<section>
<p><span data-start="15.39" data-end="18.03">so I'm talking about the javascript is a</span> <span data-start="18.03" data-end="19.83">compilation target so I want to talk</span> <span data-start="19.83" data-end="22.37">about Todd dr. JavaScript our compiler</span> <span data-start="22.37" data-end="26.1">but first who am I so am i stuffed</span> <span data-start="26.1" data-end="28.26">engineer at Google in in ojos in Denmark</span> <span data-start="28.26" data-end="30.54">and my previous projects included</span> <span data-start="30.54" data-end="32.099">schemed its keen to JavaScript compiler</span> <span data-start="32.099" data-end="33.75">then in my spare time I wrote the</span> <span data-start="33.75" data-end="35.28">child's get the scheme compiler and I</span> <span data-start="35.28" data-end="37.86">worked and we ate virtual machines and</span> <span data-start="37.86" data-end="40.26">and now now dark so my background is</span> <span data-start="40.26" data-end="42.15">basically scheme and charge give dynamic</span> <span data-start="42.15" data-end="45.78">languages so what is start it's an</span> <span data-start="45.78" data-end="47.34">unsurprising of object-oriented</span> <span data-start="47.34" data-end="49.559">programming language which from many</span> <span data-start="49.559" data-end="51.03">means it's a boring language a little</span> <span data-start="51.03" data-end="54.629">bit like Java but that was kind of our</span> <span data-start="54.629" data-end="57.449">intent it's a gas phase with the sink</span> <span data-start="57.449" data-end="60.75">inheritance and the syntax is the same</span> <span data-start="60.75" data-end="64.14">as in Java JavaScript and all these see</span> <span data-start="64.14" data-end="66.87">like languages and the new thing at</span> <span data-start="66.87" data-end="68.4">least at that time was the optional</span> <span data-start="68.4" data-end="71.43">static type system which recently was</span> <span data-start="71.43" data-end="74.1">seen in touch script too just to give</span> <span data-start="74.1" data-end="75.93">you a small example here's are the</span> <span data-start="75.93" data-end="79.05">bottles of beer in Dart nothing nothing</span> <span data-start="79.05" data-end="84.299">special here so when we only have darts</span> <span data-start="84.299" data-end="86.189">and we want to deploy it we have two</span> <span data-start="86.189" data-end="88.35">ways to do it the first of course we</span> <span data-start="88.35" data-end="90.42">have our dart sources and then ideally</span> <span data-start="90.42" data-end="91.89">you you put it on the dart virtual</span> <span data-start="91.89" data-end="93.99">machine and run it fast nice and</span> <span data-start="93.99" data-end="96.57">everything and if you still have another</span> <span data-start="96.57" data-end="98.49">browser that doesn't support the dart VM</span> <span data-start="98.49" data-end="101.159">which currently even chrome doesn't then</span> <span data-start="101.159" data-end="102.95">you have to compile the JavaScript and</span> <span data-start="102.95" data-end="105.78">that's and then it should run on all</span> <span data-start="105.78" data-end="108.21">modern browsers and this talk in</span> <span data-start="108.21" data-end="109.71">particular is now about this doctor</span> </p>
<p><span data-start="109.71" data-end="113.34">JavaScript compiler so there were</span> <span data-start="113.34" data-end="117.36">several goals when we started the the</span> <span data-start="117.36" data-end="119.64">JavaScript compiler so for one it should</span> <span data-start="119.64" data-end="122.549">run on all modern browsers and we test</span> <span data-start="122.549" data-end="124.71">on Chrome Firefox ie and Safari and we</span> <span data-start="124.71" data-end="127.229">have a testing slot for Oprah we just</span> <span data-start="127.229" data-end="129.93">haven't fill it in yet it's going to</span> <span data-start="129.93" data-end="132.72">help me at some point and and our goal</span> <span data-start="132.72" data-end="134.55">is that that the dart VM is not</span> <span data-start="134.55" data-end="137.04">necessary so you can program in dart and</span> <span data-start="137.04" data-end="139.11">it still should still work on process</span> <span data-start="139.11" data-end="141.27">that don't have to be in and of course</span> <span data-start="141.27" data-end="143.13">it must be efficient and compact</span> <span data-start="143.13" data-end="146.37">otherwise nobody wants to use it</span> <span data-start="146.37" data-end="148.739">so here's another example of dart the</span> <span data-start="148.739" data-end="152.909">standard point example nothing again</span> <span data-start="152.909" data-end="154.739">nothing special here we just allocate to</span> <span data-start="154.739" data-end="156.51">new points and then take the distance</span> <span data-start="156.51" data-end="159.239">between those two note that in this case</span> </p>
<p><span data-start="159.239" data-end="161.25">I didn't either i didn't use the type of</span> <span data-start="161.25" data-end="162.87">notation i just used bar but i could</span> <span data-start="162.87" data-end="164.94">have used typing annotation to so</span> <span data-start="164.94" data-end="168.17">pointer or intern or double in this case</span> <span data-start="168.17" data-end="171.03">so here's the compilation to the chalice</span> <span data-start="171.03" data-end="173.94">crypt in this in for this example there</span> <span data-start="173.94" data-end="175.17">are two things that probably stick out</span> <span data-start="175.17" data-end="178.14">first instead we put statics on I'm</span> <span data-start="178.14" data-end="180.48">dollar so it's dollar dot instead of</span> <span data-start="180.48" data-end="181.92">having but instead of polluting the</span> <span data-start="181.92" data-end="184.349">global namespace and the second one that</span> <span data-start="184.349" data-end="186.239">you probably actually three things the</span> <span data-start="186.239" data-end="188.01">second one is that there is no new we</span> <span data-start="188.01" data-end="190.079">just always go through factory</span> <span data-start="190.079" data-end="192.239">constructors which has a big advantage</span> <span data-start="192.239" data-end="194.519">when you have different constructors for</span> <span data-start="194.519" data-end="196.349">the same class because we in the</span> <span data-start="196.349" data-end="198.209">background can then use the same</span> </p>
<p><span data-start="198.209" data-end="201.54">JavaScript gas and have one hidden map</span> <span data-start="201.54" data-end="204.299">in the virtual machines which basically</span> <span data-start="204.299" data-end="207.12">means it will run faster the other thing</span> <span data-start="207.12" data-end="208.92">the third thing is the distance to</span> <span data-start="208.92" data-end="211.859">dollar one we encode our aerating the in</span> <span data-start="211.859" data-end="213.84">the names of the methods this way we got</span> <span data-start="213.84" data-end="215.549">except we get exceptions when the arity</span> <span data-start="215.549" data-end="217.079">doesn't work and we don't need to check</span> <span data-start="217.079" data-end="218.849">in arguments the length or anything we</span> <span data-start="218.849" data-end="220.739">just call and if it doesn't work it</span> <span data-start="220.739" data-end="222.419">means that either the arity was not was</span> <span data-start="222.419" data-end="223.829">not right or all the methods didn't</span> <span data-start="223.829" data-end="227.669">exist so this is basically what I just</span> <span data-start="227.669" data-end="230.459">said statics on abdallah factory</span> <span data-start="230.459" data-end="233.37">constructors and functions method calls</span> <span data-start="233.37" data-end="235.919">are translated to functions with with</span> <span data-start="235.919" data-end="240.09">the arity in its name so what are the</span> <span data-start="240.09" data-end="243.269">challenges now one of the big challenge</span> <span data-start="243.269" data-end="246.019">is closures in fact when we have</span> </p>
<p><span data-start="246.019" data-end="248.76">JavaScript as I just said or as an</span> <span data-start="248.76" data-end="251.4">implied doesn't check Verity where's in</span> <span data-start="251.4" data-end="252.81">doubt it's an error if you if you don't</span> <span data-start="252.81" data-end="255.769">give the correct number of arguments and</span> <span data-start="255.769" data-end="258.449">in the previous example which has been</span> <span data-start="258.449" data-end="260.699">coded the air it in the name of the</span> <span data-start="260.699" data-end="262.049">method but if you have a closure in the</span> <span data-start="262.049" data-end="263.699">hand you you don't have a name anymore</span> <span data-start="263.699" data-end="266.01">so you cannot read encode it there and</span> <span data-start="266.01" data-end="268.919">the second thing is that in dart we have</span> <span data-start="268.919" data-end="272.13">a we be allowed named or option</span> <span data-start="272.13" data-end="274.11">arguments so that's something that would</span> <span data-start="274.11" data-end="276.09">be annoying to encode inside the closure</span> <span data-start="276.09" data-end="278.87">too and we are also instant</span> <span data-start="278.87" data-end="281.93">object instances so cars instances to be</span> <span data-start="281.93" data-end="283.34">invoked as if they were closures and</span> <span data-start="283.34" data-end="285.29">their everything breaks down we cannot</span> <span data-start="285.29" data-end="286.93">use the childish cape Dakota the</span> <span data-start="286.93" data-end="289.94">challenge crypto just as target for</span> <span data-start="289.94" data-end="293.78">watch out for dart closures next one the</span> <span data-start="293.78" data-end="296.59">next challenge is its operators</span> <span data-start="296.59" data-end="299.48">javascript is very lenient in what it</span> <span data-start="299.48" data-end="303.44">accepts for operator arguments in fact</span> <span data-start="303.44" data-end="304.64">it will just try to convert it to</span> <span data-start="304.64" data-end="306.83">numbers or strings and carry on it will</span> <span data-start="306.83" data-end="308.84">keep on truckin there's nothing that</span> <span data-start="308.84" data-end="310.91">will basically throw an exception or</span> </p>
<p><span data-start="310.91" data-end="313.82">I'll give an error and we don't want</span> <span data-start="313.82" data-end="315.47">that we want to have we want to have</span> <span data-start="315.47" data-end="317.15">exceptions when when things don't don't</span> <span data-start="317.15" data-end="319.61">work where God and the second one is</span> <span data-start="319.61" data-end="321.29">that in darkly I have user-defined</span> <span data-start="321.29" data-end="323.87">operators so we allow to override the +</span> <span data-start="323.87" data-end="325.46">operator the minus operator and so on</span> <span data-start="325.46" data-end="327.32">and therefore we cannot just compile to</span> <span data-start="327.32" data-end="329">the challenge k plus because for many</span> <span data-start="329" data-end="332.66">objects it wouldn't work and finally in</span> <span data-start="332.66" data-end="334.43">the little bit in a similar area is the</span> <span data-start="334.43" data-end="339.62">array axises in JavaScript rare exes are</span> <span data-start="339.62" data-end="341.48">not checked for out of bounds or what</span> <span data-start="341.48" data-end="345.74">what the key actually is the links</span> <span data-start="345.74" data-end="347.6">operator and JavaScript works on any</span> <span data-start="347.6" data-end="350.24">object it accepts everything starting</span> <span data-start="350.24" data-end="352.97">with integers doubles objects strings</span> <span data-start="352.97" data-end="355.55">and in some cases it merges them as you</span> <span data-start="355.55" data-end="358.91">can see the the a of the string 1 is</span> <span data-start="358.91" data-end="362.72">similar to calling a of one so all those</span> <span data-start="362.72" data-end="365.6">things are invalid in dart and we need</span> <span data-start="365.6" data-end="369.62">to check those so what what are the</span> <span data-start="369.62" data-end="372.14">solutions that we came up with so</span> <span data-start="372.14" data-end="373.43">foreclosures there's actually a pretty</span> <span data-start="373.43" data-end="375.23">easy solution we compile closures two</span> <span data-start="375.23" data-end="380.21">new classes which and these gases have a</span> <span data-start="380.21" data-end="383.83">feeds for for free variables and</span> <span data-start="383.83" data-end="386.81">sometimes boxes four for four barrels</span> <span data-start="386.81" data-end="389.54">that are mutated and then we just put</span> <span data-start="389.54" data-end="391.93">normal methods on them as if there were</span> <span data-start="391.93" data-end="394.88">normal classes and we treat them</span> <span data-start="394.88" data-end="397.4">internally as as classes basically and</span> <span data-start="397.4" data-end="400.43">that's that's working pretty well for</span> <span data-start="400.43" data-end="402.35">two reasons one is that allocating a</span> <span data-start="402.35" data-end="405.35">small objects in JavaScript is very fast</span> <span data-start="405.35" data-end="408.02">and allocating a closure and javascript</span> <span data-start="408.02" data-end="410.09">is smallest size emphasized at the same</span> <span data-start="410.09" data-end="413.24">size as six fees and the second is that</span> <span data-start="413.24" data-end="415.58">every JavaScript engine has heavily</span> <span data-start="415.58" data-end="419.06">optimized the method excesses and in</span> <span data-start="419.06" data-end="421.31">there in the lurch it's just because</span> <span data-start="421.31" data-end="423.259">every benchmark uses that heavily so in</span> <span data-start="423.259" data-end="425.9">the end you are usually as fast or</span> <span data-start="425.9" data-end="427.88">faster than if you had action closures</span> <span data-start="427.88" data-end="434.12">so as an example here we have a closure</span> <span data-start="434.12" data-end="437.41">a dart closure which starts with the</span> <span data-start="437.41" data-end="441.139">they each going to the list index off so</span> <span data-start="441.139" data-end="442.669">this is a shorthand form for for</span> <span data-start="442.669" data-end="445.34">creating a closure and art so the list</span> <span data-start="445.34" data-end="447.259">of map takes the closures that itself</span> <span data-start="447.259" data-end="449.63">takes in each end and searches for the</span> <span data-start="449.63" data-end="452.93">for this element in the list and this is</span> <span data-start="452.93" data-end="455.72">translated you have the tart under on</span> <span data-start="455.72" data-end="458.259">the bottom this is translated into a</span> <span data-start="458.259" data-end="461.409">main dollar closure class so the second</span> <span data-start="461.409" data-end="465.77">second part which has one field the list</span> <span data-start="465.77" data-end="468.319">so that was a free variable and it has</span> <span data-start="468.319" data-end="470.18">one method the cold other one which</span> <span data-start="470.18" data-end="472.699">represents the invocation target if you</span> <span data-start="472.699" data-end="475.069">invoke the closure and in there it's</span> <span data-start="475.069" data-end="476.9">just a normal function which takes an</span> <span data-start="476.9" data-end="479.09">argument and does whatever we wanted to</span> <span data-start="479.09" data-end="481.58">do before note the compact gas</span> <span data-start="481.58" data-end="484.07">representation so we avoid a lot of</span> <span data-start="484.07" data-end="486.02">particle by the plate code by by</span> <span data-start="486.02" data-end="488.96">generating an occult dynamically this</span> <span data-start="488.96" data-end="490.789">way we shrink a little bit the size of</span> <span data-start="490.789" data-end="495.55">the JavaScript the resulting JavaScript</span> <span data-start="495.55" data-end="498.259">so the second problem was was the</span> <span data-start="498.259" data-end="500.99">operators and there the knave solution</span> <span data-start="500.99" data-end="502.669">would be to just add functions on the</span> <span data-start="502.669" data-end="504.979">prototypes of numbers erased rings pool</span> <span data-start="504.979" data-end="508.699">enzymes on and and invoke these methods</span> <span data-start="508.699" data-end="510.38">instead of using the child script</span> <span data-start="510.38" data-end="512.39">operates directly so you could imagine</span> <span data-start="512.39" data-end="514.61">having an ad operator on the prototype</span> <span data-start="514.61" data-end="516.529">of number that takes another argument</span> <span data-start="516.529" data-end="518.51">and only if that argument is actually</span> <span data-start="518.51" data-end="521.99">number we return the the sum of this</span> <span data-start="521.99" data-end="526.61">plus plus X and similarly for array the</span> <span data-start="526.61" data-end="528.589">index operator we would check that the</span> <span data-start="528.589" data-end="531.77">that the index is an integer and only if</span> <span data-start="531.77" data-end="534.26">it's in its then also in the bounds we</span> <span data-start="534.26" data-end="539.209">return the the axis of this so I have</span> <span data-start="539.209" data-end="541.61">the effort to example standard so X plus</span> <span data-start="541.61" data-end="544.22">y would then be compared to X dot add of</span> </p>
<p><span data-start="544.22" data-end="546.86">Y and similarly lists the operator</span> <span data-start="546.86" data-end="547.34">please</span> <span data-start="547.34" data-end="549.92">the index operator list I would be a</span> <span data-start="549.92" data-end="553.61">method call to the list so the drawbacks</span> <span data-start="553.61" data-end="555.32">of the solution is that it pollutes the</span> <span data-start="555.32" data-end="556.7">global objects which is something we</span> <span data-start="556.7" data-end="559.28">really want to avoid and it also can be</span> <span data-start="559.28" data-end="561.17">very slow especially if you if you if</span> <span data-start="561.17" data-end="565.73">you don't have a strict mode the reason</span> <span data-start="565.73" data-end="567.38">is that when you do a method call on our</span> <span data-start="567.38" data-end="570.8">numbers or number boolean's and so on it</span> <span data-start="570.8" data-end="572.75">will box the object before it can do the</span> <span data-start="572.75" data-end="578">the action method call so what we did</span> <span data-start="578" data-end="579.59">instead is having having static</span> <span data-start="579.59" data-end="581.15">interceptors so we just have static</span> <span data-start="581.15" data-end="583.6">methods that represent the operators and</span> <span data-start="583.6" data-end="587.78">the they are polymorphic in the sense</span> <span data-start="587.78" data-end="589.58">that for every operator that is for</span> <span data-start="589.58" data-end="592.01">native sorry for native up for native</span> </p>
<p><span data-start="592.01" data-end="594.77">JavaScript objects we intercept them in</span> <span data-start="594.77" data-end="597.14">these static functions so we check if</span> <span data-start="597.14" data-end="598.88">it's a number and if the other one is a</span> <span data-start="598.88" data-end="601.04">number we do the operation if it's if</span> <span data-start="601.04" data-end="602.36">it's something else that supports them</span> <span data-start="602.36" data-end="604.52">plus operator we we would do it in there</span> <span data-start="604.52" data-end="607.49">too so we just intercept operators in a</span> <span data-start="607.49" data-end="609.08">static function and then only redirect</span> <span data-start="609.08" data-end="612.41">to the data object if if it's not a</span> <span data-start="612.41" data-end="615.11">child shipped primitive similarly for</span> <span data-start="615.11" data-end="616.52">for the index operator will check if</span> <span data-start="616.52" data-end="618.71">it's a JavaScript array if it is we do</span> <span data-start="618.71" data-end="620.87">the child script stuff and if it's not</span> <span data-start="620.87" data-end="625.75">we will redirect to the dart method so</span> <span data-start="625.75" data-end="627.89">to give you an example of how that looks</span> <span data-start="627.89" data-end="630.5">in the code this is just a small main</span> <span data-start="630.5" data-end="633.08">that loop that gets the summer of a list</span> <span data-start="633.08" data-end="638.42">and this is still pretty readable so</span> <span data-start="638.42" data-end="640.49">every operator is replaced with a call</span> <span data-start="640.49" data-end="643.79">to aesthetic sodala dot in one case it's</span> <span data-start="643.79" data-end="645.77">the less than bully fires in the other</span> <span data-start="645.77" data-end="647.42">one it's the ad and then we have an</span> <span data-start="647.42" data-end="650.57">index so pretty standard stuff nothing</span> <span data-start="650.57" data-end="654.2">nothing special and that works the only</span> <span data-start="654.2" data-end="656.33">problem is that is very slow so we had a</span> <span data-start="656.33" data-end="658.55">if you do it this way you have a snow</span> <span data-start="658.55" data-end="661.09">level slowdown of about a factor of six</span> <span data-start="661.09" data-end="663.17">compared to handwritten JavaScript code</span> <span data-start="663.17" data-end="666.44">on on v8 and in some cases it even goes</span> <span data-start="666.44" data-end="668.99">down to 23 times slower than handwritten</span> <span data-start="668.99" data-end="673.97">code and there and there some really</span> <span data-start="673.97" data-end="675.65">obvious improvements you don't need to</span> <span data-start="675.65" data-end="677.27">use an operator if you actually know the</span> <span data-start="677.27" data-end="680.37">type of the arguments</span> <span data-start="680.37" data-end="682.589">this case you can simulate the in lining</span> <span data-start="682.589" data-end="685.41">of this static function call and avoid</span> <span data-start="685.41" data-end="688.23">the da'kel to the global interceptor so</span> <span data-start="688.23" data-end="690.36">by tracking the types and in particular</span> <span data-start="690.36" data-end="694.29">the local types we can and doing a</span> <span data-start="694.29" data-end="695.46">little bit of type inference we can</span> <span data-start="695.46" data-end="700.73">improve massively on that on that code</span> <span data-start="700.73" data-end="702.81">going back to the example that we had</span> <span data-start="702.81" data-end="704.91">before instead of having all these</span> <span data-start="704.91" data-end="707.85">method calls to the sorry instead of</span> <span data-start="707.85" data-end="709.08">having all the static calls to the</span> <span data-start="709.08" data-end="712.86">interceptors we now have only we have</span> <span data-start="712.86" data-end="714.6">none left in this example every</span> <span data-start="714.6" data-end="717">everywhere place is known the type is</span> <span data-start="717" data-end="718.98">known so we know that the list is an</span> <span data-start="718.98" data-end="721.5">array we know that the integers that the</span> <span data-start="721.5" data-end="723.24">sum is a number we know that I is an</span> <span data-start="723.24" data-end="725.04">integer the only thing we actually still</span> <span data-start="725.04" data-end="727.23">have to do is to do the checks so we</span> <span data-start="727.23" data-end="729.18">need to check that we don't have an</span> <span data-start="729.18" data-end="732.029">out-of-range exception and we don't have</span> <span data-start="732.029" data-end="734.79">an illegal argument exception in case we</span> <span data-start="734.79" data-end="736.74">have a plus of a number plus something</span> <span data-start="736.74" data-end="740.94">that is not a number both can be in line</span> <span data-start="740.94" data-end="744.45">easily and are pretty fast so doing just</span> <span data-start="744.45" data-end="746.459">that gives us a performance compared to</span> <span data-start="746.459" data-end="747.63">handwritten JavaScript code of a</span> <span data-start="747.63" data-end="751.16">50-percent even a little bit more and</span> <span data-start="751.16" data-end="754.529">it's a good start to continue from there</span> <span data-start="754.529" data-end="758.13">on there are two things that are to be</span> <span data-start="758.13" data-end="759.72">noted here the better your global type</span> <span data-start="759.72" data-end="762.54">reference is the less study calls you</span> <span data-start="762.54" data-end="764.61">have so the better you get and our</span> <span data-start="764.61" data-end="765.87">global type of options are girding is</span> <span data-start="765.87" data-end="767.64">currently not that well not that good</span> <span data-start="767.64" data-end="769.98">something we were going to work on soon</span> <span data-start="769.98" data-end="773.01">and even if you have a global type</span> <span data-start="773.01" data-end="775.589">inference algorithm that is pretty good</span> <span data-start="775.589" data-end="777.45">you will still have a lot of calls to</span> <span data-start="777.45" data-end="779.43">interceptors in case when you lose track</span> <span data-start="779.43" data-end="782.52">of the types and these are doubly</span> <span data-start="782.52" data-end="784.32">expensive because for one you have to</span> <span data-start="784.32" data-end="785.97">study interceptor calls and the second</span> <span data-start="785.97" data-end="786.959">one is you don't know if they have side</span> <span data-start="786.959" data-end="788.43">effects and therefore they destroy your</span> <span data-start="788.43" data-end="794.04">local optimizations so the big hammer we</span> <span data-start="794.04" data-end="795.48">have for that is the speculative</span> <span data-start="795.48" data-end="799.86">optimizations and that's the yeah so the</span> <span data-start="799.86" data-end="803.1">idea is to guess what the type of the of</span> <span data-start="803.1" data-end="806.58">the verbal would be or instruction what</span> <span data-start="806.58" data-end="809.04">the type would be based on on how it's</span> <span data-start="809.04" data-end="811.35">used and then we try to optimize for</span> <span data-start="811.35" data-end="813.15">this speculated type</span> <span data-start="813.15" data-end="815.1">and the promise of course we cannot</span> <span data-start="815.1" data-end="816.6">always be right and therefore we have</span> <span data-start="816.6" data-end="820.29">bailouts when we are wrong so the give</span> <span data-start="820.29" data-end="821.73">you an idea here this is the same</span> <span data-start="821.73" data-end="823.62">example as before the the sum of the</span> <span data-start="823.62" data-end="825.33">loop except that in this case we have no</span> <span data-start="825.33" data-end="827.01">idea what X is in the previous example</span> <span data-start="827.01" data-end="828.87">we knew it was a list it was in the code</span> <span data-start="828.87" data-end="831.27">in this example it could be anything but</span> <span data-start="831.27" data-end="833.25">looking at the code it put a really</span> <span data-start="833.25" data-end="835.77">great if it was a child script array so</span> <span data-start="835.77" data-end="838.35">what we do now is we just say okay let's</span> <span data-start="838.35" data-end="840.15">check if it's a JavaScript array and if</span> <span data-start="840.15" data-end="842.25">it is and so if it is not one we bail</span> <span data-start="842.25" data-end="844.38">out but if it is one we can optimize the</span> <span data-start="844.38" data-end="846.18">same as before we have this perfect code</span> <span data-start="846.18" data-end="849.9">that is a running nicely and fast but</span> <span data-start="849.9" data-end="853.5">not perfect but nearly perfect and then</span> <span data-start="853.5" data-end="855.36">if we are wrong well we have a bailout</span> <span data-start="855.36" data-end="857.4">function that does the expensive static</span> <span data-start="857.4" data-end="860.24">interceptor calls and does the does the</span> <span data-start="860.24" data-end="862.53">necessary stuff to get it right in case</span> <span data-start="862.53" data-end="864.21">there's an operator overloading and it's</span> <span data-start="864.21" data-end="870.48">not a list and and all these things the</span> <span data-start="870.48" data-end="872.19">thing is that if you do that all the</span> <span data-start="872.19" data-end="874.32">time you blow up your code so we have</span> <span data-start="874.32" data-end="876.33">some heuristics 22 when we want to check</span> <span data-start="876.33" data-end="879.66">when we want to speculate and it's</span> <span data-start="879.66" data-end="883.47">difficult to see when and how we need to</span> <span data-start="883.47" data-end="885.6">do that and currently we just physically</span> <span data-start="885.6" data-end="887.34">say if you're using something from</span> <span data-start="887.34" data-end="889.29">inside a loop and ideally transitively</span> <span data-start="889.29" data-end="890.64">from inside the loop so if you call a</span> <span data-start="890.64" data-end="893.19">function that is in from inside a loop</span> <span data-start="893.19" data-end="894.63">you will also optimize that function</span> <span data-start="894.63" data-end="898.2">speculatively then we do speculative</span> <span data-start="898.2" data-end="900.12">optimizations if I were is just a</span> <span data-start="900.12" data-end="902.04">function somewhere we ok we don't care</span> <span data-start="902.04" data-end="905.79">we keep their two interceptors ideally</span> <span data-start="905.79" data-end="907.29">and that's that's future work we want to</span> <span data-start="907.29" data-end="909.45">do profile guided optimizations so we</span> <span data-start="909.45" data-end="911.34">want to say speculate everything and</span> <span data-start="911.34" data-end="913.83">then tell us later on what worked and</span> <span data-start="913.83" data-end="916.17">what didn't work and things that either</span> <span data-start="916.17" data-end="918.6">always made out or never wear called we</span> <span data-start="918.6" data-end="920.55">can't just leave the the course the</span> <span data-start="920.55" data-end="921.69">static interceptors and would have</span> <span data-start="921.69" data-end="928.23">nicely reduced code size so with that we</span> <span data-start="928.23" data-end="930">get another huge bump in performance and</span> <span data-start="930" data-end="932.97">it really really paid so with that we</span> <span data-start="932.97" data-end="935.78">have about 75% of handwritten code and</span> <span data-start="935.78" data-end="938.04">together a little bit on the speed space</span> </p>
<p><span data-start="938.04" data-end="939.51">V trade off with the speculative</span> <span data-start="939.51" data-end="942.03">optimizations we have about fifty</span> <span data-start="942.03" data-end="943.59">percent code increase when we when we</span> <span data-start="943.59" data-end="946.95">enable the speculative optimizations</span> <span data-start="946.95" data-end="948.81">using heuristics and even if we didn't</span> <span data-start="948.81" data-end="952.2">use heuristics it would only blow up I</span> <span data-start="952.2" data-end="954.66">fact them by seventy two percent so for</span> <span data-start="954.66" data-end="956.55">profiling for instance it would still be</span> <span data-start="956.55" data-end="958.71">feasible to have all speculative sin and</span> <span data-start="958.71" data-end="960.09">then see which ones are actually</span> <span data-start="960.09" data-end="964.02">effective yes there's another thing we</span> <span data-start="964.02" data-end="965.82">do to reduce the code size that's tree</span> <span data-start="965.82" data-end="969.93">shaking the idea here is that we only</span> <span data-start="969.93" data-end="971.46">compile functions that are potentially</span> <span data-start="971.46" data-end="973.14">reach able so we start with the main</span> <span data-start="973.14" data-end="975.24">which is the only entry point in Dart</span> <span data-start="975.24" data-end="977.01">you cannot execute code outside of main</span> <span data-start="977.01" data-end="981.03">and then we look at yes colors of Ada</span> <span data-start="981.03" data-end="984.75">and then we look at the at what is</span> <span data-start="984.75" data-end="986.01">invoked and what classes are</span> <span data-start="986.01" data-end="987.99">instantiated and songs in this case you</span> <span data-start="987.99" data-end="990">have two classes that extent that are</span> <span data-start="990" data-end="991.86">instantiated that is pointed line and</span> <span data-start="991.86" data-end="994.41">you have one method call that that's the</span> <span data-start="994.41" data-end="997.11">distance to and then from there on since</span> <span data-start="997.11" data-end="998.79">it's a method called you collect all the</span> <span data-start="998.79" data-end="1001.97">classes they're there and see I'm sorry</span> <span data-start="1001.97" data-end="1004.64">you collect all the the methods that are</span> <span data-start="1004.64" data-end="1006.8">possible in this case let's assume point</span> <span data-start="1006.8" data-end="1008.33">and line have a distance to method on</span> <span data-start="1008.33" data-end="1011.2">them and you continue recursively</span> <span data-start="1011.2" data-end="1013.07">enumerate the functions that are</span> <span data-start="1013.07" data-end="1015.83">potentially reachable in this case you</span> <span data-start="1015.83" data-end="1017.48">would could be for instance square root</span> <span data-start="1017.48" data-end="1020.18">and a cross product and point and so as</span> <span data-start="1020.18" data-end="1022.46">you can see in this example you might</span> <span data-start="1022.46" data-end="1025.13">end up compiling too much nothing in the</span> <span data-start="1025.13" data-end="1027.05">code that is shown at least tells you</span> <span data-start="1027.05" data-end="1029.3">that you call line the distance off the</span> <span data-start="1029.3" data-end="1031.55">only one that is there is a point of</span> <span data-start="1031.55" data-end="1036.199">distance to so it distance to but the</span> <span data-start="1036.199" data-end="1039.62">it's still a good it still reduces the</span> <span data-start="1039.62" data-end="1041.3">code size ballot and the more typing</span> <span data-start="1041.3" data-end="1044.77">information you have the better it gets</span> <span data-start="1044.77" data-end="1047.87">so another in another diagram saying the</span> <span data-start="1047.87" data-end="1049.79">same thing what we do is we start by</span> <span data-start="1049.79" data-end="1053.33">parsing the whole code but diet parsing</span> <span data-start="1053.33" data-end="1054.77">which means that we don't actually</span> <span data-start="1054.77" data-end="1056.48">create the ast for everything we just</span> <span data-start="1056.48" data-end="1058.22">get the structures what other classes</span> <span data-start="1058.22" data-end="1060.17">without a method and so on then we</span> <span data-start="1060.17" data-end="1062.27">resolve using the tree shaking algorithm</span> <span data-start="1062.27" data-end="1064.46">and there we actually put the HTS and</span> <span data-start="1064.46" data-end="1068.42">then at the end we do another we do</span> <span data-start="1068.42" data-end="1070.85">another tree shaking while tree shaking</span> <span data-start="1070.85" data-end="1073.76">like compilation process where we where</span> <span data-start="1073.76" data-end="1076.67">we are compiled only the methods that</span> <span data-start="1076.67" data-end="1079.91">are actually called knowing that</span> <span data-start="1079.91" data-end="1082.55">the compilation might do that code</span> <span data-start="1082.55" data-end="1084.11">elimination and so on and that's why the</span> <span data-start="1084.11" data-end="1086.21">the compiled code could be less than the</span> <span data-start="1086.21" data-end="1090.11">results code since we are coming out</span> <span data-start="1090.11" data-end="1092.39">compilation I'm not going to the symbol</span> <span data-start="1092.39" data-end="1096.95">single static single assignment form so</span> <span data-start="1096.95" data-end="1101.39">we this is the the the how we compiled</span> <span data-start="1101.39" data-end="1103.1">we have we start with the dark syntax</span> <span data-start="1103.1" data-end="1106.13">tree then go for a pillow that builds</span> <span data-start="1106.13" data-end="1110.33">our SS a graph go to some optimizations</span> <span data-start="1110.33" data-end="1111.98">on that a lot of optimizations on that</span> <span data-start="1111.98" data-end="1114.11">and then go to the go to narita which</span> <span data-start="1114.11" data-end="1116.75">which code generator which will produce</span> <span data-start="1116.75" data-end="1118.1">the challenge crip syntax tree which</span> <span data-start="1118.1" data-end="1124.22">will then emit to get the final code so</span> <span data-start="1124.22" data-end="1126.7">the single static assignment form is</span> <span data-start="1126.7" data-end="1129.71">commonly used in tons of compilers and</span> <span data-start="1129.71" data-end="1131.48">we use it for for analysis and</span> <span data-start="1131.48" data-end="1134.45">optimizations too in particular we have</span> <span data-start="1134.45" data-end="1136.52">the local type inference which uses the</span> </p>
<p><span data-start="1136.52" data-end="1140.51">ESS a phone function in i link is well</span> <span data-start="1140.51" data-end="1142.43">it's kind of on the on the builder level</span> <span data-start="1142.43" data-end="1145.91">but partially on the SS a cuba value</span> <span data-start="1145.91" data-end="1148.22">numbering and i'm going to give a slide</span> <span data-start="1148.22" data-end="1150.26">on that one also the loop invariant code</span> <span data-start="1150.26" data-end="1151.76">motion i have a slight just afterwards</span> <span data-start="1151.76" data-end="1153.95">and finding the range propagation where</span> <span data-start="1153.95" data-end="1155.72">we just keep track of the ragged ranges</span> <span data-start="1155.72" data-end="1159.17">a variable can have note that s sa is</span> <span data-start="1159.17" data-end="1162.02">actually pretty annoying in in in some</span> <span data-start="1162.02" data-end="1163.28">respect when you compile to challenge</span> <span data-start="1163.28" data-end="1166.01">good because going out of charge of the</span> </p>
<p><span data-start="1166.01" data-end="1169.49">SS a form back to charge Gabe it's not</span> <span data-start="1169.49" data-end="1171.35">always trivial because there's no goat</span> <span data-start="1171.35" data-end="1175.43">in JavaScript there it can be tricky to</span> <span data-start="1175.43" data-end="1177.65">to to actually compiled back to tonights</span> <span data-start="1177.65" data-end="1179.09">challenge group and we spend a lot of</span> <span data-start="1179.09" data-end="1182.81">time on that so the club value numbering</span> <span data-start="1182.81" data-end="1186.07">I mentioned it basically just tries to</span> <span data-start="1186.07" data-end="1188.42">avoid recomputing stuff if you already</span> <span data-start="1188.42" data-end="1190.55">have computed it so in this case</span> <span data-start="1190.55" data-end="1192.47">compiler that generated assuming that we</span> <span data-start="1192.47" data-end="1194.09">know that compiler generated is not a</span> <span data-start="1194.09" data-end="1196.97">getter we can avoid accessing it twice</span> <span data-start="1196.97" data-end="1199.4">just doing it once before the diff and</span> <span data-start="1199.4" data-end="1201.95">therefore avoiding a little bit of code</span> <span data-start="1201.95" data-end="1206.27">end of execution in the same way in</span> <span data-start="1206.27" data-end="1209.24">looping around commotion if we can show</span> <span data-start="1209.24" data-end="1211.73">that we can hoist a computation out of a</span> <span data-start="1211.73" data-end="1213.36">loop well let's</span> <span data-start="1213.36" data-end="1217.38">do that it's as simple as that funny</span> <span data-start="1217.38" data-end="1219.71">enough most of those are not that</span> <span data-start="1219.71" data-end="1222.69">important for us because the the chit's</span> <span data-start="1222.69" data-end="1225.39">then do that already so only a few cases</span> <span data-start="1225.39" data-end="1226.5">where we have a little bit better</span> <span data-start="1226.5" data-end="1228.72">information than the chips can we can we</span> <span data-start="1228.72" data-end="1231.63">do do we do more than they do but it's</span> <span data-start="1231.63" data-end="1236.11">still it still gave us some percentages</span> <span data-start="1236.12" data-end="1238.44">here's now the the same actor that's</span> <span data-start="1238.44" data-end="1240.9">some example from before up with the</span> <span data-start="1240.9" data-end="1242.85">optimizations apply there are only two</span> <span data-start="1242.85" data-end="1245.64">changes from before for one we have now</span> <span data-start="1245.64" data-end="1248.25">the listed length which is a hoisted out</span> <span data-start="1248.25" data-end="1251.52">of the loop so that's the VAR t one then</span> <span data-start="1251.52" data-end="1253.309">and the second one is that the range</span> <span data-start="1253.309" data-end="1255.419">propagation made sure that we don't need</span> <span data-start="1255.419" data-end="1256.83">to check for for the out of bounds</span> <span data-start="1256.83" data-end="1259.47">exception in it other than that no</span> <span data-start="1259.47" data-end="1265.14">change so what's the status of the dart</span> <span data-start="1265.14" data-end="1267.87">to JavaScript compiler with respect to</span> <span data-start="1267.87" data-end="1270.69">code size we are we have improved a lot</span> <span data-start="1270.69" data-end="1272.76">since our first release so everybody</span> <span data-start="1272.76" data-end="1274.71">still remembers the mega byte header</span> <span data-start="1274.71" data-end="1280.679">world that's not the animal and usually</span> <span data-start="1280.679" data-end="1282.51">now if you have actually if you have an</span> <span data-start="1282.51" data-end="1284.16">app that loses a lot of charge gift code</span> <span data-start="1284.16" data-end="1287.25">is because you just libraries so it's</span> <span data-start="1287.25" data-end="1289.38">not that we cannot make our code bed and</span> <span data-start="1289.38" data-end="1291.419">we can definitely make it better but in</span> <span data-start="1291.419" data-end="1293.76">many cases now it's not not stupid</span> <span data-start="1293.76" data-end="1296.22">errors anymore stupid code generation as</span> <span data-start="1296.22" data-end="1298.95">there was before and we are working on a</span> <span data-start="1298.95" data-end="1303.12">mini fire already so we have and dart</span> <span data-start="1303.12" data-end="1306.12">dart mini fire and we have minification</span> <span data-start="1306.12" data-end="1307.98">for javascript where we remove the white</span> <span data-start="1307.98" data-end="1309.929">space at least and we are working on on</span> <span data-start="1309.929" data-end="1312.27">with minifying the local variables names</span> <span data-start="1312.27" data-end="1315.66">and everything to with respect to</span> <span data-start="1315.66" data-end="1318.27">performance this is a screenshot of our</span> <span data-start="1318.27" data-end="1322.14">internal tracker the important one is</span> <span data-start="1322.14" data-end="1323.7">probably did the last number on the</span> <span data-start="1323.7" data-end="1326.28">bottom and the right which is the dart</span> <span data-start="1326.28" data-end="1328.559">to JavaScript performance with compared</span> <span data-start="1328.559" data-end="1331.679">to v8 to handwritten v8 code so the gr</span> </p>
<p><span data-start="1331.679" data-end="1333.69">NT geometric means says that we are now</span> <span data-start="1333.69" data-end="1335.07">at seventy-eight percent of the</span> <span data-start="1335.07" data-end="1336.75">handwritten code at least for the</span> <span data-start="1336.75" data-end="1340.08">benchmarks we have here and we would</span> <span data-start="1340.08" data-end="1341.52">think we can still improve on that so</span> <span data-start="1341.52" data-end="1344.929">it's not yet it's not yet done</span> <span data-start="1344.929" data-end="1347.13">and then some benchmarks veeram in the</span> <span data-start="1347.13" data-end="1351.89">fastest some so as conclusion</span> <span data-start="1351.89" data-end="1354.39">speculative optimizations I think that's</span> <span data-start="1354.39" data-end="1356.49">the big takeaway from this talk it's a</span> <span data-start="1356.49" data-end="1358.2">it's crucial to get a real good</span> <span data-start="1358.2" data-end="1361.34">performance if you have dynamic code and</span> <span data-start="1361.34" data-end="1364.11">we are now more than seventy-five</span> <span data-start="1364.11" data-end="1366.15">percent speed of handwritten JavaScript</span> <span data-start="1366.15" data-end="1368.4">code so it's a good time to give that</span> <span data-start="1368.4" data-end="1371.549">another try if you have done it before</span> <span data-start="1371.549" data-end="1375.6">in a try if you hadn't and with that I</span> <span data-start="1375.6" data-end="1385.47">thank you and I will take questions</span> <span data-start="1385.48" data-end="1392.149">do have any questions out there all</span> <span data-start="1392.149" data-end="1398.74">right the loop invariant code motion</span> <span data-start="1398.74" data-end="1402.62">where and how do you have more</span> <span data-start="1402.62" data-end="1405.62">information than digit on do you have a</span> <span data-start="1405.62" data-end="1408.769">concrete case where you know more than</span> <span data-start="1408.769" data-end="1412.82">digit and can do better at the top of my</span> <span data-start="1412.82" data-end="1415.25">head I don't but I'm pretty sure there</span> <span data-start="1415.25" data-end="1417.44">are some cases where we compiled</span> <span data-start="1417.44" data-end="1419.21">something into a method call just</span> <span data-start="1419.21" data-end="1420.86">because it simpler because we don't want</span> <span data-start="1420.86" data-end="1422.539">to learn it and we still know that this</span> <span data-start="1422.539" data-end="1424.58">method call is it doesn't have any any</span> <span data-start="1424.58" data-end="1426.559">side effect and if the vm doesn't ignite</span> <span data-start="1426.559" data-end="1428.57">it it will not see the same thing and</span> <span data-start="1428.57" data-end="1431.2">also doing this might help us optimize</span> <span data-start="1431.2" data-end="1434.659">ourselves call ourselves so if we can</span> <span data-start="1434.659" data-end="1436.85">basically bail out earlier thats that's</span> <span data-start="1436.85" data-end="1438.62">the biggest thing if we can move it out</span> <span data-start="1438.62" data-end="1440.09">of the loop and then have a bailout that</span> <span data-start="1440.09" data-end="1441.86">is not inside the loop but outside the</span> <span data-start="1441.86" data-end="1447.289">loop be much faster so you briefly</span> <span data-start="1447.289" data-end="1450.679">mentioned hello hi you briefly mentioned</span> <span data-start="1450.679" data-end="1453.049">getters and of course in es6 we're gonna</span> <span data-start="1453.049" data-end="1455.99">be getting proxies which all make this I</span> <span data-start="1455.99" data-end="1459.2">imagine a lot harder do you have a</span> <span data-start="1459.2" data-end="1461.51">strategy for dealing with that or rpms</span> <span data-start="1461.51" data-end="1464.45">and compile to jeaious languages and</span> <span data-start="1464.45" data-end="1466.25">optimizations in general just kind of</span> <span data-start="1466.25" data-end="1468.47">screwed ones proxies roll around and</span> <span data-start="1468.47" data-end="1470.6">once getters start being more prevalent</span> <span data-start="1470.6" data-end="1472.49">well first it shouldn't matter because</span> <span data-start="1472.49" data-end="1474.049">we compiled to challenge crypt so as</span> <span data-start="1474.049" data-end="1476.179">long as the current set doesn't change</span> <span data-start="1476.179" data-end="1478.46">the current language doesn't change we</span> <span data-start="1478.46" data-end="1480.139">should be fine on the other hand it</span> <span data-start="1480.139" data-end="1482.179">could help us so for instance getters</span> <span data-start="1482.179" data-end="1484.13">and setters when we started out to</span> </p>
<p><span data-start="1484.13" data-end="1485.84">JavaScript it was just a no-go we</span> <span data-start="1485.84" data-end="1487.279">couldn't compile dart getters and</span> <span data-start="1487.279" data-end="1488.96">setters to JavaScript getters and</span> <span data-start="1488.96" data-end="1491.33">setters because they were horrendously</span> <span data-start="1491.33" data-end="1494.09">slow where's now I think there are some</span> <span data-start="1494.09" data-end="1495.409">benchmarks appearing that actually use</span> <span data-start="1495.409" data-end="1498.26">it so which its start to optimize them</span> <span data-start="1498.26" data-end="1501.169">so everything that comes into javascript</span> <span data-start="1501.169" data-end="1510.139">is just helping us</span> <span data-start="1510.149" data-end="1512.86">actually I have two questions one what</span> <span data-start="1512.86" data-end="1515.08">if you have a jquery on your page like</span> <span data-start="1515.08" data-end="1517.179">dollar sign is kind of very popular and</span> <span data-start="1517.179" data-end="1519.61">neither do you have a telco recursion</span> <span data-start="1519.61" data-end="1521.35">sorry do you have a tail call</span> <span data-start="1521.35" data-end="1523.69">optimization in art or not and if you do</span> <span data-start="1523.69" data-end="1526.299">what do you compile to ok so a second</span> <span data-start="1526.299" data-end="1528.039">question is easy to know we don't have</span> <span data-start="1528.039" data-end="1530.139">it and the first question is at the</span> <span data-start="1530.139" data-end="1531.97">moment there is a conflict but we can</span> <span data-start="1531.97" data-end="1533.409">easily change dollar to something else</span> <span data-start="1533.409" data-end="1535.419">there is no that that's that's really</span> <span data-start="1535.419" data-end="1542.23">easy so you mentioned minification at</span> <span data-start="1542.23" data-end="1543.909">the end that you might add that in are</span> <span data-start="1543.909" data-end="1545.049">there specific thing piece of</span> <span data-start="1545.049" data-end="1546.82">information you have in dart that you</span> <span data-start="1546.82" data-end="1548.019">think could help with minification</span> <span data-start="1548.019" data-end="1550.539">beyond just what you can get from a</span> <span data-start="1550.539" data-end="1553.96">post-hoc minna fire so fast minification</span> <span data-start="1553.96" data-end="1555.7">is much easier than for child can I hope</span> </p>
<p><span data-start="1555.7" data-end="1558.76">I responding to a question because we</span> <span data-start="1558.76" data-end="1562.029">don't have dynamic codes gnrateur</span> <span data-start="1562.029" data-end="1565.21">amoco generation or even accessing</span> <span data-start="1565.21" data-end="1566.769">through strings as long as you of course</span> <span data-start="1566.769" data-end="1569.679">don't use on mirrors which is reflection</span> <span data-start="1569.679" data-end="1571.71">so as long as you don't use reflection</span> <span data-start="1571.71" data-end="1576.22">we can just minify every method to the</span> <span data-start="1576.22" data-end="1579.01">corresponding minified the name and we</span> <span data-start="1579.01" data-end="1580.179">know that it will not be a problem</span> <span data-start="1580.179" data-end="1582.159">because nobody can use a string to</span> <span data-start="1582.159" data-end="1583.63">access it or nobody can generate new</span> <span data-start="1583.63" data-end="1587.019">code to do that so from that it seems</span> <span data-start="1587.019" data-end="1590.95">pretty just having a map from 24 methods</span> <span data-start="1590.95" data-end="1597.71">statics and everything should do the job</span> <span data-start="1597.72" data-end="1600.51">tree shaking if I said it correctly</span> <span data-start="1600.51" data-end="1603.25">wouldn't work with library code but</span> <span data-start="1603.25" data-end="1605.08">would it work if you included all your</span> <span data-start="1605.08" data-end="1607.45">or if you recompile your library card</span> <span data-start="1607.45" data-end="1610.36">together with the application that's the</span> <span data-start="1610.36" data-end="1612.85">spot video when you compile from dart to</span> </p>
<p><span data-start="1612.85" data-end="1615.25">JavaScript we take the whole code we put</span> <span data-start="1615.25" data-end="1617.08">it into one violent and which we shake</span> <span data-start="1617.08" data-end="1619.059">everything away and we have the dart</span> <span data-start="1619.059" data-end="1621.37">dart compiler to do basically the same</span> <span data-start="1621.37" data-end="1627.57">thing when you when you deploy on tart</span> <span data-start="1627.58" data-end="1631.66">any other questions all right cool thank</span> </p>
</section>