<section>
<p><span data-start="13.2" data-end="15.96">one my name is Malta thanks for choosing</span> <span data-start="15.96" data-end="18.21">the front end talk I'm one of like 15</span> <span data-start="18.21" data-end="19.5">engineers at Google not working on</span> <span data-start="19.5" data-end="20.939">machine learning so differently</span> <span data-start="20.939" data-end="22.65">appreciate the other people interested</span> <span data-start="22.65" data-end="25.439">in this yeah ok Google I specifically</span> <span data-start="25.439" data-end="27.45">work on a thing called amp project if</span> <span data-start="27.45" data-end="28.95">you've not heard about that it's kind of</span> <span data-start="28.95" data-end="31.079">a thing to make reliably fast web sites</span> <span data-start="31.079" data-end="34.92">and like while doing this project and</span> <span data-start="34.92" data-end="37.26">learned a lot about something that's the</span> <span data-start="37.26" data-end="40.95">topic of this talk so and the talk is</span> <span data-start="40.95" data-end="44.28">going to be a little dark so I wanted to</span> <span data-start="44.28" data-end="47.88">start out on a lighter note which is</span> <span data-start="47.88" data-end="49.83">that JavaScript really is my favorite</span> <span data-start="49.83" data-end="51.78">programming language and for so many</span> <span data-start="51.78" data-end="56.61">reasons for example you can use it to</span> <span data-start="56.61" data-end="58.77">build applications to make presentations</span> <span data-start="58.77" data-end="61.739">and just a few examples from from Jay's</span> <span data-start="61.739" data-end="64.309">comms what we what we did over the years</span> <span data-start="64.309" data-end="69.03">we made like robots and we made note</span> <span data-start="69.03" data-end="72.229">copters and we made freaking boats and</span> <span data-start="72.229" data-end="77.13">remain note rockets of course and you</span> <span data-start="77.13" data-end="79.259">really can't like summarize it any other</span> <span data-start="79.259" data-end="81.24">way than the javascript is freaking</span> <span data-start="81.24" data-end="83.34">awesome by the way when I came to this</span> <span data-start="83.34" data-end="84.95">conference I was talking to this person</span> <span data-start="84.95" data-end="88.77">telling like yeah I went to 15 j/s cops</span> <span data-start="88.77" data-end="91.319">already where she was saying like yeah</span> <span data-start="91.319" data-end="94.979">you're really old so there's that by</span> <span data-start="94.979" data-end="97.889">that so JavaScript really awesome but it</span> <span data-start="97.889" data-end="104.279">does have a really dark side and it's</span> <span data-start="104.279" data-end="106.759">getting darker when you talk about</span> <span data-start="106.759" data-end="110.639">third-party JavaScript or as I liked it</span> <span data-start="110.639" data-end="114.509">to call it other people JavaScript so</span> <span data-start="114.509" data-end="115.649">it's something we definitely didn't</span> <span data-start="115.649" data-end="118.38">write ourselves and it's also not stuff</span> <span data-start="118.38" data-end="120.569">on NPM which is typically something you</span> <span data-start="120.569" data-end="122.069">actually want because you like actively</span> <span data-start="122.069" data-end="124.619">included third-party JavaScript works</span> <span data-start="124.619" data-end="126.499">really differently and some examples are</span> <span data-start="126.499" data-end="130.59">for example comments and polls stuff</span> <span data-start="130.59" data-end="133.17">like reviews ads of course I'm going to</span> <span data-start="133.17" data-end="135.33">talk about ads about social plugins I</span> <span data-start="135.33" data-end="137.7">could put a tweet on your side right you</span> <span data-start="137.7" data-end="139.05">just load some javascript file from</span> </p>
<p><span data-start="139.05" data-end="140.25">Twitter and you trust them to do</span> <span data-start="140.25" data-end="143.73">something that's nice in it and it might</span> <span data-start="143.73" data-end="146.61">not be right um I always give this</span> <span data-start="146.61" data-end="147.09">example</span> <span data-start="147.09" data-end="148.47">when you like if you were building a</span> <span data-start="148.47" data-end="150.78">native app and the first thing you do</span> <span data-start="150.78" data-end="153.03">you say like hey I'm going to make it in</span> <span data-start="153.03" data-end="154.83">secure HTTP request and load some more</span> <span data-start="154.83" data-end="156.75">native code from this other third party</span> <span data-start="156.75" data-end="160.05">that I barely know and in the cat's case</span> <span data-start="160.05" data-end="161.7">they like redirect somewhere else and</span> <span data-start="161.7" data-end="164.58">then you load their native code before</span> <span data-start="164.58" data-end="166.41">anything else happens and run it and</span> <span data-start="166.41" data-end="169.739">that like seems really not such a good</span> <span data-start="169.739" data-end="171.42">idea but that's that's how this works</span> <span data-start="171.42" data-end="173.4">and I my talk is about like some</span> <span data-start="173.4" data-end="175.44">examples of what can happen and then</span> <span data-start="175.44" data-end="179.61">later on what we can do to handle it so</span> <span data-start="179.61" data-end="183.12">it's looking at my my site that had ads</span> <span data-start="183.12" data-end="185.04">the other day and I was searching in</span> <span data-start="185.04" data-end="188.61">chrome dev tools for the object tag you</span> <span data-start="188.61" data-end="192.12">know which is most I mean yesterday I</span> <span data-start="192.12" data-end="193.68">guess we learned that you can do useful</span> <span data-start="193.68" data-end="196.59">things with it mostly used alert to load</span> <span data-start="196.59" data-end="199.76">flash and so yeah so this page had 65</span> <span data-start="199.76" data-end="204.12">flash objects on them and so wondering</span> <span data-start="204.12" data-end="206.329">why and obviously it's because of ads</span> <span data-start="206.329" data-end="211.709">which doesn't really explain it um so so</span> <span data-start="211.709" data-end="217.049">but here is the the deep inside flash</span> <span data-start="217.049" data-end="219.45">movies reduce the frame rate when</span> <span data-start="219.45" data-end="221.22">they're off screen right and that is a</span> <span data-start="221.22" data-end="223.23">very good idea right that's even though</span> </p>
<p><span data-start="223.23" data-end="225.75">Steve Jobs was totally against flash if</span> <span data-start="225.75" data-end="227.28">you reduce the frame rate and you can't</span> <span data-start="227.28" data-end="228.84">see it that's great right you don't use</span> <span data-start="228.84" data-end="230.609">as much battery you don't use as much</span> <span data-start="230.609" data-end="235.349">CPU and so because of this you can use</span> <span data-start="235.349" data-end="237.419">flash to mathur measure whether</span> <span data-start="237.419" data-end="241.53">something's on the screen and that leads</span> <span data-start="241.53" data-end="244.349">us to space or dove Swift right so you</span> <span data-start="244.349" data-end="246.769">can totally put a 1 x 1 pixel flash</span> <span data-start="246.769" data-end="250.95">movie on on the screen and by observing</span> <span data-start="250.95" data-end="253.41">its frame rate you know whether that</span> <span data-start="253.41" data-end="257.25">pixel is visible and so you have things</span> <span data-start="257.25" data-end="266.13">ads and so yeah and so obviously it's</span> <span data-start="266.13" data-end="268.26">very important for the ad to actually</span> <span data-start="268.26" data-end="269.88">measure whether wishlists not rendered</span> <span data-start="269.88" data-end="272.039">somewhere deep down the screen where the</span> <span data-start="272.039" data-end="274.71">user actually scroll there so you put a</span> <span data-start="274.71" data-end="278.82">flash movie on it and I mean that's</span> <span data-start="278.82" data-end="280.98">already like a big step forward but</span> <span data-start="280.98" data-end="282.78">only tells you something like about the</span> <span data-start="282.78" data-end="287.91">top 00 position so you you you add three</span> <span data-start="287.91" data-end="290.76">flesh movies and there's actually I</span> <span data-start="290.76" data-end="292.37">think a standard that says like</span> <span data-start="292.37" data-end="294.87">twenty-five percent of the ad has to be</span> <span data-start="294.87" data-end="296.97">visible for n seconds to be considered a</span> <span data-start="296.97" data-end="299.31">view because you need to have these</span> <span data-start="299.31" data-end="302.72">twenty-five percent you add a few more</span> <span data-start="302.72" data-end="306.36">so it turns out there were seven flash</span> <span data-start="306.36" data-end="310.32">movies on this ad and now there's also</span> <span data-start="310.32" data-end="312.03">this issue that there's like the</span> <span data-start="312.03" data-end="314.16">advertiser the publisher the ad network</span> <span data-start="314.16" data-end="315.81">they don't trust each other so you you</span> <span data-start="315.81" data-end="317.88">can get to 21 flash movies on a single</span> <span data-start="317.88" data-end="321.53">ad totally not not not unheard of and</span> <span data-start="321.53" data-end="326.43">now you might like correctly question me</span> <span data-start="326.43" data-end="328.35">like yeah my phone doesn't actually a</span> <span data-start="328.35" data-end="331.86">flash them I'm good and of course it can</span> <span data-start="331.86" data-end="334.23">get even worse because the nice thing</span> <span data-start="334.23" data-end="336.33">about this flash solution is at least I</span> <span data-start="336.33" data-end="338.79">mean it's in a way incredibly</span> <span data-start="338.79" data-end="340.89">inefficient because certainly have</span> <span data-start="340.89" data-end="343.05">probably like a vm and each of these</span> <span data-start="343.05" data-end="345.66">flash things like so I mean you can't</span> <span data-start="345.66" data-end="348.99">even think about it but at least it will</span> <span data-start="348.99" data-end="350.79">like pushed you the information whether</span> <span data-start="350.79" data-end="352.8">it's visible on the screen right and um</span> <span data-start="352.8" data-end="356.22">so today on an iPhone this is basically</span> <span data-start="356.22" data-end="358.65">the best general solution you can you</span> <span data-start="358.65" data-end="362.58">can do all right well you just pull for</span> <span data-start="362.58" data-end="364.32">where it is right you can never know</span> <span data-start="364.32" data-end="367.05">that nothing else move to your round so</span> <span data-start="367.05" data-end="368.76">you can't like listen only for scroll</span> <span data-start="368.76" data-end="371.07">events because something like a thing</span> <span data-start="371.07" data-end="372.12">might be somewhere else right so you</span> <span data-start="372.12" data-end="373.5">have to like literally go and make like</span> <span data-start="373.5" data-end="376.8">get bounding client direct and call that</span> <span data-start="376.8" data-end="378.87">like however many times per second you</span> <span data-start="378.87" data-end="380.85">want and and that is really like the</span> <span data-start="380.85" data-end="382.86">worst possible thing you could do the</span> <span data-start="382.86" data-end="384.6">performance right you know you do this</span> <span data-start="384.6" data-end="385.92">all the time you don't in not even on</span> <span data-start="385.92" data-end="388.59">screen you're busy pulling like you're</span> <span data-start="388.59" data-end="390.09">probably calling something I'll get</span> </p>
<p><span data-start="390.09" data-end="391.26">Bonnie klein direct which is like</span> <span data-start="391.26" data-end="393.12">basically Tecna browse like you have to</span> <span data-start="393.12" data-end="394.56">really really really render everything</span> <span data-start="394.56" data-end="397.83">on this page you can't cheat like the</span> <span data-start="397.83" data-end="401.04">waveform collapses in this case like 25</span> <span data-start="401.04" data-end="404.67">times per second and so fortunately we</span> <span data-start="404.67" data-end="409.38">can do better nowadays it's it's in</span> <span data-start="409.38" data-end="411.03">chrome and I think it's coming in</span> <span data-start="411.03" data-end="413.91">Firefox and for Safari we can hope for</span> <span data-start="413.91" data-end="414.91">the 2007</span> <span data-start="414.91" data-end="416.86">version so there's an API called</span> <span data-start="416.86" data-end="419.14">intersection observer where you can just</span> <span data-start="419.14" data-end="420.34">say like I would like to know what this</span> <span data-start="420.34" data-end="422.89">is and where this is in relation to the</span> <span data-start="422.89" data-end="426.88">screen and it sends you events as things</span> <span data-start="426.88" data-end="428.29">change and it doesn't send you events</span> <span data-start="428.29" data-end="429.94">when they don't change and it also</span> <span data-start="429.94" data-end="431.38">doesn't change send you them</span> <span data-start="431.38" data-end="433.42">synchronously it tells you after the</span> <span data-start="433.42" data-end="435.34">fact at this time it was there so you</span> <span data-start="435.34" data-end="437.5">don't have to like do this busy waiting</span> <span data-start="437.5" data-end="439.6">so that's that's good so at least there</span> <span data-start="439.6" data-end="444.01">is a way to do this right um doesn't</span> <span data-start="444.01" data-end="445.87">mean everyone's using it already but I</span> <span data-start="445.87" data-end="449.92">think it's a great great change and you</span> <span data-start="449.92" data-end="451.63">can use this for other many many other</span> <span data-start="451.63" data-end="455.47">useful things alright so that was Hawaii</span> <span data-start="455.47" data-end="458.26">we have so much flesh next thing I want</span> <span data-start="458.26" data-end="460.69">to talk about how browsers parse web</span> <span data-start="460.69" data-end="466.36">pages it's it's really simple you take a</span> <span data-start="466.36" data-end="468.87">nation panel talk and look at its tokens</span> <span data-start="468.87" data-end="471.79">this is basically diagram there's a bit</span> <span data-start="471.79" data-end="475.2">more complexity there somewhere but</span> <span data-start="475.2" data-end="479.56">that's essentially how it works until</span> <span data-start="479.56" data-end="482.65">you see something like this probably all</span> <span data-start="482.65" data-end="488.38">heard about document right and the magic</span> <span data-start="488.38" data-end="489.82">of document ID right is completely</span> <span data-start="489.82" data-end="492.94">synchronous it changes how the current</span> <span data-start="492.94" data-end="495.94">document is being parsed so even if</span> <span data-start="495.94" data-end="498.34">there's like an openstack you can like</span> <span data-start="498.34" data-end="499.75">write into that because it's really</span> <span data-start="499.75" data-end="503.11">really weird and it gets worse because</span> <span data-start="503.11" data-end="504.43">you can actually write scripts</span> <span data-start="504.43" data-end="508.06">synchronous codes and those can do more</span> <span data-start="508.06" data-end="511.51">document or rights and that wonderful</span> <span data-start="511.51" data-end="514.24">simple state machine becomes something</span> <span data-start="514.24" data-end="516.82">like this so we like after parson we saw</span> <span data-start="516.82" data-end="518.979">we have a script tag we have to execute</span> <span data-start="518.979" data-end="521.59">it it document writes something we have</span> <span data-start="521.59" data-end="523.78">to parse the output oh there's another</span> <span data-start="523.78" data-end="525.91">script tag and then we download that and</span> <span data-start="525.91" data-end="528.07">then we basically we enter in our state</span> <span data-start="528.07" data-end="532.66">machine and things become really slow</span> <span data-start="532.66" data-end="536.47">right so the basically what you get in</span> <span data-start="536.47" data-end="538.27">like in JavaScript language is you have</span> <span data-start="538.27" data-end="540.91">the synchronous xhr that gets to modify</span> <span data-start="540.91" data-end="543.19">the currently parsing document and you</span> <span data-start="543.19" data-end="546.69">and that that is recursive right and</span> <span data-start="546.69" data-end="547.88">it's</span> <span data-start="547.88" data-end="552.17">in strong violation to what I call the</span> <span data-start="552.17" data-end="554.54">the first law of javascript is that they</span> <span data-start="554.54" data-end="558.47">all will eventually be asynchronous if</span> <span data-start="558.47" data-end="559.67">there's like you start our synchronous</span> <span data-start="559.67" data-end="560.96">because there's you only have to do like</span> <span data-start="560.96" data-end="562.19">one plus one eventually it will be</span> <span data-start="562.19" data-end="565.04">asynchronous but this entire the</span> <span data-start="565.04" data-end="567.68">semantics of document are right do not</span> <span data-start="567.68" data-end="570.77">allow anything to ever be asynchronous</span> <span data-start="570.77" data-end="574.4">so even though um every player in the</span> <span data-start="574.4" data-end="575.75">game might be completely fine with</span> <span data-start="575.75" data-end="578.06">making their stuff asynchronous if</span> <span data-start="578.06" data-end="580.7">anything relies on the synchronous</span> <span data-start="580.7" data-end="585.23">semantics you can't change it and so we</span> <span data-start="585.23" data-end="587.62">get to the opposite is if anything</span> <span data-start="587.62" data-end="590.66">relies on being synchronous obviously</span> <span data-start="590.66" data-end="592.4">every child has to be synchronous there</span> <span data-start="592.4" data-end="594.62">can't be anything asynchronous and and</span> <span data-start="594.62" data-end="596.56">and the thing is that synchronicity</span> <span data-start="596.56" data-end="601.73">really really doesn't scale so for</span> <span data-start="601.73" data-end="604.25">example um you're like on the website</span> <span data-start="604.25" data-end="605.78">and was like I would like to have a net</span> <span data-start="605.78" data-end="607.73">that's all these synchronous and then</span> <span data-start="607.73" data-end="608.93">but you don't really know how to make</span> <span data-start="608.93" data-end="610.73">add see you this is like another</span> <span data-start="610.73" data-end="612.26">javascript file leg do you know how to</span> <span data-start="612.26" data-end="613.73">make ads that's the synchronous request</span> <span data-start="613.73" data-end="617.21">and right cause like add source like</span> <span data-start="617.21" data-end="619.63">many players you like can you help us</span> <span data-start="619.63" data-end="621.62">find out which ad to draw another</span> <span data-start="621.62" data-end="624.68">synchronous request and then because you</span> <span data-start="624.68" data-end="625.61">found out that you make more money</span> <span data-start="625.61" data-end="627.2">that's Wade like let's ask these other</span> <span data-start="627.2" data-end="628.58">folks over there if they have better at</span> <span data-start="628.58" data-end="631.67">another synchronous request and then</span> <span data-start="631.67" data-end="633.8">they say no no weary soul this to some</span> <span data-start="633.8" data-end="636.44">other party and then they make another</span> <span data-start="636.44" data-end="637.97">synchronous request and then they</span> <span data-start="637.97" data-end="639.74">finally say okay now we try to figure</span> <span data-start="639.74" data-end="642.2">out how to make ads and it can be a bit</span> <span data-start="642.2" data-end="645.91">early deep which leads to these absurd</span> <span data-start="645.91" data-end="649.13">situations way where web page load times</span> <span data-start="649.13" data-end="650.84">get so slow that you can literally bake</span> <span data-start="650.84" data-end="654.08">cookies during them there's the chrome</span> <span data-start="654.08" data-end="656.51">team currently has this experiment where</span> <span data-start="656.51" data-end="658.94">they kill document right if you're on 2g</span> <span data-start="658.94" data-end="661.07">that's already launched and soon they</span> <span data-start="661.07" data-end="663.41">will always do it when you're on a 2g</span> <span data-start="663.41" data-end="665.96">like connection because you get you get</span> <span data-start="665.96" data-end="669.62">like document dot write like kiss gates</span> <span data-start="669.62" data-end="672.2">are 50 element deep if each request</span> <span data-start="672.2" data-end="674.45">takes 10 seconds you had 500 second web</span> <span data-start="674.45" data-end="675.86">page load time and you see absolutely</span> <span data-start="675.86" data-end="678.1">nothing at all during this entire time</span> <span data-start="678.1" data-end="682.75">which can't be good for anyone right</span> <span data-start="682.75" data-end="687.41">cool ah so we have how to measure</span> <span data-start="687.41" data-end="688.91">something on-screen how to load</span> <span data-start="688.91" data-end="691.67">something synchronously next is the what</span> </p>
<p><span data-start="691.67" data-end="695.41">I personally found like that was my own</span> <span data-start="695.41" data-end="697.97">impression was the the most awesome ack</span> <span data-start="697.97" data-end="701.06">hack in JavaScript ever was actually</span> <span data-start="701.06" data-end="703.67">done by Mozilla they may think called</span> <span data-start="703.67" data-end="707.24">Broadway jas and what they built was</span> <span data-start="707.24" data-end="709.79">this native JavaScript h.264 decoder</span> <span data-start="709.79" data-end="715.28">that was decently fast and so that that</span> <span data-start="715.28" data-end="716.57">seems like really cool like you can use</span> <span data-start="716.57" data-end="719.36">JavaScript to decode h.264 I think it's</span> <span data-start="719.36" data-end="723.02">pretty impressive now we need some more</span> <span data-start="723.02" data-end="727.4">context so Chrome Safari both agreed</span> <span data-start="727.4" data-end="730.49">that autoplay as a feature of the video</span> <span data-start="730.49" data-end="732.32">tag wasn't a good thing a noble right</span> <span data-start="732.32" data-end="734.06">and you can totally understand why they</span> <span data-start="734.06" data-end="735.95">would think this right autoplay means</span> <span data-start="735.95" data-end="737.3">definitely you have to download the</span> <span data-start="737.3" data-end="741.1">movie file so you incur data costs</span> <span data-start="741.1" data-end="743.66">definitely autoplay with sound can be</span> <span data-start="743.66" data-end="744.95">really awkward like you're on the bus</span> <span data-start="744.95" data-end="747.38">and you thing like place sound that you</span> <span data-start="747.38" data-end="749.3">don't want that so they they make this</span> <span data-start="749.3" data-end="750.35">decision on behalf of the user should</span> <span data-start="750.35" data-end="753.44">say like um you cannot like all the play</span> <span data-start="753.44" data-end="755.87">video users always have to tap to play</span> <span data-start="755.87" data-end="760.78">video combining this with Broadway jas</span> <span data-start="760.78" data-end="764.66">gets us to this right so some people</span> <span data-start="764.66" data-end="767.48">were like oh well you can't do autoplay</span> <span data-start="767.48" data-end="771.44">but we have a JavaScript side h.264</span> <span data-start="771.44" data-end="773">decoder so we can do autoplay because</span> <span data-start="773" data-end="775.55">that is not subject to any limitations</span> <span data-start="775.55" data-end="778.97">whatsoever and the consequences were</span> <span data-start="778.97" data-end="781.64">dire you still use the bandwidth</span> <span data-start="781.64" data-end="782.93">obviously because you download the video</span> <span data-start="782.93" data-end="785.51">now using like xhr you devastate the</span> <span data-start="785.51" data-end="788.54">battery because decoding and JavaScript</span> <span data-start="788.54" data-end="791.24">happens on the cpu this is typically on</span> <span data-start="791.24" data-end="795.74">devices that have you know a decoder in</span> <span data-start="795.74" data-end="797.42">hardware that could do this essentially</span> <span data-start="797.42" data-end="800.81">without using very little battery so</span> <span data-start="800.81" data-end="802.31">it's running totally on the UI thread</span> <span data-start="802.31" data-end="804.35">the page shanks because it runs on the</span> </p>
<p><span data-start="804.35" data-end="807.02">UI thread and and the worst part of this</span> <span data-start="807.02" data-end="810.98">is that now the legit players on this</span> <span data-start="810.98" data-end="814.07">Web like us basically we want to do</span> <span data-start="814.07" data-end="815.27">autoplay we can we</span> <span data-start="815.27" data-end="817.7">we wouldn't do this but the bad guys can</span> <span data-start="817.7" data-end="821.27">and so this is I think a good example</span> <span data-start="821.27" data-end="824.51">for how you have to be careful with</span> <span data-start="824.51" data-end="826.49">doing these interventions because the</span> <span data-start="826.49" data-end="829.13">workarounds which typically do exist</span> <span data-start="829.13" data-end="830.21">once you have a Turing complete</span> <span data-start="830.21" data-end="833.14">programming language can be much worse</span> <span data-start="833.14" data-end="835.61">all right this is the very dark part of</span> <span data-start="835.61" data-end="839.06">this talk um I wanted to continue and</span> <span data-start="839.06" data-end="841.76">talk about how we as developers can</span> <span data-start="841.76" data-end="846.23">handle it better my friend may know</span> <span data-start="846.23" data-end="848.06">typically says like let's put on the web</span> <span data-start="848.06" data-end="850.73">wetsuit and jump into the like how</span> <span data-start="850.73" data-end="854.81">can we how come we embrace the bad thing</span> <span data-start="854.81" data-end="859.58">and at least handle it and as this comes</span> <span data-start="859.58" data-end="862.58">back for when we like basically we're</span> <span data-start="862.58" data-end="864.08">working on amp and we're thinking like</span> <span data-start="864.08" data-end="867.29">how can we you know we this stuff is on</span> <span data-start="867.29" data-end="868.88">the web we have to deal with it like</span> <span data-start="868.88" data-end="871.43">it's there what can we do and so we</span> <span data-start="871.43" data-end="875.66">decided to basically put all the like 3p</span> <span data-start="875.66" data-end="879.65">code behind this barbed wire fence and</span> <span data-start="879.65" data-end="881.69">on the web that always means essentially</span> <span data-start="881.69" data-end="886.43">an iframe and and the first thing we did</span> <span data-start="886.43" data-end="888.59">was pretty simple I think it makes a lot</span> <span data-start="888.59" data-end="890.9">of sense which that it once you haven't</span> <span data-start="890.9" data-end="892.49">like something i frame you can decide</span> <span data-start="892.49" data-end="895.34">not to load it load content first then</span> <span data-start="895.34" data-end="897.95">you look everything else let's pray say</span> <span data-start="897.95" data-end="904">forward next part is that what i call a</span> <span data-start="904" data-end="908.93">generally containment right so if if you</span> <span data-start="908.93" data-end="910.88">need to load someone else's code having</span> <span data-start="910.88" data-end="913.1">it in an iframe sandbox can be very</span> <span data-start="913.1" data-end="916.01">useful it gives you you know better</span> <span data-start="916.01" data-end="918.98">security for example in amp when you</span> <span data-start="918.98" data-end="920.93">load an ad it will be on a randomly</span> <span data-start="920.93" data-end="923">generated domain right so they can</span> <span data-start="923" data-end="925.1">totally go and set some like local</span> <span data-start="925.1" data-end="927.2">storage but they will never again at</span> <span data-start="927.2" data-end="930.56">least in the time of the current</span> <span data-start="930.56" data-end="933.95">universe that same domain right so that</span> <span data-start="933.95" data-end="936.71">local storage is just gone um and then</span> <span data-start="936.71" data-end="938">there's not the middle also means</span> <span data-start="938" data-end="939.17">there's nothing on it that you could</span> <span data-start="939.17" data-end="942.65">hack right you have control of our</span> <span data-start="942.65" data-end="945.5">resizing because like in typically the</span> <span data-start="945.5" data-end="947">third party code you load it into your</span> <span data-start="947" data-end="948.65">page they own everything they can do</span> <span data-start="948.65" data-end="948.95">whatever</span> <span data-start="948.95" data-end="951.38">they want once it's an iframe they have</span> <span data-start="951.38" data-end="953.12">to ask you like I would like to be</span> <span data-start="953.12" data-end="955.85">bigger and then you can say no or like</span> <span data-start="955.85" data-end="959.24">yeah it's cool but it's up to you and I</span> <span data-start="959.24" data-end="962.57">think one of the also not obvious things</span> <span data-start="962.57" data-end="965.27">is once you have it an iframe you can</span> <span data-start="965.27" data-end="968.72">just kill the iframe so one thing well</span> <span data-start="968.72" data-end="971.51">if everything's on the same frame you</span> <span data-start="971.51" data-end="973.52">load the JavaScript like it's very it's</span> <span data-start="973.52" data-end="975.26">like you could kill the Dom they render</span> <span data-start="975.26" data-end="977.03">it but all this would still be</span> <span data-start="977.03" data-end="978.74">there they might hold onto references</span> <span data-start="978.74" data-end="980.21">the Dom so it couldn't really be garbage</span> <span data-start="980.21" data-end="982.55">collected so having an eye from is very</span> <span data-start="982.55" data-end="986.54">clean that you can say ah go away and it</span> <span data-start="986.54" data-end="988.04">really has gone that the memory comes</span> <span data-start="988.04" data-end="991.97">back and the best feature which isn't</span> <span data-start="991.97" data-end="995.75">completely obvious is that iframes also</span> <span data-start="995.75" data-end="999.47">made a gate documented right so um and</span> <span data-start="999.47" data-end="1000.67">this is completely not obvious I think</span> <span data-start="1000.67" data-end="1002.5">on so if you have a documented right in</span> <span data-start="1002.5" data-end="1005.11">iframe that doesn't actually have the</span> <span data-start="1005.11" data-end="1009.24">same blocking behavior on the other page</span> <span data-start="1009.24" data-end="1012.94">yeah last thing that we do and which we</span> <span data-start="1012.94" data-end="1014.56">so far haven't really talked about</span> <span data-start="1014.56" data-end="1016.06">because it's a kind of a get in mouse</span> <span data-start="1016.06" data-end="1020.77">game is that we intervene on behalf of</span> <span data-start="1020.77" data-end="1024.88">the user so we it's not a thing if you</span> <span data-start="1024.88" data-end="1025.99">have something I frame you can like</span> <span data-start="1025.99" data-end="1028.06">globally change everything in it but</span> <span data-start="1028.06" data-end="1030.13">it's our iframe and so we can throttle</span> <span data-start="1030.13" data-end="1036.28">timers and probably shouldn't use these</span> <span data-start="1036.28" data-end="1037.54">words because they sound really</span> <span data-start="1037.54" data-end="1040">dangerous but basically what there is so</span> <span data-start="1040" data-end="1041.62">there's code in that I frame that says</span> <span data-start="1041.62" data-end="1043.839">oh you made another child iframe i'm</span> <span data-start="1043.839" data-end="1046.36">going to go there and do the same thing</span> <span data-start="1046.36" data-end="1048.7">and what I'm doing is I am throttling</span> <span data-start="1048.7" data-end="1052.96">timers so I like I'm going to show code</span> <span data-start="1052.96" data-end="1054.58">for that so basically if something's not</span> <span data-start="1054.58" data-end="1057.13">on screen like why should you be able to</span> <span data-start="1057.13" data-end="1059.08">like call set interval with like 16</span> <span data-start="1059.08" data-end="1060.76">milliseconds right it doesn't really</span> <span data-start="1060.76" data-end="1063.19">make sense um but they do it all the</span> <span data-start="1063.19" data-end="1067.36">time so we have code like this and its</span> <span data-start="1067.36" data-end="1070.81">really like this is really dirty so one</span> <span data-start="1070.81" data-end="1072.76">like basically there's just one example</span> <span data-start="1072.76" data-end="1075.49">there's like five similar monkey</span> <span data-start="1075.49" data-end="1077.83">patching functions that go through all</span> <span data-start="1077.83" data-end="1080.74">the various ways how you could create an</span> <span data-start="1080.74" data-end="1081.91">iframe</span> <span data-start="1081.91" data-end="1084.34">and one of them is that you create an</span> <span data-start="1084.34" data-end="1086.08">iframe but a new document right into the</span> <span data-start="1086.08" data-end="1087.55">iframe there's actually a legit use of</span> <span data-start="1087.55" data-end="1089.65">document right but in this case you have</span> <span data-start="1089.65" data-end="1092.65">to call document close and so we monkey</span> <span data-start="1092.65" data-end="1095.5">patch it we eventually call the original</span> <span data-start="1095.5" data-end="1098.32">but we basically be just before calling</span> <span data-start="1098.32" data-end="1100.48">that close we documented write another</span> <span data-start="1100.48" data-end="1102.73">script tag into the iframe and basically</span> <span data-start="1102.73" data-end="1106.57">recursively call us to run that same</span> <span data-start="1106.57" data-end="1108.88">kind of we call it manage it's like a</span> <span data-start="1108.88" data-end="1112.6">nice word for like 40 link timers so we</span> <span data-start="1112.6" data-end="1114.73">go into a recursive time I frame and and</span> <span data-start="1114.73" data-end="1117.04">run the same code again and again and</span> <span data-start="1117.04" data-end="1119.8">the actual code looks like this so again</span> <span data-start="1119.8" data-end="1122.71">we monkey patch set timeout in this case</span> <span data-start="1122.71" data-end="1124.27">and there's like similar code for like</span> <span data-start="1124.27" data-end="1126.55">set interval requestanimationframe and</span> <span data-start="1126.55" data-end="1130.63">in various cases in there and so x is</span> <span data-start="1130.63" data-end="1132.73">one of the simplest one so we basically</span> <span data-start="1132.73" data-end="1135.61">just forward the set time a call to the</span> <span data-start="1135.61" data-end="1138.1">system set timeout but before doing so</span> <span data-start="1138.1" data-end="1142.78">we we overwrite the time at least</span> <span data-start="1142.78" data-end="1145.12">potentially the second function is the</span> <span data-start="1145.12" data-end="1146.86">function we actually have so what we</span> <span data-start="1146.86" data-end="1151.54">saying is if you're in viewport you get</span> <span data-start="1151.54" data-end="1153.46">whatever time you want it but if you're</span> <span data-start="1153.46" data-end="1155.74">not in viewport we'll just add a second</span> <span data-start="1155.74" data-end="1158.98">to whatever you ask it makes sense to</span> <span data-start="1158.98" data-end="1160.57">always add a second because that means</span> <span data-start="1160.57" data-end="1162.43">the order that they expect is still the</span> <span data-start="1162.43" data-end="1164.02">same right you go from like 10</span> <span data-start="1164.02" data-end="1167.35">milliseconds to 1010 or went from like</span> <span data-start="1167.35" data-end="1168.85">even if they ask for 10 which will be</span> <span data-start="1168.85" data-end="1171.07">legit they get 11 so that's kind of like</span> <span data-start="1171.07" data-end="1173.11">doesn't really matter we wouldn't have</span> <span data-start="1173.11" data-end="1174.85">cared but at least the orders now as</span> <span data-start="1174.85" data-end="1178.15">expected and so so all of these things</span> <span data-start="1178.15" data-end="1179.98">together really make a difference so we</span> </p>
<p><span data-start="1179.98" data-end="1182.56">I particularly saw this ad that was</span> <span data-start="1182.56" data-end="1186.04">using this like Bravo ajs style h.264</span> <span data-start="1186.04" data-end="1189.25">decoding and it was um even if the ad</span> <span data-start="1189.25" data-end="1191.89">was invisible the page was basically</span> <span data-start="1191.89" data-end="1195.82">unusable and with this code the page is</span> <span data-start="1195.82" data-end="1198.07">only in visit unusable when you see the</span> <span data-start="1198.07" data-end="1200.17">ad which is actually a big step forward</span> <span data-start="1200.17" data-end="1201.55">because you can start reading everything</span> <span data-start="1201.55" data-end="1203.65">else and you can like scroll away</span> <span data-start="1203.65" data-end="1205.03">because it's like almost as big as the</span> <span data-start="1205.03" data-end="1208.47">screen and then everything works again</span> <span data-start="1208.47" data-end="1213.93">right and and so</span> <span data-start="1213.94" data-end="1216.909">we the questions like whether we</span> <span data-start="1216.909" data-end="1218.35">actually went to the AP website and</span> <span data-start="1218.35" data-end="1221.62">licensed this picture which you can I</span> <span data-start="1221.62" data-end="1227.86">learned yes are we done I you know I</span> <span data-start="1227.86" data-end="1230.71">think that like this type of mitigation</span> <span data-start="1230.71" data-end="1233.62">where you handle someone else's code is</span> <span data-start="1233.62" data-end="1235.6">very very important because third-party</span> <span data-start="1235.6" data-end="1237.909">javascript is everywhere and like you</span> <span data-start="1237.909" data-end="1239.23">totally want to show some tweet</span> <span data-start="1239.23" data-end="1241.99">somewhere right and that's fine um so</span> <span data-start="1241.99" data-end="1243.73">it's not something that's going to go</span> <span data-start="1243.73" data-end="1246.58">away and that's why I think it's</span> <span data-start="1246.58" data-end="1248.2">important to talk about how you can</span> <span data-start="1248.2" data-end="1252.73">handle it but in the I think in the</span> <span data-start="1252.73" data-end="1255.07">particular ads case we can actually do</span> <span data-start="1255.07" data-end="1257.86">better so I again like I'm obviously</span> <span data-start="1257.86" data-end="1259.75">working at Google we do render some of</span> <span data-start="1259.75" data-end="1262.149">the ads in the internet so I think like</span> <span data-start="1262.149" data-end="1265.99">my team is both the privilege and the in</span> <span data-start="1265.99" data-end="1268.659">some words responsibility to actually</span> <span data-start="1268.659" data-end="1272.529">fix it so I'm not actually going to dive</span> <span data-start="1272.529" data-end="1275.799">into what exactly we're going to do but</span> </p>
<p><span data-start="1275.799" data-end="1279.7">I I did write a long blog post about</span> <span data-start="1279.7" data-end="1283.09">this a bit ly flash and for as the</span> <span data-start="1283.09" data-end="1285.639">number of ads for our details for the</span> <span data-start="1285.639" data-end="1288.94">long term plan so basically while there</span> <span data-start="1288.94" data-end="1290.289">still will be JavaScript around</span> <span data-start="1290.289" data-end="1293.1">everywhere we're super super hopeful</span> <span data-start="1293.1" data-end="1298.289">that we can at least have a more like</span> <span data-start="1298.289" data-end="1301.029">like a healthier at advertising</span> <span data-start="1301.029" data-end="1303.509">ecosystem were like you don't have to</span> <span data-start="1303.509" data-end="1305.98">mitigate them like everyone's kind of a</span> <span data-start="1305.98" data-end="1308.7">legit player yeah that's all I have</span> <span data-start="1308.7" data-end="1311.2">again I'm melta crime force on on</span> </p>
<p><span data-start="1311.2" data-end="1313.269">Twitter github etcetera thank you very</span> </p>
</section>