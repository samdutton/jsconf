<section>
<p><span data-start="37.66" data-end="41.449">we need native code on the web right now</span> <span data-start="41.449" data-end="44.3">you can write applications in any</span> <span data-start="44.3" data-end="46.55">language you want as long as it's</span> <span data-start="46.55" data-end="49.309">JavaScript so this is a funny thing to</span> <span data-start="49.309" data-end="52.609">complain about as this is jas conf but</span> <span data-start="52.609" data-end="54.949">if you think a look at the larger arc</span> <span data-start="54.949" data-end="57.64">right now javascript has a very</span> <span data-start="57.64" data-end="61.519">privileged position on the web and all</span> <span data-start="61.519" data-end="63.62">other platforms usually have a way that</span> <span data-start="63.62" data-end="66.53">they can call out to C or C++ or some</span> <span data-start="66.53" data-end="70.49">other language and this creates a lot of</span> <span data-start="70.49" data-end="72.35">lost opportunity costs such as</span> <span data-start="72.35" data-end="74.99">integrating with existing libraries or</span> <span data-start="74.99" data-end="77.659">making it easy to port between cell</span> <span data-start="77.659" data-end="79.64">phone applications and the web and</span> <span data-start="79.64" data-end="81.979">things along those lines so before we</span> <span data-start="81.979" data-end="84.71">get into the Nitty Gritty of native code</span> <span data-start="84.71" data-end="88.369">it's worth remembering why we love the</span> <span data-start="88.369" data-end="92.39">web the web is secure and by secure we</span> <span data-start="92.39" data-end="93.92">mean that you can point your web browser</span> <span data-start="93.92" data-end="97.13">at nearly any website run the</span> <span data-start="97.13" data-end="99.259">application and not worry that will</span> <span data-start="99.259" data-end="101.03">upload your financial information to</span> <span data-start="101.03" data-end="104.57">some arbitrary website so cat videos no</span> <span data-start="104.57" data-end="107.299">theft that's a good thing the web is</span> <span data-start="107.299" data-end="110.57">portable you can view it on any computer</span> <span data-start="110.57" data-end="111.829">in the operating system as long as</span> <span data-start="111.829" data-end="113.03">there's a web browser you can view it</span> <span data-start="113.03" data-end="115.729">from your cell phone it's it just runs</span> <span data-start="115.729" data-end="117.17">everywhere there's a web browser this is</span> <span data-start="117.17" data-end="120.17">great it's ephemeral so you don't have</span> <span data-start="120.17" data-end="122.329">to install anything you just point your</span> <span data-start="122.329" data-end="123.92">web browser go you don't have to</span> <span data-start="123.92" data-end="125.63">uninstall anything you don't have to</span> <span data-start="125.63" data-end="127.729">have automatic computer clean up or</span> <span data-start="127.729" data-end="130.369">anything like that that's all done in</span> <span data-start="130.369" data-end="131.44">the cache</span> <span data-start="131.44" data-end="135.01">and the web is well not very compatible</span> <span data-start="135.01" data-end="136.63">with other platforms it's kind of it's</span> <span data-start="136.63" data-end="140.35">an own Island so the reason this is is</span> <span data-start="140.35" data-end="141.64">because of all the things that make the</span> <span data-start="141.64" data-end="145">web good so the web is secure well this</span> <span data-start="145" data-end="147.25">doesn't mean that native applications</span> <span data-start="147.25" data-end="149.17">are insecure it just means that they</span> <span data-start="149.17" data-end="151.03">have an entirely different definition of</span> <span data-start="151.03" data-end="153.97">what this means so on the web it assumes</span> <span data-start="153.97" data-end="155.62">your application is running on behalf of</span> <span data-start="155.62" data-end="157.63">where you get it from whereas when you</span> <span data-start="157.63" data-end="159.31">run your native application it assumes</span> <span data-start="159.31" data-end="161.44">it's running on behalf of you so the</span> <span data-start="161.44" data-end="163.12">native application can access your</span> <span data-start="163.12" data-end="165.64">financial information because it's you</span> <span data-start="165.64" data-end="168.07">and native applications are typically</span> <span data-start="168.07" data-end="170.53">compiled down onto the machine so they</span> <span data-start="170.53" data-end="172.45">aren't they haven't traditionally been</span> <span data-start="172.45" data-end="174.4">built for portability and you typically</span> <span data-start="174.4" data-end="177.73">install these so we'll get the plugins</span> <span data-start="177.73" data-end="179.02">in a moment but if you have to install</span> <span data-start="179.02" data-end="181.24">something on the web you lose ninety</span> <span data-start="181.24" data-end="182.83">percent of your user seventy ninety</span> <span data-start="182.83" data-end="185.2">percent of you users right there so if</span> <span data-start="185.2" data-end="187.51">we want native code to work on the web</span> <span data-start="187.51" data-end="189.46">it has to behave like the web it has to</span> <span data-start="189.46" data-end="193">be secure portable and ephemeral we've</span> <span data-start="193" data-end="195.73">tried this so everyone remembers NPAPI</span> <span data-start="195.73" data-end="200.29">flash java activex some people even even</span> <span data-start="200.29" data-end="202.18">tried to hack the browser in order to</span> <span data-start="202.18" data-end="204.34">get this working and these ultimately</span> <span data-start="204.34" data-end="207.28">these approaches fall down because it's</span> </p>
<p><span data-start="207.28" data-end="210.37">JavaScript its web content which calls</span> <span data-start="210.37" data-end="212.14">into native code and then the native</span> <span data-start="212.14" data-end="214.42">code tries to do its best job pretending</span> <span data-start="214.42" data-end="216.76">it's just as secure as JavaScript but</span> <span data-start="216.76" data-end="218.35">ultimately there are security exploits</span> <span data-start="218.35" data-end="220.3">and you only get security that's as good</span> <span data-start="220.3" data-end="223.209">as the weakest link in the chain so gen</span> <span data-start="223.209" data-end="226.03">2 is people finally learn from the pain</span> <span data-start="226.03" data-end="227.56">and said why don't we try to do things</span> <span data-start="227.56" data-end="229.87">which behave as if they are web content</span> <span data-start="229.87" data-end="232.36">they're secure portable ephemeral so</span> <span data-start="232.36" data-end="235.06">there is portable Native Client which is</span> <span data-start="235.06" data-end="238.269">in chrome and allows you to take a</span> <span data-start="238.269" data-end="242.53">portable binary essentially and run it</span> <span data-start="242.53" data-end="244.54">inside your web browser and then there's</span> </p>
<p><span data-start="244.54" data-end="248.2">Emscripten which compiles native code</span> <span data-start="248.2" data-end="250.54">into JavaScript and this is one of the</span> <span data-start="250.54" data-end="252.43">main reasons that this is going to be</span> <span data-start="252.43" data-end="254.62">talked about at JS conf is because it</span> <span data-start="254.62" data-end="257.98">concerns JavaScript and what the future</span> <span data-start="257.98" data-end="259.72">of JavaScript could be to support this</span> <span data-start="259.72" data-end="262.03">kind of workflow and a lot of you have</span> <span data-start="262.03" data-end="264.28">probably heard of as MJ s and this is</span> <span data-start="264.28" data-end="264.97">actually</span> <span data-start="264.97" data-end="266.74">what happens after em scripting gets a</span> <span data-start="266.74" data-end="268.78">hold of it is it describes a specific</span> <span data-start="268.78" data-end="270.85">format that M script and generates so</span> <span data-start="270.85" data-end="272.35">for this talk I will be talking about</span> </p>
<p><span data-start="272.35" data-end="274.21">Emscripten but in your mind you can</span> <span data-start="274.21" data-end="277.59">wildcard that too as MJS if you wish</span> <span data-start="277.59" data-end="281.11">pinnacle portable Native Client works</span> <span data-start="281.11" data-end="282.91">like a traditional compiler is you take</span> <span data-start="282.91" data-end="285.7">a bunch of C++ source files you pass it</span> <span data-start="285.7" data-end="287.83">to a slightly modified version of llvm</span> <span data-start="287.83" data-end="289.87">and it produces a portable executable</span> <span data-start="289.87" data-end="291.97">this portable executable is a</span> <span data-start="291.97" data-end="294.97">serialization of lv M's internal format</span> <span data-start="294.97" data-end="297.82">then inside the browser your web page</span> <span data-start="297.82" data-end="299.92">says hey I want to embed this portable</span> <span data-start="299.92" data-end="303.04">executable so chrome grabs it downloads</span> <span data-start="303.04" data-end="305.59">it and then looks at it and says hey I</span> <span data-start="305.59" data-end="307.87">can't actually run portable code you</span> <span data-start="307.87" data-end="309.64">know my processor isn't portable it's a</span> <span data-start="309.64" data-end="311.65">real processor so then it goes and</span> <span data-start="311.65" data-end="314.05">translates it into what the local code</span> <span data-start="314.05" data-end="316.09">is and it does a few tricks to make sure</span> <span data-start="316.09" data-end="318.61">we can verify the code is safe so at</span> <span data-start="318.61" data-end="320.26">runtime you get a set up that's a little</span> <span data-start="320.26" data-end="323.08">bit like this is that there is a Knakal</span> <span data-start="323.08" data-end="324.4">process running these specially</span> <span data-start="324.4" data-end="326.62">generating machine instructions which is</span> <span data-start="326.62" data-end="328.78">your native code executing and then when</span> <span data-start="328.78" data-end="330.25">one is interact when it wants to</span> <span data-start="330.25" data-end="332.05">interact with the web page it does</span> <span data-start="332.05" data-end="334.96">postmessage so javascript is sitting</span> <span data-start="334.96" data-end="336.4">there can send messages back and forth</span> <span data-start="336.4" data-end="339.16">and one of the issues is that you don't</span> <span data-start="339.16" data-end="341.35">have direct access to the dome so the</span> <span data-start="341.35" data-end="343.39">dom is very much single threaded only</span> <span data-start="343.39" data-end="345.43">accessible by javascript and it's very</span> <span data-start="345.43" data-end="347.5">jealous of this fact so you typically</span> <span data-start="347.5" data-end="348.88">have to have some glue if you want to</span> <span data-start="348.88" data-end="350.229">modify the actual web page an</span> <span data-start="350.229" data-end="352.51">interesting thing is that when you have</span> <span data-start="352.51" data-end="354.31">an apple process it can only talk to the</span> <span data-start="354.31" data-end="356.74">browser it cannot talk directly to the</span> <span data-start="356.74" data-end="358.78">operating system and this means that the</span> <span data-start="358.78" data-end="361.18">browser notion of security is preserved</span> <span data-start="361.18" data-end="364.15">so you can't access an arbitrary file on</span> <span data-start="364.15" data-end="366.46">the disk but you can get any Earl that</span> </p>
<p><span data-start="366.46" data-end="369.1">JavaScript would be able to get and the</span> <span data-start="369.1" data-end="370.81">API that this done with is called pepper</span> <span data-start="370.81" data-end="372.76">and it's essentially functionally</span> <span data-start="372.76" data-end="374.47">equivalent with what javascript has in</span> <span data-start="374.47" data-end="378.07">terms of xml httprequest WebGL it's just</span> <span data-start="378.07" data-end="380.979">a different language binding for that M</span> <span data-start="380.979" data-end="382.51">scripting on the other hand takes the</span> <span data-start="382.51" data-end="384.729">approach where it says here's some C</span> <span data-start="384.729" data-end="386.5">code and I'm going to do some</span> <span data-start="386.5" data-end="388.09">transformations on it so it's actually</span> <span data-start="388.09" data-end="390.64">semantically equivalent JavaScript so</span> <span data-start="390.64" data-end="392.53">this is an add function which is pretty</span> <span data-start="392.53" data-end="394.39">dup a little bit to use pointers so we</span> <span data-start="394.39" data-end="395.979">actually see some memory operations in</span> <span data-start="395.979" data-end="397.87">the output but it's more or less what</span> <span data-start="397.87" data-end="398.71">you'd expect</span> <span data-start="398.71" data-end="399.91">if you kind of squint through all the</span> <span data-start="399.91" data-end="402.01">cruft in there there's a load from</span> <span data-start="402.01" data-end="404.56">memory another load from memory and then</span> <span data-start="404.56" data-end="406.6">it adds together so you'll see there's a</span> <span data-start="406.6" data-end="409.54">lot of or zeros in there and these are</span> <span data-start="409.54" data-end="411.49">bitwise operations where you're doing a</span> <span data-start="411.49" data-end="414.4">bitwise or with 0 which if you know how</span> <span data-start="414.4" data-end="416.5">or works that should be a no op you know</span> <span data-start="416.5" data-end="418.9">or with zero equals what you put in but</span> <span data-start="418.9" data-end="421.03">the trick is is that JavaScript coerces</span> <span data-start="421.03" data-end="423.7">anything you or with 0 into a 32-bit</span> <span data-start="423.7" data-end="427.24">integer so if you have a string or if</span> <span data-start="427.24" data-end="430.3">you have a double it'll mangle it until</span> <span data-start="430.3" data-end="432.01">it looks like an integer and then you</span> <span data-start="432.01" data-end="433.54">can do operations on it so this is what</span> <span data-start="433.54" data-end="435.97">azimuth is they've essentially smuggled</span> <span data-start="435.97" data-end="438.97">in type annotations to language by</span> <span data-start="438.97" data-end="441.1">exploiting the semantics of JavaScript</span> <span data-start="441.1" data-end="444.34">really weird corner cases another thing</span> <span data-start="444.34" data-end="446.05">to pay attention to is that a memory</span> <span data-start="446.05" data-end="447.67">access where you're just saying hey I</span> <span data-start="447.67" data-end="449.13">want this address in memory is</span> <span data-start="449.13" data-end="452.95">transformed into an indexed operation in</span> <span data-start="452.95" data-end="455.26">index operation into a typed array so if</span> <span data-start="455.26" data-end="456.73">you're familiar with the ray buffers and</span> <span data-start="456.73" data-end="458.65">typed array views that's what's going on</span> <span data-start="458.65" data-end="460.47">the bottom is it's taking a pointer and</span> <span data-start="460.47" data-end="463.66">because the array view the indexing</span> <span data-start="463.66" data-end="465.46">isn't bite for bite instead like if it's</span> <span data-start="465.46" data-end="467.62">a 32-bit integer it's indexing four</span> <span data-start="467.62" data-end="469.42">bytes at a time you have to drop the</span> <span data-start="469.42" data-end="471.07">lower two bits of the address divide it</span> <span data-start="471.07" data-end="473.44">by 4 so that turns a pointer address and</span> <span data-start="473.44" data-end="475.24">do an array index interesting</span> <span data-start="475.24" data-end="477.67">consequences of this is that the address</span> <span data-start="477.67" data-end="480.01">you look up isn't exactly the address</span> <span data-start="480.01" data-end="482.14">you'd normally get a native code usually</span> <span data-start="482.14" data-end="483.46">it doesn't matter but there's a few</span> <span data-start="483.46" data-end="484.9">corner cases we're dropping the lower</span> <span data-start="484.9" data-end="486.91">two bits can bite you there's also the</span> <span data-start="486.91" data-end="488.77">question of null pointers so see</span> <span data-start="488.77" data-end="492.07">typically says the the pointer 0 is in</span> <span data-start="492.07" data-end="493.51">some ways equivalent to null or</span> <span data-start="493.51" data-end="495.64">in javascript is it just means</span> <span data-start="495.64" data-end="497.5">there's nothing there and you should</span> <span data-start="497.5" data-end="499.57">always check if it's know before you use</span> <span data-start="499.57" data-end="501.88">it but if you use null in this case it's</span> <span data-start="501.88" data-end="504.34">like well let me get address it data</span> <span data-start="504.34" data-end="506.77">address 0 oh here's the data at address</span> <span data-start="506.77" data-end="508.75">0 so it doesn't complain usually with</span> <span data-start="508.75" data-end="510.91">native code it will kill the process or</span> <span data-start="510.91" data-end="513.85">something along those lines at runtime</span> <span data-start="513.85" data-end="515.56">when you use I'm script it looks like</span> <span data-start="515.56" data-end="517.69">this is your compiled code is actually</span> <span data-start="517.69" data-end="521.47">running inside the very same thread as</span> <span data-start="521.47" data-end="523.51">the rest of the JavaScript code and when</span> <span data-start="523.51" data-end="525.28">you want to call out of the compiled</span> <span data-start="525.28" data-end="526.54">code it's just calling a javascript</span> <span data-start="526.54" data-end="528.55">function so it's a very quick</span> <span data-start="528.55" data-end="530.77">synchronous bridge so with a little bit</span> <span data-start="530.77" data-end="531.49">of wrapping you</span> <span data-start="531.49" data-end="533.11">get synchronous access to the dom and</span> <span data-start="533.11" data-end="535.57">both the compiled code and the j s code</span> <span data-start="535.57" data-end="538.36">has access to this big array which it</span> <span data-start="538.36" data-end="539.709">says is equivalent to the native</span> <span data-start="539.709" data-end="542.5">machines memory the consequences of this</span> <span data-start="542.5" data-end="544.3">approach is that your native code is</span> <span data-start="544.3" data-end="547.2">sharing the same thread as javascript</span> <span data-start="547.2" data-end="549.55">which means that it has to obey the same</span> <span data-start="549.55" data-end="552.73">rules as javascript it can't block you</span> <span data-start="552.73" data-end="554.68">have to periodically relinquish control</span> <span data-start="554.68" data-end="557.05">and there's no other threads so this</span> <span data-start="557.05" data-end="558.73">means that if you're porting to use on</span> <span data-start="558.73" data-end="561.16">script and you have to potential e spend</span> <span data-start="561.16" data-end="563.44">a lot of time refactoring your code so</span> <span data-start="563.44" data-end="565.75">that it behaves like JavaScript it's</span> <span data-start="565.75" data-end="568">asynchronous callback driven and for</span> <span data-start="568" data-end="569.92">some native applications this is a step</span> <span data-start="569.92" data-end="571.99">too far so a lot of the stuff we see</span> <span data-start="571.99" data-end="573.58">nowadays that's being compiled to the</span> <span data-start="573.58" data-end="576.16">web is the stuff that works easily but</span> <span data-start="576.16" data-end="577.779">there's still a lot of stuff we haven't</span> <span data-start="577.779" data-end="579.88">been able to do because of the blocking</span> <span data-start="579.88" data-end="582.459">and threading issues this leaves you</span> <span data-start="582.459" data-end="585.339">with the dilemma is you can go pinnacle</span> <span data-start="585.339" data-end="588.1">and you say hey it has threads it's a</span> <span data-start="588.1" data-end="590.529">little bit faster it's closer to what we</span> <span data-start="590.529" data-end="592.81">expect there's fewer gotchas but on the</span> <span data-start="592.81" data-end="594.04">other hand if we go the unscripted</span> <span data-start="594.04" data-end="596.05">approach it runs everywhere javascript</span> <span data-start="596.05" data-end="599.41">runs and in many cases it's easier just</span> <span data-start="599.41" data-end="601.06">to synchronously access the Dom you</span> <span data-start="601.06" data-end="602.61">don't have a synchronous post messages</span> <span data-start="602.61" data-end="606.25">so it's a dilemma is we have to not yet</span> <span data-start="606.25" data-end="610.899">perfect solutions and what can we do it</span> <span data-start="610.899" data-end="612.49">turns out that these solutions are</span> <span data-start="612.49" data-end="614.56">actually closer in many ways than you'd</span> <span data-start="614.56" data-end="616.51">expect they're both built on top of the</span> <span data-start="616.51" data-end="620.35">lvm tool chain and they both are trying</span> <span data-start="620.35" data-end="622.72">to produce portable native code so a lot</span> <span data-start="622.72" data-end="624.52">of the tricks you have to do to get</span> <span data-start="624.52" data-end="626.05">portable native code working they're</span> <span data-start="626.05" data-end="628.72">both doing the same thing so I thought</span> <span data-start="628.72" data-end="632.37">why not create a polyfill that provides</span> <span data-start="632.37" data-end="635.89">pinnacles interface to M script them so</span> <span data-start="635.89" data-end="637.24">if you're willing to get rid of your</span> <span data-start="637.24" data-end="639.49">threads and you're willing to make sure</span> <span data-start="639.49" data-end="641.89">your programs asynchronous then you can</span> <span data-start="641.89" data-end="644.23">take the same code base and compile it</span> <span data-start="644.23" data-end="646.75">using both technologies and I call this</span> <span data-start="646.75" data-end="649.149">pepper jazz because it's ajs polyfill of</span> <span data-start="649.149" data-end="653.44">the pepper interface abstractly that's</span> <span data-start="653.44" data-end="655.54">fairly straightforward but actually</span> <span data-start="655.54" data-end="657.79">seeing into action these are Native</span> </p>
<p><span data-start="657.79" data-end="660.52">Client examples SDK examples this is a</span> <span data-start="660.52" data-end="662.32">ray traced earth that's doing this on</span> <span data-start="662.32" data-end="664.24">the CPU there's no GPU involved</span> <span data-start="664.24" data-end="667.54">and here's the pinnacle version of the</span> <span data-start="667.54" data-end="669.61">same thing you don't notice many</span> <span data-start="669.61" data-end="671.44">differences the one difference of course</span> <span data-start="671.44" data-end="673.75">is that if you go to the pinnacle</span> <span data-start="673.75" data-end="675.7">version over here you can turn on more</span> <span data-start="675.7" data-end="677.32">threads and it's very hard to see on the</span> <span data-start="677.32" data-end="680.77">VC but you do get a speed up when you're</span> <span data-start="680.77" data-end="683.709">doing that and you know there's other</span> <span data-start="683.709" data-end="687.07">cpu examples where you can just crank on</span> <span data-start="687.07" data-end="690.43">the threads see it go faster exactly the</span> <span data-start="690.43" data-end="694.63">same code working with them scriptum but</span> <span data-start="694.63" data-end="696.399">there's corner cases like this is if</span> <span data-start="696.399" data-end="698.649">your GPU bound it really doesn't matter</span> <span data-start="698.649" data-end="701.44">how fast you are so exactly the same</span> <span data-start="701.44" data-end="703.63">application mostly driving the CPU so in</span> <span data-start="703.63" data-end="705.67">terms of performance is Emscripten</span> <span data-start="705.67" data-end="707.56">actually does very good especially with</span> <span data-start="707.56" data-end="709.089">numerical kernels so things like earth</span> <span data-start="709.089" data-end="712.149">it's usually within 1 X you know it's</span> <span data-start="712.149" data-end="714.37">like twenty percent slower whereas when</span> <span data-start="714.37" data-end="715.81">you have more structured code you're</span> <span data-start="715.81" data-end="718.3">kind of in the two to three X range in</span> <span data-start="718.3" data-end="720.52">terms of performance so the performance</span> <span data-start="720.52" data-end="723.37">is mostly there it's more an issue of</span> <span data-start="723.37" data-end="725.92">developer time and structure how much</span> <span data-start="725.92" data-end="728.23">time are you willing to death how much</span> <span data-start="728.23" data-end="730.18">time are you willing to spend 2d thread</span> <span data-start="730.18" data-end="735.43">your code well why would you want</span> <span data-start="735.43" data-end="738.07">threads so I've been pounding on this is</span> <span data-start="738.07" data-end="740.77">that it's structure is modern developers</span> <span data-start="740.77" data-end="742.329">they want to target as many platforms as</span> <span data-start="742.329" data-end="743.56">possible that you know they want to run</span> <span data-start="743.56" data-end="744.88">on cell phones they'd like to run on the</span> <span data-start="744.88" data-end="747.76">web but it's all a return on investment</span> <span data-start="747.76" data-end="749.86">issue is how much time are you willing</span> <span data-start="749.86" data-end="751.54">to get that next platform and support</span> <span data-start="751.54" data-end="753.94">that next platform if that I if that</span> <span data-start="753.94" data-end="755.22">cost is too much you just don't do it</span> <span data-start="755.22" data-end="758.02">there's throughput we'll see in a moment</span> <span data-start="758.02" data-end="759.43">that if you have more threads you can</span> <span data-start="759.43" data-end="761.86">just crunch more numbers and do more</span> <span data-start="761.86" data-end="764.589">calculations there's also latency so if</span> <span data-start="764.589" data-end="766.12">you're doing audio or rendering or</span> <span data-start="766.12" data-end="768.7">real-time stuff throughput is kind of</span> <span data-start="768.7" data-end="770.11">the equation but you want to get it done</span> <span data-start="770.11" data-end="771.82">is kind of the question but you want to</span> <span data-start="771.82" data-end="773.47">get done as fast as possible so you</span> <span data-start="773.47" data-end="775.089">never want have dropouts in your audio</span> <span data-start="775.089" data-end="777.13">you never want to drop frames in your</span> <span data-start="777.13" data-end="779.92">real time application there's also a</span> <span data-start="779.92" data-end="781.27">trend in Hardware where we're getting</span> <span data-start="781.27" data-end="784.329">more and more cores and an individual</span> <span data-start="784.329" data-end="787.089">core can run code about the same speed</span> <span data-start="787.089" data-end="788.95">as it always has and if you want at your</span> <span data-start="788.95" data-end="790.69">overall application to run faster you</span> <span data-start="790.69" data-end="792.73">have to take advantage of the parallel</span> <span data-start="792.73" data-end="796.449">resources in your hardware I should</span> <span data-start="796.449" data-end="798.13">clarify before I go on</span> <span data-start="798.13" data-end="800.8">kind of using the definition that the go</span> <span data-start="800.8" data-end="803.23">programming language has done for</span> <span data-start="803.23" data-end="804.85">concurrency and parallelism is that</span> <span data-start="804.85" data-end="806.38">they're not the same thing so</span> <span data-start="806.38" data-end="810.1">parallelism is about doing things at the</span> <span data-start="810.1" data-end="812.98">same time so if you have multiple CPUs</span> <span data-start="812.98" data-end="814.33">you're running things on multiple sea</span> <span data-start="814.33" data-end="816.1">views that's parallels them whereas</span> <span data-start="816.1" data-end="818.02">concurrency is really about dealing with</span> <span data-start="818.02" data-end="820.99">the conflicts that arise when you're</span> <span data-start="820.99" data-end="823">doing things that interact so even if</span> <span data-start="823" data-end="824.8">you're running on single CPU you can</span> <span data-start="824.8" data-end="826.9">think in JavaScript you have problems</span> <span data-start="826.9" data-end="828.64">with concurrency when you load a bunch</span> <span data-start="828.64" data-end="831.01">of files and then they may come back not</span> <span data-start="831.01" data-end="833.62">quite in the order that you expect so</span> <span data-start="833.62" data-end="835.75">you have to deal with the Oh they've</span> <span data-start="835.75" data-end="837.52">resolved in different orders let me</span> <span data-start="837.52" data-end="839.41">order them then let me go on things</span> <span data-start="839.41" data-end="841.18">along those lines whereas parallel ISM</span> <span data-start="841.18" data-end="842.41">you get that when you actually load the</span> <span data-start="842.41" data-end="844.42">file so well the system is actually</span> <span data-start="844.42" data-end="845.71">grabbing the bites off the network</span> <span data-start="845.71" data-end="847.66">that's parallelism but it doesn't</span> <span data-start="847.66" data-end="849.34">interact with JavaScript until you get</span> <span data-start="849.34" data-end="853.24">the event back and that's concurrency so</span> <span data-start="853.24" data-end="855.55">what if we changed how the browser</span> <span data-start="855.55" data-end="857.77">worked a little bit what instead what if</span> <span data-start="857.77" data-end="859.99">instead of just running everything</span> <span data-start="859.99" data-end="862.3">inside the main thread we spun up a few</span> <span data-start="862.3" data-end="865.71">workers so a web worker is essentially a</span> <span data-start="865.71" data-end="869.8">thread but you can't interact with all</span> <span data-start="869.8" data-end="871.27">the other threads the way you'd want to</span> <span data-start="871.27" data-end="873.13">with native code because you can only</span> <span data-start="873.13" data-end="875.23">communicate through messages so what if</span> <span data-start="875.23" data-end="876.85">we just gave it a big chunk of memory</span> <span data-start="876.85" data-end="878.98">and said this chunk of memory can be</span> <span data-start="878.98" data-end="881.77">simultaneously read and written to from</span> <span data-start="881.77" data-end="883.9">all of these different workers and then</span> <span data-start="883.9" data-end="885.64">you provide some mechanisms along the</span> <span data-start="885.64" data-end="887.44">lines of locks and semaphores to make</span> <span data-start="887.44" data-end="888.76">sure that you're never reading or</span> <span data-start="888.76" data-end="890.2">writing from the same memory at the same</span> <span data-start="890.2" data-end="892.27">time instead you're passing ownership</span> <span data-start="892.27" data-end="895.69">back and forth between the threads so</span> <span data-start="895.69" data-end="897.73">this should horrify a few people in this</span> <span data-start="897.73" data-end="901.03">audience is that shared memory is known</span> <span data-start="901.03" data-end="904.24">to be hard and a lot of the design of</span> <span data-start="904.24" data-end="906.18">javascript has been shared nothing</span> <span data-start="906.18" data-end="909.19">instead of dealing with all these</span> <span data-start="909.19" data-end="911.23">concurrency issues the only way you can</span> <span data-start="911.23" data-end="912.52">communicate back and forth is over</span> <span data-start="912.52" data-end="914.98">messages so this is the downside of</span> <span data-start="914.98" data-end="916.93">shared memory is it kind of is going</span> <span data-start="916.93" data-end="918.46">another direction at saying if we really</span> <span data-start="918.46" data-end="920.47">want native code on the web we have to</span> <span data-start="920.47" data-end="923.29">deal with the issues of shared memory so</span> <span data-start="923.29" data-end="925.27">people will often say well there's all</span> <span data-start="925.27" data-end="927.25">these other ways we could do it and I</span> <span data-start="927.25" data-end="929.17">don't have time to go through these one</span> <span data-start="929.17" data-end="931.19">by one but always comes down to theirs</span> <span data-start="931.19" data-end="932.9">thing missing and usually what it comes</span> <span data-start="932.9" data-end="935.72">down to is that whatever solution we do</span> <span data-start="935.72" data-end="937.43">has to be incremental an incremental</span> <span data-start="937.43" data-end="940.64">evolution of JavaScript and it also has</span> <span data-start="940.64" data-end="942.86">to require minimal changes to the native</span> <span data-start="942.86" data-end="944.87">code and there's very few solutions</span> <span data-start="944.87" data-end="946.79">which solve both those for instance you</span> <span data-start="946.79" data-end="948.71">say well why does JavaScript have to</span> <span data-start="948.71" data-end="949.82">have anything to do this why are we</span> <span data-start="949.82" data-end="951.59">compiling to JavaScript why not just use</span> <span data-start="951.59" data-end="954.38">pinnacle well that's another technology</span> <span data-start="954.38" data-end="957.35">stack and getting other browsers to</span> <span data-start="957.35" data-end="959.27">adopt it is much harder than</span> <span data-start="959.27" data-end="960.71">incrementally evolving java suit</span> <span data-start="960.71" data-end="963.05">javascript so i think in the future</span> <span data-start="963.05" data-end="965">we're going to see a convergence is that</span> <span data-start="965" data-end="966.23">what's happening in m script and what's</span> <span data-start="966.23" data-end="968.36">happening in pinnacle will start to look</span> <span data-start="968.36" data-end="970.25">similar and similar but we potentially</span> <span data-start="970.25" data-end="972.08">have to evolve javascript to get to that</span> <span data-start="972.08" data-end="976.52">point so how do we prove that this all</span> <span data-start="976.52" data-end="980.54">works well I put together prohibition</span> <span data-start="980.54" data-end="984.14">apapa a fluid simulator and I'm wiggling</span> <span data-start="984.14" data-end="986.83">with my mouse here and it's tiled and</span> <span data-start="986.83" data-end="988.82">everything like that so what's happening</span> <span data-start="988.82" data-end="991.25">is underneath all this there is a grid</span> <span data-start="991.25" data-end="993.62">of velocities and this is a</span> <span data-start="993.62" data-end="995.48">visualization of the velocity grid right</span> <span data-start="995.48" data-end="997.94">there and as you swirl it around with</span> <span data-start="997.94" data-end="999.38">the mouse the fluid flows with it and</span> <span data-start="999.38" data-end="1002.44">this is a grid it's a two-by-two grid of</span> <span data-start="1002.44" data-end="1004.9">image data essentially in velocity data</span> <span data-start="1004.9" data-end="1007.18">and every step it's doing a lot of</span> <span data-start="1007.18" data-end="1008.92">calculation to move it forward so this</span> <span data-start="1008.92" data-end="1011.83">is all cpu driven this is one of these</span> <span data-start="1011.83" data-end="1013.48">things that you think could be very</span> <span data-start="1013.48" data-end="1016.81">easily paralyzed and so i tried to do it</span> <span data-start="1016.81" data-end="1018.76">with the existing workers api's so</span> <span data-start="1018.76" data-end="1020.83">here's a version where i'm splitting it</span> <span data-start="1020.83" data-end="1023.17">up into multiple workers and one thing</span> <span data-start="1023.17" data-end="1025.27">we'll get back to is you'll kind of see</span> <span data-start="1025.27" data-end="1027.55">although it's very hard you'll have to</span> <span data-start="1027.55" data-end="1029.62">squint is that the velocity buffers when</span> </p>
<p><span data-start="1029.62" data-end="1032.699">I draw into it the lines are now kind of</span> <span data-start="1032.699" data-end="1035.86">lumpy as they aren't as smooth as they</span> <span data-start="1035.86" data-end="1037.27">were the first time and we'll get to why</span> <span data-start="1037.27" data-end="1039.4">that was but this is running on multiple</span> <span data-start="1039.4" data-end="1041.05">workers right now it's in fact running</span> <span data-start="1041.05" data-end="1043.3">on four workers and if you look at the</span> <span data-start="1043.3" data-end="1046.9">actual bottom graph you see virtually no</span> <span data-start="1046.9" data-end="1048.76">improvement in fact you'll see a lot of</span> <span data-start="1048.76" data-end="1051.22">spikes popping up and those are due to</span> <span data-start="1051.22" data-end="1052.39">garbage collection pressure because</span> <span data-start="1052.39" data-end="1053.62">you're copying things to the worker</span> <span data-start="1053.62" data-end="1055.99">every time well what if you can reduce</span> <span data-start="1055.99" data-end="1058.93">the copying so this version says that</span> <span data-start="1058.93" data-end="1061.81">instead of copying the same data to all</span> <span data-start="1061.81" data-end="1064.33">four workers you copy it once and say</span> <span data-start="1064.33" data-end="1065.11">here's a read on</span> <span data-start="1065.11" data-end="1067.15">buffer that everyone can access so it</span> <span data-start="1067.15" data-end="1069.64">reduces the number of copies and you'll</span> <span data-start="1069.64" data-end="1071.98">see that a lot of the spikes go away so</span> <span data-start="1071.98" data-end="1076.54">as it turns out the big win from not</span> <span data-start="1076.54" data-end="1077.92">having to broadcast the same day that</span> <span data-start="1077.92" data-end="1080.14">everyone is not actually the cost of</span> <span data-start="1080.14" data-end="1082.03">copying the data it's the copy of</span> <span data-start="1082.03" data-end="1084.7">cleaning the data up afterwards so read</span> <span data-start="1084.7" data-end="1086.29">only memory gives you a performance</span> <span data-start="1086.29" data-end="1089.71">boost due to being friendly for GC what</span> <span data-start="1089.71" data-end="1091.69">if we go a step further and say have</span> <span data-start="1091.69" data-end="1093.49">shared memory and instead of using</span> <span data-start="1093.49" data-end="1095.65">postmessage talk back and forth we use</span> <span data-start="1095.65" data-end="1097.45">traditional native mechanisms like</span> <span data-start="1097.45" data-end="1099.49">blocks to coordinate between the threads</span> <span data-start="1099.49" data-end="1102.22">so at this point we see actually see our</span> <span data-start="1102.22" data-end="1105.25">first performance improvement and as it</span> <span data-start="1105.25" data-end="1107.61">turns out this is due to communication</span> <span data-start="1107.61" data-end="1110.41">or there's anything else so when you</span> <span data-start="1110.41" data-end="1111.76">have a lock that allows you to</span> <span data-start="1111.76" data-end="1113.049">communicate with the other threads much</span> <span data-start="1113.049" data-end="1116.35">quicker than postmessage does we'll get</span> <span data-start="1116.35" data-end="1119.23">into the actual performance numbers when</span> <span data-start="1119.23" data-end="1123.73">we in a future slide so this is what's</span> <span data-start="1123.73" data-end="1126.82">going on behind the scenes is that it's</span> <span data-start="1126.82" data-end="1128.32">doing a bunch of computations you don't</span> <span data-start="1128.32" data-end="1129.549">have to know exactly what these are but</span> <span data-start="1129.549" data-end="1131.53">like the effect stages through moving</span> <span data-start="1131.53" data-end="1133.96">things around the fuse velocity that</span> <span data-start="1133.96" data-end="1136.299">simulates viscosity and then it has to</span> <span data-start="1136.299" data-end="1137.799">make sure that there's no fluid</span> <span data-start="1137.799" data-end="1139.6">appearing from nowhere or disappearing</span> <span data-start="1139.6" data-end="1141.669">so make sure that the pressure is equal</span> <span data-start="1141.669" data-end="1145.39">at all times and then it'll draw how you</span> <span data-start="1145.39" data-end="1146.83">paralyze this is you take the</span> <span data-start="1146.83" data-end="1149.26">computationally intensive stages and you</span> <span data-start="1149.26" data-end="1151.15">move them out to a worker so you're</span> <span data-start="1151.15" data-end="1153.28">doing post message out the worker says</span> <span data-start="1153.28" data-end="1154.39">thank you for the data does the</span> <span data-start="1154.39" data-end="1156.04">computation sends the results back and</span> <span data-start="1156.04" data-end="1158.32">you periodically have to resynchronize</span> <span data-start="1158.32" data-end="1160.72">back I mentioned that some of the lines</span> <span data-start="1160.72" data-end="1164.02">become blotchy and it's because as soon</span> <span data-start="1164.02" data-end="1165.46">as you start paralyzing it there's these</span> <span data-start="1165.46" data-end="1167.169">gaps that open up on the main thread and</span> <span data-start="1167.169" data-end="1169.54">these gaps are potentially places where</span> <span data-start="1169.54" data-end="1171.85">things like Mouse events can fire so I</span> <span data-start="1171.85" data-end="1173.71">did a lot of beautiful abstraction i use</span> <span data-start="1173.71" data-end="1175.99">promises i said here are all the things</span> <span data-start="1175.99" data-end="1178.27">the fluid simulation is doing and then I</span> <span data-start="1178.27" data-end="1180.1">changed the backend implementation</span> <span data-start="1180.1" data-end="1182.44">detail and suddenly events started</span> <span data-start="1182.44" data-end="1184.48">firing in places I didn't even think</span> <span data-start="1184.48" data-end="1186.37">about that they'd fire so this is a</span> <span data-start="1186.37" data-end="1188.34">concurrency bug is we're dealing with</span> <span data-start="1188.34" data-end="1190.75">unexpected events in places we didn't</span> <span data-start="1190.75" data-end="1192.76">expect so the great irony is when</span> <span data-start="1192.76" data-end="1194.47">dealing with shared memory my</span> <span data-start="1194.47" data-end="1196.179">concurrency bug that I ran into was</span> </p>
<p><span data-start="1196.179" data-end="1197.519">JavaScript</span> <span data-start="1197.519" data-end="1200.58">when you actually look at the speed-up</span> <span data-start="1200.58" data-end="1202.809">shared nothing in read-only memory they</span> <span data-start="1202.809" data-end="1204.999">give modest improvements and then we</span> <span data-start="1204.999" data-end="1206.679">start using these fast synchronization</span> <span data-start="1206.679" data-end="1208.84">primitives you can actually start to use</span> <span data-start="1208.84" data-end="1211.21">all the cores so on eight cores only for</span> <span data-start="1211.21" data-end="1212.649">XP dup so that's fifty percent</span> <span data-start="1212.649" data-end="1214.69">efficiency so it's not quite where we</span> <span data-start="1214.69" data-end="1216.1">want to be and there's other things that</span> <span data-start="1216.1" data-end="1217.899">need to be done but this is a kind of</span> <span data-start="1217.899" data-end="1219.309">quick hand waving hack to show that</span> <span data-start="1219.309" data-end="1221.259">shared memory does work and it does give</span> <span data-start="1221.259" data-end="1223.389">you a parallel speed up in performance</span> <span data-start="1223.389" data-end="1225.789">improvement I'm going to skip these</span> <span data-start="1225.789" data-end="1228.249">slides for the sake of time but the</span> <span data-start="1228.249" data-end="1230.71">message or the the lesson learned is</span> <span data-start="1230.71" data-end="1233.44">that the main thread is actually more</span> <span data-start="1233.44" data-end="1236.23">special than you'd expect so the workers</span> <span data-start="1236.23" data-end="1237.85">aren't entirely independent with the</span> <span data-start="1237.85" data-end="1239.59">main thread and if you block the main</span> <span data-start="1239.59" data-end="1241.72">thread you can for instance prevent a</span> <span data-start="1241.72" data-end="1243.999">worker from ever creating our from ever</span> <span data-start="1243.999" data-end="1246.039">being created so when you initially</span> <span data-start="1246.039" data-end="1249.279">create it it creates a stub and it also</span> <span data-start="1249.279" data-end="1250.96">launches off an earl request to get the</span> <span data-start="1250.96" data-end="1252.369">script that's supposed to run inside the</span> <span data-start="1252.369" data-end="1254.59">stub so if you block the main thread the</span> <span data-start="1254.59" data-end="1256.36">script itself is never loaded and the</span> <span data-start="1256.36" data-end="1258.669">worker never becomes active and there's</span> <span data-start="1258.669" data-end="1260.679">similar issues where if you block the</span> <span data-start="1260.679" data-end="1261.999">main thread while workers doing</span> <span data-start="1261.999" data-end="1265.149">something the console log gets proxied</span> <span data-start="1265.149" data-end="1266.74">through the main thread to wherever the</span> <span data-start="1266.74" data-end="1270.22">console is and this means you'll lose</span> <span data-start="1270.22" data-end="1271.96">output if the main thread is blocked so</span> <span data-start="1271.96" data-end="1273.97">for programmers you shouldn't worry</span> <span data-start="1273.97" data-end="1275.98">about this but in terms of the browser</span> <span data-start="1275.98" data-end="1277.659">implementation it turns out there's all</span> <span data-start="1277.659" data-end="1279.249">sorts of complexities we're blocking the</span> <span data-start="1279.249" data-end="1280.99">main thread will kill you and this is a</span> <span data-start="1280.99" data-end="1282.999">problem for running native code because</span> <span data-start="1282.999" data-end="1287.259">it's a blocking API another thing that</span> <span data-start="1287.259" data-end="1289.169">freaks people out about native code is</span> <span data-start="1289.169" data-end="1292.36">data races and this is a classic</span> <span data-start="1292.36" data-end="1294.46">textbook I took CSI took operating</span> <span data-start="1294.46" data-end="1296.47">systems thing as you say I have these</span> <span data-start="1296.47" data-end="1298.72">two threads they each have two</span> <span data-start="1298.72" data-end="1300.1">instructions in them and I'm going to</span> <span data-start="1300.1" data-end="1301.629">run them at the same time what happens</span> <span data-start="1301.629" data-end="1305.649">so one thread assigns the value one to a</span> <span data-start="1305.649" data-end="1307.869">so assume that a and B are both 0 to</span> <span data-start="1307.869" data-end="1309.909">start out with so one thread assigns one</span> <span data-start="1309.909" data-end="1312.669">to a then prints be the other thread</span> <span data-start="1312.669" data-end="1316.45">assigns to to be and then prints a so</span> <span data-start="1316.45" data-end="1319.299">what's the end result if you look at the</span> <span data-start="1319.299" data-end="1321.279">inner leavings of these threads you get</span> <span data-start="1321.279" data-end="1323.35">six possible results it can print to it</span> <span data-start="1323.35" data-end="1325.33">can print one then one it can print one</span> <span data-start="1325.33" data-end="1327.639">than two if one of the threads runs much</span> <span data-start="1327.639" data-end="1328.99">faster than the other ones you get a</span> <span data-start="1328.99" data-end="1330.05">zero than a one</span> <span data-start="1330.05" data-end="1332.24">or a zero than it too so this is the</span> <span data-start="1332.24" data-end="1334.07">worst thing in the world is you got two</span> <span data-start="1334.07" data-end="1335.81">threads to instructions six possible in</span> <span data-start="1335.81" data-end="1338.32">our leavings we can deal with that I</span> <span data-start="1338.32" data-end="1342.61">wide so it's all worse than that is that</span> <span data-start="1342.61" data-end="1345.38">the compiler and the CPU there's all</span> <span data-start="1345.38" data-end="1346.76">sorts of things down the stack which</span> <span data-start="1346.76" data-end="1348.35">will try to make the code run faster in</span> <span data-start="1348.35" data-end="1350.15">one of the normal things they'll say is</span> <span data-start="1350.15" data-end="1352.31">well you're signing to a then you're</span> <span data-start="1352.31" data-end="1354.44">printing be these two operations are</span> <span data-start="1354.44" data-end="1356.84">totally unrelated so I can reorder them</span> <span data-start="1356.84" data-end="1358.85">as I wish and the other fed will say the</span> <span data-start="1358.85" data-end="1360.71">same thing is assigning to be than</span> <span data-start="1360.71" data-end="1362.57">printing a no relation I can reorder</span> <span data-start="1362.57" data-end="1365.45">them so instead you have 24 different</span> <span data-start="1365.45" data-end="1367.34">operations and some of them will produce</span> <span data-start="1367.34" data-end="1370.43">things which are intuitively silly like</span> <span data-start="1370.43" data-end="1373.25">one you can print 00 which never should</span> <span data-start="1373.25" data-end="1375.29">happen because by the time you hit the</span> <span data-start="1375.29" data-end="1376.85">other print you would have thought that</span> <span data-start="1376.85" data-end="1378.29">the other thread would have assigned to</span> <span data-start="1378.29" data-end="1379.82">what you're printing so there should</span> <span data-start="1379.82" data-end="1381.44">never be a second zero and you can</span> <span data-start="1381.44" data-end="1382.94">sometimes get 20 again these are</span> <span data-start="1382.94" data-end="1386.12">physically unrealizable but it gets</span> <span data-start="1386.12" data-end="1388.25">worse is for optimization purposes</span> <span data-start="1388.25" data-end="1390.47">either the CP or the compiler can</span> <span data-start="1390.47" data-end="1392.69">duplicate instructions it can remove</span> <span data-start="1392.69" data-end="1394.73">instructions it can transform the</span> <span data-start="1394.73" data-end="1396.41">instructions so instead of 24</span> <span data-start="1396.41" data-end="1397.61">interleaving there's actually</span> <span data-start="1397.61" data-end="1400.37">effectively an uncountable number of</span> <span data-start="1400.37" data-end="1401.69">inner leavings that can occur with these</span> <span data-start="1401.69" data-end="1404.72">threads and even worse is different</span> <span data-start="1404.72" data-end="1406.94">threads may not agree on what the inner</span> <span data-start="1406.94" data-end="1409.34">leavings are so if the memory operations</span> <span data-start="1409.34" data-end="1411.68">aren't dependent they can say hey a got</span> <span data-start="1411.68" data-end="1413.12">assigned to then be and the others I</span> <span data-start="1413.12" data-end="1415.51">know you got assigned to you then a and</span> <span data-start="1415.51" data-end="1418.07">not every computer will run the same way</span> <span data-start="1418.07" data-end="1420.53">so different CPUs will show some</span> <span data-start="1420.53" data-end="1422.33">orderings but not all of them and</span> <span data-start="1422.33" data-end="1424.25">different compilers will show some</span> <span data-start="1424.25" data-end="1426.02">orderings not all of them and this is</span> <span data-start="1426.02" data-end="1427.49">especially a problem for JavaScript</span> <span data-start="1427.49" data-end="1430.43">because the JIT actually behaves as</span> <span data-start="1430.43" data-end="1432.59">multiple co compilers so as you run it</span> <span data-start="1432.59" data-end="1434.84">will recompile the code and potentially</span> <span data-start="1434.84" data-end="1436.28">reorder things in different ways every</span> <span data-start="1436.28" data-end="1439.52">time it optimizes the code so this is</span> <span data-start="1439.52" data-end="1441.68">hopeless write it when it comes down to</span> <span data-start="1441.68" data-end="1444.41">it if you have a data race your program</span> <span data-start="1444.41" data-end="1446.45">is broken so you'll see a lot of people</span> <span data-start="1446.45" data-end="1448.43">they'll squint and say okay there's a</span> <span data-start="1448.43" data-end="1451.25">data race there but it'll be okay and</span> <span data-start="1451.25" data-end="1454.16">the answer is no is that the compiler</span> <span data-start="1454.16" data-end="1456.11">the CPU is going to do the worst</span> <span data-start="1456.11" data-end="1458.99">possible thing in some cases and you</span> <span data-start="1458.99" data-end="1461.09">can't reason about it so you must</span> <span data-start="1461.09" data-end="1462.77">defensively not have data races in your</span> <span data-start="1462.77" data-end="1463.31">program</span> <span data-start="1463.31" data-end="1465.33">well this would be a good argument</span> <span data-start="1465.33" data-end="1466.89">against native code on the web right</span> <span data-start="1466.89" data-end="1469.29">data data races are often but really</span> <span data-start="1469.29" data-end="1471.03">this is about concurrency is we're</span> <span data-start="1471.03" data-end="1472.77">talking about doing interacting things</span> <span data-start="1472.77" data-end="1474.9">at the same time and if you don't</span> <span data-start="1474.9" data-end="1477.36">account for these interactions your</span> <span data-start="1477.36" data-end="1479.64">program is broken this also occurs in</span> </p>
<p><span data-start="1479.64" data-end="1481.83">JavaScript and I think one of the things</span> <span data-start="1481.83" data-end="1483.9">that will be learning over the next five</span> <span data-start="1483.9" data-end="1485.76">years is that concurrency is a bigger</span> <span data-start="1485.76" data-end="1487.14">problem for JavaScript than we currently</span> <span data-start="1487.14" data-end="1489.78">understand things like Earl requests</span> <span data-start="1489.78" data-end="1491.13">coming back in the order we didn't</span> <span data-start="1491.13" data-end="1493.11">expect is we've dealt with a synchrony</span> <span data-start="1493.11" data-end="1495.18">with promises but if you have to promise</span> <span data-start="1495.18" data-end="1496.83">chains their inner leaving with each</span> <span data-start="1496.83" data-end="1499.14">other and odd ways how do you deal with</span> <span data-start="1499.14" data-end="1500.58">that what primitives do you use and</span> <span data-start="1500.58" data-end="1502.71">right now this is mostly put upon the</span> <span data-start="1502.71" data-end="1504.63">programmer to deal with so this is a</span> <span data-start="1504.63" data-end="1506.31">wicked problem but it's a generically</span> <span data-start="1506.31" data-end="1509.97">wicked problem and so can we do better</span> <span data-start="1509.97" data-end="1511.26">is there a way that we can eliminate</span> <span data-start="1511.26" data-end="1513">data races and having thought about it</span> <span data-start="1513" data-end="1514.65">for a while I can say no not really is</span> <span data-start="1514.65" data-end="1517.23">if you want to emulate a platform if you</span> <span data-start="1517.23" data-end="1518.64">want to be compatible with a platform</span> <span data-start="1518.64" data-end="1520.41">you also be have to be compatible with</span> <span data-start="1520.41" data-end="1523.8">their bugs some extent and what this</span> <span data-start="1523.8" data-end="1525.6">means is that JavaScript may have to</span> <span data-start="1525.6" data-end="1527.85">have a shared memory api for compile the</span> </p>
<p><span data-start="1527.85" data-end="1529.68">JavaScript which you probably shouldn't</span> <span data-start="1529.68" data-end="1532.47">use otherwise and that scares people so</span> <span data-start="1532.47" data-end="1534.48">where is this going is there anything</span> <span data-start="1534.48" data-end="1536.16">certain at this point there is nothing</span> <span data-start="1536.16" data-end="1538.1">certain there is going to be a bit of a</span> <span data-start="1538.1" data-end="1540.57">discussion / war for the soul of</span> <span data-start="1540.57" data-end="1542.25">JavaScript whether we want to support</span> <span data-start="1542.25" data-end="1544.11">native code on the web whether we're</span> <span data-start="1544.11" data-end="1547.76">willing to expose shared memory if the</span> <span data-start="1547.76" data-end="1552.18">ultimate gain from it is supporting</span> <span data-start="1552.18" data-end="1554.1">multi-threaded native code so you can</span> <span data-start="1554.1" data-end="1556.5">just mash together everything you can</span> <span data-start="1556.5" data-end="1558.72">mash see with JavaScript it's not just</span> <span data-start="1558.72" data-end="1560.58">mashing different web apps together</span> <span data-start="1560.58" data-end="1564.03">anymore I got through that faster than I</span> <span data-start="1564.03" data-end="1566.67">expected but if you want to know more</span> <span data-start="1566.67" data-end="1568.47">there's websites for Knakal and script</span> <span data-start="1568.47" data-end="1572.73">in try pepper j/s appspot com for some</span> <span data-start="1572.73" data-end="1574.86">of the examples I was showing tweet at</span> </p>
<p><span data-start="1574.86" data-end="1576.21">Native Client one of my co-workers a</span> <span data-start="1576.21" data-end="1579.69">troll he'll enjoy it and email me if you</span> <span data-start="1579.69" data-end="1582.45">have any thing to talk about and I think</span> <span data-start="1582.45" data-end="1584.07">we have four minutes and we might</span> <span data-start="1584.07" data-end="1585.45">actually be able to take questions for</span> <span data-start="1585.45" data-end="1588.18">the first time ever so anyone curious</span> <span data-start="1588.18" data-end="1591.15">about anything ok so the question is are</span> <span data-start="1591.15" data-end="1593.46">there potential optimizations where you</span> <span data-start="1593.46" data-end="1596.22">can just copy stuff into shared memory</span> <span data-start="1596.22" data-end="1596.4">and</span> <span data-start="1596.4" data-end="1598.08">has a pointer to workers and that's</span> <span data-start="1598.08" data-end="1599.76">essentially what the fluid simulator was</span> <span data-start="1599.76" data-end="1603.75">doing is that it had this grid of data</span> <span data-start="1603.75" data-end="1606.63">and it was saying each of these threads</span> <span data-start="1606.63" data-end="1609.3">you're responsible for calculating the</span> <span data-start="1609.3" data-end="1611.4">next version of this data for this</span> <span data-start="1611.4" data-end="1613.65">specific sub square so is it was</span> <span data-start="1613.65" data-end="1615.93">essentially handing the pointer off to</span> <span data-start="1615.93" data-end="1618.06">the worker and you know kind of a reason</span> <span data-start="1618.06" data-end="1619.98">of memory and said process this and give</span> <span data-start="1619.98" data-end="1622.89">me the result so for the non shared</span> <span data-start="1622.89" data-end="1625.02">memory version what it was doing it was</span> <span data-start="1625.02" data-end="1627.6">actually copying out that chunk and</span> <span data-start="1627.6" data-end="1630.27">sending it over and it was a little</span> <span data-start="1630.27" data-end="1632.13">worse than that because postmessage</span> <span data-start="1632.13" data-end="1636.3">takes about a millisecond to do a full</span> <span data-start="1636.3" data-end="1637.98">round-trip you know it has a high</span> <span data-start="1637.98" data-end="1639.51">throughput but potentially also high</span> <span data-start="1639.51" data-end="1641.91">latency and because of the high latency</span> <span data-start="1641.91" data-end="1643.02">when you're actually doing the fluid</span> <span data-start="1643.02" data-end="1645.84">simulator like every update your having</span> <span data-start="1645.84" data-end="1648.18">to iterate about a hundred and twenty</span> <span data-start="1648.18" data-end="1650.49">times on a specific calculation called</span> <span data-start="1650.49" data-end="1652.59">the Jacobian so if you do that all over</span> <span data-start="1652.59" data-end="1654.48">postmessage then that means you're</span> <span data-start="1654.48" data-end="1657.3">taking about a hundred and twenty</span> <span data-start="1657.3" data-end="1658.98">milliseconds just for communication</span> <span data-start="1658.98" data-end="1661.32">which obviously doesn't work so instead</span> <span data-start="1661.32" data-end="1663.39">you have to do things like actually send</span> <span data-start="1663.39" data-end="1665.25">it more data than it needs it says</span> <span data-start="1665.25" data-end="1666.9">ultimately you're responsible for this</span> <span data-start="1666.9" data-end="1669.03">little square but i'm going to give you</span> <span data-start="1669.03" data-end="1670.95">data for this much and you're going to</span> <span data-start="1670.95" data-end="1673.32">calculate a region that's about twice as</span> <span data-start="1673.32" data-end="1675.75">big just so you can predict what your</span> <span data-start="1675.75" data-end="1677.49">neighbors are doing and you don't have</span> <span data-start="1677.49" data-end="1679.65">to communicate so when you look at those</span> <span data-start="1679.65" data-end="1681.51">numbers where you see no speed up what's</span> <span data-start="1681.51" data-end="1683.69">actually going on is you're having to do</span> <span data-start="1683.69" data-end="1686.25">pretty much twice the computation and</span> <span data-start="1686.25" data-end="1687.96">all the workers just to avoid</span> <span data-start="1687.96" data-end="1690.12">communicating because communicating is</span> <span data-start="1690.12" data-end="1691.92">so slow so when you're talking about</span> <span data-start="1691.92" data-end="1693.9">avoiding copy by passing pointers to</span> <span data-start="1693.9" data-end="1696.03">workers the big win is actually</span> <span data-start="1696.03" data-end="1698.04">communication speed is on modern</span> <span data-start="1698.04" data-end="1700.86">processors copying isn't too bad as long</span> <span data-start="1700.86" data-end="1702.63">as you don't have to GC afterwards and</span> <span data-start="1702.63" data-end="1704.37">if you can't avoid it you get an</span> <span data-start="1704.37" data-end="1705.99">additional improvement but the big</span> <span data-start="1705.99" data-end="1707.1">improvement is with synchronization</span> <span data-start="1707.1" data-end="1711.39">speed aha so why are we backwards</span> <span data-start="1711.39" data-end="1713.37">looking why are we worried about all</span> <span data-start="1713.37" data-end="1717.39">this legacy code well this is often</span> <span data-start="1717.39" data-end="1719.07">brought up in these wars about should we</span> <span data-start="1719.07" data-end="1722.64">have shared memory or not and my answer</span> <span data-start="1722.64" data-end="1726.48">to that is that people are still writing</span> <span data-start="1726.48" data-end="1727.72">new native code every</span> <span data-start="1727.72" data-end="1730.12">you know everyone talks about native on</span> <span data-start="1730.12" data-end="1732.46">mobile so if we're talking about</span> <span data-start="1732.46" data-end="1734.53">compatibility with native code we're</span> <span data-start="1734.53" data-end="1736.39">really talking about can mobile</span> <span data-start="1736.39" data-end="1738.4">developers easily port back and forth to</span> <span data-start="1738.4" data-end="1740.679">the web you know can we make the web as</span> <span data-start="1740.679" data-end="1743.11">a last bastion of not being a walled</span> <span data-start="1743.11" data-end="1744.52">garden you know if you want to be really</span> <span data-start="1744.52" data-end="1745.78">political about it or something like</span> <span data-start="1745.78" data-end="1749.44">that so it's about compatibility with</span> <span data-start="1749.44" data-end="1750.909">different platforms one other thing else</span> <span data-start="1750.909" data-end="1753.19">and people are saying well why don't we</span> <span data-start="1753.19" data-end="1755.049">provide an eye slits API you know why</span> <span data-start="1755.049" data-end="1757.15">don't we say that native code just gets</span> <span data-start="1757.15" data-end="1758.65">web workers and you have to send</span> <span data-start="1758.65" data-end="1760.03">messages between the different threads</span> <span data-start="1760.03" data-end="1763.75">in native code in how are you going to</span> <span data-start="1763.75" data-end="1765.039">get people to do that you know that's a</span> <span data-start="1765.039" data-end="1767.26">huge change so you're still asking for a</span> <span data-start="1767.26" data-end="1769.299">world where people have designed for the</span> <span data-start="1769.299" data-end="1771.669">web first is they have to say well I am</span> <span data-start="1771.669" data-end="1773.049">taking on these constraints where</span> <span data-start="1773.049" data-end="1774.73">everything goes in web workers and I'm</span> <span data-start="1774.73" data-end="1776.65">not using any library which happens to</span> <span data-start="1776.65" data-end="1778.6">use a thread so there's a fairly</span> <span data-start="1778.6" data-end="1781.12">hilarious discussion I saw on the M</span> <span data-start="1781.12" data-end="1783.4">script in IRC or someone's like I can't</span> <span data-start="1783.4" data-end="1785.14">compile this library it's saying not</span> <span data-start="1785.14" data-end="1787.51">finding win threads H or something along</span> <span data-start="1787.51" data-end="1790.27">those lines and then the person is like</span> <span data-start="1790.27" data-end="1791.62">well you can't have threads and they're</span> <span data-start="1791.62" data-end="1794.169">like I don't care if I have threads I</span> <span data-start="1794.169" data-end="1796.36">just want the library to work so there</span> <span data-start="1796.36" data-end="1798.13">there is certain mash ability things is</span> <span data-start="1798.13" data-end="1800.409">you just want to put the libraries</span> <span data-start="1800.409" data-end="1801.76">together and have it work and not worry</span> <span data-start="1801.76" data-end="1803.65">about the underlying things so requiring</span> <span data-start="1803.65" data-end="1805.9">a massive rewrite of everything that's a</span> <span data-start="1805.9" data-end="1814.36">bit of a non-starter thanks Nick</span> </p>
</section>