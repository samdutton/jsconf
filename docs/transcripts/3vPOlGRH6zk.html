<section>
<p><span data-start="10.56" data-end="21.52">you</span> <span data-start="21.53" data-end="23.73">but come to my talk about</span> <span data-start="23.73" data-end="27.06">is awesome but low latency is sublime my</span> <span data-start="27.06" data-end="29.46">name is hannah's i'm working for google</span> <span data-start="29.46" data-end="32.7">in munich and I member of TV a team how</span> <span data-start="32.7" data-end="36.87">many people in here know what v8 is yeah</span> <span data-start="36.87" data-end="40.47">quite some you know right soviet is for</span> <span data-start="40.47" data-end="42.089">people who don't know the JavaScript</span> <span data-start="42.089" data-end="43.92">engine which is for example used in</span> <span data-start="43.92" data-end="46.61">chrome and is the thingy that</span> <span data-start="46.61" data-end="48.42">understands or at least tries to</span> <span data-start="48.42" data-end="51">understand your JavaScript program and</span> <span data-start="51" data-end="55.65">execute it right so what is latency and</span> <span data-start="55.65" data-end="58.17">why is it important what we understand</span> <span data-start="58.17" data-end="62.219">by latency is the time DVM in our case</span> <span data-start="62.219" data-end="65.22">v8 interrupts your JavaScript program</span> <span data-start="65.22" data-end="67.95">and has to do some work right and this</span> <span data-start="67.95" data-end="70.92">work is mainly garbage collector work so</span> <span data-start="70.92" data-end="75.3">the DVM has to when it runs out of</span> <span data-start="75.3" data-end="77.16">memory it has to go through the</span> <span data-start="77.16" data-end="79.2">allocated memory and figure out which</span> <span data-start="79.2" data-end="81.09">memory is life and which one is dead and</span> <span data-start="81.09" data-end="83.46">free the dead memories so that the</span> </p>
<p><span data-start="83.46" data-end="85.2">JavaScript application can allocate more</span> <span data-start="85.2" data-end="87.929">memory and this process can also come</span> <span data-start="87.929" data-end="90.899">from the optimizing compiler so once in</span> <span data-start="90.899" data-end="93.09">a while we decide that one function</span> <span data-start="93.09" data-end="95.789">could run waste faster this is the time</span> <span data-start="95.789" data-end="97.8">when the optimizing compiler kicks in</span> <span data-start="97.8" data-end="100.14">optimizes the code and hopefully the</span> <span data-start="100.14" data-end="102.239">code runs faster and better after that</span> <span data-start="102.239" data-end="105.869">so these are all pauses which stop the</span> <span data-start="105.869" data-end="109.14">chava script application where vm stuff</span> <span data-start="109.14" data-end="111.179">happens and after that the travel script</span> <span data-start="111.179" data-end="113.94">applications is resumed and we call it</span> <span data-start="113.94" data-end="115.59">high latency right when these pauses</span> <span data-start="115.59" data-end="118.679">alone and low latency when this boss is</span> <span data-start="118.679" data-end="121.56">a short right and why do we want low</span> <span data-start="121.56" data-end="125.039">latency because it really matters shank</span> <span data-start="125.039" data-end="127.47">is something which is really visible to</span> <span data-start="127.47" data-end="129.569">the user right probably people</span> <span data-start="129.569" data-end="131.4">experience that in here right if you</span> <span data-start="131.4" data-end="134.879">play your games or watch a video or an</span> <span data-start="134.879" data-end="136.89">audio and they are like these chunks</span> <span data-start="136.89" data-end="140.28">this chitters in between it's really not</span> <span data-start="140.28" data-end="142.83">a nice user experience right and its</span> <span data-start="142.83" data-end="144.84">really annoying right nobody likes that</span> <span data-start="144.84" data-end="148.76">and Chang's gets worse and mobile</span> <span data-start="148.76" data-end="150.93">platforms right mobile platforms are</span> <span data-start="150.93" data-end="154.709">slower like the a3 of factor of three or</span> <span data-start="154.709" data-end="156.89">four slower than a beefy lab</span> <span data-start="156.89" data-end="159.53">top or a beefy desktop machine right so</span> <span data-start="159.53" data-end="161.99">in mobile the change is even worse right</span> <span data-start="161.99" data-end="167.06">so as a vm engineer we like performance</span> <span data-start="167.06" data-end="169.22">right we'd like to tune performance but</span> <span data-start="169.22" data-end="171.95">latency is something which is sometimes</span> <span data-start="171.95" data-end="174.17">really on trade off with Rupert right</span> <span data-start="174.17" data-end="176.36">you can get better latency but you pay</span> <span data-start="176.36" data-end="178.52">in throughput for that so what we are</span> <span data-start="178.52" data-end="181.25">trying to do is to keep this interrupt</span> <span data-start="181.25" data-end="183.88">short but short we mean few milliseconds</span> <span data-start="183.88" data-end="186.02">whatever that means rights basically</span> <span data-start="186.02" data-end="189.26">around would be great to have pauses</span> <span data-start="189.26" data-end="191.33">which are not longer than let's say five</span> <span data-start="191.33" data-end="192.95">milliseconds of below one millisecond</span> <span data-start="192.95" data-end="194.959">the shorter the better right the better</span> <span data-start="194.959" data-end="197.75">user experience obviously and it would</span> <span data-start="197.75" data-end="201.769">be nice to have predictable pauses right</span> <span data-start="201.769" data-end="204.5">so it's like a real kind of moving in</span> <span data-start="204.5" data-end="207.95">this soft real-time ballgame right where</span> <span data-start="207.95" data-end="211.55">the developer may rely on some soft</span> <span data-start="211.55" data-end="214.13">guarantees we give him right and that</span> <span data-start="214.13" data-end="215.45">that would be nice it's not the case</span> <span data-start="215.45" data-end="217.97">these days right but that would be the</span> <span data-start="217.97" data-end="220.13">optimum outcome right that the vm has</span> <span data-start="220.13" data-end="223.07">some promises for the developer and for</span> <span data-start="223.07" data-end="224.87">example it deposit ends are never larger</span> <span data-start="224.87" data-end="229.06">them and milliseconds or whatever so</span> <span data-start="229.06" data-end="232.37">short overview of my talk so latency is</span> <span data-start="232.37" data-end="235.489">an issue and we recently like start</span> <span data-start="235.489" data-end="239.03">focusing in it and improving it and I'll</span> <span data-start="239.03" data-end="241.4">give a shorter with you about our</span> <span data-start="241.4" data-end="243.2">garbage collector and now optimizing</span> <span data-start="243.2" data-end="245.72">compiler few basic how this stuff worked</span> <span data-start="245.72" data-end="248.72">and the efforts we are taking their to</span> <span data-start="248.72" data-end="251.57">keep Layton's low then I will show to</span> <span data-start="251.57" data-end="254.299">latency benchmarks we're using to</span> <span data-start="254.299" data-end="257.209">evaluate our optimizations show them in</span> <span data-start="257.209" data-end="259.25">experiments how we improved over the</span> <span data-start="259.25" data-end="261.919">last year and draw some conclusions and</span> <span data-start="261.919" data-end="264.77">there should be time for Q&A maybe</span> <span data-start="264.77" data-end="267.43">otherwise we talk offline after the talk</span> <span data-start="267.43" data-end="270.95">so in v8 we have a generational garbage</span> <span data-start="270.95" data-end="273.5">collector this project Lou is used by</span> <span data-start="273.5" data-end="276.2">many bm's we have a relatively small new</span> <span data-start="276.2" data-end="278.9">generation and they have use a semi</span> <span data-start="278.9" data-end="281.69">space heap in a scavenger semi space</span> <span data-start="281.69" data-end="284.09">means that we just use half of the</span> <span data-start="284.09" data-end="286.13">memory so when we allocate stuff there</span> <span data-start="286.13" data-end="288.83">that's okay the few objects and we run</span> <span data-start="288.83" data-end="290.51">out of memory there now</span> <span data-start="290.51" data-end="294.11">semi space the scavenger looks for the</span> <span data-start="294.11" data-end="295.7">object is what the scavenger is doing</span> <span data-start="295.7" data-end="297.59">it's basically walking throughout the</span> <span data-start="297.59" data-end="299.12">life objects and as soon as it</span> <span data-start="299.12" data-end="301.58">encounters the life objects it copies it</span> <span data-start="301.58" data-end="303.95">over to the other half of the SME space</span> <span data-start="303.95" data-end="306.29">let's say two objects survive here in</span> <span data-start="306.29" data-end="309.17">our example there is a dead right so the</span> <span data-start="309.17" data-end="313.64">scavenger is pretty fast then there is a</span> <span data-start="313.64" data-end="315.92">no generation and this is typically the</span> <span data-start="315.92" data-end="318.47">memory where objects end up dead</span> <span data-start="318.47" data-end="321.02">survived for quite some time right and</span> <span data-start="321.02" data-end="323.27">they ever use a mark and sweep garbage</span> <span data-start="323.27" data-end="325.13">collect the mark and sweep means we</span> <span data-start="325.13" data-end="327.2">calculate the transitive closure of our</span> <span data-start="327.2" data-end="329.96">live objects go through this graph and</span> <span data-start="329.96" data-end="333.35">mark all the objects we find that their</span> <span data-start="333.35" data-end="336.47">life and after that when we computed the</span> <span data-start="336.47" data-end="338.96">whole transitive closure we scan over</span> <span data-start="338.96" data-end="342.11">the whole heap and free not marked stuff</span> <span data-start="342.11" data-end="345.11">and for marked objects we just clear the</span> <span data-start="345.11" data-end="347.14">markup it and go on so you see</span> <span data-start="347.14" data-end="349.79">scavengers can be fast right the heap is</span> <span data-start="349.79" data-end="352.1">smaller and they are fast when a lot of</span> <span data-start="352.1" data-end="354.08">objects died in the young generation</span> <span data-start="354.08" data-end="357.8">immediately and the old generation is</span> <span data-start="357.8" data-end="360.26">big can be really big and garbage</span> <span data-start="360.26" data-end="361.7">collections can take longer there right</span> <span data-start="361.7" data-end="363.65">so let's fill up the semi space again</span> <span data-start="363.65" data-end="366.92">and then let's say object survived well</span> <span data-start="366.92" data-end="369.26">they eventually end up in the old</span> <span data-start="369.26" data-end="373.97">generation okay so the main assumption</span> <span data-start="373.97" data-end="375.5">between the generational garbage</span> <span data-start="375.5" data-end="377.99">collector is that most of the objects</span> <span data-start="377.99" data-end="380.87">that get allocated die young right they</span> <span data-start="380.87" data-end="383.3">are l research out there that shows like</span> <span data-start="383.3" data-end="385.82">for many many application that is true</span> <span data-start="385.82" data-end="388.01">right and this already gives us some</span> <span data-start="388.01" data-end="390.29">nice latency properties right this</span> <span data-start="390.29" data-end="393.02">results in many short young generation</span> <span data-start="393.02" data-end="396.98">collections which are shown you by s or</span> </p>
<p><span data-start="396.98" data-end="399.62">I just saw this lights are not really IC</span> <span data-start="399.62" data-end="403.88">shown all right now and once in a while</span> <span data-start="403.88" data-end="407.12">when when many objects a wife they end</span> <span data-start="407.12" data-end="409.19">up in the old generation and we have</span> <span data-start="409.19" data-end="412.64">this long are marking three times one</span> <span data-start="412.64" data-end="416.9">roofer should fix the slides here okay</span> <span data-start="416.9" data-end="418.88">now that's gone I apologize for that it</span> <span data-start="418.88" data-end="421.01">looks nice on the green screen here and</span> <span data-start="421.01" data-end="421.64">there</span> <span data-start="421.64" data-end="431.25">sorry yeah so we have once in a while</span> <span data-start="431.25" data-end="433.44">this long atomic markings report well</span> <span data-start="433.44" data-end="436.11">let's try to get again a full screen</span> <span data-start="436.11" data-end="448.64">mode maybe it gets better</span> <span data-start="448.65" data-end="469.43">no not really</span> <span data-start="469.44" data-end="472.03">step better oh okay that looks better</span> <span data-start="472.03" data-end="474.43">sorry for the interval that was high</span> <span data-start="474.43" data-end="479.11">latency by the way so to get rid of</span> <span data-start="479.11" data-end="482.8">these longer mark and sweet pauses what</span> <span data-start="482.8" data-end="484.21">we implemented there is a technique</span> <span data-start="484.21" data-end="486.85">called incremental marking that means</span> <span data-start="486.85" data-end="489.73">when we do mark and sweep we don't do it</span> <span data-start="489.73" data-end="492.13">all the work at once before we run out</span> <span data-start="492.13" data-end="494.5">of memory we already do some marking</span> <span data-start="494.5" data-end="496.45">work in advance to smaller marking steps</span> <span data-start="496.45" data-end="498.73">until a point we decide that oh we</span> <span data-start="498.73" data-end="501.52">probably have marked now enough and then</span> <span data-start="501.52" data-end="504.1">do a final mark and sweep operation so</span> <span data-start="504.1" data-end="506.17">it looks like that we smear over the</span> <span data-start="506.17" data-end="508.54">whole JavaScript program execution</span> <span data-start="508.54" data-end="510.55">smaller markings that which are really</span> <span data-start="510.55" data-end="512.08">really short right they are shorter than</span> <span data-start="512.08" data-end="514.63">a millisecond and then we do a final</span> <span data-start="514.63" data-end="517.75">mark and sweep operation this improved</span> <span data-start="517.75" data-end="519.82">latency significantly and user</span> <span data-start="519.82" data-end="521.8">experience right this long marking face</span> <span data-start="521.8" data-end="524.169">is now split up into many short ones and</span> <span data-start="524.169" data-end="529.15">a big final marking face so how we can</span> <span data-start="529.15" data-end="531.81">how can we do better there how we can we</span> <span data-start="531.81" data-end="534.97">shrink the size of these final mark and</span> <span data-start="534.97" data-end="537.88">sweep face well we can use multiple</span> <span data-start="537.88" data-end="540.52">frets rights to for example the speed up</span> <span data-start="540.52" data-end="542.5">the sweeping and what we implement that</span> <span data-start="542.5" data-end="544.81">and editor we ate about half a year ago</span> <span data-start="544.81" data-end="547.33">is a technique called parallel and</span> <span data-start="547.33" data-end="549.79">concurrent sweeping parallel sweeping</span> <span data-start="549.79" data-end="551.77">means that there are multiple threats</span> <span data-start="551.77" data-end="555.01">helping out to free memory so each fret</span> <span data-start="555.01" data-end="557.26">gets like one megabyte of the old</span> <span data-start="557.26" data-end="559.66">generation heap and go through these</span> <span data-start="559.66" data-end="561.76">megabyte and finds all the free objects</span> <span data-start="561.76" data-end="563.44">and gives it back to the main</span> <span data-start="563.44" data-end="565.33">applications so you can have multiple</span> <span data-start="565.33" data-end="568">threats doing that to get a speed up by</span> <span data-start="568" data-end="571.57">the number of frets and concurrent</span> <span data-start="571.57" data-end="573.1">sweeping means that we can also run this</span> <span data-start="573.1" data-end="575.38">sweeping phrase concurrently to the</span> </p>
<p><span data-start="575.38" data-end="577.78">JavaScript application which means that</span> <span data-start="577.78" data-end="579.73">this whipping phase can be completely</span> <span data-start="579.73" data-end="582.67">transparent and invisible to the to the</span> <span data-start="582.67" data-end="585.54">application so sweeping phase kind of</span> <span data-start="585.54" data-end="588.46">goes completely away and the execution</span> <span data-start="588.46" data-end="591.12">time of this final mark and sweep phase</span> <span data-start="591.12" data-end="594.49">decreased even more so there is a</span> <span data-start="594.49" data-end="596.35">trade-off right we have multiple threats</span> <span data-start="596.35" data-end="598.06">which means higher system utilization</span> <span data-start="598.06" data-end="601.12">and but we get wet latency out of it and</span> <span data-start="601.12" data-end="602.62">one really as today</span> <span data-start="602.62" data-end="604.33">earlier that right if you had too many</span> <span data-start="604.33" data-end="606.97">frets and increased performance too much</span> <span data-start="606.97" data-end="609.67">it can be an issue again on mobile which</span> <span data-start="609.67" data-end="611.77">means system utilization typically</span> <span data-start="611.77" data-end="616.53">translate into battery life right so</span> <span data-start="616.53" data-end="620.53">then let's tackle next the scavenging</span> <span data-start="620.53" data-end="622.63">times right as I said scavenging</span> <span data-start="622.63" data-end="624.7">typically so the new generation</span> <span data-start="624.7" data-end="626.8">collection doesn't take much time</span> <span data-start="626.8" data-end="630.31">because of the main assumption that most</span> <span data-start="630.31" data-end="632.68">of the objects die young but what if all</span> <span data-start="632.68" data-end="636.07">the object survive or not all of most of</span> <span data-start="636.07" data-end="638.53">the objects survive right what then well</span> <span data-start="638.53" data-end="640.21">then scavenging is really really slow</span> <span data-start="640.21" data-end="643.6">because as you remember when you a</span> <span data-start="643.6" data-end="646.42">locate object and all alive you have to</span> <span data-start="646.42" data-end="649.06">copy them all over in the semi space and</span> <span data-start="649.06" data-end="651.52">thats get gets even worse right let's</span> <span data-start="651.52" data-end="654.19">say they survive even longer well then</span> <span data-start="654.19" data-end="656.11">you have to copy them over to the old</span> <span data-start="656.11" data-end="658.24">generation so we had to do two copies in</span> <span data-start="658.24" data-end="660.04">that case right and this is really the</span> <span data-start="660.04" data-end="664.21">the worst case for for the generational</span> <span data-start="664.21" data-end="666.61">garbage collector so how can we do</span> <span data-start="666.61" data-end="669.31">better there and what we did is we</span> <span data-start="669.31" data-end="672.07">implemented a technique called global</span> <span data-start="672.07" data-end="675.34">preteen ring which sets kind of a global</span> <span data-start="675.34" data-end="677.29">flag in the vm when we encounter that</span> <span data-start="677.29" data-end="680.05">more than ninety percent of the objects</span> <span data-start="680.05" data-end="682.63">survive and go from the new generation</span> <span data-start="682.63" data-end="685.09">to the old generation we flip a switch</span> <span data-start="685.09" data-end="688.24">and currently what we do is we have to</span> <span data-start="688.24" data-end="691.47">dip demise all the generated code and</span> <span data-start="691.47" data-end="695.16">when we generate fast code again we</span> <span data-start="695.16" data-end="697.78">generated with a location code that</span> <span data-start="697.78" data-end="699.82">allocates directly into the old</span> <span data-start="699.82" data-end="702.82">generation and when we so what's going</span> <span data-start="702.82" data-end="704.98">on is we allocate directly there we have</span> <span data-start="704.98" data-end="707.26">white the copying and when you find out</span> <span data-start="707.26" data-end="710.8">that ok most of the objects now die in</span> <span data-start="710.8" data-end="712.75">the old generation for whatever reason</span> <span data-start="712.75" data-end="714.25">right the application behavior may</span> <span data-start="714.25" data-end="717.01">change well then we have to do p again</span> <span data-start="717.01" data-end="719.92">and generate code again where everything</span> <span data-start="719.92" data-end="723.76">gets allocated in a new generation it's</span> <span data-start="723.76" data-end="725.56">kind of a global thing right now but we</span> <span data-start="725.56" data-end="727.81">are trying to get this Pretender ring on</span> <span data-start="727.81" data-end="730.75">a allocation side basis so on a local</span> <span data-start="730.75" data-end="732.78">basis so that we can decide for each</span> <span data-start="732.78" data-end="735.49">allocation call in JavaScript well</span> <span data-start="735.49" data-end="736.329">should you</span> <span data-start="736.329" data-end="737.98">yeah located in the new generation or</span> <span data-start="737.98" data-end="740.11">would you better be in the old</span> <span data-start="740.11" data-end="744.579">generation right alright so what happens</span> <span data-start="744.579" data-end="746.499">there is for like let's say we have this</span> <span data-start="746.499" data-end="750.489">worst-case application where a lot of</span> <span data-start="750.489" data-end="752.679">stuff survives and we turn on the skill</span> <span data-start="752.679" data-end="754.749">while pretending we have wet the copying</span> <span data-start="754.749" data-end="756.61">and we can avoid these cabbages at all</span> <span data-start="756.61" data-end="758.499">right because stuff immediately gets</span> <span data-start="758.499" data-end="760.959">allocated in the old generation right</span> <span data-start="760.959" data-end="762.73">that helped to improve latency</span> <span data-start="762.73" data-end="764.67">significantly for this worst-case</span> <span data-start="764.67" data-end="769.499">behavior applications all right so much</span> <span data-start="769.499" data-end="772.6">for the garbage collector let's have a</span> <span data-start="772.6" data-end="776.11">quick look at the our compiler as I</span> <span data-start="776.11" data-end="777.67">mention in the beginning the compiler</span> <span data-start="777.67" data-end="781.449">may also introduce some chanc right what</span> <span data-start="781.449" data-end="785.559">we have in v8 is a we call the full code</span> <span data-start="785.559" data-end="788.139">generator which is really really fast it</span> <span data-start="788.139" data-end="792.129">is able to generate a good code i would</span> <span data-start="792.129" data-end="794.319">say really fast and then there is the</span> <span data-start="794.319" data-end="796.54">optimizing compiler and the optimizing</span> <span data-start="796.54" data-end="798.519">compiler is used when we encounter that</span> <span data-start="798.519" data-end="801.699">a function is executed many times then</span> <span data-start="801.699" data-end="804.79">we say it's a hot function and we should</span> <span data-start="804.79" data-end="807.189">generate faster code for this function</span> <span data-start="807.189" data-end="810.309">right and when we find that out the</span> <span data-start="810.309" data-end="811.959">travel sleep Fred next time and it</span> <span data-start="811.959" data-end="814.089">executes the fred is doing the actual</span> <span data-start="814.089" data-end="817.48">compilation right so it goes into vm is</span> <span data-start="817.48" data-end="820.869">doing all the optimizations and this may</span> <span data-start="820.869" data-end="822.73">take some time this actually depends on</span> <span data-start="822.73" data-end="826.36">the code size right that gets compiled</span> <span data-start="826.36" data-end="830.679">so you will have these vm passes but we</span> <span data-start="830.679" data-end="831.61">saw before for the garbage collector</span> <span data-start="831.61" data-end="834.85">also for a compiler and what we are</span> <span data-start="834.85" data-end="837.459">doing there well quite similar to the</span> <span data-start="837.459" data-end="839.97">garbage collector before we use</span> <span data-start="839.97" data-end="842.079">mechanism called concurrent compilation</span> <span data-start="842.079" data-end="844.929">so we use an extra fret that helps us</span> <span data-start="844.929" data-end="847.329">out with doing compilation work right</span> <span data-start="847.329" data-end="850.509">and we're trying to make more and more</span> <span data-start="850.509" data-end="853.629">phases of the compiler concurrent which</span> <span data-start="853.629" data-end="855.579">is quite tricky because the new</span> <span data-start="855.579" data-end="857.41">compilation time you can allocate object</span> <span data-start="857.41" data-end="859.299">or them the application itself may</span> <span data-start="859.299" data-end="863.679">mutate objects which are kind of hooked</span> <span data-start="863.679" data-end="865.48">up with the function we are now</span> <span data-start="865.48" data-end="868.899">compiling so we try to get more and more</span> <span data-start="868.899" data-end="869.84">phases</span> <span data-start="869.84" data-end="873.5">of the optimizing compiler to make them</span> <span data-start="873.5" data-end="876.49">concurrent and run in parallel with the</span> </p>
<p><span data-start="876.49" data-end="880.1">JavaScript application the result there</span> <span data-start="880.1" data-end="882.08">is of course we use compilation time</span> <span data-start="882.08" data-end="883.82">right if you can stuff to do concurrent</span> <span data-start="883.82" data-end="889.85">and a nice benefit of that is when we do</span> <span data-start="889.85" data-end="891.5">compile stuff concurrently to the</span> <span data-start="891.5" data-end="893.12">mutator we can actually do more</span> <span data-start="893.12" data-end="894.71">aggressive optimizations right if</span> <span data-start="894.71" data-end="898.13">there's time left and in the experiments</span> <span data-start="898.13" data-end="900.86">show that there's always enough time</span> <span data-start="900.86" data-end="904.1">left to do to do the compilation the</span> <span data-start="904.1" data-end="905.87">extra fret we can do really heavy</span> <span data-start="905.87" data-end="908.06">optimizations and generate even faster</span> <span data-start="908.06" data-end="909.68">code which was not possible before</span> <span data-start="909.68" data-end="912.2">because the post times would just be too</span> <span data-start="912.2" data-end="914.21">long if we would do it all on the same</span> </p>
<p><span data-start="914.21" data-end="919.28">JavaScript fret so all right now we</span> <span data-start="919.28" data-end="922.75">covered quite some stuff in the vm that</span> <span data-start="922.75" data-end="925.88">improved latency of the garbage collect</span> <span data-start="925.88" data-end="928.22">and the optimizing compiler now let's</span> <span data-start="928.22" data-end="931.88">see how we can measure that stuff so i'm</span> <span data-start="931.88" data-end="934.52">now going to explain how we measure the</span> <span data-start="934.52" data-end="936.44">stuff within the JavaScript application</span> <span data-start="936.44" data-end="939.14">of course we could look at the vm output</span> <span data-start="939.14" data-end="941.15">right we have in v8 we have several</span> <span data-start="941.15" data-end="944.51">flags where we can ask DVM how long it</span> <span data-start="944.51" data-end="946.91">took but we do we don't trust our output</span> <span data-start="946.91" data-end="949.97">right so we really want to have the</span> <span data-start="949.97" data-end="952.37">application tell us whether it was a</span> <span data-start="952.37" data-end="955.34">good chunk experience or not right and</span> <span data-start="955.34" data-end="957.35">the way we do that is we take a</span> </p>
<p><span data-start="957.35" data-end="961.22">JavaScript program and add time probes</span> <span data-start="961.22" data-end="963.59">to the application right so let's say we</span> <span data-start="963.59" data-end="967.31">have a function that's allocating stuff</span> <span data-start="967.31" data-end="970.22">and doing some calculations before and</span> <span data-start="970.22" data-end="971.99">after the function we measure the time</span> <span data-start="971.99" data-end="974.27">and we execute this function many many</span> <span data-start="974.27" data-end="976.64">times right so in the best case this</span> <span data-start="976.64" data-end="978.65">function should be always fast and it</span> <span data-start="978.65" data-end="980.42">should we always take the same amount of</span> <span data-start="980.42" data-end="983.12">time right except when DVM has to do</span> <span data-start="983.12" data-end="985.12">some stuff like garbage collection or</span> <span data-start="985.12" data-end="987.86">compilation then you may have outliers</span> <span data-start="987.86" data-end="989.78">right so the samples which we measure</span> <span data-start="989.78" data-end="992.6">may have different time spans and then</span> <span data-start="992.6" data-end="994.73">when we run this function many many</span> <span data-start="994.73" data-end="997.34">times we calculate the root mean square</span> <span data-start="997.34" data-end="1001.72">of this sample times and this function</span> <span data-start="1001.72" data-end="1003.13">the root mean square</span> <span data-start="1003.13" data-end="1006.1">heavily penalized outliers there right</span> <span data-start="1006.1" data-end="1008.35">so this is what the square the formula</span> <span data-start="1008.35" data-end="1010.42">is taking care of when you have a huge</span> <span data-start="1010.42" data-end="1012.31">sample then you get penalized for that</span> <span data-start="1012.31" data-end="1015.01">right which translates into a bad user</span> <span data-start="1015.01" data-end="1017.02">experience right the first you can</span> <span data-start="1017.02" data-end="1019.18">execute the samples and the more</span> <span data-start="1019.18" data-end="1020.71">predictable they are the better the</span> <span data-start="1020.71" data-end="1026.14">score will be so the benchmarks I'm</span> <span data-start="1026.14" data-end="1028.329">using my experience here experiments</span> <span data-start="1028.329" data-end="1031">here to benchmarks from our octane</span> <span data-start="1031" data-end="1033.49">benchmark suit this is our JavaScript</span> <span data-start="1033.49" data-end="1035.56">benchmark suit where we measure</span> <span data-start="1035.56" data-end="1039.459">performance of v8 the first one is</span> <span data-start="1039.459" data-end="1042.1">called splay this benchmarks creates a</span> <span data-start="1042.1" data-end="1045.01">large splay tree and then modifies it</span> <span data-start="1045.01" data-end="1047.86">and in this benchmark like almost all</span> <span data-start="1047.86" data-end="1050.02">objects survive so this is kind of</span> <span data-start="1050.02" data-end="1052">divorce case benchmark for a</span> <span data-start="1052" data-end="1054.37">generational garbage collector right so</span> <span data-start="1054.37" data-end="1056.44">when we want to prove this worst-case</span> <span data-start="1056.44" data-end="1060.04">scenario dislike the worst-case post</span> <span data-start="1060.04" data-end="1063.07">times we can observe and we're trying to</span> <span data-start="1063.07" data-end="1065.56">make the better and for the compiler we</span> <span data-start="1065.56" data-end="1068.35">look at them and real benchmark this one</span> <span data-start="1068.35" data-end="1070.75">is also in the contain benchmarks field</span> <span data-start="1070.75" data-end="1073.33">it runs the 3d bullet entry imported</span> <span data-start="1073.33" data-end="1077.37">from C++ to JavaScript using module and</span> <span data-start="1077.37" data-end="1079.99">the thing there is there like huge code</span> <span data-start="1079.99" data-end="1083.05">chunks it's like thousands of lines of</span> </p>
<p><span data-start="1083.05" data-end="1085.78">JavaScript code and when the optimizing</span> <span data-start="1085.78" data-end="1089.77">compiler or the full kochan looks at the</span> <span data-start="1089.77" data-end="1092.14">functions compilation times may be</span> <span data-start="1092.14" data-end="1097.36">really really long so all right so this</span> <span data-start="1097.36" data-end="1100.69">is what we did then let's look at the</span> <span data-start="1100.69" data-end="1103.06">results the results both experiments run</span> <span data-start="1103.06" data-end="1105.25">on a nexus 10 on a mobile device it's</span> <span data-start="1105.25" data-end="1107.41">quite a beefy mobile device but I was</span> <span data-start="1107.41" data-end="1111.31">lying on my desk and with Android 403</span> <span data-start="1111.31" data-end="1113.41">let's look it's play first so this is</span> <span data-start="1113.41" data-end="1115.84">the garbage collection benchmark on the</span> <span data-start="1115.84" data-end="1118.66">x-axis you see the timeline starting in</span> </p>
<p><span data-start="1118.66" data-end="1122.56">September last year until today and on</span> <span data-start="1122.56" data-end="1124.42">the y-axis is the score so higher is</span> <span data-start="1124.42" data-end="1126.16">better so we take the root-mean-square</span> <span data-start="1126.16" data-end="1129.67">and just reverse to be higher this</span> <span data-start="1129.67" data-end="1132.37">better and all these features i</span> <span data-start="1132.37" data-end="1134.32">mentioned before except for the</span> <span data-start="1134.32" data-end="1135.84">incremental marking where</span> <span data-start="1135.84" data-end="1138.15">ship within the last year and one can</span> <span data-start="1138.15" data-end="1140.88">see that we we doubled our our score on</span> <span data-start="1140.88" data-end="1144.51">this benchmark which is quite nice if we</span> <span data-start="1144.51" data-end="1147.929">look at the specific samples what we do</span> <span data-start="1147.929" data-end="1150.029">here is like we do if you split three</span> <span data-start="1150.029" data-end="1151.83">modifications and then we measure a time</span> <span data-start="1151.83" data-end="1154.08">then go on do again like a predefined</span> <span data-start="1154.08" data-end="1156.36">amount of splay tree modifications on</span> <span data-start="1156.36" data-end="1158.94">average it takes 20 to 1 milliseconds</span> <span data-start="1158.94" data-end="1161.669">but they're like some maximum outliers</span> <span data-start="1161.669" data-end="1163.74">at the very beginning of the benchmark</span> <span data-start="1163.74" data-end="1166.5">they go up to 46 milliseconds which is</span> <span data-start="1166.5" data-end="1169.169">bad right so we can do better there we</span> <span data-start="1169.169" data-end="1170.82">investigate and what we can do were</span> <span data-start="1170.82" data-end="1174.24">there because 46 milliseconds means that</span> <span data-start="1174.24" data-end="1177.27">there will be lost frames right and this</span> <span data-start="1177.27" data-end="1179.789">is what you can also see when you</span> <span data-start="1179.789" data-end="1182.429">started it with a visualization see a</span> <span data-start="1182.429" data-end="1184.59">few chunks at the very beginning but</span> <span data-start="1184.59" data-end="1186.39">then it runs smooth right is like three</span> <span data-start="1186.39" data-end="1188.1">outliers we get in the beginning there</span> <span data-start="1188.1" data-end="1191.13">the minimum sample time is below 1</span> <span data-start="1191.13" data-end="1194.279">millisecond it's quite nice so form</span> <span data-start="1194.279" data-end="1197.279">unreal we hook the measurement up with</span> <span data-start="1197.279" data-end="1199.23">the frame rendering time so there's like</span> <span data-start="1199.23" data-end="1201.809">this time there is like the rendering it</span> <span data-start="1201.809" data-end="1204.029">sells going on and also the vm time on</span> <span data-start="1204.029" data-end="1207.24">average it takes 90 milliseconds to</span> <span data-start="1207.24" data-end="1209.159">render such a frame which includes like</span> <span data-start="1209.159" data-end="1211.23">everything right there's also the</span> <span data-start="1211.23" data-end="1212.7">computation work is also quite heavy</span> <span data-start="1212.7" data-end="1215.94">there um but there's a huge outlier in</span> <span data-start="1215.94" data-end="1218.49">the beginning right 249 milliseconds</span> <span data-start="1218.49" data-end="1220.679">just like one outlier and then they are</span> <span data-start="1220.679" data-end="1224.669">few around 40 milliseconds if I remember</span> <span data-start="1224.669" data-end="1226.2">correctly and after that it runs smooth</span> <span data-start="1226.2" data-end="1229.2">this is a time the first outlier is</span> <span data-start="1229.2" data-end="1231.75">related to when the full coach and</span> <span data-start="1231.75" data-end="1234.12">compiles the whole javascript file right</span> <span data-start="1234.12" data-end="1236.46">so again you may get some chunk at the</span> <span data-start="1236.46" data-end="1238.2">beginning when you execute the</span> <span data-start="1238.2" data-end="1240.72">application but after that you define</span> <span data-start="1240.72" data-end="1243.45">but again there's there stuff where we</span> <span data-start="1243.45" data-end="1247.23">can do better all right that already</span> <span data-start="1247.23" data-end="1251.07">brings me to the end of the talk low</span> <span data-start="1251.07" data-end="1254.789">latency of the vm i guess is key to keep</span> <span data-start="1254.789" data-end="1258">the user happy and make web application</span> <span data-start="1258" data-end="1260.429">run well on all devices right not just</span> <span data-start="1260.429" data-end="1263.49">on a macbook oh and a heavy desktop</span> <span data-start="1263.49" data-end="1266.54">machine but also on on mobile mobile</span> <span data-start="1266.54" data-end="1270.23">yeah it would be nice if javascript gems</span> <span data-start="1270.23" data-end="1272">could provide predictable performance</span> <span data-start="1272" data-end="1273.95">and give a promise to the application</span> <span data-start="1273.95" data-end="1276.41">developers we're not quite there yet but</span> </p>
<p><span data-start="1276.41" data-end="1279.56">I think that this is the direction we</span> <span data-start="1279.56" data-end="1283.25">should head because many programmers try</span> <span data-start="1283.25" data-end="1286.01">to work around to vm right like okay did</span> <span data-start="1286.01" data-end="1288.17">you see make a kin so let's build our</span> <span data-start="1288.17" data-end="1290.36">own memory management system within our</span> </p>
<p><span data-start="1290.36" data-end="1292.25">JavaScript application and this is</span> <span data-start="1292.25" data-end="1294.2">actually hard to do right the object</span> <span data-start="1294.2" data-end="1296.09">pooling and stuff like that and the</span> <span data-start="1296.09" data-end="1299.33">probability is high that one gets just</span> <span data-start="1299.33" data-end="1301.91">wrong right and you end up with day with</span> <span data-start="1301.91" data-end="1305.63">the same performance problems or it</span> <span data-start="1305.63" data-end="1308.57">could be even worse right we already</span> <span data-start="1308.57" data-end="1311.15">have some algorithms in v8 that</span> <span data-start="1311.15" data-end="1313.46">eliminate allocations right so we</span> <span data-start="1313.46" data-end="1315.76">recently landed an algorithm called</span> <span data-start="1315.76" data-end="1318.44">which is doing escape analysis right it</span> <span data-start="1318.44" data-end="1320.99">finds out whether an allocation escapes</span> <span data-start="1320.99" data-end="1323.18">a function and if it's not then it's not</span> <span data-start="1323.18" data-end="1325.76">actually allocated on the heap or other</span> <span data-start="1325.76" data-end="1328.01">allocation folding which takes multiple</span> <span data-start="1328.01" data-end="1329.99">allocations and folds them together into</span> <span data-start="1329.99" data-end="1333.44">enter one right so we're trying to to a</span> <span data-start="1333.44" data-end="1336.44">whitening get better there and the</span> <span data-start="1336.44" data-end="1338.12">latency benchmarks are showed while</span> <span data-start="1338.12" data-end="1340.1">they're quite important for us to keep</span> <span data-start="1340.1" data-end="1343.04">track of performance improvement and</span> <span data-start="1343.04" data-end="1346.13">regressions and they really help us to</span> <span data-start="1346.13" data-end="1349.51">show where where we can do better and</span> <span data-start="1349.51" data-end="1353.09">help us to evaluate new features all</span> <span data-start="1353.09" data-end="1354.83">right that's the end of my talk thank</span> <span data-start="1354.83" data-end="1356.78">you very much maybe there is time for</span> <span data-start="1356.78" data-end="1369.02">questions I don't know how much time is</span> </p>
</section>