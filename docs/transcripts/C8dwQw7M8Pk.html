<section>
<p><span data-start="0.03" data-end="5.16">hello how y'all doing ready the clouds</span> <span data-start="5.16" data-end="6.87">have been fantastic I'm super happy that</span> <span data-start="6.87" data-end="7.83">I was actually able to get here as my</span> <span data-start="7.83" data-end="9.99">first Cascadia J s been meaning to come</span> <span data-start="9.99" data-end="11.49">for a couple of years it's been</span> <span data-start="11.49" data-end="13.86">absolutely phenomenal unfortunately</span> <span data-start="13.86" data-end="15.089">after the talk I'm gonna have to walk</span> <span data-start="15.089" data-end="16.44">off the stage and right out to the lift</span> <span data-start="16.44" data-end="17.789">the airport I'm gonna miss the party</span> <span data-start="17.789" data-end="19.14">tonight I hope y'all have fun it's</span> <span data-start="19.14" data-end="21.51">something an absolute blast</span> <span data-start="21.51" data-end="25.23">so I'm James J a snow online pretty much</span> <span data-start="25.23" data-end="27.029">everywhere it's whitter github</span> <span data-start="27.029" data-end="30.42">you've gmail you know feel free to reach</span> <span data-start="30.42" data-end="31.769">out anytime if you want to talk about</span> <span data-start="31.769" data-end="35.63">node we're contributing to open source I</span> <span data-start="35.63" data-end="39.53">work for these folks are a company</span> <span data-start="39.53" data-end="41.46">headquartered on the southern coast of</span> </p>
<p><span data-start="41.46" data-end="43.35">Ireland a tiny little village you would</span> <span data-start="43.35" data-end="44.82">have no idea that there was an</span> <span data-start="44.82" data-end="46.219">international software company there</span> <span data-start="46.219" data-end="48.18">there's about a hundred and thirty of us</span> <span data-start="48.18" data-end="52.62">spread about over 24 countries they pay</span> <span data-start="52.62" data-end="54.989">me to work on node full-time my</span> <span data-start="54.989" data-end="57.18">literally on the platform itself and I</span> <span data-start="57.18" data-end="60.84">also manage the consulting team there so</span> <span data-start="60.84" data-end="64.409">not only do I get to build node I get to</span> <span data-start="64.409" data-end="66.33">help go out and teach people how to use</span> <span data-start="66.33" data-end="70.799">it and how to use it better so it you</span> <span data-start="70.799" data-end="72.39">know it's really exciting for me because</span> <span data-start="72.39" data-end="74.13">you know I get to see every day they do</span> <span data-start="74.13" data-end="76.14">the really amazing things that people</span> <span data-start="76.14" data-end="79.11">are using node for but they also get to</span> <span data-start="79.11" data-end="82.08">see the kind of the misconceptions or</span> <span data-start="82.08" data-end="85.14">the mistakes that are made not from the</span> <span data-start="85.14" data-end="87.09">fault you know from the engineering</span> <span data-start="87.09" data-end="89.25">teams faults but largely due to</span> <span data-start="89.25" data-end="90.36">misconceptions of the programming</span> <span data-start="90.36" data-end="91.86">language things that we did not</span> <span data-start="91.86" data-end="93.93">communicate properly about the platform</span> <span data-start="93.93" data-end="97.34">how it works and there's a lot of</span> <span data-start="97.34" data-end="99.27">misconception out there about how the</span> <span data-start="99.27" data-end="104.759">node internals actually function for the</span> <span data-start="104.759" data-end="107.729">past probably a year whenever a customer</span> <span data-start="107.729" data-end="109.409">comes to our team and they're saying</span> <span data-start="109.409" data-end="111.899">well our node app is kind of slow we</span> <span data-start="111.899" data-end="114.54">need to figure out why my first question</span> <span data-start="114.54" data-end="118.29">is are you using promises and if they</span> <span data-start="118.29" data-end="121.469">say yeah my first response is you're</span> <span data-start="121.469" data-end="125.07">using them wrong because typically folks</span> <span data-start="125.07" data-end="127.259">are actually using them wrong and it's</span> <span data-start="127.259" data-end="129.149">and it's not their fault it's just the</span> <span data-start="129.149" data-end="131.79">promise abstraction there are some</span> <span data-start="131.79" data-end="133.41">nuances about it and</span> <span data-start="133.41" data-end="135.39">how it interacts with node and the event</span> <span data-start="135.39" data-end="137.52">loop and things like next tick and</span> <span data-start="137.52" data-end="139.71">timers and you know all these you know</span> <span data-start="139.71" data-end="142.2">different things that can really trip</span> <span data-start="142.2" data-end="144.9">some folks up so I'm here to talk a</span> <span data-start="144.9" data-end="146.49">little bit about you know how all this</span> <span data-start="146.49" data-end="148.98">stuff comes together so a lot of people</span> <span data-start="148.98" data-end="152.22">see node kinda like this some people</span> <span data-start="152.22" data-end="156.36">think it's a toy right I can just look</span> <span data-start="156.36" data-end="159.45">at this for four hours I have like three</span> <span data-start="159.45" data-end="162.81">of these at home you know but you know</span> <span data-start="162.81" data-end="164.04">it's like you look at it it's like okay</span> <span data-start="164.04" data-end="165.6">what's happening inside I'm flipping a</span> <span data-start="165.6" data-end="167.46">switch something's happening but I don't</span> <span data-start="167.46" data-end="169.17">quite know what's there so we're gonna</span> <span data-start="169.17" data-end="171.51">my talk about how we can peer in what's</span> <span data-start="171.51" data-end="173.22">going on and I'm going to talk about how</span> <span data-start="173.22" data-end="175.71">note itself functions under the covers</span> <span data-start="175.71" data-end="177.78">with regards to the event loop so what's</span> <span data-start="177.78" data-end="179.82">happening inside this may be a little</span> <span data-start="179.82" data-end="184.62">bit hard to read but this code prints a</span> <span data-start="184.62" data-end="189.69">series of console statements to the</span> <span data-start="189.69" data-end="192.57">console right your challenge is to</span> <span data-start="192.57" data-end="195.09">figure out without running the code</span> <span data-start="195.09" data-end="197.79">right now have a link where you can go</span> <span data-start="197.79" data-end="200.34">out and running it try to figure out the</span> <span data-start="200.34" data-end="202.53">order in which these statements are</span> <span data-start="202.53" data-end="206.49">printed there are a couple promises in</span> <span data-start="206.49" data-end="208.83">here there is a set immediate there's a</span> <span data-start="208.83" data-end="211.38">next tick this new thing called cue</span> <span data-start="211.38" data-end="212.67">micro test because we didn't have things</span> <span data-start="212.67" data-end="216.75">confusing enough set timeouts does it</span> <span data-start="216.75" data-end="218.82">promise all it's a lot going on in this</span> <span data-start="218.82" data-end="221.52">thing so it can be rather difficult to</span> <span data-start="221.52" data-end="224.82">see what is happening these are pretty</span> <span data-start="224.82" data-end="226.56">much all the ways of scheduling a</span> <span data-start="226.56" data-end="229.44">synchronous activity within node right</span> <span data-start="229.44" data-end="231.6">so we have promise we have event emitter</span> <span data-start="231.6" data-end="233.22">many meters been in there from you know</span> <span data-start="233.22" data-end="235.77">almost the beginning async/await which</span> <span data-start="235.77" data-end="238.35">is absolutely love next tick and set</span> <span data-start="238.35" data-end="241.29">immediate which you know they actually</span> <span data-start="241.29" data-end="242.72">should have been reversed in the names</span> <span data-start="242.72" data-end="244.98">the one missing from here is like set</span> <span data-start="244.98" data-end="247.739">interval and cue micro tasks is this one</span> <span data-start="247.739" data-end="252.06">we just added a couple of weeks ago it</span> <span data-start="252.06" data-end="254.91">is similar to promises among you know</span> <span data-start="254.91" data-end="257.609">when you do a problem of promise then</span> <span data-start="257.609" data-end="259.799">right it does the same kind of task</span> <span data-start="259.799" data-end="262.68">where you can kind of manually add a and</span> <span data-start="262.68" data-end="265.47">an item there that only works right now</span> <span data-start="265.47" data-end="269.37">in node in master right so if you're</span> <span data-start="269.37" data-end="273.48">building from the master or node 11 so</span> <span data-start="273.48" data-end="275.52">if you you know if you try out this code</span> <span data-start="275.52" data-end="277.89">in no date or no ten you just have two</span> <span data-start="277.89" data-end="279.66">comments out that Q micro test line</span> <span data-start="279.66" data-end="282.48">they're right in the middle but like I</span> <span data-start="282.48" data-end="285">said you challenge you just you can grow</span> <span data-start="285" data-end="286.62">it and grab this if you want to write</span> <span data-start="286.62" data-end="288.51">that down so I look at the code see if</span> <span data-start="288.51" data-end="291.6">we can figure it out if any of you</span> <span data-start="291.6" data-end="292.89">figure out the order</span> <span data-start="292.89" data-end="295.14">you know without actually running the</span> <span data-start="295.14" data-end="297.81">codes let me know because I only know of</span> <span data-start="297.81" data-end="299.76">a couple of people within note and</span> <span data-start="299.76" data-end="301.29">within another project itself they could</span> <span data-start="301.29" data-end="305.28">figure it out on the first try huh but</span> <span data-start="305.28" data-end="307.11">in order to figure out that you know to</span> <span data-start="307.11" data-end="308.73">see what this code is doing in order to</span> <span data-start="308.73" data-end="309.87">be able to reason about it there are</span> <span data-start="309.87" data-end="312.47">four critical concepts we need to know</span> <span data-start="312.47" data-end="315.9">the first one is the event loop what it</span> <span data-start="315.9" data-end="318.02">is basically how it works</span> <span data-start="318.02" data-end="322.05">the next one is the next tick Q alright</span> <span data-start="322.05" data-end="324.3">this is the thing that the process next</span> <span data-start="324.3" data-end="327.36">ticket function interacts with the third</span> <span data-start="327.36" data-end="330.15">one is two micro tasks you alright this</span> <span data-start="330.15" data-end="332.43">is the thing that promises interact with</span> <span data-start="332.43" data-end="336.3">and the fourth is this concept there's</span> <span data-start="336.3" data-end="338.57">no such thing as asynchronous JavaScript</span> <span data-start="338.57" data-end="342.21">it does not exist all right you can</span> <span data-start="342.21" data-end="344.82">schedule the execution of eight of</span> </p>
<p><span data-start="344.82" data-end="347.43">JavaScript asynchronously but you cannot</span> <span data-start="347.43" data-end="350.31">run JavaScript asynchronously all right</span> <span data-start="350.31" data-end="353.22">very very important concept when it</span> <span data-start="353.22" data-end="354.48">comes to understanding what's happening</span> <span data-start="354.48" data-end="358.37">within a node process and how that is</span> <span data-start="358.37" data-end="361.74">performing so this might be a picture</span> <span data-start="361.74" data-end="363.45">you've seen before it's a very abstract</span> <span data-start="363.45" data-end="366.66">view of the event loop all right it's</span> <span data-start="366.66" data-end="368.58">this thing you know it turns around and</span> <span data-start="368.58" data-end="370.83">around and does stuff right but what</span> <span data-start="370.83" data-end="374.31">exactly is it doing this is you know</span> <span data-start="374.31" data-end="377.37">this is a better view in my opinion what</span> <span data-start="377.37" data-end="379.29">the event loop does is essentially</span> <span data-start="379.29" data-end="381.9">delivering messages right so you can</span> <span data-start="381.9" data-end="383.88">imagine you know I'm a letter carrier</span> <span data-start="383.88" data-end="386.22">right and I have a stack of letters</span> <span data-start="386.22" data-end="388.23">right but I need to deliver so I have</span> <span data-start="388.23" data-end="390.12">one right now I'm gonna give it to</span> <span data-start="390.12" data-end="393.27">somebody and I can't just go and to the</span> <span data-start="393.27" data-end="395.669">next person in Port handing letters out</span> <span data-start="395.669" data-end="397.26">what I have to do is when I give it to</span> <span data-start="397.26" data-end="398.83">somebody I</span> <span data-start="398.83" data-end="401.41">to wait until they do whatever they're</span> <span data-start="401.41" data-end="404.02">gonna do with it right they read it they</span> <span data-start="404.02" data-end="406.18">figure out you know what what response</span> <span data-start="406.18" data-end="407.5">they're gonna give they write out a</span> <span data-start="407.5" data-end="409.57">response right and then and then they</span> <span data-start="409.57" data-end="411.43">tell me that they're done okay</span> <span data-start="411.43" data-end="414.19">so then I go to the next person and I</span> <span data-start="414.19" data-end="415.66">can hand them their letter and then I</span> <span data-start="415.66" data-end="417.82">have to wait all right and then I go to</span> <span data-start="417.82" data-end="420.12">the next person and hand them theirs</span> <span data-start="420.12" data-end="423.82">that is what the event loop does it</span> <span data-start="423.82" data-end="426.85">takes a queue of messages so cute you</span> <span data-start="426.85" data-end="429.85">know we're callbacks right events that</span> <span data-start="429.85" data-end="432.13">have occurred and it goes through and</span> <span data-start="432.13" data-end="434.92">hands those off to JavaScript functions</span> <span data-start="434.92" data-end="437.98">to execute all right it can only do one</span> <span data-start="437.98" data-end="439.42">of these at a time</span> <span data-start="439.42" data-end="443.38">all right one of the really important</span> <span data-start="443.38" data-end="448.17">concepts to understand is that in node</span> <span data-start="448.17" data-end="451.66">you have a call stack so you have the</span> <span data-start="451.66" data-end="455.26">event loop running down here you have</span> <span data-start="455.26" data-end="457.96">some C++ code and then you have some</span> </p>
<p><span data-start="457.96" data-end="460.87">JavaScript code all right every time the</span> <span data-start="460.87" data-end="462.88">event loop gets a notification it's</span> <span data-start="462.88" data-end="465.07">gonna call through C++ up to the</span> <span data-start="465.07" data-end="468.28">JavaScript all right and then when that</span> <span data-start="468.28" data-end="470.77">JavaScript returns back all the way down</span> <span data-start="470.77" data-end="472.78">to the event loop you can move on to the</span> <span data-start="472.78" data-end="474.79">next task and run the next stack of</span> <span data-start="474.79" data-end="478.21">JavaScript code okay now this is</span> <span data-start="478.21" data-end="479.92">critically important because over here</span> <span data-start="479.92" data-end="482.65">on the side are these two little things</span> <span data-start="482.65" data-end="486.64">here one is the next tick queue and the</span> <span data-start="486.64" data-end="490.78">other is the micro task you when code is</span> <span data-start="490.78" data-end="492.73">running in JavaScript and you call</span> <span data-start="492.73" data-end="495.19">process next tick it's just going to</span> <span data-start="495.19" data-end="497.59">drop a function into that X to Q and</span> <span data-start="497.59" data-end="500.11">leave it there when you schedule a</span> <span data-start="500.11" data-end="501.46">problem when you call a promise and</span> <span data-start="501.46" data-end="504.88">interview in resolves to the dot dot Ben</span> <span data-start="504.88" data-end="507.91">or dot catch or dot finally what's gonna</span> <span data-start="507.91" data-end="509.77">happen is that function handler is gonna</span> <span data-start="509.77" data-end="511.48">be dropped into micro test queue and</span> <span data-start="511.48" data-end="514.24">it's lefted there okay it's not until</span> <span data-start="514.24" data-end="516.49">the threat of execution we you know that</span> <span data-start="516.49" data-end="518.56">stack unwinds back to that javascript</span> <span data-start="518.56" data-end="521.59">c++ layer that that next to queue and</span> <span data-start="521.59" data-end="524.44">the micro task queue is drained so all</span> <span data-start="524.44" data-end="526.39">of those functions will not be called</span> <span data-start="526.39" data-end="529.57">until control returns back to the c++</span> <span data-start="529.57" data-end="531.13">layer</span> <span data-start="531.13" data-end="534.269">you know from that from that call okay</span> <span data-start="534.269" data-end="537.91">so we can only execute one task at a</span> <span data-start="537.91" data-end="539.529">time all of these tab</span> <span data-start="539.529" data-end="540.79">you know these asynchronous tasks that</span> <span data-start="540.79" data-end="542.32">are scheduled getting an end up getting</span> <span data-start="542.32" data-end="545.29">queued in the micro task queue or the or</span> <span data-start="545.29" data-end="546.97">the next tick queue unless they're a</span> <span data-start="546.97" data-end="548.74">timer which works entirely different</span> <span data-start="548.74" data-end="552.759">timer will run on the event loop either</span> <span data-start="552.759" data-end="555.04">on the next turn or some you know set of</span> <span data-start="555.04" data-end="556.48">milliseconds or seconds Africa okay you</span> <span data-start="556.48" data-end="560.23">know as the event loop turns but still</span> <span data-start="560.23" data-end="561.91">if you're going through and doing all</span> <span data-start="561.91" data-end="563.44">the scheduling it still only runs one</span> <span data-start="563.44" data-end="564.48">thing at a time</span> <span data-start="564.48" data-end="566.889">so when javascript is running the event</span> <span data-start="566.889" data-end="569.949">loop is not the event loop past the</span> <span data-start="569.949" data-end="572.56">pause whenever you are whatever it's</span> <span data-start="572.56" data-end="573.79">executing this code which means you</span> <span data-start="573.79" data-end="576.88">can't collect i/o events no network</span> <span data-start="576.88" data-end="578.889">traffic is being okay no network</span> <span data-start="578.889" data-end="581.23">connections are being are being</span> <span data-start="581.23" data-end="581.829">processed</span> <span data-start="581.829" data-end="586">it's just executing that code we call</span> <span data-start="586" data-end="587.769">this event loop delay and it's the</span> <span data-start="587.769" data-end="589.959">single most important concept for node</span> <span data-start="589.959" data-end="591.97">performance all right this is the thing</span> <span data-start="591.97" data-end="593.98">that will kill your note note</span> <span data-start="593.98" data-end="597.43">applications from from running so this</span> <span data-start="597.43" data-end="599.62">is an example you know whenever you're</span> <span data-start="599.62" data-end="601.449">doing any kind of large synchronous</span> <span data-start="601.449" data-end="604.029">activity right you're just killing</span> <span data-start="604.029" data-end="605.56">everything you're killing performance</span> <span data-start="605.56" data-end="607.99">they're not letting no do it do what it</span> <span data-start="607.99" data-end="611.319">does which is a synchronous i/o okay so</span> <span data-start="611.319" data-end="614.68">again javascript is not synchronous but</span> <span data-start="614.68" data-end="615.459">here's a trick question</span> <span data-start="615.459" data-end="617.41">had to leave it'll you know a trick</span> <span data-start="617.41" data-end="619.3">question because the answer should be</span> <span data-start="619.3" data-end="621.819">obvious it's very the fact that I'm</span> <span data-start="621.819" data-end="624.13">asking it the answer is no not all</span> <span data-start="624.13" data-end="626.35">javascript in note runs within the event</span> <span data-start="626.35" data-end="628.18">loop and this comes is a big surprise</span> <span data-start="628.18" data-end="630.79">for a lot of people now here's another</span> <span data-start="630.79" data-end="632.709">question does it all run within the same</span> <span data-start="632.709" data-end="636.22">event loop as of no ten no it does not</span> <span data-start="636.22" data-end="638.98">we now have proper worker threads every</span> <span data-start="638.98" data-end="640.81">worker thread has its own event loop and</span> <span data-start="640.81" data-end="642.579">node instance running this is all</span> <span data-start="642.579" data-end="644.649">running within a single process I'm not</span> <span data-start="644.649" data-end="645.97">gonna get into that now but it makes</span> <span data-start="645.97" data-end="647.38">things significantly more complicated</span> <span data-start="647.38" data-end="651.069">but a hell of a lot more fun so this is</span> <span data-start="651.069" data-end="652.99">gonna be a blast working with with this</span> <span data-start="652.99" data-end="654.399">hopefully workers will come out of</span> <span data-start="654.399" data-end="655.839">experimental by no.12</span> <span data-start="655.839" data-end="661.75">and you know yeah I can't wait but there</span> <span data-start="661.75" data-end="664.27">are three main phases two nodes startup</span> <span data-start="664.27" data-end="667.24">there's the bootstrap there's main and</span> <span data-start="667.24" data-end="669.01">event loop you know folks have some</span> <span data-start="669.01" data-end="672.64">different names for these things what</span> <span data-start="672.64" data-end="674.74">happens during boot strap is nodes</span> <span data-start="674.74" data-end="678.459">loading its own JavaScript right who's</span> <span data-start="678.459" data-end="682.27">doing serverless stuff all right all</span> <span data-start="682.27" data-end="683.8">right who have had problems with cold</span> <span data-start="683.8" data-end="685.02">start times</span> <span data-start="685.02" data-end="687.76">that's because node is damn slow loading</span> <span data-start="687.76" data-end="689.86">itself it has a whole bunch of</span> </p>
<p><span data-start="689.86" data-end="692.17">JavaScript that it needs to load and</span> <span data-start="692.17" data-end="693.91">then it needs to load the user code on</span> <span data-start="693.91" data-end="695.89">top of that right which is which happens</span> <span data-start="695.89" data-end="698.74">during main during this time it's</span> <span data-start="698.74" data-end="701.02">loading it off it's compar Singh the the</span> <span data-start="701.02" data-end="702.97">JavaScript it's compiling it and then</span> <span data-start="702.97" data-end="705.279">executing it and there's a lot of boot</span> <span data-start="705.279" data-end="707.529">up that needs to happen within node</span> <span data-start="707.529" data-end="709.99">itself to to make sure that it's that</span> <span data-start="709.99" data-end="712.87">it's able to run the event loop has</span> <span data-start="712.87" data-end="715.45">started after main scope exits all right</span> <span data-start="715.45" data-end="717.67">and only if asynchronous tasks were</span> <span data-start="717.67" data-end="720.55">scheduled so this is an example so we</span> <span data-start="720.55" data-end="724.63">have this bootstrap by JS file excuse me</span> <span data-start="724.63" data-end="727.72">and one of the statements here is this</span> <span data-start="727.72" data-end="730.18">console log right we have the</span> <span data-start="730.18" data-end="732.52">performance API this no timing object</span> <span data-start="732.52" data-end="734.26">gives you some timestamp of when things</span> <span data-start="734.26" data-end="737.709">within node kicked off or when they when</span> <span data-start="737.709" data-end="739.18">they completed this loop start tells you</span> <span data-start="739.18" data-end="741.37">when the event loops was actually</span> <span data-start="741.37" data-end="744.459">started after that yeah after your code</span> <span data-start="744.459" data-end="746.62">it started running so in bootstrap Jas</span> <span data-start="746.62" data-end="748.81">here this first console log statement</span> <span data-start="748.81" data-end="750.579">loop start is gonna be minus one which</span> <span data-start="750.579" data-end="752.32">indicates that the loop has not actually</span> <span data-start="752.32" data-end="754.69">started you schedule some asynchronous</span> <span data-start="754.69" data-end="756.55">activities set immediate when that runs</span> <span data-start="756.55" data-end="758.829">you check loop start again and you'll</span> <span data-start="758.829" data-end="761.47">see an actual timestamp there so this</span> <span data-start="761.47" data-end="763.899">initial code this top scope right</span> <span data-start="763.899" data-end="765.76">top-level scope this is running within</span> <span data-start="765.76" data-end="767.26">that main scope right</span> <span data-start="767.26" data-end="769.42">at this point the event loop is not</span> <span data-start="769.42" data-end="772.959">running why is this important in this</span> <span data-start="772.959" data-end="775.06">code if you want to start reasoning</span> <span data-start="775.06" data-end="777.279">about what this is doing and the order</span> <span data-start="777.279" data-end="779.589">of execution you have to start thinking</span> <span data-start="779.589" data-end="781.3">about what is running within the event</span> <span data-start="781.3" data-end="783.16">loop and what is not running within the</span> <span data-start="783.16" data-end="784.51">event loop you also have to start</span> <span data-start="784.51" data-end="786.1">thinking about what is running within</span> <span data-start="786.1" data-end="788.05">the the micro task queue what is running</span> <span data-start="788.05" data-end="789.91">within the process next to what is a</span> <span data-start="789.91" data-end="792.31">timer and how all of these things and</span> <span data-start="792.31" data-end="793.3">relates from one another</span> <span data-start="793.3" data-end="797.24">it is extremely complicated to visual</span> <span data-start="797.24" data-end="798.89">even conceptually how these things</span> <span data-start="798.89" data-end="800.21">interact with one another</span> <span data-start="800.21" data-end="802.13">we've fortunately we built some tools to</span> <span data-start="802.13" data-end="804.28">figure that to start to visualize this</span> <span data-start="804.28" data-end="806.9">so the first rule of nodejs performance</span> <span data-start="806.9" data-end="809.3">know when your code is running know ya</span> <span data-start="809.3" data-end="813.68">know each individual function so the</span> <span data-start="813.68" data-end="815.33">first tool that we've that we have</span> <span data-start="815.33" data-end="818.9">within those are trace events trace</span> <span data-start="818.9" data-end="822.2">events are a file format that that came</span> <span data-start="822.2" data-end="826.13">out of v8 and chrome it's a right now</span> <span data-start="826.13" data-end="828.29">it's a JSON format that gets outputted</span> <span data-start="828.29" data-end="831.86">by the engine and by node whenever</span> <span data-start="831.86" data-end="834.02">significant events happen with the core</span> <span data-start="834.02" data-end="835.42">we have to go through and actually</span> <span data-start="835.42" data-end="838.01">implement the code to emit these we are</span> <span data-start="838.01" data-end="841.13">in the process now of expanding the type</span> <span data-start="841.13" data-end="843.29">of information that can come out of node</span> <span data-start="843.29" data-end="846.08">through trace events one of the key bits</span> <span data-start="846.08" data-end="847.82">of information we can get right now is</span> <span data-start="847.82" data-end="850.31">what a synchronous activity is happening</span> <span data-start="850.31" data-end="852.71">over the lifetime of that of that</span> <span data-start="852.71" data-end="855.62">application we can use this I will show</span> <span data-start="855.62" data-end="857.42">in just a minute to visualize the</span> <span data-start="857.42" data-end="859.01">activity happening within that</span> <span data-start="859.01" data-end="862.76">application the next important tool is</span> <span data-start="862.76" data-end="864.77">async Kooks this is the low-level API</span> <span data-start="864.77" data-end="867.53">which is what we use to actually emit</span> <span data-start="867.53" data-end="870.23">the trace events to see what is</span> <span data-start="870.23" data-end="871.88">happening so whenever a new object is</span> <span data-start="871.88" data-end="874.97">created whenever a callback is invoked</span> <span data-start="874.97" data-end="879.35">the async hooks API is called this third</span> <span data-start="879.35" data-end="881.45">one it's not actually in core it's</span> <span data-start="881.45" data-end="883.52">another tool it's a it's an external</span> <span data-start="883.52" data-end="885.11">tool they by team in uniform and near</span> <span data-start="885.11" data-end="886.48">foreign-built it's all open source</span> <span data-start="886.48" data-end="889.49">called bubble bubble bubble problem</span> <span data-start="889.49" data-end="892.82">profiling I'll show you how this works</span> <span data-start="892.82" data-end="894.5">and how it relates to all this but it's</span> <span data-start="894.5" data-end="897.62">built on top of of trace events so the</span> <span data-start="897.62" data-end="899.3">first thing I pick until we have is</span> <span data-start="899.3" data-end="901.64">built into chrome itself this is the</span> <span data-start="901.64" data-end="904.28">chrome trace viewer it's a very</span> <span data-start="904.28" data-end="907.82">unassuming simple UI may be a little bit</span> <span data-start="907.82" data-end="909.83">hard to read because of the colors that</span> <span data-start="909.83" data-end="913.58">are there but it can read this JSON file</span> <span data-start="913.58" data-end="916.94">that is emitted by the node process and</span> <span data-start="916.94" data-end="919.49">by v8 and depending on what categories</span> <span data-start="919.49" data-end="922.04">of trace events you've you've asked it</span> <span data-start="922.04" data-end="924.2">to emit you pull this in and it gives</span> <span data-start="924.2" data-end="927.14">you a timeline of when those things were</span> <span data-start="927.14" data-end="928.52">occurring so this is looking at that</span> <span data-start="928.52" data-end="929.31">timing file</span> <span data-start="929.31" data-end="931.199">and we see that there was an immediate</span> <span data-start="931.199" data-end="933.24">scheduled right that was the said</span> <span data-start="933.24" data-end="935.519">immediate that we had and that is a</span> <span data-start="935.519" data-end="937.47">persistent object to exist over time</span> <span data-start="937.47" data-end="940.86">right and then at some point that gets</span> <span data-start="940.86" data-end="943.05">executed we have two of those that are</span> <span data-start="943.05" data-end="944.79">happening here we have multiple promises</span> <span data-start="944.79" data-end="946.74">and this will show you the entire</span> <span data-start="946.74" data-end="950.97">lifecycle of these of these things we</span> <span data-start="950.97" data-end="952.769">have within nodes these things called</span> <span data-start="952.769" data-end="954.66">tick objects those are the next tick</span> <span data-start="954.66" data-end="957.139">things that are scheduled on that queue</span> <span data-start="957.139" data-end="960.36">we can also see when v8 was actually</span> <span data-start="960.36" data-end="963.329">executing code and the interesting thing</span> <span data-start="963.329" data-end="965.519">about this is we can actually if we</span> <span data-start="965.519" data-end="969.48">drill in and see zoom in on this you see</span> <span data-start="969.48" data-end="971.459">it actually gets fairly complicated we</span> <span data-start="971.459" data-end="973.439">can see the exact transition points when</span> <span data-start="973.439" data-end="975.72">v8 to go you know when v8 is done</span> <span data-start="975.72" data-end="978.329">executing the JavaScript code and when</span> <span data-start="978.329" data-end="980.759">control returns back to that c++ layer</span> <span data-start="980.759" data-end="982.62">and things like the next tick queue and</span> <span data-start="982.62" data-end="985.529">the micro task queue get executed this</span> <span data-start="985.529" data-end="987.809">is extremely helpful if you know what a</span> <span data-start="987.809" data-end="989.79">synchronous activity your application is</span> <span data-start="989.79" data-end="991.35">scheduling for you to know what the</span> <span data-start="991.35" data-end="993.449">actual performance impact of that code</span> <span data-start="993.449" data-end="996.12">is you can see those transition points</span> <span data-start="996.12" data-end="998.639">you can see when this you know this big</span> <span data-start="998.639" data-end="1000.68">json.parse thing you might have in there</span> <span data-start="1000.68" data-end="1002.87">you know how long how much time that's</span> <span data-start="1002.87" data-end="1004.309">taking up and what else</span> <span data-start="1004.309" data-end="1006.17">it is delaying now it takes a bit of</span> <span data-start="1006.17" data-end="1008.18">practice to figure out what you know</span> <span data-start="1008.18" data-end="1010.339">what's going on in here and it's not the</span> <span data-start="1010.339" data-end="1014.029">best use of our interface it is evolving</span> <span data-start="1014.029" data-end="1016.399">over time but it's extremely useful to</span> <span data-start="1016.399" data-end="1019.759">see see these transition points all</span> <span data-start="1019.759" data-end="1023.54">right so let's go back here bootstrap</span> <span data-start="1023.54" data-end="1025.459">trace events something we enabled in in</span> <span data-start="1025.459" data-end="1028.49">core if you use this command line you</span> <span data-start="1028.49" data-end="1033.02">can see let's see here you can see</span> <span data-start="1033.02" data-end="1037.13">exactly when node itself executes its</span> <span data-start="1037.13" data-end="1040.49">various bootstrap phases so when it when</span> <span data-start="1040.49" data-end="1042.559">does it start the event loop when is it</span> <span data-start="1042.559" data-end="1044.809">compiling its own code those kind of</span> <span data-start="1044.809" data-end="1046.549">things so we're going to set up some</span> <span data-start="1046.549" data-end="1048.89">categories we're gonna do v8 we're gonna</span> <span data-start="1048.89" data-end="1052.51">go node VM and we're gonna say node</span> <span data-start="1052.51" data-end="1057.71">bootstrap and I mean look at that</span> <span data-start="1057.71" data-end="1062.08">the but I don't want to give away the</span> <span data-start="1062.08" data-end="1066.74">order of it alright so there we have it</span> <span data-start="1066.74" data-end="1070.18">we can come back in here look at our</span> <span data-start="1070.18" data-end="1074.33">node trace file and we can see in here</span> <span data-start="1074.33" data-end="1075.74">there's a bug in Windows it's not</span> <span data-start="1075.74" data-end="1077.06">actually telling me what it should say</span> <span data-start="1077.06" data-end="1079.12">under this context context apply script</span> <span data-start="1079.12" data-end="1081.56">it should tell me the exact file names</span> <span data-start="1081.56" data-end="1084.47">that I was requiring and that's nodes</span> <span data-start="1084.47" data-end="1088.19">own library and your code that's running</span> <span data-start="1088.19" data-end="1089.96">in here it'll tell you when it was</span> <span data-start="1089.96" data-end="1091.67">required it will tell you exactly how</span> <span data-start="1091.67" data-end="1093.08">long it take to load it how long it took</span> <span data-start="1093.08" data-end="1095">to compile it and how long it took to</span> <span data-start="1095" data-end="1097.07">execute it and then show you the exact</span> <span data-start="1097.07" data-end="1099.83">ordering of the loading of your</span> <span data-start="1099.83" data-end="1102.23">dependencies over time and you can you</span> <span data-start="1102.23" data-end="1104">know if you look at that with the async</span> <span data-start="1104" data-end="1106.37">activity information turned on you can</span> <span data-start="1106.37" data-end="1108.98">also see that activity occurring</span> <span data-start="1108.98" data-end="1111.86">relative to turns of the event loop so</span> <span data-start="1111.86" data-end="1113.9">you can see exactly when all of your</span> <span data-start="1113.9" data-end="1116.3">your code is being run and exactly how</span> <span data-start="1116.3" data-end="1120.23">long it's it took dacing traced events</span> <span data-start="1120.23" data-end="1122.81">this is the thing that takes the async</span> <span data-start="1122.81" data-end="1124.67">hooks information and exports it out to</span> <span data-start="1124.67" data-end="1128.18">the to that trace event log and this</span> <span data-start="1128.18" data-end="1130.88">gets quite a bit more complicated so if</span> <span data-start="1130.88" data-end="1134.84">we want to take the same one and we're</span> <span data-start="1134.84" data-end="1138.23">gonna say node base and cooks this is</span> <span data-start="1138.23" data-end="1140.21">this all of this is just built into the</span> <span data-start="1140.21" data-end="1142.37">node binary right now works for 10 and</span> <span data-start="1142.37" data-end="1144.46">11 there's some support in it for 8</span> <span data-start="1144.46" data-end="1147.53">there are some bugs in it so everybody</span> <span data-start="1147.53" data-end="1149.74">should be on 10 anyway so upgrade</span> <span data-start="1149.74" data-end="1152.83">alright so we're gonna run this again</span> <span data-start="1152.83" data-end="1155.9">we're gonna come back here load this</span> <span data-start="1155.9" data-end="1160.97">back up and in here we see there's you</span> <span data-start="1160.97" data-end="1162.11">know quite a bit more detail this is</span> <span data-start="1162.11" data-end="1163.34">where we're seeing all of those promise</span> <span data-start="1163.34" data-end="1165.26">objects the immediate stew timer is the</span> <span data-start="1165.26" data-end="1167.45">next kicks and and we can see the</span> <span data-start="1167.45" data-end="1169.07">execution of these things relative to</span> <span data-start="1169.07" data-end="1170.83">one another</span> <span data-start="1170.83" data-end="1177.59">all right the the Therese Event Viewer</span> <span data-start="1177.59" data-end="1180.53">is good it provides a lot of detail it's</span> <span data-start="1180.53" data-end="1182.33">really hard to process if you have an</span> <span data-start="1182.33" data-end="1185.6">extremely complicated application just</span> <span data-start="1185.6" data-end="1187.1">this last week I was you know at a</span> <span data-start="1187.1" data-end="1189.02">customer we you know in a</span> <span data-start="1189.02" data-end="1191.84">20 and I think was a 20 second benchmark</span> <span data-start="1191.84" data-end="1194.45">of their code we ran through and they</span> <span data-start="1194.45" data-end="1196.31">ended up just in that 20 seconds they</span> <span data-start="1196.31" data-end="1198.14">had created something like 15,000</span> <span data-start="1198.14" data-end="1203.84">promises about 10,000 next ticks and a</span> <span data-start="1203.84" data-end="1205.94">whole bunch else the the the trace event</span> <span data-start="1205.94" data-end="1207.71">file was massive and it just killed</span> <span data-start="1207.71" data-end="1209.96">chrome when I tried to load the you know</span> <span data-start="1209.96" data-end="1214.27">loaded in the viewer it's extremely</span> <span data-start="1214.27" data-end="1216.23">complicated and there's a lot of data</span> <span data-start="1216.23" data-end="1217.73">that's there so we needed a different</span> <span data-start="1217.73" data-end="1220.28">way of viewing it so we created a tool</span> <span data-start="1220.28" data-end="1222.23">called clinic this is all open source</span> <span data-start="1222.23" data-end="1225.61">you can get it from you know yeah NPM</span> <span data-start="1225.61" data-end="1229.4">from clinic use yarn whatever and what</span> <span data-start="1229.4" data-end="1231.35">it is designed to do is help you</span> <span data-start="1231.35" data-end="1232.91">diagnose performance problems within</span> <span data-start="1232.91" data-end="1237.92">your application bubble props is one of</span> <span data-start="1237.92" data-end="1240.19">the tools here and it's very simple</span> <span data-start="1240.19" data-end="1247.19">clinic bubble node again I don't wanna</span> <span data-start="1247.19" data-end="1251.45">give away the result we're gonna let it</span> <span data-start="1251.45" data-end="1252.89">do its thing for a few minutes what it's</span> <span data-start="1252.89" data-end="1254.81">doing right now is it's exporting that</span> <span data-start="1254.81" data-end="1257.03">vet file and then it's going to go</span> <span data-start="1257.03" data-end="1261.65">through and actually analyze the all of</span> <span data-start="1261.65" data-end="1263.6">that async activity and then it's going</span> <span data-start="1263.6" data-end="1266.69">to give you a display of that</span> <span data-start="1266.69" data-end="1269.12">asynchronous activity what this is</span> <span data-start="1269.12" data-end="1271.82">showing you is the aggregate latency</span> <span data-start="1271.82" data-end="1274.55">caused by a synchronous activity within</span> </p>
<p><span data-start="1274.55" data-end="1276.29">Europe and within your application you</span> <span data-start="1276.29" data-end="1277.85">can explore this you can kind of drill</span> <span data-start="1277.85" data-end="1279.56">down into it you can see exactly what</span> <span data-start="1279.56" data-end="1281.45">promise has happened the UI we're still</span> <span data-start="1281.45" data-end="1281.96">working on it</span> <span data-start="1281.96" data-end="1284.39">some application you know some of them</span> <span data-start="1284.39" data-end="1285.68">turn out we have a whole gallery of a</span> <span data-start="1285.68" data-end="1288.8">really crazy artwork from this thing but</span> <span data-start="1288.8" data-end="1290.15">what it's basically showing you is how</span> <span data-start="1290.15" data-end="1292.19">long it took to transition from one</span> <span data-start="1292.19" data-end="1294.14">asynchronous activity within your code</span> <span data-start="1294.14" data-end="1296.09">to another so where's the trace event</span> <span data-start="1296.09" data-end="1298.91">you can see or see it over a time line</span> <span data-start="1298.91" data-end="1300.74">right you can see â€” the transition</span> <span data-start="1300.74" data-end="1302.06">points what this is going to do is</span> <span data-start="1302.06" data-end="1304.88">aggregate those and show you exactly how</span> <span data-start="1304.88" data-end="1306.77">much time in each part of your</span> <span data-start="1306.77" data-end="1310.37">application node was spending and notice</span> <span data-start="1310.37" data-end="1312.5">doing work right or how much time it was</span> <span data-start="1312.5" data-end="1314.68">spending waiting for work to be done</span> <span data-start="1314.68" data-end="1319.49">okay so let me show you let me ask you</span> <span data-start="1319.49" data-end="1322.419">this one I promise is asynchronous</span> <span data-start="1322.419" data-end="1325.61">it is a trick question do promises</span> <span data-start="1325.61" data-end="1328.82">execute concurrently there's a lot of</span> <span data-start="1328.82" data-end="1330.26">confusion about this I had an argument</span> <span data-start="1330.26" data-end="1332.21">with a guy a couple months ago who is</span> <span data-start="1332.21" data-end="1334.64">just absolutely adamant that promise all</span> <span data-start="1334.64" data-end="1336.82">executed everything concurrently the</span> <span data-start="1336.82" data-end="1340.13">challenge is a does it all right when</span> <span data-start="1340.13" data-end="1342.11">you have an async function right and</span> <span data-start="1342.11" data-end="1344.54">that async function wraps purely</span> <span data-start="1344.54" data-end="1348.77">synchronous code right then it's then</span> <span data-start="1348.77" data-end="1350.75">it's just gonna execute synchronously so</span> <span data-start="1350.75" data-end="1353.15">when you have this promise that all food</span> <span data-start="1353.15" data-end="1355.19">and bar who's gonna run completely bars</span> <span data-start="1355.19" data-end="1356.96">gonna run completely after it all right</span> <span data-start="1356.96" data-end="1360.2">what about promise race same thing races</span> <span data-start="1360.2" data-end="1361.7">that race says whichever one finishes</span> <span data-start="1361.7" data-end="1364.82">first give me that right well if if the</span> <span data-start="1364.82" data-end="1367.19">async functions here are all purely</span> <span data-start="1367.19" data-end="1369.2">synchronous you're gonna have the exact</span> <span data-start="1369.2" data-end="1371.69">same effect foo which is a much longer</span> <span data-start="1371.69" data-end="1372.799">loop it's gonna block the event loop</span> <span data-start="1372.799" data-end="1375.049">that's gonna finish first and so in this</span> <span data-start="1375.049" data-end="1376.61">particular case race is not doing you</span> <span data-start="1376.61" data-end="1379.4">any good now if those functions actually</span> <span data-start="1379.4" data-end="1381.41">have a synchronous activity like this a</span> <span data-start="1381.41" data-end="1384.02">wait time out then yes bar will finish</span> <span data-start="1384.02" data-end="1386.75">first and you know in the promise race</span> <span data-start="1386.75" data-end="1390.32">will do what you expect it to do all</span> <span data-start="1390.32" data-end="1392.21">right running out of time some to skip</span> <span data-start="1392.21" data-end="1393.47">ahead I want to show you this example</span> <span data-start="1393.47" data-end="1394.7">we're a quick so this is a real-world</span> <span data-start="1394.7" data-end="1396.74">example from an application we profile</span> <span data-start="1396.74" data-end="1398.66">just about a week ago all right using</span> <span data-start="1398.66" data-end="1403.299">bubble cross this is the high level</span> <span data-start="1403.299" data-end="1405.08">asynchronous activity happening in this</span> <span data-start="1405.08" data-end="1407.78">application it's a mess because this was</span> <span data-start="1407.78" data-end="1411.2">very poorly written code and we can</span> <span data-start="1411.2" data-end="1413.87">drill down in here and we can see now</span> <span data-start="1413.87" data-end="1419.33">yep there's more activity here let's see</span> <span data-start="1419.33" data-end="1421.97">we can find there's some promise changed</span> <span data-start="1421.97" data-end="1426.049">in here like deep promise chains this</span> <span data-start="1426.049" data-end="1427.73">this is the code that was creating about</span> <span data-start="1427.73" data-end="1432.049">ten thousand promises within a twenty</span> <span data-start="1432.049" data-end="1433.79">second run this is the one I was looking</span> <span data-start="1433.79" data-end="1437.03">for this is extremely poorly written</span> <span data-start="1437.03" data-end="1439.13">scheduling code all this is doing is</span> <span data-start="1439.13" data-end="1441.26">scheduling that this was about a</span> <span data-start="1441.26" data-end="1443.98">thousand promises in a single</span> <span data-start="1443.98" data-end="1446.33">synchronous loop and then they weren't</span> <span data-start="1446.33" data-end="1448.01">allowed to execute and then as soon as</span> <span data-start="1448.01" data-end="1450.799">the the control returned all that</span> <span data-start="1450.799" data-end="1452.75">executed all at once you know one after</span> <span data-start="1452.75" data-end="1454.85">the other and then each of those were</span> <span data-start="1454.85" data-end="1456.8">also scheduling promises I could drill</span> <span data-start="1456.8" data-end="1460.55">down here many more levels I'm have time</span> <span data-start="1460.55" data-end="1464.45">to do that but the point is you know in</span> <span data-start="1464.45" data-end="1465.71">order to be able to visualize and reason</span> <span data-start="1465.71" data-end="1466.94">about this stuff I mean you know the</span> <span data-start="1466.94" data-end="1468.56">whole reason this is such a mess is the</span> <span data-start="1468.56" data-end="1471.32">team forgot to think about when their</span> <span data-start="1471.32" data-end="1473.99">code is being executed they were</span> <span data-start="1473.99" data-end="1476.54">wrapping synchronous code with promises</span> <span data-start="1476.54" data-end="1478.61">thinking that that you know by</span> <span data-start="1478.61" data-end="1480.02">sprinkling a little you know promise</span> <span data-start="1480.02" data-end="1481.07">magic everything was going to be</span> <span data-start="1481.07" data-end="1483.02">asynchronous or they're using it for</span> <span data-start="1483.02" data-end="1485.03">convenience right you know hey if we're</span> <span data-start="1485.03" data-end="1486.44">using promises one place we have to use</span> <span data-start="1486.44" data-end="1488.99">promises everywhere that is a</span> <span data-start="1488.99" data-end="1490.88">misconception about promises and if you</span> <span data-start="1490.88" data-end="1494.03">continually abuse promises that way then</span> <span data-start="1494.03" data-end="1495.71">your code is just gonna get slower and</span> <span data-start="1495.71" data-end="1498.74">slower and slower because of the</span> <span data-start="1498.74" data-end="1501.26">additional allocations of promise these</span> <span data-start="1501.26" data-end="1503.24">objects and all these async up resources</span> <span data-start="1503.24" data-end="1506.03">and all the scheduling overhead doesn't</span> <span data-start="1506.03" data-end="1507.98">mean that your synchronous code is gonna</span> <span data-start="1507.98" data-end="1513.22">run any faster okay so that's that's it</span> <span data-start="1513.22" data-end="1515.57">because I just wanted to kind of peel</span> <span data-start="1515.57" data-end="1516.71">and I'll peel back the curtain little</span> <span data-start="1516.71" data-end="1518.87">bit how the event loop runs how these</span> <span data-start="1518.87" data-end="1520.55">things work together and some of the</span> <span data-start="1520.55" data-end="1521.87">tools you can use to start visualizing</span> <span data-start="1521.87" data-end="1524.03">this stuff feel free</span> <span data-start="1524.03" data-end="1526.85">reach out set up je a snow anywhere if</span> <span data-start="1526.85" data-end="1527.84">you want to talk about some of this</span> <span data-start="1527.84" data-end="1530.81">stuff need some more pointers on kind of</span> <span data-start="1530.81" data-end="1532.58">how these things are going or you know</span> <span data-start="1532.58" data-end="1534.32">how to make your node applications</span> <span data-start="1534.32" data-end="1535.76">faster just reach out and let me know</span> </p>
<p><span data-start="1535.76" data-end="1539.64">Thanks</span> </p>
</section>