<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>yhCA14HB4Tk</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/yhCA14HB4Tk?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="10.91" data-end="13.35">usually I talk about my latest node</span> <span data-start="13.35" data-end="15.15">library and what it does and show it off</span> <span data-start="15.15" data-end="16.68">and do some live coding but today I</span> <span data-start="16.68" data-end="17.34">thought I'd do something a little</span> <span data-start="17.34" data-end="20.25">different a a question that I've seen</span> <span data-start="20.25" data-end="22.2">come up a lot with people who are</span> <span data-start="22.2" data-end="25.8">working with either lots of Io and the</span> <span data-start="25.8" data-end="27.57">browser or on server side JavaScript</span> <span data-start="27.57" data-end="29.91">wears lots of I oh is that all these</span> <span data-start="29.91" data-end="32.55">callbacks really get tangled it gets</span> <span data-start="32.55" data-end="35.67">hard to do so I talk is techniques and</span> <span data-start="35.67" data-end="36.989">tools for taming tangled twist it turns</span> <span data-start="36.989" data-end="42.809">up top and yeah so so just a quick recap</span> <span data-start="42.809" data-end="44.039">I'm sure most of you notice what makes</span> <span data-start="44.039" data-end="46.32">note fast I i work on node a lot so</span> <span data-start="46.32" data-end="47.789">that's most of the JavaScript I deal</span> <span data-start="47.789" data-end="48.96">with but this applies to other things</span> <span data-start="48.96" data-end="53.699">too so so node never blocks on Io it's</span> <span data-start="53.699" data-end="55.109">all it's all non block and it's all</span> <span data-start="55.109" data-end="56.579">callback base which means you don't eat</span> <span data-start="56.579" data-end="58.739">threads which is awesome because if</span> <span data-start="58.739" data-end="60.179">you've done systems programming threads</span> <span data-start="60.179" data-end="62.67">are not free they're expensive but this</span> <span data-start="62.67" data-end="64.019">also means that you have to handle the</span> <span data-start="64.019" data-end="66.83">scheduling explicitly through callbacks</span> <span data-start="66.83" data-end="69.24">with threading the OS does it for you</span> <span data-start="69.24" data-end="71.88">you can just say I want to read the file</span> <span data-start="71.88" data-end="75.27">system and no one s done do this and the</span> </p>
<p><span data-start="75.27" data-end="77.31">OS handle Zelda for you all the</span> <span data-start="77.31" data-end="81.93">concurrency not so much in JavaScript so</span> <span data-start="81.93" data-end="84.899">here's just a quick example and this</span> <span data-start="84.899" data-end="86.909">isn't even the best Ruby but the point</span> <span data-start="86.909" data-end="90.479">is we have this final new thing that</span> <span data-start="90.479" data-end="92.67">opens a file that next line will not</span> <span data-start="92.67" data-end="94.82">execute until that file has been opened</span> <span data-start="94.82" data-end="97.92">nothing happens and this line equals</span> <span data-start="97.92" data-end="100.77">file gets that will block until it</span> <span data-start="100.77" data-end="102.149">actually reads the data from the disk</span> <span data-start="102.149" data-end="104.67">which could take a lot of CPU cycles and</span> <span data-start="104.67" data-end="107.28">in the next slide happens and then you</span> <span data-start="107.28" data-end="108.42">can file close here at the bottom</span> <span data-start="108.42" data-end="110.159">because you won't get there till you're</span> <span data-start="110.159" data-end="113.49">done really simple code right because</span> <span data-start="113.49" data-end="115.02">the OS is doing all the juggling for you</span> <span data-start="115.02" data-end="119.399">with threads well here's one way to do</span> <span data-start="119.399" data-end="123">this a note so we got we going to open</span> <span data-start="123" data-end="124.439">the file give that a call back when its</span> <span data-start="124.439" data-end="128.49">open and then nodes ap eyes are a little</span> <span data-start="128.49" data-end="130.32">lower level it matches the capi is</span> <span data-start="130.32" data-end="134.01">pretty close so you got to say I want to</span> <span data-start="134.01" data-end="136.32">read some data up to this many chunks</span> <span data-start="136.32" data-end="137.82">put it in this buffer it might actually</span> <span data-start="137.82" data-end="139.62">read that many chunks and so you're</span> <span data-start="139.62" data-end="140.97">going to then check how many chunks for</span> <span data-start="140.97" data-end="141.54">it I mean</span> <span data-start="141.54" data-end="143.37">lights were red and if it's not enough</span> <span data-start="143.37" data-end="144.599">you got to keep reading you go to these</span> <span data-start="144.599" data-end="146.489">recursive loops and it's all a sink and</span> </p>
<p><span data-start="146.489" data-end="148.709">I don't know about you but that's kind</span> <span data-start="148.709" data-end="152.939">of hard to read it first but that that's</span> <span data-start="152.939" data-end="156.93">the trade-off so don't worry it's</span> <span data-start="156.93" data-end="159.06">actually not as bad as it looks if your</span> <span data-start="159.06" data-end="160.95">house has a fire tornado that's pretty</span> <span data-start="160.95" data-end="163.349">bad javascript you're okay so do some</span> <span data-start="163.349" data-end="168.48">tricks to this so I've got six sections</span> <span data-start="168.48" data-end="170.4">they make a cube and all the pieces make</span> <span data-start="170.4" data-end="173.73">this cool awesome train yeah all right</span> <span data-start="173.73" data-end="175.65">this is the tingle twisted train of</span> <span data-start="175.65" data-end="178.68">thought so the first piece of the train</span> <span data-start="178.68" data-end="180.829">is lambda first class functions</span> <span data-start="180.829" data-end="183.269">javascript has first class functions I</span> <span data-start="183.269" data-end="186.48">know this isn't new to most of you but</span> <span data-start="186.48" data-end="188.7">in node we have this interesting merge</span> <span data-start="188.7" data-end="190.409">of communities where you have people</span> <span data-start="190.409" data-end="192.06">coming from the server side that know</span> </p>
<p><span data-start="192.06" data-end="194.669">Ruby and PHP and Python and haven't</span> <span data-start="194.669" data-end="197.129">really dealt with callbacks and then we</span> <span data-start="197.129" data-end="199.019">have the people from the front end who</span> <span data-start="199.019" data-end="202.079">know all about callbacks and Ajax but</span> <span data-start="202.079" data-end="203.76">then hadn't really use JavaScript</span> <span data-start="203.76" data-end="205.709">against file systems where you have lots</span> <span data-start="205.709" data-end="208.53">and lots of i/o and so occasionally</span> <span data-start="208.53" data-end="210.09">people forget that you have all these</span> <span data-start="210.09" data-end="212.459">neat tricks with functions so just a</span> <span data-start="212.459" data-end="215.459">quick review javascript is a very simple</span> <span data-start="215.459" data-end="217.199">business understood language and the</span> <span data-start="217.199" data-end="220.019">secret is the functions a function is an</span> <span data-start="220.019" data-end="221.909">object it can be passed around it has a</span> <span data-start="221.909" data-end="224.28">closure but it's really just something</span> <span data-start="224.28" data-end="226.019">you can pass around it's not tied to an</span> <span data-start="226.019" data-end="228.18">object that's not a proper method like</span> <span data-start="228.18" data-end="229.53">in other languages where it's part of</span> <span data-start="229.53" data-end="232.65">the class it's it's just some executable</span> <span data-start="232.65" data-end="234.919">code that has some special properties so</span> <span data-start="234.919" data-end="237.78">here's just a quick example so I make</span> <span data-start="237.78" data-end="240.629">this object Lane has named laman Elena</span> <span data-start="240.629" data-end="242.819">lambda and then one function description</span> <span data-start="242.819" data-end="245.129">that returns a person named to this name</span> <span data-start="245.129" data-end="247.769">and you execute this you'll get back a</span> <span data-start="247.769" data-end="249.359">person named Lena lambda nothing</span> <span data-start="249.359" data-end="252.479">surprising right so we make another</span> <span data-start="252.479" data-end="254.04">object called Fred and Fred's</span> <span data-start="254.04" data-end="255.629">description is the same function as</span> <span data-start="255.629" data-end="257.37">lanes description but when you read it</span> <span data-start="257.37" data-end="259.37">you get a person named Fred the functor</span> <span data-start="259.37" data-end="261.539">exact same function for rain in a</span> <span data-start="261.539" data-end="267.419">different different scope so we can use</span> <span data-start="267.419" data-end="270.529">colon apply to specify what this is</span> <span data-start="270.529" data-end="273.079">and just call lanes description function</span> <span data-start="273.079" data-end="275.149">with a new object and you'll get back a</span> <span data-start="275.149" data-end="276.829">person named said the zettabyte it's</span> <span data-start="276.829" data-end="280.639">really clear right but here's where it</span> <span data-start="280.639" data-end="281.779">gets people when you start dealing with</span> <span data-start="281.779" data-end="284.269">events and callbacks if I store this</span> <span data-start="284.269" data-end="287.359">lame duck description to a variable put</span> <span data-start="287.359" data-end="289.669">that in some event system and then later</span> <span data-start="289.669" data-end="293.329">call it a person named  but it</span> <span data-start="293.329" data-end="294.739">was lamed that description i passed in</span> <span data-start="294.739" data-end="297.319">so i should have lain as this right no</span> <span data-start="297.319" data-end="299.269">it's not tied to the object it's just a</span> <span data-start="299.269" data-end="301.129">function and when you start doing lots</span> <span data-start="301.129" data-end="303.519">of callbacks this bites a lot of people</span> <span data-start="303.519" data-end="306.319">well this is where closures come in this</span> <span data-start="306.319" data-end="307.999">is a simple factory method that returns</span> <span data-start="307.999" data-end="311.269">a function but since name is from the</span> <span data-start="311.269" data-end="313.369">closure no matter how you call this</span> <span data-start="313.369" data-end="315.049">function it's going to have the right</span> <span data-start="315.049" data-end="317.569">name so this is a really important thing</span> <span data-start="317.569" data-end="318.619">to understand i'm sure most of you</span> <span data-start="318.619" data-end="321.049">notice quite well but that's the first</span> <span data-start="321.049" data-end="322.849">technique to doing lots of asynchronous</span> <span data-start="322.849" data-end="324.679">code is that by sound understanding of</span> <span data-start="324.679" data-end="327.439">how the language works so my next</span> <span data-start="327.439" data-end="330.679">section function composition the first</span> <span data-start="330.679" data-end="333.109">large node project i will wrote was</span> <span data-start="333.109" data-end="336.429">wheat the engine to how to note it's</span> <span data-start="336.429" data-end="339.289">it's a pretty interesting blog engine it</span> <span data-start="339.289" data-end="342.189">sits on top of a rocket repo and</span> <span data-start="342.189" data-end="345.799">basically uses get sub a subshell just</span> <span data-start="345.799" data-end="347.779">use git show and use as good as a</span> <span data-start="347.779" data-end="349.399">database there are no real files</span> <span data-start="349.399" data-end="352.159">anywhere it just uses get show give me</span> <span data-start="352.159" data-end="354.469">this file at this revision and there's</span> <span data-start="354.469" data-end="355.729">some muck down files for articles</span> <span data-start="355.729" data-end="357.589">there's some HTML and it's it's all in</span> <span data-start="357.589" data-end="361.249">get but when I wrote this I started</span> <span data-start="361.249" data-end="365.539">seeing that you got to do these complex</span> <span data-start="365.539" data-end="367.879">things wrap them in simple api's or</span> <span data-start="367.879" data-end="371.749">you'll go insane so node has a single</span> <span data-start="371.749" data-end="373.189">def s read file because it's pretty</span> <span data-start="373.189" data-end="374.989">common use case that you want to read a</span> <span data-start="374.989" data-end="376.699">file when its entirety their small files</span> <span data-start="376.699" data-end="378.049">you don't want to stream it you just say</span> <span data-start="378.049" data-end="380.629">give me the contents of that file so you</span> <span data-start="380.629" data-end="382.549">take all these other async operations</span> <span data-start="382.549" data-end="385.789">and you wrap them in one single API this</span> <span data-start="385.789" data-end="390.529">is a very useful technique so I'm just</span> <span data-start="390.529" data-end="392.059">going to quickly go through one way to</span> <span data-start="392.059" data-end="394.129">implement this so what's going to happen</span> <span data-start="394.129" data-end="396.949">zero f s open which is a non-blocking</span> <span data-start="396.949" data-end="398.629">filesystem thing all the arrows with</span> <span data-start="398.629" data-end="401.129">stars means this call</span> <span data-start="401.129" data-end="402.929">happens via the event loop you don't</span> <span data-start="402.929" data-end="405.3">ever explicitly call this when the file</span> <span data-start="405.3" data-end="407.999">system comes back and it's open it will</span> <span data-start="407.999" data-end="411.089">then call your on open function which</span> <span data-start="411.089" data-end="414.839">then will call get chunk because it</span> <span data-start="414.839" data-end="416.219">wants to start getting some chunks and</span> <span data-start="416.219" data-end="417.839">then that's going to call FS read and</span> <span data-start="417.839" data-end="420.179">then FS rate when it gets a chunk is</span> <span data-start="420.179" data-end="421.649">going to call your on read and that's</span> <span data-start="421.649" data-end="422.789">going to check if there's bites or not</span> <span data-start="422.789" data-end="423.839">it's going to loop through till you've</span> <span data-start="423.839" data-end="427.529">read the whole file so I put the black</span> <span data-start="427.529" data-end="430.259">borders around these functions that I'm</span> <span data-start="430.259" data-end="431.819">wrapping so this is just a quick little</span> <span data-start="431.819" data-end="435.33">utility i made up called wrap if any of</span> <span data-start="435.33" data-end="436.319">you have done Python this is the</span> <span data-start="436.319" data-end="438.33">decorator pattern I don't know is their</span> <span data-start="438.33" data-end="440.279">name for a javascript where you take a</span> <span data-start="440.279" data-end="441.629">function return a new function with</span> <span data-start="441.629" data-end="445.349">slightly in your behavior but so you</span> <span data-start="445.349" data-end="449.219">take your your actual on an open on</span> <span data-start="449.219" data-end="453.119">whatever callback and this adds error</span> <span data-start="453.119" data-end="455.339">handling to it because the problem with</span> <span data-start="455.339" data-end="457.61">async code is you can't use try catch</span> <span data-start="457.61" data-end="461.759">try catch is tied to a stack and you saw</span> <span data-start="461.759" data-end="463.169">the errors with the stars every time</span> <span data-start="463.169" data-end="465.3">that happens you're on a new stack and</span> <span data-start="465.3" data-end="466.86">you try catch to happen before is long</span> <span data-start="466.86" data-end="468.479">gone and it won't catch any exceptions</span> <span data-start="468.479" data-end="470.699">that happen now so if you want your code</span> <span data-start="470.699" data-end="472.889">to not throw exceptions which in a</span> <span data-start="472.889" data-end="474.36">server you don't want because then your</span> <span data-start="474.36" data-end="476.309">entire server goes down and all your</span> <span data-start="476.309" data-end="478.949">connections are now closed you need to</span> <span data-start="478.949" data-end="480.209">be careful about routing all these</span> <span data-start="480.209" data-end="481.619">exceptions to the right place you can</span> <span data-start="481.619" data-end="485.249">send the user a 500 page or something so</span> <span data-start="485.249" data-end="488.509">it takes the function note has this</span> <span data-start="488.509" data-end="492.3">convention that all I'll call backs give</span> <span data-start="492.3" data-end="494.459">you air and result and so if node gave</span> <span data-start="494.459" data-end="495.99">you an error pass it through the</span> <span data-start="495.99" data-end="499.11">callback and if actually colon your code</span> <span data-start="499.11" data-end="501.209">throws an exception catch that and pass</span> <span data-start="501.209" data-end="505.229">it to the callback super handy and then</span> <span data-start="505.229" data-end="506.879">this is just merging buffers we don't</span> <span data-start="506.879" data-end="509.55">need to go through that but so here's</span> <span data-start="509.55" data-end="510.99">here's the read frontal it takes the</span> <span data-start="510.99" data-end="512.399">fault is chunk and then here I've got my</span> <span data-start="512.399" data-end="513.899">own open on read and they're just</span> <span data-start="513.899" data-end="516.509">wrapped versions of the functions so</span> <span data-start="516.509" data-end="520.019">they handled error handling on opens</span> <span data-start="520.019" data-end="522.329">pretty easy you get the file descriptor</span> <span data-start="522.329" data-end="523.919">store it and available in the closure</span> <span data-start="523.919" data-end="527.1">and then call get junk and then I want</span> <span data-start="527.1" data-end="529.11">all errors to be ready to call back on</span> <span data-start="529.11" data-end="532.14">read pretty similar file system</span> </p>
<p><span data-start="532.14" data-end="533.88">I gave me this many bites and those</span> <span data-start="533.88" data-end="535.41">bites were given to the buffer I had in</span> <span data-start="535.41" data-end="538.41">my other closure and so if there were no</span> <span data-start="538.41" data-end="540.06">bites I'm done called the done function</span> <span data-start="540.06" data-end="543.81">if if it wasn't how many bytes I wanted</span> <span data-start="543.81" data-end="545.91">or if it's small and a buffer you got to</span> <span data-start="545.91" data-end="548.91">resize the buffer this is low-level node</span> <span data-start="548.91" data-end="551.37">buffer stuff but the important thing</span> <span data-start="551.37" data-end="553.53">here is that I then called get chunk</span> <span data-start="553.53" data-end="556.14">again and it loops recursively but</span> <span data-start="556.14" data-end="557.28">you're not going to you're not going to</span> <span data-start="557.28" data-end="558.51">blow it a step because remember every</span> <span data-start="558.51" data-end="560.25">time on Reed is called it's a new stack</span> <span data-start="560.25" data-end="561.72">so you'd have to worry about stack</span> <span data-start="561.72" data-end="564.84">overflow and the get chunk just</span> <span data-start="564.84" data-end="567.12">basically allocates a buffer and reads</span> <span data-start="567.12" data-end="570.51">it from the file and then done closes</span> <span data-start="570.51" data-end="572.31">the file and then merges all the buffers</span> <span data-start="572.31" data-end="575.19">and calls person here is your file nice</span> <span data-start="575.19" data-end="576.96">to do all that for you and wrap it up in</span> <span data-start="576.96" data-end="579.39">just one call read this phone give me</span> <span data-start="579.39" data-end="581.67">the data there's the data great pattern</span> <span data-start="581.67" data-end="585.57">function composition so the second</span> <span data-start="585.57" data-end="588.57">technique is called back counters since</span> <span data-start="588.57" data-end="591.84">this all this non blocking code it just</span> <span data-start="591.84" data-end="593.04">goes straight through you can do stuff</span> <span data-start="593.04" data-end="595.38">in parallel you can do weights in</span> <span data-start="595.38" data-end="597.06">parallel you can't do execution and</span> <span data-start="597.06" data-end="598.53">parallels it's single-threaded it's</span> </p>
<p><span data-start="598.53" data-end="600.75">JavaScript but you can be waiting for</span> <span data-start="600.75" data-end="602.01">this file to open while you're waiting</span> <span data-start="602.01" data-end="603.3">for this database query to come back</span> <span data-start="603.3" data-end="604.38">while you're waiting for something else</span> <span data-start="604.38" data-end="605.67">to happen you can do all those weights</span> <span data-start="605.67" data-end="607.29">in parallel which is great really speeds</span> <span data-start="607.29" data-end="614.61">it up but the problem is you need to do</span> <span data-start="614.61" data-end="616.17">things when it's done you need to</span> <span data-start="616.17" data-end="619.67">continue the logic of your program so</span> <span data-start="619.67" data-end="622.29">organize it into either serial actions</span> <span data-start="622.29" data-end="623.37">that maybe we'll run on another or</span> <span data-start="623.37" data-end="626.16">things going to be done in parallel so</span> <span data-start="626.16" data-end="627.96">here's a simple example suppose I want</span> <span data-start="627.96" data-end="629.22">to read two files these files are</span> <span data-start="629.22" data-end="631.08">completely unrelated and then do</span> <span data-start="631.08" data-end="633.21">something after they've been read well</span> <span data-start="633.21" data-end="635.91">how do you do that it's quite simple you</span> <span data-start="635.91" data-end="637.92">have a counter or some other variable</span> <span data-start="637.92" data-end="641.61">and each time the on Reed's come back</span> <span data-start="641.61" data-end="643.44">from those you decrement your counter</span> <span data-start="643.44" data-end="645.12">and when it reaches zero you know all of</span> <span data-start="645.12" data-end="647.19">your call backs have done and then you</span> <span data-start="647.19" data-end="651.78">call the next step so there's simple</span> <span data-start="651.78" data-end="655.29">counters here's a slightly more complex</span> <span data-start="655.29" data-end="657.15">example suppose I want to take a</span> <span data-start="657.15" data-end="659.73">directory of files and I want to read</span> <span data-start="659.73" data-end="661.14">the contents of all the files in that</span> <span data-start="661.14" data-end="663.09">directory so we have an unknown number</span> <span data-start="663.09" data-end="664.13">of things here</span> <span data-start="664.13" data-end="665.45">there might be 10 files might be a</span> <span data-start="665.45" data-end="669.35">thousand files so I'm gonna call read</span> <span data-start="669.35" data-end="670.82">directory which is going to get listing</span> <span data-start="670.82" data-end="673.25">the files when that comes back I'm going</span> <span data-start="673.25" data-end="675.41">to then loop over that and fire off a</span> <span data-start="675.41" data-end="676.94">raid file for each one of those files</span> <span data-start="676.94" data-end="679.58">and then I wanted a another all going to</span> <span data-start="679.58" data-end="681.08">call on read and then when all of them</span> <span data-start="681.08" data-end="682.64">are done it's going to pass the data to</span> <span data-start="682.64" data-end="688.13">my call back so this is slightly more</span> <span data-start="688.13" data-end="692.38">complicated but same idea so we call</span> <span data-start="692.38" data-end="695.27">some filtering out some files either a</span> </p>
<p><span data-start="695.27" data-end="697.01">County ghost files dot length so the</span> <span data-start="697.01" data-end="698.33">number of files i'm going to open I got</span> <span data-start="698.33" data-end="700.46">my counter again and then while I for</span> <span data-start="700.46" data-end="702.74">each over the files it's opening them</span> <span data-start="702.74" data-end="704.21">and then when those callbacks come back</span> <span data-start="704.21" data-end="706.19">document count now one thing to note</span> <span data-start="706.19" data-end="708.77">here remember this is non blocking so</span> <span data-start="708.77" data-end="711.7">this for each goes through instantly and</span> <span data-start="711.7" data-end="713.81">then the files are read from the disk</span> <span data-start="713.81" data-end="716.63">you got to remember that code never ever</span> <span data-start="716.63" data-end="718.34">blocks in this non-blocking world and</span> <span data-start="718.34" data-end="721.25">any tobacco goes straight through but</span> <span data-start="721.25" data-end="723.44">then once they've all read the count</span> <span data-start="723.44" data-end="725.66">will be the count will be zero called a</span> <span data-start="725.66" data-end="730.76">call back with the results here's a</span> <span data-start="730.76" data-end="732.59">slightly simpler version if you just</span> <span data-start="732.59" data-end="734.75">want to see count count decrement and</span> <span data-start="734.75" data-end="736.76">then equals you don't have to use the</span> <span data-start="736.76" data-end="738.17">minus minus count it's kind of tricky</span> <span data-start="738.17" data-end="739.91">but if you want really short code works</span> </p>
<p><span data-start="739.91" data-end="741.38">I mean it's whatever your preference is</span> <span data-start="741.38" data-end="744.23">I usually just do count minus minus 0</span> <span data-start="744.23" data-end="745.49">then if count equals 0 it's more</span> <span data-start="745.49" data-end="748.61">explicit that way but slides you got to</span> <span data-start="748.61" data-end="751.7">squish the code sometimes so that's</span> <span data-start="751.7" data-end="753.23">called back counters very handy</span> <span data-start="753.23" data-end="754.67">technique we do this all the time I</span> <span data-start="754.67" data-end="756.77">think I think every node library at</span> <span data-start="756.77" data-end="757.97">there has some implementation of</span> <span data-start="757.97" data-end="762.13">counters and a helper library that loops</span> <span data-start="762.13" data-end="766.64">not everything is a call back so call</span> <span data-start="766.64" data-end="768.62">backs are great the way the way we</span> <span data-start="768.62" data-end="771.14">talked about them originally when we</span> <span data-start="771.14" data-end="773.54">dropped promises from node is there's a</span> <span data-start="773.54" data-end="775.88">distinction you have you have things</span> <span data-start="775.88" data-end="777.2">that are basically asynchronous</span> <span data-start="777.2" data-end="779.12">functions they're going to either return</span> <span data-start="779.12" data-end="782.57">one value or they're going to throw an</span> <span data-start="782.57" data-end="784.58">error and in synchronous code that's</span> <span data-start="784.58" data-end="787.94">easy an async code you just give it a</span> <span data-start="787.94" data-end="788.96">call back and that callback you</span> <span data-start="788.96" data-end="790.61">eventually gets cold with an error or</span> <span data-start="790.61" data-end="793.04">value what about things that just happen</span> <span data-start="793.04" data-end="794.19">on several</span> <span data-start="794.19" data-end="796.8">x or never happen at all like unclick</span> <span data-start="796.8" data-end="799.2">events in the browser or on request</span> <span data-start="799.2" data-end="801.48">events an HTTP server you don't want to</span> <span data-start="801.48" data-end="803.19">really use plain callbacks for those</span> <span data-start="803.19" data-end="805.5">because it happened several times I mean</span> <span data-start="805.5" data-end="807.15">lower level it is JavaScript callback is</span> <span data-start="807.15" data-end="809.25">a function but it's a slightly higher</span> <span data-start="809.25" data-end="812.85">abstraction using events so going back</span> <span data-start="812.85" data-end="814.17">to the rube example ahead of front</span> <span data-start="814.17" data-end="815.61">suppose you really did want to read the</span> <span data-start="815.61" data-end="817.71">file line by line that's a useful thing</span> <span data-start="817.71" data-end="822.3">to do so I had this mythical line reader</span> <span data-start="822.3" data-end="823.98">thing this is doesn't exist a node and</span> <span data-start="823.98" data-end="827.16">it gives you this object that has three</span> <span data-start="827.16" data-end="830.13">events it has a line event that is</span> <span data-start="830.13" data-end="831.6">emitted every time a line is read from</span> <span data-start="831.6" data-end="833.88">the file has an end event that is</span> <span data-start="833.88" data-end="835.8">emitted when the files done and if</span> <span data-start="835.8" data-end="836.82">there's any errors there's an error</span> <span data-start="836.82" data-end="838.41">event this is one way to do it there's</span> <span data-start="838.41" data-end="840.6">lots of other abstractions but the point</span> <span data-start="840.6" data-end="842.91">is different things are happening and so</span> <span data-start="842.91" data-end="848.05">you just have various event callbacks</span> <span data-start="848.06" data-end="850.86">easy as pie libraries to see I need to</span> <span data-start="850.86" data-end="855.42">use these cool symbols so a lot of this</span> <span data-start="855.42" data-end="857.43">code as you saw it was kind of long and</span> <span data-start="857.43" data-end="859.29">hard to write and i've been writing eps</span> <span data-start="859.29" data-end="860.76">with node for a while and i don't like</span> <span data-start="860.76" data-end="863.61">writing this over all the time so i made</span> <span data-start="863.61" data-end="865.38">a i made several libraries my favorite</span> <span data-start="865.38" data-end="868.38">one is step and it's based on regular</span> <span data-start="868.38" data-end="870.54">callbacks and it's it's really simple</span> <span data-start="870.54" data-end="874.83">and it just you can do things in cereal</span> <span data-start="874.83" data-end="876.24">without nesting your code you can do</span> <span data-start="876.24" data-end="877.47">things in parallel and group and with</span> <span data-start="877.47" data-end="879.09">that writing your own counters it does</span> <span data-start="879.09" data-end="880.89">the counters for you it wraps everything</span> <span data-start="880.89" data-end="882.99">in try-catch does the routing it's just</span> <span data-start="882.99" data-end="886.53">a neat thing Chris recently released the</span> <span data-start="886.53" data-end="889.05">library promised i/o which it wraps the</span> <span data-start="889.05" data-end="891.51">node AP is in in some promise</span> <span data-start="891.51" data-end="893.39">abstraction which is a different way to</span> <span data-start="893.39" data-end="895.68">instead of doing callbacks their</span> <span data-start="895.68" data-end="898.02">promises so there's lots of ways to do</span> <span data-start="898.02" data-end="900.3">this there's other libraries too I know</span> <span data-start="900.3" data-end="901.56">step so that's what I'm going to talk</span> <span data-start="901.56" data-end="905.19">about so let's take a simple example I</span> <span data-start="905.19" data-end="908.04">want to load a user now I get that user</span> <span data-start="908.04" data-end="910.77">from the database I then we'll find some</span> <span data-start="910.77" data-end="913.38">items about that user so i need to do</span> <span data-start="913.38" data-end="914.82">some queries against the database and</span> <span data-start="914.82" data-end="917.16">then when that's done that bottom ones</span> <span data-start="917.16" data-end="921.72">labeled wrong do something else so you</span> <span data-start="921.72" data-end="924.18">notice here this there's two events from</span> <span data-start="924.18" data-end="926.61">the event loop the return from the</span> <span data-start="926.61" data-end="927.75">database and the other</span> <span data-start="927.75" data-end="930.45">on the database so to do this in step</span> <span data-start="930.45" data-end="933.9">you have three steps load user calls DB</span> <span data-start="933.9" data-end="936.78">get user and then in step this is a call</span> <span data-start="936.78" data-end="938.25">back to the next step so you don't have</span> <span data-start="938.25" data-end="940.44">to nest your code that way it stays on</span> <span data-start="940.44" data-end="941.82">saner when you have long chains of</span> <span data-start="941.82" data-end="944.61">things to do in cereal so then find</span> <span data-start="944.61" data-end="946.05">items i'm just going to do some random</span> <span data-start="946.05" data-end="947.4">query against the database and then</span> <span data-start="947.4" data-end="950.85">again this that'll pass the area to the</span> <span data-start="950.85" data-end="954.18">next one notice that i am checking the</span> <span data-start="954.18" data-end="955.47">air here and thrown it if there's a</span> <span data-start="955.47" data-end="957.48">problem normally you want to pass it to</span> <span data-start="957.48" data-end="959.73">some call back throwing and note is</span> <span data-start="959.73" data-end="961.02">generally a bad idea unless you know</span> <span data-start="961.02" data-end="964.2">something's going to catch it so just</span> <span data-start="964.2" data-end="965.88">you know a couple things in order pretty</span> <span data-start="965.88" data-end="968.43">simple right how about a couple things</span> <span data-start="968.43" data-end="970.14">in parallel you do that all the time too</span> <span data-start="970.14" data-end="972.39">suppose I'm rendering a page i need to</span> <span data-start="972.39" data-end="973.83">load my template from the file system</span> <span data-start="973.83" data-end="975.45">but what am I data from the database and</span> <span data-start="975.45" data-end="977.04">then merge the two and render HTML page</span> <span data-start="977.04" data-end="980.19">super common but I need to know I have</span> <span data-start="980.19" data-end="982.29">to have the data and the template to be</span> <span data-start="982.29" data-end="983.31">able to render it I can't do anything</span> <span data-start="983.31" data-end="987.51">till they're both done so the this</span> <span data-start="987.51" data-end="990.51">object actually has a function called</span> <span data-start="990.51" data-end="992.55">parallel which generates callbacks so</span> <span data-start="992.55" data-end="993.75">every time you need a callback for that</span> <span data-start="993.75" data-end="995.55">you just call this parallel so I can do</span> <span data-start="995.55" data-end="996.93">five things in parallel two things in</span> <span data-start="996.93" data-end="999.3">parallel it'll do them all it'll keep</span> <span data-start="999.3" data-end="1000.77">checking the counters it'll even order</span> <span data-start="1000.77" data-end="1002.6">the results for you so no matter what</span> <span data-start="1002.6" data-end="1005">order these come back when it calls the</span> <span data-start="1005" data-end="1006.65">next thing I got my results i got my</span> <span data-start="1006.65" data-end="1008.15">file contents and if there was an error</span> <span data-start="1008.15" data-end="1012.83">in either one i have that error and what</span> <span data-start="1012.83" data-end="1014.24">if you want to do several things like we</span> <span data-start="1014.24" data-end="1015.56">did before rita directory with several</span> <span data-start="1015.56" data-end="1021.11">files so in that case we're going to</span> <span data-start="1021.11" data-end="1023.21">read the directory pass the file names</span> <span data-start="1023.21" data-end="1026">to the next step and this one I don't</span> <span data-start="1026" data-end="1026.93">know I should probably change the you've</span> <span data-start="1026.93" data-end="1029.78">had this really confuses people so this</span> <span data-start="1029.78" data-end="1032.38">step group creates a callback generator</span> <span data-start="1032.38" data-end="1034.64">so you got to call that once and that</span> <span data-start="1034.64" data-end="1036.05">will reserve a slot in the next step and</span> <span data-start="1036.05" data-end="1039.53">then for each of your things an FS read</span> <span data-start="1039.53" data-end="1041.839">file call group again this is now the</span> <span data-start="1041.839" data-end="1043.55">callback generator and that gives each</span> <span data-start="1043.55" data-end="1045.189">one of those read files a unique</span> <span data-start="1045.189" data-end="1048.5">callback and the contents the next step</span> <span data-start="1048.5" data-end="1050.3">will be an array of all the results and</span> <span data-start="1050.3" data-end="1052.13">those are actually ordered in the order</span> <span data-start="1052.13" data-end="1053.69">you called FS read file not the order</span> <span data-start="1053.69" data-end="1054.68">that came back from the file system</span> <span data-start="1054.68" data-end="1058.17">because those aren't the same thing</span> <span data-start="1058.18" data-end="1061.22">so so you do that we've contents now you</span> <span data-start="1061.22" data-end="1062.48">got the contents of all the files this</span> <span data-start="1062.48" data-end="1066.32">is slightly less code then doing it in</span> <span data-start="1066.32" data-end="1068.21">plain node plain JavaScript but when you</span> <span data-start="1068.21" data-end="1070.28">start getting larger programs this gets</span> <span data-start="1070.28" data-end="1072.47">a lot saner and this has all day or</span> <span data-start="1072.47" data-end="1081.17">handily built in for you so well that</span> <span data-start="1081.17" data-end="1085.61">was fast all right questions that I know</span> <span data-start="1085.61" data-end="1086.63">a lot of people have questions about</span> <span data-start="1086.63" data-end="1119.09">this Lamela enlist in IRC</span> <span data-start="1119.1" data-end="1122.91">yeah I mean note is single threaded</span> <span data-start="1122.91" data-end="1125.17">execution only one thing happens at a</span> <span data-start="1125.17" data-end="1127.72">time ever and so if I have a line that</span> <span data-start="1127.72" data-end="1129.37">says count minus minus and the next line</span> <span data-start="1129.37" data-end="1130.93">if at zero nothing's going to happen</span> <span data-start="1130.93" data-end="1132.85">between those that's blocking</span> <span data-start="1132.85" data-end="1135.46">synchronous code and so while we have</span> <span data-start="1135.46" data-end="1137.8">some asynchronous things going on you at</span> <span data-start="1137.8" data-end="1139.81">least know that random stuff that could</span> <span data-start="1139.81" data-end="1141.19">happen between your lines like with</span> <span data-start="1141.19" data-end="1143.41">threading with threading it's insane</span> <span data-start="1143.41" data-end="1144.97">anything can happen anywhere unless it's</span> <span data-start="1144.97" data-end="1147.52">an atomic CPU operation which is why we</span> <span data-start="1147.52" data-end="1149.68">have OS level locks and all these crazy</span> <span data-start="1149.68" data-end="1152.11">things but with a single threaded event</span> <span data-start="1152.11" data-end="1154.36">system you don't have those issues the</span> <span data-start="1154.36" data-end="1155.44">only time that things can happen</span> <span data-start="1155.44" data-end="1160.03">arbitrarily is between your weights you</span> <span data-start="1160.03" data-end="1161.41">don't know which events are going to</span> <span data-start="1161.41" data-end="1163.54">come back in what order you just know</span> <span data-start="1163.54" data-end="1165.01">that once you're in code you're in</span> <span data-start="1165.01" data-end="1168.01">control until you stop so like I said at</span> <span data-start="1168.01" data-end="1169.21">the beginning the difference between</span> <span data-start="1169.21" data-end="1171.88">this and threading is with threading the</span> </p>
<p><span data-start="1171.88" data-end="1173.65">OS handles the concurrency for you it</span> <span data-start="1173.65" data-end="1176.29">says you code stop you code run no no no</span> <span data-start="1176.29" data-end="1178.12">you run again it just interrupts them</span> <span data-start="1178.12" data-end="1180.97">constantly with node we're saying run</span> <span data-start="1180.97" data-end="1183.85">this code and then I'm done which can</span> <span data-start="1183.85" data-end="1187.63">actually bite you sometimes because if</span> <span data-start="1187.63" data-end="1189.43">you're doing CPU intensive things like</span> <span data-start="1189.43" data-end="1191.7">calculating the first million pi digits</span> <span data-start="1191.7" data-end="1194.89">that's not a good thing first Olivia</span> <span data-start="1194.89" data-end="1195.76">it's not very good at that particular</span> <span data-start="1195.76" data-end="1199.81">use case and secondly your entire server</span> <span data-start="1199.81" data-end="1201.76">with your hundred thousand clients is</span> <span data-start="1201.76" data-end="1204.25">now blocked nothing happens nothing</span> <span data-start="1204.25" data-end="1205.75">happens at all because it's calculating</span> <span data-start="1205.75" data-end="1207.25">these pi digits for this one user who</span> <span data-start="1207.25" data-end="1208.51">typed a really big number in their form</span> <span data-start="1208.51" data-end="1210.88">and so that's where things like web</span> <span data-start="1210.88" data-end="1212.68">workers come in where you can actually</span> <span data-start="1212.68" data-end="1214.63">defer this to another process that does</span> <span data-start="1214.63" data-end="1216.76">the CPU intensive stuff hopefully on</span> <span data-start="1216.76" data-end="1217.99">another machine maybe if it's really</span> <span data-start="1217.99" data-end="1219.91">heavy so you're not fighting for the</span> <span data-start="1219.91" data-end="1221.47">threads and then that will give you</span> <span data-start="1221.47" data-end="1224.53">something back over IPC or TCP about</span> <span data-start="1224.53" data-end="1227.2">it's done but if things are short and</span> <span data-start="1227.2" data-end="1228.88">that receive you intensive than just do</span> <span data-start="1228.88" data-end="1230.38">them in line as long as you're done</span> <span data-start="1230.38" data-end="1232.53">quickly it won't hurt the event loop</span> <span data-start="1232.53" data-end="1251.21">anymore questions</span> </p>
<p><span data-start="1251.22" data-end="1254.64">I</span> <span data-start="1254.65" data-end="1257.92">I have i I've heard different things</span> <span data-start="1257.92" data-end="1259.57">I've heard it being I've heard what we</span> <span data-start="1259.57" data-end="1261.13">do with node called continuation passing</span> <span data-start="1261.13" data-end="1262.66">style and I've heard other things what</span> <span data-start="1262.66" data-end="1277.33">what do you mean by that</span> <span data-start="1277.34" data-end="1280.44">the best solution</span> <span data-start="1280.44" data-end="1285.179">so is this is this like her routines or</span> <span data-start="1285.179" data-end="1290.289">sort of okay so i dunno co routines and</span> <span data-start="1290.289" data-end="1293.619">we we had those in node early on with</span> <span data-start="1293.619" data-end="1297.579">the promise wait API and while it works</span> <span data-start="1297.579" data-end="1299.259">and doesn't hurt the event lip too bad</span> <span data-start="1299.259" data-end="1301.599">it introduces thread like semantics</span> <span data-start="1301.599" data-end="1304.359">because now you have functions that do</span> <span data-start="1304.359" data-end="1307.569">non-blocking i/o but externally look</span> <span data-start="1307.569" data-end="1310.599">like they're blocking and so once those</span> <span data-start="1310.599" data-end="1312.309">get reps behind other functions and</span> <span data-start="1312.309" data-end="1313.929">other AP is and you just use libraries</span> <span data-start="1313.929" data-end="1315.969">unless you read all the code you don't</span> <span data-start="1315.969" data-end="1318.219">know if this function call is actually</span> <span data-start="1318.219" data-end="1320.109">going to stop and let the event lib do</span> <span data-start="1320.109" data-end="1322.119">other stuff and so then it's kind of</span> <span data-start="1322.119" data-end="1323.409">like threading in between these calls</span> <span data-start="1323.409" data-end="1325.629">random stuff may happen and it's not</span> <span data-start="1325.629" data-end="1328.899">quite as bad as truth reading but yeah i</span> <span data-start="1328.899" data-end="1330.849">mean we tried the co routines we decided</span> <span data-start="1330.849" data-end="1332.589">we didn't like them for node other other</span> <span data-start="1332.589" data-end="1334.929">frameworks use them if that's what</span> <span data-start="1334.929" data-end="1337.809">you're talking about but yeah it's it's</span> <span data-start="1337.809" data-end="1339.999">one alternative we're trying we're</span> <span data-start="1339.999" data-end="1342.039">trying to a nodal really trying to</span> <span data-start="1342.039" data-end="1343.929">follow the same style in the browser and</span> <span data-start="1343.929" data-end="1346.329">in the browser it's just plain callbacks</span> <span data-start="1346.329" data-end="1348.489">plain event single threaded single stack</span> <span data-start="1348.489" data-end="1351.159">and with co routines you have multiple</span> <span data-start="1351.159" data-end="1353.559">stacks and they that kind of interleave</span> <span data-start="1353.559" data-end="1355.869">dependent on when they when they waited</span> <span data-start="1355.869" data-end="1368.95">on the next event the question</span> <span data-start="1368.96" data-end="1371.58">it depends on how the DB library is</span> <span data-start="1371.58" data-end="1373.23">written hopefully it doesn't look any</span> <span data-start="1373.23" data-end="1376.95">library is a block you shouldn't use if</span> <span data-start="1376.95" data-end="1378.72">it's my postgres library it actually</span> <span data-start="1378.72" data-end="1380.85">implements that the postgres protocol</span> <span data-start="1380.85" data-end="1383.1">over tcp and so it's non blocking</span> <span data-start="1383.1" data-end="1384.929">because all of nodes networking stack as</span> <span data-start="1384.929" data-end="1386.85">non blocking but if you're saying just</span> <span data-start="1386.85" data-end="1388.919">buying into the ROM icicle library it's</span> <span data-start="1388.919" data-end="1390.149">going to be blocking is going to hurt</span> <span data-start="1390.149" data-end="1391.86">your event loop so you got to make sure</span> <span data-start="1391.86" data-end="1392.909">you don't use libraries that are</span> <span data-start="1392.909" data-end="1395.249">blocking which is another reason why</span> <span data-start="1395.249" data-end="1397.279">javascript was a good choice for note</span> <span data-start="1397.279" data-end="1400.11">people who come from Python or Ruby are</span> <span data-start="1400.11" data-end="1402.179">used to these blocking libraries almost</span> <span data-start="1402.179" data-end="1403.619">your database drivers are blocking and</span> <span data-start="1403.619" data-end="1405.779">so when people use twisted or event</span> <span data-start="1405.779" data-end="1407.94">machine or the non-blocking systems they</span> <span data-start="1407.94" data-end="1409.289">got to be careful which libraries they</span> <span data-start="1409.289" data-end="1412.47">pull in and JavaScript the spec there is</span> <span data-start="1412.47" data-end="1415.86">no I oh and in the browser the only i/o</span> <span data-start="1415.86" data-end="1418.379">is non blocking I mean there is sync xhr</span> <span data-start="1418.379" data-end="1420.48">but we're told not to use it so pretty</span> <span data-start="1420.48" data-end="1422.07">much it's non blocking and so the</span> </p>
<p><span data-start="1422.07" data-end="1423.539">JavaScript people are used to this idea</span> <span data-start="1423.539" data-end="1425.49">of all your libraries being non blocking</span> <span data-start="1425.49" data-end="1427.74">and we have a fresh clean start but yeah</span> <span data-start="1427.74" data-end="1429.09">you don't want to use a library that is</span> <span data-start="1429.09" data-end="1449.68">blocking that's that's very bad</span> <span data-start="1449.69" data-end="1455.37">yeah so it's a tough decision require</span> <span data-start="1455.37" data-end="1457.73">require especially as a special case</span> <span data-start="1457.73" data-end="1460.95">early on I was pushing for fully async</span> <span data-start="1460.95" data-end="1462.03">require it makes your code more</span> <span data-start="1462.03" data-end="1463.89">complicated makes it harder to read and</span> <span data-start="1463.89" data-end="1465.66">the same time it's you know it's</span> <span data-start="1465.66" data-end="1467.16">parallel what's non-blocking you can</span> <span data-start="1467.16" data-end="1468.57">write the same code in the browser and</span> <span data-start="1468.57" data-end="1469.89">because you can't really do block and</span> <span data-start="1469.89" data-end="1473.27">requires on a browser but then again</span> <span data-start="1473.27" data-end="1476.13">require is cached even if you require in</span> <span data-start="1476.13" data-end="1477.66">a hot loop in your server you're</span> <span data-start="1477.66" data-end="1479.43">probably requiring the 10 file same 10</span> <span data-start="1479.43" data-end="1481.56">files over and over so your first web</span> <span data-start="1481.56" data-end="1483.15">request will be an extra 30 milliseconds</span> <span data-start="1483.15" data-end="1485.4">long after that they're hitting the</span> <span data-start="1485.4" data-end="1487.05">in-memory cache and so it doesn't hurt</span> <span data-start="1487.05" data-end="1489.99">your performance yeah it's a special</span> <span data-start="1489.99" data-end="1491.61">case and we're still thinking about</span> <span data-start="1491.61" data-end="1493.68">what's a good API for a good require I</span> <span data-start="1493.68" data-end="1494.88">know the common jest guys are thinking</span> <span data-start="1494.88" data-end="1526.88">about it so yeah</span> <span data-start="1526.89" data-end="1529.92">yeah now you can implement your own it's</span> <span data-start="1529.92" data-end="1531.93">not hard no it provides a script API</span> <span data-start="1531.93" data-end="1535.47">where you can get access to v8's I don't</span> <span data-start="1535.47" data-end="1544.92">know what it's called but but yeah yeah</span> <span data-start="1544.92" data-end="1547.77">okay so yeah just just talk on the</span> <span data-start="1547.77" data-end="1549.36">mailing list give some suggestions we're</span> <span data-start="1549.36" data-end="1551.79">open ideas note note is still a work in</span> <span data-start="1551.79" data-end="1553.14">progress but it's stable enough now to</span> <span data-start="1553.14" data-end="1555.39">start being used for applications thank</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
