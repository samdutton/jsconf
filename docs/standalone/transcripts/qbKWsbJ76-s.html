<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>qbKWsbJ76-s</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/qbKWsbJ76-s?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="10.63" data-end="21.42">you</span> <span data-start="21.43" data-end="23.62">hi right I'm going to be talking about</span> <span data-start="23.62" data-end="27.61">promises and generators so a lot of</span> <span data-start="27.61" data-end="29.26">stuff I'm talking about it's very new so</span> <span data-start="29.26" data-end="31.63">it's very experimental it's getting into</span> <span data-start="31.63" data-end="33.46">the latest browsers but you're going to</span> <span data-start="33.46" data-end="35.05">have to enable some flags so if you're</span> <span data-start="35.05" data-end="36.82">in Firefox nightly I believe this has</span> <span data-start="36.82" data-end="39.37">just been added it's in Chrome with a</span> <span data-start="39.37" data-end="41.41">flat if you go to the flags and you can</span> <span data-start="41.41" data-end="43.78">use it in node with the â€” - harmony</span> <span data-start="43.78" data-end="47.32">generators flag and mice the slides are</span> <span data-start="47.32" data-end="48.489">available for this so if you want to</span> <span data-start="48.489" data-end="49.69">follow along or whatever you can get</span> <span data-start="49.69" data-end="53.68">grab those now so I'm going to start off</span> <span data-start="53.68" data-end="55.6">not really talking about promises not</span> <span data-start="55.6" data-end="56.92">really talking about asynchronous stuff</span> <span data-start="56.92" data-end="58.51">at all but talking about how you</span> <span data-start="58.51" data-end="60.91">represent a sequence so if you've got a</span> <span data-start="60.91" data-end="62.53">sequence of numbers so here we're</span> <span data-start="62.53" data-end="65.68">talking about the integers this function</span> <span data-start="65.68" data-end="68.02">returns the first n integers as an array</span> <span data-start="68.02" data-end="70.42">and that's really nice for representing</span> <span data-start="70.42" data-end="73.149">finite sequences arrays work great for</span> <span data-start="73.149" data-end="74.86">that but the integers aren't really a</span> <span data-start="74.86" data-end="76.93">finite sequence really they're an</span> <span data-start="76.93" data-end="79.06">infinite sequence but we can't have this</span> <span data-start="79.06" data-end="81.16">function returning an infinite sequence</span> <span data-start="81.16" data-end="83.56">as an array if we try and do that just</span> <span data-start="83.56" data-end="85.24">replace the condition there with true</span> <span data-start="85.24" data-end="87.49">this is trying to create an infinitely</span> <span data-start="87.49" data-end="89.65">long array so this count function is</span> <span data-start="89.65" data-end="91.659">just never going to return we're never</span> <span data-start="91.659" data-end="93.52">going to get into that for loop and</span> <span data-start="93.52" data-end="95.35">we're never going to log any output I</span> <span data-start="95.35" data-end="97.869">should just note that for oov there is a</span> <span data-start="97.869" data-end="99.88">new construct but it just loops over the</span> <span data-start="99.88" data-end="102.42">items in an array or in a sequence or it</span> <span data-start="102.42" data-end="104.32">supports a much wider range of</span> <span data-start="104.32" data-end="106.63">collections than say using a for a</span> <span data-start="106.63" data-end="111.49">traditional for loop so the next version</span> <span data-start="111.49" data-end="114.31">of JavaScript has built-in support for</span> <span data-start="114.31" data-end="117.28">these infinite collections and they it</span> <span data-start="117.28" data-end="119.83">works using it by making the function</span> <span data-start="119.83" data-end="123.04">lazy and only only executing as far as</span> <span data-start="123.04" data-end="124.72">it needs to to return the values that</span> <span data-start="124.72" data-end="127.54">are actually used so what happens with</span> <span data-start="127.54" data-end="129.759">this count function is that the function</span> <span data-start="129.759" data-end="132.85">is executed only when we request the</span> <span data-start="132.85" data-end="134.86">value so initially when you call count</span> <span data-start="134.86" data-end="137.23">none of the code inside the body is</span> <span data-start="137.23" data-end="140.799">executed then the for loop requests the</span> <span data-start="140.799" data-end="143.95">first value from count and at that point</span> <span data-start="143.95" data-end="147.07">it executes as far as that first yield</span> <span data-start="147.07" data-end="149.68">keyword and when it gets to that first</span> <span data-start="149.68" data-end="152.23">yield keyword it returns that value and</span> <span data-start="152.23" data-end="154.68">we get to use it in the for loop</span> <span data-start="154.68" data-end="157.379">but it pauses the function so it saves</span> <span data-start="157.379" data-end="159.42">the entire execution state of that</span> <span data-start="159.42" data-end="162.959">function and then when we ask for the</span> <span data-start="162.959" data-end="165.329">second value it resumes that function</span> <span data-start="165.329" data-end="167.579">from where the yield keyword was and</span> <span data-start="167.579" data-end="170.51">continues around the loop a second time</span> <span data-start="170.51" data-end="173.099">so this is really useful for infinite</span> <span data-start="173.099" data-end="175.65">sequences like this function represents</span> <span data-start="175.65" data-end="178.709">all of the integers and we can still get</span> <span data-start="178.709" data-end="181.349">back to the semantics we had before we</span> <span data-start="181.349" data-end="183.239">can just write a simple take function</span> <span data-start="183.239" data-end="186.269">that takes any infinite sequence and</span> <span data-start="186.269" data-end="189.06">takes the first n items out of that</span> <span data-start="189.06" data-end="191.069">sequence and this would work for</span> <span data-start="191.069" data-end="193.95">integers but you could equally pass the</span> </p>
<p><span data-start="193.95" data-end="196.139">Fibonacci sequence as an infinite</span> <span data-start="196.139" data-end="199.139">sequence and because it's because of the</span> <span data-start="199.139" data-end="200.909">lazy nature of it we could pull off the</span> <span data-start="200.909" data-end="203.01">first 5 items the first 10 items as</span> <span data-start="203.01" data-end="206.129">needed and we can reuse this and we</span> <span data-start="206.129" data-end="207.78">could have more complicated conditions</span> <span data-start="207.78" data-end="209.819">as well it doesn't have to be the first</span> <span data-start="209.819" data-end="212.639">n items it could be all the items up</span> <span data-start="212.639" data-end="214.079">until an item that matches some</span> <span data-start="214.079" data-end="217.26">condition for example so that's really</span> <span data-start="217.26" data-end="220.709">powerful for maths and sequences and</span> <span data-start="220.709" data-end="222.989">things and later I'm going to show you</span> <span data-start="222.989" data-end="224.31">how it can be really useful for</span> <span data-start="224.31" data-end="228.51">asynchronous programming as well so to</span> <span data-start="228.51" data-end="229.799">get back to the original point of</span> <span data-start="229.799" data-end="231.689">asynchronous programming I'm going to</span> <span data-start="231.689" data-end="234.12">follow through a simple example say we</span> <span data-start="234.12" data-end="236.189">want to write a function that reads a</span> <span data-start="236.189" data-end="239.129">file and passes it as JSON and returns</span> <span data-start="239.129" data-end="241.65">the result it's a fairly simple thing</span> <span data-start="241.65" data-end="243.93">and it's a task that I'm sure many of</span> <span data-start="243.93" data-end="245.04">you have had to do at some point</span> <span data-start="245.04" data-end="246.72">especially if you're writing server-side</span> <span data-start="246.72" data-end="248.729">code would you write jar if you write</span> <span data-start="248.729" data-end="250.259">client-side code you can think of this</span> <span data-start="250.259" data-end="251.939">as just making a web request and then</span> <span data-start="251.939" data-end="255.03">parsing that is JSON nothing I'm talking</span> <span data-start="255.03" data-end="259.019">about is really specific to note the so</span> <span data-start="259.019" data-end="260.699">this function is really about as simple</span> <span data-start="260.699" data-end="262.77">as it can can be to accomplish this</span> <span data-start="262.77" data-end="265.56">functionality it takes a filename it</span> <span data-start="265.56" data-end="269.07">reads that file with utf-8 encoding so</span> <span data-start="269.07" data-end="271.409">it gets a string back and then it passes</span> <span data-start="271.409" data-end="274.56">it as JSON and returns the result if at</span> <span data-start="274.56" data-end="276.659">any point one of these methods froze an</span> <span data-start="276.659" data-end="278.789">error if the read file operation froze</span> <span data-start="278.789" data-end="281.669">an error or the JSON pars operation</span> <span data-start="281.669" data-end="283.65">frozen error then it's going to bubble</span> <span data-start="283.65" data-end="285.75">up the stack and we can handle that at</span> <span data-start="285.75" data-end="288.03">some top level where we know</span> <span data-start="288.03" data-end="289.35">or information about how we should</span> <span data-start="289.35" data-end="291.87">handle it so all of the errors propagate</span> <span data-start="291.87" data-end="294.81">nicely the results return nicely and</span> <span data-start="294.81" data-end="299.01">it's a really simple function to read so</span> <span data-start="299.01" data-end="301.32">we we can make that asynchronous if we</span> <span data-start="301.32" data-end="303.12">don't make it asynchronous it's going to</span> <span data-start="303.12" data-end="305.13">block the program and nothing else is</span> <span data-start="305.13" data-end="306.63">going to happen if it's a client side</span> <span data-start="306.63" data-end="308.94">app and you do synchronous i/o then</span> <span data-start="308.94" data-end="310.68">you're going to be freezing the</span> <span data-start="310.68" data-end="311.94">application nothing's going to happen</span> <span data-start="311.94" data-end="314.1">for a while if you're doing a server and</span> <span data-start="314.1" data-end="316.5">you do synchronous i/o then you're not</span> <span data-start="316.5" data-end="317.97">going to be handling any other requests</span> <span data-start="317.97" data-end="319.8">for a while so you're going to</span> <span data-start="319.8" data-end="321.99">effectively the this server will appear</span> <span data-start="321.99" data-end="325.38">to be down to everyone else so we can</span> <span data-start="325.38" data-end="327.51">make this asynchronous just by taking a</span> <span data-start="327.51" data-end="330.3">callback so we add a second argument to</span> <span data-start="330.3" data-end="332.4">the read JSON function that's callback</span> <span data-start="332.4" data-end="335.04">and we then also pass a function to our</span> </p>
<p><span data-start="335.04" data-end="338.52">FS read file we then say if there's an</span> <span data-start="338.52" data-end="341.46">error we call back with the error and if</span> <span data-start="341.46" data-end="343.53">there's not then we call back with null</span> <span data-start="343.53" data-end="346.11">as our error argument and the result as</span> <span data-start="346.11" data-end="348.93">the second argument this isn't a lot</span> <span data-start="348.93" data-end="352.53">more complicated than then the first</span> <span data-start="352.53" data-end="355.41">function we wrote but I wanted to show</span> <span data-start="355.41" data-end="357.24">you today that this isn't sufficient</span> <span data-start="357.24" data-end="359.7">this code is a long way off a complete</span> <span data-start="359.7" data-end="362.82">implementation of read a Sun and we can</span> <span data-start="362.82" data-end="365.94">do better so this is conflating the</span> <span data-start="365.94" data-end="368.19">input with the output it's kind of a</span> <span data-start="368.19" data-end="369.93">subtle point and it might not seem like</span> <span data-start="369.93" data-end="371.94">it's important but it turns out to have</span> <span data-start="371.94" data-end="375.18">lots of effects down the line so we're</span> <span data-start="375.18" data-end="377.01">going from our really simple model of</span> <span data-start="377.01" data-end="379.38">having arguments as inputs to functions</span> <span data-start="379.38" data-end="382.5">and some return value as the result to</span> <span data-start="382.5" data-end="385.14">now having this additional argument that</span> <span data-start="385.14" data-end="387.96">represents how to how to send the result</span> <span data-start="387.96" data-end="390.63">back that callback isn't really an input</span> <span data-start="390.63" data-end="392.31">to the function it's just part of the</span> <span data-start="392.31" data-end="396.84">mechanics it's relies on pure convention</span> <span data-start="396.84" data-end="399.06">that we that we passed the error is the</span> <span data-start="399.06" data-end="401.73">first as the first argument and the</span> <span data-start="401.73" data-end="403.41">result as the second argument and that</span> <span data-start="403.41" data-end="405.03">we don't do weird things like call the</span> <span data-start="405.03" data-end="408.45">call back multiple times so that can be</span> <span data-start="408.45" data-end="411.36">real problem later down the line it also</span> <span data-start="411.36" data-end="413.22">won't work with control flow primitives</span> <span data-start="413.22" data-end="415.23">it's really difficult to do an</span> <span data-start="415.23" data-end="417.39">asynchronous operation in the middle of</span> <span data-start="417.39" data-end="419.42">a for loop using this kind of technique</span> <span data-start="419.42" data-end="421.59">it's just not going to work you're going</span> <span data-start="421.59" data-end="421.96">to</span> <span data-start="421.96" data-end="424.87">you can't pause the for-loop while</span> <span data-start="424.87" data-end="427.83">executing this asynchronous function</span> <span data-start="427.83" data-end="430.9">this currently doesn't handle errors so</span> <span data-start="430.9" data-end="433.12">this has a major flaw if I try and read</span> <span data-start="433.12" data-end="435.97">a JSON file that turns out not to be</span> <span data-start="435.97" data-end="439.3">valid JSON that exists so the filesystem</span> <span data-start="439.3" data-end="442.449">read succeeds or the web requests if we</span> <span data-start="442.449" data-end="445.27">were on the client but where the</span> <span data-start="445.27" data-end="447.94">json.parse bit fails and frozen error</span> <span data-start="447.94" data-end="451.18">that error can't be caught anywhere it's</span> <span data-start="451.18" data-end="453.539">going to be thrown into the global scope</span> <span data-start="453.539" data-end="457.15">because we're not handling it so that's</span> <span data-start="457.15" data-end="459.639">simple to fix we just have to use a</span> <span data-start="459.639" data-end="463.479">try-catch so now we've wrapped the the</span> <span data-start="463.479" data-end="465.19">bit that does the JSON parsing in a</span> <span data-start="465.19" data-end="467.65">try-catch and if there's an error we</span> <span data-start="467.65" data-end="470.86">call the callback with an error this</span> <span data-start="470.86" data-end="472.15">still conflates the input with the</span> <span data-start="472.15" data-end="474.28">output it still won't work with control</span> <span data-start="474.28" data-end="475.93">flow primitives but it does handle</span> <span data-start="475.93" data-end="478.09">errors in JSON path so we've got a bit</span> <span data-start="478.09" data-end="480.55">of a win there we have a might a</span> <span data-start="480.55" data-end="483.069">slightly subtle of floor though we're</span> <span data-start="483.069" data-end="486.52">handling errors in the callback twice so</span> <span data-start="486.52" data-end="491.259">if if the filesystem Reedus succeeds the</span> </p>
<p><span data-start="491.259" data-end="494.25">JSON path succeeds we call the callback</span> <span data-start="494.25" data-end="496.62">but then that callback frozen error</span> <span data-start="496.62" data-end="498.61">we're going to callback call the</span> <span data-start="498.61" data-end="500.62">callback again when really what we</span> <span data-start="500.62" data-end="502.889">should do is just crash the application</span> <span data-start="502.889" data-end="505.449">so if you can you can see this in action</span> <span data-start="505.449" data-end="508.599">if we were to do a read JSON with a</span> <span data-start="508.599" data-end="510.729">callback which froze an error and</span> <span data-start="510.729" data-end="513.76">increment some integer each time so you</span> <span data-start="513.76" data-end="515.26">can see here that n should be</span> <span data-start="515.26" data-end="517.3">incremented once but will actually get</span> <span data-start="517.3" data-end="520.3">incremented twice and this seems like a</span> <span data-start="520.3" data-end="522.789">slightly obscure example but this could</span> <span data-start="522.789" data-end="524.829">manifest itself with additional log</span> <span data-start="524.829" data-end="526.57">messages if you're logging the error or</span> <span data-start="526.57" data-end="528.73">really weird behavior if you're actually</span> <span data-start="528.73" data-end="530.29">doing something with these errors and</span> <span data-start="530.29" data-end="538.42">handling them properly so we can fix</span> <span data-start="538.42" data-end="540.94">that all we need to do is make sure that</span> <span data-start="540.94" data-end="543.73">we're not calling the callback inside of</span> <span data-start="543.73" data-end="548.5">the try catch so this code makes sure</span> <span data-start="548.5" data-end="550.24">that the only thing we do inside the try</span> <span data-start="550.24" data-end="552.85">catch is pars the JSON and then we</span> <span data-start="552.85" data-end="555.22">actually call the callback outside of</span> <span data-start="555.22" data-end="558.6">the try catch now this fixes the bug</span> <span data-start="558.6" data-end="560.65">we're still conflating the input with</span> <span data-start="560.65" data-end="562.42">output we're still not working with</span> <span data-start="562.42" data-end="564.459">control flow primitives but we are at</span> <span data-start="564.459" data-end="566.829">least handling errors now this was a</span> <span data-start="566.829" data-end="569.47">this this code might seem like a weird</span> <span data-start="569.47" data-end="571.24">bug you might think I'd never write code</span> <span data-start="571.24" data-end="574.66">like that but a very popular library</span> </p>
<p><span data-start="574.66" data-end="578.199">Jade has had this exact bug for several</span> <span data-start="578.199" data-end="579.97">years and it was only fixed about a</span> <span data-start="579.97" data-end="583.06">month ago so these these bugs are</span> <span data-start="583.06" data-end="584.98">happening in real code I'm not making</span> <span data-start="584.98" data-end="589.48">these up and it's afoot so now we've got</span> <span data-start="589.48" data-end="591.52">this fixed function this this function</span> <span data-start="591.52" data-end="593.65">works it's an implementation of read</span> <span data-start="593.65" data-end="595.6">JSON as I'd expect to see it in a</span> <span data-start="595.6" data-end="600.1">typical nodejs program but it's a far</span> <span data-start="600.1" data-end="602.41">cry from that simple function we started</span> <span data-start="602.41" data-end="605.17">with this is the real semantics we want</span> <span data-start="605.17" data-end="607.06">to express we want to express these</span> <span data-start="607.06" data-end="609.64">semantics and just the additional bit of</span> <span data-start="609.64" data-end="611.68">information that the file system reads</span> <span data-start="611.68" data-end="614.14">should be asynchronous so we need</span> <span data-start="614.14" data-end="616">something simpler we don't want to talk</span> <span data-start="616" data-end="617.41">about error handling because the error</span> <span data-start="617.41" data-end="619.48">handling we're asking for should be the</span> <span data-start="619.48" data-end="624.06">default anyway so imagine for the moment</span> <span data-start="624.06" data-end="627.85">the asynchronous methods still return</span> <span data-start="627.85" data-end="629.709">values asynchronous functions are still</span> <span data-start="629.709" data-end="634.15">going to return something these values</span> <span data-start="634.15" data-end="635.65">obviously won't be something we can use</span> <span data-start="635.65" data-end="637.24">directly because they're going to have</span> <span data-start="637.24" data-end="639.91">to return this value synchronously but</span> <span data-start="639.91" data-end="641.529">they're going to execute asynchronously</span> <span data-start="641.529" data-end="642.88">so we don't know what that value</span> <span data-start="642.88" data-end="645.76">represents yet but we can somehow await</span> <span data-start="645.76" data-end="648.459">it we can somehow say tell me when this</span> <span data-start="648.459" data-end="651.339">value is is settled tell me when we know</span> <span data-start="651.339" data-end="655.18">what this value actually represents so</span> <span data-start="655.18" data-end="657.88">we have such a value in JavaScript it's</span> <span data-start="657.88" data-end="659.589">called a promise there are a number of</span> <span data-start="659.589" data-end="662.14">implementations of it Q is extremely</span> <span data-start="662.14" data-end="663.85">popular I maintain my own promise</span> <span data-start="663.85" data-end="666.04">library called promise and PM installed</span> <span data-start="666.04" data-end="669.68">promise if you're using node and</span> <span data-start="669.69" data-end="672.49">so promis represents the result of an</span> <span data-start="672.49" data-end="674.8">asynchronous operation it can be in one</span> <span data-start="674.8" data-end="677.14">of three states loosely so it can be</span> <span data-start="677.14" data-end="679.72">pending or it can be fulfilled or it can</span> <span data-start="679.72" data-end="682.9">be rejected so every promise starts out</span> <span data-start="682.9" data-end="685.6">pending and then transitions into either</span> <span data-start="685.6" data-end="687.22">fulfilled or rejected</span> <span data-start="687.22" data-end="689.41">and once it's transitioned into one of</span> <span data-start="689.41" data-end="692.11">those states it's immutable it'll never</span> <span data-start="692.11" data-end="694.54">change back to being pending it'll never</span> <span data-start="694.54" data-end="696.64">go from fulfilled to reject it or reject</span> <span data-start="696.64" data-end="699.67">it to fulfilled so we can implement read</span> <span data-start="699.67" data-end="703.09">file in to return a promise based on the</span> <span data-start="703.09" data-end="707.98">built in nodejs FS read file function so</span> <span data-start="707.98" data-end="709.93">we start by saying we're going to return</span> <span data-start="709.93" data-end="712.59">a new promise and we give the promise</span> <span data-start="712.59" data-end="714.85">constructor a function that represents</span> <span data-start="714.85" data-end="716.86">the asynchronous work we're going to do</span> <span data-start="716.86" data-end="719.86">and that function gets given a full film</span> <span data-start="719.86" data-end="723.37">function and a reject function and we</span> <span data-start="723.37" data-end="725.56">use those inside the method to control</span> <span data-start="725.56" data-end="728.35">the result of the promise so we do the</span> <span data-start="728.35" data-end="730.72">read file operation and if the refile</span> <span data-start="730.72" data-end="733.48">operation fails we reject the resulting</span> <span data-start="733.48" data-end="736.33">promise and if the read file operation</span> <span data-start="736.33" data-end="738.31">succeeds we fulfill the resulting</span> <span data-start="738.31" data-end="740.96">promise</span> <span data-start="740.97" data-end="744.46">so having built that we can use the done</span> <span data-start="744.46" data-end="747.96">method to await the result of a promise</span> <span data-start="747.96" data-end="750.52">so this is how we could build our read</span> </p>
<p><span data-start="750.52" data-end="754.15">JSON function so this read JSON function</span> <span data-start="754.15" data-end="756.97">again returns a new promise with these</span> <span data-start="756.97" data-end="759.28">fulfill and the reject parameters</span> <span data-start="759.28" data-end="762.67">available it does the read file and when</span> <span data-start="762.67" data-end="765.82">that's done it tries to fulfill with the</span> <span data-start="765.82" data-end="769.69">JSON with a JSON pars result failing</span> <span data-start="769.69" data-end="771.96">that it rejects with the exception and</span> <span data-start="771.96" data-end="774.82">if the read file operation fails it</span> <span data-start="774.82" data-end="777.13">rejects with the exception so done takes</span> <span data-start="777.13" data-end="780.79">two arguments the first of which is an</span> <span data-start="780.79" data-end="784.18">unfulfilled callback and the latter is</span> <span data-start="784.18" data-end="791.95">an unregenerate of waiting for the</span> <span data-start="791.95" data-end="796.42">promise to fulfill it doesn't complete</span> <span data-start="796.42" data-end="798.04">the input with the output anymore we're</span> <span data-start="798.04" data-end="800.2">now returning this value so you can see</span> <span data-start="800.2" data-end="802.72">the arguments through for both the read</span> <span data-start="802.72" data-end="803.11">file</span> <span data-start="803.11" data-end="806.019">and the read JSON functions are back how</span> <span data-start="806.019" data-end="807.88">they should be they're just the input</span> <span data-start="807.88" data-end="810.16">read file takes a filename and in</span> <span data-start="810.16" data-end="813.339">encoding and read JSON just takes the</span> <span data-start="813.339" data-end="815.35">filename we don't have that additional</span> <span data-start="815.35" data-end="817.93">parameter it's still not going to work</span> <span data-start="817.93" data-end="819.43">with control flow primitives that</span> <span data-start="819.43" data-end="822.73">requires language support it does still</span> <span data-start="822.73" data-end="824.44">require a lot of extra work to handle</span> <span data-start="824.44" data-end="826.51">errors so we've still got that try-catch</span> <span data-start="826.51" data-end="829.24">in there which is a bit pointless it's</span> <span data-start="829.24" data-end="831.82">nothing to do with our hand our actual</span> <span data-start="831.82" data-end="835.779">application business logic so we really</span> <span data-start="835.779" data-end="837.85">want to get that out we have at least</span> <span data-start="837.85" data-end="839.41">made a slight win though</span> <span data-start="839.41" data-end="841.75">and the this double handling of the</span> <span data-start="841.75" data-end="843.94">callbacks is how it is dealt with for us</span> <span data-start="843.94" data-end="848.49">the promise libraries all promise not</span> <span data-start="848.49" data-end="851.17">not to throw an exception when you call</span> <span data-start="851.17" data-end="853.149">fulfill which means we're not double</span> <span data-start="853.149" data-end="854.589">handling any errors we don't need to</span> <span data-start="854.589" data-end="858.04">worry about that at least we can do</span> <span data-start="858.04" data-end="860.89">better when you start it out I bet many</span> <span data-start="860.89" data-end="863.709">of you used for each when you when you</span> <span data-start="863.709" data-end="866.23">had one array and need another ray that</span> <span data-start="866.23" data-end="868.54">was based on that first array and I bet</span> <span data-start="868.54" data-end="870.85">most of you now use map in a lot of</span> <span data-start="870.85" data-end="872.56">cases where you'd have used for each</span> <span data-start="872.56" data-end="875.35">when you start it out so map lets you</span> <span data-start="875.35" data-end="877.63">transform each of the items in an array</span> <span data-start="877.63" data-end="879.76">and get a new array without having to</span> <span data-start="879.76" data-end="881.82">manually construct that array yourself</span> <span data-start="881.82" data-end="885.55">we have a similar system in promises so</span> <span data-start="885.55" data-end="888.459">done just lets you extract the value of</span> <span data-start="888.459" data-end="891.1">a promise but we have a method called</span> <span data-start="891.1" data-end="893.41">then which lets you transform the</span> <span data-start="893.41" data-end="896.26">promise into a new promise that's based</span> <span data-start="896.26" data-end="900.31">on that first promise so using that we</span> <span data-start="900.31" data-end="903.73">can rewrite our asynchronous read JSON</span> <span data-start="903.73" data-end="907.24">function just as read file filename</span> <span data-start="907.24" data-end="912.459">encoding then json dot parse so here</span> <span data-start="912.459" data-end="914.829">what we're doing is the then method is</span> <span data-start="914.829" data-end="917.86">creating a new promise based on the</span> <span data-start="917.86" data-end="919.93">previous promise so if the previous</span> <span data-start="919.93" data-end="922.899">promise is rejected then by default this</span> <span data-start="922.899" data-end="925.329">new promise this child promise gets</span> <span data-start="925.329" data-end="927.73">rejected as well so that propagation</span> <span data-start="927.73" data-end="929.35">happens automatically we don't need to</span> <span data-start="929.35" data-end="931.99">handle that anymore and the unfulfilled</span> <span data-start="931.99" data-end="935.319">if there if unfulfilled so that the</span> <span data-start="935.319" data-end="936.18">first method</span> <span data-start="936.18" data-end="938.04">the pastor then is a non fulfilled</span> <span data-start="938.04" data-end="940.98">handler if that if that method frozen</span> <span data-start="940.98" data-end="942.839">error then we reject the resulting</span> <span data-start="942.839" data-end="944.61">promise that happens automatically for</span> <span data-start="944.61" data-end="945.93">us so we don't need this try-catch</span> <span data-start="945.93" data-end="948.45">anymore and if the if that method</span> <span data-start="948.45" data-end="950.91">returns a value then that's used as the</span> <span data-start="950.91" data-end="952.709">result that's what the promise is</span> <span data-start="952.709" data-end="955.11">resolved with so we don't need any messy</span> <span data-start="955.11" data-end="957.6">callback stuff anymore we're just</span> <span data-start="957.6" data-end="960.779">dealing with the pure simple business</span> <span data-start="960.779" data-end="964.02">logic now here we have a function that</span> <span data-start="964.02" data-end="966.029">takes a single argument and passes that</span> <span data-start="966.029" data-end="967.62">single argument to another function and</span> <span data-start="967.62" data-end="969.54">returns the result so we can simplify</span> <span data-start="969.54" data-end="971.37">that a little bit by just passing</span> <span data-start="971.37" data-end="974.339">json.parse directly note that I'm not</span> <span data-start="974.339" data-end="976.47">calling JSON docpods there I'm passing</span> <span data-start="976.47" data-end="980.19">it as a function as the argument this</span> <span data-start="980.19" data-end="981.45">doesn't conflate the input with the</span> <span data-start="981.45" data-end="983.43">output we're returning a promise from</span> <span data-start="983.43" data-end="986.279">all of our functions it still won't work</span> <span data-start="986.279" data-end="988.98">with control flow primitives yet but it</span> <span data-start="988.98" data-end="990.99">handles errors and it handles them</span> <span data-start="990.99" data-end="992.79">really gracefully we haven't added any</span> <span data-start="992.79" data-end="995.55">extra code to handle those errors they</span> <span data-start="995.55" data-end="997.38">just bubble up the stack just like they</span> <span data-start="997.38" data-end="1000.709">would in synchronous code so we can</span> <span data-start="1000.709" data-end="1004.06">still do better though this is still</span> <span data-start="1004.06" data-end="1006.86">this is still a really simple example it</span> <span data-start="1006.86" data-end="1008.42">doesn't have any for loops in it it</span> <span data-start="1008.42" data-end="1010.49">doesn't have try-catch it doesn't have</span> <span data-start="1010.49" data-end="1012.89">while we want to be able to get back the</span> <span data-start="1012.89" data-end="1015.17">ability to use those control flux</span> <span data-start="1015.17" data-end="1018.08">control flow structures to manage our</span> <span data-start="1018.08" data-end="1022.16">code so what if we could await a promise</span> <span data-start="1022.16" data-end="1023.48">somehow what if we could pause a</span> <span data-start="1023.48" data-end="1026.929">function mid execution and wait for the</span> <span data-start="1026.929" data-end="1029.839">promise to resolve well as way as I</span> <span data-start="1029.839" data-end="1031.16">mentioned at the beginning of the talk</span> <span data-start="1031.16" data-end="1033.709">we have a method for pausing a function</span> <span data-start="1033.709" data-end="1036.23">mid execution because that's what yield</span> <span data-start="1036.23" data-end="1041.809">does so with an async helper we can make</span> <span data-start="1041.809" data-end="1044.87">yield effectively wait for a promise to</span> <span data-start="1044.87" data-end="1048.5">resolve and return the result so at the</span> <span data-start="1048.5" data-end="1049.64">top there you can see our original</span> <span data-start="1049.64" data-end="1053.72">synchronous JSON function and at the</span> <span data-start="1053.72" data-end="1056.42">bottom you can see our asynchronous JSON</span> <span data-start="1056.42" data-end="1058.46">function and you can see all that</span> <span data-start="1058.46" data-end="1061.37">changes is that we add the keyword we</span> <span data-start="1061.37" data-end="1063.86">add the async function the async wrapper</span> <span data-start="1063.86" data-end="1067.1">the star which denotes a generator</span> <span data-start="1067.1" data-end="1067.88">function</span> <span data-start="1067.88" data-end="1070.13">and they yield to tell us that we're</span> <span data-start="1070.13" data-end="1071.39">going to wait for that promise to</span> <span data-start="1071.39" data-end="1074.72">resolve this doesn't complete the input</span> <span data-start="1074.72" data-end="1077.21">with the output this will work with</span> <span data-start="1077.21" data-end="1080.15">control flow primitives this handles</span> <span data-start="1080.15" data-end="1082.61">errors and it remains looking</span> <span data-start="1082.61" data-end="1085.1">asynchronous it has just enough clues in</span> <span data-start="1085.1" data-end="1088.04">there but I can read this code and know</span> <span data-start="1088.04" data-end="1089.21">instantly that it's going to be doing</span> <span data-start="1089.21" data-end="1091.79">something asynchronous we have the async</span> <span data-start="1091.79" data-end="1093.65">keyword that tells us that function is</span> <span data-start="1093.65" data-end="1095.06">the function as a whole is asynchronous</span> <span data-start="1095.06" data-end="1098.45">and we have the yield keyword telling us</span> <span data-start="1098.45" data-end="1100.22">exactly where that asynchrony is going</span> <span data-start="1100.22" data-end="1104.54">to happen so we can use this to do</span> <span data-start="1104.54" data-end="1107.09">things like a sequence of operations we</span> <span data-start="1107.09" data-end="1109.43">can read one file then read another file</span> <span data-start="1109.43" data-end="1112.13">just by doing multiple yields and then</span> <span data-start="1112.13" data-end="1114.74">we can use the result because promises</span> <span data-start="1114.74" data-end="1116.93">are first-class values we can fairly</span> <span data-start="1116.93" data-end="1119.57">easily do the same thing in parallel</span> <span data-start="1119.57" data-end="1122.24">just by starting in both operations and</span> <span data-start="1122.24" data-end="1124.88">storing the promise that for each of</span> <span data-start="1124.88" data-end="1127.73">those operations in turn and then having</span> <span data-start="1127.73" data-end="1130.58">started both operations we then wait for</span> <span data-start="1130.58" data-end="1132.59">them one at a time which leads to the</span> <span data-start="1132.59" data-end="1135.02">actual IO happening in parallel and</span> <span data-start="1135.02" data-end="1138.05">since the IO bit is the slow bit that's</span> <span data-start="1138.05" data-end="1142.88">really what we want like I said it</span> <span data-start="1142.88" data-end="1145.34">worked with control flow it with the</span> <span data-start="1145.34" data-end="1148.07">normal control flow structures so we can</span> <span data-start="1148.07" data-end="1150.17">do this inside a try-catch if we have</span> <span data-start="1150.17" data-end="1153.38">some asynchronous get key method we can</span> <span data-start="1153.38" data-end="1155.96">put it inside a try-catch and have some</span> <span data-start="1155.96" data-end="1160.58">handler in the catch block we can use it</span> <span data-start="1160.58" data-end="1163.04">inside for loops say we have an upload</span> <span data-start="1163.04" data-end="1165.65">method to upload a document and we want</span> <span data-start="1165.65" data-end="1167.42">to upload multiple documents one at a</span> <span data-start="1167.42" data-end="1170.06">time we can just loop over the documents</span> <span data-start="1170.06" data-end="1172.19">and upload them one at a time a</span> <span data-start="1172.19" data-end="1175.52">synchronously so the result of this is a</span> <span data-start="1175.52" data-end="1177.41">is a promise so this function is a</span> <span data-start="1177.41" data-end="1179.54">function that returns a promise it's</span> <span data-start="1179.54" data-end="1182">asynchronous in its own right and it's</span> <span data-start="1182" data-end="1183.74">using these asynchronous methods</span> <span data-start="1183.74" data-end="1186.44">internally if we wanted to do a parallel</span> <span data-start="1186.44" data-end="1189.08">one one option would be to start off all</span> <span data-start="1189.08" data-end="1192.62">the operations in one at a time and then</span> <span data-start="1192.62" data-end="1194.33">wait for them all to complete one at a</span> <span data-start="1194.33" data-end="1197.69">time there are helper methods in most</span> <span data-start="1197.69" data-end="1199.19">promise libraries that mean that there</span> <span data-start="1199.19" data-end="1202.21">are easier ways you could do this</span> <span data-start="1202.21" data-end="1204.049">so I want to talk about how it works</span> <span data-start="1204.049" data-end="1206.96">under the hood like initially that can</span> <span data-start="1206.96" data-end="1209.24">look like a lot like magic I don't know</span> <span data-start="1209.24" data-end="1211.58">my my first reaction to this is that</span> <span data-start="1211.58" data-end="1214.01">seems like a lot of magic but it's</span> <span data-start="1214.01" data-end="1218.12">actually relatively simple so yield of</span> <span data-start="1218.12" data-end="1221.179">some expression is itself an expression</span> <span data-start="1221.179" data-end="1225.77">yield evaluates to something and a</span> <span data-start="1225.77" data-end="1228.26">generator can be manually operated using</span> <span data-start="1228.26" data-end="1230.87">the next method so you can take a</span> <span data-start="1230.87" data-end="1233.51">generator and rolling using a four of</span> <span data-start="1233.51" data-end="1236.51">loop to loop through it you can manually</span> <span data-start="1236.51" data-end="1238.7">say give me the next value</span> <span data-start="1238.7" data-end="1240.799">give me the next value give me the next</span> <span data-start="1240.799" data-end="1244.79">value so say we have a simple generator</span> <span data-start="1244.79" data-end="1248.33">here this generator yields ten asserts</span> <span data-start="1248.33" data-end="1251.45">that the result of yielding 10 is 32 and</span> <span data-start="1251.45" data-end="1256.16">then returns 42 we can execute this</span> <span data-start="1256.16" data-end="1260.09">manually first of all we call demo which</span> <span data-start="1260.09" data-end="1263">instantiates the generator this returns</span> <span data-start="1263" data-end="1266.54">an iterator or generator and we can call</span> <span data-start="1266.54" data-end="1269.059">next on it and that moves the point the</span> <span data-start="1269.059" data-end="1271.64">control flow pointer to that first yield</span> <span data-start="1271.64" data-end="1275.57">expression it returns us the thing</span> <span data-start="1275.57" data-end="1277.52">that's been yielded which in this case</span> <span data-start="1277.52" data-end="1280.76">is the ten and something that a Tanner</span> <span data-start="1280.76" data-end="1284.09">and a done property that tells us that</span> <span data-start="1284.09" data-end="1286.429">it's not finished yet there are there</span> <span data-start="1286.429" data-end="1288.549">are potentially more values to yield</span> <span data-start="1288.549" data-end="1291.26">it's not the end of a function and it's</span> <span data-start="1291.26" data-end="1294.62">not a return keyword we can then use d</span> <span data-start="1294.62" data-end="1298.94">dot next again to move to carry on but</span> <span data-start="1298.94" data-end="1301.82">if we like we can feed it a value to</span> <span data-start="1301.82" data-end="1305.12">return from that yield so by fielding it</span> <span data-start="1305.12" data-end="1308.48">by feeding it that 30 to there we're</span> <span data-start="1308.48" data-end="1310.4">able to inject that value into the</span> <span data-start="1310.4" data-end="1312.95">function and that becomes the value of</span> <span data-start="1312.95" data-end="1315.65">res inside the function hence the assert</span> <span data-start="1315.65" data-end="1319.7">path since the result we then get is 42</span> <span data-start="1319.7" data-end="1321.65">which is the result from the return and</span> <span data-start="1321.65" data-end="1325.25">the done property is true because it's</span> <span data-start="1325.25" data-end="1328.73">the last operation if we call D dot next</span> <span data-start="1328.73" data-end="1330.32">again it's going to throw because that</span> <span data-start="1330.32" data-end="1333.44">function is done it's finished so we</span> <span data-start="1333.44" data-end="1335.11">can't carry on using it</span> <span data-start="1335.11" data-end="1338.6">now generators were created with this</span> <span data-start="1338.6" data-end="1340.97">use case in mind as one of the possible</span> <span data-start="1340.97" data-end="1343.67">use cases and as a result we have this</span> <span data-start="1343.67" data-end="1349.04">really helpful method afro now fro takes</span> <span data-start="1349.04" data-end="1350.84">an error it doesn't have to be an error</span> <span data-start="1350.84" data-end="1353.15">you can pass it like 10 if you want to</span> <span data-start="1353.15" data-end="1354.83">but I'd strongly recommend you use</span> <span data-start="1354.83" data-end="1355.4">errors</span> <span data-start="1355.4" data-end="1357.59">whenever you're throwing things throwing</span> <span data-start="1357.59" data-end="1359.21">errors gives you stack traces throwing</span> <span data-start="1359.21" data-end="1363.26">anything else doesn't so we can use</span> <span data-start="1363.26" data-end="1366.47">yield inside a try/catch and we can make</span> <span data-start="1366.47" data-end="1369.68">that yield throw to invoke the catch</span> <span data-start="1369.68" data-end="1373.28">operation so again we start by calling</span> <span data-start="1373.28" data-end="1376.7">demo instantiating the generator we then</span> <span data-start="1376.7" data-end="1379.1">call next to move it to that first yield</span> <span data-start="1379.1" data-end="1381.59">we get back the result that's yielded so</span> <span data-start="1381.59" data-end="1383.45">that's the 10 and the fact that it's not</span> <span data-start="1383.45" data-end="1388.1">done we can then call throw and throw an</span> <span data-start="1388.1" data-end="1390.8">error into the generator so that will</span> <span data-start="1390.8" data-end="1393.26">cause the yield expression to</span> <span data-start="1393.26" data-end="1396.26">effectively throw that error and cause</span> <span data-start="1396.26" data-end="1399.65">the catch block to be executed so that</span> <span data-start="1399.65" data-end="1402.5">allows us on the one hand to represent</span> <span data-start="1402.5" data-end="1404.63">fulfilling so this is promises being</span> <span data-start="1404.63" data-end="1407.12">fulfilled by injecting values into the</span> <span data-start="1407.12" data-end="1409.58">yield and we can represent promises</span> <span data-start="1409.58" data-end="1412.01">being rejected by injecting insect</span> <span data-start="1412.01" data-end="1414.17">exceptions that are thrown into the</span> <span data-start="1414.17" data-end="1417.17">yield so we can put this all together</span> <span data-start="1417.17" data-end="1419.51">and we get this surprisingly simple</span> <span data-start="1419.51" data-end="1422.36">function so this is a function wrapper</span> <span data-start="1422.36" data-end="1424.28">it returns a function when given a</span> <span data-start="1424.28" data-end="1427.04">function first thing it does is call</span> <span data-start="1427.04" data-end="1429.37">that function to return a generator and</span> <span data-start="1429.37" data-end="1431.45">that's going to be a generator that's</span> <span data-start="1431.45" data-end="1434.36">effectively an an a lazy sequence of</span> <span data-start="1434.36" data-end="1438.35">promises so we start by moving to the</span> <span data-start="1438.35" data-end="1440.99">first yield we get the first promise</span> <span data-start="1440.99" data-end="1443.03">that's yielded and we attempt to handle</span> <span data-start="1443.03" data-end="1447.74">it so handling it says if it's done then</span> <span data-start="1447.74" data-end="1449.6">it must be like a return keyword or the</span> <span data-start="1449.6" data-end="1451.55">end of a function so just return the</span> <span data-start="1451.55" data-end="1454.67">result otherwise we've been yielded a</span> <span data-start="1454.67" data-end="1456.26">promise we've been given a promise that</span> <span data-start="1456.26" data-end="1458.93">the function wants us to resolve and</span> <span data-start="1458.93" data-end="1462.26">give back the result of so we call then</span> <span data-start="1462.26" data-end="1467.15">on that promise and if it's if that</span> <span data-start="1467.15" data-end="1468.83">promise is fulfilled</span> <span data-start="1468.83" data-end="1470.78">we call generator dot next with that</span> <span data-start="1470.78" data-end="1473.51">result which lets us inject the</span> <span data-start="1473.51" data-end="1475.43">fulfilled result back into the function</span> <span data-start="1475.43" data-end="1477.89">and then we handle the next iteration</span> <span data-start="1477.89" data-end="1481.39">the next yield the next yield keyword if</span> <span data-start="1481.39" data-end="1485">the promise is rejected it's very much</span> <span data-start="1485" data-end="1487.85">the same story but we're throw so we're</span> <span data-start="1487.85" data-end="1490.4">now injecting that exception that throw</span> <span data-start="1490.4" data-end="1493.48">into the function as it's running and</span> <span data-start="1493.48" data-end="1496.49">continuing where we left off and if the</span> <span data-start="1496.49" data-end="1498.26">function inside doesn't have a try-catch</span> <span data-start="1498.26" data-end="1499.91">then that'll bubble out as an error if</span> <span data-start="1499.91" data-end="1502.64">it does have a try-catch though it'll</span> <span data-start="1502.64" data-end="1505.22">just get handled and and it can carry on</span> <span data-start="1505.22" data-end="1506.51">and there it might it might have a</span> <span data-start="1506.51" data-end="1507.98">try-catch that then awaits other</span> <span data-start="1507.98" data-end="1514.1">promises later on so generators are a</span> <span data-start="1514.1" data-end="1516.8">big win I don't think anyone I haven't</span> <span data-start="1516.8" data-end="1519.05">seen many people denying that they're</span> <span data-start="1519.05" data-end="1520.88">fantastically useful for controlling</span> <span data-start="1520.88" data-end="1524.12">your asynchronous code but there are</span> <span data-start="1524.12" data-end="1525.95">people who dispute that generator that</span> <span data-start="1525.95" data-end="1528.05">promises are the right tool for the job</span> <span data-start="1528.05" data-end="1530.66">for interacting with generators so I</span> <span data-start="1530.66" data-end="1532.67">want to give you some examples of some</span> <span data-start="1532.67" data-end="1533.69">of the other things that people have</span> <span data-start="1533.69" data-end="1535.4">done to try and manage their</span> <span data-start="1535.4" data-end="1537.38">asynchronous code I'm only going to give</span> <span data-start="1537.38" data-end="1539.9">you examples that work with the native</span> <span data-start="1539.9" data-end="1542.33">control flow structures because I'm not</span> <span data-start="1542.33" data-end="1543.38">really interested in anything that</span> <span data-start="1543.38" data-end="1546.47">doesn't but I haven't chosen difficult</span> <span data-start="1546.47" data-end="1548.03">or bad examples I just want to give you</span> <span data-start="1548.03" data-end="1549.59">a feel for what else is out there</span> <span data-start="1549.59" data-end="1551.33">and why I think they're not really</span> <span data-start="1551.33" data-end="1555.47">sufficient so streamline has been around</span> <span data-start="1555.47" data-end="1558.44">for a very long time streamline lets you</span> <span data-start="1558.44" data-end="1559.91">replace all of your callbacks with the</span> <span data-start="1559.91" data-end="1561.86">underscore character and then act as if</span> <span data-start="1561.86" data-end="1563.44">all your sync functions are synchronous</span> <span data-start="1563.44" data-end="1566.6">now this is fantastically clever but it</span> <span data-start="1566.6" data-end="1570.44">does this by read by compiling your your</span> <span data-start="1570.44" data-end="1573.26">code into some monstrosity that actually</span> <span data-start="1573.26" data-end="1575.84">handles this so that cross-compilation</span> <span data-start="1575.84" data-end="1577.94">needs to really ugly code and really</span> <span data-start="1577.94" data-end="1580.25">ugly behavior and it has a few other</span> <span data-start="1580.25" data-end="1582.5">issues so it works for control flow</span> <span data-start="1582.5" data-end="1584.45">primitives like I say that's great</span> <span data-start="1584.45" data-end="1586.81">it handles error propagation properly</span> <span data-start="1586.81" data-end="1589.1">but it's conflating the input with the</span> <span data-start="1589.1" data-end="1590.53">output again again we've got this</span> <span data-start="1590.53" data-end="1591.77">parameter</span> <span data-start="1591.77" data-end="1593.72">there's not really a parameter it's just</span> <span data-start="1593.72" data-end="1595.34">about how we return the result</span> <span data-start="1595.34" data-end="1596.84">that's the underscore we have to pass</span> <span data-start="1596.84" data-end="1598.52">everywhere that's not too much of an</span> <span data-start="1598.52" data-end="1599.05">issue</span> <span data-start="1599.05" data-end="1601.67">it also looks entirely synchronous</span> <span data-start="1601.67" data-end="1602.12">though</span> <span data-start="1602.12" data-end="1604.4">when you read that as a JavaScript</span> <span data-start="1604.4" data-end="1606.86">developer its natural to assume that the</span> <span data-start="1606.86" data-end="1608.99">function there is synchronous there's no</span> <span data-start="1608.99" data-end="1610.88">keywords that imply that this is doing</span> <span data-start="1610.88" data-end="1614.27">anything asynchronous and that to me is</span> <span data-start="1614.27" data-end="1616.88">a huge problem for maintainability and</span> <span data-start="1616.88" data-end="1619.7">it compiles to pretty ugly code and like</span> <span data-start="1619.7" data-end="1621.83">it or not sooner or later you're going</span> <span data-start="1621.83" data-end="1623.63">to end up trying to debug that code and</span> <span data-start="1623.63" data-end="1625.039">that is not code you want to be</span> <span data-start="1625.039" data-end="1629.69">debugging so suspend this is probably</span> <span data-start="1629.69" data-end="1632">one of the most ingenious libraries I've</span> <span data-start="1632" data-end="1636.26">seen in the last year so this is a way</span> <span data-start="1636.26" data-end="1639.32">of using pure callbacks nodejs style</span> <span data-start="1639.32" data-end="1642.919">callbacks with generators so it gives</span> <span data-start="1642.919" data-end="1645.44">you a callback to use everywhere let's</span> <span data-start="1645.44" data-end="1649.279">this resume you pass resume to any of</span> <span data-start="1649.279" data-end="1651.799">your asynchronous operations that you</span> <span data-start="1651.799" data-end="1655.85">want to yield on you then yield and it</span> <span data-start="1655.85" data-end="1659">yields until resume is called now this</span> <span data-start="1659" data-end="1659.75">is very clever</span> <span data-start="1659.75" data-end="1661.64">it works for control flow primitives</span> <span data-start="1661.64" data-end="1663.59">that handles errors it's conflating the</span> <span data-start="1663.59" data-end="1665.809">input with output but it has a really</span> <span data-start="1665.809" data-end="1668.779">major flaw it's really not doing what it</span> <span data-start="1668.779" data-end="1671.72">looks like it's doing so FS dot read</span> <span data-start="1671.72" data-end="1674.059">file is still the nodejs style read file</span> <span data-start="1674.059" data-end="1677.179">here it returns  so you're</span> <span data-start="1677.179" data-end="1679.789">yielding  and waiting for that</span> <span data-start="1679.789" data-end="1683.12">resume to be called so if I put the FS</span> <span data-start="1683.12" data-end="1685.25">read file on the previous line and</span> <span data-start="1685.25" data-end="1688.96">yielded some random value say 10 or 42</span> <span data-start="1688.96" data-end="1691.549">it would have exactly the same behavior</span> <span data-start="1691.549" data-end="1694.85">the yield value is ignored what that</span> <span data-start="1694.85" data-end="1697.34">means is that when you refactor it you</span> <span data-start="1697.34" data-end="1699.62">get really surprising results you can't</span> <span data-start="1699.62" data-end="1701.929">do parallel operation for example you</span> <span data-start="1701.929" data-end="1704.86">can't say read this file and store the</span> <span data-start="1704.86" data-end="1707.809">pending operation read this file store</span> <span data-start="1707.809" data-end="1709.52">that pending operation and then yield on</span> <span data-start="1709.52" data-end="1711.289">each one because then you've got a race</span> <span data-start="1711.289" data-end="1714.309">to see which one calls resume first</span> <span data-start="1714.309" data-end="1717.44">because it's the ordering of calls to</span> <span data-start="1717.44" data-end="1719.96">resume that determines which yield goes</span> <span data-start="1719.96" data-end="1725.11">with which resume so for me that that</span> <span data-start="1725.11" data-end="1727.64">cleverness there is too much cleverness</span> <span data-start="1727.64" data-end="1729.529">it's not doing what it looks like it's</span> <span data-start="1729.529" data-end="1731.419">doing and therefore I wouldn't want to</span> <span data-start="1731.419" data-end="1734.09">use that</span> <span data-start="1734.1" data-end="1737.13">next library it's very popular by its by</span> </p>
<p><span data-start="1737.13" data-end="1741.69">Vision Media TJ it's called Co so the</span> <span data-start="1741.69" data-end="1744.15">idea here is your asynchronous</span> <span data-start="1744.15" data-end="1747.12">operations also become lazy they return</span> <span data-start="1747.12" data-end="1749.18">a function that takes a call back and</span> <span data-start="1749.18" data-end="1752.82">then you yield that function that takes</span> <span data-start="1752.82" data-end="1755.34">a call back as its only parameter and Co</span> <span data-start="1755.34" data-end="1757.2">will handle calling that function for</span> <span data-start="1757.2" data-end="1759.93">you this works with control flow</span> <span data-start="1759.93" data-end="1760.62">primitives</span> <span data-start="1760.62" data-end="1763.08">it handles errors it can't do parallel</span> <span data-start="1763.08" data-end="1765.99">operation as easily because it's lazy so</span> <span data-start="1765.99" data-end="1768.3">you can't just start those operations</span> <span data-start="1768.3" data-end="1769.86">and then yield on them because they</span> <span data-start="1769.86" data-end="1772.29">won't actually start until you yield on</span> <span data-start="1772.29" data-end="1772.65">them</span> <span data-start="1772.65" data-end="1774.9">you also can't share or cache the</span> <span data-start="1774.9" data-end="1776.79">asynchronous operation so I frequently</span> <span data-start="1776.79" data-end="1781.65">cash promises as part of like database</span> <span data-start="1781.65" data-end="1783.84">reads and things caching these won't</span> <span data-start="1783.84" data-end="1785.31">help because you'll end up still</span> <span data-start="1785.31" data-end="1787.14">executing the function and you another</span> <span data-start="1787.14" data-end="1789.06">time for every time you ask for the</span> <span data-start="1789.06" data-end="1792.21">value back so it's a neat abstraction</span> <span data-start="1792.21" data-end="1794.49">it's one of the best of the of the worst</span> <span data-start="1794.49" data-end="1796.95">but I still wouldn't wouldn't recommend</span> <span data-start="1796.95" data-end="1799.23">it I'd still say promises are a lot more</span> <span data-start="1799.23" data-end="1801.72">useful a lot more powerful also this</span> <span data-start="1801.72" data-end="1803.82">offers you know help today</span> <span data-start="1803.82" data-end="1806.82">so using this method offers you no help</span> <span data-start="1806.82" data-end="1809.34">when you don't have generators it's only</span> <span data-start="1809.34" data-end="1812.13">a help when you've got generators so to</span> <span data-start="1812.13" data-end="1816.09">wrap up promises let us turn this read</span> <span data-start="1816.09" data-end="1819.27">json function which is 90% error</span> <span data-start="1819.27" data-end="1823.23">handling into a read json function that</span> <span data-start="1823.23" data-end="1825.15">just has the business logic and that</span> <span data-start="1825.15" data-end="1827.64">simple then method to indicate that</span> <span data-start="1827.64" data-end="1829.88">we're doing something a synchronous</span> <span data-start="1829.88" data-end="1833.07">generators let us turn this nested read</span> <span data-start="1833.07" data-end="1836.43">file operation with with multiple calls</span> <span data-start="1836.43" data-end="1838.17">to then which is about as simple as I</span> <span data-start="1838.17" data-end="1840.21">can write that that specific code in</span> <span data-start="1840.21" data-end="1843.09">promises into something that looks a lot</span> <span data-start="1843.09" data-end="1845.55">more like what we're used to seeing the</span> <span data-start="1845.55" data-end="1847.56">multiple operations one on each line</span> <span data-start="1847.56" data-end="1850.17">with no need no need for indentation</span> <span data-start="1850.17" data-end="1852.45">just to create that that asynchronous</span> <span data-start="1852.45" data-end="1854.27">control flow</span> </p>
<p><span data-start="1854.27" data-end="1856.53">I've been Forbes Lindsay thank you for</span> <span data-start="1856.53" data-end="1857.85">listening you can find me on Twitter</span> <span data-start="1857.85" data-end="1860.04">github I have a blog I maintain loads of</span> <span data-start="1860.04" data-end="1861.81">open source projects I work at Red Gate</span> <span data-start="1861.81" data-end="1863.49">and the slides are online if you want to</span> <span data-start="1863.49" data-end="1870.57">grab them thank you</span> <span data-start="1870.58" data-end="1880.31">you</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
