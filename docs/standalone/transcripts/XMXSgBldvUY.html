<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>XMXSgBldvUY</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/XMXSgBldvUY?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="0" data-end="1.53">shut up or when I signed up for this</span> <span data-start="1.53" data-end="4.71">talk I had no idea what was going to</span> <span data-start="4.71" data-end="8.01">happen on black friday so thankfully</span> <span data-start="8.01" data-end="13.349">this this talk is a bit more positive</span> <span data-start="13.349" data-end="16.289">than it could have otherwise been this</span> <span data-start="16.289" data-end="17.22">very much could have been a disaster</span> <span data-start="17.22" data-end="19.65">porn segment but that's not the way it</span> <span data-start="19.65" data-end="24.48">went thankfully so this is a second year</span> <span data-start="24.48" data-end="28.609">that we've done a note BF sort of</span> <span data-start="28.609" data-end="33.57">twitter campaign and basically we just</span> <span data-start="33.57" data-end="36.03">documented what what happened in our</span> <span data-start="36.03" data-end="39.66">system as we hit the most traffic that</span> <span data-start="39.66" data-end="43.5">we see throughout the year and this year</span> <span data-start="43.5" data-end="46.559">was fairly unique for myself because it</span> <span data-start="46.559" data-end="49.14">was the first year that we were doing</span> <span data-start="49.14" data-end="51.51">some fairly intensive cpu tasks within</span> <span data-start="51.51" data-end="55.05">our note environment last year we were</span> <span data-start="55.05" data-end="58.079">basically just concatenate ingela script</span> <span data-start="58.079" data-end="60.75">or sorry concatenate HTML with a little</span> <span data-start="60.75" data-end="62.879">bit of minimal JavaScript and pushing</span> <span data-start="62.879" data-end="65.01">out to the client that lightweight super</span> <span data-start="65.01" data-end="69.21">simple easy this year to try to improve</span> <span data-start="69.21" data-end="71.25">our initial page load performance as</span> <span data-start="71.25" data-end="74.369">well as our SEO we've updated a number</span> <span data-start="74.369" data-end="77.85">of our pages to render the content on</span> <span data-start="77.85" data-end="79.229">the server and then push it down to the</span> <span data-start="79.229" data-end="82.17">client so it this provides a much faster</span> <span data-start="82.17" data-end="85.56">page load I can show you some nice side</span> <span data-start="85.56" data-end="87.75">by side videos that really drive home</span> <span data-start="87.75" data-end="89.909">the point but I don't really have time</span> <span data-start="89.909" data-end="93.86">for that today or in this presentation</span> <span data-start="93.86" data-end="96.659">the the issue that this brings up is</span> <span data-start="96.659" data-end="101.28">that it's a massively different of load</span> <span data-start="101.28" data-end="104.13">on the servers its CPU versus i/o bound</span> <span data-start="104.13" data-end="108.479">and notice awesome at a thai oh wait</span> <span data-start="108.479" data-end="112.47">sorts of tasks but cpu-bound operations</span> <span data-start="112.47" data-end="115.46">using having only one thread available</span> <span data-start="115.46" data-end="119.13">can quickly smile spiral out of control</span> <span data-start="119.13" data-end="121.649">if you don't have the proper</span> <span data-start="121.649" data-end="126.659">configuration and safety mechanisms so</span> <span data-start="126.659" data-end="130.349">this is kind of what I had thought that</span> <span data-start="130.349" data-end="132.36">black friday would be and it certainly</span> <span data-start="132.36" data-end="133.63">was in the</span> <span data-start="133.63" data-end="135.16">the couple of months prior to black</span> <span data-start="135.16" data-end="139.3">friday but we actually effectively</span> <span data-start="139.3" data-end="142.33">repeated last year this is a graph of</span> <span data-start="142.33" data-end="147.49">our I believe this is the RSS loads on</span> <span data-start="147.49" data-end="150.43">the servers and they're basically flat</span> <span data-start="150.43" data-end="153.61">there's the servers were at least on</span> <span data-start="153.61" data-end="155.89">this particular metric not doing a whole</span> <span data-start="155.89" data-end="160.03">lot this is obviously a bit contrived</span> <span data-start="160.03" data-end="161.92">because the CPU is we're doing a lot of</span> <span data-start="161.92" data-end="163.54">things as well but those graphs aren't</span> <span data-start="163.54" data-end="165.58">nearly as interesting and don't drive</span> <span data-start="165.58" data-end="170.32">the point home but to do all this it</span> <span data-start="170.32" data-end="174.07">took a lot of work to to get our system</span> <span data-start="174.07" data-end="175.75">into this state that we needed it to be</span> <span data-start="175.75" data-end="179.16">when we first started deploying this</span> <span data-start="179.16" data-end="183.31">everything seemed fine under our smaller</span> <span data-start="183.31" data-end="185.35">production loads but we quickly found</span> <span data-start="185.35" data-end="190.96">that I got our first stress test we</span> <span data-start="190.96" data-end="192.64">couldn't even deliver half of the</span> <span data-start="192.64" data-end="195.28">traffic that we did last year due to</span> <span data-start="195.28" data-end="197.32">these changes and due to implementing</span> <span data-start="197.32" data-end="202.09">them in some pathological ways which was</span> <span data-start="202.09" data-end="204.28">not good needed to say there were some</span> <span data-start="204.28" data-end="206.11">concerned people in the business group</span> <span data-start="206.11" data-end="211.96">after those results but basically we</span> <span data-start="211.96" data-end="215.53">used those stress tests as well as some</span> <span data-start="215.53" data-end="217.84">pretty aggressive monitoring both during</span> <span data-start="217.84" data-end="220.23">those tests and throughout the year to</span> <span data-start="220.23" data-end="223.03">identify issues that we may have run</span> <span data-start="223.03" data-end="226.54">into between memory leaks excess of CPU</span> <span data-start="226.54" data-end="228.37">and those sorts of things and we flicked</span> <span data-start="228.37" data-end="231.04">them fix them as quickly as we could and</span> <span data-start="231.04" data-end="234.61">push the production and moved on to the</span> <span data-start="234.61" data-end="238.87">next issue which this was very helpful</span> <span data-start="238.87" data-end="245.95">we survived so I there's three big</span> <span data-start="245.95" data-end="248.709">changes that we made that helped us out</span> <span data-start="248.709" data-end="252.76">the most and in our opinion the first of</span> <span data-start="252.76" data-end="258.58">those was the event loop effectively we</span> <span data-start="258.58" data-end="260.47">were taking a system that was designed</span> <span data-start="260.47" data-end="263.979">to generate HTML on a within a browser</span> <span data-start="263.979" data-end="266.66">on the user's device</span> <span data-start="266.66" data-end="270.8">and trying to make it work under a note</span> <span data-start="270.8" data-end="273.44">environment that has very different</span> <span data-start="273.44" data-end="275.75">goals on the user's device you may want</span> <span data-start="275.75" data-end="278.66">to show partial behavior earlier or you</span> <span data-start="278.66" data-end="281.39">may want to delay the actual you may</span> <span data-start="281.39" data-end="284.15">want to run on the event loop longer in</span> <span data-start="284.15" data-end="287.9">order to show everything at the proper</span> <span data-start="287.9" data-end="290.3">time to the user and in some cases avoid</span> <span data-start="290.3" data-end="295.58">browser bugs but this led to situations</span> <span data-start="295.58" data-end="297.98">where you'd have 40 milliseconds to</span> <span data-start="297.98" data-end="301.93">render a page and that's continuous so</span> <span data-start="301.93" data-end="304.04">rendering a single page would be 40</span> <span data-start="304.04" data-end="305.66">milliseconds sitting on the event loop</span> <span data-start="305.66" data-end="310.19">and under under small loads that's not</span> <span data-start="310.19" data-end="312.4">an issue but when you start throwing</span> <span data-start="312.4" data-end="316.85">tons of crazed shoppers at the system it</span> <span data-start="316.85" data-end="319.97">very quickly destabilize this a system</span> <span data-start="319.97" data-end="322.37">and when you're in a situation that you</span> <span data-start="322.37" data-end="325.79">have event loop contention on your node</span> <span data-start="325.79" data-end="328.22">server it you can take down the entire</span> <span data-start="328.22" data-end="330.32">thing very easily it's not just that</span> <span data-start="330.32" data-end="333.41">only those routes are destabilized it's</span> <span data-start="333.41" data-end="335.87">everything so with that ties that's</span> <span data-start="335.87" data-end="337.46">basically the behavior that we saw in</span> <span data-start="337.46" data-end="341.66">our first stress test the the entire</span> <span data-start="341.66" data-end="345.23">server went down not just the the pages</span> <span data-start="345.23" data-end="348.14">that were in question here and that's</span> <span data-start="348.14" data-end="357.86">very bad so additionally we since we had</span> <span data-start="357.86" data-end="360.65">the client side rendering path that we</span> <span data-start="360.65" data-end="362.12">had to use previous years and we knew</span> <span data-start="362.12" data-end="365.54">that that worked we were able to utilize</span> <span data-start="365.54" data-end="370.88">this to failover at the at the proper</span> <span data-start="370.88" data-end="373.22">port failover if the system determined</span> <span data-start="373.22" data-end="378.08">that it was likely to hit a case where</span> <span data-start="378.08" data-end="380.06">there would be contention or just</span> <span data-start="380.06" data-end="384.53">general stress we also designed this so</span> <span data-start="384.53" data-end="387.02">that it would be automatic the point</span> <span data-start="387.02" data-end="389.6">that you're starting to have or that the</span> <span data-start="389.6" data-end="391.31">point that human could react to having</span> <span data-start="391.31" data-end="394.07">been notified by a system that email or</span> <span data-start="394.07" data-end="396.289">pager or whatever the case may be your</span> <span data-start="396.289" data-end="398.57">systems already highly unstable at that</span> <span data-start="398.57" data-end="399.249">point</span> <span data-start="399.249" data-end="402.789">and you may even depend on exactly how</span> <span data-start="402.789" data-end="405.069">its implemented if it's a wife config</span> <span data-start="405.069" data-end="408.879">push you may not be able to even talk to</span> <span data-start="408.879" data-end="413.049">the endpoints in question and restarting</span> <span data-start="413.049" data-end="414.939">servers that are already under that sort</span> <span data-start="414.939" data-end="417.279">of load can also lead to some very bad</span> <span data-start="417.279" data-end="421.299">things so you absolutely want to make</span> <span data-start="421.299" data-end="422.919">sure that if you are doing any sort of</span> <span data-start="422.919" data-end="428.019">failover it happens automatically we</span> <span data-start="428.019" data-end="431.459">also designed the system so that it was</span> <span data-start="431.459" data-end="434.499">targeted at the public use case at the</span> </p>
<p><span data-start="434.499" data-end="438.789">Googlebot at the basically at the point</span> <span data-start="438.789" data-end="440.919">that we can serve only the content to</span> <span data-start="440.919" data-end="444.429">the user that or sorry that the initial</span> <span data-start="444.429" data-end="447.129">response is only the content that is</span> <span data-start="447.129" data-end="450.819">long-lived and applies to everyone so we</span> <span data-start="450.819" data-end="452.619">split out services that would either</span> <span data-start="452.619" data-end="457.179">user specific or have data that needs to</span> <span data-start="457.179" data-end="459.459">be shorter-lived due to whatever reason</span> <span data-start="459.459" data-end="462.459">and then we pushed all this into a large</span> <span data-start="462.459" data-end="464.439">number of caches throughout the system</span> <span data-start="464.439" data-end="470.229">and found that your use case will vary</span> <span data-start="470.229" data-end="473.019">but they're having offload in a system</span> <span data-start="473.019" data-end="478.509">like this is quite important so we did</span> <span data-start="478.509" data-end="481.179">all these but there was certainly a</span> <span data-start="481.179" data-end="483.549">varied amount of impact based off of</span> <span data-start="483.549" data-end="488.529">what the based off of each different</span> <span data-start="488.529" data-end="492.369">action that we took so the event loop</span> <span data-start="492.369" data-end="495.339">was very important so was the event loop</span> <span data-start="495.339" data-end="501.099">and the event loop this change added a</span> <span data-start="501.099" data-end="502.989">lot of complexity or to our code because</span> <span data-start="502.989" data-end="506.079">we needed to support rendering</span> <span data-start="506.079" data-end="507.599">synchronously on the client and</span> <span data-start="507.599" data-end="511.119">asynchronously on the server but it had</span> <span data-start="511.119" data-end="513.279">we not made these changes I don't think</span> <span data-start="513.279" data-end="515.039">that we would have survived the holiday</span> <span data-start="515.039" data-end="519.519">or we would have had to turn things off</span> <span data-start="519.519" data-end="522.129">and toned it down gone back to the older</span> <span data-start="522.129" data-end="524.35">system or other sorts of mitigation</span> <span data-start="524.35" data-end="529.54">techniques but the failover and the</span> <span data-start="529.54" data-end="532.269">caching actually didn't matter that much</span> <span data-start="532.269" data-end="535.69">for</span> <span data-start="535.7" data-end="538.38">of course that did not work on this</span> <span data-start="538.38" data-end="545.43">resolution so this is a graph of all the</span> <span data-start="545.43" data-end="549.42">server side does execution instances of</span> <span data-start="549.42" data-end="555.51">over I believe that nature there we</span> <span data-start="555.51" data-end="558.45">found that almost no failover occurred</span> <span data-start="558.45" data-end="560.25">there were some errors down at the</span> <span data-start="560.25" data-end="563.31">bottom maybe two percent at the peak I'm</span> <span data-start="563.31" data-end="566.36">not sure you can't even see the</span> <span data-start="566.36" data-end="569.76">instances on this graph of the of the</span> <span data-start="569.76" data-end="572.31">failover or the load based veil of her</span> <span data-start="572.31" data-end="576.06">cases they were there in the raw data</span> <span data-start="576.06" data-end="581.279">but in at this scale it just it didn't</span> <span data-start="581.279" data-end="584.279">really matter whether or not those</span> <span data-start="584.279" data-end="588.089">triggers were false positives or whether</span> <span data-start="588.089" data-end="590.58">or not they had they not happened the</span> <span data-start="590.58" data-end="592.26">system would have then become unstable</span> <span data-start="592.26" data-end="595.08">is unclear but at the volume that they</span> <span data-start="595.08" data-end="597.48">did occur it's it seems like that did</span> <span data-start="597.48" data-end="600.72">not help us as much dairy under our</span> <span data-start="600.72" data-end="604.26">particular load there which kind of ties</span> <span data-start="604.26" data-end="610.2">me in sorry about that this kind of ties</span> <span data-start="610.2" data-end="613.47">me into the point that everyone should</span> <span data-start="613.47" data-end="615.839">be aware on this so there's some here be</span> <span data-start="615.839" data-end="619.589">dragons to just assuming that the things</span> <span data-start="619.589" data-end="622.079">that we did for our use case will work</span> <span data-start="622.079" data-end="624.81">for your system if you're consulting</span> <span data-start="624.81" data-end="629.7">similar things but it's certainly</span> <span data-start="629.7" data-end="631.47">helpful to know that this is the case</span> <span data-start="631.47" data-end="633.54">but you absolutely have to do your own</span> <span data-start="633.54" data-end="636.69">testing to make sure that whatever your</span> <span data-start="636.69" data-end="638.82">cat your traffic patterns whatever your</span> </p>
<p><span data-start="638.82" data-end="641.67">Black Friday is your super bowl you can</span> <span data-start="641.67" data-end="645.959">survive those sorts of situations so</span> <span data-start="645.959" data-end="649.92">i'll post these slides later some links</span> <span data-start="649.92" data-end="652.68">to the the system that we used as well</span> <span data-start="652.68" data-end="655.41">as the write up that i did on the start</span> <span data-start="655.41" data-end="657.54">of our node BF event but thank you very</span> <span data-start="657.54" data-end="659.39">much</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
