<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>rYqh5LYfw0Y</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/rYqh5LYfw0Y?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="5.65" data-end="8.26">so that's my head Twitter and all add</span> <span data-start="8.26" data-end="9.97">materially nough please ask me questions</span> <span data-start="9.97" data-end="13.38">whatever I replied most of the time so</span> <span data-start="13.38" data-end="14.769">I'm going to</span> <span data-start="14.769" data-end="16.779">to talk about the no dial you might ask</span> <span data-start="16.779" data-end="18.939">why not' well I am part of the nodejs</span> <span data-start="18.939" data-end="21.34">technical steering committee so whatever</span> <span data-start="21.34" data-end="23.02">a lot of things no J yes if you have</span> <span data-start="23.02" data-end="27.029">questions about north core thing me so</span> </p>
<p><span data-start="27.029" data-end="30.73">I'm also a principal ocular the near</span> <span data-start="30.73" data-end="31.899">forum we are a professional service</span> <span data-start="31.899" data-end="33.25">company</span> <span data-start="33.25" data-end="35.079">distributed all around the globe but</span> <span data-start="35.079" data-end="37.059">business in Ireland whatever if you need</span> <span data-start="37.059" data-end="38.62">us we are there check it out check us</span> <span data-start="38.62" data-end="42.7">out also another little bit of intro</span> <span data-start="42.7" data-end="44.92">there is these lights if you have a</span> <span data-start="44.92" data-end="46.57">laptop there are some interactive</span> <span data-start="46.57" data-end="47.86">visualizations so if you have a laptop</span> <span data-start="47.86" data-end="50.32">out and you want to play with them these</span> <span data-start="50.32" data-end="51.579">are these lights you can take a picture</span> <span data-start="51.579" data-end="55.78">whatever whatever you want so let's get</span> <span data-start="55.78" data-end="59.649">started when everybody starts with note</span> <span data-start="59.649" data-end="61.63">they start with a very simple question</span> <span data-start="61.63" data-end="65.11">how to debug a synchronous activity you</span> <span data-start="65.11" data-end="66.909">know you have a socket coming in on an</span> </p>
<p><span data-start="66.909" data-end="68.86">HTTP request coming in and you want to</span> <span data-start="68.86" data-end="73.96">react to to those activity and you know</span> <span data-start="73.96" data-end="76.36">what everybody does oh well I can use</span> <span data-start="76.36" data-end="78.1">the inspector protocol the expector</span> <span data-start="78.1" data-end="80.59">chrome inspector and I just laughs yeah</span> <span data-start="80.59" data-end="81.369">more or less</span> <span data-start="81.369" data-end="83.889">but what if we have 10 concurrent</span> <span data-start="83.889" data-end="88.78">requests a hundred how can i debug an</span> <span data-start="88.78" data-end="90.609">application running in production where</span> <span data-start="90.609" data-end="94.029">i have a lot of concurrency in place in</span> <span data-start="94.029" data-end="95.409">other I came from the Java world</span> <span data-start="95.409" data-end="98.1">whatever I've done this and I've said it</span> <span data-start="98.1" data-end="100.899">you could stop a thread single try than</span> <span data-start="100.899" data-end="102.579">just debug that you can't do that in</span> <span data-start="102.579" data-end="107.439">node so most of the stuff is because no</span> <span data-start="107.439" data-end="109.27">js' is based on a concept called the</span> <span data-start="109.27" data-end="110.95">ever loop and you'll probably are</span> <span data-start="110.95" data-end="114.189">familiar with the node event loop okay</span> <span data-start="114.189" data-end="115.42">how many of you think you are familiar</span> <span data-start="115.42" data-end="119.95">with a node event loop okay how many of</span> <span data-start="119.95" data-end="124.899">you I've seen this less people this is</span> <span data-start="124.899" data-end="127.509">this the secret sauce okay that's the</span> <span data-start="127.509" data-end="130.66">most Aiden piece of node lore that you</span> <span data-start="130.66" data-end="132.94">can find took six months to write that</span> <span data-start="132.94" data-end="135.459">guide please read it if you want to know</span> <span data-start="135.459" data-end="137.709">more about our node works and this is on</span> <span data-start="137.709" data-end="140.319">that node event loop works probably not</span> <span data-start="140.319" data-end="142.15">really easy to understand so let's</span> <span data-start="142.15" data-end="146.92">switch to a more easy to understand</span> <span data-start="146.92" data-end="148.72">version because Pro</span> <span data-start="148.72" data-end="151.27">a little bit more clear to everybody so</span> <span data-start="151.27" data-end="155.35">when the JavaScript is execute the only</span> <span data-start="155.35" data-end="157.99">thing that a node application does when</span> <span data-start="157.99" data-end="162.07">at least two i/o it talked to the kernel</span> <span data-start="162.07" data-end="164.2">a single barrier or the thread pool and</span> <span data-start="164.2" data-end="167.08">says when this event happens when this</span> <span data-start="167.08" data-end="169.75">condition happens please call back call</span> <span data-start="169.75" data-end="172.06">a function when these finishes that's</span> <span data-start="172.06" data-end="175.68">the only thing that that node does and</span> <span data-start="175.68" data-end="178.57">it is specified in passing a JavaScript</span> <span data-start="178.57" data-end="181.03">function and you know some event happens</span> <span data-start="181.03" data-end="183.61">like you are receiving some data from a</span> <span data-start="183.61" data-end="186.79">socket and that it calls back and then</span> <span data-start="186.79" data-end="188.68">wants to call that function how does</span> <span data-start="188.68" data-end="192.85">that happen that is let's see whoa there</span> <span data-start="192.85" data-end="194.83">is an event queue here and the event</span> <span data-start="194.83" data-end="197.68">queue means that all the functions are</span> <span data-start="197.68" data-end="202.48">processed one at a time so just to</span> <span data-start="202.48" data-end="205.99">repeat the dusky primetime specify a</span> <span data-start="205.99" data-end="208.18">fare other function as a listener to</span> <span data-start="208.18" data-end="211.18">some IO event and then the yo event</span> <span data-start="211.18" data-end="214.69">happens and the function is called but</span> <span data-start="214.69" data-end="217.93">you know that is one caller ID to all of</span> <span data-start="217.93" data-end="220">this we have only one function executing</span> <span data-start="220" data-end="221.92">again a given time and this is one of</span> <span data-start="221.92" data-end="224.47">the key tenants of any nodejs</span> <span data-start="224.47" data-end="227.019">and in ojs function now you might ask</span> <span data-start="227.019" data-end="229.15">why all of this matter when doing a</span> <span data-start="229.15" data-end="230.68">synchronous activity would it make these</span> <span data-start="230.68" data-end="234.25">things simpler yes and now it makes</span> <span data-start="234.25" data-end="236.62">things simpler to code however there is</span> <span data-start="236.62" data-end="239.76">one key piece that is a little bit</span> <span data-start="239.76" data-end="243.1">obscure which knowing which code is</span> <span data-start="243.1" data-end="247.54">running relative to one another also</span> <span data-start="247.54" data-end="250.81">what about next ik promises and set</span> <span data-start="250.81" data-end="253.51">immediate now which one will run first</span> <span data-start="253.51" data-end="255.7">if you schedule a promise if you run a</span> <span data-start="255.7" data-end="258.79">promise if you do next ik or if you do</span> <span data-start="258.79" data-end="261.31">set immediate you know I'm not throwing</span> <span data-start="261.31" data-end="263.169">set timeout zero in there because that's</span> <span data-start="263.169" data-end="267.43">even trickier so next it are always</span> <span data-start="267.43" data-end="269.44">executed before</span> <span data-start="269.44" data-end="273.31">promises are resolved and before any</span> <span data-start="273.31" data-end="276.669">other are your events promises are if</span> <span data-start="276.669" data-end="278.38">you do new promise the function is</span> <span data-start="278.38" data-end="280.99">executed synchronously but then resolve</span> <span data-start="280.99" data-end="282.249">are synchronously</span> <span data-start="282.249" data-end="287.169">and before any other are your events set</span> <span data-start="287.169" data-end="289.659">immediate instead exercise the full</span> <span data-start="289.659" data-end="292.959">event loop that we told you that we've</span> <span data-start="292.959" data-end="295.419">told you you know and I've not thrown in</span> <span data-start="295.419" data-end="296.859">setting itself time Abdera because</span> <span data-start="296.859" data-end="299.129">that's another level of complication so</span> <span data-start="299.129" data-end="301.929">again the artist piece of information</span> <span data-start="301.929" data-end="305.169">that the thing that when a newbie starts</span> <span data-start="305.169" data-end="307.869">working with node is to know when a</span> <span data-start="307.869" data-end="310.029">chunk of code is executed relative to</span> <span data-start="310.029" data-end="314.229">one another so going back to the</span> <span data-start="314.229" data-end="317.319">question how to debug multiple</span> <span data-start="317.319" data-end="319.119">asynchronous activity how do we do this</span> <span data-start="319.119" data-end="320.679">because you know we have multiple things</span> <span data-start="320.679" data-end="322.839">happening how do we we have a bad bug</span> <span data-start="322.839" data-end="325.239">and that is happening only when I'm</span> <span data-start="325.239" data-end="326.799">calling three different routes at the</span> <span data-start="326.799" data-end="329.589">same time and the moon is aligning and</span> </p>
<p><span data-start="329.589" data-end="331.419">Mars is over there I don't know</span> <span data-start="331.419" data-end="334.809">it really gets complicated and I don't</span> <span data-start="334.809" data-end="336.729">understand what what is happening it</span> <span data-start="336.729" data-end="340.299">here it's very hard so it goes back to</span> <span data-start="340.299" data-end="342.369">to a problem and something that we're</span> <span data-start="342.369" data-end="343.839">missing in JavaScript which is the</span> <span data-start="343.839" data-end="347.159">concept of the synchronous context so</span> <span data-start="347.159" data-end="350.799">let's look at a bad very basic HTTP</span> <span data-start="350.799" data-end="353.289">server written in ojs and you can see</span> <span data-start="353.289" data-end="355.899">that we do our HTTP create server and we</span> <span data-start="355.899" data-end="358.419">pass in a function this function in fact</span> <span data-start="358.419" data-end="361.029">when we receive an HTTP request from a</span> <span data-start="361.029" data-end="363.849">browser you have a new logical a</span> <span data-start="363.849" data-end="365.11">synchronous context that is being</span> <span data-start="365.11" data-end="367.029">created which means you know this is</span> <span data-start="367.029" data-end="368.769">your transaction this is your HTTP</span> <span data-start="368.769" data-end="371.289">request and response this is a logical</span> <span data-start="371.289" data-end="374.289">concept that is living in there okay all</span> <span data-start="374.289" data-end="376.179">the things that the Sun from this one</span> <span data-start="376.179" data-end="379.36">will be you know linked one with another</span> <span data-start="379.36" data-end="382.719">mainly because they are part of the same</span> <span data-start="382.719" data-end="384.759">closure you see it's a closure created</span> <span data-start="384.759" data-end="386.829">here so they are part of the same</span> <span data-start="386.829" data-end="388.629">closure and then when I create another</span> <span data-start="388.629" data-end="392.669">closure you know it's in here okay and</span> <span data-start="392.669" data-end="395.589">and the context is being the response is</span> <span data-start="395.589" data-end="399.61">being propagated just by using that so</span> <span data-start="399.61" data-end="403.269">it's really powerful right however there</span> <span data-start="403.269" data-end="405.039">is no concept of a synchronous context</span> <span data-start="405.039" data-end="407.259">in the JavaScript language so you know</span> <span data-start="407.259" data-end="409.569">it's something that is built in into our</span> <span data-start="409.569" data-end="411.55">browser works and how the event loop</span> <span data-start="411.55" data-end="414.789">works but there is no way to control in</span> <span data-start="414.789" data-end="416.34">any</span> <span data-start="416.34" data-end="418.42">reflection oriented way this type of</span> <span data-start="418.42" data-end="420.94">things so it's completely illogical</span> <span data-start="420.94" data-end="422.92">contest construct but is not a language</span> <span data-start="422.92" data-end="424.96">not a language feature there is some</span> <span data-start="424.96" data-end="427.09">work in making this a reality where</span> <span data-start="427.09" data-end="428.95">there is actually a concept in the</span> <span data-start="428.95" data-end="430.69">language pack and some of the wall you</span> <span data-start="430.69" data-end="432.01">can find some of the work done by the</span> </p>
<p><span data-start="432.01" data-end="434.55">Diagnostics working group in no js'</span> <span data-start="434.55" data-end="437.2">check it out and this goes a little bit</span> <span data-start="437.2" data-end="439.21">into the deep depth of this and it's</span> <span data-start="439.21" data-end="443.8">really really interesting to read then</span> <span data-start="443.8" data-end="447.22">well if there is no concept of seamless</span> <span data-start="447.22" data-end="451.6">context how can we track IO events so</span> <span data-start="451.6" data-end="453.49">how can we know when things happen you</span> <span data-start="453.49" data-end="456.37">know this is a thing called a Singh</span> <span data-start="456.37" data-end="458.23">cooks you're probably heard about a</span> </p>
<p><span data-start="458.23" data-end="461.11">Singh cooks in the past and it's one of</span> <span data-start="461.11" data-end="464.5">those you know new features of not Jas</span> <span data-start="464.5" data-end="467.13">that do that can do great things also</span> <span data-start="467.13" data-end="469.39">you know there are somewhat hard to use</span> <span data-start="469.39" data-end="471.85">this is an example of using them this</span> <span data-start="471.85" data-end="474.46">actually real real code can you</span> <span data-start="474.46" data-end="475.26">understand what it does</span> <span data-start="475.26" data-end="480.58">well it's complex and it also generates</span> <span data-start="480.58" data-end="482.32">a lot of data and I'm not going to</span> <span data-start="482.32" data-end="484.66">explain it because it's a really big</span> <span data-start="484.66" data-end="488.35">that conversation so myself and my team</span> <span data-start="488.35" data-end="489.88">we have work force each month trying to</span> <span data-start="489.88" data-end="492.16">make sense about all the stuff and how</span> <span data-start="492.16" data-end="495.34">to provide a way to reason about the</span> <span data-start="495.34" data-end="496.87">synchronous context and their</span> <span data-start="496.87" data-end="499.06">synchronous activity in node J yes so</span> <span data-start="499.06" data-end="501.16">you know and when you have this type of</span> <span data-start="501.16" data-end="503.5">question the best way to attack these</span> <span data-start="503.5" data-end="505.12">problems you know I am a software</span> <span data-start="505.12" data-end="505.99">engineer okay</span> <span data-start="505.99" data-end="509.979">by trade whatever so you know you go oh</span> <span data-start="509.979" data-end="513.339">well you ask a designer sorry we can't</span> <span data-start="513.339" data-end="515.62">do this so I ask we ask I ask a designer</span> <span data-start="515.62" data-end="517.96">hey can you please sit down with a</span> <span data-start="517.96" data-end="519.31">little bit of a design workshop whatever</span> <span data-start="519.31" data-end="522">to figure this out turns out that they</span> <span data-start="522" data-end="524.65">they answer to the question on how to</span> <span data-start="524.65" data-end="527.19">visualize the synchronous activity is</span> <span data-start="527.19" data-end="533.14">bubbles so bubbles yeah that's it so</span> <span data-start="533.14" data-end="536.41">let's make an example we have we have a</span> <span data-start="536.41" data-end="539.77">nice very tiny piece of ass off code</span> <span data-start="539.77" data-end="541.839">here okay it's the same server that we</span> <span data-start="541.839" data-end="545.23">were talking about before you so we go</span> <span data-start="545.23" data-end="548.899">to all our lights so hey so we go to our</span> <span data-start="548.899" data-end="552.47">so we are here and we have that code now</span> <span data-start="552.47" data-end="554.389">we can use this tool called bubble probe</span> <span data-start="554.389" data-end="557.18">and this part of a sweet code clinic you</span> <span data-start="557.18" data-end="558.529">might check it out late this is critter</span> <span data-start="558.529" data-end="560.869">linked and autocannon is a tool to</span> <span data-start="560.869" data-end="562.369">generate some load so we are putting in</span> <span data-start="562.369" data-end="564.079">a thousand requests just to spice things</span> <span data-start="564.079" data-end="567.05">up to know where things behave in</span> <span data-start="567.05" data-end="568.999">production and basically you run on your</span> <span data-start="568.999" data-end="573.439">code not probably I've typed yeah you we</span> <span data-start="573.439" data-end="574.97">run our code now you can see that</span> <span data-start="574.97" data-end="576.74">autocannon is pinning things up a little</span> <span data-start="576.74" data-end="578.509">bit and running a little bit of those</span> <span data-start="578.509" data-end="582.74">requests and it's basically now</span> <span data-start="582.74" data-end="584.6">generating our visualization take some</span> <span data-start="584.6" data-end="586.819">time you know this machine is not</span> <span data-start="586.819" data-end="590.72">powerful at all and this is a bubble</span> <span data-start="590.72" data-end="594.019">prof diagram now I'm zooming in and so</span> <span data-start="594.019" data-end="596.269">what we can see on on the right side is</span> <span data-start="596.269" data-end="598.189">the number of a synchronous operation</span> <span data-start="598.189" data-end="601.639">being done of by this system and you can</span> <span data-start="601.639" data-end="603.129">see that it's doing you know we have</span> <span data-start="603.129" data-end="606.079">twelve thousand a synchronous resource</span> <span data-start="606.079" data-end="609.999">being created by running a thousand</span> <span data-start="609.999" data-end="613.399">requests in no Jaya's does this app help</span> <span data-start="613.399" data-end="616.1">anybody maybe yes maybe no the key</span> <span data-start="616.1" data-end="617.72">important part are blue a further down</span> <span data-start="617.72" data-end="620.12">we can start from the root so when the</span> <span data-start="620.12" data-end="622.519">root this is the root node and represent</span> <span data-start="622.519" data-end="623.809">the starting point of your application</span> <span data-start="623.809" data-end="627.019">yeah then we can go deep and you know</span> <span data-start="627.019" data-end="629.72">see the first part and the first part in</span> <span data-start="629.72" data-end="632.179">fact it's on line 20 of our application</span> <span data-start="632.179" data-end="634.579">basic dodge is whatever it is and it's</span> <span data-start="634.579" data-end="638.149">alcohol to server dot listen our server</span> <span data-start="638.149" data-end="641.87">is starting to listen on stuff still</span> <span data-start="641.87" data-end="643.819">this is not helping me and again knowing</span> <span data-start="643.819" data-end="645.67">what is happening in my node application</span> <span data-start="645.67" data-end="649.399">so the next part it's this big block</span> <span data-start="649.399" data-end="651.259">here which is a bunch of and network</span> <span data-start="651.259" data-end="653.48">activity which is you can see it in in</span> <span data-start="653.48" data-end="655.67">green and this bunch of network activity</span> <span data-start="655.67" data-end="657.679">it's there's some bunch of antifreeze</span> <span data-start="657.679" data-end="661.399">these are not core stuff but then we</span> <span data-start="661.399" data-end="663.079">have a bunch of another node core stuff</span> <span data-start="663.079" data-end="665.209">which come from how we receive a TCP</span> <span data-start="665.209" data-end="668.179">connection in node.js itself so you know</span> <span data-start="668.179" data-end="669.559">that you are receiving a TCP connection</span> <span data-start="669.559" data-end="671.779">on J yes when you receive an HTTP</span> <span data-start="671.779" data-end="673.67">request you got an HD a TCP connection</span> <span data-start="673.67" data-end="678.679">being open after this you after this you</span> <span data-start="678.679" data-end="680.259">actually the key part of our application</span> <span data-start="680.259" data-end="682.92">which is our</span> <span data-start="682.92" data-end="687.18">set time out now you know you see that</span> <span data-start="687.18" data-end="688.95">is a set time out happening here and you</span> <span data-start="688.95" data-end="691.86">see a fork and you can ask wise is there</span> <span data-start="691.86" data-end="693.39">a fork now you can see two things first</span> <span data-start="693.39" data-end="695.04">of all the execution continued on the</span> <span data-start="695.04" data-end="696.93">left because there's a big Harrow that</span> <span data-start="696.93" data-end="698.339">will give you a hint that the execution</span> <span data-start="698.339" data-end="700.56">continued on the left but our execution</span> <span data-start="700.56" data-end="703.56">force white force well on the right you</span> <span data-start="703.56" data-end="706.2">can see that you know it start a set</span> <span data-start="706.2" data-end="711.209">timeout okay on the right but then on on</span> <span data-start="711.209" data-end="717.209">the left its when it's our promise dot</span> <span data-start="717.209" data-end="721.86">then okay which the resolution of the</span> <span data-start="721.86" data-end="726.36">promise itself so it it is and there is</span> <span data-start="726.36" data-end="728.1">a tiny bit of thing in the middle of</span> </p>
<p><span data-start="728.1" data-end="730.529">North core bits and bobs where things</span> <span data-start="730.529" data-end="734.16">are you know executed so so you know</span> <span data-start="734.16" data-end="736.98">these things is clear enough and we have</span> <span data-start="736.98" data-end="738.72">a bunch of stuff that not core does when</span> <span data-start="738.72" data-end="741.42">it finishes and you know it's for</span> <span data-start="741.42" data-end="743.75">example in here we are calling a</span> <span data-start="743.75" data-end="746.579">responsible end which is where we send</span> <span data-start="746.579" data-end="749.1">our response back to the user so we were</span> <span data-start="749.1" data-end="751.14">talking this okay no these I understand</span> <span data-start="751.14" data-end="752.88">is this is matching which matches my</span> <span data-start="752.88" data-end="753.87">understanding</span> <span data-start="753.87" data-end="756.079">now let's pile things up a little bit</span> <span data-start="756.079" data-end="759.3">now let's do a little quick refactoring</span> <span data-start="759.3" data-end="761.94">on this system and well if you are</span> <span data-start="761.94" data-end="763.26">following there is the full name of this</span> <span data-start="763.26" data-end="765.089">thing the generator one let's switch to</span> <span data-start="765.089" data-end="767.459">the sink oh wait when I think about</span> <span data-start="767.459" data-end="770.55">version this is function is that</span> <span data-start="770.55" data-end="772.649">function J functionally equivalent to</span> <span data-start="772.649" data-end="774.6">the previous one note that we are using</span> <span data-start="774.6" data-end="777.63">dot catch always put a dot catch when</span> <span data-start="777.63" data-end="778.529">you're doing these type of things</span> <span data-start="778.529" data-end="781.32">because otherwise you will leak file</span> <span data-start="781.32" data-end="783.45">descriptor and you know make popcorn of</span> <span data-start="783.45" data-end="786.839">your servers so I don't do that</span> <span data-start="786.839" data-end="788.73">put a catch here and when you're calling</span> <span data-start="788.73" data-end="793.529">promises so you need you know we are</span> <span data-start="793.529" data-end="796.05">doing this so let's try let's see if</span> <span data-start="796.05" data-end="798.74">it's the same as before</span> <span data-start="798.74" data-end="802.68">how many people think is the same how</span> <span data-start="802.68" data-end="805.74">many people 60s there different somebody</span> <span data-start="805.74" data-end="807.73">knows</span> <span data-start="807.73" data-end="816.709">somebody knows so this is this is that's</span> <span data-start="816.709" data-end="819.35">my zoom in okay so you can see that this</span> <span data-start="819.35" data-end="820.79">is actually different from the previous</span> <span data-start="820.79" data-end="824.81">one you generate a different diagram why</span> <span data-start="824.81" data-end="826.91">well first of all we can note that we</span> <span data-start="826.91" data-end="828.2">are actually using more synchronous</span> <span data-start="828.2" data-end="829.01">resources</span> <span data-start="829.01" data-end="831.14">note that promises are a synchronous</span> <span data-start="831.14" data-end="832.93">resources because they are scheduled in</span> <span data-start="832.93" data-end="834.769">they're going to be a synchronous</span> <span data-start="834.769" data-end="837.68">activity happening in the future so you</span> <span data-start="837.68" data-end="839.63">see that we are scheduling 2000 more</span> <span data-start="839.63" data-end="842.18">promises more or less than before why is</span> <span data-start="842.18" data-end="842.69">that</span> <span data-start="842.69" data-end="844.97">and the reason comes in the way the a</span> <span data-start="844.97" data-end="847.459">sink await I think a way to specified</span> <span data-start="847.459" data-end="849.62">and you know for every way that you do</span> <span data-start="849.62" data-end="851.3">you are locate a bunch of promises that</span> <span data-start="851.3" data-end="853.61">are not necessarily needed and they're</span> <span data-start="853.61" data-end="855.41">going to be removed and you know fixed</span> <span data-start="855.41" data-end="857.6">in later version of the spec I can send</span> <span data-start="857.6" data-end="859.579">you some links if you are interested so</span> <span data-start="859.579" data-end="861.44">the Reedy and you can see the difference</span> <span data-start="861.44" data-end="863.3">here that you know we have our handle</span> <span data-start="863.3" data-end="865.1">function and then we our a sink await</span> <span data-start="865.1" data-end="866.839">function and it gets split in two and</span> <span data-start="866.839" data-end="869.39">there is a bunch of tiny thing in here</span> <span data-start="869.39" data-end="871.399">which says one frame with no file and</span> <span data-start="871.399" data-end="872.87">this is you know there are some</span> <span data-start="872.87" data-end="875.12">throwaway called throwaway promises in</span> <span data-start="875.12" data-end="878.12">its gets you see some artifacts due to</span> <span data-start="878.12" data-end="880.37">our promises work and you know and this</span> <span data-start="880.37" data-end="881.959">is a completing of the hallway promise</span> <span data-start="881.959" data-end="883.579">that goes nowhere this promise is</span> <span data-start="883.579" data-end="885.8">completely like generated to just</span> <span data-start="885.8" data-end="889.959">fulfill some spec need whatever anyway</span> <span data-start="889.959" data-end="893.329">this is with the sink await and you know</span> <span data-start="893.329" data-end="896.68">then another step interesting it's just</span> <span data-start="896.68" data-end="899.779">just use callbacks you know why we are</span> <span data-start="899.779" data-end="901.49">using this type of thing why can't we</span> <span data-start="901.49" data-end="903.98">just use callbacks and let's do another</span> <span data-start="903.98" data-end="906.98">example that's calling FS read file one</span> <span data-start="906.98" data-end="909.709">of the parameters of nodejs so we go</span> <span data-start="909.709" data-end="912.77">back here and we are running our files</span> <span data-start="912.77" data-end="916.82">example and I think loosing tab but it's</span> <span data-start="916.82" data-end="919.07">not a really good idea so a lot of files</span> <span data-start="919.07" data-end="921.44">in there so we are running it and</span> <span data-start="921.44" data-end="924.17">generating some bunch of things and here</span> <span data-start="924.17" data-end="927.04">we go</span> <span data-start="927.04" data-end="932.57">some magic sprinkling I don't know here</span> <span data-start="932.57" data-end="933.079">we go</span> <span data-start="933.079" data-end="934.88">now you can see that is another a</span> <span data-start="934.88" data-end="936.56">slightly different one this is fully</span> <span data-start="936.56" data-end="938.81">linear let me zoom in okay you can see</span> <span data-start="938.81" data-end="940.43">in this blah blah</span> <span data-start="940.43" data-end="942.02">there's a lot of brown activity which is</span> <span data-start="942.02" data-end="944.18">a reading of files a bunch of scheduling</span> <span data-start="944.18" data-end="945.74">activity which is the purple and then</span> <span data-start="945.74" data-end="948.05">some green one which is data so we have</span> <span data-start="948.05" data-end="950">these blocks of brown activity in here</span> <span data-start="950" data-end="952.19">that you can see and you know the third</span> <span data-start="952.19" data-end="953.36">let's click on the first one and the</span> <span data-start="953.36" data-end="956.57">first one is our f1 function and you can</span> <span data-start="956.57" data-end="958.46">see oh maybe as we are reading a file so</span> <span data-start="958.46" data-end="960.2">this is scheduling our rid of the file</span> <span data-start="960.2" data-end="962.87">then we have this next block afterwards</span> <span data-start="962.87" data-end="965.27">which is in fact a combination of three</span> <span data-start="965.27" data-end="966.74">different a synchronous activities</span> <span data-start="966.74" data-end="968.99">because no J yes in order to read that</span> <span data-start="968.99" data-end="971.03">file is actually accessing the file</span> <span data-start="971.03" data-end="973.16">system three times and is completely in</span> <span data-start="973.16" data-end="974.54">it for you you just call a fast read</span> <span data-start="974.54" data-end="977.12">file but it's segmented and it makes</span> <span data-start="977.12" data-end="980.06">things interleaved so that it you can</span> <span data-start="980.06" data-end="981.68">use multiple signals activity at the</span> <span data-start="981.68" data-end="984.08">same time and he's doing treat and is</span> <span data-start="984.08" data-end="985.43">doing three things and it's calling this</span> <span data-start="985.43" data-end="987.35">function read file after open which is</span> <span data-start="987.35" data-end="989.33">totally an old call thing and we are not</span> <span data-start="989.33" data-end="990.95">should not really worry too much about</span> <span data-start="990.95" data-end="991.43">it</span> <span data-start="991.43" data-end="993.35">and now we have the first we have the</span> <span data-start="993.35" data-end="995.63">first file and then the second file and</span> <span data-start="995.63" data-end="998.05">then the third file okay this seems I</span> <span data-start="998.05" data-end="1004.12">can understand this so let's switch to a</span> <span data-start="1004.12" data-end="1006.88">sink await okay now you should have</span> <span data-start="1006.88" data-end="1008.71">learned we should have seen that it</span> <span data-start="1008.71" data-end="1011.11">changes significantly the structure of</span> <span data-start="1011.11" data-end="1016.33">my application and it's it's actually</span> <span data-start="1016.33" data-end="1019.12">very it's actually very useful because</span> <span data-start="1019.12" data-end="1020.44">it moved from something that is very</span> <span data-start="1020.44" data-end="1022.12">hard to read and very hard to maintain</span> <span data-start="1022.12" data-end="1024.55">or something this is way better to read</span> <span data-start="1024.55" data-end="1027.459">and maintain so yeah I like it right</span> </p>
<p><span data-start="1027.459" data-end="1032.74">I'm a fan by the way and so what is</span> <span data-start="1032.74" data-end="1035.74">happening it's now you can see that the</span> <span data-start="1035.74" data-end="1038.95">the actual bubble prof art as we call it</span> <span data-start="1038.95" data-end="1042.13">it is slightly different than them</span> <span data-start="1042.13" data-end="1044.94">before because you can see that there is</span> <span data-start="1044.94" data-end="1047.53">way more scheduling activity happening</span> <span data-start="1047.53" data-end="1049.87">and you can see where the throw away</span> <span data-start="1049.87" data-end="1051.22">promises are so there is at Rahway</span> <span data-start="1051.22" data-end="1052.99">promise here via KHOU we are actually</span> <span data-start="1052.99" data-end="1054.91">calling a sink await three times as I</span> <span data-start="1054.91" data-end="1056.83">wait three times so we have three throw</span> <span data-start="1056.83" data-end="1058.93">away promises and we have one here one</span> <span data-start="1058.93" data-end="1064.27">here and one here now there is and we</span> <span data-start="1064.27" data-end="1065.77">can now understand how things are</span> <span data-start="1065.77" data-end="1067.21">getting interleaved between each other</span> <span data-start="1067.21" data-end="1069.94">and how we can use this information to</span> <span data-start="1069.94" data-end="1073.47">write better code and maybe fix problems</span> <span data-start="1073.47" data-end="1076.92">one more thing it's we have written our</span> <span data-start="1076.92" data-end="1080.85">code in this way now we can also very</span> <span data-start="1080.85" data-end="1084.36">quickly write our code to be Impa in</span> <span data-start="1084.36" data-end="1088.77">parallel note that changing a bunch of</span> <span data-start="1088.77" data-end="1091.41">code back he'll functions to be parallel</span> <span data-start="1091.41" data-end="1093.84">it's hard doing it with the sink away it</span> <span data-start="1093.84" data-end="1095.07">is a matter of changing three lines of</span> <span data-start="1095.07" data-end="1098.19">code so benefit there note that I'm not</span> <span data-start="1098.19" data-end="1108.76">using a weight and let's see how it goes</span> <span data-start="1108.77" data-end="1118.47">take some time here we go I'm zoom in</span> <span data-start="1118.47" data-end="1121.17">and now now you can see that in fact the</span> <span data-start="1121.17" data-end="1123.06">truth we throw away promises that we</span> <span data-start="1123.06" data-end="1125.1">were talking before I have gone I have</span> <span data-start="1125.1" data-end="1128.04">disappeared and we now have our only</span> <span data-start="1128.04" data-end="1130.26">three blocks of reading our files and we</span> <span data-start="1130.26" data-end="1132.18">can unpack this web and you can see that</span> <span data-start="1132.18" data-end="1134.07">you know there is all the the things</span> <span data-start="1134.07" data-end="1136.65">will get generated properly and stuff</span> <span data-start="1136.65" data-end="1138.3">like that and there is a lot of</span> <span data-start="1138.3" data-end="1140.7">information that you can that you can</span> <span data-start="1140.7" data-end="1142.35">gather from this tool and to visualize</span> <span data-start="1142.35" data-end="1144.6">your synchronous activity and understand</span> <span data-start="1144.6" data-end="1147.18">how human your node process work in fact</span> <span data-start="1147.18" data-end="1149.73">we've done some analysis on some some</span> <span data-start="1149.73" data-end="1155.28">open source modules this is from a</span> <span data-start="1155.28" data-end="1158.1">library called ipfs and it's a</span> <span data-start="1158.1" data-end="1159.63">distributed web platform and we have</span> <span data-start="1159.63" data-end="1163.55">done some optimizations in there and</span> <span data-start="1163.55" data-end="1167.7">there was some some there was things</span> <span data-start="1167.7" data-end="1169.17">that could be improved and you can see</span> <span data-start="1169.17" data-end="1171.18">there is a lot of activity in here a lot</span> <span data-start="1171.18" data-end="1172.56">of things that are you know chained</span> <span data-start="1172.56" data-end="1175.44">together and so on and so forth and you</span> <span data-start="1175.44" data-end="1178.05">can read all of this in this issue if</span> <span data-start="1178.05" data-end="1181.47">you are interested it's long it's a long</span> <span data-start="1181.47" data-end="1184.05">long long paper of explanation on what</span> <span data-start="1184.05" data-end="1184.92">was the problem</span> <span data-start="1184.92" data-end="1187.2">how we fix it in the end we fix it we</span> <span data-start="1187.2" data-end="1189.33">got a 30% performance improvements so</span> <span data-start="1189.33" data-end="1190.38">yeah</span> <span data-start="1190.38" data-end="1194.21">what's nice what was a nice one okay so</span> <span data-start="1194.21" data-end="1196.17">let's go a little bit into some</span> <span data-start="1196.17" data-end="1197.88">performance consideration on how you</span> <span data-start="1197.88" data-end="1200.01">write your node application and how to</span> <span data-start="1200.01" data-end="1204.39">improve them so you know we've talked a</span> <span data-start="1204.39" data-end="1205.92">little bit about the event loop and now</span> <span data-start="1205.92" data-end="1207.299">the fact that your i/o</span> <span data-start="1207.299" data-end="1210.239">runs one at a time right and we schedule</span> <span data-start="1210.239" data-end="1212.159">functions so when we receive a request</span> <span data-start="1212.159" data-end="1217.86">and it really is we schedule some</span> <span data-start="1217.86" data-end="1219.809">activity to happen in the future</span> <span data-start="1219.809" data-end="1222.419">we set a function into our event loop</span> <span data-start="1222.419" data-end="1225.6">machinery right and they will call me</span> <span data-start="1225.6" data-end="1228.179">back when it's finished so when this is</span> <span data-start="1228.179" data-end="1231.179">low are your operation that function</span> <span data-start="1231.179" data-end="1235.59">will stay alive longer okay which means</span> <span data-start="1235.59" data-end="1238.259">that they can accept more stuff from I</span> <span data-start="1238.259" data-end="1239.549">can accept more requests before</span> <span data-start="1239.549" data-end="1241.83">returning right that's what everybody</span> <span data-start="1241.83" data-end="1244.08">would do well I have capacity I'm not</span> <span data-start="1244.08" data-end="1247.019">doing anything I'm haidle so I will get</span> <span data-start="1247.019" data-end="1248.999">more data from you know I let's add more</span> </p>
<p><span data-start="1248.999" data-end="1254.07">HTTP requests so yeah it's increased the</span> <span data-start="1254.07" data-end="1255.929">amount of concurrent tasks because I</span> <span data-start="1255.929" data-end="1257.82">have more CPU bandwidth now I'm waiting</span> <span data-start="1257.82" data-end="1259.109">for stuff to happen so I can execute</span> <span data-start="1259.109" data-end="1263.999">stuff good however the more increased</span> <span data-start="1263.999" data-end="1267.749">the concurrency the more you increase</span> <span data-start="1267.749" data-end="1271.799">the memory consumption why well we have</span> <span data-start="1271.799" data-end="1273.69">a for each one that we received we are</span> <span data-start="1273.69" data-end="1277.619">allocating new closures so new closures</span> <span data-start="1277.619" data-end="1279.779">gets allocated new objects and all of</span> <span data-start="1279.779" data-end="1284.129">these occupy memory which is you know</span> <span data-start="1284.129" data-end="1290.549">precious in most systems the moment you</span> <span data-start="1290.549" data-end="1293.999">increase memory consumption you increase</span> <span data-start="1293.999" data-end="1296.609">you make the word of the nice garbage</span> <span data-start="1296.609" data-end="1301.289">collector harder why well because you</span> <span data-start="1301.289" data-end="1304.95">have es more stuff to clean up and you</span> <span data-start="1304.95" data-end="1307.95">will is worth even the performance of</span> <span data-start="1307.95" data-end="1309.21">the garbage collector is getting better</span> <span data-start="1309.21" data-end="1310.379">and better and better and better better</span> <span data-start="1310.379" data-end="1313.889">better and better every year we are</span> <span data-start="1313.889" data-end="1315.299">scheduling more stuff every year to</span> <span data-start="1315.299" data-end="1318.539">every moment to do more arise so it</span> <span data-start="1318.539" data-end="1320.22">increased the pressure on the garbage</span> <span data-start="1320.22" data-end="1325.799">collector to to do work and these the</span> <span data-start="1325.799" data-end="1327.419">garbage collector where does it run is</span> <span data-start="1327.419" data-end="1329.609">it magic no it's not magic it runs on a</span> </p>
<p><span data-start="1329.609" data-end="1332.34">CPU and you know when you are working on</span> <span data-start="1332.34" data-end="1334.019">a container system or are deploying</span> <span data-start="1334.019" data-end="1338.19">nodejs in production you are doing you</span> <span data-start="1338.19" data-end="1340.169">probably have one or two or three</span> <span data-start="1340.169" data-end="1342.33">maybe course I don't know Italy most of</span> <span data-start="1342.33" data-end="1344.639">the time once one Corps</span> <span data-start="1344.639" data-end="1346.889">so if regard watch collectors running</span> <span data-start="1346.889" data-end="1349.259">maybe my note process cannot run so we</span> <span data-start="1349.259" data-end="1350.58">have a problem there okay there is</span> <span data-start="1350.58" data-end="1355.32">contention so in the end and so this</span> <span data-start="1355.32" data-end="1356.73">means that the garbage collector will</span> <span data-start="1356.73" data-end="1360.989">steal my CPU cycles perfect and will</span> <span data-start="1360.989" data-end="1365.059">steal my CPU cycle from the JavaScript</span> <span data-start="1365.059" data-end="1370.35">critical path which is which is a little</span> <span data-start="1370.35" data-end="1377.159">bit a tricky thing II so the net result</span> <span data-start="1377.159" data-end="1380.07">is that late in a node.js application</span> <span data-start="1380.07" data-end="1383.34">latency and throughput are tightly</span> <span data-start="1383.34" data-end="1386.249">connected so the moment you see an</span> <span data-start="1386.249" data-end="1389.009">increase in latency you will see also</span> <span data-start="1389.009" data-end="1391.049">likely a decrease in in throughput</span> <span data-start="1391.049" data-end="1393.09">mainly because they are linked together</span> <span data-start="1393.09" data-end="1397.44">by the way the node works and the fact</span> <span data-start="1397.44" data-end="1399.749">that typically it can take a huge amount</span> <span data-start="1399.749" data-end="1402.749">of high concurrency compared to other</span> <span data-start="1402.749" data-end="1405.629">platforms and and this is one of the</span> <span data-start="1405.629" data-end="1408.149">things that you know having doing it as</span> <span data-start="1408.149" data-end="1411.84">a job to go through and putting node.js</span> <span data-start="1411.84" data-end="1414.239">application in production it's one of</span> <span data-start="1414.239" data-end="1416.129">the most misunderstood concepts about</span> <span data-start="1416.129" data-end="1419.34">about no GS and think thinking that this</span> <span data-start="1419.34" data-end="1421.71">true concept latency and throughput are</span> <span data-start="1421.71" data-end="1423.989">not connected to each other and you</span> <span data-start="1423.989" data-end="1427.409">should always remember this so that this</span> <span data-start="1427.409" data-end="1429.6">tool is part of the clinic J's suite you</span> <span data-start="1429.6" data-end="1431.309">can find it there it there is also a</span> <span data-start="1431.309" data-end="1435.299">video of me speaking whatever so if you</span> <span data-start="1435.299" data-end="1436.529">need some help in improving the</span> <span data-start="1436.529" data-end="1438.6">performance of your node.js application</span> <span data-start="1438.6" data-end="1441.749">reach out eh say hi and yeah that's it</span> <span data-start="1441.749" data-end="1444.629">and again these lights you probably want</span> <span data-start="1444.629" data-end="1445.98">to check them out I don't know hopefully</span> <span data-start="1445.98" data-end="1448.23">hopefully yes hopefully now I will tweet</span> <span data-start="1448.23" data-end="1449.909">about them sooner rather than later</span> <span data-start="1449.909" data-end="1451.529">somebody taking a pictures thank you I</span> <span data-start="1451.529" data-end="1455.47">put it right they put it there for you</span> <span data-start="1455.48" data-end="1464.62">so yes and thank you</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
