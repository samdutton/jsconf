<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>hHytsQkVlhA</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/hHytsQkVlhA?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="34.579" data-end="38.96">so hey y'all my name is Andy Wingo it's</span> <span data-start="38.96" data-end="41.57">real pleasure to be here thank you and</span> <span data-start="41.57" data-end="43.52">and I'm a compiler nerd I have to say</span> <span data-start="43.52" data-end="46.399">right yeah it's a technical title</span> <span data-start="46.399" data-end="48.769">actually I work for a gallium it's a</span> <span data-start="48.769" data-end="51.62">spanish software consulting company that</span> <span data-start="51.62" data-end="53.329">does mostly consulting around free</span> <span data-start="53.329" data-end="54.68">software projects and if you know our</span> <span data-start="54.68" data-end="57.079">work it's mostly it would probably be</span> <span data-start="57.079" data-end="58.97">because of our work on whether it right</span> <span data-start="58.97" data-end="60.71">where it's difficult to count these</span> <span data-start="60.71" data-end="61.82">things but we're something like the</span> <span data-start="61.82" data-end="64.399">third largest corporate contributor to</span> <span data-start="64.399" data-end="67.94">the WebKit project we work on ports for</span> <span data-start="67.94" data-end="75.32">customers integrations for device</span> <span data-start="75.32" data-end="77.83">manufacturers and things that and then I</span> <span data-start="77.83" data-end="80.42">have been working on JavaScript core for</span> <span data-start="80.42" data-end="84.979">the last spend some time with v8 but I'm</span> </p>
<p><span data-start="84.979" data-end="87.2">I'm mostly going to focus on JavaScript</span> <span data-start="87.2" data-end="90.89">core oh yes fun fact you Galia is a</span> <span data-start="90.89" data-end="92.6">worker owned cooperative if y'all are</span> <span data-start="92.6" data-end="94.7">interested about such a strange project</span> <span data-start="94.7" data-end="95.869">come to me afterwards and you know</span> <span data-start="95.869" data-end="99.47">asking about the thing but I'm not</span> <span data-start="99.47" data-end="101.3">really a JavaScript programmer right I'm</span> <span data-start="101.3" data-end="105.779">I'm a schemer at heart that's you know</span> <span data-start="105.789" data-end="108.95">but it's been just real interesting</span> <span data-start="108.95" data-end="110.63">getting in the thick of these JavaScript</span> <span data-start="110.63" data-end="112.399">implementations they're fascinating</span> <span data-start="112.399" data-end="115.16">things and I find them you know quite</span> <span data-start="115.16" data-end="116.929">quite interesting so this is gonna be a</span> <span data-start="116.929" data-end="118.789">talk about some things that I've learned</span> <span data-start="118.789" data-end="120.41">about the various implementations and</span> <span data-start="120.41" data-end="122.209">it's going to focus on JavaScript core</span> <span data-start="122.209" data-end="124.009">because they don't do a very good job</span> <span data-start="124.009" data-end="125.3">marketing and I don't think anyone</span> <span data-start="125.3" data-end="126.5">really understands how it works</span> <span data-start="126.5" data-end="129.41">right so I figure it's a a good you know</span> <span data-start="129.41" data-end="131.62">time to take out some of these things I</span> <span data-start="131.62" data-end="134.09">have a feeling like my perspective is</span> <span data-start="134.09" data-end="136.489">that my languages are essentially tribal</span> <span data-start="136.489" data-end="138.98">right that's that's the thing that</span> <span data-start="138.98" data-end="140.69">defines a language community that you</span> <span data-start="140.69" data-end="142.76">know you have a group and you have in</span> <span data-start="142.76" data-end="144.77">and outside and you have your respected</span> <span data-start="144.77" data-end="146.48">elders and your tribe and such and I</span> <span data-start="146.48" data-end="148.36">come from you know this Lisp tribe and</span> <span data-start="148.36" data-end="151.4">one of our old bards was Peter Norvig</span> <span data-start="151.4" data-end="153.05">you might know I'm he's through a</span> <span data-start="153.05" data-end="155.3">research now at Google 20 years ago he</span> <span data-start="155.3" data-end="156.86">wrote a book called paradigms and</span> <span data-start="156.86" data-end="159.01">artificial intelligence programming and</span> <span data-start="159.01" data-end="161.39">the book has not held up as far as</span> <span data-start="161.39" data-end="163.31">artificial intelligence goes but it's I</span> <span data-start="163.31" data-end="164.96">think it's quite interesting on a you</span> <span data-start="164.96" data-end="166.76">know the practice of programming and</span> <span data-start="166.76" data-end="168.23">some efficiency concerns</span> <span data-start="168.23" data-end="170.48">and he he did some retrospectives on</span> <span data-start="170.48" data-end="173.269">this book five years after in ten years</span> <span data-start="173.269" data-end="175.069">after he hasn't done a twenty or one yet</span> <span data-start="175.069" data-end="177.29">but I'm aware of but he extracted you</span> <span data-start="177.29" data-end="178.67">know these lessons and they're kind of</span> <span data-start="178.67" data-end="180.53">cute one of them though that really is</span> <span data-start="180.53" data-end="182.45">stuck with me and all my programming</span> <span data-start="182.45" data-end="186.17">stuff be it god forbid even in C++ would</span> <span data-start="186.17" data-end="187.67">be that they're this statement that</span> <span data-start="187.67" data-end="189.68">there are four general techniques which</span> <span data-start="189.68" data-end="192.11">you can use to speed up an algorithm</span> <span data-start="192.11" data-end="196.34">being caching compiling delaying</span> <span data-start="196.34" data-end="197.75">computation which sometimes we call</span> <span data-start="197.75" data-end="199.489">laziness any through in this thing</span> <span data-start="199.489" data-end="200.769">called indexing because the bad time</span> </p>
<p><span data-start="200.769" data-end="203.15">Lisp programmers like to use linked</span> <span data-start="203.15" data-end="205.04">lists for everything and Husing please</span> <span data-start="205.04" data-end="207.59">use a an array or some structure with</span> <span data-start="207.59" data-end="212.09">better Big O complexity but you know in</span> <span data-start="212.09" data-end="216.819">any case this is you know escaping from</span> <span data-start="216.819" data-end="220.79">as a way to interpret what I have found</span> <span data-start="220.79" data-end="223.25">in in the JavaScript tribe so one</span> <span data-start="223.25" data-end="225.92">extreme example of this would be the</span> <span data-start="225.92" data-end="228.319">inline cash phenomenon so lose your hand</span> <span data-start="228.319" data-end="231.19">if you own inline caches sorry get</span> <span data-start="231.19" data-end="235.01">through the room or so so this when</span> <span data-start="235.01" data-end="236.93">you're a language imitation and you see</span> <span data-start="236.93" data-end="240.2">like X plus y like you have to do</span> <span data-start="240.2" data-end="241.519">something right you have to add it at</span> <span data-start="241.519" data-end="244.85">some point right but the question is how</span> <span data-start="244.85" data-end="246.079">exactly are you going to go about doing</span> <span data-start="246.079" data-end="249.65">this well for example in v8 and more</span> <span data-start="249.65" data-end="251.299">even than that and in Dart</span> <span data-start="251.299" data-end="253.069">what you do is you don't do anything</span> <span data-start="253.069" data-end="255.38">right you don't implement it at all</span> <span data-start="255.38" data-end="257.359">until it's run for the first time and</span> <span data-start="257.359" data-end="259.7">then when it's first run you see what</span> <span data-start="259.7" data-end="261.169">types are flowing through that call site</span> <span data-start="261.169" data-end="264.65">you compile a version of this operation</span> <span data-start="264.65" data-end="266.66">specific to the types for that call site</span> <span data-start="266.66" data-end="269.06">and you cash that code in stub so</span> <span data-start="269.06" data-end="271.49">they're those three most important</span> <span data-start="271.49" data-end="274.76">elements of norfolk's Maxim they're sort</span> <span data-start="274.76" data-end="277.07">of worked them together and of course</span> <span data-start="277.07" data-end="278.78">this technique also applies to field</span> <span data-start="278.78" data-end="281.72">accesses you know x dot y and</span> <span data-start="281.72" data-end="285.02">interestingly in v8 the the caches work</span> <span data-start="285.02" data-end="287.27">as input the optimizing compiler later</span> </p>
<p><span data-start="287.27" data-end="288.26">I'll talk a little bit more about that</span> <span data-start="288.26" data-end="291.71">in a bit but like I say on JavaScript</span> <span data-start="291.71" data-end="295.82">core and specifically to the new tiered</span> <span data-start="295.82" data-end="297.47">compilation model I'm gonna do the hand</span> <span data-start="297.47" data-end="300.25">raising thing again so how many of you</span> <span data-start="300.25" data-end="301.97">have her</span> <span data-start="301.97" data-end="306.56">the term TFG TFG very few I guess lol</span> <span data-start="306.56" data-end="309.59">int probably fewer okay some though</span> <span data-start="309.59" data-end="310.76">awesome great</span> <span data-start="310.76" data-end="314.12">so javascriptcore works it's it it</span> <span data-start="314.12" data-end="318.2">compiles your code to bytecode and then</span> <span data-start="318.2" data-end="320.69">the first time it runs it on cold code</span> <span data-start="320.69" data-end="323.33">it will interpret that bytecode and then</span> <span data-start="323.33" data-end="325.58">if that code warms up it will compile</span> <span data-start="325.58" data-end="328.34">those byte codes into native code and</span> <span data-start="328.34" data-end="330.77">then if that code JavaScript core</span> <span data-start="330.77" data-end="332.66">determines that it's hot then it will</span> <span data-start="332.66" data-end="335.39">optimize that compiled code and produce</span> <span data-start="335.39" data-end="337.82">a version which is specific to the types</span> <span data-start="337.82" data-end="339.65">flowing through that call site and it's</span> <span data-start="339.65" data-end="343.22">a speculative optimization meaning it</span> <span data-start="343.22" data-end="344.99">doesn't have to be general like so that</span> <span data-start="344.99" data-end="347.57">the the highest then it can fail at some</span> <span data-start="347.57" data-end="348.62">point say you're having a bunch of</span> <span data-start="348.62" data-end="350.27">integers and integers and integers and</span> <span data-start="350.27" data-end="354.03">something you see like a float</span> <span data-start="354.04" data-end="356.03">javascript or floating point but there's</span> <span data-start="356.03" data-end="357.74">the common optimization that small</span> <span data-start="357.74" data-end="359.6">integers are represented differently at</span> <span data-start="359.6" data-end="360.65">that point you would fail the</span> <span data-start="360.65" data-end="362.87">speculation tier back down from tier 2</span> <span data-start="362.87" data-end="365.75">up to tier 1 and wait again and try some</span> <span data-start="365.75" data-end="368.24">more and I think I'm sure many of you</span> <span data-start="368.24" data-end="372.74">have heard Larry wall Perl creator haha</span> <span data-start="372.74" data-end="375.41">but right he has the cardinal virtues of</span> <span data-start="375.41" data-end="378.23">programmer being laziness impatience and</span> <span data-start="378.23" data-end="379.55">humorous and I think they correspond in</span> <span data-start="379.55" data-end="382.19">this order actually to the L and the the</span> <span data-start="382.19" data-end="386.63">baseline JIT and the DFG JIT so the ll</span> <span data-start="386.63" data-end="390.64">inch is the lowest level of JavaScript</span> <span data-start="390.64" data-end="392.62">implementation javascript cores</span> <span data-start="392.62" data-end="394.79">implementation and this is very very new</span> <span data-start="394.79" data-end="396.74">it's maybe it landed a month and a half</span> <span data-start="396.74" data-end="398.78">ago or so so I'm not surprised y'all</span> <span data-start="398.78" data-end="399.98">haven't heard of it and I'm not</span> <span data-start="399.98" data-end="401.33">surprised you haven't heard the DFG</span> <span data-start="401.33" data-end="402.73">either because that's also quite recent</span> <span data-start="402.73" data-end="406.7">it's the new interpreter it's the first</span> <span data-start="406.7" data-end="411.86">pass at your and javascriptcore I need</span> <span data-start="411.86" data-end="413.3">to give a bit of context though for you</span> <span data-start="413.3" data-end="414.89">to understand how it's different than</span> <span data-start="414.89" data-end="418.1">the old one so I'm gonna do a bit of a</span> <span data-start="418.1" data-end="421.07">deep dive into the bytecode the bike</span> <span data-start="421.07" data-end="424.04">compiler the old interpreter and then</span> </p>
<p><span data-start="424.04" data-end="426.29">I'll show the new one and we're going to</span> <span data-start="426.29" data-end="428.96">see a bit of C++ here and I'm sorry you</span> <span data-start="428.96" data-end="430.37">know I have to deal with it'll work I</span> <span data-start="430.37" data-end="432.65">figure y'all got yourself a little bit</span> <span data-start="432.65" data-end="435.03">of it you know some somehow for</span> <span data-start="435.03" data-end="439.59">justice I guess so anyway if you have</span> <span data-start="439.59" data-end="441.87">javascriptcore for example you have</span> <span data-start="441.87" data-end="443.97">downloaded a WebKit nightly and you find</span> <span data-start="443.97" data-end="445.71">the JSC binary which is tucked in there</span> <span data-start="445.71" data-end="447.42">somewhere for the Mac platform or you</span> <span data-start="447.42" data-end="450.39">build javascriptcore yourself you will</span> <span data-start="450.39" data-end="451.98">end up with this binary called JSC and</span> <span data-start="451.98" data-end="453.72">that's the interpreter when you run it</span> <span data-start="453.72" data-end="455.91">with the data GE argument it's going to</span> <span data-start="455.91" data-end="460.68">dump any time it creates bytecode so you</span> <span data-start="460.68" data-end="464.4">know main function and you put it in</span> <span data-start="464.4" data-end="466.74">prisoner right it's going to print out</span> <span data-start="466.74" data-end="469.11">some byte code that it emits and the</span> <span data-start="469.11" data-end="471">interesting thing is like where where is</span> <span data-start="471" data-end="474.24">the addition here here we're just ok the</span> <span data-start="474.24" data-end="475.8">result of defining this thing is the</span> <span data-start="475.8" data-end="477.54">value which is kind of a whap</span> <span data-start="477.54" data-end="479.85">thing as far as language goes but you</span> <span data-start="479.85" data-end="482.85">know where is the addition so like we</span> <span data-start="482.85" data-end="485.61">said about laziness javascriptcore and</span> <span data-start="485.61" data-end="489.03">v8 and I assume spider monkey and God</span> <span data-start="489.03" data-end="491.55">knows what the other engines do don't</span> <span data-start="491.55" data-end="493.83">actually byte compile they don't even</span> <span data-start="493.83" data-end="496.17">par seer function until it's run for the</span> <span data-start="496.17" data-end="498.3">first time they simply check the syntax</span> <span data-start="498.3" data-end="501.02">right so the function is never called is</span> <span data-start="501.02" data-end="504.21">essentially free there are some you know</span> <span data-start="504.21" data-end="506.34">overheads for that but if if you have a</span> <span data-start="506.34" data-end="507.75">function is never called like you have a</span> <span data-start="507.75" data-end="509.4">big jQuery library or something and you</span> <span data-start="509.4" data-end="510.45">just don't call some of those things</span> <span data-start="510.45" data-end="512.28">they never get created like they never</span> <span data-start="512.28" data-end="514.5">your parsed I never get compiled either</span> <span data-start="514.5" data-end="515.91">to bytecode nor native code nor anything</span> <span data-start="515.91" data-end="517.68">else so once you call them for the first</span> <span data-start="517.68" data-end="519.78">time though JavaScript core is going to</span> <span data-start="519.78" data-end="521.91">go ahead and and byte compile it and</span> <span data-start="521.91" data-end="524.49">parse it by compile it and produce this</span> <span data-start="524.49" data-end="527.28">output here we see we have three opcodes</span> <span data-start="527.28" data-end="530.79">right we enter the function we are going</span> <span data-start="530.79" data-end="537.45">to add and it's a negative eight</span> <span data-start="537.45" data-end="539.42">negative nine that's gonna reference</span> <span data-start="539.42" data-end="542.04">arguments coming in and the result is</span> <span data-start="542.04" data-end="544.23">gonna be put in our zero and then you're</span> <span data-start="544.23" data-end="545.82">gonna return from that function you of</span> <span data-start="545.82" data-end="547.8">its I think it's it's fairly clear what</span> <span data-start="547.8" data-end="550.17">this is question is what is implementing</span> <span data-start="550.17" data-end="553.17">these op codes right that that is the</span> <span data-start="553.17" data-end="556.17">interpreter at the very base level and</span> <span data-start="556.17" data-end="559.17">the classic interpreter it's world bitch</span> <span data-start="559.17" data-end="561.36">how about that you raise hands for Go</span> </p>
<p><span data-start="561.36" data-end="563.28">Fish we got many but that's the name</span> <span data-start="563.28" data-end="566.019">it's sort of stuck with you I don't know</span> <span data-start="566.019" data-end="567.67">I'm not sure if the other thing to you</span> <span data-start="567.67" data-end="570.399">new javascriptcore squirrelfish all</span> <span data-start="570.399" data-end="572.11">these all these names got you know</span> <span data-start="572.11" data-end="574.689">jumbled together marketing-wise the name</span> <span data-start="574.689" data-end="575.949">of the interpreter is javascriptcore</span> <span data-start="575.949" data-end="577.989">it's been marketed under various names</span> <span data-start="577.989" data-end="580.72">and when in 2008 the bike compiler first</span> <span data-start="580.72" data-end="582.009">came out because before they had this</span> <span data-start="582.009" data-end="584.079">tree based interpreter they called it</span> <span data-start="584.079" data-end="586.269">squirrel so the classic interpreter now</span> <span data-start="586.269" data-end="588.61">corresponds more or less to did that</span> <span data-start="588.61" data-end="591.04">release in 2008 and here we go with some</span> <span data-start="591.04" data-end="594.189">c++ I don't I mean you don't need to you</span> <span data-start="594.189" data-end="595.749">know understand this but I just wanna</span> <span data-start="595.749" data-end="600.309">sure the shape right so if you find</span> <span data-start="600.309" data-end="602.41">interpreter at cpp when you download the</span> <span data-start="602.41" data-end="605.41">source and you should dig this sort of</span> <span data-start="605.41" data-end="609.1">thing and you'll find op add I your</span> <span data-start="609.1" data-end="610.329">search for it and we see at the</span> <span data-start="610.329" data-end="612.279">beginning we're parsing out the the</span> <span data-start="612.279" data-end="614.499">registers like we had the dump and then</span> <span data-start="614.499" data-end="616.689">there are two cases right one is a case</span> <span data-start="616.689" data-end="618.369">for small integers that don't overflow</span> <span data-start="618.369" data-end="620.35">and yeah there's a more general case</span> <span data-start="620.35" data-end="621.399">where we're calling out to a stub</span> <span data-start="621.399" data-end="625.269">finally we put the well both of those</span> <span data-start="625.269" data-end="626.439">handle putting the result in the</span> <span data-start="626.439" data-end="628.839">destination we advance the program</span> <span data-start="628.839" data-end="630.009">counter and we go to the next</span> <span data-start="630.009" data-end="631.269">instruction and this is kind of</span> <span data-start="631.269" data-end="633.309">interesting here the next instruction is</span> <span data-start="633.309" data-end="637.569">uh is a macro to find the top and it's a</span> <span data-start="637.569" data-end="640.389">computed goto you see the go to star</span> <span data-start="640.389" data-end="643.209">right the the opcode actually stores the</span> <span data-start="643.209" data-end="645.879">address of the label and the C++</span> <span data-start="645.879" data-end="648.85">function it's kind of you know makes</span> <span data-start="648.85" data-end="650.559">your head turn a little bit and it makes</span> <span data-start="650.559" data-end="652.36">the compilers head turn a little bit as</span> <span data-start="652.36" data-end="653.92">well because this isn't it's not</span> <span data-start="653.92" data-end="656.259">standard C it's not standard C++ and</span> <span data-start="656.259" data-end="658.689">it's a it's a form of higher-level flow</span> <span data-start="658.689" data-end="660.369">control and the compiler doesn't really</span> <span data-start="660.369" data-end="663.339">know the C compiler right GC c lv m</span> <span data-start="663.339" data-end="664.749">doesn't really know what to do with this</span> <span data-start="664.749" data-end="666.91">function right it doesn't know what</span> <span data-start="666.91" data-end="668.319">things need to be in registers what</span> <span data-start="668.319" data-end="669.73">things can be spilled on the stack what</span> <span data-start="669.73" data-end="671.11">things can be thrown away because all it</span> <span data-start="671.11" data-end="673.209">sees is all the labels could branch to</span> <span data-start="673.209" data-end="676.24">each other and it doesn't it can't do</span> <span data-start="676.24" data-end="678.759">very good analysis my so what happened</span> <span data-start="678.759" data-end="680.949">was is this fellow Philip is low which I</span> <span data-start="680.949" data-end="682.149">don't know how long he's been working in</span> </p>
<p><span data-start="682.149" data-end="683.35">Apple but he's been contributing our</span> <span data-start="683.35" data-end="684.569">JavaScript core for about a year so</span> <span data-start="684.569" data-end="687.639">rewrote the the interpreter in assembly</span> <span data-start="687.639" data-end="689.379">right I assume that's not important I've</span> <span data-start="689.379" data-end="692.499">never actually seen before and he ll int</span> <span data-start="692.499" data-end="694.689">is the new interpreter for JavaScript</span> <span data-start="694.689" data-end="697.839">core instead of being implemented in C++</span> <span data-start="697.839" data-end="700.33">it's amended in a specific</span> <span data-start="700.33" data-end="702.25">assembly language and it's actually</span> <span data-start="702.25" data-end="703.84">compiled to the native code with a</span> <span data-start="703.84" data-end="706.33">custom Ruby macro assembler so I think</span> <span data-start="706.33" data-end="708.61">it's fair to say that javascriptcore now</span> <span data-start="708.61" data-end="710.17">implemented Ruby</span> <span data-start="710.17" data-end="713.2">it happens beforehand it's ahead of time</span> <span data-start="713.2" data-end="714.76">it's part of the build process for</span> </p>
<p><span data-start="714.76" data-end="717.16">JavaScript core itself and again I'm</span> <span data-start="717.16" data-end="718.96">going to show you this this custom</span> <span data-start="718.96" data-end="720.97">language sort of for shape you know if</span> <span data-start="720.97" data-end="723.01">you're really into this the the slides</span> <span data-start="723.01" data-end="724.27">will be up later you can check it out</span> <span data-start="724.27" data-end="726.03">and obviously it's in the source as well</span> <span data-start="726.03" data-end="729.22">at first we see we're defining a</span> <span data-start="729.22" data-end="731.44">dispatch macro so this is a macro</span> <span data-start="731.44" data-end="732.88">assembler that allows you to define</span> <span data-start="732.88" data-end="735.64">macros in its own language so your dogs</span> <span data-start="735.64" data-end="740.59">right dispatch we're adding some number</span> <span data-start="740.59" data-end="742.18">to the program counter and then we're</span> <span data-start="742.18" data-end="743.68">doing the computed go to but this is an</span> <span data-start="743.68" data-end="748">assembly now we dereference the OP code</span> <span data-start="748" data-end="750.1">that is there and jump forward to the</span> <span data-start="750.1" data-end="753.58">next label these like hello end up and</span> <span data-start="753.58" data-end="756.07">it lazy reg that's the simplest opcode</span> <span data-start="756.07" data-end="758.05">it's in the interpreter basically and I</span> <span data-start="758.05" data-end="760.33">put up there just to show it there's a</span> <span data-start="760.33" data-end="761.62">trace execution which generally doesn't</span> <span data-start="761.62" data-end="764.41">execute we parse out the register that</span> <span data-start="764.41" data-end="765.73">we're going to fill with an empty value</span> <span data-start="765.73" data-end="768.31">for various internal purposes we store</span> <span data-start="768.31" data-end="771.31">the empty value in that slot and then we</span> <span data-start="771.31" data-end="772.96">dispatch on to the next opcode and</span> <span data-start="772.96" data-end="775.15">that's the entire imitation that opcode</span> </p>
<p><span data-start="775.15" data-end="777.79">I can't show add though not not as it's</span> <span data-start="777.79" data-end="779.23">not in its entirety because you get</span> <span data-start="779.23" data-end="781.18">adding small integers with small</span> <span data-start="781.18" data-end="782.95">integers adding small integers with</span> <span data-start="782.95" data-end="784.78">doubles adding doubles with small</span> <span data-start="784.78" data-end="787.45">integers you know and then strings right</span> <span data-start="787.45" data-end="789.79">because it's a string append as well and</span> <span data-start="789.79" data-end="792.1">then other value of type things and it</span> <span data-start="792.1" data-end="795.18">gets a bit complicated so what he did as</span> <span data-start="795.18" data-end="798.1">this complication it has to be repeated</span> <span data-start="798.1" data-end="799.8">for all these different opcodes like add</span> <span data-start="799.8" data-end="802.96">divide subtract and all these things he</span> <span data-start="802.96" data-end="805.27">made a macro called binary op that gets</span> <span data-start="805.27" data-end="810.46">passed to macros right macro being</span> <span data-start="810.46" data-end="813.06">passed to macros one which is the ratio</span> <span data-start="813.06" data-end="815.35">and you see at the bottom that we're</span> <span data-start="815.35" data-end="818.02">instantiating the binary op with two</span> <span data-start="818.02" data-end="819.31">macros which are defined there</span> <span data-start="819.31" data-end="821.5">anonymously like lambda expressions I</span> <span data-start="821.5" data-end="825.28">know you're all with me right but so</span> <span data-start="825.28" data-end="827.4">this is this is your new JavaScript core</span> <span data-start="827.4" data-end="830.08">and the question is why right</span> <span data-start="830.08" data-end="832.64">the the low-level interpreter has</span> <span data-start="832.64" data-end="834.2">of advantages over the old one not only</span> <span data-start="834.2" data-end="836.66">you know can we select what's on the</span> <span data-start="836.66" data-end="838.19">stack and what's in the register a bit</span> <span data-start="838.19" data-end="838.61">better</span> <span data-start="838.61" data-end="840.65">we can select what's in line then what's</span> <span data-start="840.65" data-end="841.85">not in line which is something that's</span> <span data-start="841.85" data-end="845.72">kind of difficult to do in in C++ to get</span> <span data-start="845.72" data-end="847.79">very fine control over you know the</span> <span data-start="847.79" data-end="850.07">ordering of your instructions that gets</span> <span data-start="850.07" data-end="852.41">you better locality which means you're</span> <span data-start="852.41" data-end="854.03">you're missing on your instruction cache</span> <span data-start="854.03" data-end="856.76">less since you're not spilling as much</span> <span data-start="856.76" data-end="858.11">stuff on the stack you know you can</span> <span data-start="858.11" data-end="860.81">throw away the garbage collector doesn't</span> <span data-start="860.81" data-end="863.99">hang on to as much garbage to it doesn't</span> <span data-start="863.99" data-end="865.49">think some things but you're dead or</span> <span data-start="865.49" data-end="868.19">actually alive and it's much easier to</span> <span data-start="868.19" data-end="871.1">transfer to tear up from the low-level</span> <span data-start="871.1" data-end="873.35">interpreter to the JIT because it's the</span> <span data-start="873.35" data-end="874.64">same calling convention because we</span> <span data-start="874.64" data-end="876.41">control the con convention like you</span> <span data-start="876.41" data-end="877.88">don't when you when you compile</span> <span data-start="877.88" data-end="883.16">something in C++ and yes</span> </p>
<p><span data-start="883.16" data-end="885.8">OSR is this process of tearing up or</span> <span data-start="885.8" data-end="887.66">down you're on the stack in the middle</span> <span data-start="887.66" data-end="890.33">of a computation and you replace the</span> <span data-start="890.33" data-end="891.5">code that's running the current</span> <span data-start="891.5" data-end="893.9">computation from you know one tier to</span> <span data-start="893.9" data-end="896.06">the other tier on stack replacements</span> <span data-start="896.06" data-end="898.01">also quite complicated if you google for</span> <span data-start="898.01" data-end="899.87">that you'll find a blog post in which it</span> <span data-start="899.87" data-end="903.71">blows my mind entirely so it's much</span> <span data-start="903.71" data-end="906.52">faster is the thing the initial</span> <span data-start="906.52" data-end="910.25">statement was 200% is faster I don't</span> <span data-start="910.25" data-end="912.47">know whether that means x 2 or x 3 or</span> <span data-start="912.47" data-end="914.99">what I don't really know in reality if</span> <span data-start="914.99" data-end="916.52">you have a JIT you're going to tear up</span> <span data-start="916.52" data-end="918.2">on anything it's hot and so it doesn't</span> <span data-start="918.2" data-end="920.23">make that that much of a performance</span> <span data-start="920.23" data-end="922.76">gain on some benchmarks but when you're</span> <span data-start="922.76" data-end="924.86">just slinging lots of JavaScript it's</span> <span data-start="924.86" data-end="927.29">good to have like a fast low-level thing</span> <span data-start="927.29" data-end="929">where you just don't do very much again</span> <span data-start="929" data-end="931.19">delay in common delaying computation</span> <span data-start="931.19" data-end="935.96">right and on the iOS you have this</span> <span data-start="935.96" data-end="937.4">restriction where you can't generate</span> <span data-start="937.4" data-end="941.45">native code in as an app right and this</span> <span data-start="941.45" data-end="943.16">sort of thing really helps out in that</span> <span data-start="943.16" data-end="944.87">context I would imagine you know I don't</span> <span data-start="944.87" data-end="946.61">have any inside apple knowledge right</span> <span data-start="946.61" data-end="948.65">but it seems pretty clear that's what</span> <span data-start="948.65" data-end="950.36">what the deal is the other thing you can</span> <span data-start="950.36" data-end="953.24">do is you can actually use the ll into</span> <span data-start="953.24" data-end="955.4">profile what values are flowing through</span> <span data-start="955.4" data-end="957.59">your interpreter and you can use this</span> <span data-start="957.59" data-end="960.89">information as input you're optimizing</span> <span data-start="960.89" data-end="963.14">compilers say oh actually I've never</span> <span data-start="963.14" data-end="965.26">seen a negative zero in this</span> <span data-start="965.26" data-end="966.52">of the computation and you would be</span> <span data-start="966.52" data-end="969.46">amazed like how much work goes into</span> <span data-start="969.46" data-end="970.93">proving that you'll never see a negative</span> <span data-start="970.93" data-end="974.29">zero because if you can there's many</span> <span data-start="974.29" data-end="976.57">more code cases right so if you can</span> <span data-start="976.57" data-end="978.16">prove that you can't or you can</span> <span data-start="978.16" data-end="979.48">speculate that you can't because you</span> <span data-start="979.48" data-end="981.28">haven't seen one then then you can do</span> <span data-start="981.28" data-end="982.96">much better right</span> <span data-start="982.96" data-end="985.21">so that's tier 0 the low-level</span> <span data-start="985.21" data-end="988.33">interpreter tier 1 would be what was</span> <span data-start="988.33" data-end="990.52">called squirrelfish extreme if anyone</span> <span data-start="990.52" data-end="992.86">remembers this one it's essentially you</span> <span data-start="992.86" data-end="994.9">take all the all those code segments I</span> <span data-start="994.9" data-end="996.94">showed you like those little labels and</span> <span data-start="996.94" data-end="1001.11">instead of making making the the native</span> <span data-start="1001.11" data-end="1002.43">machine jump back and forth in between</span> <span data-start="1002.43" data-end="1004.47">those labels you you copy them out and</span> <span data-start="1004.47" data-end="1006.45">serialize them so the native machine</span> <span data-start="1006.45" data-end="1010.08">pointer is advancing you you you miss</span> <span data-start="1010.08" data-end="1012.63">fuer branches the the branch predictions</span> <span data-start="1012.63" data-end="1017.82">work better you can do some small</span> <span data-start="1017.82" data-end="1021.33">optimizations here as well and this JIT</span> <span data-start="1021.33" data-end="1023.91">until the element was amended was also</span> <span data-start="1023.91" data-end="1027.36">this sort of standard for execution of</span> <span data-start="1027.36" data-end="1029.49">all JavaScript it's generic it handles</span> <span data-start="1029.49" data-end="1031.74">all the cases and it's okay</span> <span data-start="1031.74" data-end="1033.99">the advantage of course is that you also</span> <span data-start="1033.99" data-end="1035.94">control the stack as opposed to the old</span> <span data-start="1035.94" data-end="1038.76">interpreter so it helps you when you can</span> <span data-start="1038.76" data-end="1040.41">tear up to the optimizing compiler after</span> <span data-start="1040.41" data-end="1041.55">that all right</span> <span data-start="1041.55" data-end="1048.8">no c++ right crazy macro macro LAN</span> <span data-start="1048.8" data-end="1050.88">again I just want to show you the shape</span> <span data-start="1050.88" data-end="1053.31">here we're parsing out the arguments in</span> <span data-start="1053.31" data-end="1054.9">the beginning just as we were doing and</span> <span data-start="1054.9" data-end="1056.82">any other interpreters its operating on</span> <span data-start="1056.82" data-end="1058.11">the bytecode it's turning the bytecode</span> <span data-start="1058.11" data-end="1060.36">into native code and we have a few more</span> <span data-start="1060.36" data-end="1063.84">you know if blocks this means we have a</span> <span data-start="1063.84" data-end="1065.7">few more cases that we can compile</span> <span data-start="1065.7" data-end="1067.65">specially meaning your code can go a bit</span> <span data-start="1067.65" data-end="1069.9">more a bit faster if we can tell that</span> <span data-start="1069.9" data-end="1073.44">you're adding a constant to a constant</span> <span data-start="1073.44" data-end="1076.53">small number to a number right then the</span> <span data-start="1076.53" data-end="1079.26">the it can predict a bit better or what</span> <span data-start="1079.26" data-end="1080.67">you're going to have while still having</span> <span data-start="1080.67" data-end="1083.76">to implement the slow path but general</span> <span data-start="1083.76" data-end="1086.1">it doesn't have flow control it doesn't</span> <span data-start="1086.1" data-end="1088.19">know what's really happening</span> <span data-start="1088.19" data-end="1090.29">so it can just guess it has to be fast</span> <span data-start="1090.29" data-end="1092.33">it just slings out the native code and</span> <span data-start="1092.33" data-end="1095.66">then if you actually need it the D F G</span> <span data-start="1095.66" data-end="1098.6">is there D F G stands for a data flow</span> <span data-start="1098.6" data-end="1101.51">graph and it refers to how the type</span> <span data-start="1101.51" data-end="1103.73">information propagates in the optimizing</span> <span data-start="1103.73" data-end="1106.61">compiler this is for JavaScript core</span> <span data-start="1106.61" data-end="1111.77">what the higher levels of hotspot or</span> <span data-start="1111.77" data-end="1114.44">what crankshaft is for for v8 like this</span> <span data-start="1114.44" data-end="1116.03">is that right this this is the</span> <span data-start="1116.03" data-end="1118.07">optimizing compiler that tries to you</span> <span data-start="1118.07" data-end="1119.42">know spend a bit more time on your on</span> <span data-start="1119.42" data-end="1122.41">your hot code and use the type back to</span> <span data-start="1122.41" data-end="1126.11">unbox your numbers to find your</span> <span data-start="1126.11" data-end="1128.9">functions to what else I say here native</span> <span data-start="1128.9" data-end="1132.08">arithmetic and objects in allocate</span> <span data-start="1132.08" data-end="1134.96">registers and and all the things in</span> <span data-start="1134.96" data-end="1136.94">order to be able to do this you need a</span> <span data-start="1136.94" data-end="1138.29">couple of things you need to be able to</span> <span data-start="1138.29" data-end="1140.39">tear down which is this OSR thing and</span> <span data-start="1140.39" data-end="1141.44">you couldn't tear down to the</span> <span data-start="1141.44" data-end="1143.78">interpreter before because you didn't</span> <span data-start="1143.78" data-end="1146.3">control the layout of the stack but now</span> <span data-start="1146.3" data-end="1148.22">with the element you can tear between</span> <span data-start="1148.22" data-end="1150.17">all these different levels</span> <span data-start="1150.17" data-end="1152.6">you also need profiling information</span> <span data-start="1152.6" data-end="1155.9">about you know is this thing that is a</span> <span data-start="1155.9" data-end="1157.94">plus in the JavaScript source code is it</span> <span data-start="1157.94" data-end="1161.09">out of the numbers and if it's further</span> <span data-start="1161.09" data-end="1166.4">they doubles or are they small and and</span> <span data-start="1166.4" data-end="1167.96">you need the ability to sort of abort</span> <span data-start="1167.96" data-end="1169.85">when you're when your speculation fails</span> </p>
<p><span data-start="1169.85" data-end="1173">I cool and and crankshaft is is cool in</span> <span data-start="1173" data-end="1176.42">the same way that you can just try</span> <span data-start="1176.42" data-end="1178.52">really hard to emit the correct code</span> <span data-start="1178.52" data-end="1180.26">like assume that things are going to</span> <span data-start="1180.26" data-end="1182">work out and if things don't if you see</span> <span data-start="1182" data-end="1184.94">that negative zero then you bail and and</span> <span data-start="1184.94" data-end="1187.13">things go on with with the older JIT and</span> <span data-start="1187.13" data-end="1189.59">it doesn't go as fast but maybe it's</span> <span data-start="1189.59" data-end="1191.92">your fault anyway I don't know</span> <span data-start="1191.92" data-end="1196.01">it's a DFG I this is even more abstract</span> <span data-start="1196.01" data-end="1197.78">but I want to point out a couple of</span> <span data-start="1197.78" data-end="1200.75">points here and it's this word should</span> <span data-start="1200.75" data-end="1205.16">write before in the baseline JIT we</span> <span data-start="1205.16" data-end="1207.26">didn't know whether we you know should</span> <span data-start="1207.26" data-end="1209.03">speculate for an integer or should</span> <span data-start="1209.03" data-end="1214.31">speculate for a double or should only go</span> <span data-start="1214.31" data-end="1216.86">the slow path of string concatenation or</span> <span data-start="1216.86" data-end="1218.9">what have you but in the DFG we've</span> <span data-start="1218.9" data-end="1220.61">actually done some flow analysis we've</span> <span data-start="1220.61" data-end="1221.45">eliminated</span> <span data-start="1221.45" data-end="1223.429">code we've propagated types around and</span> <span data-start="1223.429" data-end="1225.62">so we can you know have an answer for</span> <span data-start="1225.62" data-end="1227.12">this should what should I do</span> <span data-start="1227.12" data-end="1229.85">right and that's that's what the DFG is</span> <span data-start="1229.85" data-end="1234.889">able to do and as far as comment works</span> <span data-start="1234.889" data-end="1238.25">go in JavaScript core now there is the</span> <span data-start="1238.25" data-end="1239.659">classic interpreter it's still there</span> <span data-start="1239.659" data-end="1241.73">there is the low-level interpreter there</span> <span data-start="1241.73" data-end="1243.98">is the baseline JIT and there is the DFG</span> </p>
<p><span data-start="1243.98" data-end="1245.539">JIT and they can exist in various</span> <span data-start="1245.539" data-end="1248.269">combinations and depends on the port as</span> <span data-start="1248.269" data-end="1251.6">to what actually exists on the Mac on</span> <span data-start="1251.6" data-end="1256.399">x86 32 and 64 and on arm v7 you get the</span> <span data-start="1256.399" data-end="1258.769">combination ll in baseline JIT and DFG</span> <span data-start="1258.769" data-end="1260.899">this is really what you want a lot of</span> <span data-start="1260.899" data-end="1262.46">the other ports like I work on the GDK</span> <span data-start="1262.46" data-end="1267.789">portable it hasn't caught up yet and</span> <span data-start="1267.789" data-end="1272.899">only have like the baseline JIT gtk</span> <span data-start="1272.899" data-end="1275.12">right now and JIT is it a minute at all</span> <span data-start="1275.12" data-end="1277.429">on Windows for for examples so you just</span> <span data-start="1277.429" data-end="1278.69">get the classic interpreter but it's</span> <span data-start="1278.69" data-end="1280.13">kind of nice that you actually have a</span> <span data-start="1280.13" data-end="1281.99">portable interpreter to run things on</span> <span data-start="1281.99" data-end="1284.029">you know even if you're on some strange</span> <span data-start="1284.029" data-end="1288.23">platform like Windows 64 so again back</span> <span data-start="1288.23" data-end="1292.22">to nor bigs for ways to speed up the</span> <span data-start="1292.22" data-end="1294.049">algorithm caching compiling delaying</span> <span data-start="1294.049" data-end="1296.289">commutation and you know for charitable</span> </p>
<p><span data-start="1296.289" data-end="1299.33">I feel like we're missing something you</span> <span data-start="1299.33" data-end="1301.94">know because this is what Norvig was</span> <span data-start="1301.94" data-end="1306.38">writing about in 1992 on big lists</span> <span data-start="1306.38" data-end="1308.12">machines and some things are available</span> <span data-start="1308.12" data-end="1309.86">to us now that we're not available to</span> <span data-start="1309.86" data-end="1313.179">amend it specifically concurrency and</span> <span data-start="1313.179" data-end="1315.44">you know how can we you know bring</span> <span data-start="1315.44" data-end="1317.809">concurrency to bear on the problem of</span> <span data-start="1317.809" data-end="1320.99">making JavaScript implementations faster</span> <span data-start="1320.99" data-end="1323.84">and what JavaScript core has been doing</span> <span data-start="1323.84" data-end="1326.72">is to paralyze what's called the mark</span> <span data-start="1326.72" data-end="1329.539">phase of garbage collection so garbage</span> <span data-start="1329.539" data-end="1330.86">collection goes you allocate you</span> <span data-start="1330.86" data-end="1332.84">allocate you allocate and at some point</span> <span data-start="1332.84" data-end="1334.37">there's there's no more free memory</span> <span data-start="1334.37" data-end="1336.83">right so you stop you mark all the live</span> <span data-start="1336.83" data-end="1342.7">data all the data which gets free</span> <span data-start="1342.71" data-end="1345.68">and this marking phase stops your</span> <span data-start="1345.68" data-end="1347.21">application right so if you have</span> <span data-start="1347.21" data-end="1348.65">something that's trying to update at 30</span> <span data-start="1348.65" data-end="1358.92">frames a second or you know even more</span> <span data-start="1358.93" data-end="1361.13">what again</span> </p>
<p><span data-start="1361.13" data-end="1363.2">Philip is low I hope to meet him one day</span> <span data-start="1363.2" data-end="1364.39">because he sounds really awesome</span> <span data-start="1364.39" data-end="1367.1">terrible is this mark face so we can use</span> <span data-start="1367.1" data-end="1370.85">for cours upward force it can use more</span> <span data-start="1370.85" data-end="1378.25">this is a value in the garbage collector</span> <span data-start="1378.25" data-end="1380.59">and I think coming to the end here</span> <span data-start="1380.59" data-end="1386.78">finally so this is nor big in this book</span> <span data-start="1386.78" data-end="1388.73">as this chapter nothing called on</span> <span data-start="1388.73" data-end="1391.13">efficiency and if you substitute lips</span> <span data-start="1391.13" data-end="1394.58">list for yeah I just list if you</span> <span data-start="1394.58" data-end="1396.68">substitute list for a JavaScript when</span> <span data-start="1396.68" data-end="1399.34">you're reading this if you check it out</span> <span data-start="1399.34" data-end="1403.64">or what have you then you're it's it's</span> <span data-start="1403.64" data-end="1404.96">quite relevant you know to modern-day</span> <span data-start="1404.96" data-end="1406.43">programming and JavaScript and</span> </p>
<p><span data-start="1406.43" data-end="1408.53">JavaScript implementations and one of</span> <span data-start="1408.53" data-end="1410.27">the things he says is that the expert</span> <span data-start="1410.27" data-end="1413.03">Lisp programmer eventually develops a</span> <span data-start="1413.03" data-end="1415.01">good efficiency model you know what what</span> <span data-start="1415.01" data-end="1417.02">is the cost of what I'm doing there's a</span> <span data-start="1417.02" data-end="1419.87">quote by Alan Perlis that a lisp</span> <span data-start="1419.87" data-end="1421.37">programmer and there was the value of</span> <span data-start="1421.37" data-end="1423.77">everything but the cost of nothing but</span> <span data-start="1423.77" data-end="1426.14">the thing is is that this efficiency</span> <span data-start="1426.14" data-end="1429.32">model changes over time right the things</span> <span data-start="1429.32" data-end="1431.09">that are fast now in JavaScript I was</span> <span data-start="1431.09" data-end="1432.41">talking to a fella yesterday's like well</span> <span data-start="1432.41" data-end="1435.44">you know if you just do this for x</span> <span data-start="1435.44" data-end="1437.96">equals 1 X is less than and you know do</span> <span data-start="1437.96" data-end="1439.34">something on my array that's much faster</span> <span data-start="1439.34" data-end="1441.83">than array for each well why is this</span> <span data-start="1441.83" data-end="1444.95">it's because the benchmarks don't have</span> <span data-start="1444.95" data-end="1448.04">array for each all right JavaScript</span> <span data-start="1448.04" data-end="1449.87">invitations are completely driven by</span> <span data-start="1449.87" data-end="1453.68">benchmarks and and you as programmers</span> <span data-start="1453.68" data-end="1457.07">are in this loop right if something if</span> <span data-start="1457.07" data-end="1458.84">there's a way that you want to program</span> <span data-start="1458.84" data-end="1463.64">it's not working you can file bug</span> <span data-start="1463.64" data-end="1465.47">reports or grade benchmark sweets or</span> <span data-start="1465.47" data-end="1467.72">such and and get it to a point where it</span> <span data-start="1467.72" data-end="1469.7">where it is fast like this efficiency</span> <span data-start="1469.7" data-end="1471.47">model can change over time and don't let</span> <span data-start="1471.47" data-end="1473.84">you know what's currently fast or slow</span> <span data-start="1473.84" data-end="1475.299">crimper style</span> <span data-start="1475.299" data-end="1478.809">so to speak and I think I'd say we can</span> <span data-start="1478.809" data-end="1480.7">do some questions you can find me this</span> <span data-start="1480.7" data-end="1484.419">dress or that website so thank you very</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
