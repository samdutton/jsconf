<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DWZj56qUNfs</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/DWZj56qUNfs?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="0.62" data-end="14.63">[Music]</span> <span data-start="14.63" data-end="20.43">okay let's begin good morning everyone</span> <span data-start="20.43" data-end="25.38">so today I'm going to talk about race</span> <span data-start="25.38" data-end="28.619">conditions in JavaScript apps and so</span> <span data-start="28.619" data-end="30.48">right the title of this talk is about</span> <span data-start="30.48" data-end="33.39">race conditions today I'm going to talk</span> <span data-start="33.39" data-end="36.329">about other things as well maybe other</span> <span data-start="36.329" data-end="38.82">edge cases that are not strictly race</span> <span data-start="38.82" data-end="41.1">conditions but you may encounter them</span> <span data-start="41.1" data-end="44.19">when you write a synchronous code so</span> <span data-start="44.19" data-end="47.03">before I begin to talk I would like to</span> <span data-start="47.03" data-end="51.03">share a bit of story before like how</span> <span data-start="51.03" data-end="54.629">this talk came to be so I first got the</span> <span data-start="54.629" data-end="59.37">idea of for this talk on one day on that</span> <span data-start="59.37" data-end="61.32">day I went to a local meet up in</span> </p>
<p><span data-start="61.32" data-end="63.989">Thailand and after the talks are done</span> <span data-start="63.989" data-end="66.45">it's like networking time and my friend</span> <span data-start="66.45" data-end="70.86">approached me and asked me hey ty is it</span> <span data-start="70.86" data-end="73.26">hard to deal with race conditions in</span> <span data-start="73.26" data-end="77.159">JavaScript so I answered well is</span> <span data-start="77.159" data-end="80.85">actually pretty easy you just don't</span> <span data-start="80.85" data-end="84.39">forget about them he gives me a bit of a</span> <span data-start="84.39" data-end="87.36">confused look and I was like hey I'm</span> <span data-start="87.36" data-end="90.72">totally serious here let me show you a</span> <span data-start="90.72" data-end="92.88">couple of examples so I took out my</span> <span data-start="92.88" data-end="95.43">laptop and start coding showing him some</span> <span data-start="95.43" data-end="98.43">examples and before long it turned into</span> <span data-start="98.43" data-end="102.72">a really deep discussion so after that</span> <span data-start="102.72" data-end="106.799">discussion my friend told me whoa this</span> <span data-start="106.799" data-end="110.729">could have been a food talk why don't</span> <span data-start="110.729" data-end="112.17">you make a talk out of it and submit it</span> <span data-start="112.17" data-end="114.99">to judge point for something so here I</span> <span data-start="114.99" data-end="119.219">am and a big shout out goes to same for</span> <span data-start="119.219" data-end="121.25">giving me the inspiration for this talk</span> <span data-start="121.25" data-end="125.369">he's with us here as well so next time</span> <span data-start="125.369" data-end="127.29">you have a deep technical discussion</span> <span data-start="127.29" data-end="129.629">maybe you can tell your friend to like</span> <span data-start="129.629" data-end="132.66">consider submitting a talk</span> <span data-start="132.66" data-end="136.77">so this makes it my second time speaking</span> <span data-start="136.77" data-end="139.77">here at just wants a CS so big big</span> <span data-start="139.77" data-end="142.92">thanks to Thomas and all the organizers</span> <span data-start="142.92" data-end="145.29">involved in running this conference it's</span> <span data-start="145.29" data-end="147.3">really great and thank you for having me</span> <span data-start="147.3" data-end="150.06">once again so today I'm going to show</span> <span data-start="150.06" data-end="152.1">you two stories from my experience</span> <span data-start="152.1" data-end="155.09">dealing with race conditions and stuff</span> <span data-start="155.09" data-end="157.8">so I hope you can learn something out of</span> <span data-start="157.8" data-end="161.25">these stories as I did by the way my</span> <span data-start="161.25" data-end="164.49">name is ty and I'm from Thailand my</span> <span data-start="164.49" data-end="167.91">twitter handle is at DT ints and if you</span> <span data-start="167.91" data-end="169.86">have any feedback about this talk please</span> <span data-start="169.86" data-end="172.32">send it to me and I would really</span> <span data-start="172.32" data-end="175.68">appreciate it I'm currently working at</span> <span data-start="175.68" data-end="177.78">task whereas the front-end architect and</span> </p>
<p><span data-start="177.78" data-end="179.31">I'll get back to that later</span> <span data-start="179.31" data-end="182.6">but now here comes the first story and</span> <span data-start="182.6" data-end="186.81">this story involves little search box so</span> <span data-start="186.81" data-end="189.06">in this search boss as I type a keyword</span> <span data-start="189.06" data-end="192.17">is going to show the search result and</span> <span data-start="192.17" data-end="194.67">it's going to show the result instantly</span> <span data-start="194.67" data-end="196.26">so I don't have to press ENTER or</span> <span data-start="196.26" data-end="196.62">anything</span> <span data-start="196.62" data-end="199.74">it's like Google's autosuggest so let's</span> <span data-start="199.74" data-end="201.51">build this real quick first we need the</span> <span data-start="201.51" data-end="205.05">mock up so here I'm going to use the</span> <span data-start="205.05" data-end="207.45">section for the rapper then it does an</span> <span data-start="207.45" data-end="210.42">input box right there and then list</span> <span data-start="210.42" data-end="214.08">containing the result so that's all the</span> <span data-start="214.08" data-end="217.02">mock-up we need and next we're going to</span> <span data-start="217.02" data-end="220.11">add some interactivity and for that I'm</span> <span data-start="220.11" data-end="225.9">going to use VJ s so let's start with</span> <span data-start="225.9" data-end="228.18">the data model for our state first we</span> <span data-start="228.18" data-end="230.34">need to store the security that the user</span> <span data-start="230.34" data-end="234.81">type and we can buy that today input box</span> <span data-start="234.81" data-end="238.02">using the Wemo directive then we also</span> <span data-start="238.02" data-end="240.18">need to store the search result to be</span> <span data-start="240.18" data-end="242.34">displayed on the list here and to do</span> <span data-start="242.34" data-end="246.15">that we can use the we four directive to</span> <span data-start="246.15" data-end="248.04">do the binding and finally we buy the</span> <span data-start="248.04" data-end="250.08">content of each result into the</span> <span data-start="250.08" data-end="254.22">respective elements so that the data and</span> <span data-start="254.22" data-end="256.459">the Dom they are now kept in sync so</span> <span data-start="256.459" data-end="259.5">when the user enters the text Kure into</span> <span data-start="259.5" data-end="262.35">the input field is going to update the</span> <span data-start="262.35" data-end="265.71">text right here and we can wash for when</span> <span data-start="265.71" data-end="266.5">it changes</span> <span data-start="266.5" data-end="270.04">and when it changes we can perform in a</span> <span data-start="270.04" data-end="272.74">synchronous Kure by calling the search</span> <span data-start="272.74" data-end="275.44">function right there it's going to</span> <span data-start="275.44" data-end="277.39">return a promise so we have to await it</span> <span data-start="277.39" data-end="280.66">and once the result arrived we save it</span> <span data-start="280.66" data-end="282.49">into this page which will be displayed</span> <span data-start="282.49" data-end="286.6">on the user interface so then we have it</span> <span data-start="286.6" data-end="288.76">and let's see how it goes</span> <span data-start="288.76" data-end="292.81">so okay I'm going to type in react I</span> <span data-start="292.81" data-end="297.16">don't know why but okay so the result</span> <span data-start="297.16" data-end="300.13">shows up and that's good but it seems</span> <span data-start="300.13" data-end="302.74">that the result that I see here doesn't</span> <span data-start="302.74" data-end="305.77">have anything to do with react so what's</span> <span data-start="305.77" data-end="308.38">going on here let's try again but this</span> <span data-start="308.38" data-end="310.83">time I built an inspector on the right</span> <span data-start="310.83" data-end="315.66">so that we can see what's going on okay</span> <span data-start="315.66" data-end="319.57">you can see here that the result I want</span> <span data-start="319.57" data-end="323.59">to see is overwritten by the result of</span> <span data-start="323.59" data-end="326.5">the request that I made earlier but it</span> <span data-start="326.5" data-end="329.59">finished later so it overrides their the</span> <span data-start="329.59" data-end="332.71">the Dom and you know this kind of makes</span> <span data-start="332.71" data-end="335.83">sense because the shorter the Kure maybe</span> <span data-start="335.83" data-end="337.81">it will return more result and maybe it</span> <span data-start="337.81" data-end="341.58">will take longer to load so you cannot</span> <span data-start="341.58" data-end="344.56">depend on the order of the request to</span> <span data-start="344.56" data-end="346.53">correspond to the order of the response</span> <span data-start="346.53" data-end="350.38">so you can think of an a sync function</span> <span data-start="350.38" data-end="354.43">as a function that spawns the trade and</span> <span data-start="354.43" data-end="357.31">the Dom here is a shared mutable state</span> <span data-start="357.31" data-end="359.919">so you know when dealing with shared</span> <span data-start="359.919" data-end="362.95">mutable state we have to be careful</span> <span data-start="362.95" data-end="366.46">so let's come back to this code when we</span> <span data-start="366.46" data-end="368.86">face problem like this one of the common</span> <span data-start="368.86" data-end="372.13">approach I see very often is to do a D</span> <span data-start="372.13" data-end="374.919">bounce and what I mean by D bouncing is</span> <span data-start="374.919" data-end="376.99">that instead of doing the search right</span> <span data-start="376.99" data-end="379.96">away we're going to wait a bit until the</span> <span data-start="379.96" data-end="382.96">user has finished typing and after that</span> <span data-start="382.96" data-end="385.96">period of inactivity then we do the</span> <span data-start="385.96" data-end="391.15">search as usual so let's try it okay it</span> <span data-start="391.15" data-end="393.94">seems to work because now it only</span> <span data-start="393.94" data-end="396.58">performs a single request there are no</span> <span data-start="396.58" data-end="399.729">more competing requests but you know it</span> <span data-start="399.729" data-end="402.13">went with the D bounce it still doesn't</span> <span data-start="402.13" data-end="405.789">guarantee the order of the response so I</span> <span data-start="405.789" data-end="408.669">could do something like this then we're</span> <span data-start="408.669" data-end="411.34">back to the same problem so let's step</span> <span data-start="411.34" data-end="414.7">back and look at this code again the</span> <span data-start="414.7" data-end="417.07">real problem here is that while we are</span> <span data-start="417.07" data-end="420.16">waiting for the result to arrive I could</span> <span data-start="420.16" data-end="422.77">have triggered another search and in</span> <span data-start="422.77" data-end="426.01">this case when the result did arrive it</span> <span data-start="426.01" data-end="427.75">might not make sense to use it anymore</span> <span data-start="427.75" data-end="431.02">because now I have already triggered</span> <span data-start="431.02" data-end="434.02">another search so let's fix this but</span> <span data-start="434.02" data-end="435.729">first I'm going to get rid of the D</span> <span data-start="435.729" data-end="439.21">bounce because it didn't work instead</span> </p>
<p><span data-start="439.21" data-end="442.21">I'm going to generate a unique ID for</span> <span data-start="442.21" data-end="445.12">each request then keep track of the</span> <span data-start="445.12" data-end="450.789">latest request ID here and when we after</span> <span data-start="450.789" data-end="453.82">we await maybe this not latest request</span> <span data-start="453.82" data-end="456.7">ID could have changed so we compare if</span> <span data-start="456.7" data-end="458.729">the request ID we are holding onto</span> <span data-start="458.729" data-end="461.289">doesn't corresponds to the latest</span> <span data-start="461.289" data-end="463.659">request we'll just discard the result</span> <span data-start="463.659" data-end="470.159">and let's see okay now it works and</span> <span data-start="470.159" data-end="473.11">because we only care about the result of</span> <span data-start="473.11" data-end="477.19">the latest request other other response</span> <span data-start="477.19" data-end="481.659">got discarded but here now I am</span> <span data-start="481.659" data-end="483.97">searching really slowly and you can see</span> <span data-start="483.97" data-end="488.02">that until I finished typing I get no</span> <span data-start="488.02" data-end="490.12">feedback whatsoever from the search box</span> <span data-start="490.12" data-end="493.659">and that makes me fear that the search</span> <span data-start="493.659" data-end="498.28">box is a bit unresponsive because you</span> <span data-start="498.28" data-end="500.65">know before the resolve could arrive I</span> <span data-start="500.65" data-end="503.919">type another letter so it discarded the</span> <span data-start="503.919" data-end="508.45">result that the interim result but if we</span> <span data-start="508.45" data-end="510.729">compare that to Google even on a very</span> <span data-start="510.729" data-end="513.969">slow internet I still get the result as</span> </p>
<p><span data-start="513.969" data-end="516.94">I type even if it lacks behind by</span> <span data-start="516.94" data-end="520.209">several characters so it's clear that</span> <span data-start="520.209" data-end="523.78">they are not totally disregarding the</span> <span data-start="523.78" data-end="528.25">result that is not the latest so I think</span> <span data-start="528.25" data-end="530.5">we can do better so instead of</span> <span data-start="530.5" data-end="532.37">discarding the result that</span> <span data-start="532.37" data-end="533.899">doesn't correspond to the latest</span> <span data-start="533.899" data-end="537.29">requests what if we only discard the</span> <span data-start="537.29" data-end="541.67">result that arrived out of order so we</span> <span data-start="541.67" data-end="546.8">can do this and let's see okay now it</span> <span data-start="546.8" data-end="549.23">seems to work and you can see here that</span> </p>
<p><span data-start="549.23" data-end="551.93">I get the result I want even before I</span> <span data-start="551.93" data-end="557.509">finished typing so yeah you can see that</span> <span data-start="557.509" data-end="561.139">this humble little search box it took me</span> <span data-start="561.139" data-end="563.809">three attempts until I can get it right</span> <span data-start="563.809" data-end="567.079">and that brings me to the first takeaway</span> <span data-start="567.079" data-end="570.379">for this first story which is to always</span> <span data-start="570.379" data-end="573.439">remember about the potential risk</span> <span data-start="573.439" data-end="575.92">conditions whenever there is an await</span> <span data-start="575.92" data-end="579.439">call so each time you see in a wait</span> <span data-start="579.439" data-end="582.05">maybe think about what else could happen</span> <span data-start="582.05" data-end="584.089">while we are waiting for the result and</span> <span data-start="584.089" data-end="586.759">also think about whether or not it makes</span> <span data-start="586.759" data-end="590.92">sense to use the result after the wait</span> <span data-start="590.92" data-end="592.37">all right</span> <span data-start="592.37" data-end="595.399">that's the first story we're going to</span> <span data-start="595.399" data-end="598.43">continue with the second story and this</span> <span data-start="598.43" data-end="600.709">story came from like my experience</span> <span data-start="600.709" data-end="603.529">working at Tazewell and it is a</span> <span data-start="603.529" data-end="605.689">real-time collaborative project</span> <span data-start="605.689" data-end="608.569">management app and that's important and</span> <span data-start="608.569" data-end="612.47">you'll see why the story happened when</span> <span data-start="612.47" data-end="615.379">we built the app in its early days so</span> <span data-start="615.379" data-end="617.72">we're just starting out there it</span> <span data-start="617.72" data-end="619.579">happened about two to three years ago</span> <span data-start="619.579" data-end="622.639">and it has to do with something called</span> <span data-start="622.639" data-end="626.42">optimistic updates so for example our</span> <span data-start="626.42" data-end="629.209">app provides a Kanban board and suppose</span> <span data-start="629.209" data-end="631.129">that you drag a task from one list to</span> <span data-start="631.129" data-end="633.74">the other you wouldn't expect the task</span> <span data-start="633.74" data-end="637.129">to go into the loading State right well</span> <span data-start="637.129" data-end="639.47">no you expect the task to just snap</span> <span data-start="639.47" data-end="642.769">right into the new list and that's what</span> <span data-start="642.769" data-end="646.069">optimistic update is so basic idea is we</span> <span data-start="646.069" data-end="649.879">update the UI first in anticipation that</span> <span data-start="649.879" data-end="652.73">the request will be completed</span> <span data-start="652.73" data-end="655.819">successfully and raw we synchronize this</span> <span data-start="655.819" data-end="658.73">change with the server in the background</span> <span data-start="658.73" data-end="661.579">so having this kind of experience like</span> <span data-start="661.579" data-end="664.129">optimistic updates it's really important</span> <span data-start="664.129" data-end="666.54">for collaborative epic</span> <span data-start="666.54" data-end="670.59">patience but our app users react and</span> <span data-start="670.59" data-end="672.57">when we use to react</span> <span data-start="672.57" data-end="675.9">we like to derive our user interface</span> <span data-start="675.9" data-end="678.57">from the underlying data model so in</span> <span data-start="678.57" data-end="682.2">this case is the reader store so in</span> <span data-start="682.2" data-end="684.96">order to preserve the unidirectional</span> <span data-start="684.96" data-end="688.11">data flow we update the data model</span> <span data-start="688.11" data-end="691.92">instead and we're going to let it flow</span> <span data-start="691.92" data-end="696.18">into the UI and for this example maybe</span> <span data-start="696.18" data-end="699.21">moving a task is a bit complex operation</span> <span data-start="699.21" data-end="702.33">because it involves both a task and the</span> <span data-start="702.33" data-end="705.33">list so instead I'm going to just focus</span> <span data-start="705.33" data-end="710.37">on something simpler such as renaming a</span> <span data-start="710.37" data-end="714.42">task so when I hit enter here is going</span> <span data-start="714.42" data-end="717.63">to trigger an event handler and it will</span> <span data-start="717.63" data-end="720.45">call a function here rename task which</span> <span data-start="720.45" data-end="724.32">is our action and following this basic</span> <span data-start="724.32" data-end="726.66">pattern what we did is okay we update</span> <span data-start="726.66" data-end="729.18">the data model here and that's going to</span> <span data-start="729.18" data-end="732.12">cost the data model to flow into the</span> <span data-start="732.12" data-end="735.48">user interface and like that then we</span> <span data-start="735.48" data-end="737.37">make the API call to synchronize with</span> <span data-start="737.37" data-end="740.33">the backend and because sometimes</span> <span data-start="740.33" data-end="742.98">internet connection may not be stable or</span> <span data-start="742.98" data-end="744.72">something we are just going on with the</span> </p>
<p><span data-start="744.72" data-end="748.14">API we use a try cache to display the</span> <span data-start="748.14" data-end="751.08">error message just for good measure and</span> <span data-start="751.08" data-end="753.66">that's it that is how we implement it</span> <span data-start="753.66" data-end="757.2">basic optimistic updates and for most of</span> <span data-start="757.2" data-end="760.53">our operations in our app we write code</span> <span data-start="760.53" data-end="764.13">following this basic pattern and you</span> <span data-start="764.13" data-end="766.77">know this works really well and gives us</span> <span data-start="766.77" data-end="770.94">a really great experience as long as</span> <span data-start="770.94" data-end="773.88">never as long as nothing goes wrong so</span> <span data-start="773.88" data-end="776.82">it works well in the early days when we</span> <span data-start="776.82" data-end="779.58">are just starting out and our focus was</span> <span data-start="779.58" data-end="783.21">to figure out how we can make project</span> <span data-start="783.21" data-end="785.97">management to that our customers would</span> <span data-start="785.97" data-end="789.66">like to use however as we get more</span> <span data-start="789.66" data-end="792.57">customers we start getting reports such</span> <span data-start="792.57" data-end="794.91">as well our screens are displaying</span> <span data-start="794.91" data-end="798.54">different things you know they become</span> <span data-start="798.54" data-end="799.95">incomes</span> <span data-start="799.95" data-end="803.01">or something more serious such as this</span> <span data-start="803.01" data-end="805.92">one so someone writes a comment the</span> <span data-start="805.92" data-end="807.6">other person didn't receive it because</span> <span data-start="807.6" data-end="811.32">it never gets sent but the app acts as</span> <span data-start="811.32" data-end="815.49">if it was already sent so you know work</span> <span data-start="815.49" data-end="818.79">is lost and that's pretty serious I</span> <span data-start="818.79" data-end="822.27">think we came back to our code and it</span> <span data-start="822.27" data-end="825.89">became clear that our implementation of</span> <span data-start="825.89" data-end="829.23">optimistic update was indeed too</span> <span data-start="829.23" data-end="833.4">optimistic so there's no room for</span> <span data-start="833.4" data-end="836.19">anything to go wrong here and when it</span> <span data-start="836.19" data-end="838.98">does let's see for example if this API</span> <span data-start="838.98" data-end="842.58">call fails first we didn't live with our</span> <span data-start="842.58" data-end="844.86">data model back to the previous state so</span> <span data-start="844.86" data-end="847.8">each client will go its own way and it</span> <span data-start="847.8" data-end="850.8">will be totally out of sync and we also</span> <span data-start="850.8" data-end="853.59">didn't really try to request and this is</span> <span data-start="853.59" data-end="856.23">really bad because you know we tried so</span> <span data-start="856.23" data-end="858.24">hard and put in a lot of effort to like</span> <span data-start="858.24" data-end="861.6">craft a great experience that the</span> <span data-start="861.6" data-end="863.46">customer will want to use and now we are</span> <span data-start="863.46" data-end="866.43">just throwing their data away and you</span> <span data-start="866.43" data-end="868.14">know that's not what we want for our</span> <span data-start="868.14" data-end="871.74">users but well that was what we</span> <span data-start="871.74" data-end="875.6">implemented so at that time we</span> <span data-start="875.6" data-end="878.61">incorrectly assumed that building a</span> <span data-start="878.61" data-end="881.91">single page real-time collaborative app</span> <span data-start="881.91" data-end="885.27">and task management apps you know is</span> <span data-start="885.27" data-end="888.6">it's just like CI UD apps create read</span> <span data-start="888.6" data-end="891.9">update delete that's all that's mostly</span> <span data-start="891.9" data-end="894.42">what it does so it should be as simple</span> <span data-start="894.42" data-end="897.48">as Oh screw multi page application</span> <span data-start="897.48" data-end="900.15">because right because you know that's</span> <span data-start="900.15" data-end="901.59">what we know that's what we're familiar</span> <span data-start="901.59" data-end="905.97">with and if you write Ruby on Rails ya</span> <span data-start="905.97" data-end="909.81">doing a create thing is just as simple</span> <span data-start="909.81" data-end="913.11">as that so it's supposed to be simple</span> <span data-start="913.11" data-end="917.45">right well maybe not really and now here</span> <span data-start="917.45" data-end="921.93">here we are facing its consequence so we</span> <span data-start="921.93" data-end="924.36">have to fix it and that means we have to</span> <span data-start="924.36" data-end="926.85">go back and fix all of these operations</span> <span data-start="926.85" data-end="931.9">that we've implemented so far as well so</span> <span data-start="931.9" data-end="936.64">our goals shift data loss is a serious</span> <span data-start="936.64" data-end="940.57">problem and first to fix that we need to</span> <span data-start="940.57" data-end="943.78">try to achieve eventual consistency that</span> <span data-start="943.78" data-end="946.24">means everyone will eventually see the</span> <span data-start="946.24" data-end="948.73">same thing on their screen which I call</span> <span data-start="948.73" data-end="951.94">the ground truth without having to like</span> <span data-start="951.94" data-end="955.75">press refresh and second we want to</span> <span data-start="955.75" data-end="959.53">prevent data loss as much as we can so</span> <span data-start="959.53" data-end="961.86">let's first talk about the first one</span> <span data-start="961.86" data-end="964.87">coming back to this code record the</span> <span data-start="964.87" data-end="967.48">previous part where I say when the API</span> <span data-start="967.48" data-end="969.28">call failed we didn't reword this state</span> <span data-start="969.28" data-end="970.36">right</span> <span data-start="970.36" data-end="973.42">maybe that's quite easy to fix right</span> <span data-start="973.42" data-end="976.99">we just start a previous title here and</span> <span data-start="976.99" data-end="978.46">when that's an error</span> <span data-start="978.46" data-end="983.8">we just revert and that would work would</span> <span data-start="983.8" data-end="988.86">it as we learned from our first story</span> <span data-start="988.86" data-end="991.99">you see in a weight and anything could</span> <span data-start="991.99" data-end="994.45">happen here especially in a real-time</span> <span data-start="994.45" data-end="998.43">app so for example someone may</span> <span data-start="998.43" data-end="1000.72">successfully update this task while</span> <span data-start="1000.72" data-end="1003.18">we're awaiting here and that means the</span> <span data-start="1003.18" data-end="1006.66">previous title that we stored will no</span> <span data-start="1006.66" data-end="1008.37">longer become well it and we cannot use</span> <span data-start="1008.37" data-end="1009.18">it anymore</span> <span data-start="1009.18" data-end="1013.2">so the more is cases we try to solve the</span> <span data-start="1013.2" data-end="1016.47">more they seem to come up and what about</span> <span data-start="1016.47" data-end="1018.24">more complex operations such as like</span> <span data-start="1018.24" data-end="1021.18">moving a task between lists how how much</span> <span data-start="1021.18" data-end="1024.42">complex would our quote be if we were to</span> <span data-start="1024.42" data-end="1026.58">handle all the edge cases in all of</span> <span data-start="1026.58" data-end="1030.48">these operations uh is there something</span> <span data-start="1030.48" data-end="1032.34">fundamentally wrong with the way we are</span> <span data-start="1032.34" data-end="1036.36">writing code so I took another step back</span> <span data-start="1036.36" data-end="1038.22">and think about the way we are</span> <span data-start="1038.22" data-end="1041.04">approaching optimistic updates and then</span> </p>
<p><span data-start="1041.04" data-end="1044.66">I realized that if we want to have</span> <span data-start="1044.66" data-end="1047.61">eventual consistency we must try to</span> <span data-start="1047.61" data-end="1051.66">stick with the ground truth I defined it</span> <span data-start="1051.66" data-end="1054.09">as the letter state that we received</span> <span data-start="1054.09" data-end="1057.39">from or delay or delayed the thing that</span> <span data-start="1057.39" data-end="1060.3">was acknowledged by the backend can be</span> <span data-start="1060.3" data-end="1062.37">considered the ground truth and each</span> <span data-start="1062.37" data-end="1065.04">time we update the model of the</span> <span data-start="1065.04" data-end="1068.78">basically here we are moving away from</span> <span data-start="1068.78" data-end="1072.21">that ground truth and considering that</span> <span data-start="1072.21" data-end="1074.52">everything else may be going on and</span> <span data-start="1074.52" data-end="1077.42">happening all around that will make it</span> <span data-start="1077.42" data-end="1081.72">hard harder to ever come back to it so</span> <span data-start="1081.72" data-end="1084.78">maybe we should leave that data model</span> <span data-start="1084.78" data-end="1087.95">alone and don't update it optimistically</span> <span data-start="1087.95" data-end="1092">but then how would we implement</span> <span data-start="1092" data-end="1098.31">optimistic UI then we figure something</span> <span data-start="1098.31" data-end="1103.58">out what if we had a separate data model</span> <span data-start="1103.58" data-end="1105.54">representing a list of the pending</span> <span data-start="1105.54" data-end="1108.96">operations instead of optimistically</span> <span data-start="1108.96" data-end="1113.19">update the data model directly we just</span> <span data-start="1113.19" data-end="1115.14">add it to the list of pending operations</span> <span data-start="1115.14" data-end="1118.43">and when it's done we just remove it</span> <span data-start="1118.43" data-end="1122.01">when we render the UI we overlay the</span> <span data-start="1122.01" data-end="1124.53">pending change on top of what's inside</span> <span data-start="1124.53" data-end="1127.47">the model essentially computing a</span> <span data-start="1127.47" data-end="1129.96">project optimistic version of the task</span> <span data-start="1129.96" data-end="1136.23">on the fly in our components and that</span> <span data-start="1136.23" data-end="1137.97">could work because if the operation</span> <span data-start="1137.97" data-end="1140.85">fails the data model would be left alone</span> <span data-start="1140.85" data-end="1144.72">and the UI will revert back but if the</span> <span data-start="1144.72" data-end="1147.74">operation succeeded the ground truth</span> <span data-start="1147.74" data-end="1150.84">will be updated first then the operation</span> <span data-start="1150.84" data-end="1154.05">will be removed from the list and from</span> <span data-start="1154.05" data-end="1157.17">the UI perspective it's nothing change</span> <span data-start="1157.17" data-end="1160.47">so now we have a data model that allows</span> <span data-start="1160.47" data-end="1162.57">us to do optimistic up Dre updates</span> <span data-start="1162.57" data-end="1166.98">without driving us insane so now let's</span> <span data-start="1166.98" data-end="1170.64">consider a case where I just created a</span> <span data-start="1170.64" data-end="1173.76">task here and the blue bar right there</span> <span data-start="1173.76" data-end="1175.59">represents the time it take for the</span> <span data-start="1175.59" data-end="1179.07">operation to complete but now since we</span> <span data-start="1179.07" data-end="1180.6">have optimistic update</span> </p>
<p><span data-start="1180.6" data-end="1183.62">I see the task appear right away and</span> <span data-start="1183.62" data-end="1186.21">that means I can also interact with it</span> <span data-start="1186.21" data-end="1188.79">so let's say I immediately assigned</span> <span data-start="1188.79" data-end="1192.63">someone to that task in this case this</span> <span data-start="1192.63" data-end="1195.03">API call would fail because at this time</span> <span data-start="1195.03" data-end="1197.55">the task doesn't exist in the backend</span> <span data-start="1197.55" data-end="1198.71">yet</span> <span data-start="1198.71" data-end="1203.639">right so that will lead to a data loss</span> <span data-start="1203.639" data-end="1206.97">and we don't want that and that means I</span> <span data-start="1206.97" data-end="1208.679">need to wait until the previous</span> <span data-start="1208.679" data-end="1213.45">operation complete first before before</span> <span data-start="1213.45" data-end="1216.179">we can work on the subsequent operation</span> <span data-start="1216.179" data-end="1219.419">and that essentially means we have to</span> <span data-start="1219.419" data-end="1223.169">sequence our operations into an</span> <span data-start="1223.169" data-end="1227.129">operation queue so with the operation</span> <span data-start="1227.129" data-end="1229.889">queue implemented the action code now</span> <span data-start="1229.889" data-end="1233.009">looks like this so this is now even</span> <span data-start="1233.009" data-end="1234.629">simpler than the first one that we came</span> <span data-start="1234.629" data-end="1237.509">up and we just let the queue do his</span> <span data-start="1237.509" data-end="1240.989">thing so now all of our write operations</span> <span data-start="1240.989" data-end="1244.109">can be fixed by making it right to the</span> <span data-start="1244.109" data-end="1245.94">queue instead of calling the API</span> <span data-start="1245.94" data-end="1250.349">directly then we can update the UI to</span> <span data-start="1250.349" data-end="1253.499">compute the projected state by reading</span> <span data-start="1253.499" data-end="1257.099">from that queue so because the</span> <span data-start="1257.099" data-end="1259.71">operations are now sequence and managed</span> <span data-start="1259.71" data-end="1262.979">by the queue that means it can also take</span> <span data-start="1262.979" data-end="1265.08">care of Lee trying the failed request</span> <span data-start="1265.08" data-end="1270.169">and that helps us deal with data loss so</span> <span data-start="1270.169" data-end="1273.45">we haven't covered all the edge cases</span> <span data-start="1273.45" data-end="1276.779">yet and preventing further data loss</span> <span data-start="1276.779" data-end="1278.609">from here is like just a matter of</span> <span data-start="1278.609" data-end="1282.779">asking a series of what-if questions for</span> <span data-start="1282.779" data-end="1285.059">example what if the user closes the</span> <span data-start="1285.059" data-end="1287.239">browser arrived a queue is still running</span> <span data-start="1287.239" data-end="1289.979">well we can try to prevent the user from</span> <span data-start="1289.979" data-end="1292.649">quitting the browser or we can persist</span> <span data-start="1292.649" data-end="1294.899">the content of the queue into the</span> <span data-start="1294.899" data-end="1297.96">client-side storage so that it can be</span> <span data-start="1297.96" data-end="1300.69">resumed afterwards or we can do both</span> <span data-start="1300.69" data-end="1305.159">right but our user may be using our app</span> <span data-start="1305.159" data-end="1308.489">from a mobile device and it might not be</span> <span data-start="1308.489" data-end="1312.059">practical to do that so we decided to</span> <span data-start="1312.059" data-end="1314.22">also save the queue to the client</span> <span data-start="1314.22" data-end="1319.95">storage and that gives us as a bonus</span> <span data-start="1319.95" data-end="1323.309">give us a building block that if we want</span> <span data-start="1323.309" data-end="1326.009">to make our app work offline in the</span> <span data-start="1326.009" data-end="1328.799">future because you know progressive web</span> <span data-start="1328.799" data-end="1331.83">apps are becoming more popular each year</span> <span data-start="1331.83" data-end="1334.89">so yeah that's a good bonus for for</span> <span data-start="1334.89" data-end="1336.809">purchasing the cute to the clients</span> <span data-start="1336.809" data-end="1341.39">knowledge but then a user may be running</span> <span data-start="1341.39" data-end="1347.16">our app in multiple attempts so before</span> <span data-start="1347.16" data-end="1349.86">we decide to purchase the queue there</span> <span data-start="1349.86" data-end="1352.14">was no problem because each tap would</span> <span data-start="1352.14" data-end="1354.96">have its own queue but now the queue is</span> <span data-start="1354.96" data-end="1355.71">persistent</span> <span data-start="1355.71" data-end="1359.76">so it become a shared mutable state here</span> <span data-start="1359.76" data-end="1362.49">if every tap runs the queue at the same</span> <span data-start="1362.49" data-end="1366.39">time bad things going to happen so that</span> <span data-start="1366.39" data-end="1368.55">can be only one tab that runs this queue</span> <span data-start="1368.55" data-end="1375.78">but which one so today with today's web</span> <span data-start="1375.78" data-end="1378.179">technology we have shared web workers</span> <span data-start="1378.179" data-end="1380.58">and also so its workers so we have two</span> <span data-start="1380.58" data-end="1384.57">things so maybe we don't need any tap to</span> <span data-start="1384.57" data-end="1387.72">run it at all we can just do it in the</span> <span data-start="1387.72" data-end="1393.24">workers but today we also have this so I</span> <span data-start="1393.24" data-end="1398.309">guess we cannot use the workers yet so</span> <span data-start="1398.309" data-end="1400.65">we have to make it so that any tab can</span> <span data-start="1400.65" data-end="1403.74">work on the queue if and only if no</span> <span data-start="1403.74" data-end="1407.64">other tabs work on it but since our</span> <span data-start="1407.64" data-end="1410.63">client side storage can be a synchronous</span> <span data-start="1410.63" data-end="1413.46">there might be the case where more than</span> <span data-start="1413.46" data-end="1416.309">one tab looking at the queue and saw</span> <span data-start="1416.309" data-end="1420">that no one's running the queue and both</span> <span data-start="1420" data-end="1426.66">decide to work on it so who wins and you</span> <span data-start="1426.66" data-end="1430.17">know there can be only one tap working</span> <span data-start="1430.17" data-end="1432.03">on the queue that's a hot requirement</span> <span data-start="1432.03" data-end="1434.79">otherwise bad things going to happen so</span> <span data-start="1434.79" data-end="1437.52">we use a shared client-side storage and</span> <span data-start="1437.52" data-end="1441.059">have each I have each tap write its own</span> </p>
<p><span data-start="1441.059" data-end="1444.09">ID to this storage and after allow</span> <span data-start="1444.09" data-end="1448.05">really we read it back so the letters</span> <span data-start="1448.05" data-end="1451.44">the latest have to write wins and the</span> <span data-start="1451.44" data-end="1454.83">winning tap will periodically report its</span> <span data-start="1454.83" data-end="1456.96">status to the shared storage so that</span> <span data-start="1456.96" data-end="1459.69">other taps know that okay someone is</span> <span data-start="1459.69" data-end="1461.19">taking care of the queue and it's due</span> <span data-start="1461.19" data-end="1463.14">alive but</span> <span data-start="1463.14" data-end="1468.39">if that tap somehow disappeared um maybe</span> <span data-start="1468.39" data-end="1471.66">it maybe the user closed it maybe it</span> <span data-start="1471.66" data-end="1475.32">crashed then that we have to set up a</span> <span data-start="1475.32" data-end="1477.99">time out so that other taps could decide</span> <span data-start="1477.99" data-end="1480.75">that well the tap that originally work</span> <span data-start="1480.75" data-end="1485.79">on it has gone and can take over can</span> <span data-start="1485.79" data-end="1489.84">take a word the work left from the</span> <span data-start="1489.84" data-end="1495.59">previous tab so but what if the tap tap</span> <span data-start="1495.59" data-end="1499.83">disappeared didn't didn't went away it</span> <span data-start="1499.83" data-end="1504.6">just slept and it came back so we also</span> <span data-start="1504.6" data-end="1507.24">have to handle the case where where</span> <span data-start="1507.24" data-end="1509.61">where the cue has been taken away from</span> <span data-start="1509.61" data-end="1512.79">the tap that is not dead so as you can</span> <span data-start="1512.79" data-end="1515.25">see there was a lot of edge cases that</span> <span data-start="1515.25" data-end="1517.86">we have to handle to make our app more</span> <span data-start="1517.86" data-end="1521.85">resilient and to prevent data loss that</span> <span data-start="1521.85" data-end="1525.54">brings me to the takeaway that first I</span> <span data-start="1525.54" data-end="1528.24">didn't know that writing as the IUD apps</span> <span data-start="1528.24" data-end="1531.809">would have to be this complex you know</span> <span data-start="1531.809" data-end="1534.049">there's a lot of tutorials out there</span> <span data-start="1534.049" data-end="1536.54">teaching you to like how to make a</span> <span data-start="1536.54" data-end="1539.24">real-time to do application</span> <span data-start="1539.24" data-end="1542.4">collaborative using let's say socket IO</span> </p>
<p><span data-start="1542.4" data-end="1545.19">I have never seen any of them want me</span> <span data-start="1545.19" data-end="1549.66">about this when so these are the</span> <span data-start="1549.66" data-end="1551.7">problems we face when we try to build</span> <span data-start="1551.7" data-end="1555.299">production quality apps and that's why I</span> <span data-start="1555.299" data-end="1558.84">want to give this talk so much and the</span> <span data-start="1558.84" data-end="1561.419">next takeaway is knowing your tools can</span> <span data-start="1561.419" data-end="1564.03">help so there are higher level</span> <span data-start="1564.03" data-end="1567.24">primitives that can help you write code</span> <span data-start="1567.24" data-end="1570.63">that's free of race conditions there are</span> <span data-start="1570.63" data-end="1576.419">some cloud cloud providers and SDKs that</span> <span data-start="1576.419" data-end="1580.559">will take care of these problems to some</span> <span data-start="1580.559" data-end="1583.679">extent some open source database are</span> <span data-start="1583.679" data-end="1585.96">designed to be about to synchronize and</span> <span data-start="1585.96" data-end="1592.47">work offline so sometimes if you can</span> <span data-start="1592.47" data-end="1594.059">take advantage of them that's great</span> <span data-start="1594.059" data-end="1594.78">you</span> <span data-start="1594.78" data-end="1597.75">less problem to solve but sometimes your</span> <span data-start="1597.75" data-end="1599.88">circumstance might prevent you from</span> <span data-start="1599.88" data-end="1603.57">using the tools that you want and that's</span> <span data-start="1603.57" data-end="1606.21">why in my opinion the most important</span> <span data-start="1606.21" data-end="1609">thing the most important thing here is</span> <span data-start="1609" data-end="1612.86">to become aware of the existence of this</span> <span data-start="1612.86" data-end="1617.1">class of problems because even if you</span> <span data-start="1617.1" data-end="1619.5">don't know the solutions or if you don't</span> <span data-start="1619.5" data-end="1623.79">know the wish to to use at least you</span> <span data-start="1623.79" data-end="1626.87">know that you should try to avoid it so</span> <span data-start="1626.87" data-end="1630.18">to close this talk I would consider this</span> <span data-start="1630.18" data-end="1633.24">talk success if you go home today and</span> <span data-start="1633.24" data-end="1636">become more careful when you see the</span> <span data-start="1636" data-end="1640.38">keyword await in your codebase you don't</span> <span data-start="1640.38" data-end="1644.76">have to be paranoid just maybe just be</span> <span data-start="1644.76" data-end="1646.55">aware that during an a wait</span> <span data-start="1646.55" data-end="1650.79">anything could happen I don't know if</span> <span data-start="1650.79" data-end="1655.85">that's paranoid or not but but and maybe</span> <span data-start="1655.85" data-end="1657.93">when you test your app try</span> <span data-start="1657.93" data-end="1659.76">double-clicking everything instead of</span> <span data-start="1659.76" data-end="1664.8">single clicking and the next time you</span> <span data-start="1664.8" data-end="1668.4">see all right there were a wait I hope</span> <span data-start="1668.4" data-end="1671.68">you think about this talk thank you</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
