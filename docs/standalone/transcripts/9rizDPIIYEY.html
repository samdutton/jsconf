<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>9rizDPIIYEY</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/9rizDPIIYEY?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="15.3" data-end="18.09">good morning good morning so yeah thank</span> <span data-start="18.09" data-end="20.55">you Jed as Jed said we're basically</span> <span data-start="20.55" data-end="22.47">gonna take a quick look at some tips</span> <span data-start="22.47" data-end="25.71">tricks and hacks that you normally use</span> <span data-start="25.71" data-end="27.509">in the web but as viewed from within</span> <span data-start="27.509" data-end="28.619">WebKit</span> <span data-start="28.619" data-end="31.949">right so this is kind of a culmination</span> <span data-start="31.949" data-end="33.87">of a lot of discussions we've had with</span> <span data-start="33.87" data-end="35.61">people over the past few years we've</span> <span data-start="35.61" data-end="36.69">notice that they're doing certain things</span> <span data-start="36.69" data-end="38.82">and and realizing maybe like that the</span> <span data-start="38.82" data-end="40.82">engine can kind of do different modes</span> <span data-start="40.82" data-end="43.199">depending on like what you know kind of</span> <span data-start="43.199" data-end="45.75">little tips they use but we realized</span> <span data-start="45.75" data-end="47.22">that a lot of people don't quite realize</span> <span data-start="47.22" data-end="48.69">what's happening inside the engine when</span> <span data-start="48.69" data-end="50.85">they do that sometimes too bad effects</span> <span data-start="50.85" data-end="53.25">or sometimes a good effects so it's</span> <span data-start="53.25" data-end="54.42">basically a talk where we can take a few</span> <span data-start="54.42" data-end="55.589">of the really popular ones that we've</span> <span data-start="55.589" data-end="57.47">seen where people seem to have a lot of</span> <span data-start="57.47" data-end="59.909">misconceptions or misunderstandings of</span> <span data-start="59.909" data-end="61.44">what's going on inside of the engine and</span> <span data-start="61.44" data-end="63.78">we're gonna look into them to actually</span> <span data-start="63.78" data-end="68.549">show you what is going on right so so</span> </p>
<p><span data-start="68.549" data-end="70.59">Jed give a little introduction so again</span> <span data-start="70.59" data-end="74.159">I'm Matt and this is Jing and so we just</span> <span data-start="74.159" data-end="76.439">left apple early is here and are</span> <span data-start="76.439" data-end="78.15">starting her a little company together</span> <span data-start="78.15" data-end="80.64">in the Bay Area so if you see us around</span> <span data-start="80.64" data-end="81.899">you can talk to us later more about that</span> <span data-start="81.899" data-end="83.64">but we basically work together on the</span> <span data-start="83.64" data-end="85.049">Safari and WebKit team for the past few</span> <span data-start="85.049" data-end="90.03">years yeah that's better what else so so</span> <span data-start="90.03" data-end="92.27">to start off they're basically a few</span> <span data-start="92.27" data-end="95.369">demos that we had made to to kind of</span> <span data-start="95.369" data-end="96.96">illustrate the points of what these tips</span> <span data-start="96.96" data-end="99.27">tricks and hacks are that people use but</span> <span data-start="99.27" data-end="101.399">we realize demos are kind of boring</span> <span data-start="101.399" data-end="104.569">right because if we could have you know</span> <span data-start="104.569" data-end="106.59">synergy in our talk or whatever right</span> <span data-start="106.59" data-end="108.509">then then they'll be great because</span> <span data-start="108.509" data-end="109.71">everyone loves synergy so like let's</span> <span data-start="109.71" data-end="111.359">make a game out of these these these</span> <span data-start="111.359" data-end="113.069">tips tricks and hacks let's put them all</span> <span data-start="113.069" data-end="116.1">together in like one example it's fun to</span> <span data-start="116.1" data-end="118.409">do so basically last night we were kind</span> <span data-start="118.409" data-end="120.24">of scrambling to do all this and fit it</span> <span data-start="120.24" data-end="122.1">all into one so we came up with a little</span> <span data-start="122.1" data-end="124.77">simple game that we like to call Verta</span> <span data-start="124.77" data-end="127.319">fall and so a little play off the German</span> <span data-start="127.319" data-end="130.91">word vert which means words in German</span> <span data-start="130.91" data-end="133.62">the simple game that we made was was</span> <span data-start="133.62" data-end="137.61">essentially you might be you see like</span> <span data-start="137.61" data-end="138.84">these words falling from the top of the</span> <span data-start="138.84" data-end="140.19">page right so maybe like chocolate</span> <span data-start="140.19" data-end="142.89">cupcakes or whatever and your objective</span> <span data-start="142.89" data-end="144.09">for the game is to go through and type</span> <span data-start="144.09" data-end="145.86">the words as fast as you can so for</span> <span data-start="145.86" data-end="147.24">every one that you type and you get</span> <span data-start="147.24" data-end="149.34">right you get some points for the</span> <span data-start="149.34" data-end="151.29">right so if you type cupcakes really</span> <span data-start="151.29" data-end="152.489">fast before it hits the bottom of the</span> <span data-start="152.489" data-end="154.349">page and disappears then you get like 80</span> <span data-start="154.349" data-end="156.63">points or so and so on and you're kind</span> <span data-start="156.63" data-end="158.31">of just you know going against the clock</span> <span data-start="158.31" data-end="159.39">to see how fast you can type all the</span> <span data-start="159.39" data-end="161.88">words so those a little fun little</span> <span data-start="161.88" data-end="163.11">example that kind of brings together all</span> <span data-start="163.11" data-end="164.94">of our all the things we want to talk</span> <span data-start="164.94" data-end="170.88">about and so we'll so I'll show you in a</span> <span data-start="170.88" data-end="172.61">second what that game looks like</span> <span data-start="172.61" data-end="174.599">basically it's about like 2:00 a.m. last</span> <span data-start="174.599" data-end="176.16">night right and and we're totally</span> <span data-start="176.16" data-end="177.51">freaking out because we need to get this</span> <span data-start="177.51" data-end="180.3">all done before tomorrow so we know that</span> <span data-start="180.3" data-end="181.23">like there's only one way we can</span> <span data-start="181.23" data-end="183.989">possibly you know get this done in time</span> <span data-start="183.989" data-end="186.33">because we need to meet male right at</span> <span data-start="186.33" data-end="188.31">the super awesome raver Club like 5:00</span> <span data-start="188.31" data-end="191.069">in the morning he's talking about so so</span> <span data-start="191.069" data-end="193.019">it's like you know it's just it's game</span> <span data-start="193.019" data-end="195.15">time right we have 2 a.m. until 5 a.m.</span> <span data-start="195.15" data-end="196.62">to get this done and then we have all</span> <span data-start="196.62" data-end="198.66">this like super partying at the club</span> <span data-start="198.66" data-end="200.19">until 9:00 in the morning and then</span> <span data-start="200.19" data-end="202.2">breakfast now and if you have any clue</span> <span data-start="202.2" data-end="203.549">this is why we're so tired right now</span> <span data-start="203.549" data-end="207.45">this is this is a true story so there's</span> <span data-start="207.45" data-end="208.59">only one way you could possibly do this</span> <span data-start="208.59" data-end="210.239">in time right so we know we need to get</span> <span data-start="210.239" data-end="214.14">to bombers peak right so so to</span> <span data-start="214.14" data-end="216.239">illustrate such a thing we're gonna do</span> <span data-start="216.239" data-end="219.78">that right now we go through Hey Cheers</span> <span data-start="219.78" data-end="224.619">this is true story</span> <span data-start="224.629" data-end="226.47">okay so this game that we're saying</span> <span data-start="226.47" data-end="227.79">right the the words are falling from the</span> <span data-start="227.79" data-end="229.68">sky as they should be right and we're</span> <span data-start="229.68" data-end="230.459">trying to take them as fast as possible</span> <span data-start="230.459" data-end="233.25">however we get it the game done and all</span> <span data-start="233.25" data-end="234.72">of a sudden it's not working of course</span> <span data-start="234.72" data-end="236.34">you know cuz we're total noobs and so</span> <span data-start="236.34" data-end="238.59">the very issue they run into the very</span> <span data-start="238.59" data-end="242.31">first issue we see is that got it is</span> <span data-start="242.31" data-end="247.859">that all the words are not there Mart</span> <span data-start="247.859" data-end="249.72">not there right they should be they</span> <span data-start="249.72" data-end="250.68">should be basically flowing there from</span> <span data-start="250.68" data-end="252.18">the top because we have a little</span> <span data-start="252.18" data-end="254.25">transition it's like you know going from</span> <span data-start="254.25" data-end="255.54">the top at the bottom and then sliding</span> <span data-start="255.54" data-end="256.079">them down</span> <span data-start="256.079" data-end="258.299">however it's not working baby like are</span> <span data-start="258.299" data-end="259.979">stuck somewhere right so to go to look</span> <span data-start="259.979" data-end="263.4">at the code for a second and jiggle</span> <span data-start="263.4" data-end="264.36">explain what we're doing here</span> <span data-start="264.36" data-end="266.76">alright so basically in our code we have</span> <span data-start="266.76" data-end="269.28">these divs that have classes word and we</span> <span data-start="269.28" data-end="270.96">want to do is start them off at the top</span> <span data-start="270.96" data-end="272.46">of the page above the top of the page</span> <span data-start="272.46" data-end="274.979">and then I have them animate all the way</span> <span data-start="274.979" data-end="277.199">to the bottom so what we did here was</span> <span data-start="277.199" data-end="279.599">basically have like call this function</span> <span data-start="279.599" data-end="281.46">called dispatch word that crazy word</span> <span data-start="281.46" data-end="283.86">element inserts it into the Dom and then</span> <span data-start="283.86" data-end="287.13">changes the top position to the height</span> <span data-start="287.13" data-end="289.44">of the screen so we're thinking about</span> <span data-start="289.44" data-end="290.88">this last night and we're like oh wait</span> <span data-start="290.88" data-end="293.13">we're people on the web saying something</span> <span data-start="293.13" data-end="294.75">about like you need a set timeout zero</span> <span data-start="294.75" data-end="297">between like inserting something into</span> <span data-start="297" data-end="299.22">the DOM and changing its property or</span> <span data-start="299.22" data-end="300.84">else like the transition doesn't take</span> <span data-start="300.84" data-end="303.659">effect or something so so we're like</span> <span data-start="303.659" data-end="307.229">okay let's try this we changed our code</span> <span data-start="307.229" data-end="309.12">to basically do a set time at zero and</span> <span data-start="309.12" data-end="311.789">then set the final top position and</span> <span data-start="311.789" data-end="314.07">they're like okay let's try this out see</span> <span data-start="314.07" data-end="319.77">if it works and it does whoa okay you</span> <span data-start="319.77" data-end="321.449">know our game works we're well on our</span> <span data-start="321.449" data-end="324">way to partying and we're also making</span> <span data-start="324" data-end="326.97">our way steadily up bombers peak which</span> <span data-start="326.97" data-end="328.74">means we got super distracted who were</span> <span data-start="328.74" data-end="330.539">like why do we even need us it how about</span> <span data-start="330.539" data-end="332.789">zero I mean we have like one CSS value</span> <span data-start="332.789" data-end="334.05">the next one why can't the browser just</span> <span data-start="334.05" data-end="337.47">do it so we went online and we looked up</span> <span data-start="337.47" data-end="339.659">the definition of how transitions are</span> <span data-start="339.659" data-end="343.74">triggered in the spec so though the w3c</span> <span data-start="343.74" data-end="346.349">spec says when the computed value of for</span> <span data-start="346.349" data-end="348.33">property changes then then the engine</span> <span data-start="348.33" data-end="351.57">starts the transition so we know a</span> <span data-start="351.57" data-end="354.09">little bit about how web browsers work</span> <span data-start="354.09" data-end="356.4">so when you're running your JavaScript</span> <span data-start="356.4" data-end="357.96">code that each chunk of your code is</span> <span data-start="357.96" data-end="358.319">actually</span> <span data-start="358.319" data-end="361.379">run in a single run loop inside the</span> <span data-start="361.379" data-end="362.729">browser and the browser kind of like</span> <span data-start="362.729" data-end="364.379">manages one to call these wrong loops</span> <span data-start="364.379" data-end="366.779">and in between these wrong loops then</span> <span data-start="366.779" data-end="368.219">the browser does like whatever it needs</span> <span data-start="368.219" data-end="371.129">to do to actually you know render your</span> <span data-start="371.129" data-end="373.139">page respond to system events and</span> <span data-start="373.139" data-end="374.999">anything that's not directly in your</span> <span data-start="374.999" data-end="377.699">control so one of the things that the</span> <span data-start="377.699" data-end="380.249">browser does during this time between</span> <span data-start="380.249" data-end="382.83">your on loop is to update all the Styles</span> <span data-start="382.83" data-end="385.349">you've said and layout so that makes</span> <span data-start="385.349" data-end="387.27">sense because when we have a set timeout</span> <span data-start="387.27" data-end="389.069">zero we're basically saying we're done</span> <span data-start="389.069" data-end="390.479">with the first round loop do whatever</span> <span data-start="390.479" data-end="392.039">you need to do in the browser and then</span> <span data-start="392.039" data-end="394.8">and then do whatever we said later so</span> <span data-start="394.8" data-end="397.649">that's why it works awesome okay so</span> <span data-start="397.649" data-end="398.969">we're done with that and we're like okay</span> <span data-start="398.969" data-end="400.02">we want to go party with a little party</span> <span data-start="400.02" data-end="406.469">let's try playing this game huh there's</span> <span data-start="406.469" data-end="409.879">like this weird stutter when they type</span> <span data-start="409.879" data-end="412.889">this this is to slow some reason every</span> <span data-start="412.889" data-end="415.229">time we're pressing one letter it's just</span> <span data-start="415.229" data-end="417.209">absolutely slowing down so this is not</span> <span data-start="417.209" data-end="421.889">good either right so I know that the</span> <span data-start="421.889" data-end="424.019">animation works fine and it only slows</span> <span data-start="424.019" data-end="426.33">down when I'm typing so it must be</span> <span data-start="426.33" data-end="428.969">something wrong with my event handler so</span> </p>
<p><span data-start="428.969" data-end="431.899">I go look at my event handling code and</span> <span data-start="431.899" data-end="434.459">this is the function I call basically</span> <span data-start="434.459" data-end="437.339">every time you type a letter I go</span> <span data-start="437.339" data-end="439.05">through loops through all of the word</span> <span data-start="439.05" data-end="441.3">elements in the page and then compare</span> <span data-start="441.3" data-end="443.159">their inner text to see if it matches a</span> <span data-start="443.159" data-end="445.559">letter typed and if it does then I'll</span> <span data-start="445.559" data-end="446.999">just like change the class name which is</span> <span data-start="446.999" data-end="448.11">that some styles on there that</span> <span data-start="448.11" data-end="452.369">highlights it so as I'm looking at this</span> </p>
<p><span data-start="452.369" data-end="455.309">I start remembering there's this talk on</span> <span data-start="455.309" data-end="457.709">YouTube oh it's it's all Paul irons just</span> <span data-start="457.709" data-end="461.099">talk about how accessing some values in</span> <span data-start="461.099" data-end="464.009">the loop could cause reflows and slow</span> <span data-start="464.009" data-end="465.019">things down</span> <span data-start="465.019" data-end="467.459">actually now now I really remember it's</span> <span data-start="467.459" data-end="469.529">our Texas one of these properties that</span> <span data-start="469.529" data-end="472.289">causes a reflow so I think the tip was</span> <span data-start="472.289" data-end="475.289">to access all of your values at the same</span> <span data-start="475.289" data-end="477.18">time and then set your values at the</span> <span data-start="477.18" data-end="480.149">same time so I changed my code and now</span> <span data-start="480.149" data-end="481.919">I'm running two loops the first loop</span> <span data-start="481.919" data-end="483.959">gets all the inner texts and the second</span> <span data-start="483.959" data-end="486.119">loop just access there's a local</span> <span data-start="486.119" data-end="489.689">variable instead of asking for for it</span> <span data-start="489.689" data-end="491.01">from the element</span> <span data-start="491.01" data-end="496.65">so let's run that code yay</span> <span data-start="496.65" data-end="498.39">no it's responsive so breaking out that</span> <span data-start="498.39" data-end="499.98">pattern so that we do all the all the</span> <span data-start="499.98" data-end="501.96">gets of the intertext and then all the</span> <span data-start="501.96" data-end="503.55">sets have to right then we're avoiding</span> <span data-start="503.55" data-end="506.25">all of those reflows so so now we see</span> <span data-start="506.25" data-end="509.31">it's so much smoother right so of course</span> <span data-start="509.31" data-end="512.97">yeah so it again since Matt's still</span> <span data-start="512.97" data-end="515.729">holding my beer over nearly at help</span> <span data-start="515.729" data-end="518.22">farmer speak and we're like you know why</span> <span data-start="518.22" data-end="519.72">are we causing these reflows I'm just</span> <span data-start="519.72" data-end="523.35">asking for some text from the Dom so we</span> <span data-start="523.35" data-end="525">decided to actually just step through</span> <span data-start="525" data-end="526.89">this loop and look at what's actually</span> <span data-start="526.89" data-end="528.69">happening in web kids</span> </p>
<p><span data-start="528.69" data-end="533.37">C++ code so I put a breakpoint inside in</span> <span data-start="533.37" data-end="536.4">our text and this is the function that I</span> <span data-start="536.4" data-end="539.46">see you see that the first line there</span> <span data-start="539.46" data-end="542.85">says call um a document update layout</span> <span data-start="542.85" data-end="544.95">ignore pending sow Jade's super alarming</span> <span data-start="544.95" data-end="546.69">so I'm like what is this thing actually</span> <span data-start="546.69" data-end="549.09">do and then I kept stepping through the</span> <span data-start="549.09" data-end="550.35">stepping through I'll save you guys have</span> <span data-start="550.35" data-end="552.32">a pain of stepping through like 20 files</span> <span data-start="552.32" data-end="555.66">but at the end it comes down to calling</span> <span data-start="555.66" data-end="559.41">recalc style on the document so I go</span> <span data-start="559.41" data-end="561.18">into recounts out and this there's this</span> <span data-start="561.18" data-end="562.95">this is like this huge function that's</span> <span data-start="562.95" data-end="565.59">like three pages long and it does what</span> <span data-start="565.59" data-end="567.18">it says it does it recalculates the</span> <span data-start="567.18" data-end="569.55">style if it needs to be recalculated but</span> <span data-start="569.55" data-end="572.31">the most interesting part is that near</span> <span data-start="572.31" data-end="574.59">the end of it if the element actually</span> <span data-start="574.59" data-end="577.14">loops through all of his children and it</span> <span data-start="577.14" data-end="580.38">says if any of my children needs it cell</span> <span data-start="580.38" data-end="582.69">style recalculated then I also had to</span> <span data-start="582.69" data-end="584.58">recalculate my style even if I didn't</span> <span data-start="584.58" data-end="587.82">change so I'm going through this loop</span> <span data-start="587.82" data-end="589.71">asking for inner tags and going through</span> <span data-start="589.71" data-end="591.3">all this logic why I haven't changed</span> <span data-start="591.3" data-end="592.95">anything so this doesn't really trigger</span> <span data-start="592.95" data-end="595.76">anything okay let's see what I did next</span> <span data-start="595.76" data-end="599.15">so the next thing I did is I changed the</span> <span data-start="599.15" data-end="601.65">the class name to something else so</span> <span data-start="601.65" data-end="604.23">again I could webpage at work here and I</span> <span data-start="604.23" data-end="606.15">see that it's function called class</span> <span data-start="606.15" data-end="609.57">attribute changed got called and there's</span> <span data-start="609.57" data-end="610.65">a whole bunch of stuff it's supposed to</span> <span data-start="610.65" data-end="613.62">do but at the very very end it says sent</span> <span data-start="613.62" data-end="616.65">me style recalc which sounds like a</span> <span data-start="616.65" data-end="618.06">might sugar the thing which I saw</span> <span data-start="618.06" data-end="621.12">earlier so to help me organize my</span> <span data-start="621.12" data-end="624.279">thoughts I kind of graphed out</span> <span data-start="624.279" data-end="626.379">looks like so I had the document root</span> <span data-start="626.379" data-end="628.93">documents elements and then I had this</span> <span data-start="628.93" data-end="630.73">gain container that contains a whole</span> <span data-start="630.73" data-end="632.62">bunch of words and I just went through</span> <span data-start="632.62" data-end="634.66">the first word and set it style so the</span> <span data-start="634.66" data-end="637.149">first word has a dirty bit for if the</span> <span data-start="637.149" data-end="641.379">style needs to be recalculated so now</span> </p>
<p><span data-start="641.379" data-end="643.209">I'm on to the next iteration of my loop</span> <span data-start="643.209" data-end="645.16">I'm looking at the second word and I'm</span> <span data-start="645.16" data-end="646.629">asking the second word for its inner</span> <span data-start="646.629" data-end="649.66">text and as you saw earlier when you</span> <span data-start="649.66" data-end="651.399">asked for inner text it triggers all</span> <span data-start="651.399" data-end="653.319">these function calls that go to recalc</span> <span data-start="653.319" data-end="655.899">style so the document asks do I need to</span> <span data-start="655.899" data-end="658.329">recalculate my selves and it's like oh -</span> <span data-start="658.329" data-end="659.98">my children need to recalculate their</span> <span data-start="659.98" data-end="662.259">styles and the game says do my children</span> <span data-start="662.259" data-end="664.569">need to recalculate their cells and the</span> <span data-start="664.569" data-end="666.04">first word says hey I need my style</span> <span data-start="666.04" data-end="669.309">recalculated so the first word does its</span> <span data-start="669.309" data-end="671.529">own layout calculation things and it</span> <span data-start="671.529" data-end="673.72">goes back to the game and the game says</span> <span data-start="673.72" data-end="675.879">well one of my children has a style</span> <span data-start="675.879" data-end="677.499">recalculated so I guess I had to</span> <span data-start="677.499" data-end="680.259">recalculate myself — so what this</span> <span data-start="680.259" data-end="682.569">actually caused in my game was that</span> <span data-start="682.569" data-end="685.029">every single time I asked for inner text</span> <span data-start="685.029" data-end="687.999">the game element was relating out all of</span> <span data-start="687.999" data-end="690.459">its words so if I had n words I will</span> <span data-start="690.459" data-end="692.74">have n loops and inside each loop I will</span> <span data-start="692.74" data-end="694.629">really out in words so it's like</span> <span data-start="694.629" data-end="697.269">exponentially expensive to have the</span> <span data-start="697.269" data-end="700.8">accesses in the same loop as the setters</span> <span data-start="700.8" data-end="706">so that explains why I need to access</span> <span data-start="706" data-end="708.309">all the values first and then and then</span> <span data-start="708.309" data-end="713.41">send all the values so now our game is</span> <span data-start="713.41" data-end="715.75">pretty much done actually to couple that</span> <span data-start="715.75" data-end="717.279">point there for a second um you might</span> <span data-start="717.279" data-end="720.069">ask yourself like why is why does like</span> <span data-start="720.069" data-end="721.269">the browser have to do all this work why</span> <span data-start="721.269" data-end="722.649">can't it be as smart as my JavaScript</span> <span data-start="722.649" data-end="723.879">loop could be just to like cashless</span> <span data-start="723.879" data-end="725.769">values essentially and then we're</span> <span data-start="725.769" data-end="727.089">getting the big discussion of like if</span> <span data-start="727.089" data-end="728.829">you look at the the way you like style</span> <span data-start="728.829" data-end="730.24">resolution and everything works inside</span> <span data-start="730.24" data-end="732.16">of the browser it's it's obviously a lot</span> <span data-start="732.16" data-end="734.74">of really complicated CSS rules all</span> <span data-start="734.74" data-end="737.139">implemented right so there have to be</span> <span data-start="737.139" data-end="738.61">some places where we can do that sort of</span> <span data-start="738.61" data-end="740.92">thing where we can speed things up but</span> <span data-start="740.92" data-end="741.819">in a day like we don't really know like</span> <span data-start="741.819" data-end="743.499">what you're gonna do next in JavaScript</span> <span data-start="743.499" data-end="745.209">right so so a lot of cases where it's</span> <span data-start="745.209" data-end="746.889">just not worth it to possibly save</span> <span data-start="746.889" data-end="748.54">around like every intermediate you know</span> <span data-start="748.54" data-end="750.759">intermediary value between it so</span> <span data-start="750.759" data-end="752.589">basically the take-home message there is</span> <span data-start="752.589" data-end="754.059">like you just kind of accept the fact</span> <span data-start="754.059" data-end="755.829">that like this is the current code so</span> <span data-start="755.829" data-end="756.73">this is this is what you have to deal</span> <span data-start="756.73" data-end="758.08">with on the platform right</span> <span data-start="758.08" data-end="760.3">so so even the best things that can be</span> <span data-start="760.3" data-end="761.38">done in the future they currently don't</span> <span data-start="761.38" data-end="763.69">exist so it's just you know limitation</span> <span data-start="763.69" data-end="766.08">of the current implementation basically</span> <span data-start="766.08" data-end="768.79">but yeah okay so so we fixed that right</span> <span data-start="768.79" data-end="771.58">and we've we've understood that one but</span> <span data-start="771.58" data-end="775.089">now like we're looking at it and and if</span> <span data-start="775.089" data-end="776.89">you can see like like keg is kind of</span> <span data-start="776.89" data-end="778.63">just shaking as its falling down it</span> <span data-start="778.63" data-end="779.83">doesn't really look that smooth right</span> <span data-start="779.83" data-end="781.06">and since the perfectionist that we are</span> <span data-start="781.06" data-end="783.459">we want this game to be really really</span> <span data-start="783.459" data-end="786.88">smooth right so so we get so we um you</span> <span data-start="786.88" data-end="790.18">know we remember this we remember this</span> <span data-start="790.18" data-end="791.95">um this tip that someone told us before</span> <span data-start="791.95" data-end="792.52">right</span> <span data-start="792.52" data-end="794.709">that was like use like translate z0 on</span> <span data-start="794.709" data-end="795.82">elements when you're animating them</span> <span data-start="795.82" data-end="798.82">because that like like sets hardwork</span> <span data-start="798.82" data-end="800.32">celebration to happen or some such thing</span> <span data-start="800.32" data-end="802.3">right so you can get these awesome crisp</span> <span data-start="802.3" data-end="806.529">animations so on so recall this and</span> <span data-start="806.529" data-end="808.63">we're basically on we go to use this</span> <span data-start="808.63" data-end="810.13">this little hack because it sounds great</span> <span data-start="810.13" data-end="812.649">right so so it boils down to before we</span> <span data-start="812.649" data-end="814.6">had a WebKit transition you know on on</span> <span data-start="814.6" data-end="816.97">top so that it goes from you know top at</span> <span data-start="816.97" data-end="818.589">zero all the way down to the height of</span> <span data-start="818.589" data-end="821.11">the page but instead now we just added</span> </p>
<p><span data-start="821.11" data-end="824.02">WebKit transform with the translate Z</span> <span data-start="824.02" data-end="826.51">initially zero and then later we add</span> <span data-start="826.51" data-end="828.79">translate Z and trans like Y so it goes</span> <span data-start="828.79" data-end="830.77">down the page so same exact effect just</span> <span data-start="830.77" data-end="832.48">using transforms now as opposed to using</span> <span data-start="832.48" data-end="836.11">a transition on the top and this is the</span> <span data-start="836.11" data-end="837.73">trick that everyone uses that should</span> <span data-start="837.73" data-end="839.17">hopefully like hardware-accelerated my</span> <span data-start="839.17" data-end="841.209">you know animation right so let's check</span> <span data-start="841.209" data-end="846.73">it out let's see if it works yeah so</span> <span data-start="846.73" data-end="848.74">that's buttery smooth right so this is</span> <span data-start="848.74" data-end="851.1">the effect that everyone goes for and</span> <span data-start="851.1" data-end="854.41">it's it's like the holy grail of making</span> <span data-start="854.41" data-end="856.27">awesome animations right you can't live</span> <span data-start="856.27" data-end="857.23">without this if you're trying to this</span> <span data-start="857.23" data-end="859.81">sort of thing it seems but why doesn't</span> <span data-start="859.81" data-end="861.64">like the browser you know do this on its</span> <span data-start="861.64" data-end="864.43">own right like we're we're curious like</span> <span data-start="864.43" data-end="866.41">what's going on here so at this point of</span> <span data-start="866.41" data-end="868.12">course we're totally like a top Ballmer</span> <span data-start="868.12" data-end="869.98">peak right we are even like jumping over</span> <span data-start="869.98" data-end="871.87">the top of it high-fiving right we are</span> <span data-start="871.87" data-end="873.81">so curious about what goes on the engine</span> <span data-start="873.81" data-end="876.82">and so we start to so we start to ask</span> <span data-start="876.82" data-end="879.1">the questions right like why doesn't the</span> <span data-start="879.1" data-end="880.72">browser always do this why don't I just</span> <span data-start="880.72" data-end="882.22">always do it in my page like every</span> <span data-start="882.22" data-end="883.72">animation I do why don't I just add like</span> <span data-start="883.72" data-end="885.79">translate Z zero because that would just</span> <span data-start="885.79" data-end="888.31">make everything better right well not so</span> <span data-start="888.31" data-end="891.579">fast right so we start by looking into</span> <span data-start="891.579" data-end="891.97">the engine</span> <span data-start="891.97" data-end="894.55">and seeing like what's going on when our</span> <span data-start="894.55" data-end="895.93">curiosity is getting better us here and</span> <span data-start="895.93" data-end="898.509">we realize that there's some some some</span> <span data-start="898.509" data-end="899.829">machinery being set up we're now</span> <span data-start="899.829" data-end="900.91">entering this thing called like</span> <span data-start="900.91" data-end="902.5">compositing mode right so web kids</span> <span data-start="902.5" data-end="904.629">dropping into this code that it wasn't</span> <span data-start="904.629" data-end="905.589">in the case before when we were</span> <span data-start="905.589" data-end="907.839">transitioning just on the on the top</span> <span data-start="907.839" data-end="910.149">element and so so it seems to be</span> <span data-start="910.149" data-end="911.379">entering this compositing mode we're</span> <span data-start="911.379" data-end="913.509">setting up all this machinery right it's</span> <span data-start="913.509" data-end="916.149">creating these like layer things and you</span> <span data-start="916.149" data-end="917.319">see a lot of code paths that are now</span> <span data-start="917.319" data-end="918.779">being used that are like if step between</span> <span data-start="918.779" data-end="922.149">accelerated compositing Flags there so</span> <span data-start="922.149" data-end="924.67">what like what is compositing what is</span> <span data-start="924.67" data-end="926.68">what is this accelerated notion where's</span> <span data-start="926.68" data-end="928.209">that hardware acceleration coming into</span> <span data-start="928.209" data-end="931.149">play and whatever happened like talking</span> <span data-start="931.149" data-end="933.81">about Hardware accelerate rendering so</span> <span data-start="933.81" data-end="936.79">understand all these concepts we need to</span> <span data-start="936.79" data-end="938.98">quickly just do a little segue to give a</span> <span data-start="938.98" data-end="941.92">graphics 101 to understand this concept</span> <span data-start="941.92" data-end="943.629">of what's going on with accelerated</span> <span data-start="943.629" data-end="947.589">compositing so in the next five plus</span> <span data-start="947.589" data-end="949.829">minutes I'm going to try to fly through</span> <span data-start="949.829" data-end="951.879">rendering from top to bottom as to how</span> <span data-start="951.879" data-end="954.55">it works especially in the lens of how</span> <span data-start="954.55" data-end="955.93">it works in our rendering engines such</span> <span data-start="955.93" data-end="958.36">as WebKit and hopefully I trick you into</span> <span data-start="958.36" data-end="960.22">understanding how accelerate compositing</span> <span data-start="960.22" data-end="962.529">works all within breaking neck time so</span> <span data-start="962.529" data-end="967.209">so let's start so so compositing and</span> <span data-start="967.209" data-end="968.17">rendering or the two different terms</span> <span data-start="968.17" data-end="969.759">we're talking about here right normally</span> <span data-start="969.759" data-end="971.319">hear people talking about accelerated</span> <span data-start="971.319" data-end="973.329">rendering but what does that mean well</span> <span data-start="973.329" data-end="976">rendering is the overall process of what</span> <span data-start="976" data-end="977.74">we're doing here we're compositing is a</span> <span data-start="977.74" data-end="979.93">sub step of it so we have to know what</span> <span data-start="979.93" data-end="981.069">rendering is first we can talk about</span> <span data-start="981.069" data-end="984.43">compositing so as its define rendering</span> <span data-start="984.43" data-end="986.079">is generally the process of taking a</span> <span data-start="986.079" data-end="988.959">model and and rendering it into an image</span> <span data-start="988.959" data-end="990.579">so by an image I mean like you know a</span> <span data-start="990.579" data-end="993.069">bitmap image or you know an actual like</span> <span data-start="993.069" data-end="994.93">2d array of pixels this just a little</span> <span data-start="994.93" data-end="996.79">chunk of memory in the end right and</span> <span data-start="996.79" data-end="1000.569">your model in the case of WebKit and a</span> <span data-start="1000.569" data-end="1002.069">rendering engine for the browser right</span> <span data-start="1002.069" data-end="1006.47">is just basically your Dom plus CSS so</span> <span data-start="1006.47" data-end="1008.73">so your model is simply that Dom that</span> <span data-start="1008.73" data-end="1010.8">you give us in the CSS and WebKit does</span> <span data-start="1010.8" data-end="1012">the job of simply taking that and</span> <span data-start="1012" data-end="1013.98">translating that literally into an image</span> <span data-start="1013.98" data-end="1016.199">right and the end of the day I'm going</span> <span data-start="1016.199" data-end="1020.459">to grossly oversimplify this but I let's</span> <span data-start="1020.459" data-end="1021.569">say that that image at the end is just</span> <span data-start="1021.569" data-end="1023.1">called a frame we'll just use that term</span> <span data-start="1023.1" data-end="1024.959">for a second and we'll say that</span> <span data-start="1024.959" data-end="1027.329">once we've generated that frame all we</span> <span data-start="1027.329" data-end="1030.029">need to do is give it to the GPU and my</span> <span data-start="1030.029" data-end="1031.919">graphics graphics friends are totally</span> <span data-start="1031.919" data-end="1033.509">gonna kill me for over simplifying this</span> <span data-start="1033.509" data-end="1034.74">so much let's just say it's simply the</span> <span data-start="1034.74" data-end="1036.99">job of the GPU is to take our frame that</span> <span data-start="1036.99" data-end="1038.909">image that we give it and it makes sure</span> <span data-start="1038.909" data-end="1042.779">that it appears in the screen okay so so</span> <span data-start="1042.779" data-end="1044.429">cool so so we don't to worry about</span> <span data-start="1044.429" data-end="1045.509">anything after we've generated this</span> <span data-start="1045.509" data-end="1047.22">image we just need to generate that that</span> <span data-start="1047.22" data-end="1050.22">like actual set of pixels right so how</span> <span data-start="1050.22" data-end="1052.59">my WebKit go about doing this process of</span> <span data-start="1052.59" data-end="1054.539">rendering well a very simple and naive</span> <span data-start="1054.539" data-end="1057.96">approach we'll go through in a second</span> <span data-start="1057.96" data-end="1059.85">with a simple example to see how we</span> <span data-start="1059.85" data-end="1061.619">could do it just in a very simple sense</span> <span data-start="1061.619" data-end="1066.389">so let's consider a very simple system</span> <span data-start="1066.389" data-end="1068.34">where we have a say a small screen and</span> <span data-start="1068.34" data-end="1070.74">we have a very simple page and so the</span> <span data-start="1070.74" data-end="1075.119">page is about 20 by 20 pixels and on the</span> <span data-start="1075.119" data-end="1076.919">body we just basically have one color so</span> <span data-start="1076.919" data-end="1079.919">one big color background we have one</span> <span data-start="1079.919" data-end="1082.74">child that's the square div and it's</span> <span data-start="1082.74" data-end="1084.779">just ten by ten and it has one</span> <span data-start="1084.779" data-end="1086.279">background color right pink so these</span> <span data-start="1086.279" data-end="1088.35">like simple squares going on here and</span> <span data-start="1088.35" data-end="1090.33">then in within the square there's like a</span> <span data-start="1090.33" data-end="1091.71">bunch of like little divs we'll just</span> <span data-start="1091.71" data-end="1093.45">call them little J Estes you'll see in a</span> <span data-start="1093.45" data-end="1095.309">second that are at all just a bunch of</span> <span data-start="1095.309" data-end="1098.039">little white pixels essentially and it's</span> <span data-start="1098.039" data-end="1100.769">gonna look something like this so right</span> <span data-start="1100.769" data-end="1102.36">so if you have that background square</span> <span data-start="1102.36" data-end="1105.48">and then you know the it's Cayenne and</span> <span data-start="1105.48" data-end="1107.61">then I'm sorry on and then we have this</span> <span data-start="1107.61" data-end="1110.129">pink one and then the white dots so how</span> <span data-start="1110.129" data-end="1111.419">might we go about like creating this</span> <span data-start="1111.419" data-end="1113.07">right if we were just given that Dom and</span> <span data-start="1113.07" data-end="1115.59">and we need to make it into this well</span> <span data-start="1115.59" data-end="1117.47">the first step may be to go through and</span> <span data-start="1117.47" data-end="1120.36">paid from back to front so we would</span> <span data-start="1120.36" data-end="1122.94">basically fill in the pixels of this</span> <span data-start="1122.94" data-end="1125.19">like frame thing right this image one by</span> <span data-start="1125.19" data-end="1126.929">one where we put in blue blue blue and</span> <span data-start="1126.929" data-end="1128.61">then eventually strap late you can go</span> <span data-start="1128.61" data-end="1130.139">fill it the whole thing and the next</span> <span data-start="1130.139" data-end="1132.33">step that we could do is to go to that</span> <span data-start="1132.33" data-end="1133.98">next child element that ii did that's</span> <span data-start="1133.98" data-end="1136.74">square it's pink and we fill in you know</span> <span data-start="1136.74" data-end="1138.48">just fill in the pixels boom boom boom</span> <span data-start="1138.48" data-end="1140.999">the values and whole thing or curse</span> <span data-start="1140.999" data-end="1142.409">again to the children and we go through</span> <span data-start="1142.409" data-end="1143.879">when you fill in all the for the J and</span> <span data-start="1143.879" data-end="1148.71">the s and that's that's pretty simple</span> <span data-start="1148.71" data-end="1152.309">right so that's essentially what boils</span> <span data-start="1152.309" data-end="1153.69">down to the process of rendering that's</span> <span data-start="1153.69" data-end="1154.919">pretty simple naive approach of how to</span> <span data-start="1154.919" data-end="1157.44">do it let's think about for a second</span> <span data-start="1157.44" data-end="1158.97">like how many operations we were doing</span> <span data-start="1158.97" data-end="1161.73">do it in this naive approach basically</span> <span data-start="1161.73" data-end="1163.53">we had that twenty by twenty square so</span> <span data-start="1163.53" data-end="1165.57">in the 10 by 10 square and then seven by</span> <span data-start="1165.57" data-end="1167.25">five that we did on top of that so this</span> <span data-start="1167.25" data-end="1168.659">results in about five hundred and thirty</span> <span data-start="1168.659" data-end="1172.049">five pixel fill operations so that's the</span> <span data-start="1172.049" data-end="1173.429">kind of like I'm out of time it would</span> <span data-start="1173.429" data-end="1174.84">take to generate every one of these</span> <span data-start="1174.84" data-end="1177.12">frames right but we know like the</span> <span data-start="1177.12" data-end="1179.429">average screen goes about at 60 frames</span> <span data-start="1179.429" data-end="1181.65">per second so multiply this out and</span> <span data-start="1181.65" data-end="1183.59">we're looking at for this tiny screen</span> <span data-start="1183.59" data-end="1187.5">32,000 operations to do this per second</span> <span data-start="1187.5" data-end="1190.11">right so for the modern CPU this is</span> <span data-start="1190.11" data-end="1192.45">obviously no problem to do however if</span> <span data-start="1192.45" data-end="1194.07">you consider like a much bigger case you</span> <span data-start="1194.07" data-end="1196.11">can imagine this can start to get really</span> <span data-start="1196.11" data-end="1198.539">expensive right so like a maybe map air</span> <span data-start="1198.539" data-end="1200.159">screen where you have nine nine nine</span> <span data-start="1200.159" data-end="1202.98">hundred five you know 1440 now you're</span> <span data-start="1202.98" data-end="1204.57">talking about a lot of operations like</span> <span data-start="1204.57" data-end="1206.37">just over you know close to about two</span> <span data-start="1206.37" data-end="1208.74">million so that's simply just amount of</span> <span data-start="1208.74" data-end="1210.09">time it takes to fill in these pixels</span> <span data-start="1210.09" data-end="1212.37">right but even worse I</span> <span data-start="1212.37" data-end="1215.22">oh sorry right so that's a person for</span> <span data-start="1215.22" data-end="1217.86">frame and then overall you're looking at</span> <span data-start="1217.86" data-end="1218.7">102</span> <span data-start="1218.7" data-end="1220.85">you know million per per second</span> <span data-start="1220.85" data-end="1222.929">operations have to do for that so be</span> <span data-start="1222.929" data-end="1224.549">considered like that a an average system</span> <span data-start="1224.549" data-end="1226.38">is is doing a lot more things than just</span> <span data-start="1226.38" data-end="1228.21">rendering this is a lot of time to do</span> <span data-start="1228.21" data-end="1229.83">this naive approach you have a lot of</span> <span data-start="1229.83" data-end="1231.27">room programs going on different windows</span> <span data-start="1231.27" data-end="1232.98">bunch of tabs open you're talking about</span> <span data-start="1232.98" data-end="1234.419">a lot of different people doing this</span> <span data-start="1234.419" data-end="1236.34">amount of work and that just becomes too</span> <span data-start="1236.34" data-end="1239.34">much doesn't scale and if you consider</span> <span data-start="1239.34" data-end="1241.89">even worse you're looking at about 600</span> <span data-start="1241.89" data-end="1245.58">megabits per second like for just</span> <span data-start="1245.58" data-end="1247.799">pushing this one set of frames from from</span> <span data-start="1247.799" data-end="1249.6">your screen over to the GPU which is</span> <span data-start="1249.6" data-end="1252.45">just a ton of data transfer we can just</span> <span data-start="1252.45" data-end="1255.929">totally bogged on the system right so so</span> <span data-start="1255.929" data-end="1257.25">basically this doesn't quite scale right</span> <span data-start="1257.25" data-end="1259.44">this this is not a good approach we</span> <span data-start="1259.44" data-end="1262.59">can't possibly make fast webpages with</span> <span data-start="1262.59" data-end="1265.77">this so in comes the role of compositing</span> <span data-start="1265.77" data-end="1268.32">right so so basically in that first</span> <span data-start="1268.32" data-end="1269.909">approach there we were we were just</span> <span data-start="1269.909" data-end="1272.58">running through and and kind of doing</span> <span data-start="1272.58" data-end="1276.03">all rendering as like one pass right but</span> <span data-start="1276.03" data-end="1277.74">compositing is this notion of breaking</span> <span data-start="1277.74" data-end="1280.169">up a step of where you're you're</span> <span data-start="1280.169" data-end="1281.73">combining visual elements from separate</span> <span data-start="1281.73" data-end="1284.58">sources into like one source so so we</span> <span data-start="1284.58" data-end="1285.659">were kind of doing this implicitly</span> <span data-start="1285.659" data-end="1288.059">before when when we drew from back to</span> <span data-start="1288.059" data-end="1290.49">front we did like the the one color the</span> <span data-start="1290.49" data-end="1292.14">next color over top we were</span> <span data-start="1292.14" data-end="1294.179">by the by the method of drawing we were</span> <span data-start="1294.179" data-end="1296.04">actually implicitly compositing</span> <span data-start="1296.04" data-end="1300.48">appropriately so so instead let's break</span> <span data-start="1300.48" data-end="1301.74">this up into two different steps two</span> <span data-start="1301.74" data-end="1303.809">discrete steps right so the first one is</span> <span data-start="1303.809" data-end="1305.309">drawing and the second one is</span> <span data-start="1305.309" data-end="1307.559">compositing like I said so in order to</span> <span data-start="1307.559" data-end="1310.89">do this we need to be able to take every</span> <span data-start="1310.89" data-end="1312.09">element and give it its own little</span> <span data-start="1312.09" data-end="1313.679">section of memory that it can do the</span> <span data-start="1313.679" data-end="1315.87">drawing into initially and then we'll do</span> <span data-start="1315.87" data-end="1317.16">the second step that I'll explain in a</span> <span data-start="1317.16" data-end="1318.48">second it's compositing which is the</span> <span data-start="1318.48" data-end="1320.429">process of combining all of those</span> <span data-start="1320.429" data-end="1322.44">separate images into this one that we</span> <span data-start="1322.44" data-end="1325.919">need to give over to the GPU right so so</span> <span data-start="1325.919" data-end="1327.66">let's start by looking at it we had like</span> <span data-start="1327.66" data-end="1330.36">that we have the three different look</span> <span data-start="1330.36" data-end="1331.679">call them layers so these are basically</span> <span data-start="1331.679" data-end="1334.95">like a little like off-screen kind of</span> <span data-start="1334.95" data-end="1337.23">frames per element that we're giving so</span> <span data-start="1337.23" data-end="1338.52">our Dom was pretty simple we had that</span> <span data-start="1338.52" data-end="1340.5">you know the body we had a little pink</span> <span data-start="1340.5" data-end="1343.25">layer for that background div and then</span> <span data-start="1343.25" data-end="1346.14">and then we have this j/s layer which is</span> <span data-start="1346.14" data-end="1347.33">just a bunch of those little divs that</span> <span data-start="1347.33" data-end="1349.26">we're just the simply the white dots</span> <span data-start="1349.26" data-end="1356.4">right so so we have here is it's</span> <span data-start="1356.4" data-end="1359.22">basically these chunks of memory that we</span> <span data-start="1359.22" data-end="1361.26">needs drawing as our first step so we're</span> <span data-start="1361.26" data-end="1363.059">gonna go in fill is in like before same</span> <span data-start="1363.059" data-end="1366.15">process we go through you know the cyan</span> <span data-start="1366.15" data-end="1368.61">dots and then all the pink dots and then</span> <span data-start="1368.61" data-end="1371.61">the Jas ones and now that we have these</span> <span data-start="1371.61" data-end="1372.809">layers we're gonna do the second step</span> <span data-start="1372.809" data-end="1374.669">which is compositing so this is simply</span> <span data-start="1374.669" data-end="1377.37">the process of taking the contents of</span> <span data-start="1377.37" data-end="1379.83">the one layer and copying into the other</span> <span data-start="1379.83" data-end="1382.71">and instead of going back to front here</span> <span data-start="1382.71" data-end="1385.47">we're doing now front to back so we take</span> <span data-start="1385.47" data-end="1387.24">the like the foremost elements that</span> <span data-start="1387.24" data-end="1389.309">would be in the front of the page so</span> <span data-start="1389.309" data-end="1391.2">that is an example here we take all of</span> <span data-start="1391.2" data-end="1392.61">those little divs that make up little J</span> <span data-start="1392.61" data-end="1395.04">s dots and we are literally copying</span> <span data-start="1395.04" data-end="1397.74">those into the pink one so that we</span> <span data-start="1397.74" data-end="1400.26">composite it into the pink one in the</span> <span data-start="1400.26" data-end="1402.12">right location right so it's simply just</span> <span data-start="1402.12" data-end="1405.419">a copy and then we copy that pink one in</span> <span data-start="1405.419" data-end="1406.74">to the appropriate location be</span> <span data-start="1406.74" data-end="1409.169">composited into the into the overall</span> <span data-start="1409.169" data-end="1412.32">body and now basically the layer of the</span> <span data-start="1412.32" data-end="1414.99">body finally has the contents inside of</span> <span data-start="1414.99" data-end="1418.08">it that we need to give over the GPU so</span> <span data-start="1418.08" data-end="1419.64">you may be asking yourself like what's</span> <span data-start="1419.64" data-end="1421.86">the point of this like we just allocate</span> <span data-start="1421.86" data-end="1423.3">a bunch of more memory and did just as</span> <span data-start="1423.3" data-end="1424.82">much work but we</span> <span data-start="1424.82" data-end="1426.919">you know didn't gain anything but you</span> <span data-start="1426.919" data-end="1429.259">have to consider what happens when</span> <span data-start="1429.259" data-end="1431.21">things are happening first at a larger</span> <span data-start="1431.21" data-end="1432.649">scale you have a lot of things you're</span> <span data-start="1432.649" data-end="1434.419">drawing on your page and perhaps your</span> <span data-start="1434.419" data-end="1437.12">even you know adding effects like if you</span> <span data-start="1437.12" data-end="1439.88">scroll literally the elements are moving</span> <span data-start="1439.88" data-end="1441.35">around or you do an effect like you just</span> <span data-start="1441.35" data-end="1444.44">saw that's a lot of if we were do that</span> <span data-start="1444.44" data-end="1446.74">repaint every time we were literally</span> <span data-start="1446.74" data-end="1448.97">like an old method of just simply</span> <span data-start="1448.97" data-end="1450.139">rendering in one pass</span> <span data-start="1450.139" data-end="1452.24">we were redrawing or frame like over and</span> <span data-start="1452.24" data-end="1453.35">over and over and I said before you know</span> <span data-start="1453.35" data-end="1455.48">600 megabits per second like throughput</span> <span data-start="1455.48" data-end="1457.22">to the GPU all of that that was a lot of</span> <span data-start="1457.22" data-end="1459.289">time so in this compositing path though</span> <span data-start="1459.289" data-end="1461.6">we can instead skip all that rendering</span> <span data-start="1461.6" data-end="1463.129">compositing that we did for that pink</span> <span data-start="1463.129" data-end="1465.379">layer and we can just use the contents</span> <span data-start="1465.379" data-end="1467.09">of that layer and recompose it in two</span> <span data-start="1467.09" data-end="1469.879">different locations in that overall blue</span> <span data-start="1469.879" data-end="1471.799">layer right that's hot most layer so</span> <span data-start="1471.799" data-end="1472.94">that basically saves us a ton of work</span> <span data-start="1472.94" data-end="1475.69">every time we can go a bit faster here</span> <span data-start="1475.69" data-end="1481.25">so they're obviously trade-offs we have</span> <span data-start="1481.25" data-end="1482.779">allocated a bunch more memory to get</span> <span data-start="1482.779" data-end="1484.84">some speed ups and how we do things</span> <span data-start="1484.84" data-end="1488.179">so of course memory is not limitless you</span> <span data-start="1488.179" data-end="1492.5">you definitely have you know a kind of a</span> <span data-start="1492.5" data-end="1493.94">trade-off of how many layers you should</span> <span data-start="1493.94" data-end="1496.1">be allocating dependant on you know how</span> <span data-start="1496.1" data-end="1497.629">much performance you need perhaps to</span> <span data-start="1497.629" data-end="1499.909">like speed up the rendering so it's</span> <span data-start="1499.909" data-end="1502.159">important remember this now now keep in</span> <span data-start="1502.159" data-end="1503.84">mind at this point the talk we haven't</span> <span data-start="1503.84" data-end="1505.22">yet talked about hardware versus</span> <span data-start="1505.22" data-end="1506.779">software we basically everything we've</span> <span data-start="1506.779" data-end="1508.37">been doing to like do this rendering and</span> <span data-start="1508.37" data-end="1510.379">this compositing this drawing has all</span> <span data-start="1510.379" data-end="1511.669">been happening you can just do it in</span> <span data-start="1511.669" data-end="1513.2">software like any program could do this</span> <span data-start="1513.2" data-end="1516.44">right so so now it's interesting to</span> <span data-start="1516.44" data-end="1518.149">consider how might we use the hardware</span> <span data-start="1518.149" data-end="1521.12">to speed up some of this stuff well</span> <span data-start="1521.12" data-end="1522.23">first like let's think about like what's</span> <span data-start="1522.23" data-end="1525.409">slow here right so CPU rendering takes a</span> <span data-start="1525.409" data-end="1526.61">lot of time that's what we were just</span> <span data-start="1526.61" data-end="1528.08">doing just in software just filling in</span> <span data-start="1528.08" data-end="1530.019">those pixels right as we know them</span> <span data-start="1530.019" data-end="1532.669">that's a ton of operations right the</span> <span data-start="1532.669" data-end="1534.11">second part was this really expensive to</span> <span data-start="1534.11" data-end="1535.46">eventually take that product and push it</span> <span data-start="1535.46" data-end="1537.409">over to the GPU that's just like copies</span> <span data-start="1537.409" data-end="1539.48">are really expensive to go to the GPU so</span> <span data-start="1539.48" data-end="1540.71">we want to minimize those things</span> <span data-start="1540.71" data-end="1542.2">altogether right</span> <span data-start="1542.2" data-end="1546.2">so luckily if you look at any like</span> <span data-start="1546.2" data-end="1547.519">graphics hardware you always see like</span> <span data-start="1547.519" data-end="1549.44">there's some sort of amount of megabytes</span> <span data-start="1549.44" data-end="1551.629">that the card has well that's the GPUs</span> <span data-start="1551.629" data-end="1553.429">memory right so so what's the point of</span> <span data-start="1553.429" data-end="1554.69">this memory like how could we use this</span> <span data-start="1554.69" data-end="1556.7">here well if you think back to our</span> <span data-start="1556.7" data-end="1558.56">process of doing you know the draw</span> <span data-start="1558.56" data-end="1560.38">the layers and then compositing step</span> <span data-start="1560.38" data-end="1562.58">that compositing step had a bunch of</span> <span data-start="1562.58" data-end="1564.17">these just chunks of memory these layers</span> <span data-start="1564.17" data-end="1565.55">that we've generated and not really</span> <span data-start="1565.55" data-end="1567.56">changing they're kind of just there so</span> <span data-start="1567.56" data-end="1569.63">what if we instead copy them over to the</span> </p>
<p><span data-start="1569.63" data-end="1572.3">GPUs memory so we say hey JP you GPU</span> <span data-start="1572.3" data-end="1573.47">hold on to the east right we've just</span> <span data-start="1573.47" data-end="1575.66">drawn these cool so we draw them once</span> <span data-start="1575.66" data-end="1578.66">and give them to them and then and then</span> <span data-start="1578.66" data-end="1582.41">so while we need at this point to to</span> <span data-start="1582.41" data-end="1583.76">basically finish the process is if we</span> <span data-start="1583.76" data-end="1586.22">just had a way to tell the GPU hey take</span> <span data-start="1586.22" data-end="1587.66">these layers right and squish them</span> <span data-start="1587.66" data-end="1590.3">together because that's like the last</span> <span data-start="1590.3" data-end="1592.67">step right well luckily this is exactly</span> <span data-start="1592.67" data-end="1594.44">what GPU is designed to do incredibly</span> <span data-start="1594.44" data-end="1596.03">well right so these textures that you</span> <span data-start="1596.03" data-end="1598.55">have on the GPU GPU acts like a</span> <span data-start="1598.55" data-end="1600.08">compositor for us because we give them</span> <span data-start="1600.08" data-end="1602.42">the simple lightweight commands on any</span> <span data-start="1602.42" data-end="1603.68">given frame that we're drawing to make</span> <span data-start="1603.68" data-end="1605">like say our animation around the screen</span> <span data-start="1605" data-end="1606.65">or scrolling we're saying hey take those</span> <span data-start="1606.65" data-end="1608.78">layers and rearranged like recompose it</span> <span data-start="1608.78" data-end="1610.58">that that pink one to be on the blue one</span> <span data-start="1610.58" data-end="1612.2">in this next location next location next</span> <span data-start="1612.2" data-end="1613.94">location that kind of communication is</span> <span data-start="1613.94" data-end="1615.89">really fast copying those frames every</span> <span data-start="1615.89" data-end="1618.08">time not fast so this is something that</span> <span data-start="1618.08" data-end="1621.35">the GPU is designed for it's a great</span> <span data-start="1621.35" data-end="1625.16">sandwich maker and this is basically</span> <span data-start="1625.16" data-end="1627.98">yeah this is basically this is</span> <span data-start="1627.98" data-end="1629.75">accelerated compositing this is exactly</span> <span data-start="1629.75" data-end="1631.55">what we do in WebKit this is the process</span> <span data-start="1631.55" data-end="1635.69">so back to translate see right so what's</span> <span data-start="1635.69" data-end="1638.54">going on here with translate C well it's</span> <span data-start="1638.54" data-end="1640.07">doing exactly this it's kicking us into</span> <span data-start="1640.07" data-end="1642.86">a mode where we start doing it in the in</span> <span data-start="1642.86" data-end="1644.03">the second fashion where you start</span> <span data-start="1644.03" data-end="1645.65">allocating these layers for things that</span> <span data-start="1645.65" data-end="1648.32">you translate zeon because we we can't</span> <span data-start="1648.32" data-end="1650.63">afford to not handle this 3d case where</span> <span data-start="1650.63" data-end="1651.74">you need to do it or else it's just</span> <span data-start="1651.74" data-end="1653.78">incredibly slow so we jump into</span> <span data-start="1653.78" data-end="1654.98">compositing mode we start allocating</span> <span data-start="1654.98" data-end="1656.06">layers so those things you give</span> <span data-start="1656.06" data-end="1658.22">translate Z 2 which means that they also</span> <span data-start="1658.22" data-end="1659.6">start to have all this extra memory</span> <span data-start="1659.6" data-end="1661.73">right so this is kind of like the it's</span> <span data-start="1661.73" data-end="1663.2">like the be careful message right this</span> <span data-start="1663.2" data-end="1664.34">is where you're walking with the really</span> <span data-start="1664.34" data-end="1665.9">heavy stick when you start translating Z</span> <span data-start="1665.9" data-end="1668.84">on everything but of course you can get</span> <span data-start="1668.84" data-end="1669.8">really fast</span> <span data-start="1669.8" data-end="1671.54">yups if you're doing the kind of thing</span> <span data-start="1671.54" data-end="1673.43">that would basically be draw once in a</span> <span data-start="1673.43" data-end="1674.42">layer and move it around the page</span> <span data-start="1674.42" data-end="1676.43">because that hardware compositing is</span> <span data-start="1676.43" data-end="1678.17">what works really fast right in this</span> <span data-start="1678.17" data-end="1680.3">mode cool so let's go back to our</span> <span data-start="1680.3" data-end="1683.48">example and use a little thing called</span> </p>
<p><span data-start="1683.48" data-end="1685.91">WebKit debug borders so check out what's</span> <span data-start="1685.91" data-end="1687.2">going on in our example when we added</span> <span data-start="1687.2" data-end="1694.659">translate see</span> <span data-start="1694.669" data-end="1697.2">so those words are following really</span> <span data-start="1697.2" data-end="1700.739">sweet from the top and so now we see we</span> <span data-start="1700.739" data-end="1702.299">see that like every single word has this</span> <span data-start="1702.299" data-end="1704.639">debug board around it now I'm not gonna</span> <span data-start="1704.639" data-end="1705.929">go into too much detail about this but</span> <span data-start="1705.929" data-end="1707.22">this is basically a little debug mode</span> <span data-start="1707.22" data-end="1709.139">that we have in WebKit to look at which</span> <span data-start="1709.139" data-end="1711.779">elements on the page are actually</span> <span data-start="1711.779" data-end="1713.429">getting these layers so they're so</span> <span data-start="1713.429" data-end="1714.929">they're actually getting memory assigned</span> <span data-start="1714.929" data-end="1716.22">to them that they get to draw into</span> <span data-start="1716.22" data-end="1717.96">that's reserved for just them and then</span> <span data-start="1717.96" data-end="1719.639">it's also backed by GPU memory right</span> <span data-start="1719.639" data-end="1721.83">that we that we use in order to do this</span> <span data-start="1721.83" data-end="1725.429">accelerated compositing last step so</span> <span data-start="1725.429" data-end="1726.809">obvious you can see this like a plenty</span> <span data-start="1726.809" data-end="1727.859">of things in the page that are getting</span> <span data-start="1727.859" data-end="1730.139">these these little green boxes however</span> <span data-start="1730.139" data-end="1731.789">we're doing this well because we're not</span> <span data-start="1731.789" data-end="1733.169">overusing them there's nothing in the</span> <span data-start="1733.169" data-end="1734.94">page that's like getting these layers</span> <span data-start="1734.94" data-end="1736.71">that doesn't need it to like all the</span> <span data-start="1736.71" data-end="1739.669">words in the background for example so</span> <span data-start="1739.669" data-end="1741.72">this is a perfect sample of how to use</span> <span data-start="1741.72" data-end="1749.159">it correctly and yeah so by the end of</span> <span data-start="1749.159" data-end="1749.789">talk here</span> <span data-start="1749.789" data-end="1752.489">and so just as like one more point right</span> <span data-start="1752.489" data-end="1755.039">is if I guess for fun if you if you</span> <span data-start="1755.039" data-end="1757.409">consider like ways to minimize the usage</span> <span data-start="1757.409" data-end="1758.999">of it use it just for the kind of cases</span> <span data-start="1758.999" data-end="1760.2">where you're doing those things that</span> <span data-start="1760.2" data-end="1762.69">would would benefit from accelerating</span> <span data-start="1762.69" data-end="1764.309">accelerating the compositing and you</span> <span data-start="1764.309" data-end="1765.359">could even get like really nice effects</span> <span data-start="1765.359" data-end="1767.039">like this in page so we kind of made a</span> <span data-start="1767.039" data-end="1768.059">different version of the game where</span> <span data-start="1768.059" data-end="1770.909">we're just really taxing a lot of things</span> <span data-start="1770.909" data-end="1774.96">being moved around and we have a little</span> <span data-start="1774.96" data-end="1777.809">bit of time left so so yeah so that was</span> <span data-start="1777.809" data-end="1779.82">a quick run-through of how accelerated</span> <span data-start="1779.82" data-end="1783.48">compositing works in WebKit and and how</span> <span data-start="1783.48" data-end="1786.149">rendering in general works in a in a</span> <span data-start="1786.149" data-end="1801.51">browser I don't have any questions</span> <span data-start="1801.52" data-end="1806">so the other browsers don't have this</span> <span data-start="1806" data-end="1806.75">problem</span> <span data-start="1806.75" data-end="1809.539">why does WebKit have this problem where</span> <span data-start="1809.539" data-end="1810.95">they need to create a new layers for</span> <span data-start="1810.95" data-end="1813.049">every hardware accelerated thing which</span> <span data-start="1813.049" data-end="1815.6">problem the the the other browsers like</span> <span data-start="1815.6" data-end="1816.95">have one layer and they Hardware</span> <span data-start="1816.95" data-end="1818.659">accelerate everything on that at least</span> <span data-start="1818.659" data-end="1821.09">according to their tech Doc's well right</span> <span data-start="1821.09" data-end="1823.76">um they may be accelerating like the</span> <span data-start="1823.76" data-end="1826.94">actual like body that all the time which</span> <span data-start="1826.94" data-end="1828.26">essentially is kind of always the case</span> <span data-start="1828.26" data-end="1829.58">because you always need to have some</span> <span data-start="1829.58" data-end="1831.14">sort of reserved chunk of memory that</span> <span data-start="1831.14" data-end="1833.24">you eventually draw into the ideas if</span> <span data-start="1833.24" data-end="1837.02">you are using intermediary chunks of</span> <span data-start="1837.02" data-end="1838.309">memory right like little buffers along</span> <span data-start="1838.309" data-end="1840.58">the way to do part of the drawing into</span> <span data-start="1840.58" data-end="1843.35">which anyone does when they're doing</span> <span data-start="1843.35" data-end="1845.659">this compositing right it's when you</span> <span data-start="1845.659" data-end="1846.98">choose to do it is perhaps what's</span> <span data-start="1846.98" data-end="1847.97">interesting</span> <span data-start="1847.97" data-end="1850.64">so something web has a problem it's it's</span> <span data-start="1850.64" data-end="1852.5">the thing that solves the problem of</span> <span data-start="1852.5" data-end="1858.87">doing it faster yeah that makes me sense</span> <span data-start="1858.88" data-end="1861.679">so you showed the example where you're</span> <span data-start="1861.679" data-end="1863.809">accidentally triggering the hole reflow</span> <span data-start="1863.809" data-end="1867.529">in the loop how can you how can you tell</span> <span data-start="1867.529" data-end="1869.679">that you're doing that or how can you</span> <span data-start="1869.679" data-end="1872.63">it's a sort of way to see that that's</span> <span data-start="1872.63" data-end="1873.77">happening you know all you can see is</span> <span data-start="1873.77" data-end="1877.34">the performance sucks but right yeah so</span> <span data-start="1877.34" data-end="1879.98">so of course you can always like try to</span> <span data-start="1879.98" data-end="1881.12">be cognizant of that but at the end of</span> <span data-start="1881.12" data-end="1883.25">day like when you're debugging the the</span> <span data-start="1883.25" data-end="1885.409">biggest tip is to go into the into the</span> <span data-start="1885.409" data-end="1888.5">web inspector and look at timelines if</span> <span data-start="1888.5" data-end="1891.11">you want to spin yeah I'm so in the web</span> <span data-start="1891.11" data-end="1893.6">inspector you can look at the timeline</span> <span data-start="1893.6" data-end="1895.64">of layout and rendering and when you're</span> <span data-start="1895.64" data-end="1897.47">triggering all this reflow what you can</span> <span data-start="1897.47" data-end="1899.51">see is a lot of life we layout really</span> <span data-start="1899.51" data-end="1901.61">our layout we layout in between two</span> <span data-start="1901.61" data-end="1904.309">renders so you really ideally only want</span> <span data-start="1904.309" data-end="1906.159">to do one real layout before one render</span> <span data-start="1906.159" data-end="1908.51">another good way for this specific cases</span> <span data-start="1908.51" data-end="1910.85">that you can actually find this online I</span> <span data-start="1910.85" data-end="1912.32">think several people have talked about</span> <span data-start="1912.32" data-end="1914.75">it or blogged about it they listed all</span> <span data-start="1914.75" data-end="1916.58">the values that would trigger this tree</span> <span data-start="1916.58" data-end="1918.559">layout and they're called computer</span> <span data-start="1918.559" data-end="1920.51">values in WebKit and if you look for the</span> <span data-start="1920.51" data-end="1922.37">earlier function I show like update</span> <span data-start="1922.37" data-end="1924.62">layout ignoring blah blah blah if you</span> <span data-start="1924.62" data-end="1926.09">search for that then that pretty much</span> <span data-start="1926.09" data-end="1927.83">lists out everything that you need to be</span> <span data-start="1927.83" data-end="1931.85">cognizant of not using too much</span> <span data-start="1931.86" data-end="1933.779">all right I think we're at a time we're</span> <span data-start="1933.779" data-end="1935.88">gonna have a break now and come back in</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
