<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>09V_JAGTs2E</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/09V_JAGTs2E?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="5.52" data-end="9.179">all right so yes I'm here to talk to you</span> <span data-start="9.179" data-end="11.67">about tamagotchis and generators</span> <span data-start="11.67" data-end="14.07">excited that crystal went before me cuz</span> <span data-start="14.07" data-end="15.45">she already explained some concepts that</span> </p>
<p><span data-start="15.45" data-end="17.48">I'm gonna go into in this talk as well</span> <span data-start="17.48" data-end="21.63">so again hello I'm Jen software engineer</span> <span data-start="21.63" data-end="23.73">based in New York if you want to reach</span> <span data-start="23.73" data-end="25.5">out to me on twitter my handle is girl</span> <span data-start="25.5" data-end="27.63">code you know definitely tweet at me I</span> <span data-start="27.63" data-end="29.22">post like a lot of cat pictures and</span> <span data-start="29.22" data-end="31.08">stuff but there's also some JavaScript</span> <span data-start="31.08" data-end="34.32">usage all right how many of you had a</span> <span data-start="34.32" data-end="37.83">tamagotchi growing up oh yeah I see a</span> <span data-start="37.83" data-end="41.67">lot of hands sweet okay so if you aren't</span> <span data-start="41.67" data-end="44.07">familiar with them Tamagotchis were</span> <span data-start="44.07" data-end="46.949">really popular digital pets in the 1990s</span> <span data-start="46.949" data-end="49.65">so they looked like this and when the</span> <span data-start="49.65" data-end="52.11">game would start an egg would appear and</span> <span data-start="52.11" data-end="54.87">then hatch and out would come your</span> </p>
<p><span data-start="54.87" data-end="57.36">Tamagotchi as a baby and you want to</span> <span data-start="57.36" data-end="60.03">raise it from a baby to an adult so you</span> <span data-start="60.03" data-end="61.979">would clean up after it you would play</span> <span data-start="61.979" data-end="63.989">with it you would feed it it would be</span> <span data-start="63.989" data-end="65.94">Pat you would it needed things it could</span> <span data-start="65.94" data-end="68.58">get sick as well and then you didn't</span> <span data-start="68.58" data-end="71.22">actually know what type of Tamagotchi it</span> <span data-start="71.22" data-end="74.04">was gonna grow up to be as an adult so</span> <span data-start="74.04" data-end="75.99">that was the fun like surprise of the</span> <span data-start="75.99" data-end="78.84">game now when I was growing up i</span> <span data-start="78.84" data-end="80.549">nurtured a lot of Tamagotchis to</span> <span data-start="80.549" data-end="84.509">adulthood some didn't make it that's</span> <span data-start="84.509" data-end="87.6">okay but I really loved this game and I</span> <span data-start="87.6" data-end="89.7">just want to build my own like web-based</span> <span data-start="89.7" data-end="92.969">version of it so my version of a</span> </p>
<p><span data-start="92.969" data-end="96.42">Tamagotchi includes an SVG shell the</span> <span data-start="96.42" data-end="99.049">controls which are just HTML divs to</span> <span data-start="99.049" data-end="100.829">actually interact with the Tamagotchi</span> <span data-start="100.829" data-end="103.679">and then the game screen is actually</span> <span data-start="103.679" data-end="106.439">built in canvas so if you aren't</span> <span data-start="106.439" data-end="109.229">familiar with canvas to use it we're</span> <span data-start="109.229" data-end="111.21">going to query the Dom for a canvas</span> <span data-start="111.21" data-end="113.999">we're going to ask for the context so in</span> <span data-start="113.999" data-end="117.21">this case we want to D to draw on the</span> <span data-start="117.21" data-end="119.219">canvas we're going to use context draw</span> <span data-start="119.219" data-end="120.99">image and we're going to pass it the</span> <span data-start="120.99" data-end="123.509">image to draw as well as some XY</span> <span data-start="123.509" data-end="125.28">coordinates that I'm not gonna get into</span> <span data-start="125.28" data-end="127.17">right now but that's gonna draw the</span> <span data-start="127.17" data-end="128.49">image to the screen so at the bottom you</span> <span data-start="128.49" data-end="130.41">can see our Tamagotchi has been drawn to</span> <span data-start="130.41" data-end="134.4">the screen now for all the animations in</span> <span data-start="134.4" data-end="137.46">this game I used a sprite sheet so below</span> <span data-start="137.46" data-end="140.239">is the sprite to bounce the Tamagotchi</span> <span data-start="140.239" data-end="143.97">so if each frame of the sprite is at 200</span> <span data-start="143.97" data-end="145.14">pixels</span> <span data-start="145.14" data-end="147.14">then I need to draw the image at zero</span> <span data-start="147.14" data-end="151.62">then 200 and then 400 pixels so that's</span> <span data-start="151.62" data-end="153.12">going to bounce the Tamagotchi up and</span> <span data-start="153.12" data-end="155.46">then I'd go back down to bounce Tamaki</span> <span data-start="155.46" data-end="158.31">down now you'll notice that I'm doing</span> <span data-start="158.31" data-end="159.99">contexts that clear between these</span> <span data-start="159.99" data-end="161.85">drawings and that's to avoid this</span> <span data-start="161.85" data-end="164.37">situation so if you don't clear the</span> <span data-start="164.37" data-end="166.23">context between drawings all the frames</span> <span data-start="166.23" data-end="169.02">just draw on top of each other all right</span> <span data-start="169.02" data-end="172.8">so as it's written now this isn't going</span> <span data-start="172.8" data-end="175.59">to work it's actually drawing and</span> <span data-start="175.59" data-end="177.81">clearing so quickly that you're only</span> <span data-start="177.81" data-end="181.44">seeing the last frame of this so that's</span> <span data-start="181.44" data-end="185.01">not going to work but I can delay the</span> <span data-start="185.01" data-end="187.41">animation with that timeout so I'm</span> <span data-start="187.41" data-end="189.17">looking for this really old-school</span> <span data-start="189.17" data-end="192.48">choppy Pixley animation like the</span> <span data-start="192.48" data-end="194.34">original game and I'm not going to build</span> <span data-start="194.34" data-end="196.11">out a sprite sheet that is actually 60</span> <span data-start="196.11" data-end="199.59">frames right so I'm gonna animate from</span> <span data-start="199.59" data-end="201.6">frame 1 through 3 and then back to 2 and</span> <span data-start="201.6" data-end="204.6">1 for a full bounce using set timeout to</span> <span data-start="204.6" data-end="208.32">do this to delay the frame drawings so</span> <span data-start="208.32" data-end="212.7">this is going to work now ah bouncing</span> <span data-start="212.7" data-end="217.14">tamagotchi but I've created a problem</span> <span data-start="217.14" data-end="217.56">here</span> <span data-start="217.56" data-end="222.209">because now my animations are async so</span> <span data-start="222.209" data-end="225.51">how do I know when this animation is</span> <span data-start="225.51" data-end="227.22">done like I have to know the actual</span> <span data-start="227.22" data-end="228.54">amount of time that this is going to</span> <span data-start="228.54" data-end="230.4">take and that's in order to kick off</span> <span data-start="230.4" data-end="232.92">another animation after this or to not</span> <span data-start="232.92" data-end="235.2">you know overwrite another animation or</span> <span data-start="235.2" data-end="238.1">have a weird long delay between them and</span> <span data-start="238.1" data-end="240.78">you know this just isn't sustainable for</span> <span data-start="240.78" data-end="244.47">a game that's full of animations what I</span> <span data-start="244.47" data-end="248.04">want is to resolve an animation and then</span> <span data-start="248.04" data-end="251.459">handle another animation and this sounds</span> <span data-start="251.459" data-end="253.68">a lot like a promise now crystal REI</span> <span data-start="253.68" data-end="255.93">talked about promises but you know they</span> <span data-start="255.93" data-end="258.239">represent an adventure all value so</span> <span data-start="258.239" data-end="260.609">inside a promise I can run the animation</span> <span data-start="260.609" data-end="262.919">code and then when it's done I can</span> <span data-start="262.919" data-end="266.43">resolve the promise and since I can do a</span> <span data-start="266.43" data-end="268.59">dot then on the promise I can use that</span> <span data-start="268.59" data-end="271.91">to run an animation after it's complete</span> <span data-start="271.91" data-end="274.68">so for the first version of this game</span> <span data-start="274.68" data-end="277.979">that's what I did I used promises for</span> <span data-start="277.979" data-end="278.37">all</span> <span data-start="278.37" data-end="280.85">animations I made a general-purpose</span> <span data-start="280.85" data-end="283.59">animate function that takes in a draw</span> <span data-start="283.59" data-end="285.449">function and the milliseconds for the</span> <span data-start="285.449" data-end="288.69">delay animate always returns a new</span> <span data-start="288.69" data-end="291.84">promise and inside that promise an inner</span> <span data-start="291.84" data-end="293.639">function is going to run the draw</span> <span data-start="293.639" data-end="296.669">function and we delegate resolving the</span> <span data-start="296.669" data-end="299.19">promise to the draw function if drawl</span> <span data-start="299.19" data-end="301.05">resolves the promise and returns true</span> <span data-start="301.05" data-end="304.8">we're done otherwise set timeout is</span> <span data-start="304.8" data-end="306.479">called with the inner function and</span> <span data-start="306.479" data-end="311.55">another loop of this function occurs so</span> <span data-start="311.55" data-end="312.75">here we're going to actually use the</span> <span data-start="312.75" data-end="314.52">animate function to create a bounce up</span> <span data-start="314.52" data-end="317.28">animation we're gonna pass a function</span> <span data-start="317.28" data-end="319.919">that draws the correct frame clears the</span> <span data-start="319.919" data-end="322.289">context and increments the current frame</span> <span data-start="322.289" data-end="325.229">count when the current frame is greater</span> <span data-start="325.229" data-end="327.21">than the frame count the promise is</span> <span data-start="327.21" data-end="330.09">resolved and we return true so this</span> <span data-start="330.09" data-end="331.979">would stop the function from setting</span> <span data-start="331.979" data-end="336.57">another loop via set timeout and so now</span> <span data-start="336.57" data-end="338.43">we can create a simple bounce function</span> <span data-start="338.43" data-end="340.83">using our bounce up animation and it</span> <span data-start="340.83" data-end="343.08">bounced down animation using the same</span> <span data-start="343.08" data-end="345.419">animate function and as you can see our</span> </p>
<p><span data-start="345.419" data-end="348.24">Tamagotchi is bouncing wonderful</span> <span data-start="348.24" data-end="351.12">beautiful and so now that that's working</span> <span data-start="351.12" data-end="354.18">we can move on to creating the main game</span> <span data-start="354.18" data-end="357.36">loop so when you're not interacting with</span> <span data-start="357.36" data-end="359.19">the Tamagotchi it's going to show this</span> <span data-start="359.19" data-end="361.95">idle animation so it's going to bounce</span> <span data-start="361.95" data-end="363.84">it's going to move to the right move to</span> <span data-start="363.84" data-end="366.06">the left keeps bouncing it's so on and</span> <span data-start="366.06" data-end="368.669">so forth and to set up the main loop</span> <span data-start="368.669" data-end="370.49">we're going to create a loop function</span> <span data-start="370.49" data-end="373.59">will call the idle animation and when</span> <span data-start="373.59" data-end="375.12">that's complete we call the loop</span> <span data-start="375.12" data-end="376.86">function again so just continuously</span> <span data-start="376.86" data-end="381.449">loops there okay but I've created some</span> <span data-start="381.449" data-end="383.94">more problems here there's two main</span> <span data-start="383.94" data-end="386.25">issues I noticed when using promises to</span> <span data-start="386.25" data-end="387.41">build the animations</span> <span data-start="387.41" data-end="392.97">the first one is venable health so once</span> <span data-start="392.97" data-end="395.669">upon time we used callbacks to handle</span> <span data-start="395.669" data-end="397.889">async calls and you know this created</span> <span data-start="397.889" data-end="399.9">the dreaded triangle of doom okay</span> <span data-start="399.9" data-end="402.84">callback health and one of the issues I</span> <span data-start="402.84" data-end="404.55">noticed when making this game was that</span> <span data-start="404.55" data-end="406.62">promises really didn't alleviate</span> <span data-start="406.62" data-end="409.349">callback hell like you're still in hell</span> <span data-start="409.349" data-end="410.63">it's just</span> <span data-start="410.63" data-end="415.43">looking how so the left side is a more</span> <span data-start="415.43" data-end="417.29">realistic version of how these</span> <span data-start="417.29" data-end="420.23">animations might work so I might need to</span> <span data-start="420.23" data-end="422.42">pass in information to functions or</span> <span data-start="422.42" data-end="424.97">check information to make a decision and</span> <span data-start="424.97" data-end="428.09">this all gets just as unwieldy and as</span> <span data-start="428.09" data-end="431.81">unmanageable as callback hell and you</span> <span data-start="431.81" data-end="433.22">know don't mistake me for hating</span> <span data-start="433.22" data-end="435.83">promises they're really great but when</span> <span data-start="435.83" data-end="438.08">you're doing like more large-scale async</span> <span data-start="438.08" data-end="441.17">work the ease of promises really breaks</span> <span data-start="441.17" data-end="444.98">down and I noticed another larger issue</span> <span data-start="444.98" data-end="449.15">with using promises for animations so</span> <span data-start="449.15" data-end="452.18">the point of the Tamagotchi is that the</span> <span data-start="452.18" data-end="455.27">user can interact with it I mean the</span> <span data-start="455.27" data-end="457.64">whole game is about interacting with the</span> </p>
<p><span data-start="457.64" data-end="461.36">Tamagotchi so at some point I need to</span> <span data-start="461.36" data-end="464.51">suspend the idle animation in favor of a</span> <span data-start="464.51" data-end="467.57">user-generated event so like feeding the</span> <span data-start="467.57" data-end="468.64">Tamagotchi</span> <span data-start="468.64" data-end="471.47">so here I've added an array to hold</span> <span data-start="471.47" data-end="474.86">pending events the loop function checks</span> <span data-start="474.86" data-end="476.9">if there are any pending events and if</span> <span data-start="476.9" data-end="479.06">there are the handle event function is</span> <span data-start="479.06" data-end="483.77">run and the loop is terminated so handle</span> <span data-start="483.77" data-end="485.9">event is going to take the first event</span> <span data-start="485.9" data-end="487.85">off the queue of events and run it and</span> <span data-start="487.85" data-end="489.68">when it's complete we're gonna restart</span> <span data-start="489.68" data-end="492.11">the loop if there's another event in the</span> <span data-start="492.11" data-end="494.14">queue handle event will get called again</span> <span data-start="494.14" data-end="497.18">otherwise we continue the loop until the</span> <span data-start="497.18" data-end="502.34">next event and so this didn't work you</span> <span data-start="502.34" data-end="504.05">can see I'm requesting to feed the</span> </p>
<p><span data-start="504.05" data-end="506.15">Tamagotchi</span> <span data-start="506.15" data-end="508.22">but the feed animation is delayed until</span> <span data-start="508.22" data-end="510.89">the idle animation completes its current</span> <span data-start="510.89" data-end="513.74">loop and that can be upwards of seven to</span> <span data-start="513.74" data-end="516.44">eight seconds so that's not going to</span> <span data-start="516.44" data-end="519.02">work what I need is to actually cancel</span> <span data-start="519.02" data-end="522.34">the promise that runs the idle animation</span> <span data-start="522.34" data-end="527.27">except you can't cancel a promise think</span> <span data-start="527.27" data-end="531.949">of promises as unbreakable valves</span> <span data-start="531.959" data-end="536.949">rest in peace snake so you can throw</span> <span data-start="536.949" data-end="539.29">errors and promises and you can catch</span> <span data-start="539.29" data-end="541.839">those errors but you can't actually</span> <span data-start="541.839" data-end="544.629">cancel a promise all of the attached</span> <span data-start="544.629" data-end="548.199">debt functions are going to fire what I</span> <span data-start="548.199" data-end="550.749">actually want is to pause an animation</span> <span data-start="550.749" data-end="553.809">and yield to an event and that sounds a</span> <span data-start="553.809" data-end="556.809">lot like a generator so generators are</span> <span data-start="556.809" data-end="558.579">amazing because their code that can be</span> <span data-start="558.579" data-end="561.759">paused so most of the code that you</span> <span data-start="561.759" data-end="564.069">write is run to completion once it</span> <span data-start="564.069" data-end="566.199">starts there's no actually stopping it</span> <span data-start="566.199" data-end="568.66">even if you're doing async work you're</span> <span data-start="568.66" data-end="570.579">throwing it onto the event loop and it's</span> <span data-start="570.579" data-end="572.47">going to come back around you can't tell</span> <span data-start="572.47" data-end="574.839">it like to cancel itself and stop can't</span> <span data-start="574.839" data-end="577.3">pause it both generators you can pause</span> <span data-start="577.3" data-end="580.629">and resume code so let's take a look at</span> <span data-start="580.629" data-end="584.74">them so this is a generator and I know</span> <span data-start="584.74" data-end="586.42">it's a generator because of the asterisk</span> <span data-start="586.42" data-end="588.279">next to the function keyword that's</span> <span data-start="588.279" data-end="589.749">actually all you need to do to turn a</span> <span data-start="589.749" data-end="591.429">regular function into a generator</span> <span data-start="591.429" data-end="593.829">function and then inside you'll notice</span> <span data-start="593.829" data-end="596.35">the yield statement so yield is a</span> <span data-start="596.35" data-end="597.79">special keyword and generators that</span> <span data-start="597.79" data-end="602.8">means pause to use the generator we're</span> <span data-start="602.8" data-end="604.6">going to call it and that's going to</span> <span data-start="604.6" data-end="608.019">return to us the generator object now on</span> <span data-start="608.019" data-end="610.12">the generator object is a method called</span> <span data-start="610.12" data-end="612.309">next and that actually tells the</span> <span data-start="612.309" data-end="614.499">generator to run until it encounters a</span> <span data-start="614.499" data-end="617.829">yield statement when that happens it's</span> <span data-start="617.829" data-end="620.019">going to return to you an object with a</span> <span data-start="620.019" data-end="623.47">value key and a done key so if there's a</span> <span data-start="623.47" data-end="625.12">value to the right of the yield</span> <span data-start="625.12" data-end="625.809">statement</span> <span data-start="625.809" data-end="628.149">it'll be passed via the value key and</span> <span data-start="628.149" data-end="630.519">then done provides the status of the</span> <span data-start="630.519" data-end="633.79">generator is it done true or false so in</span> <span data-start="633.79" data-end="635.41">this case this generator is not done so</span> <span data-start="635.41" data-end="639.1">we're getting false now you don't need</span> <span data-start="639.1" data-end="642.459">to yield values yield is just a key word</span> <span data-start="642.459" data-end="644.829">that means pause so you don't need to</span> <span data-start="644.829" data-end="647.189">return a value with it so in that case</span> <span data-start="647.189" data-end="649.299">yielding no value is going to return</span> <span data-start="649.299" data-end="651.16">and as you can see were still</span> <span data-start="651.16" data-end="654.639">not done done false so now we're calling</span> <span data-start="654.639" data-end="657.79">next again reading 3 so the value is 3</span> <span data-start="657.79" data-end="660.04">and done is false but done is still</span> <span data-start="660.04" data-end="661.36">false right like we haven't actually</span> <span data-start="661.36" data-end="664.329">finished yet it's on the next call</span> <span data-start="664.329" data-end="670.209">but now we're actually truly done you</span> <span data-start="670.209" data-end="672.579">can also pass values into the generators</span> <span data-start="672.579" data-end="675.339">next function and so here we're passing</span> <span data-start="675.339" data-end="678.279">two into the second next function and</span> <span data-start="678.279" data-end="680.559">this seems a little odd at first like</span> <span data-start="680.559" data-end="682.179">why aren't we doing this on the first</span> <span data-start="682.179" data-end="686.29">call to next but when you call next what</span> <span data-start="686.29" data-end="689.379">you're saying is hey generator do</span> <span data-start="689.379" data-end="691.66">whatever you need to do until you</span> <span data-start="691.66" data-end="695.17">encounter a yield statement so in this</span> <span data-start="695.17" data-end="696.61">case there's actually nothing for the</span> <span data-start="696.61" data-end="698.829">generator to do before the first yield</span> <span data-start="698.829" data-end="701.829">statement so when next is called it sees</span> <span data-start="701.829" data-end="703.42">that yield statement it's going to pause</span> <span data-start="703.42" data-end="706.179">there and the yield statement has no</span> <span data-start="706.179" data-end="708.73">value associated with it so the value is</span> <span data-start="708.73" data-end="713.079">on the second next call we</span> <span data-start="713.079" data-end="715.66">pass in a value and that value is going</span> <span data-start="715.66" data-end="718.54">to take the place of yield and now</span> <span data-start="718.54" data-end="720.699">because we've called next and we've said</span> <span data-start="720.699" data-end="723.309">hey do whatever you need to do until you</span> <span data-start="723.309" data-end="725.86">see a yield statement the value is now</span> <span data-start="725.86" data-end="729.009">being assigned to the variable num the</span> <span data-start="729.009" data-end="731.019">generator runs until the next statement</span> <span data-start="731.019" data-end="734.23">and this time we do have a value yielded</span> <span data-start="734.23" data-end="738.399">back to plus Nam or four on the next</span> <span data-start="738.399" data-end="740.35">call the generator yields four plus num</span> <span data-start="740.35" data-end="744.129">or six then it's done no more yield</span> <span data-start="744.129" data-end="747.879">statements you can also create an</span> <span data-start="747.879" data-end="752.139">infinite generator so how many of you</span> <span data-start="752.139" data-end="756.759">use while loops yeah just just a handful</span> <span data-start="756.759" data-end="760.48">of you like in production it very few</span> <span data-start="760.48" data-end="763.989">okay generally we don't I mean when I</span> <span data-start="763.989" data-end="765.399">was learning while loops obviously what</span> </p>
<p><span data-start="765.399" data-end="768.699">I did was crash my browser I think we</span> <span data-start="768.699" data-end="772.119">all did so in this example like first</span> <span data-start="772.119" data-end="773.47">we're gonna pass in an initial value</span> <span data-start="773.47" data-end="776.019">into the generator function and this is</span> <span data-start="776.019" data-end="778.299">going to avoid relying on next to set</span> <span data-start="778.299" data-end="781.299">the initial value of num and then you're</span> <span data-start="781.299" data-end="782.949">gonna see the while loop right we're</span> <span data-start="782.949" data-end="787.209">doing wild true so this should crash my</span> <span data-start="787.209" data-end="789.129">computer like this is an infinite loop</span> <span data-start="789.129" data-end="791.35">and should crash my browser and I'll be</span> <span data-start="791.35" data-end="794.799">annoyed with myself but actually because</span> <span data-start="794.799" data-end="797.559">generators can pause it's actually</span> <span data-start="797.559" data-end="798.259">pausing</span> <span data-start="798.259" data-end="802.1">while loop so it's not gonna cause a</span> <span data-start="802.1" data-end="804.169">crash the yield statements going to</span> <span data-start="804.169" data-end="806.089">pause it for us and it's only gonna</span> <span data-start="806.089" data-end="809.209">resume again when we call next and so as</span> <span data-start="809.209" data-end="811.609">long as you keep calling next this is</span> <span data-start="811.609" data-end="813.019">going to keep running</span> <span data-start="813.019" data-end="814.16">so this couldn't be an infinite</span> <span data-start="814.16" data-end="815.72">generator but you don't have to worry</span> <span data-start="815.72" data-end="817.459">about overloading the event loop with</span> <span data-start="817.459" data-end="819.649">the while loop because generators can</span> <span data-start="819.649" data-end="824.089">pause now you can also run a generator</span> <span data-start="824.089" data-end="827.419">from inside of another generator and to</span> <span data-start="827.419" data-end="828.709">do that you're going to use the yield</span> <span data-start="828.709" data-end="830.509">asterisk expression I'm gonna call it</span> <span data-start="830.509" data-end="831.499">yield star because it's just a little</span> <span data-start="831.499" data-end="835.009">bit easier to say but to illustrate this</span> </p>
<p><span data-start="835.009" data-end="837.139">I have a generator function called</span> <span data-start="837.139" data-end="840.169">powder and a generator function called</span> <span data-start="840.169" data-end="843.859">inner and you'll notice that outer is</span> <span data-start="843.859" data-end="845.72">calling inner with the yield star</span> <span data-start="845.72" data-end="850.85">expression so same as before we're going</span> <span data-start="850.85" data-end="852.47">to call outer and that's gonna return to</span> <span data-start="852.47" data-end="855.829">us the generator object so the first</span> <span data-start="855.829" data-end="858.019">time we call next what we expect to</span> <span data-start="858.019" data-end="861.649">happen happens the January runs until it</span> <span data-start="861.649" data-end="863.72">encounters a yield statement so this</span> <span data-start="863.72" data-end="866.119">runs encounters yield and the value to</span> <span data-start="866.119" data-end="868.759">the right one is passed back as the</span> <span data-start="868.759" data-end="873.649">value but when we call next again the</span> <span data-start="873.649" data-end="875.539">generator isn't going to pause at the</span> <span data-start="875.539" data-end="878.089">yield star you can see it's pausing at</span> <span data-start="878.089" data-end="879.589">the first yield statement in the inner</span> <span data-start="879.589" data-end="882.47">generator and the value being returned</span> <span data-start="882.47" data-end="885.019">isn't the generator itself but the value</span> <span data-start="885.019" data-end="888.049">a from the inner generator so yield star</span> <span data-start="888.049" data-end="890.839">is a delegate so when you call next and</span> <span data-start="890.839" data-end="892.759">it encounters a yield star expression it</span> <span data-start="892.759" data-end="895.22">delegates the generator to the right of</span> <span data-start="895.22" data-end="898.91">that expression and it will continue to</span> <span data-start="898.91" data-end="901.85">do so as you call next until that</span> <span data-start="901.85" data-end="904.339">generator is complete so when we call</span> <span data-start="904.339" data-end="906.409">next again the inner generator isn't</span> <span data-start="906.409" data-end="910.85">done yet so now the value is B now the</span> <span data-start="910.85" data-end="913.129">inner generator is complete and so we</span> <span data-start="913.129" data-end="914.72">move on to the next yield statement in</span> <span data-start="914.72" data-end="919.279">the outer function and in addition to</span> <span data-start="919.279" data-end="921.769">being paused generators can be cancelled</span> <span data-start="921.769" data-end="924.159">and you can do this one of two ways so</span> <span data-start="924.159" data-end="926.689">the first is with the return statement</span> <span data-start="926.689" data-end="929.089">so this generator because it's using a</span> <span data-start="929.089" data-end="931.639">while true it should run for as long as</span> </p>
<p><span data-start="931.639" data-end="932.16">I call</span> <span data-start="932.16" data-end="935.61">the next method but instead when this</span> <span data-start="935.61" data-end="937.199">generator encounters the return</span> <span data-start="937.199" data-end="940.35">statement it's going to cancel itself so</span> <span data-start="940.35" data-end="943.889">you can see that done is now true and it</span> <span data-start="943.889" data-end="945.69">doesn't matter how many times I call</span> <span data-start="945.69" data-end="950.939">next this generator is done and you can</span> <span data-start="950.939" data-end="953.189">also cancel a generator from outside of</span> <span data-start="953.189" data-end="955.829">itself so here again the generator</span> <span data-start="955.829" data-end="959.189">should be infinite but when I call the</span> <span data-start="959.189" data-end="961.92">return method on it it cancels the</span> <span data-start="961.92" data-end="965.189">generator and this is really interesting</span> <span data-start="965.189" data-end="966.959">that you can cancel a generator from</span> <span data-start="966.959" data-end="970.35">within or outside because you can only</span> <span data-start="970.35" data-end="973.259">resume the generator from outside of it</span> <span data-start="973.259" data-end="976.769">so generators are paused via yield and</span> <span data-start="976.769" data-end="980.1">restarted via next but a generator</span> <span data-start="980.1" data-end="983.819">cannot call next on itself if I never</span> <span data-start="983.819" data-end="985.5">call next on this generator it will</span> <span data-start="985.5" data-end="989.49">never yield to it stays paused and this</span> <span data-start="989.49" data-end="991.019">is the thing I really struggled with</span> <span data-start="991.019" data-end="993.48">when I was converting the game from</span> <span data-start="993.48" data-end="996.87">promises to generators because who runs</span> <span data-start="996.87" data-end="1001.1">the generator so if control happens</span> <span data-start="1001.1" data-end="1003.5">outside like something has to be pulling</span> <span data-start="1003.5" data-end="1006.05">the strings like how do you know to keep</span> <span data-start="1006.05" data-end="1007.88">calling dot next on something or how</span> <span data-start="1007.88" data-end="1009.29">many yield statements there are in</span> <span data-start="1009.29" data-end="1012.079">something and so this is where</span> <span data-start="1012.079" data-end="1016.579">co-routines come into play so carbo</span> <span data-start="1016.579" data-end="1018.41">teens are a general control structure</span> <span data-start="1018.41" data-end="1020.72">where control flow is cooperatively</span> <span data-start="1020.72" data-end="1023.74">passed between two different routines I</span> <span data-start="1023.74" data-end="1025.85">like to think of kuru teens as</span> <span data-start="1025.85" data-end="1028.61">cooperative partners because the</span> <span data-start="1028.61" data-end="1031.01">generator can't resume itself you need a</span> <span data-start="1031.01" data-end="1035.6">cooperative partner to help out so this</span> <span data-start="1035.6" data-end="1038.15">function is a basic example of a Co</span> <span data-start="1038.15" data-end="1040.039">routine it's going to take in a</span> <span data-start="1040.039" data-end="1042.439">generator it's going to call it which</span> <span data-start="1042.439" data-end="1046.13">returns the generator object the inner</span> <span data-start="1046.13" data-end="1048.98">function next response calls the</span> <span data-start="1048.98" data-end="1051.77">generators next method this starts the</span> <span data-start="1051.77" data-end="1053.75">generator which will run until it</span> <span data-start="1053.75" data-end="1056.27">encounters a yield statement at this</span> <span data-start="1056.27" data-end="1058.49">time the generator returns an object</span> <span data-start="1058.49" data-end="1061.37">with the value key and the done key next</span> <span data-start="1061.37" data-end="1063.62">response evaluates whether the generator</span> <span data-start="1063.62" data-end="1065.13">is done or not</span> <span data-start="1065.13" data-end="1067.44">calls itself and if not it calls itself</span> <span data-start="1067.44" data-end="1068.85">with the value from the generators</span> <span data-start="1068.85" data-end="1071.58">response and this loop continues until</span> <span data-start="1071.58" data-end="1075.78">the generator is done so the co routine</span> <span data-start="1075.78" data-end="1077.429">is the cooperative partner to the</span> <span data-start="1077.429" data-end="1080.4">generator the co routine function passes</span> <span data-start="1080.4" data-end="1082.62">control to the generator and when the</span> <span data-start="1082.62" data-end="1084.9">generator pauses control is yielded back</span> <span data-start="1084.9" data-end="1087.15">to the co routine and these two</span> <span data-start="1087.15" data-end="1089.25">functions cooperatively pass control</span> <span data-start="1089.25" data-end="1094.26">until completion so now I can rewrite</span> <span data-start="1094.26" data-end="1097.549">the bounce animation as a generator and</span> <span data-start="1097.549" data-end="1101.25">use a Co routine to run it except you'll</span> <span data-start="1101.25" data-end="1103.14">notice that this code suffers from the</span> <span data-start="1103.14" data-end="1105.99">same issue I had in the beginning the</span> <span data-start="1105.99" data-end="1108.059">animation still happens too quickly I</span> <span data-start="1108.059" data-end="1110.4">still actually need set timeout and I</span> <span data-start="1110.4" data-end="1114.03">actually still need promises but my</span> <span data-start="1114.03" data-end="1116.1">generator doesn't care if I'm using</span> <span data-start="1116.1" data-end="1118.74">promises it's not going to wait for each</span> <span data-start="1118.74" data-end="1121.919">individual promise to resolve and then</span> <span data-start="1121.919" data-end="1124.23">resume itself like it can't resume</span> <span data-start="1124.23" data-end="1128.33">itself but a cooperative partner could</span> <span data-start="1128.33" data-end="1131.909">so I can amend my Co routine to handle</span> <span data-start="1131.909" data-end="1134.94">async requests instead of calling next</span> <span data-start="1134.94" data-end="1137.25">response we'll call a handle async</span> <span data-start="1137.25" data-end="1139.71">function we'll pass it the value of the</span> <span data-start="1139.71" data-end="1141.9">generators response which is a promise</span> <span data-start="1141.9" data-end="1145.799">and now we can prevent the generator</span> <span data-start="1145.799" data-end="1148.409">from resuming until the promise is</span> <span data-start="1148.409" data-end="1151.26">resolved when it's resolved we'll call</span> <span data-start="1151.26" data-end="1153.45">next response which will resume the</span> <span data-start="1153.45" data-end="1155.419">generator</span> <span data-start="1155.419" data-end="1158.46">so with this amended Co routine these</span> <span data-start="1158.46" data-end="1160.799">functions are now equivalent so</span> <span data-start="1160.799" data-end="1162.78">previously we chained promises together</span> <span data-start="1162.78" data-end="1165.27">for the animation and now we can yield</span> <span data-start="1165.27" data-end="1168">promises and our cooperative partner the</span> </p>
<p><span data-start="1168" data-end="1170.52">KO routine will handle resuming the</span> <span data-start="1170.52" data-end="1173.51">generator when the promise is resolved</span> <span data-start="1173.51" data-end="1176.25">so you can do more than yield promises</span> <span data-start="1176.25" data-end="1178.23">you can yield all sorts of async things</span> <span data-start="1178.23" data-end="1180.33">like callback functions and generators</span> <span data-start="1180.33" data-end="1182.669">themselves and more and there's a really</span> <span data-start="1182.669" data-end="1184.5">great library called Co if you want to</span> <span data-start="1184.5" data-end="1186.299">play around with that I really highly</span> <span data-start="1186.299" data-end="1189">recommend it kuru teens are very very</span> <span data-start="1189" data-end="1192.24">powerful and the reason they're so</span> <span data-start="1192.24" data-end="1194.52">powerful is that they allow you to think</span> <span data-start="1194.52" data-end="1198.63">sequentially about async code because</span> <span data-start="1198.63" data-end="1198.9">the</span> <span data-start="1198.9" data-end="1200.7">her routine is your cooperative partner</span> <span data-start="1200.7" data-end="1202.95">and handling the messy business of</span> <span data-start="1202.95" data-end="1205.47">chaining and dealing with async code for</span> <span data-start="1205.47" data-end="1207.81">you in the background you can write your</span> <span data-start="1207.81" data-end="1212.91">code as if it ran sequentially so for</span> <span data-start="1212.91" data-end="1214.71">the second version of this game I</span> <span data-start="1214.71" data-end="1217.23">rewrote all the animations with promises</span> <span data-start="1217.23" data-end="1219.39">and generators so what you're seeing</span> <span data-start="1219.39" data-end="1221.43">here is actually the same idle animation</span> <span data-start="1221.43" data-end="1223.83">but with generators and promises and run</span> <span data-start="1223.83" data-end="1226.74">by a KO routine and I had two goals with</span> <span data-start="1226.74" data-end="1228.99">this rewrite I wanted to be able to</span> <span data-start="1228.99" data-end="1231.39">pause animations and I want to take</span> <span data-start="1231.39" data-end="1233.46">advantage of thinking sequentially about</span> <span data-start="1233.46" data-end="1237.96">async code so to do that I started with</span> <span data-start="1237.96" data-end="1239.55">rewriting the function that delays the</span> <span data-start="1239.55" data-end="1240.54">animation</span> <span data-start="1240.54" data-end="1243.33">so this is our async function and it</span> <span data-start="1243.33" data-end="1244.77">doesn't need to hold the animation</span> <span data-start="1244.77" data-end="1247.17">itself it just needs to delay with a</span> <span data-start="1247.17" data-end="1249.77">promise that's its sole responsibility</span> <span data-start="1249.77" data-end="1251.94">so when this function is called it</span> <span data-start="1251.94" data-end="1254.34">returns a new promise and resolved that</span> <span data-start="1254.34" data-end="1257.52">when the timeout is complete it also</span> <span data-start="1257.52" data-end="1259.23">broke out the context clearing it to its</span> <span data-start="1259.23" data-end="1261.48">own function and the drawing of the</span> <span data-start="1261.48" data-end="1264.96">image into its own function and now we</span> <span data-start="1264.96" data-end="1267.06">can combine these new functions to</span> <span data-start="1267.06" data-end="1269.58">replace the previous animation function</span> <span data-start="1269.58" data-end="1273.06">and we can do so inside a generator so</span> <span data-start="1273.06" data-end="1274.98">we'll clear whatever was previously on</span> <span data-start="1274.98" data-end="1276.63">the canvas and then draw the new frame</span> <span data-start="1276.63" data-end="1280.56">and those can occur synchronously will</span> <span data-start="1280.56" data-end="1282.57">yield the delay that's the asynchronous</span> <span data-start="1282.57" data-end="1285.21">part of this function but because we're</span> <span data-start="1285.21" data-end="1286.92">handing it off to the co-routine our</span> <span data-start="1286.92" data-end="1289.56">cooperative partner this looks and feels</span> <span data-start="1289.56" data-end="1292.74">very synchronous the KO routine will</span> <span data-start="1292.74" data-end="1294.72">handle the resolve promise when the</span> <span data-start="1294.72" data-end="1297.99">timeout completes and so here is our</span> <span data-start="1297.99" data-end="1301.44">draw frame generator in use this dislike</span> <span data-start="1301.44" data-end="1303.81">animation draws two frames and because</span> <span data-start="1303.81" data-end="1305.91">draw frame is a generator we're using</span> <span data-start="1305.91" data-end="1308.78">yield star to delegate yield calls to it</span> <span data-start="1308.78" data-end="1311.22">so for each call and draw frame we're</span> <span data-start="1311.22" data-end="1313.14">clearing the context drawing the frame</span> <span data-start="1313.14" data-end="1316.38">and then delaying and then this is what</span> <span data-start="1316.38" data-end="1317.82">the dislike animation looks like you can</span> <span data-start="1317.82" data-end="1320.49">see it's a very unhappy tamagotchi just</span> <span data-start="1320.49" data-end="1323.94">really pissed okay and now we can</span> <span data-start="1323.94" data-end="1326.37">rewrite also the main game loop and take</span> <span data-start="1326.37" data-end="1329.37">advantage of canceling the generator so</span> <span data-start="1329.37" data-end="1332.01">our loop generator function will be run</span> <span data-start="1332.01" data-end="1333.059">by ko</span> <span data-start="1333.059" data-end="1335.01">so we can rely on it to handle any</span> <span data-start="1335.01" data-end="1337.44">values yielded to it we'll create a</span> <span data-start="1337.44" data-end="1339.179">variable to save the status of the</span> <span data-start="1339.179" data-end="1341.61">generator done or not and we'll preset</span> <span data-start="1341.61" data-end="1344.15">the animation to idle</span> <span data-start="1344.15" data-end="1346.71">we'll use a while loop to create a</span> <span data-start="1346.71" data-end="1349.11">never-ending generator so this way the</span> <span data-start="1349.11" data-end="1350.61">game loop is going to continue forever</span> <span data-start="1350.61" data-end="1353.67">if we have a pending user event we'll</span> <span data-start="1353.67" data-end="1355.47">cancel the current animation and</span> <span data-start="1355.47" data-end="1357.72">delegate to the event using yield star</span> <span data-start="1357.72" data-end="1360.179">and whatever the event yields will be</span> <span data-start="1360.179" data-end="1364.41">passed to the co routine otherwise a</span> <span data-start="1364.41" data-end="1366.45">second while loop will handle running</span> <span data-start="1366.45" data-end="1368.64">the animation a while loop inside a</span> <span data-start="1368.64" data-end="1369.78">while loop I want you to understand</span> <span data-start="1369.78" data-end="1370.559">though this is nuts</span> <span data-start="1370.559" data-end="1374.04">as long as the animation is not complete</span> <span data-start="1374.04" data-end="1376.53">and there are no pending events this</span> <span data-start="1376.53" data-end="1378.63">loop will yield the generators values to</span> <span data-start="1378.63" data-end="1380.22">the KO routine to handle and these are</span> <span data-start="1380.22" data-end="1382.14">promises so the KO routine is going to</span> <span data-start="1382.14" data-end="1385.74">handle the chaining but if the animation</span> <span data-start="1385.74" data-end="1388.11">is done or there is a pending user event</span> <span data-start="1388.11" data-end="1390.419">the loop is going to terminate stopping</span> <span data-start="1390.419" data-end="1391.83">the animation generator from running</span> <span data-start="1391.83" data-end="1394.559">again and will reassign animation to the</span> <span data-start="1394.559" data-end="1396.39">idle generator to start from fresh and</span> <span data-start="1396.39" data-end="1399.179">it will reset done to false and on the</span> <span data-start="1399.179" data-end="1400.89">next iteration of this while loop</span> <span data-start="1400.89" data-end="1403.08">pending will be true and will handle the</span> <span data-start="1403.08" data-end="1406.95">user event instead so this is the</span> <span data-start="1406.95" data-end="1408.66">generator function for the feed action</span> <span data-start="1408.66" data-end="1411.24">it evaluates if the Tamagotchi is hungry</span> <span data-start="1411.24" data-end="1414.419">or not if it's not it delegates future</span> <span data-start="1414.419" data-end="1416.429">calls to the dislike anim generator</span> <span data-start="1416.429" data-end="1418.61">which will run the dislike animation</span> <span data-start="1418.61" data-end="1420.809">otherwise we're gonna decrease the</span> <span data-start="1420.809" data-end="1422.429">hunger count and use the yield star</span> <span data-start="1422.429" data-end="1423.9">we're gonna delegate to the eat</span> <span data-start="1423.9" data-end="1426.99">generator that runs that animation all</span> <span data-start="1426.99" data-end="1429.69">right so will this work all right so</span> <span data-start="1429.69" data-end="1431.4">we're idling I'm gonna say yeah I want</span> <span data-start="1431.4" data-end="1432.57">to feed you I'm gonna feed you a burger</span> <span data-start="1432.57" data-end="1434.76">he's eating all right so the idle engine</span> <span data-start="1434.76" data-end="1438.21">canceled I'm gonna do it again but this</span> <span data-start="1438.21" data-end="1441.65">time I'm a feedom candy in a second</span> <span data-start="1441.65" data-end="1445.89">cuz you know a well-balanced meal there</span> <span data-start="1445.89" data-end="1446.309">we go</span> <span data-start="1446.309" data-end="1449.549">cool all right he seems fine so idle</span> <span data-start="1449.549" data-end="1451.46">animation keeps running again</span> <span data-start="1451.46" data-end="1453.36">all right let's feed him one more time</span> <span data-start="1453.36" data-end="1455.91">cuz I think maybe he's still hungry now</span> <span data-start="1455.91" data-end="1458.83">he's mad he doesn't like that alright</span> <span data-start="1458.83" data-end="1462.279">so that's LL for me if you want to check</span> <span data-start="1462.279" data-end="1464.11">out the code for this there's the link</span> <span data-start="1464.11" data-end="1467.33">to the repository for it and huh</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
