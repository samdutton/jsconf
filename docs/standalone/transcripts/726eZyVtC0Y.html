<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>726eZyVtC0Y</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/726eZyVtC0Y?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="0.14" data-end="2.73">good morning thank you for coming out to</span> <span data-start="2.73" data-end="5.52">my session on elegant pacing patterns</span> <span data-start="5.52" data-end="7.2">and different functional programming</span> <span data-start="7.2" data-end="9.54">techniques you guys can use right now to</span> <span data-start="9.54" data-end="12.179">help scale your JavaScript up to</span> <span data-start="12.179" data-end="14.07">multiple cores if that sounds a little</span> <span data-start="14.07" data-end="15.299">bit crazy and you're thinking wait a</span> <span data-start="15.299" data-end="16.77">minute javascript can't even do this</span> <span data-start="16.77" data-end="17.699">hang tight</span> <span data-start="17.699" data-end="19.98">we'll get there so I'm Jonathan Martin</span> <span data-start="19.98" data-end="23.369">or you can find me at nibbler on the web</span> <span data-start="23.369" data-end="25.47">one of the awesome calligraphy artists</span> <span data-start="25.47" data-end="28.109">do this and spell this out so if you</span> <span data-start="28.109" data-end="30.179">haven't already checked out their booth</span> <span data-start="30.179" data-end="31.529">by the way you should check it out</span> <span data-start="31.529" data-end="33.149">they're really really good at what they</span> <span data-start="33.149" data-end="35.91">do and I'm an instructor in web</span> <span data-start="35.91" data-end="38.1">developer for a consultancy in the USA</span> <span data-start="38.1" data-end="41.01">it's called big nerd ranch big nerd</span> <span data-start="41.01" data-end="43.95">ranch develops web and mobile apps for</span> <span data-start="43.95" data-end="46.379">our clients and we also teach developers</span> <span data-start="46.379" data-end="47.969">to do the same through intensive</span> <span data-start="47.969" data-end="50.28">five-day Bute camps mostly in the US and</span> <span data-start="50.28" data-end="52.829">then also we fly out to many of our</span> <span data-start="52.829" data-end="55.32">clients around the globe we also teach</span> <span data-start="55.32" data-end="56.699">developers to our best-selling</span> <span data-start="56.699" data-end="58.71">programming guides so maybe you've seen</span> <span data-start="58.71" data-end="60.3">some of these before especially in the</span> <span data-start="60.3" data-end="62.01">iOS and Android space and we have a</span> <span data-start="62.01" data-end="64.7">front-end web development guide as well</span> <span data-start="64.7" data-end="66.93">outside big nerd ranch I'm also a</span> <span data-start="66.93" data-end="68.76">digital nomad which really just means</span> <span data-start="68.76" data-end="70.92">that I leverage technology to work from</span> <span data-start="70.92" data-end="71.76">anywhere in the globe</span> <span data-start="71.76" data-end="74.61">so some of these areas might be where I</span> <span data-start="74.61" data-end="77.34">might be working any given day this</span> <span data-start="77.34" data-end="79.53">isn't quite the norm yet I'm working up</span> <span data-start="79.53" data-end="81.81">towards this so over the last three</span> <span data-start="81.81" data-end="83.61">years this lifestyle in particular has</span> <span data-start="83.61" data-end="85.049">really helped me to nurture my love for</span> <span data-start="85.049" data-end="87.119">landscape photography so if you don't</span> <span data-start="87.119" data-end="89.46">like JavaScript or multi-threading which</span> <span data-start="89.46" data-end="91.38">seems unusual since you came to a Jay s</span> <span data-start="91.38" data-end="93.63">comp you can go look at pretty pictures</span> <span data-start="93.63" data-end="95.759">instead for now I'll assume that's not</span> <span data-start="95.759" data-end="99.24">the case since it is a Escom so when I</span> <span data-start="99.24" data-end="100.65">was accepted it comes to speak here at</span> </p>
<p><span data-start="100.65" data-end="102.63">Budapest I was pretty excited so I</span> <span data-start="102.63" data-end="104.369">started to piece together my travel</span> <span data-start="104.369" data-end="106.38">plans for speaking here in Budapest I'm</span> <span data-start="106.38" data-end="108.329">slightly obsessed with the two to-do</span> <span data-start="108.329" data-end="110.159">lists so I started listening out the</span> <span data-start="110.159" data-end="111.869">things I need to complete before I could</span> <span data-start="111.869" data-end="114.36">give this talk in Budapest of course I</span> <span data-start="114.36" data-end="116.31">need to fly out here be a little bit</span> <span data-start="116.31" data-end="117.99">hard to give it over hangouts internet</span> <span data-start="117.99" data-end="119.729">connections in Alabama are the slowest</span> <span data-start="119.729" data-end="122.25">in the u.s. also I'd need to put</span> <span data-start="122.25" data-end="123.84">together a slide deck so I need to work</span> <span data-start="123.84" data-end="126.03">on those I'd probably need to get packed</span> <span data-start="126.03" data-end="128.94">for the trip I just some phone calls I</span> <span data-start="128.94" data-end="130.47">need to make before that true</span> <span data-start="130.47" data-end="132.33">and probably on the flight I should read</span> <span data-start="132.33" data-end="135.3">a book and at least some time before my</span> <span data-start="135.3" data-end="138.2">session I needed to take a shower so</span> <span data-start="138.2" data-end="141.69">lists are great and but to really start</span> <span data-start="141.69" data-end="143.37">knocking out leads to dues of course you</span> <span data-start="143.37" data-end="145.05">need to figure out well what order am I</span> <span data-start="145.05" data-end="146.61">gonna do these in what's gonna be my</span> <span data-start="146.61" data-end="149.55">plan for completing these so I could</span> <span data-start="149.55" data-end="151.53">just naively go from top to bottom and</span> <span data-start="151.53" data-end="154.41">complete them one by one in that case I</span> <span data-start="154.41" data-end="155.79">probably would have never made it out</span> <span data-start="155.79" data-end="157.47">here since I didn't actually have the</span> <span data-start="157.47" data-end="159.33">slide deck finished until a few minutes</span> <span data-start="159.33" data-end="161.37">ago so I probably would never have flown</span> <span data-start="161.37" data-end="163.08">out here and so I wouldn't be here so</span> <span data-start="163.08" data-end="165.54">that's one strategy I could use I could</span> <span data-start="165.54" data-end="167.13">go from top to bottom finish these one</span> <span data-start="167.13" data-end="170.07">by one but we're human we don't actually</span> <span data-start="170.07" data-end="173.25">finish things this way we tend to do</span> <span data-start="173.25" data-end="175.98">more than one thing at a time so for</span> <span data-start="175.98" data-end="178.56">example some of these things could</span> <span data-start="178.56" data-end="180.18">happen at the same time you know maybe</span> <span data-start="180.18" data-end="182.55">on my flight I could work on my slide</span> <span data-start="182.55" data-end="184.65">deck if I was able to stay awake for</span> <span data-start="184.65" data-end="186.63">that flight so if I were smarter when</span> <span data-start="186.63" data-end="188.64">writing my to-do lists maybe I could</span> <span data-start="188.64" data-end="191.13">encode constraints and preferences so I</span> <span data-start="191.13" data-end="193.35">could better plan how to tackle this</span> <span data-start="193.35" data-end="197.34">really onerous to-do list for example I</span> <span data-start="197.34" data-end="200.13">could encode my constraints as arrows</span> <span data-start="200.13" data-end="202.02">which show that some things logically</span> <span data-start="202.02" data-end="204.36">have to come before others for example I</span> <span data-start="204.36" data-end="206.13">have to pack before my flight and I have</span> <span data-start="206.13" data-end="208.83">to fly before I can speak I also have to</span> <span data-start="208.83" data-end="210.42">work on my slide deck but really that</span> <span data-start="210.42" data-end="212.31">can happen any time before I get my talk</span> <span data-start="212.31" data-end="214.17">so long as it happens before then I</span> <span data-start="214.17" data-end="215.67">could work on it before or after my</span> <span data-start="215.67" data-end="217.83">flight now some of these things also</span> <span data-start="217.83" data-end="219.75">can't happen at the same time for</span> <span data-start="219.75" data-end="221.34">example I can't make a phone call while</span> </p>
<p><span data-start="221.34" data-end="223.38">I'm on the plane and I can't read a book</span> <span data-start="223.38" data-end="225.209">while I'm in the shower as awesome as</span> <span data-start="225.209" data-end="228">that sounds together these describe my</span> <span data-start="228" data-end="230.37">constraints and preferences for how I'm</span> <span data-start="230.37" data-end="233.6">going to get ready for my Jas comp talk</span> <span data-start="233.6" data-end="235.98">software also deals with to-do lists of</span> <span data-start="235.98" data-end="238.41">its own and the problem is twofold we</span> <span data-start="238.41" data-end="240.66">need a way to model constraints and</span> <span data-start="240.66" data-end="243.09">preferences for how work gets done and</span> <span data-start="243.09" data-end="245.16">we need to figure out the optimal</span> <span data-start="245.16" data-end="247.41">solution that satisfies all those</span> <span data-start="247.41" data-end="249.45">constraints and preferences and the way</span> <span data-start="249.45" data-end="251.04">we solve these two problems is a</span> <span data-start="251.04" data-end="253.83">defining characteristic of many</span> <span data-start="253.83" data-end="255">different programming languages</span> <span data-start="255" data-end="258.359">including Java Script now before I hop</span> <span data-start="258.359" data-end="259.739">into the body of this session I want to</span> <span data-start="259.739" data-end="261.37">recap some terminology briefly</span> <span data-start="261.37" data-end="263.199">in particular we're going to toss around</span> <span data-start="263.199" data-end="266.669">the terms concurrency and parallelism</span> <span data-start="266.669" data-end="268.72">parallelism excuse me</span> <span data-start="268.72" data-end="270.729">concurrency just means that two or more</span> <span data-start="270.729" data-end="273.37">computations have overlapping timelines</span> <span data-start="273.37" data-end="276.16">with each other in terms of execution so</span> <span data-start="276.16" data-end="278.919">for example task 3 begins before task</span> <span data-start="278.919" data-end="281.41">two and task 1 but before task 3</span> <span data-start="281.41" data-end="284.169">completes task 1 and task 2 will already</span> <span data-start="284.169" data-end="286.21">begin computing so that's what I mean by</span> <span data-start="286.21" data-end="288.669">overlapping timelines now how you</span> <span data-start="288.669" data-end="290.86">achieve that concurrency is really up to</span> <span data-start="290.86" data-end="292">you there's a lot of different</span> <span data-start="292" data-end="294.55">strategies you could use one example is</span> <span data-start="294.55" data-end="296.32">you could switch really quickly between</span> <span data-start="296.32" data-end="299.169">working on these three tasks so in</span> <span data-start="299.169" data-end="300.789">particular and software we could use</span> <span data-start="300.789" data-end="304.06">multi-threading to do this a single CPU</span> <span data-start="304.06" data-end="306.13">core can really only do one thing at a</span> <span data-start="306.13" data-end="308.26">time but by quickly switching we could</span> <span data-start="308.26" data-end="310.419">have these overlapping execution</span> <span data-start="310.419" data-end="312.669">timelines context switching makes it</span> <span data-start="312.669" data-end="314.169">seem like we're doing three things at</span> <span data-start="314.169" data-end="316.11">the same time even though we aren't</span> <span data-start="316.11" data-end="318.4">there's another way we can do this we</span> <span data-start="318.4" data-end="320.229">could have three separate machines or</span> </p>
<p><span data-start="320.229" data-end="323.65">CPU cores and dedicate one core per task</span> <span data-start="323.65" data-end="326.65">this specific form of concurrency is</span> <span data-start="326.65" data-end="328.539">often called parallelism</span> <span data-start="328.539" data-end="331.09">so to summarize concurrent programs can</span> <span data-start="331.09" data-end="332.34">run multiple pieces of code</span> <span data-start="332.34" data-end="334.08">independently of each other and</span> <span data-start="334.08" data-end="336.82">multi-threading and parallelism are just</span> <span data-start="336.82" data-end="339.639">two execution strategies for running</span> <span data-start="339.639" data-end="342.25">code concurrently so how we write our</span> <span data-start="342.25" data-end="344.5">code our choice of style isn't really</span> <span data-start="344.5" data-end="346.479">going to very much based on our choice</span> <span data-start="346.479" data-end="349.27">of do we write it in parallel or</span> <span data-start="349.27" data-end="351.58">multi-threaded so for this talk</span> </p>
<p><span data-start="351.58" data-end="352.75">I'm not going to distinguish between</span> <span data-start="352.75" data-end="354.639">them I'm just going to collectively</span> <span data-start="354.639" data-end="359.199">refer to it as concurrency so after this</span> <span data-start="359.199" data-end="360.97">point you don't have to remember any of</span> <span data-start="360.97" data-end="362.289">those crazy things we're just always</span> <span data-start="362.289" data-end="363.58">going to talk about code being</span> <span data-start="363.58" data-end="365.44">concurrent which just means two or more</span> <span data-start="365.44" data-end="368.199">things to our more functions perhaps are</span> <span data-start="368.199" data-end="371.889">running at the same time now some of you</span> <span data-start="371.889" data-end="375.07">gave me a funny little wink when I said</span> <span data-start="375.07" data-end="376.24">something about multi-threading in</span> </p>
<p><span data-start="376.24" data-end="377.74">JavaScript in the same sentence</span> <span data-start="377.74" data-end="379.87">so note in front-end developers alike</span> <span data-start="379.87" data-end="381.699">are commonly trolled by the classic</span> <span data-start="381.699" data-end="384.07">question how do you scale a JavaScript</span> <span data-start="384.07" data-end="386.08">code base since it's single threaded a</span> <span data-start="386.08" data-end="389.169">little bit of a loaded question but in</span> <span data-start="389.169" data-end="391.45">fact not only is it multi-threaded</span> <span data-start="391.45" data-end="393.789">javascript is highly concurrent by</span> <span data-start="393.789" data-end="394.93">default Thanks</span> <span data-start="394.93" data-end="397.539">to the event loop but it shields us at</span> <span data-start="397.539" data-end="398.71">the same time from many of them</span> <span data-start="398.71" data-end="400.57">multi-threading woes and synchronization</span> <span data-start="400.57" data-end="402.46">primitives you might be familiar with in</span> <span data-start="402.46" data-end="405.22">other languages like semaphores mutexes</span> <span data-start="405.22" data-end="408.97">locks etc so for example each of these</span> <span data-start="408.97" data-end="411.61">web api calls seamlessly fires up a</span> <span data-start="411.61" data-end="413.979">separate thread for a total of four</span> <span data-start="413.979" data-end="415.87">threads you have the main Orchestrator</span> <span data-start="415.87" data-end="417.25">thread which is where you write this</span> <span data-start="417.25" data-end="419.65">code and then you also get these three</span> <span data-start="419.65" data-end="421.479">others in the background for free that</span> <span data-start="421.479" data-end="424.6">are powering these different api's so</span> <span data-start="424.6" data-end="426.88">how on earth does that actually work if</span> <span data-start="426.88" data-end="429.49">javascript is multi-threaded how is it</span> <span data-start="429.49" data-end="431.259">that everything seemed like you is</span> <span data-start="431.259" data-end="433.449">running on one thread which means that</span> <span data-start="433.449" data-end="434.949">there's only one call stack and there's</span> <span data-start="434.949" data-end="437.169">one thing happening at a time so how can</span> <span data-start="437.169" data-end="438.729">you write your code in such a way that</span> <span data-start="438.729" data-end="440.65">it looks like it's singles write it but</span> <span data-start="440.65" data-end="442.06">it's actually taking advantage of</span> <span data-start="442.06" data-end="444.099">multiple cores well that's where the</span> <span data-start="444.099" data-end="446.979">event loop comes in now in 30 minutes I</span> <span data-start="446.979" data-end="448.419">can't actually do full justice and</span> <span data-start="448.419" data-end="450.46">explaining the event loop so let me just</span> <span data-start="450.46" data-end="452.199">give you a quick recap and just keep in</span> <span data-start="452.199" data-end="454.3">mind that I'm lying to you quite a bit</span> <span data-start="454.3" data-end="456.31">so it's grossly inaccurate I'll forward</span> <span data-start="456.31" data-end="458.82">you guys to a slightly better</span> <span data-start="458.82" data-end="460.63">examination of the event loop near the</span> <span data-start="460.63" data-end="463.18">end so in the middle of this slide we</span> <span data-start="463.18" data-end="465.34">have the call stack and the call stack</span> <span data-start="465.34" data-end="467.05">just helps us keep track of what is</span> <span data-start="467.05" data-end="469.539">currently executing you might think of</span> <span data-start="469.539" data-end="472.18">this and if this is your main javascript</span> <span data-start="472.18" data-end="473.919">file and the pages just started up you</span> <span data-start="473.919" data-end="476.229">might think of this as the main function</span> <span data-start="476.229" data-end="478.72">if you have a callback executing then</span> <span data-start="478.72" data-end="480.34">you could imagine that callback is on</span> <span data-start="480.34" data-end="483.49">the call stack so on the far left we</span> <span data-start="483.49" data-end="485.08">have the built-in web api's</span> <span data-start="485.08" data-end="487.72">and these are natively implemented for</span> <span data-start="487.72" data-end="489.43">equivalency this could also be the node</span> <span data-start="489.43" data-end="491.59">api's node works the same way it also</span> <span data-start="491.59" data-end="493.9">uses the event loop and then finally on</span> <span data-start="493.9" data-end="495.37">the far left we have our source code</span> <span data-start="495.37" data-end="497.8">that we've written we've loaded into the</span> <span data-start="497.8" data-end="498.97">browser and now we're going to start</span> <span data-start="498.97" data-end="501.159">executing it so the first line is</span> <span data-start="501.159" data-end="503.65">performing an ajax request and it</span> <span data-start="503.65" data-end="505.9">executes a function called parse once we</span> <span data-start="505.9" data-end="510.28">receive an ajax response second we're</span> <span data-start="510.28" data-end="512.979">using the set timeout api to schedule a</span> <span data-start="512.979" data-end="515.2">refresh function to run in about five</span> <span data-start="515.2" data-end="517.51">seconds or so and finally we use the</span> <span data-start="517.51" data-end="520.839">indexdb api to make a database query and</span> <span data-start="520.839" data-end="523.12">invoke a function called render once</span> <span data-start="523.12" data-end="525.73">that query has completed so how is the</span> </p>
<p><span data-start="525.73" data-end="527.35">JavaScript runtime actually going to go</span> <span data-start="527.35" data-end="528.38">about eval</span> <span data-start="528.38" data-end="530">awaiting this code some of these</span> <span data-start="530" data-end="531.68">operations for example will take a while</span> <span data-start="531.68" data-end="534.05">in Ajax requests might take a few</span> <span data-start="534.05" data-end="535.61">hundred milliseconds or it might take</span> <span data-start="535.61" data-end="537.38">several seconds depending on the</span> <span data-start="537.38" data-end="539.84">connection yarn so javascript is going</span> <span data-start="539.84" data-end="541.81">to evaluate these in a very specific</span> <span data-start="541.81" data-end="544.82">order and so let's just to build up our</span> <span data-start="544.82" data-end="545.84">understanding of the event loop we're</span> <span data-start="545.84" data-end="548.24">going to walk through this ourselves so</span> <span data-start="548.24" data-end="549.59">as soon as that fetch function is</span> <span data-start="549.59" data-end="551.12">invoked you can imagine that that's</span> <span data-start="551.12" data-end="553.76">currently on the call stack and it fires</span> <span data-start="553.76" data-end="556.73">up a natively implemented web api in the</span> <span data-start="556.73" data-end="559.88">backgrounds but it doesn't just fire up</span> <span data-start="559.88" data-end="562.19">the fetch API it also passes along a</span> <span data-start="562.19" data-end="565.1">function or callback to invoke once that</span> <span data-start="565.1" data-end="568.49">fetch API receives the Ajax response now</span> <span data-start="568.49" data-end="570.5">while that fetch Web API is running in</span> <span data-start="570.5" data-end="571.37">the background</span> <span data-start="571.37" data-end="573.35">the runtime will advance to the next</span> <span data-start="573.35" data-end="575.39">line and go ahead and execute it without</span> <span data-start="575.39" data-end="577.19">waiting for the Ajax request to finish</span> <span data-start="577.19" data-end="579.53">this is how we think of asynchronous</span> <span data-start="579.53" data-end="582.8">coding in JavaScript the set timeout API</span> <span data-start="582.8" data-end="585.02">also fires up a native web the API and</span> <span data-start="585.02" data-end="586.88">passes along a callback to execute once</span> <span data-start="586.88" data-end="588.59">the time is up it's a very similar</span> <span data-start="588.59" data-end="593.15">behavior so indexdb works exactly the</span> <span data-start="593.15" data-end="594.83">same way it fires up a native web api</span> <span data-start="594.83" data-end="597.44">and it passes a callback to execute — in</span> <span data-start="597.44" data-end="602.06">the indexdb web api so now what we're</span> <span data-start="602.06" data-end="603.71">out of source code to execute there's</span> <span data-start="603.71" data-end="605.54">nothing on the call stack in most</span> <span data-start="605.54" data-end="606.74">languages this would mean that your</span> <span data-start="606.74" data-end="608.48">program is dead it's not running</span> <span data-start="608.48" data-end="611.06">anything however we do have those native</span> <span data-start="611.06" data-end="613.07">web api is still crunching some code for</span> <span data-start="613.07" data-end="615.56">us in the background and so let's say</span> <span data-start="615.56" data-end="618.8">that when the index DB query finishes it</span> <span data-start="618.8" data-end="621.11">will alert the JavaScript runtime by</span> <span data-start="621.11" data-end="622.97">pushing that render callback we gave it</span> <span data-start="622.97" data-end="625.52">on to a queue it's very imaginatively</span> <span data-start="625.52" data-end="628.4">named the callback queue now this</span> <span data-start="628.4" data-end="631.82">doesn't yet run our render function so</span> <span data-start="631.82" data-end="633.38">the event loop is actually just a</span> <span data-start="633.38" data-end="635.21">mechanism that checks to see if there's</span> <span data-start="635.21" data-end="637.97">anything currently running in other</span> <span data-start="637.97" data-end="639.11">words is there something in the call</span> <span data-start="639.11" data-end="640.91">stack and if there is something in the</span> <span data-start="640.91" data-end="643.28">callback queue if there's nothing in the</span> <span data-start="643.28" data-end="644.9">call stack and there's at least</span> <span data-start="644.9" data-end="647.54">something on the combat queue the event</span> <span data-start="647.54" data-end="649.79">loop will pop off that first callback</span> <span data-start="649.79" data-end="652.31">off the queue and push it onto the call</span> <span data-start="652.31" data-end="654.62">stack which means that now our render</span> <span data-start="654.62" data-end="658.76">function is executing now while that</span> <span data-start="658.76" data-end="660.35">render function is executing it could</span> <span data-start="660.35" data-end="662.49">take a while another way</span> </p>
<p><span data-start="662.49" data-end="664.17">I might finish its background work</span> <span data-start="664.17" data-end="666.84">perhaps our Ajax request so that web api</span> <span data-start="666.84" data-end="669.3">will immediately push the parse function</span> <span data-start="669.3" data-end="672.69">onto the callback queue however this</span> <span data-start="672.69" data-end="674.82">time there is code already on call stack</span> <span data-start="674.82" data-end="675.72">being executed</span> <span data-start="675.72" data-end="677.58">so that parse function is actually just</span> <span data-start="677.58" data-end="680.22">going to stay in the callback queue this</span> <span data-start="680.22" data-end="683.1">behavior is called run to completion it</span> <span data-start="683.1" data-end="684.96">guarantees that the currently executing</span> <span data-start="684.96" data-end="687.51">function will not be interrupted by</span> <span data-start="687.51" data-end="689.67">another callback which in a nutshell</span> <span data-start="689.67" data-end="690.81">means you don't have to worry about</span> <span data-start="690.81" data-end="694.71">thread safety now when that current</span> <span data-start="694.71" data-end="697.26">function on the call set takes a long</span> <span data-start="697.26" data-end="699.12">time to finish this is what we call</span> <span data-start="699.12" data-end="701.55">blocking the event loop you can just</span> <span data-start="701.55" data-end="703.29">imagine that if the event loop keeps</span> <span data-start="703.29" data-end="705.09">trying to figure out hey can I push</span> <span data-start="705.09" data-end="706.62">something can I push something yet can i</span> <span data-start="706.62" data-end="708.45">grab one of these callbacks and start</span> <span data-start="708.45" data-end="711.03">executing it it's blocked until the call</span> <span data-start="711.03" data-end="715.35">stack is empty now during this time our</span> <span data-start="715.35" data-end="717.96">timer API might also finish and it just</span> <span data-start="717.96" data-end="719.76">pushes the refresh function onto that</span> <span data-start="719.76" data-end="721.41">callback queue and waits to be executed</span> <span data-start="721.41" data-end="724.05">once that render function finally</span> <span data-start="724.05" data-end="726.03">finishes executing the call stack is now</span> <span data-start="726.03" data-end="728.19">empty which means that the event loop</span> <span data-start="728.19" data-end="730.5">can pop the first callback off the</span> <span data-start="730.5" data-end="733.32">callback queue and push it onto the call</span> <span data-start="733.32" data-end="735.66">stack which means it's being executed</span> <span data-start="735.66" data-end="737.04">that's what's currently being executed</span> <span data-start="737.04" data-end="739.68">and of course once the parse function</span> <span data-start="739.68" data-end="741.39">finishes the call SEC will again be</span> <span data-start="741.39" data-end="743.55">empty so we can push that final refresh</span> <span data-start="743.55" data-end="746.64">callback and then execute that to</span> <span data-start="746.64" data-end="750.48">completion so in summary while our own</span> </p>
<p><span data-start="750.48" data-end="752.58">JavaScript code looks like it's single</span> <span data-start="752.58" data-end="754.11">threaded and in a way it is actually</span> <span data-start="754.11" data-end="755.67">single threaded meaning there is only</span> <span data-start="755.67" data-end="757.77">one call stack and only one function</span> <span data-start="757.77" data-end="760.83">running at a time the native background</span> <span data-start="760.83" data-end="763.92">Web API is that powered JavaScript can</span> <span data-start="763.92" data-end="765.63">be executed on separate background</span> <span data-start="765.63" data-end="767.73">threads seamlessly it's not even</span> <span data-start="767.73" data-end="769.71">something we have to think about now not</span> <span data-start="769.71" data-end="772.2">all of the async Web API s use separate</span> <span data-start="772.2" data-end="774.69">threads but the mental model holds and</span> <span data-start="774.69" data-end="776.43">it helps explain why no js' and</span> <span data-start="776.43" data-end="778.35">javascript in the browser can perform so</span> <span data-start="778.35" data-end="780.96">much work concurrently while appearing</span> <span data-start="780.96" data-end="782.88">single threaded makes it very easy to</span> <span data-start="782.88" data-end="785.64">reason about again this was a highly</span> <span data-start="785.64" data-end="787.53">inaccurate version of this I hope that</span> <span data-start="787.53" data-end="789.03">sets the stage at least for the rest of</span> <span data-start="789.03" data-end="790.68">the session but you owe it to yourself</span> <span data-start="790.68" data-end="791.94">to watch Phillip Roberts</span> <span data-start="791.94" data-end="794.19">talk on the subject it's called help I'm</span> <span data-start="794.19" data-end="795.67">stuck in an event loop</span> <span data-start="795.67" data-end="797.98">you can check out this link bitly event</span> <span data-start="797.98" data-end="800.23">loop help really great talk and it's</span> <span data-start="800.23" data-end="803.2">only 20 minutes so the event loop is</span> <span data-start="803.2" data-end="805.42">great but in nodejs you can pretty soon</span> <span data-start="805.42" data-end="807.46">hit a scaling limit with a single</span> <span data-start="807.46" data-end="809.35">process despite the many background</span> <span data-start="809.35" data-end="811.66">threads so at this point many developers</span> <span data-start="811.66" data-end="813.58">typically turn to something like nodes</span> <span data-start="813.58" data-end="817.06">cluster module or PM 2 but turning to</span> <span data-start="817.06" data-end="818.77">multi-processing 2 soon</span> <span data-start="818.77" data-end="820.48">negates many of the single process</span> <span data-start="820.48" data-end="822.28">benefits we enjoy and the predictability</span> <span data-start="822.28" data-end="825.16">of having a single call stack in</span> </p>
<p><span data-start="825.16" data-end="827.41">JavaScript now luckily a single</span> <span data-start="827.41" data-end="829.15">JavaScript runtime thread can actually</span> <span data-start="829.15" data-end="831.67">orchestrate an amazing amount of work</span> <span data-start="831.67" data-end="834.19">but to write code that all that will</span> <span data-start="834.19" data-end="835.6">scale easily and doesn't look like a</span> <span data-start="835.6" data-end="838.3">bunch of promise dot all spaghetti will</span> <span data-start="838.3" data-end="840.31">need to exercise a few patents so in the</span> <span data-start="840.31" data-end="841.72">remainder of this session we're going to</span> <span data-start="841.72" data-end="843.43">cover these three different patterns and</span> <span data-start="843.43" data-end="845.14">recipes that you can use both in your</span> <span data-start="845.14" data-end="847.24">node.js and your front-end web</span> <span data-start="847.24" data-end="849.04">applications to write scalable</span> <span data-start="849.04" data-end="850.93">performant code that remains elegant and</span> <span data-start="850.93" data-end="853.66">actually scales to multiple cores we're</span> <span data-start="853.66" data-end="854.89">gonna do that also without any</span> <span data-start="854.89" data-end="856.93">third-party libraries no frameworks or</span> <span data-start="856.93" data-end="859.53">fads just plain old JavaScript yes</span> <span data-start="859.53" data-end="863.26">2017 specifically so the first pattern</span> <span data-start="863.26" data-end="866.32">is coordinating concurrency with async</span> <span data-start="866.32" data-end="868.33">if ease you probably haven't all heard</span> <span data-start="868.33" data-end="871.68">of and seeing if ease so async if ease</span> <span data-start="871.68" data-end="874.36">should bring up some interesting ideas</span> <span data-start="874.36" data-end="876.34">so when you do more than one thing at a</span> <span data-start="876.34" data-end="877.9">time you usually need some ugly</span> <span data-start="877.9" data-end="879.7">pipelining to describe how those</span> <span data-start="879.7" data-end="881.74">different tasks are related to each</span> <span data-start="881.74" data-end="884.17">other so here's a concrete example let's</span> <span data-start="884.17" data-end="886.36">say we're building iTunes in the browser</span> <span data-start="886.36" data-end="888.58">and we're beginning to write the code</span> <span data-start="888.58" data-end="890.8">for importing mp3 files into our music</span> <span data-start="890.8" data-end="893.26">library in the browser the user might</span> <span data-start="893.26" data-end="894.85">import these files by dragging and</span> <span data-start="894.85" data-end="896.47">dropping them into the browser this is</span> <span data-start="896.47" data-end="898.51">not a theoretical app by the way all the</span> <span data-start="898.51" data-end="901.15">technology for this exists if you're</span> <span data-start="901.15" data-end="903.69">interested I'll show you guys a demo of</span> <span data-start="903.69" data-end="905.77">basically iTunes in the browser and</span> <span data-start="905.77" data-end="907.78">working with mp3s some cool blog posts</span> <span data-start="907.78" data-end="910.45">and stuff so we might imagine if we're</span> <span data-start="910.45" data-end="912.34">writing this mp3 importer there are five</span> <span data-start="912.34" data-end="915.22">steps to import a song first we need to</span> <span data-start="915.22" data-end="917.95">read in the mp3 files contents we might</span> <span data-start="917.95" data-end="920.14">have a file object and so we might need</span> <span data-start="920.14" data-end="922.09">to read that in to some sort of binary</span> <span data-start="922.09" data-end="923.1">data type enjoy</span> <span data-start="923.1" data-end="925.68">script then from that we might want to</span> <span data-start="925.68" data-end="927.87">parse out the song's title the album</span> <span data-start="927.87" data-end="929.7">name and some other useful metadata in</span> <span data-start="929.7" data-end="932.34">most mp3s this information is encoded in</span> <span data-start="932.34" data-end="935.01">the beginning of the file it's a format</span> <span data-start="935.01" data-end="937.77">called ID 3 if you're interested in how</span> <span data-start="937.77" data-end="939.3">to parse that data and working with</span> <span data-start="939.3" data-end="941.58">binary data in JavaScript check out the</span> <span data-start="941.58" data-end="945.38">blog post it's bitly slash mp3 — parser</span> <span data-start="945.38" data-end="948.24">now unfortunately id3 metadata doesn't</span> <span data-start="948.24" data-end="952.05">usually include the songs duration so</span> <span data-start="952.05" data-end="953.1">we'll actually need to calculate</span> <span data-start="953.1" data-end="955.02">ourselves and we can do that using the</span> <span data-start="955.02" data-end="958.68">web's audio api and once all that</span> <span data-start="958.68" data-end="960.9">metadata is extracted we're going to</span> <span data-start="960.9" data-end="963.33">auto create a new album in the database</span> <span data-start="963.33" data-end="965.4">if one doesn't already exist by that</span> <span data-start="965.4" data-end="967.41">name and then we'll finally create a new</span> <span data-start="967.41" data-end="969.87">song entry in our music library using</span> <span data-start="969.87" data-end="971.04">all the information from those previous</span> <span data-start="971.04" data-end="974.4">four steps so my first solution when I</span> <span data-start="974.4" data-end="975.99">was coding this up looked roughly like</span> <span data-start="975.99" data-end="978.57">this very much the code corresponds</span> <span data-start="978.57" data-end="980.58">exactly with those steps we read in the</span> <span data-start="980.58" data-end="982.68">file in this case we're reading it in as</span> <span data-start="982.68" data-end="984.42">an array buffer which is JavaScript</span> <span data-start="984.42" data-end="988.35">binary data type and then we parse out</span> </p>
<p><span data-start="988.35" data-end="990.36">ID 3 metadata this is a library of god</span> <span data-start="990.36" data-end="991.98">on github you guys can check out and</span> <span data-start="991.98" data-end="994.05">it's just using a lot of those binary</span> <span data-start="994.05" data-end="997.05">files and then we're calculating the</span> <span data-start="997.05" data-end="999.93">duration using some audio api's in</span> <span data-start="999.93" data-end="1002.53">particular this is audio context and</span> <span data-start="1002.53" data-end="1004.88">then we're creating entries in the</span> <span data-start="1004.88" data-end="1007.1">database for the album and then for the</span> <span data-start="1007.1" data-end="1010.16">song now you'll notice that async and</span> <span data-start="1010.16" data-end="1012.2">await makes this code really nice we've</span> <span data-start="1012.2" data-end="1013.49">got a lot of asynchronous stuff</span> <span data-start="1013.49" data-end="1015.5">happening here and all we have to do is</span> <span data-start="1015.5" data-end="1017.96">put in a weight in front of every line</span> <span data-start="1017.96" data-end="1020.66">that would return a promise this gets</span> <span data-start="1020.66" data-end="1022.25">rid of all the dot then callback so this</span> <span data-start="1022.25" data-end="1024.62">looks really nice there's a problem</span> <span data-start="1024.62" data-end="1027.77">however we're actually blocking too much</span> <span data-start="1027.77" data-end="1030.17">anytime you see a weight just realize</span> <span data-start="1030.17" data-end="1032.12">that no code below that away will</span> <span data-start="1032.12" data-end="1033.95">execute in other words we're kind of</span> <span data-start="1033.95" data-end="1037.22">hamstringing JavaScript's pattern of</span> <span data-start="1037.22" data-end="1039.65">just going line by line by line without</span> <span data-start="1039.65" data-end="1042.44">pausing for a breath so unfortunately</span> <span data-start="1042.44" data-end="1044.54">we're actually forcing more things than</span> <span data-start="1044.54" data-end="1046.4">necessary to execute one after another</span> <span data-start="1046.4" data-end="1049.34">when in reality they could be executing</span> <span data-start="1049.34" data-end="1052.03">in parallel or I should say concurrently</span> <span data-start="1052.03" data-end="1054.59">but if we wanted to execute some of this</span> <span data-start="1054.59" data-end="1056.03">code concurrently you know</span> <span data-start="1056.03" data-end="1057.95">squint at this and try to figure out hmm</span> <span data-start="1057.95" data-end="1059.39">some of these things yeah they can run</span> <span data-start="1059.39" data-end="1062.69">in concurrently but to do that you have</span> <span data-start="1062.69" data-end="1064.94">to sacrifice those really elegant awaits</span> <span data-start="1064.94" data-end="1067.4">here's one way we might do that we could</span> <span data-start="1067.4" data-end="1069.86">use promised doll to block further code</span> <span data-start="1069.86" data-end="1071.84">until the file reader and the parser</span> <span data-start="1071.84" data-end="1074.66">have finished before computing the</span> <span data-start="1074.66" data-end="1077.03">song's duration or importing in album</span> <span data-start="1077.03" data-end="1079.37">not only does this uglify the solution</span> <span data-start="1079.37" data-end="1081.32">quite a bit but more disturbingly it's</span> <span data-start="1081.32" data-end="1084.23">still a suboptimal solution if the file</span> <span data-start="1084.23" data-end="1086.6">reader for example finishes before the</span> <span data-start="1086.6" data-end="1088.94">parser there's no reason the import</span> <span data-start="1088.94" data-end="1091.43">album couldn't already begin doing its</span> <span data-start="1091.43" data-end="1094.37">work the problem is it takes a fair</span> <span data-start="1094.37" data-end="1096.35">amount of work to figure out the optimal</span> <span data-start="1096.35" data-end="1099.35">grouping of which tasks can be run in</span> <span data-start="1099.35" data-end="1102.17">parallel and any time you switch any one</span> <span data-start="1102.17" data-end="1104.66">of these steps from asynchronous API to</span> <span data-start="1104.66" data-end="1108.02">an async one it completely changes that</span> <span data-start="1108.02" data-end="1109.88">optimal solution which means you're</span> <span data-start="1109.88" data-end="1110.87">going to have a lot of code sharing</span> <span data-start="1110.87" data-end="1112.28">you're gonna have very large get discs</span> <span data-start="1112.28" data-end="1115.16">so luckily there's another way that we</span> <span data-start="1115.16" data-end="1117.02">can model these kinds of concurrency</span> <span data-start="1117.02" data-end="1120.41">relationships so what if we modeled each</span> <span data-start="1120.41" data-end="1124.1">chunk of code as a dependency graph for</span> <span data-start="1124.1" data-end="1126.35">the runtime to evaluate just like we did</span> <span data-start="1126.35" data-end="1128.48">with my to-do list for coming to speak</span> <span data-start="1128.48" data-end="1132.2">at J's conf to accomplish this we're</span> <span data-start="1132.2" data-end="1134.06">going to use a pattern called the async</span> <span data-start="1134.06" data-end="1136.04">immediately invoked function expression</span> <span data-start="1136.04" data-end="1138.11">it's an elegant pattern for managing</span> <span data-start="1138.11" data-end="1141.41">concurrency on a single thread now most</span> <span data-start="1141.41" data-end="1142.97">of you have probably already seen async</span> <span data-start="1142.97" data-end="1145.37">functions something to keep in mind is</span> <span data-start="1145.37" data-end="1148.01">that in async function when invoked</span> <span data-start="1148.01" data-end="1150.91">always returns a promise no exception</span> <span data-start="1150.91" data-end="1153.5">even if there's an error it's just</span> <span data-start="1153.5" data-end="1155.75">returns a promise that rejects so the</span> <span data-start="1155.75" data-end="1158.33">return value from an async function</span> <span data-start="1158.33" data-end="1161.54">invoked is always a promise so in async</span> <span data-start="1161.54" data-end="1163.13">if e is just you creating an async</span> <span data-start="1163.13" data-end="1165.53">function an anonymous one and you invoke</span> <span data-start="1165.53" data-end="1169.16">it so the async Afiya allows us to group</span> <span data-start="1169.16" data-end="1171.89">together sequential code into a single</span> <span data-start="1171.89" data-end="1174.11">unit we might call a task and then</span> <span data-start="1174.11" data-end="1176.93">immediately invokes it a task can depend</span> <span data-start="1176.93" data-end="1179.9">on other tasks as a source of input but</span> <span data-start="1179.9" data-end="1183.17">it produces a single return value as its</span> <span data-start="1183.17" data-end="1185.6">output which means that this async if e</span> <span data-start="1185.6" data-end="1187.22">is going to return a promise that</span> <span data-start="1187.22" data-end="1189.08">resolves to the results</span> <span data-start="1189.08" data-end="1191.419">now the task local variable that you see</span> <span data-start="1191.419" data-end="1194.749">is also going to be a promise so if</span> <span data-start="1194.749" data-end="1195.619">there's one thing you should take away</span> <span data-start="1195.619" data-end="1198.08">from this talk it should be the async if</span> <span data-start="1198.08" data-end="1200.45">you design pattern it kind of resembles</span> <span data-start="1200.45" data-end="1205.58">a task in a task runner like a gulp like</span> <span data-start="1205.58" data-end="1206.96">gulp or a makefile</span> <span data-start="1206.96" data-end="1208.879">so if it helps you can think of async</span> <span data-start="1208.879" data-end="1210.23">appeases sort of like those different</span> <span data-start="1210.23" data-end="1213.019">tasks in a task runner now if we</span> <span data-start="1213.019" data-end="1215.21">refactor our mp3 importer code into</span> <span data-start="1215.21" data-end="1217.159">multiple tasks here's one way we might</span> <span data-start="1217.159" data-end="1219.71">break it down so first when we read in</span> <span data-start="1219.71" data-end="1221.69">that file this just returns a promise</span> <span data-start="1221.69" data-end="1223.669">just for naming conventions I might call</span> <span data-start="1223.669" data-end="1226.97">this the read task and then the meta</span> <span data-start="1226.97" data-end="1229.129">task would just run that parsing code</span> <span data-start="1229.129" data-end="1231.529">now you notice in every single one of</span> <span data-start="1231.529" data-end="1234.919">these tasks all these operations depend</span> <span data-start="1234.919" data-end="1237.769">on the very previous line in other words</span> <span data-start="1237.769" data-end="1240.71">there's no line in any of these tasks</span> <span data-start="1240.71" data-end="1243.559">that doesn't depend on everything before</span> <span data-start="1243.559" data-end="1245.419">it we've tried to separate that out into</span> <span data-start="1245.419" data-end="1247.94">these small chunks now each task is an</span> <span data-start="1247.94" data-end="1250.22">async iffy so it returns a promise which</span> <span data-start="1250.22" data-end="1252.919">evaluates to the functions return value</span> <span data-start="1252.919" data-end="1255.649">at the very end the thing that kind of</span> <span data-start="1255.649" data-end="1257.809">kick starts this process is when we're</span> <span data-start="1257.809" data-end="1260.6">awaiting the song import task which is</span> <span data-start="1260.6" data-end="1263.269">sort of the top level task that calls</span> <span data-start="1263.269" data-end="1268.129">all these others so with multiple tasks</span> <span data-start="1268.129" data-end="1269.69">we're just leveraging local variables</span> <span data-start="1269.69" data-end="1271.73">and concurrency by default to</span> <span data-start="1271.73" data-end="1273.23">essentially create a dependency graph</span> <span data-start="1273.23" data-end="1274.759">which the JavaScript runtime will</span> <span data-start="1274.759" data-end="1276.889">optimally evaluate for us no matter how</span> <span data-start="1276.889" data-end="1279.289">complex it is so if we were to break</span> <span data-start="1279.289" data-end="1281.179">these down you could imagine that this</span> <span data-start="1281.179" data-end="1282.98">is the dependency graph that we've just</span> <span data-start="1282.98" data-end="1284.509">modeled but we didn't actually have to</span> <span data-start="1284.509" data-end="1286.309">type this out ourselves we didn't have</span> <span data-start="1286.309" data-end="1288.049">to explicitly define that execution</span> <span data-start="1288.049" data-end="1290.33">order just by wrapping sequential chunks</span> <span data-start="1290.33" data-end="1292.609">of code into a sink if ease we modeled</span> <span data-start="1292.609" data-end="1294.289">the constraints and let JavaScript</span> <span data-start="1294.289" data-end="1296.809">figure out how to satisfy those</span> <span data-start="1296.809" data-end="1299.869">constraints again there's tons more to</span> <span data-start="1299.869" data-end="1301.46">the async if you pattern so definitely</span> <span data-start="1301.46" data-end="1302.809">check out this blog post to learn more</span> <span data-start="1302.809" data-end="1307.82">bitly slash async — if II leave that up</span> <span data-start="1307.82" data-end="1311.48">just for a moment so our second step to</span> <span data-start="1311.48" data-end="1313.759">creating elegant scalable code is to</span> <span data-start="1313.759" data-end="1316.549">define execution preferences async</span> <span data-start="1316.549" data-end="1318.019">ephese allow us to define those</span> <span data-start="1318.019" data-end="1320.21">constraints how things have to execute</span> <span data-start="1320.21" data-end="1322.31">but a lot of times you</span> <span data-start="1322.31" data-end="1325.01">to say how would we like these things to</span> <span data-start="1325.01" data-end="1326.27">be executed how would we like to</span> <span data-start="1326.27" data-end="1328.76">prioritize them in particular how could</span> <span data-start="1328.76" data-end="1330.56">we throttle how many things are allowed</span> <span data-start="1330.56" data-end="1332.84">to run concurrently with functional</span> <span data-start="1332.84" data-end="1335.21">programming so our mp3 importer right</span> <span data-start="1335.21" data-end="1337.1">now runs as fast as possible which is</span> <span data-start="1337.1" data-end="1337.76">fabulous</span> <span data-start="1337.76" data-end="1339.77">but this is a browser so we need to be</span> <span data-start="1339.77" data-end="1341.75">considerate of the CPU which is after</span> <span data-start="1341.75" data-end="1345.11">all a limited resource so a syncope has</span> <span data-start="1345.11" data-end="1346.37">led us to find those execution</span> <span data-start="1346.37" data-end="1348.92">constraints how could we declaratively</span> <span data-start="1348.92" data-end="1351.83">define our preferences for how that work</span> <span data-start="1351.83" data-end="1354.5">gets executed on the CPU for example in</span> <span data-start="1354.5" data-end="1356.6">our application if a user drops in a</span> <span data-start="1356.6" data-end="1360.73">very large collection of mp3s by default</span> <span data-start="1360.73" data-end="1363.53">we might either import all these songs</span> <span data-start="1363.53" data-end="1366.11">one by one which is not so cool or we</span> <span data-start="1366.11" data-end="1369.2">might import them all at once now your</span> <span data-start="1369.2" data-end="1370.76">solution is great in particular if we</span> <span data-start="1370.76" data-end="1372.47">started importing all of them at once</span> <span data-start="1372.47" data-end="1374.15">we might get this really irritating</span> <span data-start="1374.15" data-end="1376.88">progress bar behavior like this where it</span> <span data-start="1376.88" data-end="1378.74">jumps from oh I'm importing the first</span> <span data-start="1378.74" data-end="1381.8">one and then 20 seconds later it jumps</span> <span data-start="1381.8" data-end="1383.75">all the way to the hand since all those</span> <span data-start="1383.75" data-end="1385.49">songs started importing at the same time</span> <span data-start="1385.49" data-end="1386.81">the progress bar is basically</span> <span data-start="1386.81" data-end="1388.91">meaningless to the user and it will</span> <span data-start="1388.91" data-end="1391.27">often lock up the browser also not great</span> <span data-start="1391.27" data-end="1394.4">so instead what if we said well we only</span> <span data-start="1394.4" data-end="1396.86">want to import a few songs at a time and</span> <span data-start="1396.86" data-end="1398.75">then we'll queue up the others for</span> <span data-start="1398.75" data-end="1400.91">import once another song finishes</span> <span data-start="1400.91" data-end="1403.76">importing so only importing a few at a</span> <span data-start="1403.76" data-end="1409.07">time so in many threaded languages you</span> <span data-start="1409.07" data-end="1411.14">can accomplish something like this with</span> <span data-start="1411.14" data-end="1414.17">semaphores semaphores are an object that</span> <span data-start="1414.17" data-end="1417.32">represent a limited resource and you can</span> <span data-start="1417.32" data-end="1421.1">acquire and release access to it to</span> <span data-start="1421.1" data-end="1423.74">basically throttle how many times or how</span> <span data-start="1423.74" data-end="1424.82">many people are trying to use that</span> <span data-start="1424.82" data-end="1428.6">semaphore so for example the CPU is an</span> <span data-start="1428.6" data-end="1430.01">example of something a semaphore might</span> <span data-start="1430.01" data-end="1432.02">represent it could be a database or even</span> <span data-start="1432.02" data-end="1435.26">network i/o at their extreme we could</span> <span data-start="1435.26" data-end="1437.09">limit it to one client at a time which</span> <span data-start="1437.09" data-end="1439.37">we would call a mutex now in an</span> <span data-start="1439.37" data-end="1440.96">object-oriented paradigm we could</span> <span data-start="1440.96" data-end="1442.94">initialize a semaphore object with the</span> <span data-start="1442.94" data-end="1445.04">maximum number of concurrent clients and</span> <span data-start="1445.04" data-end="1447.8">use a wait to acquire a spot in the</span> <span data-start="1447.8" data-end="1449.63">queue before we execute our code and</span> <span data-start="1449.63" data-end="1451.76">then once a spot opens up we do some</span> <span data-start="1451.76" data-end="1452.45">things</span> <span data-start="1452.45" data-end="1454.97">and we release our spot so another</span> <span data-start="1454.97" data-end="1458.63">client can execute some code so here's a</span> <span data-start="1458.63" data-end="1460.91">sample object-oriented solution to</span> <span data-start="1460.91" data-end="1463.01">creating a semaphore and it just tracks</span> <span data-start="1463.01" data-end="1464.3">functions that are waiting to be</span> <span data-start="1464.3" data-end="1466.88">executed and whenever a spot opens up it</span> <span data-start="1466.88" data-end="1468.41">executes the next function in the queue</span> <span data-start="1468.41" data-end="1474.59">so this is very standard cs20 101 type</span> <span data-start="1474.59" data-end="1476">solution you would probably write for</span> <span data-start="1476" data-end="1478.55">semaphore unfortunately there's some</span> <span data-start="1478.55" data-end="1480.23">really brittle boilerplate with an</span> <span data-start="1480.23" data-end="1481.84">object-oriented solution for a semaphore</span> <span data-start="1481.84" data-end="1484.49">in particular we could easily write code</span> <span data-start="1484.49" data-end="1487.16">that will acquire a semaphore but never</span> <span data-start="1487.16" data-end="1488.03">release it</span> <span data-start="1488.03" data-end="1489.86">perhaps we throw an exception which will</span> <span data-start="1489.86" data-end="1491.69">blow up the rest of the function so now</span> <span data-start="1491.69" data-end="1494.32">that some before will never be released</span> <span data-start="1494.32" data-end="1497.42">so instead here's a functional</span> <span data-start="1497.42" data-end="1498.89">programming version of that same</span> <span data-start="1498.89" data-end="1500.66">semaphore and instead of returning an</span> <span data-start="1500.66" data-end="1502.64">object it's going to return a</span> <span data-start="1502.64" data-end="1505.22">higher-order function that wraps up</span> <span data-start="1505.22" data-end="1507.14">other functions with a call to acquire</span> <span data-start="1507.14" data-end="1508.97">and release so you can almost think of</span> <span data-start="1508.97" data-end="1511.34">it as it I can take any function and</span> </p>
<p><span data-start="1511.34" data-end="1514.18">I'll prepend it with a choir and then</span> <span data-start="1514.18" data-end="1518.81">suffix it with dot release so use this</span> <span data-start="1518.81" data-end="1520.46">functional sum before we can invoke it</span> <span data-start="1520.46" data-end="1522.59">with an async function now there's no</span> <span data-start="1522.59" data-end="1525.26">way a semaphore can be acquired but not</span> <span data-start="1525.26" data-end="1527.96">released now we're actually only one</span> <span data-start="1527.96" data-end="1529.28">step away from turning this into a</span> <span data-start="1529.28" data-end="1530.96">really elegant higher-order function</span> <span data-start="1530.96" data-end="1533">that doesn't even force us to think</span> <span data-start="1533" data-end="1535.4">about semaphores at all so let's suppose</span> <span data-start="1535.4" data-end="1537.68">that we want to limit how many times our</span> <span data-start="1537.68" data-end="1541.25">import mp3 function is called and we</span> <span data-start="1541.25" data-end="1543.14">want to limit how many times it can be</span> <span data-start="1543.14" data-end="1545.27">run concurrently so in other words if</span> <span data-start="1545.27" data-end="1548.27">you call import mp3 four times right</span> <span data-start="1548.27" data-end="1550.25">after each other say we only want to</span> <span data-start="1550.25" data-end="1552.47">allow two instances of that function to</span> <span data-start="1552.47" data-end="1555.62">run at a time and then it would delay</span> <span data-start="1555.62" data-end="1557.93">the third and fourth invocations until</span> <span data-start="1557.93" data-end="1560.21">there's a slot left until one of those</span> <span data-start="1560.21" data-end="1563.06">first two invocations is finished so we</span> <span data-start="1563.06" data-end="1564.77">could think of this function we might</span> <span data-start="1564.77" data-end="1566.87">call it limit we could think of it as a</span> <span data-start="1566.87" data-end="1568.85">decorator or higher-order function and</span> <span data-start="1568.85" data-end="1571.37">it takes an async function that usually</span> <span data-start="1571.37" data-end="1574.13">runs with unlimited concurrency and it</span> <span data-start="1574.13" data-end="1575.57">returns the same function but now</span> <span data-start="1575.57" data-end="1577.91">composed with throttling behavior so</span> <span data-start="1577.91" data-end="1579.95">this example would take our mp3 importer</span> <span data-start="1579.95" data-end="1581.81">function and return a new function that</span> <span data-start="1581.81" data-end="1584.57">looks exactly the same but only allows</span> <span data-start="1584.57" data-end="1585.69">two instances</span> <span data-start="1585.69" data-end="1588.42">function to run concurrently so in this</span> <span data-start="1588.42" data-end="1591.09">example song 1 and song 2 will</span> <span data-start="1591.09" data-end="1593.97">immediately begin importing but song 3</span> <span data-start="1593.97" data-end="1595.95">won't even begin importing until song 1</span> <span data-start="1595.95" data-end="1598.26">or song 2 finishes meaning there's a</span> <span data-start="1598.26" data-end="1601.65">slot in the semaphore the limit function</span> <span data-start="1601.65" data-end="1603.48">it turns out is really easy to write</span> <span data-start="1603.48" data-end="1605.04">with a semaphore we built it's just</span> <span data-start="1605.04" data-end="1607.26">three or four lines of code but the key</span> <span data-start="1607.26" data-end="1608.97">takeaway from this is that instead of</span> <span data-start="1608.97" data-end="1611.58">focusing now on managing this abstract</span> <span data-start="1611.58" data-end="1614.13">semaphore object we're focusing on</span> <span data-start="1614.13" data-end="1616.77">creating functions with new throttling</span> <span data-start="1616.77" data-end="1618.57">behavior it's really elegant and cuts</span> <span data-start="1618.57" data-end="1620.52">down on potential bugs from trying to</span> <span data-start="1620.52" data-end="1622.29">share a similar object throughout your</span> <span data-start="1622.29" data-end="1624.9">codebase and it preserves your existing</span> </p>
<p><span data-start="1624.9" data-end="1627.21">API so that way if you want to throttle</span> <span data-start="1627.21" data-end="1629.1">concurrency in your codebase you don't</span> <span data-start="1629.1" data-end="1630.96">have to refactor your code or change any</span> <span data-start="1630.96" data-end="1633.93">of your api's again there's a whole lot</span> <span data-start="1633.93" data-end="1635.7">more we could dive into here so feel</span> <span data-start="1635.7" data-end="1637.11">free to check out the source code in</span> <span data-start="1637.11" data-end="1639.33">particular for the semaphore if you want</span> <span data-start="1639.33" data-end="1640.86">to play around without a bit on github</span> <span data-start="1640.86" data-end="1644.54">but the final component of this talk is</span> <span data-start="1644.54" data-end="1647.64">how can we create our own long-lived</span> <span data-start="1647.64" data-end="1651.45">async tasks with a web worker cluster so</span> <span data-start="1651.45" data-end="1652.23">what do I mean by this</span> <span data-start="1652.23" data-end="1654.09">so the browser comes with a huge</span> <span data-start="1654.09" data-end="1656.34">selection of async api's that we use all</span> <span data-start="1656.34" data-end="1656.91">the time</span> <span data-start="1656.91" data-end="1659.31">these api's are natively implemented</span> <span data-start="1659.31" data-end="1661.44">there's not JavaScript code behind in</span> </p>
<p><span data-start="1661.44" data-end="1664.2">Ajax requests so for example the fetch</span> <span data-start="1664.2" data-end="1666.78">on index DB abis are all natively</span> <span data-start="1666.78" data-end="1669.36">implemented and they use promises and</span> <span data-start="1669.36" data-end="1670.83">other asynchronous mechanisms like</span> <span data-start="1670.83" data-end="1673.8">callbacks now under the hood the browser</span> <span data-start="1673.8" data-end="1675.93">handles this by managing a dedicated</span> <span data-start="1675.93" data-end="1678.09">thread pool that's ready to crunch those</span> <span data-start="1678.09" data-end="1680.94">async api's for you whenever you try to</span> <span data-start="1680.94" data-end="1684.3">use one of these async api's but what if</span> <span data-start="1684.3" data-end="1686.25">you could create your own how would you</span> <span data-start="1686.25" data-end="1688.74">create your own native async api's for</span> <span data-start="1688.74" data-end="1691.05">your own long-lived async operations</span> <span data-start="1691.05" data-end="1693">that maybe they take up a lot of time</span> <span data-start="1693" data-end="1694.44">and you don't want to block the main</span> <span data-start="1694.44" data-end="1694.77">thread</span> <span data-start="1694.77" data-end="1696.99">for example maybe we want to move our</span> <span data-start="1696.99" data-end="1699.57">mp3 importer off the main thread which</span> <span data-start="1699.57" data-end="1702.3">is also rendering the UI maybe we want</span> <span data-start="1702.3" data-end="1704.4">to move it to the background so that way</span> <span data-start="1704.4" data-end="1706.71">it won't lock up the UI if it takes a</span> <span data-start="1706.71" data-end="1708.66">particularly long time to import some of</span> <span data-start="1708.66" data-end="1709.32">these mp3s</span> <span data-start="1709.32" data-end="1711.63">well web workers are essentially that</span> <span data-start="1711.63" data-end="1714.18">there are standard web api for creating</span> <span data-start="1714.18" data-end="1716.76">background threads so to create a web</span> <span data-start="1716.76" data-end="1718.68">worker we just invoke the worker</span> <span data-start="1718.68" data-end="1719.32">construct</span> <span data-start="1719.32" data-end="1721.21">and give it the path to the JavaScript</span> <span data-start="1721.21" data-end="1722.71">code that will execute with its own</span> <span data-start="1722.71" data-end="1725.2">dedicated scope and with its own event</span> <span data-start="1725.2" data-end="1727.15">loop it's completely isolated from your</span> <span data-start="1727.15" data-end="1729.4">main thread now to communicate with a</span> <span data-start="1729.4" data-end="1732.1">worker you can only exchange messages</span> <span data-start="1732.1" data-end="1734.35">this is a really important concept those</span> <span data-start="1734.35" data-end="1736.51">of you have maybe tried elixir or some</span> <span data-start="1736.51" data-end="1738.31">of these high concurrency high fault</span> <span data-start="1738.31" data-end="1739.69">tolerance type languages are probably</span> <span data-start="1739.69" data-end="1741.4">already familiar with this concept of</span> <span data-start="1741.4" data-end="1744.01">exchanging messages basically it means</span> <span data-start="1744.01" data-end="1746.08">the worker must be listening for that</span> <span data-start="1746.08" data-end="1748.24">message and handle it as part of its own</span> <span data-start="1748.24" data-end="1750.88">event loop cycle so in other words</span> <span data-start="1750.88" data-end="1754.03">messages are received asynchronously now</span> <span data-start="1754.03" data-end="1755.59">the main thread and the worker thread</span> <span data-start="1755.59" data-end="1757.99">don't have to both block to exchange</span> <span data-start="1757.99" data-end="1759.76">that message they just send and check</span> <span data-start="1759.76" data-end="1761.37">for messages whenever they're ready to</span> <span data-start="1761.37" data-end="1763.87">now the basic web worker API is not</span> <span data-start="1763.87" data-end="1766.15">exceptionally elegant if you want to</span> <span data-start="1766.15" data-end="1767.83">have a two-way conversation between the</span> <span data-start="1767.83" data-end="1769.27">worker main thread it can really quickly</span> <span data-start="1769.27" data-end="1771.84">turn into this really ugly callbacks OOP</span> <span data-start="1771.84" data-end="1774.61">so what if web workers looked more like</span> <span data-start="1774.61" data-end="1777.76">an async web api call where we invoke it</span> <span data-start="1777.76" data-end="1779.71">and we get a promise in return that</span> <span data-start="1779.71" data-end="1783.13">resolves to the workers end result that</span> <span data-start="1783.13" data-end="1785.05">would make it really trivial to move CPU</span> <span data-start="1785.05" data-end="1787.24">intensive computations to a separate</span> <span data-start="1787.24" data-end="1789.04">thread so we don't end up walking the</span> <span data-start="1789.04" data-end="1790.6">main thread so you can imagine there's</span> <span data-start="1790.6" data-end="1792.46">probably a lot of use cases for this up</span> <span data-start="1792.46" data-end="1794.41">until cryptography was added to the</span> <span data-start="1794.41" data-end="1796.21">browser standards cryptography would</span> <span data-start="1796.21" data-end="1798.28">have been a really common use case same</span> <span data-start="1798.28" data-end="1800.56">for doing any sort of 3d graphics maybe</span> <span data-start="1800.56" data-end="1802.6">game rendering maybe you'd like to move</span> <span data-start="1802.6" data-end="1804.01">these to the background off the main</span> <span data-start="1804.01" data-end="1805.6">thread but you don't have to completely</span> <span data-start="1805.6" data-end="1807.73">rewrite your code base to take advantage</span> <span data-start="1807.73" data-end="1811.36">of it so in particular we're going to</span> <span data-start="1811.36" data-end="1813.31">take our mp3 importer and move it into a</span> <span data-start="1813.31" data-end="1815.38">worker and treat it as though it were a</span> <span data-start="1815.38" data-end="1818.95">natively implemented async web api to do</span> <span data-start="1818.95" data-end="1819.97">this we're going to create this</span> <span data-start="1819.97" data-end="1822.16">mysterious cluster function to make the</span> <span data-start="1822.16" data-end="1824.08">web worker API a little bit more elegant</span> <span data-start="1824.08" data-end="1826.78">for our use case and cluster is just</span> <span data-start="1826.78" data-end="1829.24">going to spin up a bunch of web workers</span> <span data-start="1829.24" data-end="1832.39">in the background for us and these web</span> <span data-start="1832.39" data-end="1834.16">workers will handle the task of</span> <span data-start="1834.16" data-end="1836.38">importing mp3s so a functional</span> <span data-start="1836.38" data-end="1837.67">programming the implementation for this</span> <span data-start="1837.67" data-end="1840.16">cluster is actually really terse so this</span> <span data-start="1840.16" data-end="1841.87">code has a lot of stuff at the beginning</span> <span data-start="1841.87" data-end="1843.64">basically it figures out what's the best</span> <span data-start="1843.64" data-end="1845.53">number of web workers to use usually</span> <span data-start="1845.53" data-end="1848.43">that's how many virtual cores you have</span> <span data-start="1848.43" data-end="1851.32">so it creates these different workers</span> <span data-start="1851.32" data-end="1852.07">and it put</span> <span data-start="1852.07" data-end="1853.66">some in an array to keep track of it's</span> <span data-start="1853.66" data-end="1855.34">basically a pool of workers and each</span> <span data-start="1855.34" data-end="1858.43">time we try to invoke that cluster it</span> <span data-start="1858.43" data-end="1860.2">grabs a worker from the pool that's</span> <span data-start="1860.2" data-end="1862.21">currently unused and it forwards along</span> <span data-start="1862.21" data-end="1864.16">some data so this would be us invoking</span> <span data-start="1864.16" data-end="1865.84">cluster we pass some argument those</span> <span data-start="1865.84" data-end="1867.61">arguments get forwarded to the worker</span> <span data-start="1867.61" data-end="1870.4">once the worker finishes and replies</span> <span data-start="1870.4" data-end="1871.48">with the result</span> <span data-start="1871.48" data-end="1874.15">it adds itself back to the pool to say</span> <span data-start="1874.15" data-end="1875.38">hey I'm not currently working on</span> <span data-start="1875.38" data-end="1877.03">anything you can use me for a different</span> <span data-start="1877.03" data-end="1879.49">computation and the overall promise will</span> <span data-start="1879.49" data-end="1882.76">evaluate to that result the code for the</span> <span data-start="1882.76" data-end="1885.67">web worker itself is really short it's</span> <span data-start="1885.67" data-end="1887.59">an infinite loop that just receives data</span> <span data-start="1887.59" data-end="1889.36">from the main thread it does some work</span> <span data-start="1889.36" data-end="1891.13">and then it notifies the main thread</span> <span data-start="1891.13" data-end="1893.53">when it's done with that computation by</span> <span data-start="1893.53" data-end="1894.97">the way this isn't just for the browser</span> <span data-start="1894.97" data-end="1898.12">you can use a popular facade library to</span> <span data-start="1898.12" data-end="1900.52">write web workers in node as well with</span> <span data-start="1900.52" data-end="1902.65">the same API and under the hood it uses</span> <span data-start="1902.65" data-end="1904.51">native multi-threading so this isn't</span> <span data-start="1904.51" data-end="1907">just for the front-end browser so you</span> <span data-start="1907" data-end="1909.97">could imagine moving all kinds of CPU</span> <span data-start="1909.97" data-end="1912.61">intensive operations with just a few</span> <span data-start="1912.61" data-end="1913.99">lines of code you can actually get with</span> <span data-start="1913.99" data-end="1915.61">fewer than this if you write a little</span> <span data-start="1915.61" data-end="1917.62">utility function you can imagine moving</span> <span data-start="1917.62" data-end="1920.65">all of these into web workers so a</span> <span data-start="1920.65" data-end="1923.14">little bit long time so the TLDR from</span> <span data-start="1923.14" data-end="1924.79">this really is that javascript in the</span> <span data-start="1924.79" data-end="1927.85">browser and node.js is highly concurrent</span> <span data-start="1927.85" data-end="1930.28">out-of-the-box so things like async</span> <span data-start="1930.28" data-end="1932.14">appease can help us define those</span> <span data-start="1932.14" data-end="1935.26">execution constraints thanks to the</span> <span data-start="1935.26" data-end="1936.61">event loop we don't have to even worry</span> <span data-start="1936.61" data-end="1938.83">about thread safety or re-entrance e or</span> <span data-start="1938.83" data-end="1940.09">a lot of these other things you might be</span> <span data-start="1940.09" data-end="1942.13">familiar with with language like C or</span> </p>
<p><span data-start="1942.13" data-end="1944.89">Java and functional programming patterns</span> <span data-start="1944.89" data-end="1946.66">keep us from making a mess of things</span> <span data-start="1946.66" data-end="1948.58">just for the sake of that threading it</span> <span data-start="1948.58" data-end="1950.38">all happens pretty seamlessly for us and</span> <span data-start="1950.38" data-end="1952.78">if there isn't an async Web API for</span> <span data-start="1952.78" data-end="1955.42">something you need maybe its 3d graphics</span> <span data-start="1955.42" data-end="1957.55">related or cryptography related just</span> <span data-start="1957.55" data-end="1959.47">write your own web worker and treat it</span> <span data-start="1959.47" data-end="1961.18">like a native async web api</span> <span data-start="1961.18" data-end="1963.58">so next time you're told just remember</span> <span data-start="1963.58" data-end="1965.74">you can always bet on JavaScript to help</span> <span data-start="1965.74" data-end="1967.51">you leverage multi-core machines and</span> <span data-start="1967.51" data-end="1969.43">crunch there to do loops through to-do</span> <span data-start="1969.43" data-end="1971.77">lists so you won't soak your favorite</span> <span data-start="1971.77" data-end="1982.7">book in the shower like I did so</span> <span data-start="1982.71" data-end="1985.29">my timeshare on this room CPU is up so</span> <span data-start="1985.29" data-end="1986.91">if you like pretty pictures and travel</span> <span data-start="1986.91" data-end="1988.38">stories you can hop to my landscape</span> <span data-start="1988.38" data-end="1991.41">photography site yellow scale.com or you</span> <span data-start="1991.41" data-end="1993.63">can find me on twitter as at nibbler</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
