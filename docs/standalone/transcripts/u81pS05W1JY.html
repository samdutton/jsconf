<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="JSConf transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>u81pS05W1JY</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/u81pS05W1JY?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="10.87" data-end="13.45">so my name is thomas yang Chuck I work</span> <span data-start="13.45" data-end="16.39">for of zero with gum tow and during this</span> <span data-start="16.39" data-end="17.98">session will be talking about sin boxing</span> <span data-start="17.98" data-end="22.59">no dress code in multi-channel systems</span> <span data-start="22.59" data-end="25.869">so why would you even think about sin</span> <span data-start="25.869" data-end="27.82">boxing no dress code many multi-tenant</span> <span data-start="27.82" data-end="31">systems enable extensibility by allowing</span> <span data-start="31" data-end="33.64">users to write custom code that is then</span> <span data-start="33.64" data-end="35.53">running as part of the platform and</span> <span data-start="35.53" data-end="37.3">since you since you know very little</span> <span data-start="37.3" data-end="38.829">about what that code does and how it</span> <span data-start="38.829" data-end="40.989">behaves you cannot fully trust it so</span> <span data-start="40.989" data-end="42.55">that's why you need a sandbox to run it</span> <span data-start="42.55" data-end="46.239">in he not 0 we are offering identity as</span> <span data-start="46.239" data-end="48.19">a service and as part of the</span> <span data-start="48.19" data-end="49.809">authentication pipeline we allow people</span> <span data-start="49.809" data-end="52.6">to provide custom nodejs code that we</span> <span data-start="52.6" data-end="54.1">are executing as part of every</span> <span data-start="54.1" data-end="56.14">authentication transaction people can</span> <span data-start="56.14" data-end="58.179">basically customize the behavior the</span> <span data-start="58.179" data-end="60.1">authentication behavior for their</span> <span data-start="60.1" data-end="63.579">applications and users that way however</span> <span data-start="63.579" data-end="65.92">given that we don't have full control</span> <span data-start="65.92" data-end="68.44">over what that code can do we need a</span> <span data-start="68.44" data-end="73.659">sandbox to run that code in all custom</span> <span data-start="73.659" data-end="77.02">code in ode 0 right runs in the context</span> <span data-start="77.02" data-end="79.66">of an HTTP request so basically the code</span> <span data-start="79.66" data-end="82.12">must execute fully within the lifetime</span> <span data-start="82.12" data-end="83.74">for a single HTTP request which is the</span> <span data-start="83.74" data-end="85">like a time span of a single</span> <span data-start="85" data-end="87.94">authentication transaction given that</span> <span data-start="87.94" data-end="90.16">the sandbox model that we required also</span> <span data-start="90.16" data-end="92.77">was based on HTTP basically you were</span> <span data-start="92.77" data-end="95.08">sending an HTTP POST request to the</span> <span data-start="95.08" data-end="97.42">sandbox the body of the HTTP POST</span> <span data-start="97.42" data-end="99.46">request contains the node.js code to</span> <span data-start="99.46" data-end="102.49">execute the sandbox runs dovecote and</span> <span data-start="102.49" data-end="104.05">when the result is available it sends it</span> <span data-start="104.05" data-end="106.66">back to the color is Jason object in the</span> </p>
<p><span data-start="106.66" data-end="109.57">HTTP response so this is a very basic</span> <span data-start="109.57" data-end="112.63">sandbox model the program programming</span> <span data-start="112.63" data-end="114.25">model around that we have created is</span> <span data-start="114.25" data-end="116.35">also very simple you're basically</span> <span data-start="116.35" data-end="120.21">writing a node.js code that returns</span> <span data-start="120.21" data-end="123.88">javascript function closure that</span> <span data-start="123.88" data-end="125.41">function accepts a single callback</span> <span data-start="125.41" data-end="127.06">parameter when you're done executing</span> <span data-start="127.06" data-end="128.83">your code you're supposed to return the</span> <span data-start="128.83" data-end="131.89">result value to that callback that</span> <span data-start="131.89" data-end="133.9">result is then civilized into Jason and</span> <span data-start="133.9" data-end="137.26">returning to the color what kind of</span> <span data-start="137.26" data-end="139.15">properties that we require out of that</span> <span data-start="139.15" data-end="141.489">sandbox so first and foremost we require</span> <span data-start="141.489" data-end="144.34">data isolation if we r XZ</span> <span data-start="144.34" data-end="146.47">getting code of one tenant we expect</span> <span data-start="146.47" data-end="149.47">that code to be unable to affect</span> <span data-start="149.47" data-end="151.569">execution of code from other tenants in</span> <span data-start="151.569" data-end="153.37">any way or from accessing data of other</span> <span data-start="153.37" data-end="154.93">tenants so this is the kind of primary</span> <span data-start="154.93" data-end="158.319">security requirement that we had in</span> <span data-start="158.319" data-end="160.15">addition to that we also had a number of</span> <span data-start="160.15" data-end="163.33">resource governance requirements around</span> <span data-start="163.33" data-end="165.879">how memory CPU and networking is</span> <span data-start="165.879" data-end="168.849">allocated we wanted to prevent one</span> <span data-start="168.849" data-end="171.43">tenant from executing an authenticated</span> <span data-start="171.43" data-end="173.47">us attack against resources of our</span> <span data-start="173.47" data-end="176.38">sandbox that would prevent other tenants</span> <span data-start="176.38" data-end="179.44">from running code in the same time in</span> <span data-start="179.44" data-end="184.959">that sandbox so the very high level we</span> <span data-start="184.959" data-end="186.069">basically looked at what is available</span> <span data-start="186.069" data-end="187.989">out there in terms of sandbox in node.js</span> <span data-start="187.989" data-end="189.879">code and none of the of the shelf</span> <span data-start="189.879" data-end="192.61">components were meeting our requirement</span> <span data-start="192.61" data-end="195.31">so we decided to build our own high</span> <span data-start="195.31" data-end="197.41">level our sandbox is built on core OS</span> <span data-start="197.41" data-end="200.47">dockery tcd and fleet which is a great</span> <span data-start="200.47" data-end="203.349">set of technologies that help you write</span> <span data-start="203.349" data-end="205.69">container based distributed applications</span> <span data-start="205.69" data-end="208.54">however in themselves these technologies</span> <span data-start="208.54" data-end="210.19">are insufficient to provide the kind of</span> <span data-start="210.19" data-end="211.9">security guarantees we expected around</span> <span data-start="211.9" data-end="214.6">the sandbox so he had to enhance the</span> <span data-start="214.6" data-end="217.329">basic setup of chorus and docker with</span> <span data-start="217.329" data-end="220.48">additional sandboxing mechanisms so this</span> <span data-start="220.48" data-end="222.88">is the view of a single VM in a core OS</span> <span data-start="222.88" data-end="226.42">cluster that runs our sandbox the</span> <span data-start="226.42" data-end="228.19">primary mechanism by which we ensure</span> <span data-start="228.19" data-end="230.28">data isolation between tenants is</span> <span data-start="230.28" data-end="233.65">running every tenants code in their own</span> <span data-start="233.65" data-end="238.03">docker container in addition to that we</span> <span data-start="238.03" data-end="239.95">are creating an egress firewall around</span> <span data-start="239.95" data-end="241.87">that docker container so that the code</span> <span data-start="241.87" data-end="243.849">running in that container can only talk</span> <span data-start="243.849" data-end="247.06">to the public Internet it cannot talk to</span> <span data-start="247.06" data-end="248.98">other two endpoints exposed by other</span> <span data-start="248.98" data-end="250.81">docker containers running on behalf of</span> <span data-start="250.81" data-end="254.29">other tenants or two endpoints exposed</span> <span data-start="254.29" data-end="256.419">by our sandbox infrastructure like the</span> <span data-start="256.419" data-end="259.18">proxy the controller or etcd running on</span> <span data-start="259.18" data-end="262.27">that box so the way the system functions</span> <span data-start="262.27" data-end="264.099">is that when that HTTP POST request</span> <span data-start="264.099" data-end="266.2">containing the code to execute arrives</span> <span data-start="266.2" data-end="269.229">on the box it is first landing at the</span> <span data-start="269.229" data-end="271.99">proxy component the proxy consults etcd</span> <span data-start="271.99" data-end="273.669">which is a distributed configuration</span> <span data-start="273.669" data-end="275.87">system like zookeeper</span> <span data-start="275.87" data-end="278.27">to see if a container associated to the</span> <span data-start="278.27" data-end="280.1">particular tenant is already running if</span> <span data-start="280.1" data-end="282.76">it is that request is then reverse proxy</span> <span data-start="282.76" data-end="285.56">to that existing container if the</span> <span data-start="285.56" data-end="287.27">container doesn't exist in the proxy</span> <span data-start="287.27" data-end="289.25">will create a new one associated with a</span> <span data-start="289.25" data-end="292.22">tenant a creator registration etcd for</span> <span data-start="292.22" data-end="296.09">future requests and reverse proxy the</span> <span data-start="296.09" data-end="300.51">request to the newly created component</span> <span data-start="300.52" data-end="306.38">in terms of preventing authenticated us</span> <span data-start="306.38" data-end="308.29">attacks against memory CPU and other</span> <span data-start="308.29" data-end="310.46">operating system resources you are using</span> <span data-start="310.46" data-end="312.26">a number of mechanisms first and</span> <span data-start="312.26" data-end="314.87">foremost we are leveraging limits</span> <span data-start="314.87" data-end="317.39">imposed the see groups level so see</span> <span data-start="317.39" data-end="319.4">groups is a Linux mechanism that docker</span> <span data-start="319.4" data-end="329.21">also exposes that wasn't me the doctor</span> <span data-start="329.21" data-end="331.49">also expose issue which which unable to</span> <span data-start="331.49" data-end="333.38">put limits on the memory and CPU</span> <span data-start="333.38" data-end="335.15">consumption of individual docking docker</span> <span data-start="335.15" data-end="337.97">containers in addition to that within</span> <span data-start="337.97" data-end="340.67">the sandbox containers themselves we are</span> <span data-start="340.67" data-end="342.56">creating transient users basically</span> <span data-start="342.56" data-end="344.03">whenever we spin up a new docker</span> <span data-start="344.03" data-end="345.65">container we are creating a brand new</span> <span data-start="345.65" data-end="348.44">operating system user and then we are</span> <span data-start="348.44" data-end="350.63">imposing pam limits for that user so for</span> <span data-start="350.63" data-end="352.52">example you are saying that user cannot</span> <span data-start="352.52" data-end="356.09">create more than 50 processes or threads</span> <span data-start="356.09" data-end="360.23">or he cannot create more than 5000 files</span> <span data-start="360.23" data-end="362.51">in the file system so this provides us</span> <span data-start="362.51" data-end="365.51">with the very basic mechanisms to limit</span> <span data-start="365.51" data-end="367.22">what the code running in the sandbox</span> <span data-start="367.22" data-end="370.85">container can do so with that I want to</span> <span data-start="370.85" data-end="373.04">do a few demos and take our sandbox for</span> <span data-start="373.04" data-end="376.43">a spin you have seen one map during the</span> </p>
<p><span data-start="376.43" data-end="379.55">RabbitMQ presentation and I just</span> <span data-start="379.55" data-end="380.96">couldn't resist I'll show you another</span> <span data-start="380.96" data-end="384.05">one we also have a map about ours with</span> <span data-start="384.05" data-end="386.78">more dots on it so what we are seeing</span> <span data-start="386.78" data-end="390.32">here is basically eight places around</span> <span data-start="390.32" data-end="391.73">the world where we have deployed our</span> <span data-start="391.73" data-end="393.3">sandbox</span> <span data-start="393.3" data-end="395.669">cluster so each of these places can</span> <span data-start="395.669" data-end="398.159">execute custom code on our behalf during</span> <span data-start="398.159" data-end="399.93">this demo I'm going to use the one that</span> <span data-start="399.93" data-end="401.94">is just around the corner in Sao Paulo</span> <span data-start="401.94" data-end="405.03">in Brazil just because it is the closest</span> <span data-start="405.03" data-end="407.879">one latency wise so with that let's have</span> <span data-start="407.879" data-end="411.15">a look at some code so this is the very</span> <span data-start="411.15" data-end="413.699">basic hello world example we are</span> <span data-start="413.699" data-end="415.919">creating a JavaScript function that</span> <span data-start="415.919" data-end="417.72">accepts a call back in immediately turns</span> <span data-start="417.72" data-end="419.19">around and codes are called back with a</span> <span data-start="419.19" data-end="420.93">simple string as a result and that</span> <span data-start="420.93" data-end="424.08">string is pretty much saying hello from</span> </p>
<p><span data-start="424.08" data-end="427.409">Las Vegas and it's offending the version</span> <span data-start="427.409" data-end="430.169">of node.js to it so the way you run that</span> <span data-start="430.169" data-end="432">code i'm going to show you the organic</span> <span data-start="432" data-end="435.3">version first we are going to use curve</span> <span data-start="435.3" data-end="437.4">because this is just a simple HTTP POST</span> <span data-start="437.4" data-end="439.979">request so courage enough and so we are</span> <span data-start="439.979" data-end="441.65">using Colonel we are pointing it at our</span> <span data-start="441.65" data-end="445.05">sandbox deployed in Sao Paulo we are</span> <span data-start="445.05" data-end="446.789">saying that this code is to be executing</span> <span data-start="446.789" data-end="448.77">on behalf of 10 and Q 1 and this is just</span> <span data-start="448.77" data-end="451.05">an arbitrary string that denotes the</span> <span data-start="451.05" data-end="452.819">isolation boundary between containers</span> <span data-start="452.819" data-end="459.84">and then we are just providing the body</span> <span data-start="459.84" data-end="462.69">of the HTTP POST request which is that</span> <span data-start="462.69" data-end="466.05">not Jes code that we won't execute so we</span> <span data-start="466.05" data-end="468.77">are going to return a function that</span> <span data-start="468.77" data-end="472.05">takes a single callback parameter and</span> <span data-start="472.05" data-end="473.58">you immediately calls that callback</span> <span data-start="473.58" data-end="479.669">parameter with hello world and i hope i</span> <span data-start="479.669" data-end="492.09">didn't make and i did make what did i</span> <span data-start="492.09" data-end="492.9">miss here</span> <span data-start="492.9" data-end="496.139">no our sandbox also has a very simple</span> <span data-start="496.139" data-end="498.12">authentication mechanism so I have to</span> <span data-start="498.12" data-end="500.16">basically provide an authentication key</span> <span data-start="500.16" data-end="503.94">here this is a query parameter which is</span> <span data-start="503.94" data-end="510.06">what I missed so you're sending it over</span> <span data-start="510.06" data-end="513.99">to some Pablo our sandbox compilers that</span> <span data-start="513.99" data-end="516.24">code executes serializes the result and</span> <span data-start="516.24" data-end="518.69">here it comes back so let's run it again</span> <span data-start="518.69" data-end="521.279">it is not much faster because the second</span> <span data-start="521.279" data-end="522.659">time I run it the container is already</span> <span data-start="522.659" data-end="525.12">running in Sao Paulo for that tenant so</span> <span data-start="525.12" data-end="528.6">no extra provisioning is required so</span> <span data-start="528.6" data-end="530.16">with that let's move on to a slightly</span> <span data-start="530.16" data-end="532.92">more advanced example in this case the</span> <span data-start="532.92" data-end="534.209">only difference is that we have a</span> <span data-start="534.209" data-end="535.83">variation of the programming model which</span> <span data-start="535.83" data-end="538.35">allows URL query parameters of that HTTP</span> </p>
<p><span data-start="538.35" data-end="540.81">POST request to be propagated to the</span> <span data-start="540.81" data-end="542.88">JavaScript code as part of the context</span> <span data-start="542.88" data-end="545.04">object so what i'm doing here is i'm</span> <span data-start="545.04" data-end="547.8">prepending a name equals of 0 URL query</span> <span data-start="547.8" data-end="550.47">parameter to the URL i'm going to be</span> <span data-start="550.47" data-end="552.81">involved to be invoking and then i can</span> <span data-start="552.81" data-end="555.089">access that name parameter off of the</span> <span data-start="555.089" data-end="557.58">context object passed into the function</span> <span data-start="557.58" data-end="559.8">that I'm authoring so let's run this</span> <span data-start="559.8" data-end="568.28">game</span> <span data-start="568.29" data-end="570.69">oh hello of zero and just make sure</span> <span data-start="570.69" data-end="572.19">up against really well i'm going to</span> <span data-start="572.19" data-end="577.5">change the 02 jas cone and what comes</span> <span data-start="577.5" data-end="582.09">back is calories count so here is a</span> <span data-start="582.09" data-end="583.95">slightly more interesting example so</span> <span data-start="583.95" data-end="585.78">let's say now that we have the ability</span> <span data-start="585.78" data-end="587.97">to run arbitrary code in eight places in</span> <span data-start="587.97" data-end="589.98">the world one one way we can use it is</span> <span data-start="589.98" data-end="592.56">to measure latency of accessing a</span> <span data-start="592.56" data-end="594.78">particular end point from those eight</span> <span data-start="594.78" data-end="596.4">places around the world and this is what</span> <span data-start="596.4" data-end="600.6">that code does it will call in 20 20 com</span> <span data-start="600.6" data-end="603.51">basically to an HTTP GET against zero at</span> <span data-start="603.51" data-end="605.91">colleges our website measure the latency</span> <span data-start="605.91" data-end="609.72">of that call and return the latency in</span> <span data-start="609.72" data-end="614.31">the result so let's run it from Northern</span> </p>
<p><span data-start="614.31" data-end="620.04">California which is the other sandbox</span> <span data-start="620.04" data-end="623.34">lastly we have deployed and you'll</span> <span data-start="623.34" data-end="624.84">notice the latency to Northern</span> <span data-start="624.84" data-end="628.41">California is very long but once you are</span> <span data-start="628.41" data-end="630.3">in Northern California the latency of</span> <span data-start="630.3" data-end="632.25">calling ohdeedoh.com is just 26</span> <span data-start="632.25" data-end="634.59">milliseconds that is because our website</span> <span data-start="634.59" data-end="636.45">of zero dot com is hosted in Northern</span> <span data-start="636.45" data-end="638.73">California as well if we do the same</span> <span data-start="638.73" data-end="640.71">test and send that code to be executed</span> <span data-start="640.71" data-end="649.26">in Singapore that called take more time</span> <span data-start="649.26" data-end="652.02">than my flight here even not is the</span> <span data-start="652.02" data-end="655.35">latency from Singapore to of zero is 750</span> <span data-start="655.35" data-end="657.84">two milliseconds so that way you can</span> <span data-start="657.84" data-end="659.82">basically conduct very simple latency</span> <span data-start="659.82" data-end="661.35">measurements by having the code deploy</span> <span data-start="661.35" data-end="662.49">to different places around the world</span> <span data-start="662.49" data-end="669.84">with a sim simple HTTP POST request so</span> <span data-start="669.84" data-end="671.16">here comes something interesting that</span> <span data-start="671.16" data-end="673.77">that ghanta mentioned the beginning in</span> <span data-start="673.77" data-end="675.48">addition to running no dress code we</span> <span data-start="675.48" data-end="676.98">also have the ability to run c-sharp</span> <span data-start="676.98" data-end="679.65">code and you are doing this using the</span> <span data-start="679.65" data-end="683.04">eds module which allows you to host CLR</span> <span data-start="683.04" data-end="685.2">and v8 inside of a single process and</span> <span data-start="685.2" data-end="686.82">provides an interrupt mechanism between</span> <span data-start="686.82" data-end="689.04">these two so what happens here is that</span> <span data-start="689.04" data-end="691.23">the node.js code is creating a</span> </p>
<p><span data-start="691.23" data-end="695.1">JavaScript proxy around async lambda</span> <span data-start="695.1" data-end="697.35">expression in c-sharp and it's also</span> <span data-start="697.35" data-end="699.15">providing a marshalling capability such</span> <span data-start="699.15" data-end="700.65">a thing you can exchange data between</span> <span data-start="700.65" data-end="702.04">JavaScript and see</span> <span data-start="702.04" data-end="703.99">are and also you can sighs threading</span> <span data-start="703.99" data-end="705.16">models because see that is</span> <span data-start="705.16" data-end="707.97">multi-threaded and v8 is single threaded</span> <span data-start="707.97" data-end="712.06">so this code should effectively do the</span> <span data-start="712.06" data-end="714.82">very same hello world example that we</span> <span data-start="714.82" data-end="717.22">have done previously in purely non je s</span> <span data-start="717.22" data-end="720.19">basically the URL query parameter name</span> <span data-start="720.19" data-end="722.44">of zero is going to be first propagated</span> <span data-start="722.44" data-end="726.579">into that context object in not Jes from</span> <span data-start="726.579" data-end="728.44">there it is going to be propagated to</span> <span data-start="728.44" data-end="732.73">the JavaScript function which wraps the</span> <span data-start="732.73" data-end="735.22">sea shop is in lambda expression from</span> <span data-start="735.22" data-end="737.649">there hjs will actually propagate it</span> <span data-start="737.649" data-end="740.56">into the dynamic context parameter to</span> <span data-start="740.56" data-end="742.66">that acing lambda expression and c-sharp</span> <span data-start="742.66" data-end="746.019">will generate a response let's send it</span> <span data-start="746.019" data-end="753.399">over to Brazil hello world 0 just to</span> <span data-start="753.399" data-end="755.199">make sure that we have the entire</span> <span data-start="755.199" data-end="759.699">pipeline covered the fool and here comes</span> <span data-start="759.699" data-end="761.56">the phone so the interesting thing you</span> <span data-start="761.56" data-end="763.06">know you know you notice it was actually</span> <span data-start="763.06" data-end="764.649">pretty fast so what happened here is we</span> <span data-start="764.649" data-end="767.019">sent a JavaScript code with embedded c</span> <span data-start="767.019" data-end="769.899">sharp code to brazil the sandbox took</span> <span data-start="769.899" data-end="771.91">this thing extracted the seashore code</span> <span data-start="771.91" data-end="773.68">compiled it on the fly into an in-memory</span> <span data-start="773.68" data-end="776.11">assembly marshal the request in to c</span> <span data-start="776.11" data-end="777.639">sharp C sharp generated the response</span> </p>
<p><span data-start="777.639" data-end="779.589">JavaScript serialize it into Jason and</span> <span data-start="779.589" data-end="786.829">send back to us so that was pretty quick</span> <span data-start="786.839" data-end="789.31">so with that let's move into something</span> <span data-start="789.31" data-end="791.5">slightly more complex and let's see how</span> <span data-start="791.5" data-end="793.75">that sandbox preventing the different</span> <span data-start="793.75" data-end="795.459">provides the different isolation Gavitt</span> <span data-start="795.459" data-end="796.959">guarantees that I've been talking about</span> <span data-start="796.959" data-end="798.43">and also prevents different kinds of</span> <span data-start="798.43" data-end="801.55">attacks so what you see here is a code</span> <span data-start="801.55" data-end="803.29">that we are going to be executing on</span> <span data-start="803.29" data-end="806.66">behalf of two different tenants</span> <span data-start="806.67" data-end="809.05">sequentially what this code does it</span> <span data-start="809.05" data-end="811.39">first it looks if there is a secret</span> <span data-start="811.39" data-end="814.57">property in the global namespace of what</span> <span data-start="814.57" data-end="816.52">whatever context that code executes</span> <span data-start="816.52" data-end="819.01">saying if there is no secret object a</span> <span data-start="819.01" data-end="820.899">one will be created using math.random</span> <span data-start="820.899" data-end="823.72">and you know the second time you execute</span> <span data-start="823.72" data-end="825.49">that code the secret will already exist</span> <span data-start="825.49" data-end="828.64">so it will remain unchanged and then the</span> <span data-start="828.64" data-end="830.95">function that we are returning from the</span> <span data-start="830.95" data-end="832.87">snow dress code simply turns around and</span> <span data-start="832.87" data-end="835.75">returns the global secret so let's run</span> <span data-start="835.75" data-end="838.959">it on behalf of 10 and full in some Sao</span> </p>
<p><span data-start="838.959" data-end="842.92">Paulo so the first time we done it the</span> <span data-start="842.92" data-end="844.959">secret will be generated and will be</span> <span data-start="844.959" data-end="847.89">returned to to us and that secret is</span> <span data-start="847.89" data-end="851.08">0.56 to something something next time</span> <span data-start="851.08" data-end="853.57">you call it the secret is the same but</span> <span data-start="853.57" data-end="855.31">now if i go ahead and I change the</span> <span data-start="855.31" data-end="863.44">tenant named here to full 10 and 1 i'll</span> <span data-start="863.44" data-end="864.39">get an oosik</span> <span data-start="864.39" data-end="867.96">generated 0.35 if I call tenant one</span> <span data-start="867.96" data-end="872.16">again I will again get zero 3.5 but if i</span> <span data-start="872.16" data-end="875.43">go back to tenant I'll get back the old</span> <span data-start="875.43" data-end="876.51">secret so this is just a demonstration</span> <span data-start="876.51" data-end="880.08">that the data context in which the</span> <span data-start="880.08" data-end="881.79">requests on behalf of different tenants</span> <span data-start="881.79" data-end="884.67">execute is different so tenants do not</span> <span data-start="884.67" data-end="891.6">have access to their data let's have a</span> <span data-start="891.6" data-end="893.199">look</span> <span data-start="893.199" data-end="895.899">my favorite kind of attack on nodejs</span> <span data-start="895.899" data-end="898.879">very elaborate that I can CPU we are</span> <span data-start="898.879" data-end="901.009">basically going to run an infinite loop</span> <span data-start="901.009" data-end="903.8">while true so what this does in Dantes</span> <span data-start="903.8" data-end="906.62">it blocks the event loop the event loop</span> <span data-start="906.62" data-end="909.17">can process any any more requests but</span> <span data-start="909.17" data-end="912.05">the basic premise of our sandbox is that</span> <span data-start="912.05" data-end="915.8">it is fine to do so as long as it</span> <span data-start="915.8" data-end="917.389">doesn't prevent other tenants from</span> <span data-start="917.389" data-end="920.329">executing code in the sandbox if you are</span> <span data-start="920.329" data-end="922.49">writing bad cold it is okay if you</span> <span data-start="922.49" data-end="924.23">should you yourself in the food but you</span> <span data-start="924.23" data-end="925.959">shouldn't be able to affect how others</span> <span data-start="925.959" data-end="929.779">execute code so let's let's take a guy</span> <span data-start="929.779" data-end="931.819">who's actually in who actually knows how</span> <span data-start="931.819" data-end="934.04">to write good code and he will be</span> <span data-start="934.04" data-end="938.019">issuing request request to the sandbox</span> <span data-start="938.019" data-end="940.85">thousand requests sequentially will</span> <span data-start="940.85" data-end="942.56">basically be responding with hello one</span> <span data-start="942.56" data-end="944.72">two three and so on and now I'm going to</span> <span data-start="944.72" data-end="947.689">run the bed code in the same sandbox and</span> <span data-start="947.689" data-end="950.569">see if it affects the behavior of the</span> <span data-start="950.569" data-end="951.98">first tenant which is running the</span> <span data-start="951.98" data-end="955.009">well-behaved code so I'm not going to</span> <span data-start="955.009" data-end="957.019">take that wire through code that the</span> <span data-start="957.019" data-end="959.899">loop you are seeing here and I'm going</span> <span data-start="959.899" data-end="964.71">to run it from this console the Derby</span> <span data-start="964.72" data-end="969.62">the first of all take a moment is what</span> <span data-start="969.62" data-end="971.509">happens here is that we are starting to</span> <span data-start="971.509" data-end="973.399">execute the JavaScript code that does</span> <span data-start="973.399" data-end="976.04">the infinite loop and before our system</span> <span data-start="976.04" data-end="977.87">realizes that the event loop is blocked</span> <span data-start="977.87" data-end="979.189">it is like two seconds it is a</span> <span data-start="979.189" data-end="981.29">configurable time period but eventually</span> <span data-start="981.29" data-end="984.529">the our sandbox realizes okay this this</span> <span data-start="984.529" data-end="986.3">process is gone so we are going to</span> <span data-start="986.3" data-end="989.54">terminate it this results in that tenant</span> <span data-start="989.54" data-end="991.699">who wrote the bed code getting an HTTP</span> <span data-start="991.699" data-end="994.579">500 back but you'll notice that the code</span> <span data-start="994.579" data-end="997.1">who wrote the word written code is</span> <span data-start="997.1" data-end="998.54">running just fine so he remained</span> <span data-start="998.54" data-end="1002.43">unaffected by the attempted CPU attack</span> <span data-start="1002.43" data-end="1007.29">to keep that well-behaved 10 and going</span> <span data-start="1007.29" data-end="1010.75">and we will do another kind of attack on</span> <span data-start="1010.75" data-end="1012.759">memory this time so here we have a</span> <span data-start="1012.759" data-end="1015.639">string evil and you are going to run a</span> <span data-start="1015.639" data-end="1017.439">very tight loop which basically doubles</span> <span data-start="1017.439" data-end="1019.54">the size of evil so eventually after a</span> <span data-start="1019.54" data-end="1020.86">few iterations we are going to run out</span> <span data-start="1020.86" data-end="1024.549">of memory so let's run this thing in the</span> <span data-start="1024.549" data-end="1025.51">same sandbox</span> <span data-start="1025.51" data-end="1030.04">as the tenant running the well executing</span> <span data-start="1030.04" data-end="1031.78">code so you'll notice that we got HTT if</span> </p>
<p><span data-start="1031.78" data-end="1035.199">I found it much faster however the the</span> <span data-start="1035.199" data-end="1037.18">tenant that is well behaved was</span> <span data-start="1037.18" data-end="1040.54">unaffected again and the last kind of</span> <span data-start="1040.54" data-end="1042.97">attack is a traditional fork bomb so we</span> <span data-start="1042.97" data-end="1046.36">are going to use spawn to basically keep</span> <span data-start="1046.36" data-end="1049.27">creating note processes child node</span> <span data-start="1049.27" data-end="1050.8">processes they're not processes are not</span> <span data-start="1050.8" data-end="1052.51">doing much but it is that is beside the</span> <span data-start="1052.51" data-end="1054.58">point the idea is that you know we are</span> <span data-start="1054.58" data-end="1056.32">trying to create a billion processes on</span> <span data-start="1056.32" data-end="1060.46">that machine and see that well behave</span> <span data-start="1060.46" data-end="1061.96">tonight is affected so let's do this</span> <span data-start="1061.96" data-end="1077.47">again I will take a moment until it is</span> <span data-start="1077.47" data-end="1078.7">it should be 500</span> <span data-start="1078.7" data-end="1080.89">and the world we hit tennis continues</span> <span data-start="1080.89" data-end="1082.63">running just fine so this just</span> <span data-start="1082.63" data-end="1085.99">demonstrated some very basic send boxing</span> <span data-start="1085.99" data-end="1087.61">capabilities of the technology that</span> <span data-start="1087.61" data-end="1089.86">we've created one last thing I really</span> <span data-start="1089.86" data-end="1091.72">want to talk about in this presentation</span> <span data-start="1091.72" data-end="1094.78">is logging because that in itself is</span> <span data-start="1094.78" data-end="1100.33">very interesting logging is a very basic</span> <span data-start="1100.33" data-end="1102.16">diagnostic mechanism that is very</span> <span data-start="1102.16" data-end="1103.75">frequently used in node in a distributed</span> <span data-start="1103.75" data-end="1107.08">system like that it is interesting how</span> <span data-start="1107.08" data-end="1109.54">to structure a collection of logs such</span> <span data-start="1109.54" data-end="1110.77">as it is actually usable to the</span> <span data-start="1110.77" data-end="1112.51">developer and other systems that consume</span> <span data-start="1112.51" data-end="1115.18">them so what we are doing here is we are</span> <span data-start="1115.18" data-end="1117.31">normalizing logs generated by all</span> <span data-start="1117.31" data-end="1118.81">components in the system both the</span> <span data-start="1118.81" data-end="1121.48">sandbox the proxy and the user code</span> <span data-start="1121.48" data-end="1122.83">using anything you write using</span> <span data-start="1122.83" data-end="1126.19">console.log now into Bunyan first such</span> <span data-start="1126.19" data-end="1127.96">that we have structured Jason locks then</span> <span data-start="1127.96" data-end="1130.15">we put those logs into Kafka we have a</span> </p>
<p><span data-start="1130.15" data-end="1132.46">Kafka cluster deployed across the car OS</span> <span data-start="1132.46" data-end="1135.16">cluster Kafka SMS messaging server that</span> <span data-start="1135.16" data-end="1136.66">is highly optimized for logging</span> <span data-start="1136.66" data-end="1139.36">scenarios and then we expose the logs</span> <span data-start="1139.36" data-end="1143.89">over HTTP so let's take it for a spin</span> <span data-start="1143.89" data-end="1145.72">again so what i'm doing here is</span> <span data-start="1145.72" data-end="1147.52">basically writing a single simple</span> <span data-start="1147.52" data-end="1150.3">function that the calls console.log ones</span> <span data-start="1150.3" data-end="1154.75">first I'm going to attach my streaming</span> <span data-start="1154.75" data-end="1157.15">logging endpoint that exposes the locks</span> <span data-start="1157.15" data-end="1161.08">from Kafka and I'm filtering Lee let me</span> <span data-start="1161.08" data-end="1163.15">actually filter the output through</span> <span data-start="1163.15" data-end="1165.4">Bunyan so that we get pretty printing</span> <span data-start="1165.4" data-end="1168.31">and then I'm going to invoke this code</span> <span data-start="1168.31" data-end="1174.5">that actually perform some some logging</span> <span data-start="1174.51" data-end="1176.25">here it is</span> <span data-start="1176.25" data-end="1180.66">all returned Monte is 0 10 30 which is</span> <span data-start="1180.66" data-end="1186.45">what this code did but you also notice</span> <span data-start="1186.45" data-end="1188.07">that there is a console.log statement</span> <span data-start="1188.07" data-end="1193.23">and that console log showed up here if I</span> <span data-start="1193.23" data-end="1196.32">run it again it will basically get a new</span> <span data-start="1196.32" data-end="1198.99">entry here down here so this gives you a</span> <span data-start="1198.99" data-end="1200.94">streaming logging capability real time</span> <span data-start="1200.94" data-end="1202.98">access to logs generated by the sandbox</span> <span data-start="1202.98" data-end="1205.83">code and you can post process it in</span> <span data-start="1205.83" data-end="1213.9">whatever way you want so this is this is</span> <span data-start="1213.9" data-end="1216.42">what we have built we are kind of we</span> <span data-start="1216.42" data-end="1219.21">built it primarily with a scenario in</span> <span data-start="1219.21" data-end="1221.4">mind of enabling our customers to run</span> <span data-start="1221.4" data-end="1223.59">custom code on a platform but once we</span> <span data-start="1223.59" data-end="1225.69">build it we are actually started</span> <span data-start="1225.69" data-end="1227.97">noticing certain scenarios and patterns</span> <span data-start="1227.97" data-end="1229.71">where the sandbox is very very usable</span> <span data-start="1229.71" data-end="1231.75">for example we've built our entire</span> <span data-start="1231.75" data-end="1233.43">health monitoring system around the</span> <span data-start="1233.43" data-end="1235.08">system we have these eight sandboxes</span> <span data-start="1235.08" data-end="1236.7">deployed around the world and every 30</span> <span data-start="1236.7" data-end="1238.35">seconds they are basically executing a</span> <span data-start="1238.35" data-end="1240.87">bunch of tests not just HTTP test but</span> <span data-start="1240.87" data-end="1242.94">you know you can contact Mongo you can</span> <span data-start="1242.94" data-end="1246">do anything you can do with no Jas in</span> <span data-start="1246" data-end="1247.47">those sand boxes around the world and</span> <span data-start="1247.47" data-end="1249.06">they are then consolidating results</span> <span data-start="1249.06" data-end="1251.22">across the world but such a technology</span> <span data-start="1251.22" data-end="1253.95">really we think the sweet spot it is</span> <span data-start="1253.95" data-end="1256.02">targeting multi-tenant systems or things</span> <span data-start="1256.02" data-end="1259.89">like if this than that things like</span> <span data-start="1259.89" data-end="1262.56">custom web hooks for example so the</span> <span data-start="1262.56" data-end="1264.42">possibilities are really quite quite</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
