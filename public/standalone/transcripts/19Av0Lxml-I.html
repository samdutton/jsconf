<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="web.dev LIVE video transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>19Av0Lxml-I</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/19Av0Lxml-I?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="14.87" data-end="15.87">Thanks.</span> <span data-start="15.87" data-end="18.7">So yeah, I'm really excited to be here, talking about making</span> <span data-start="18.7" data-end="21.62">relational cool again, and the subtitle is..</span> <span data-start="21.62" data-end="23.42">Or JavaScript on ACID.</span> <span data-start="23.42" data-end="27.21">And like I said, my name is Tim Griesser, Tgriesser</span> <span data-start="27.21" data-end="31.14">on Github, and I'm here really excited to be talking about SQL.</span> <span data-start="31.14" data-end="34.39">Or is it Ess-kyoo-ell?</span> <span data-start="34.39" data-end="40.39">I know it's an issue that really divides programmers.</span> <span data-start="40.39" data-end="46.7">So I Googled it, and the first result I came across was this English language and use in</span> <span data-start="46.7" data-end="47.969">Stack Exchange.</span> <span data-start="47.969" data-end="51.44">Which I thought was fitting, given that we're at a programming</span> <span data-start="51.44" data-end="53.18">conference.</span> <span data-start="53.18" data-end="55.76">And the first thing you'll notice is I'm not a member of the English</span> <span data-start="55.76" data-end="61.129">language and usage, so if I make any mistakes up here, you'll know why.</span> </p>
<p><span data-start="61.129" data-end="65.26">But the answer was that it was in fact first called the structured English query</span> <span data-start="65.26" data-end="68.43">language, and so that acronym was SEQUEL.</span> <span data-start="68.43" data-end="75.07">And then that was abbreviated as SQL.</span> <span data-start="75.07" data-end="76.57">Now it's a matter of preference.</span> <span data-start="76.57" data-end="78.9">And there's an urban legend that it came after the structured</span> <span data-start="78.9" data-end="85.61">query language, which is the worst urban legend I ever heard.</span> <span data-start="85.61" data-end="90.32">So I learned something new, and now I'm a member.</span> <span data-start="90.32" data-end="95.57">It was a big day.</span> <span data-start="95.57" data-end="99.12">But it's appropriate that we're talking about relational databases</span> <span data-start="99.12" data-end="103.09">at a JavaScript conference, because I think there's a lot of similar features</span> <span data-start="103.09" data-end="105.1">between the two.</span> <span data-start="105.1" data-end="107.55">At a language level, maybe not so much.</span> <span data-start="107.55" data-end="113.67">Relational, SQL is static and strongly typed, declarative, and in some ways procedural,</span> <span data-start="113.67" data-end="118.28">and JavaScript is as loosely typed as you can get while still being a programming</span> <span data-start="118.28" data-end="125.95">language, and it's object oriented, which leads to some interesting</span> <span data-start="125.95" data-end="132.84">debates as to how to write the code correctly, and it shares some of the same</span> <span data-start="132.84" data-end="137.59">operators, but we know in JavaScript the operators don't do what we want some of</span> <span data-start="137.59" data-end="139.72">the time.</span> </p>
<p><span data-start="139.72" data-end="143.28">So what do I mean when I say is theres a lot of similarities between</span> <span data-start="143.28" data-end="145.28">SQL and JavaScript?</span> <span data-start="145.28" data-end="149.68">They both sort of share this similar quality that is not</span> <span data-start="149.68" data-end="153.689">often attained by all languages, which is what I like to term  —  languages</span> <span data-start="153.689" data-end="156.319">that will probably never die.</span> </p>
<p><span data-start="156.319" data-end="158.9">As much as people try to kill off JavaScript</span> <span data-start="158.9" data-end="164.17">with different other languages that will supersede it, it sort has this monopoly.</span> <span data-start="164.17" data-end="165.5">It's the language of the web.</span> <span data-start="165.5" data-end="167.819">It's the language that runs in web browsers.</span> <span data-start="167.819" data-end="171.2">And similarly, SQL has so much momentum.</span> <span data-start="171.2" data-end="175.519">It's been around since the '70s and it's been around forever.</span> </p>
<p><span data-start="175.519" data-end="178.379">This is a slide that we often show when we're talking</span> <span data-start="178.379" data-end="181.2">about JavaScript, just sort of illustrating that it runs everywhere.</span> <span data-start="181.2" data-end="185.79">In the browsers, but also your television and your server and your nodebots</span> <span data-start="185.79" data-end="189.43">and copters and also on your phones, and I think the same could be sort</span> <span data-start="189.43" data-end="190.75">of said about SQL.</span> <span data-start="190.75" data-end="193.529">Is that it powers the largest websites in the world.</span> <span data-start="193.529" data-end="201.2">It's behind Facebook and Wikipedia, and also down to SQL-lite, flat file storage,</span> <span data-start="201.2" data-end="207.76">which is in more places than you would imagine on your phones.</span> </p>
<p><span data-start="207.76" data-end="211.35">So coming to node.js a couple years ago, I was</span> <span data-start="211.35" data-end="212.42">sort of surprised.</span> <span data-start="212.42" data-end="214.93">It seems like these two would be such a great fit.</span> <span data-start="214.93" data-end="217.769">They're both everywhere.</span> <span data-start="217.769" data-end="220.81">Why is there not more support for it?</span> <span data-start="220.81" data-end="224.819">And I think the reason is that node starts with no, and no is the</span> <span data-start="224.819" data-end="230.65">beginning of NoSQL, and around the time that node came out, it was like  —  let's</span> <span data-start="230.65" data-end="235.17">rethink the entire way that we're writing server side applications with</span> <span data-start="235.17" data-end="236.7">this evented IO model.</span> <span data-start="236.7" data-end="240.2">And at the time, it was sort of like  —  let's rethink</span> <span data-start="240.2" data-end="244.54">the standard relational database, because we're hitting web scale and we need</span> <span data-start="244.54" data-end="247.269">to get past that.</span> <span data-start="247.269" data-end="253.769">And so around the time that sort of the height of the NoSQL phase or moment  — </span> <span data-start="253.769" data-end="258.421">it's still going, of course  —  is when node came out, and that's why there was</span> <span data-start="258.421" data-end="259.421">so much of this.</span> </p>
<p><span data-start="259.421" data-end="263.389">So all the tutorials I felt like for node were node and</span> <span data-start="263.389" data-end="266.5">Mongo, getting started  —  they have literally taken the software and web</span> <span data-start="266.5" data-end="271.74">industries by storm.</span> <span data-start="271.74" data-end="274.47">You've got Mongo express angular node, which everybody</span> <span data-start="274.47" data-end="284.62">has heard of, and then my favorite, the LeBron stack, level DB slam dunk.</span> <span data-start="284.62" data-end="287.46">And what happened to relational algebra?</span> <span data-start="287.46" data-end="288.46">Right?</span> <span data-start="288.46" data-end="290.86">This is proven and time tested.</span> <span data-start="290.86" data-end="295.4">And SQL works great for a lot of things.</span> <span data-start="295.4" data-end="299.4">And this stack overflow post that I came across sort of summed up what I was thinking,</span> <span data-start="299.4" data-end="303.759">coming to node from outside.</span> <span data-start="303.759" data-end="306.34">Are relational databases a poor fit?</span> <span data-start="306.34" data-end="309.66">And this is sort of long, so let me just pick out a few things.</span> <span data-start="309.66" data-end="315.139">There's a degree of antipathy toward relational databases, is an observation you could make</span> <span data-start="315.139" data-end="317.479">of the node community.</span> </p>
<p><span data-start="317.479" data-end="320.71">And that they're poorly supported, compared to non-relational</span> <span data-start="320.71" data-end="321.71">databases.</span> <span data-start="321.71" data-end="322.81">I sort of agree with this.</span> <span data-start="322.81" data-end="327.58">Listening to the node up podcasts, listening to couch DB and</span> <span data-start="327.58" data-end="333.159">Mongo, I guess it was like  —  relational databases aren't cool anymore.</span> <span data-start="333.159" data-end="336.851">I dug a little and found there actually are really</span> <span data-start="336.851" data-end="342.28">great libraries for working with SQL in node.</span> <span data-start="342.28" data-end="352.32">All the popular Open Source, and Oracle came out with another</span> <span data-start="352.32" data-end="353.32">one.</span> </p>
<p><span data-start="353.32" data-end="357.229">But there's not a common API all of them.</span> <span data-start="357.229" data-end="361.12">Node didn't assume that a relational database was a given.</span> <span data-start="361.12" data-end="367.259">In all other language systems, there's a standard for how you're interacting with common</span> <span data-start="367.259" data-end="368.8">patterns of a database.</span> <span data-start="368.8" data-end="371.169">How you connect, how you disconnect.</span> <span data-start="371.169" data-end="372.169">That doesn't exist.</span> <span data-start="372.169" data-end="376.539">So what that lends to is that all the different clients have a different</span> <span data-start="376.539" data-end="380.37">way of dealing with these things that should be pretty common.</span> </p>
<p><span data-start="380.37" data-end="385.379">And there's also, I guess  —  the next thing I noticed was that the higher level</span> <span data-start="385.379" data-end="387.96">abstractions were lacking a little bit.</span> <span data-start="387.96" data-end="391.15">And what I mean by that is that a lot of them were database-specific.</span> <span data-start="391.15" data-end="394.039">So there was a great query builder, but it works for</span> <span data-start="394.039" data-end="396.509">postgres, specifically.</span> </p>
<p><span data-start="396.509" data-end="399.94">Another great one for another language, and no way</span> <span data-start="399.94" data-end="402.44">to use the same for both.</span> <span data-start="402.44" data-end="403.74">Different APIs.</span> <span data-start="403.74" data-end="407.12">Or there's a mix of an ORM layer and a query layer, so there's no</span> <span data-start="407.12" data-end="412.189">ability to drop down and use just vanilla SQL if you need to.</span> <span data-start="412.189" data-end="415.659">One that was big for me is the lack of transaction APIs.</span> <span data-start="415.659" data-end="418.3">So there wasn't any mention of transactions.</span> <span data-start="418.3" data-end="421.35">In any of the higher level libraries that I had seen at the</span> <span data-start="421.35" data-end="422.35">time.</span> <span data-start="422.35" data-end="425.84">And that is sort of what the second subtitle of the talk is that I'll</span> <span data-start="425.84" data-end="426.979">get to in a little bit.</span> </p>
<p><span data-start="426.979" data-end="429.129">And then there was the jack of all trades, where it's</span> <span data-start="429.129" data-end="434.61">sort of like  —  hey, you can use the same save API to save to Redis or Mongo</span> <span data-start="434.61" data-end="437.46">or relational database or the file system.</span> <span data-start="437.46" data-end="438.479">It's like..</span> <span data-start="438.479" data-end="443.289">If you have the same API for all these different specialized data</span> <span data-start="443.289" data-end="448.02">stores, you're really not taking advantage of the best use cases for each of</span> <span data-start="448.02" data-end="449.02">them.</span> </p>
<p><span data-start="449.02" data-end="450.94">Or there's sort of what I call the DIY.</span> <span data-start="450.94" data-end="454.18">Like, it gets you most of the way, but modularity.</span> <span data-start="454.18" data-end="457.5">So you have to assemble all these.</span> <span data-start="457.5" data-end="461.33">The pooling, the construction, the abstracting the</span> <span data-start="461.33" data-end="462.99">database API.</span> <span data-start="462.99" data-end="466.941">So the ecosystem  —  I would definitely agree with the Stack</span> <span data-start="466.941" data-end="473.56">Overflow post, that there's a need there, that needs to be filled.</span> <span data-start="473.56" data-end="475.2">But I really wanted this to happen.</span> <span data-start="475.2" data-end="476.72">I really love writing JavaScript.</span> <span data-start="476.72" data-end="478.46">So I was like..</span> <span data-start="478.46" data-end="479.87">Maybe we can do something better.</span> <span data-start="479.87" data-end="482.88">And at the time, I had been writing a lot of PHP.</span> <span data-start="482.88" data-end="486.569">This was back in 2012, in a framework called Laravel, which some</span> <span data-start="486.569" data-end="487.569">might have heard of.</span> <span data-start="487.569" data-end="493.759">And it makes writing PHP pretty tolerable.</span> <span data-start="493.759" data-end="495.56">And I was also using a lot of backbones.</span> </p>
<p><span data-start="495.56" data-end="496.56">So I was thinking..</span> <span data-start="496.56" data-end="500.41">Maybe I can take some of the ideas from both of these, and I sort of translated</span> <span data-start="500.41" data-end="505.28">the query builder from Laravel into this project called Knex.JS.</span> <span data-start="505.28" data-end="509.8">And this sort of illustrates what pieces were taken from each, but the eloquent</span> <span data-start="509.8" data-end="513.95">ORM from Laravel and some of the ideas from backbone into bookshelf, and mix</span> <span data-start="513.95" data-end="518.84">into promises  —  and so I'm going to talk about these two libraries that I have</span> <span data-start="518.84" data-end="521.53">put together, connects and bookshelf.</span> </p>
<p><span data-start="521.53" data-end="523.47">The first is Knex.</span> <span data-start="523.47" data-end="528.889">If you're not familiar with where the name comes from, it's this toy that was popular</span> <span data-start="528.889" data-end="530.57">in the '90s.</span> <span data-start="530.57" data-end="533.01">It's sort of like a cheaper version of Legos.</span> <span data-start="533.01" data-end="536.07">You can assemble all these pieces together and build</span> <span data-start="536.07" data-end="538.31">pretty cool-looking things.</span> <span data-start="538.31" data-end="544.529">And actually, it's really great if you're procrastinating, making conference slides.</span> <span data-start="544.529" data-end="549.56">I decided to make this little motorcycle here.</span> <span data-start="549.56" data-end="554.089">All right, JSConf.</span> <span data-start="554.089" data-end="556.95">But the reason that I think..</span> <span data-start="556.95" data-end="562.279">What Knex tries to do is standardize some of the inconsistencies</span> <span data-start="562.279" data-end="563.44">in SQL.</span> <span data-start="563.44" data-end="568.42">So SQL is a language  —  an ANSI language specification.</span> <span data-start="568.42" data-end="573.949">But it's not like it is, what we're used to with, like, ES5 or ES6 and beyond.</span> <span data-start="573.949" data-end="576.93">Where we sort of have this compatibility table, and we see that Babel</span> <span data-start="576.93" data-end="581.519">is in ahead of everything else, in terms of implementing all the different features.</span> </p>
<p><span data-start="581.519" data-end="585.339">But it feels more like the can I use.</span> <span data-start="585.339" data-end="587.06">Sort of like a language guideline.</span> <span data-start="587.06" data-end="595.3">There are features that exist in some dialects but not others.</span> <span data-start="595.3" data-end="599.17">It doesn't fail, or it fails sometimes, or  — </span> <span data-start="599.17" data-end="604.31">different inconsistencies that Knex tries to paper over.</span> </p>
<p><span data-start="604.31" data-end="607.37">This is an illustration of the different pieces as they're</span> <span data-start="607.37" data-end="609.49">coming over internally.</span> <span data-start="609.49" data-end="612.17">Have things like connection pooling, to make sure</span> <span data-start="612.17" data-end="614.779">you're getting connections that you don't have to continually reconnect to</span> <span data-start="614.779" data-end="619.04">the database every time you reissue a query, mixes in different grammars from</span> <span data-start="619.04" data-end="625.529">the different dialects, and creates a client that's used in the schema and normal</span> <span data-start="625.529" data-end="627.68">query building, as well as transactions.</span> </p>
<p><span data-start="627.68" data-end="630.61">Which I sort of break out entirely, because I'm going to spend a</span> <span data-start="630.61" data-end="635.05">little bit of time on those, and on top of that, we have higher level APIs for</span> <span data-start="635.05" data-end="639.399">doing some familiar migrations and seeding as you would see for something like</span> <span data-start="639.399" data-end="641.04">Rails.</span> <span data-start="641.04" data-end="645.1">So how you get started with Knex is just give it a connection string.</span> <span data-start="645.1" data-end="647.73">If you want to configure the pool, you can do that.</span> <span data-start="647.73" data-end="651.72">And it works against a number of different databases.</span> <span data-start="651.72" data-end="653.36">Including Oracle, which is pretty cool.</span> <span data-start="653.36" data-end="654.76">Somebody just opened a pull request.</span> <span data-start="654.76" data-end="657.079">And it's like  —  oh, I don't use Oracle, but it's</span> <span data-start="657.079" data-end="660.209">awesome that you opened a pull request.</span> </p>
<p><span data-start="660.209" data-end="661.5">Yay, Open Source.</span> <span data-start="661.5" data-end="665.07">And it also supports web SQL, but I don't really recommend that,</span> <span data-start="665.07" data-end="667.82">because that's deprecated.</span> <span data-start="667.82" data-end="671.1">Browsers killed that off.</span> <span data-start="671.1" data-end="680.41">So you can select all from accounts, where activated</span> <span data-start="680.41" data-end="684.7">is one, and then you call then on it, and it has the familiar promise chaining</span> <span data-start="684.7" data-end="689.139">API, so it issues that query and returns the result of the query and then you</span> <span data-start="689.139" data-end="694.12">can catch the error if that happens in the standard promise  —  it's actually</span> <span data-start="694.12" data-end="697.18">great that I don't have to argue too much in favor of promise, now that</span> <span data-start="697.18" data-end="698.18">they're actually in the spec.</span> <span data-start="698.18" data-end="703.779">But when I was starting out, that was a thing, whether it was  —  it was still up for debate</span> <span data-start="703.779" data-end="706.339">whether you should use that.</span> </p>
<p><span data-start="706.339" data-end="707.56">Also it does joins.</span> <span data-start="707.56" data-end="710.529">I don't have to read it out too much, but joins with</span> <span data-start="710.529" data-end="715.55">multiple clauses, and then subqueries, so anywhere  —  so here we have a where</span> <span data-start="715.55" data-end="720.279">in clause, and anywhere you might want to use a subquery, the general rule of</span> <span data-start="720.279" data-end="725.079">thumb is that you can pass a function and then use the context of that closure</span> <span data-start="725.079" data-end="727.92">as a new subquery.</span> </p>
<p><span data-start="727.92" data-end="730.97">And then from there, I'm not going to dive into all the</span> <span data-start="730.97" data-end="733.269">features, because that's what documentation is for.</span> <span data-start="733.269" data-end="736.1">But you can do raw queries, like if you have a specialized query</span> <span data-start="736.1" data-end="737.779">that you don't want to..</span> <span data-start="737.779" data-end="739.399">That maybe does some things that aren't supported</span> <span data-start="739.399" data-end="746.3">by Knex, you can issue those, aggregates, subquery aliasing, and it tries</span> <span data-start="746.3" data-end="748.66">hard not to let you screw up.</span> <span data-start="748.66" data-end="751.32">It tries to catch different errors or paper over</span> <span data-start="751.32" data-end="755.91">things for you, so you don't make too many mistakes.</span> <span data-start="755.91" data-end="758.829">And so the subtitle of the talk, as I mentioned, is</span> <span data-start="758.829" data-end="760.029">JavaScript on ACID.</span> <span data-start="760.029" data-end="764.42">So this is not the ACID test, which..</span> <span data-start="764.42" data-end="767.13">Some are probably familiar with.</span> </p>
<p><span data-start="767.13" data-end="770.31">I've mentioned this to someone, and they're like  —  oh, you mean the browser</span> <span data-start="770.31" data-end="771.31">suite?</span> <span data-start="771.31" data-end="772.31">No.</span> <span data-start="772.31" data-end="773.31">Let me look that up, though.</span> <span data-start="773.31" data-end="777.07">It's good to know that Chrome is passing the ACID 3 test, as of today.</span> <span data-start="777.07" data-end="783.98">But I mean atomicity, consistency, isolation, and durability.</span> <span data-start="783.98" data-end="786.851">I'm not going to go into each of them, because that</span> <span data-start="786.851" data-end="792.95">could be a separate talk about each of the individual terms.</span> <span data-start="792.95" data-end="796.05">But transactions  —  I sort of sum up that.</span> <span data-start="796.05" data-end="798.48">What they do is give you the ability to have a</span> <span data-start="798.48" data-end="802.41">snapshot state of the world as you're working with your database.</span> </p>
<p><span data-start="802.41" data-end="805.5">So what it allows you to do is roll back to a certain</span> <span data-start="805.5" data-end="811.399">point in time, and also prevent other connections that might be working against</span> <span data-start="811.399" data-end="815.649">your databases, from altering rows as you're working within a single atomic</span> <span data-start="815.649" data-end="818.1">unit of state.</span> <span data-start="818.1" data-end="821.47">And this is kind of difficult to do in node.</span> </p>
<p><span data-start="821.47" data-end="826.441">You have to think about this API in advance, because in order for this to work, you have</span> <span data-start="826.441" data-end="831.16">to have the same database connection passed to every single query that</span> <span data-start="831.16" data-end="833.05">you're working against.</span> <span data-start="833.05" data-end="835.11">So it's not like in synchronous languages, where you</span> <span data-start="835.11" data-end="838.92">could just sort of say  —  okay, start transaction here, and then all of these</span> <span data-start="838.92" data-end="841.63">will run right here, and then end it right here.</span> </p>
<p><span data-start="841.63" data-end="843.19">Because you sort of..</span> <span data-start="843.19" data-end="850.05">With the event I/O model, you sort of lose that context as you go with the callback.</span> <span data-start="850.05" data-end="851.17">You don't really know what's happening.</span> <span data-start="851.17" data-end="856.45">So the connection explicitly has to be passed to every query.</span> <span data-start="856.45" data-end="858.9">So let's think about a situation where we would</span> <span data-start="858.9" data-end="860.259">actually want to use transactions.</span> <span data-start="860.259" data-end="864.74">So here's a simple user flow situation, where someone is registering for a</span> <span data-start="864.74" data-end="865.74">website.</span> <span data-start="865.74" data-end="868.54">And they register, and you give them an ID and you have to send that</span> <span data-start="868.54" data-end="872.79">to a third party service and then you have to create maybe some other rows for</span> <span data-start="872.79" data-end="874.95">that user, and then it's all done.</span> <span data-start="874.95" data-end="876.399">They're all registered.</span> <span data-start="876.399" data-end="880.66">So let's think about what could go wrong in these four steps.</span> <span data-start="880.66" data-end="885.22">So first you might depend on a module which doesn't follow semantic versioning.</span> <span data-start="885.22" data-end="888.819">So something breaks, and it's completely out of your control, or the third</span> <span data-start="888.819" data-end="893.269">party API that you're working against sort of shuts down, and your data</span> <span data-start="893.269" data-end="895.14">gets into a bad state.</span> </p>
<p><span data-start="895.14" data-end="898.83">So in order to deal with that, then, after step 2, if</span> <span data-start="898.83" data-end="902.49">that fails, then you would have to undo what happened in step 1.</span> <span data-start="902.49" data-end="908.85">Or in step 3, where you're creating additional rows to deal with that new user, maybe one</span> <span data-start="908.85" data-end="912.93">or a few of them failed, so then you have to make sure the ones that did go</span> <span data-start="912.93" data-end="917.819">through get rolled back, and then you have to unregister the user, and then</span> <span data-start="917.819" data-end="920.16">say  —  hey, something messed up.</span> <span data-start="920.16" data-end="922.63">And that ends up pushing a lot of logic into your</span> <span data-start="922.63" data-end="924.279">application code that you have to deal with.</span> <span data-start="924.279" data-end="926.399">All of these potential bad states.</span> <span data-start="926.399" data-end="930.029">Or you just don't deal with it, and then you have potentially bad data in your</span> <span data-start="930.029" data-end="931.029">application.</span> <span data-start="931.029" data-end="934.25">Because you want this whole register user flow to happen as one</span> <span data-start="934.25" data-end="936.44">atomic event.</span> </p>
<p><span data-start="936.44" data-end="939.14">Or here's another situation that can't be handled by the last</span> <span data-start="939.14" data-end="940.14">one.</span> <span data-start="940.14" data-end="944.39">Your servers just catch on fire halfway through registering the user.</span> <span data-start="944.39" data-end="945.39">And actually..</span> <span data-start="945.39" data-end="947.79">I created these libraries so I would one day have the ability to</span> <span data-start="947.79" data-end="950.48">use this graphic in a keynote.</span> </p>
<p><span data-start="950.48" data-end="951.73">No.</span> <span data-start="951.73" data-end="952.97">But..</span> <span data-start="952.97" data-end="959.22">So what Knex tries to do is you can say Knex transaction, and then it creates</span> <span data-start="959.22" data-end="964.13">an instance that you treat as a normal query builder instance, but it knows</span> <span data-start="964.13" data-end="968.38">what it's supposed to be on and the fact that it's inside an transaction.</span> </p>
<p><span data-start="968.38" data-end="973.069">So you can pass that to other functions that can utilize it and work with</span> <span data-start="973.069" data-end="978.7">it as if it's a normal API, but behind the scenes, you have a transaction</span> <span data-start="978.7" data-end="980.42">that you're dealing with.</span> <span data-start="980.42" data-end="983.319">And originally, the API was that you would just</span> <span data-start="983.319" data-end="986.91">have to pass this explicitly to every single query that you built.</span> </p>
<p><span data-start="986.91" data-end="991.23">So you had the transaction object, and then you could call commit or rollback at the very</span> <span data-start="991.23" data-end="992.23">end.</span> <span data-start="992.23" data-end="995.81">But that seemed to be kind of error-prone, that users would sort of forget</span> <span data-start="995.81" data-end="999.949">to pass it to every single query necessary, and then they would have</span> <span data-start="999.949" data-end="1004.69">sort of queries not working on the same connection, and it caused all sorts of</span> <span data-start="1004.69" data-end="1005.69">errors.</span> <span data-start="1005.69" data-end="1006.74">So this is the new API.</span> <span data-start="1006.74" data-end="1011.899">And like I said, Knex tries to make it hard to screw up, I guess.</span> <span data-start="1011.899" data-end="1015.31">And so this is a little boilerplate here  —  every time</span> <span data-start="1015.31" data-end="1020.22">we call commit and roll back, this is a promise, and then we return the promise</span> <span data-start="1020.22" data-end="1024.94">into the transaction, and we know if the entire promise chain fulfills, the</span> <span data-start="1024.94" data-end="1029.14">transaction should be committed, and if it fails, the transaction should be rolled</span> <span data-start="1029.14" data-end="1030.14">back.</span> </p>
<p><span data-start="1030.14" data-end="1031.4">So that's pretty simple.</span> <span data-start="1031.4" data-end="1033.069">Nesting transactions is new.</span> <span data-start="1033.069" data-end="1035.14">And it's the idea that you shouldn't have to</span> <span data-start="1035.14" data-end="1039.309">worry about whether the client is already inside a transaction.</span> <span data-start="1039.309" data-end="1044.1">So if you call Knex transaction on something that is already</span> <span data-start="1044.1" data-end="1048.31">a transaction Knex, it should just create a save point.</span> </p>
<p><span data-start="1048.31" data-end="1051.03">And so a save point is sort of like a save point in,</span> <span data-start="1051.03" data-end="1052.03">like, a video game.</span> <span data-start="1052.03" data-end="1054.1">Where you get to a certain point, and if something fails</span> <span data-start="1054.1" data-end="1057.48">beyond that, you don't go back to the very beginning, but you go back to just</span> <span data-start="1057.48" data-end="1059.15">right here.</span> <span data-start="1059.15" data-end="1061.32">And so it does this transparently.</span> <span data-start="1061.32" data-end="1063.34">You know, for you.</span> <span data-start="1063.34" data-end="1067.49">And you don't have to worry about it too much.</span> <span data-start="1067.49" data-end="1071.77">So Knex likes to take what I call the batteries included approach, where it does a lot of</span> <span data-start="1071.77" data-end="1076.39">this for you, and also provides a lot of different interfaces, like callbacks</span> <span data-start="1076.39" data-end="1081.15">and streams and events, and two string  —  the different things you would want</span> <span data-start="1081.15" data-end="1084.79">to work with in a nice manner.</span> <span data-start="1084.79" data-end="1087.02">So that's pretty much just a high level overview of Knex.</span> <span data-start="1087.02" data-end="1088.97">And now I'm going to jump into bookshelf.</span> </p>
<p><span data-start="1088.97" data-end="1093.67">Which is an ORM, which stands for object relational mapper.</span> <span data-start="1093.67" data-end="1097.85">And in short what that tries to do is take care of standard SQL</span> <span data-start="1097.85" data-end="1100.89">queries for you, especially in common app operations.</span> <span data-start="1100.89" data-end="1104.25">So when you're building an app, there's a lot of things that are pretty</span> <span data-start="1104.25" data-end="1105.25">standard.</span> <span data-start="1105.25" data-end="1111.08">Like insert, return, fetch, save, dealing with  —  relating different</span> <span data-start="1111.08" data-end="1114.37">rows of data.</span> <span data-start="1114.37" data-end="1116.559">And you don't want to have to write all of this by hand.</span> <span data-start="1116.559" data-end="1119.99">So it sort of abstracts that a little bit for you, and takes a little bit</span> <span data-start="1119.99" data-end="1126.07">of the flexibility away, but gives you a nicer, higher level piece to work with.</span> <span data-start="1126.07" data-end="1129.99">So the different association types  —  pretty familiar if you've ever worked</span> <span data-start="1129.99" data-end="1132.63">with an ORM in another language.</span> <span data-start="1132.63" data-end="1134.68">One to one, one to many, many to many.</span> <span data-start="1134.68" data-end="1138.701">Polymorphic  —  I don't know if these are necessarily a great idea, but</span> <span data-start="1138.701" data-end="1140.12">sometimes they can be useful, I guess.</span> </p>
<p><span data-start="1140.12" data-end="1141.8">So it supports those.</span> <span data-start="1141.8" data-end="1143.01">And it builds on top of Knex.</span> <span data-start="1143.01" data-end="1145.33">So that's where I was talking about having a separation between</span> <span data-start="1145.33" data-end="1147.98">a query building layer and an ORM layer.</span> <span data-start="1147.98" data-end="1151.13">You should be able to write raw SQL when you want and have</span> <span data-start="1151.13" data-end="1156">something that works on top of that and also allows you to drop back into it</span> <span data-start="1156" data-end="1157.58">when you need.</span> <span data-start="1157.58" data-end="1160.48">So this is sort of what it looks like, to create a few models</span> <span data-start="1160.48" data-end="1162.679">with associations.</span> </p>
<p><span data-start="1162.679" data-end="1166.6">And you can also sort of filter with..</span> <span data-start="1166.6" data-end="1169.52">So here we have comments, which is has many to a comment,</span> <span data-start="1169.52" data-end="1176.37">but we also have moderated comments, and we can add in the where-moderated is true.</span> <span data-start="1176.37" data-end="1182.539">And it also supports loading where you're trying to add data to a collection</span> <span data-start="1182.539" data-end="1188.45">of data, if you have 26 items, you have 26 extra queries, so it tries to</span> <span data-start="1188.45" data-end="1192.71">do one and then another query for the extra related results.</span> <span data-start="1192.71" data-end="1196.02">An example here is to find an account with all the</span> <span data-start="1196.02" data-end="1200.39">posts in the account, and then all the comments under those posts and all the</span> <span data-start="1200.39" data-end="1204.88">accounts that actually made the comments on the posts for the account.</span> <span data-start="1204.88" data-end="1209.1">So that's what that it would look like, to provide</span> <span data-start="1209.1" data-end="1212.38">with-related, and this is all in the documentation.</span> </p>
<p><span data-start="1212.38" data-end="1216.24">So I'm going to jump through this a little bit.</span> <span data-start="1216.24" data-end="1223.46">Also, as you constrain your loads, you can dynamically constrain relations,</span> <span data-start="1223.46" data-end="1225.11">and then load things after the fact.</span> <span data-start="1225.11" data-end="1229.86">So if you want to fetch one row or a collection of rows and then only load onto</span> <span data-start="1229.86" data-end="1233.38">one, it allows you to do that as well.</span> <span data-start="1233.38" data-end="1237.63">And then as I was mentioning earlier, it allows you to tap into the</span> <span data-start="1237.63" data-end="1240.88">query chain, to dynamically add things that are maybe a little more</span> <span data-start="1240.88" data-end="1246.52">SQL-specific under the hood, as you're building the select statement or other</span> <span data-start="1246.52" data-end="1249.63">statements for the model.</span> <span data-start="1249.63" data-end="1252.44">And so transactions in bookshelf aren't quite where</span> <span data-start="1252.44" data-end="1256.46">they are in Knex, where you still have to pass the explicit object to each of</span> <span data-start="1256.46" data-end="1258.39">the async calls.</span> </p>
<p><span data-start="1258.39" data-end="1260.66">Turns out it's a little harder to retrofit that, where you</span> <span data-start="1260.66" data-end="1262.95">have a transactional bookshelf object.</span> <span data-start="1262.95" data-end="1265.501">That's where it's going in the future.</span> <span data-start="1265.501" data-end="1269.9">But transactions are absolutely supported in bookshelf.</span> <span data-start="1269.9" data-end="1272.72">And just a little bit of where bookshelf sort of came from  —  I</span> <span data-start="1272.72" data-end="1278.07">mentioned that it came from some of the ideas from backbone models and collections.</span> <span data-start="1278.07" data-end="1281.77">And ultimately the idea was to see if we could reuse some of the same models</span> <span data-start="1281.77" data-end="1284.14">on the server and client.</span> <span data-start="1284.14" data-end="1286.34">And this was back in, like, 2012, back before</span> <span data-start="1286.34" data-end="1289.86">I even knew there was a term for doing this.</span> <span data-start="1289.86" data-end="1291.11">Which I'm not going to say.</span> <span data-start="1291.11" data-end="1295.68">Because he already covered it last year.</span> </p>
<p><span data-start="1295.68" data-end="1296.74">And I actually sort of got there.</span> <span data-start="1296.74" data-end="1301.77">I was able to swap out bookshelf models and collections for, like, the backbone TodoMVC</span> <span data-start="1301.77" data-end="1304.36">and use it targeting webSQL.</span> <span data-start="1304.36" data-end="1306.36">Which was kind of cool.</span> <span data-start="1306.36" data-end="1307.789">I don't know.</span> <span data-start="1307.789" data-end="1310.159">I built a to-do list.</span> <span data-start="1310.159" data-end="1312.07">And that's pretty special.</span> <span data-start="1312.07" data-end="1316.01">But really, I think, shared models sound great, but it's not really</span> <span data-start="1316.01" data-end="1320.82">as great in practice, because you have to know a lot more  —  or there's sort</span> <span data-start="1320.82" data-end="1322.159">of a limit to what you can do.</span> </p>
<p><span data-start="1322.159" data-end="1326.13">You have to load all the data, and lose out on</span> <span data-start="1326.13" data-end="1327.169">a lot.</span> <span data-start="1327.169" data-end="1330.89">Because you don't need as much of what you would need on the server on</span> <span data-start="1330.89" data-end="1332.65">the client, if you're just displaying it.</span> <span data-start="1332.65" data-end="1333.65">So it sounds great.</span> <span data-start="1333.65" data-end="1334.65">Not as great in practice.</span> <span data-start="1334.65" data-end="1337.15">And it's something that I'm sort of moving away from, some of the</span> <span data-start="1337.15" data-end="1342.63">model and collection conventions from backbone, based on some of the things</span> <span data-start="1342.63" data-end="1346.04">that I've learned, having been out there for a little while.</span> <span data-start="1346.04" data-end="1347.059">So you can read more in the docs.</span> <span data-start="1347.059" data-end="1349.63">I'm not going to go too much further into it.</span> <span data-start="1349.63" data-end="1351.6">But I think one thing I would like to point out is that</span> <span data-start="1351.6" data-end="1354.49">Knex and bookshelf are not the first to do this.</span> <span data-start="1354.49" data-end="1358.46">So I mentioned earlier there was already higher level SQL</span> <span data-start="1358.46" data-end="1361.77">abstractions in JavaScript that I saw, and I was like  —  oh, I'll build these</span> <span data-start="1361.77" data-end="1362.99">instead.</span> </p>
<p><span data-start="1362.99" data-end="1364.46">And hopefully it's not the last to do this.</span> <span data-start="1364.46" data-end="1369.22">So a few other projects  —  openrecord is a really great project that's</span> <span data-start="1369.22" data-end="1374.2">using Knex under the hood, and it provides more of an active record syntax.</span> <span data-start="1374.2" data-end="1378.9">And SQLize is the big one, and is still a big one.</span> <span data-start="1378.9" data-end="1381.71">And it didn't have support for transactions.</span> <span data-start="1381.71" data-end="1383.789">It had a really..</span> <span data-start="1383.789" data-end="1385.48">The APIs were sort of rough.</span> <span data-start="1385.48" data-end="1387.33">And since then, it's come a long way.</span> <span data-start="1387.33" data-end="1389.929">I've been really impressed with a lot of the development happening with</span> <span data-start="1389.929" data-end="1390.929">SQLize.</span> <span data-start="1390.929" data-end="1393.49">So if you haven't looked at it for a while, take another look.</span> <span data-start="1393.49" data-end="1396.53">They're doing cool things, especially around the new</span> <span data-start="1396.53" data-end="1400.93">postgres features that are coming out.</span> <span data-start="1400.93" data-end="1405.74">A new one that I just saw recently, by someone who had been frequently</span> <span data-start="1405.74" data-end="1410.83">commenting on bookshelf and Knex projects, and I guess maybe had some opinions</span> <span data-start="1410.83" data-end="1414.27">that were different, created this Zuul.JS.</span> </p>
<p><span data-start="1414.27" data-end="1416.11">And it's really impressive.</span> <span data-start="1416.11" data-end="1419.179">It does transactions, doesn't have quite the separation</span> <span data-start="1419.179" data-end="1423.75">between the query building and the ORM layer, but does a lot for you at the</span> <span data-start="1423.75" data-end="1424.75">ORM layer.</span> <span data-start="1424.75" data-end="1426.89">That's worth checking out.</span> <span data-start="1426.89" data-end="1432.01">SQL bricks is pretty similar to Knex, but with different opinions.</span> <span data-start="1432.01" data-end="1438.72">NodeSQL, by the guy who does the postgres driver.</span> <span data-start="1438.72" data-end="1444.61">Even the drivers have come a long way since I looked at them in 2012.</span> <span data-start="1444.61" data-end="1450.96">The node my SQL driver has a ton of documentation and a lot of features added.</span> <span data-start="1450.96" data-end="1457.779">It's really impressive how far it's come in the last few years.</span> <span data-start="1457.779" data-end="1459.89">Knex query lab allows you to demo this in the</span> <span data-start="1459.89" data-end="1462.45">browser and have it spit out SQL.</span> </p>
<p><span data-start="1462.45" data-end="1468.63">Bookends does nested data loading and querying really well.</span> <span data-start="1468.63" data-end="1470.58">It's on top of bookshelf.</span> <span data-start="1470.58" data-end="1478.62">And there's endpoints, a JSON API compliant library, which has Knex and</span> <span data-start="1478.62" data-end="1484.409">bookshelf under the hood, and larger stack implementations like Sails, which has</span> <span data-start="1484.409" data-end="1488.37">their own ORM, but they were potentially talking about using Knex as the</span> <span data-start="1488.37" data-end="1490.5">query builder under the hood.</span> <span data-start="1490.5" data-end="1495.83">So they're targeting all the different SQL drivers.</span> <span data-start="1495.83" data-end="1497.13">That's just some of what's out there.</span> </p>
<p><span data-start="1497.13" data-end="1499.54">But I really don't think this is enough.</span> <span data-start="1499.54" data-end="1500.61">So..</span> <span data-start="1500.61" data-end="1501.669">We're still sort of like..</span> <span data-start="1501.669" data-end="1506.13">At this stage where node is a really young ecosystem.</span> <span data-start="1506.13" data-end="1508.34">And a lot of times, you'll hear  —  don't reinvent the wheel.</span> </p>
<p><span data-start="1508.34" data-end="1509.73">Like it's already been done.</span> <span data-start="1509.73" data-end="1511.14">But I sort of disagree with this.</span> <span data-start="1511.14" data-end="1514.669">I think that people should absolutely be reinventing the wheel.</span> <span data-start="1514.669" data-end="1517.169">With an asterisk.</span> <span data-start="1517.169" data-end="1518.6">Just not on the client side.</span> <span data-start="1518.6" data-end="1520.87">Because React already did this.</span> <span data-start="1520.87" data-end="1522.87">No, I'm kidding there.</span> </p>
<p><span data-start="1522.87" data-end="1526.3">But, like, we should have more experiments out there, because I think the</span> <span data-start="1526.3" data-end="1530.95">types of conversations we're having since React are really different, about..</span> <span data-start="1530.95" data-end="1532.69">Just the web in general.</span> <span data-start="1532.69" data-end="1535.62">Because they questioned a lot of opinions.</span> <span data-start="1535.62" data-end="1538.71">So I think that  —  take a look at other libraries.</span> <span data-start="1538.71" data-end="1539.94">Take a look at other languages.</span> <span data-start="1539.94" data-end="1542.679">Which is what  —  you know, a lot of what JavaScript</span> <span data-start="1542.679" data-end="1543.679">is about.</span> <span data-start="1543.679" data-end="1546.669">JavaScript is sort of late to the party of being on the server.</span> <span data-start="1546.669" data-end="1554.09">And a lot of the great ideas coming out around async and ES7 and ES8 are looking</span> <span data-start="1554.09" data-end="1555.98">at the best of what's around in other languages.</span> <span data-start="1555.98" data-end="1558.94">So I think it's really important  —  like, as I mentioned,</span> <span data-start="1558.94" data-end="1564.179">these were adapted from the Laravel query builder in PHP, and I would like to</span> <span data-start="1564.179" data-end="1571.57">move a lot further toward SQL Alchemy and query builder.</span> </p>
<p><span data-start="1571.57" data-end="1578.64">But I would love to see node become more of a target for traditional</span> <span data-start="1578.64" data-end="1580.97">web applications.</span> <span data-start="1580.97" data-end="1585.391">Prove that Stack Overflow question wrong, and get more</span> <span data-start="1585.391" data-end="1591.179">awareness out there, that you can do this type of boring traditional website</span> <span data-start="1591.179" data-end="1597.96">development in node, and I think the more that that becomes something that's</span> <span data-start="1597.96" data-end="1601.77">well known, the more people will be writing JavaScript, and then more goes</span> <span data-start="1601.77" data-end="1602.77">into the ecosystem.</span> <span data-start="1602.77" data-end="1605.58">So that was sort of the goal of creating these two libraries,</span> <span data-start="1605.58" data-end="1608.53">to sort of say  —  hey, you can do this.</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
