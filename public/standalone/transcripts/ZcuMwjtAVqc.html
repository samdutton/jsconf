<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="web.dev LIVE video transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZcuMwjtAVqc</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/ZcuMwjtAVqc?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="34.67" data-end="36.98">I don't I don't know if many people in</span> <span data-start="36.98" data-end="39.589">this room know who I am if you don't get</span> <span data-start="39.589" data-end="41.3">this reference then that's not good and</span> <span data-start="41.3" data-end="42.89">you you gotta catch opening Jackie Chan</span> <span data-start="42.89" data-end="44.019">movies</span> <span data-start="44.019" data-end="46.219">so let's want to give a brief</span> <span data-start="46.219" data-end="48.44">introduction to myself Who I am what I</span> <span data-start="48.44" data-end="51.14">work on again my name is Jared Nichols</span> <span data-start="51.14" data-end="53.539">and I work at Sencha I work in the</span> <span data-start="53.539" data-end="57.32">center's web platform team which is like</span> <span data-start="57.32" data-end="59.149">a corporate name for the web kid team we</span> <span data-start="59.149" data-end="61.28">just do web Kitty things we work on</span> </p>
<p><span data-start="61.28" data-end="62.899">WebKit products and we can you should be</span> <span data-start="62.899" data-end="65.81">back to the WebKit project and I'm a</span> <span data-start="65.81" data-end="68.36">WebKit committer for those who don't</span> <span data-start="68.36" data-end="70.31">know what that means it just means I can</span> <span data-start="70.31" data-end="73.159">push to the repository of WebKit nothing</span> <span data-start="73.159" data-end="77.479">fancy and I'm also co work co-author of</span> <span data-start="77.479" data-end="80.509">the w3c web cryptography API this</span> <span data-start="80.509" data-end="83.75">technically doesn't exist yet it's it's</span> <span data-start="83.75" data-end="85.94">coming though the the working group is</span> <span data-start="85.94" data-end="88.25">knew it was recently chartered and it's</span> <span data-start="88.25" data-end="91.069">in the Advisory Committee stage so once</span> <span data-start="91.069" data-end="92.869">it gets out of that stage then this will</span> <span data-start="92.869" data-end="95.81">be will be a you know full steam ahead</span> <span data-start="95.81" data-end="97.429">on this and I'm working together with</span> </p>
<p><span data-start="97.429" data-end="101.21">David dolphin Mozilla on this so that's</span> <span data-start="101.21" data-end="102.92">just briefly who I am when I'm working</span> <span data-start="102.92" data-end="105.32">on but today I'm not gonna talk about</span> <span data-start="105.32" data-end="106.64">any of those things I'm talking about</span> <span data-start="106.64" data-end="109.219">something totally different JavaScript</span> <span data-start="109.219" data-end="111.53">on the GPU is there something that's</span> <span data-start="111.53" data-end="114.799">caught my fancy recently it's more or</span> <span data-start="114.799" data-end="117.979">less just a side secret pet project</span> <span data-start="117.979" data-end="119.869">experiment that I'm working on with a</span> <span data-start="119.869" data-end="122.45">couple of my own my friends today I'm</span> <span data-start="122.45" data-end="124.789">just going to talk about like why job's</span> <span data-start="124.789" data-end="126.259">getting the GPU why is that interesting</span> <span data-start="126.259" data-end="130.22">why would we want that if if any of you</span> <span data-start="130.22" data-end="131.989">were here for the first session on</span> <span data-start="131.989" data-end="133.549">Monday when you heard Stephan from Intel</span> <span data-start="133.549" data-end="137.03">talking he was he gave all the reasons</span> <span data-start="137.03" data-end="139.459">why we should care about JavaScript</span> <span data-start="139.459" data-end="141.739">running on the GPU doing data parallel</span> <span data-start="141.739" data-end="144.92">tasks so I will go over that briefly but</span> </p>
<p><span data-start="144.92" data-end="146.51">I think everybody who attended that has</span> <span data-start="146.51" data-end="149.239">the gist of it and then we're gonna talk</span> <span data-start="149.239" data-end="151.01">about getting jobs going to GPU how we</span> <span data-start="151.01" data-end="153.47">do that and the approach to that I took</span> <span data-start="153.47" data-end="157.1">it's a insane approach and we'll walk</span> <span data-start="157.1" data-end="158.6">over that and show you all the issues</span> <span data-start="158.6" data-end="161.66">that I ran to it's crazy so after you</span> <span data-start="161.66" data-end="162.44">talk about that then we talk about</span> <span data-start="162.44" data-end="163.36">what's to come</span> <span data-start="163.36" data-end="166.76">so why JavaScript the GPU again we</span> <span data-start="166.76" data-end="167.67">already kind of covered that</span> <span data-start="167.67" data-end="170.13">but they're really that there's two</span> <span data-start="170.13" data-end="172.53">answers one is why not and the other</span> <span data-start="172.53" data-end="174.959">answer is there's a better question and</span> <span data-start="174.959" data-end="181.08">why the GPU the GPU is fast okay it's</span> <span data-start="181.08" data-end="182.76">fast it's not faceted everything as fast</span> <span data-start="182.76" data-end="184.83">as certain types of things and these</span> <span data-start="184.83" data-end="186.27">things are what we need to target on</span> </p>
<p><span data-start="186.27" data-end="188.7">GPUs and they're fast because there are</span> <span data-start="188.7" data-end="190.38">totally different paradigm their</span> <span data-start="190.38" data-end="191.489">architectures totally different from</span> <span data-start="191.489" data-end="194.1">CPUs they're geared towards data</span> <span data-start="194.1" data-end="197.55">parallel tasks and stream processing so</span> <span data-start="197.55" data-end="199.67">taking a stream or set of data</span> <span data-start="199.67" data-end="202.56">performing operations on every element</span> <span data-start="202.56" data-end="205.47">of that that set of data and doing it</span> <span data-start="205.47" data-end="207.299">all in parallel and it takes a</span> <span data-start="207.299" data-end="208.86">divide-and-conquer approach it has many</span> <span data-start="208.86" data-end="212.04">small working stream processing units to</span> <span data-start="212.04" data-end="215.91">to do this and each of those processing</span> <span data-start="215.91" data-end="217.769">users you can say that it can run a</span> <span data-start="217.769" data-end="221.58">thread of general-purpose code and for</span> <span data-start="221.58" data-end="224.01">example on my on my laptop here my HCI</span> </p>
<p><span data-start="224.01" data-end="226.769">Radeon has four engines 480 stream</span> <span data-start="226.769" data-end="228.66">processing unit sources effectively 480</span> <span data-start="228.66" data-end="230.31">small little cores to do something for</span> <span data-start="230.31" data-end="233.37">us on my mac pro back to my office that</span> <span data-start="233.37" data-end="237.57">has like 1600 so you can imagine how</span> <span data-start="237.57" data-end="239.94">much you can get done at one time on</span> <span data-start="239.94" data-end="242.549">these on these GPUs in general they have</span> <span data-start="242.549" data-end="244.53">a high memory bandwidth a lot higher</span> <span data-start="244.53" data-end="246.63">than system memory</span> <span data-start="246.63" data-end="248.64">most of the advertised values are</span> <span data-start="248.64" data-end="250.2">theoretical so you have to take</span> <span data-start="250.2" data-end="252">advantage of the GPU 100% to get to</span> <span data-start="252" data-end="254.34">those values but in general the</span> <span data-start="254.34" data-end="255.81">bandwidth is much faster than you know</span> <span data-start="255.81" data-end="258.69">system memory to a CPU and they can</span> <span data-start="258.69" data-end="260.489">they're specialized you know they were</span> <span data-start="260.489" data-end="264.06">made for mathematical operations</span> <span data-start="264.06" data-end="266.4">particularly with you know games and</span> <span data-start="266.4" data-end="268.71">they had to specialize in processing</span> <span data-start="268.71" data-end="270.84">floating-point operations really fast</span> <span data-start="270.84" data-end="274.11">and a lot of them at same time but they</span> <span data-start="274.11" data-end="276.06">don't solve all problems again they you</span> <span data-start="276.06" data-end="277.86">can't just throw any task or any any</span> <span data-start="277.86" data-end="279.63">problem at a GPU and expect it to go</span> <span data-start="279.63" data-end="282.03">faster it's just a that's that's a false</span> <span data-start="282.03" data-end="284.88">statement so they have you have to throw</span> <span data-start="284.88" data-end="287.52">something a problem set that can be run</span> <span data-start="287.52" data-end="290.16">in parallel homogeneous if you will</span> <span data-start="290.16" data-end="292.44">side-effect free Stephan cover this well</span> <span data-start="292.44" data-end="295.289">so I won't go any further so I just</span> <span data-start="295.289" data-end="297.84">asked myself a question how well would</span> <span data-start="297.84" data-end="299.66">jobs could run on the GPU if we throw</span> </p>
<p><span data-start="299.66" data-end="303.2">JavaScript running GPU let's I just want</span> <span data-start="303.2" data-end="304.43">to know how that would happen all right</span> <span data-start="304.43" data-end="306.08">how well would that work so we're gonna</span> <span data-start="306.08" data-end="310.01">find out so a couple buddies of mine who</span> <span data-start="310.01" data-end="311.78">work Accenture as well we decided to</span> <span data-start="311.78" data-end="313.1">start a little experiment we codenamed a</span> <span data-start="313.1" data-end="316.4">lateral Jas and that experiment was to</span> <span data-start="316.4" data-end="318.32">get JavaScript as a first-class citizen</span> <span data-start="318.32" data-end="323.81">on GPUs to run 100% compliant and to</span> <span data-start="323.81" data-end="325.37">take advantage of the GPUs in certain</span> <span data-start="325.37" data-end="327.68">ways to do data parallelization and</span> <span data-start="327.68" data-end="331.28">accelerate operations like native native</span> <span data-start="331.28" data-end="332.9">floating point operations instructions</span> <span data-start="332.9" data-end="335.84">built right into the hardware so we had</span> <span data-start="335.84" data-end="338.09">two options to get a general-purpose</span> <span data-start="338.09" data-end="341.42">you know whatever to run JavaScript on</span> <span data-start="341.42" data-end="344.81">only GPU those two options were open CL</span> <span data-start="344.81" data-end="349.16">and Nvidia CUDA and it's it's</span> <span data-start="349.16" data-end="350.9">interesting how we how we chose what we</span> <span data-start="350.9" data-end="353.27">did we went over a list and Nvidia CUDA</span> <span data-start="353.27" data-end="355.79">has a lot of great abilities basically</span> <span data-start="355.79" data-end="357.26">you can write a lot of general-purpose</span> <span data-start="357.26" data-end="360.26">code and it will run on these GPUs but</span> <span data-start="360.26" data-end="361.76">it's only for NVIDIA hardware and we</span> <span data-start="361.76" data-end="363.5">want to kind of make this stuff run on</span> <span data-start="363.5" data-end="366.89">all hardware all variable GPUs OpenCL</span> <span data-start="366.89" data-end="370.61">accomplishes that and it has support and</span> <span data-start="370.61" data-end="373.52">drivers for eight AMD Harbor and video</span> <span data-start="373.52" data-end="374.81">hardware and even Intel like a</span> <span data-start="374.81" data-end="377.93">celebrator processors but everything</span> <span data-start="377.93" data-end="379.28">else about OpenGL sucks</span> <span data-start="379.28" data-end="381.98">it's a terrible version of C you can't</span> <span data-start="381.98" data-end="383.99">have dynamic memory you have no</span> <span data-start="383.99" data-end="385.58">recursion available all functions are in</span> <span data-start="385.58" data-end="388.01">line no function pointers there's no</span> <span data-start="388.01" data-end="390.05">tooling like really hardly any tolling</span> <span data-start="390.05" data-end="393.02">the Intel XDK is pretty good but I mean</span> <span data-start="393.02" data-end="394.7">the tolling is just far behind on videos</span> <span data-start="394.7" data-end="396.95">and it's a little bit mature it's a</span> <span data-start="396.95" data-end="399.74">newer newer open standard but we went</span> <span data-start="399.74" data-end="400.76">ahead and chose up and see all the one</span> <span data-start="400.76" data-end="401.87">that sounded like a complete nightmare</span> <span data-start="401.87" data-end="405.5">so we really wanted to target all those</span> <span data-start="405.5" data-end="407.419">different GPUs but really the truth of</span> <span data-start="407.419" data-end="412.01">it is our Mac books had AMD cards so we</span> <span data-start="412.01" data-end="416.57">had to work with that so we had a couple</span> <span data-start="416.57" data-end="417.8">of different routes were gonna take and</span> <span data-start="417.8" data-end="418.73">the first one was doing a static</span> <span data-start="418.73" data-end="420.5">compiler which is exactly where River</span> </p>
<p><span data-start="420.5" data-end="422.45">Trail from Intel does it statically</span> <span data-start="422.45" data-end="424.51">compiled JavaScript into up and CL code</span> <span data-start="424.51" data-end="427.11">but we chose not to go that route</span> <span data-start="427.11" data-end="429.12">for one we wanted full JavaScript</span> <span data-start="429.12" data-end="431.28">support we wanted objects and prototypes</span> <span data-start="431.28" data-end="434.61">closures recursion variable typing all</span> <span data-start="434.61" data-end="436.11">the things you get with JavaScript we</span> <span data-start="436.11" data-end="437.759">want you know compliant JavaScript to</span> <span data-start="437.759" data-end="441.9">run on this on the GPUs and to</span> <span data-start="441.9" data-end="443.849">accomplish a really good stack of holo</span> <span data-start="443.849" data-end="444.99">you have to do a lot of type inference</span> <span data-start="444.99" data-end="446.789">which is pretty limiting it can be</span> <span data-start="446.789" data-end="449.22">solved for some cases but the rabbit</span> <span data-start="449.22" data-end="450.9">hole gets pretty deep to figure it out</span> <span data-start="450.9" data-end="453.27">stuff out statically and you know if you</span> <span data-start="453.27" data-end="455.639">if you have a really good static</span> <span data-start="455.639" data-end="456.87">compiler can figure stuff out you're</span> <span data-start="456.87" data-end="458.31">basically at that point interpreting the</span> <span data-start="458.31" data-end="461.97">code so that compilers are tough to</span> <span data-start="461.97" data-end="463.56">solve all those problems and get 100%</span> <span data-start="463.56" data-end="467.159">applying JavaScript running so again</span> <span data-start="467.159" data-end="468.96">with the sac compiler you're kind of</span> <span data-start="468.96" data-end="471.21">limited to those kernel size functions</span> <span data-start="471.21" data-end="473.37">which are perfect for you know doing</span> <span data-start="473.37" data-end="475.139">these data breaking up these tasks to</span> <span data-start="475.139" data-end="477.03">homogeneous parts and and running</span> <span data-start="477.03" data-end="479.43">parallel tasks on this hardware so you</span> <span data-start="479.43" data-end="481.62">know writing a small kernel function in</span> </p>
<p><span data-start="481.62" data-end="482.789">JavaScript totally possible to</span> <span data-start="482.789" data-end="484.319">statically compiled that river turtles</span> <span data-start="484.319" data-end="486.449">doing it but we just didn't think it was</span> <span data-start="486.449" data-end="487.74">insane enough we wanted to do something</span> <span data-start="487.74" data-end="489.539">that is just totally crazy and see how</span> <span data-start="489.539" data-end="493.139">it would run so what we did was Roberto</span> <span data-start="493.139" data-end="496.02">J's interpreter and OpenCL seeing which</span> <span data-start="496.02" data-end="499.53">is really crazy and you know for the</span> <span data-start="499.53" data-end="501.33">reasons reasons why we did that it's</span> <span data-start="501.33" data-end="502.349">just the opposite of what I just said</span> <span data-start="502.349" data-end="504.419">you know we can run full JavaScript it's</span> <span data-start="504.419" data-end="506.49">it is insane we have no idea how it was</span> <span data-start="506.49" data-end="507.9">going to perform we know wasn't gonna be</span> <span data-start="507.9" data-end="509.639">great we just want to see how it work</span> <span data-start="509.639" data-end="514.02">right and you know it is a challenge it</span> <span data-start="514.02" data-end="515.339">would be a challenge to make that happen</span> <span data-start="515.339" data-end="516.93">especially with all the deficiencies in</span> </p>
<p><span data-start="516.93" data-end="519.81">OpenCL so we thought it'd be fun and</span> <span data-start="519.81" data-end="521.459">then if you can make it at least work</span> <span data-start="521.459" data-end="522.75">then we can make it better and actually</span> <span data-start="522.75" data-end="524.01">make it you know something that is</span> <span data-start="524.01" data-end="526.829">practical to use to solve real world</span> <span data-start="526.829" data-end="529.17">problems so first we talk about all the</span> <span data-start="529.17" data-end="531.24">headaches we ran into just diving into</span> </p>
<p><span data-start="531.24" data-end="533.279">OpenCL and getting an interpreter</span> <span data-start="533.279" data-end="537.12">written as we all know the best cure for</span> <span data-start="537.12" data-end="538.47">headache is decapitation another</span> <span data-start="538.47" data-end="539.7">insanity well if I love the insanity</span> <span data-start="539.7" data-end="544.86">wolf so we ran into some issues and</span> <span data-start="544.86" data-end="548.19">here's a list of them with these</span> <span data-start="548.19" data-end="549.66">general-purpose</span> <span data-start="549.66" data-end="554.1">GPU SDKs or specs if you will they they</span> <span data-start="554.1" data-end="556.26">allow you to really optimize your code</span> <span data-start="556.26" data-end="558.6">to different memory addresses there's</span> <span data-start="558.6" data-end="560.579">multiple memory address spaces on these</span> <span data-start="560.579" data-end="563.489">on this Hong from these devices that you</span> <span data-start="563.489" data-end="565.23">can target with your code and they kind</span> <span data-start="565.23" data-end="568.23">of tear down from really fast but</span> <span data-start="568.23" data-end="570.839">limited amount to you know your entire</span> <span data-start="570.839" data-end="573.329">available vram but super slow bandwidth</span> <span data-start="573.329" data-end="575.399">right so you have all these different</span> <span data-start="575.399" data-end="578.85">options and in dealing with those</span> <span data-start="578.85" data-end="580.079">different address spaces you have to</span> <span data-start="580.079" data-end="581.549">know that you know when you're dealing</span> <span data-start="581.549" data-end="584.22">with pointers to address to addresses in</span> <span data-start="584.22" data-end="587.97">those spaces they are totally different</span> <span data-start="587.97" data-end="589.92">they're just autonomous you know sets of</span> <span data-start="589.92" data-end="591.089">memory and so when you have all these</span> <span data-start="591.089" data-end="594.299">pointers you have to fully qualify what</span> <span data-start="594.299" data-end="595.949">the pointer is pointing to so it's tough</span> <span data-start="595.949" data-end="598.769">it's this really verbose code again no</span> <span data-start="598.769" data-end="601.98">recursion all inline functions so you</span> <span data-start="601.98" data-end="602.91">know writing interpreter without</span> <span data-start="602.91" data-end="604.649">recursion it's certainly possible but</span> <span data-start="604.649" data-end="608.91">it's hard so we'll get into what we have</span> <span data-start="608.91" data-end="610.739">to do with that and there's no standard</span> </p>
<p><span data-start="610.739" data-end="613.799">Lipsy libraries whatsoever I mean you're</span> <span data-start="613.799" data-end="616.139">stuck with nothing really you don't have</span> <span data-start="616.139" data-end="618.989">you know mem coffee or string age or and</span> <span data-start="618.989" data-end="620.629">you know any of that stuff it's not good</span> <span data-start="620.629" data-end="623.85">no dynamic memory again so what do you</span> <span data-start="623.85" data-end="625.11">do with no I mean you can't do you can</span> <span data-start="625.11" data-end="627.449">allocate memory okay so what do you do I</span> <span data-start="627.449" data-end="631.769">mean and then you know they don't have</span> <span data-start="631.769" data-end="632.939">any standard data structures they do</span> <span data-start="632.939" data-end="635.66">have like vector you know for numeric</span> <span data-start="635.66" data-end="638.61">values that you can do vector operations</span> <span data-start="638.61" data-end="639.899">which you know harbors tuned for that</span> <span data-start="639.899" data-end="641.489">but apart from that they don't have like</span> <span data-start="641.489" data-end="643.41">standard data structures like stacks and</span> <span data-start="643.41" data-end="645.47">queues and linkless and so like that so</span> <span data-start="645.47" data-end="648.389">and then in general OpenCL since it's so</span> <span data-start="648.389" data-end="650.22">fresh you know the compilers with the</span> <span data-start="650.22" data-end="651.509">drivers are pretty buggy they have</span> <span data-start="651.509" data-end="653.189">problems they have memory alignment</span> <span data-start="653.189" data-end="655.199">issues it was a nightmare trying to get</span> <span data-start="655.199" data-end="657.179">this thing get this thing working so in</span> <span data-start="657.179" data-end="658.98">general it's bananas there's totally</span> <span data-start="658.98" data-end="661.919">bananas so real quick the memory space</span> <span data-start="661.919" data-end="664.259">is you have private which is very fast</span> <span data-start="664.259" data-end="666.54">it's like cache on each individual</span> <span data-start="666.54" data-end="668.339">processing core in the in the hardware</span> <span data-start="668.339" data-end="670.98">effectively it's super fast but you only</span> <span data-start="670.98" data-end="673.1">get about 64k of the per working onion</span> <span data-start="673.1" data-end="675.689">then you have local memory which is also</span> <span data-start="675.689" data-end="677.73">fast it's available to a group but</span> <span data-start="677.73" data-end="679.589">limited again like 64 K on average</span> <span data-start="679.589" data-end="681.11">depending on the harbor and the drivers</span> <span data-start="681.11" data-end="682.98">then you have global memory which is</span> <span data-start="682.98" data-end="684.809">basically all of your available vrm it's</span> <span data-start="684.809" data-end="686.999">slow much much much much much lower than</span> <span data-start="686.999" data-end="690.539">private or local memory but it's</span> <span data-start="690.539" data-end="692.64">available to you know every available</span> <span data-start="692.64" data-end="693.84">work item that's running for that</span> <span data-start="693.84" data-end="698.37">particular kernel on the device so to</span> <span data-start="698.37" data-end="699.57">talk about let you know to go a little</span> <span data-start="699.57" data-end="701.85">more detail but the pointer problems we</span> <span data-start="701.85" data-end="703.88">had with these different address spaces</span> <span data-start="703.88" data-end="707.64">you have to fully qualify pointers to a</span> <span data-start="707.64" data-end="709.32">particular address space if you don't</span> <span data-start="709.32" data-end="710.78">qualify it then it's implied to be</span> <span data-start="710.78" data-end="713.22">living in the private very pointing to</span> <span data-start="713.22" data-end="715.95">address in private memory and so when</span> <span data-start="715.95" data-end="718.41">you write functions you have to fully</span> <span data-start="718.41" data-end="719.85">qualify the incoming pointer if you're</span> <span data-start="719.85" data-end="722.99">passing a pointer to a function and that</span> <span data-start="722.99" data-end="726.51">gets kind of nuts so that you can see</span> <span data-start="726.51" data-end="727.92">here like if you have an address for K</span> <span data-start="727.92" data-end="729.51">is pointing to different spots and</span> <span data-start="729.51" data-end="731.07">global local and private so you have to</span> <span data-start="731.07" data-end="733.11">keep that in mind you can't just turn a</span> <span data-start="733.11" data-end="735.39">global pointer into a local pointer and</span> <span data-start="735.39" data-end="736.8">expect it to work you have to copy the</span> <span data-start="736.8" data-end="741">data over so because you have to fully</span> <span data-start="741" data-end="742.92">qualify all these dress spaces it just</span> <span data-start="742.92" data-end="744.33">got really redundant so we create some</span> <span data-start="744.33" data-end="746.31">macros to help us out and keep the code</span> <span data-start="746.31" data-end="750.27">a little bit shorter now no recursion so</span> <span data-start="750.27" data-end="752.34">there's no call stack and I don't know</span> <span data-start="752.34" data-end="753.6">whether it's a chicken and egg omelet</span> <span data-start="753.6" data-end="755.33">there's no call checkers are in lined or</span> <span data-start="755.33" data-end="757.32">they're in lining it because there's no</span> <span data-start="757.32" data-end="758.81">call stack I don't know what it is but</span> <span data-start="758.81" data-end="761.13">you can't write recursive functions</span> <span data-start="761.13" data-end="763.53">again no standard Lib C libraries new</span> <span data-start="763.53" data-end="765.93">mem copy string copy string compare so</span> <span data-start="765.93" data-end="768.53">we just implemented that ourselves</span> <span data-start="768.53" data-end="772.89">now we had to do this really strangely</span> <span data-start="772.89" data-end="775.05">we had to actually write these functions</span> <span data-start="775.05" data-end="778.23">as macros and then create a whole bunch</span> <span data-start="778.23" data-end="780.59">of versions of the same function but</span> <span data-start="780.59" data-end="782.15">using different address spaces</span> <span data-start="782.15" data-end="784.74">qualifying different address spaces so</span> <span data-start="784.74" data-end="786.84">you can see that this macro will produce</span> <span data-start="786.84" data-end="789.21">12 different copies of this M copy</span> <span data-start="789.21" data-end="791.46">function which is kind of it kind of</span> <span data-start="791.46" data-end="793.02">sucks because I mean these functions are</span> <span data-start="793.02" data-end="795.75">all in line when they're used so I was</span> <span data-start="795.75" data-end="797.94">taking up a lot of space but that's what</span> <span data-start="797.94" data-end="799.44">you have to do to make this clean and be</span> <span data-start="799.44" data-end="801.38">able to just cleanly pass in a</span> <span data-start="801.38" data-end="803.61">destination of a global pointer and a</span> <span data-start="803.61" data-end="805.38">source of a private pointer and just</span> <span data-start="805.38" data-end="806.85">have it work I mean I don't at</span> <span data-start="806.85" data-end="808.86">development I'm you know which what your</span> <span data-start="808.86" data-end="810.42">source and destination is and so you can</span> <span data-start="810.42" data-end="813.3">say I want to do mem copy underscore GP</span> <span data-start="813.3" data-end="815.49">and it'll just work you want to do like</span> <span data-start="815.49" data-end="819.27">casting and whatnot so so we had to do</span> <span data-start="819.27" data-end="821.82">this for every single Lib C function</span> <span data-start="821.82" data-end="823.08">that we implemented which is all a</span> <span data-start="823.08" data-end="824.2">string age some of</span> <span data-start="824.2" data-end="827.44">etc so it's kind of nuts no dying</span> <span data-start="827.44" data-end="829.45">memories a new mouth no free what to do</span> <span data-start="829.45" data-end="833.139">do it ourselves so we had to create a</span> <span data-start="833.139" data-end="834.94">large buffle of buffer excuse me of</span> <span data-start="834.94" data-end="836.709">global memory which would just call our</span> <span data-start="836.709" data-end="838.389">heap it's our virtual heap if you will</span> <span data-start="838.389" data-end="840.66">and we inflated our own malloc and free</span> <span data-start="840.66" data-end="842.74">we had to create our own pointer uh</span> <span data-start="842.74" data-end="844.63">excuse me uh handle system is like a</span> <span data-start="844.63" data-end="847.24">smart pointer that kind of points like a</span> <span data-start="847.24" data-end="849.639">virtual memory right and we had to do</span> <span data-start="849.639" data-end="851.889">that because as soon as you free data</span> <span data-start="851.889" data-end="853.51">and we decide we win the kind of</span> <span data-start="853.51" data-end="856.93">compressed data or rearrange it much</span> <span data-start="856.93" data-end="860.019">like an OS would do pointers would be</span> <span data-start="860.019" data-end="862.12">immediately invalidated they wouldn't</span> <span data-start="862.12" data-end="863.56">point to the right data anymore so we</span> <span data-start="863.56" data-end="866.26">had to create a handle and every time</span> <span data-start="866.26" data-end="867.73">you wanted to do something with the</span> <span data-start="867.73" data-end="870.16">handle put data or read data from it you</span> <span data-start="870.16" data-end="871.57">had to get the pointer out of the handle</span> <span data-start="871.57" data-end="873.459">and that pointer always be the right you</span> <span data-start="873.459" data-end="874.66">know point to the right spot and then</span> <span data-start="874.66" data-end="877.57">you could do something with it so that's</span> <span data-start="877.57" data-end="880.99">what we had to do it's interesting but</span> <span data-start="880.99" data-end="882.399">um I'll tell you what</span> <span data-start="882.399" data-end="883.99">doing that I got a lot of these screens</span> </p>
<p><span data-start="883.99" data-end="886.92">I definitely had a lot of memory issues</span> <span data-start="886.92" data-end="890.26">and infinite loops and things like that</span> <span data-start="890.26" data-end="893.62">yeah so I saw this I can't remember how</span> <span data-start="893.62" data-end="894.699">many times out of restart my computer</span> <span data-start="894.699" data-end="896.529">it's fun so you go I get the point</span> <span data-start="896.529" data-end="897.579">there's a lot of headaches for doing</span> <span data-start="897.579" data-end="902.199">this so finally we solved these problems</span> <span data-start="902.199" data-end="903.67">OpenCL and now we're actually getting to</span> <span data-start="903.67" data-end="905.8">what we wanted to do so we create out of</span> <span data-start="905.8" data-end="907.6">a architecture of this host that runs in</span> <span data-start="907.6" data-end="909.76">a process and the host has an embedded</span> <span data-start="909.76" data-end="912.07">v8 engine that runs the Escrima parser</span> <span data-start="912.07" data-end="916.089">everybody here saw Paul Irish talk about</span> <span data-start="916.089" data-end="918.22">ass prima a little bit already out he</span> <span data-start="918.22" data-end="919.839">he's a colleague of mine he wrote a</span> <span data-start="919.839" data-end="922.24">stream into JavaScript parser it's super</span> <span data-start="922.24" data-end="923.68">fast so we're using that to generate the</span> <span data-start="923.68" data-end="926.74">ast of incoming JavaScript then we had</span> <span data-start="926.74" data-end="927.67">like a little module in the host that</span> <span data-start="927.67" data-end="930.64">does data serialization to and from the</span> <span data-start="930.64" data-end="933.88">device and then a device manager so you</span> <span data-start="933.88" data-end="937.51">can actually send JavaScript at the same</span> <span data-start="937.51" data-end="939.73">time to different available devices on</span> <span data-start="939.73" data-end="941.769">the system to get multiple GPUs they can</span> <span data-start="941.769" data-end="944.079">manage that on the GPU side then we have</span> <span data-start="944.079" data-end="946.269">our data heat that I've talked about a</span> <span data-start="946.269" data-end="948.55">slow terrible stack based interpreter</span> <span data-start="948.55" data-end="951.069">well we'll get into that and then a</span> <span data-start="951.069" data-end="952.72">garbage collector so like the whole</span> <span data-start="952.72" data-end="955.87">interpreters on the GPU and the host is</span> <span data-start="955.87" data-end="957.55">basically just sending commands and</span> <span data-start="957.55" data-end="960.73">things like that so what happens today's</span> <span data-start="960.73" data-end="962.35">we get some code we're going to evaluate</span> <span data-start="962.35" data-end="964.899">it it builds a json AST we convert that</span> <span data-start="964.899" data-end="967.72">to a friendly c structure so we can</span> <span data-start="967.72" data-end="970.209">easily read it over in the the open CL</span> <span data-start="970.209" data-end="973.81">sign and we shipped the command say</span> <span data-start="973.81" data-end="976.329">interpret this ast to the GPU and we get</span> <span data-start="976.329" data-end="980.86">the result back so AST generation this</span> <span data-start="980.86" data-end="981.819">is kind of how it works</span> </p>
<p><span data-start="981.819" data-end="983.829">Java goes in this premium we get the v8</span> <span data-start="983.829" data-end="985.779">object out we enumerate the v8 object</span> <span data-start="985.779" data-end="987.79">convert it to see structures and then we</span> <span data-start="987.79" data-end="990.67">send the C structures over as one big</span> <span data-start="990.67" data-end="992.529">memory blob to the GPU so we can work</span> <span data-start="992.529" data-end="994.839">with that we're we already put up with</span> <span data-start="994.839" data-end="995.98">enough we're not gonna write a JSON</span> <span data-start="995.98" data-end="997.779">parser and OpenCL see it's not gonna</span> <span data-start="997.779" data-end="998.11">happen</span> <span data-start="998.11" data-end="1001.769">so so the first thing is embedding the</span> <span data-start="1001.769" data-end="1003.54">stream of us so we very like a quick you</span> <span data-start="1003.54" data-end="1005.16">know a resource generator all does it</span> <span data-start="1005.16" data-end="1007.199">take the file in spits out you know a</span> <span data-start="1007.199" data-end="1009.089">string of all the bytes and then we can</span> <span data-start="1009.089" data-end="1011.67">use it inside of our code compiling a</span> <span data-start="1011.67" data-end="1012.959">stream of running after the first time</span> <span data-start="1012.959" data-end="1014.79">which initializes it and now it's ready</span> <span data-start="1014.79" data-end="1016.8">to parse something so that's the agency</span> <span data-start="1016.8" data-end="1019.199">generator initializing itself then you</span> <span data-start="1019.199" data-end="1020.339">can throw anything out you can throw</span> </p>
<p><span data-start="1020.339" data-end="1022.41">JavaScript at it so here's an example of</span> <span data-start="1022.41" data-end="1026.339">a variable declaration XYZ and it's just</span> <span data-start="1026.339" data-end="1028.35">it's a new expression for array of a</span> <span data-start="1028.35" data-end="1031.62">size 10 this is the function experiment</span> <span data-start="1031.62" data-end="1033.809">parse and if you don't if you never work</span> <span data-start="1033.809" data-end="1036.089">the v8 then it all it's doing is calling</span> <span data-start="1036.089" data-end="1037.74">a spring MoDOT parse passing in the</span> <span data-start="1037.74" data-end="1039.9">JavaScript string getting a v8 object</span> <span data-start="1039.9" data-end="1042.329">out and the v8 object holds</span> <span data-start="1042.329" data-end="1045.63">json HT that looks just like this so</span> <span data-start="1045.63" data-end="1047.429">then we have to take that and convert to</span> <span data-start="1047.429" data-end="1049.669">the lateral ast Struck's</span> <span data-start="1049.669" data-end="1054.2">so these trucks are made to you know be</span> <span data-start="1054.2" data-end="1057.24">compiled and ran on both the host and</span> <span data-start="1057.24" data-end="1059.309">the OpenCL run time so they have</span> <span data-start="1059.309" data-end="1060.84">compatible types we had to do some</span> <span data-start="1060.84" data-end="1062.88">macros to get types working you know</span> <span data-start="1062.88" data-end="1064.97">cleanly on both both sides of the fence</span> <span data-start="1064.97" data-end="1069.09">but we have an ast node structure for</span> <span data-start="1069.09" data-end="1071.88">every single node in that JSON that you</span> <span data-start="1071.88" data-end="1076.409">saw if we were to write this by hand</span> <span data-start="1076.409" data-end="1079.669">what the v8 object and numerator does it</span> <span data-start="1079.669" data-end="1081.98">would look like this it's a bunch of</span> <span data-start="1081.98" data-end="1084.33">creation calls passing in different</span> <span data-start="1084.33" data-end="1086.159">parts different nodes AFC nodes and</span> <span data-start="1086.159" data-end="1088.26">creating blocks of</span> </p>
<p><span data-start="1088.26" data-end="1091.65">ASD knows here's an example of creating</span> <span data-start="1091.65" data-end="1094.429">identifiers so we had to get the</span> <span data-start="1094.429" data-end="1096.929">calculate the size of what this identify</span> <span data-start="1096.929" data-end="1099.45">will be in total including the structure</span> <span data-start="1099.45" data-end="1100.95">size and then the string of the identify</span> <span data-start="1100.95" data-end="1102.96">itself allocate all that memory and then</span> <span data-start="1102.96" data-end="1105.33">we put the string into the right spot</span> <span data-start="1105.33" data-end="1107.52">just tuck it right after the the</span> <span data-start="1107.52" data-end="1110.25">structure so it's all one can take it as</span> <span data-start="1110.25" data-end="1112.47">you know blob memory it would look like</span> <span data-start="1112.47" data-end="1115.919">this you know size 16 name is a field in</span> <span data-start="1115.919" data-end="1116.88">the identifiers</span> <span data-start="1116.88" data-end="1118.77">structure and that just officer from the</span> <span data-start="1118.77" data-end="1120.809">beginning of the header onion excuse me</span> <span data-start="1120.809" data-end="1121.74">the beginning at the beginning of the</span> <span data-start="1121.74" data-end="1124.559">shock and and so it's pointing to 12 and</span> <span data-start="1124.559" data-end="1125.91">that 12 that's beginning of our string</span> </p>
<p><span data-start="1125.91" data-end="1129.62">XYZ in the four bytes another example</span> <span data-start="1129.62" data-end="1131.61">new expression is doing the same thing</span> <span data-start="1131.61" data-end="1134.82">calculate the size to fit it's solved</span> <span data-start="1134.82" data-end="1138.36">nodes into the the new expression blob</span> <span data-start="1138.36" data-end="1141.09">and then it's copying all that in and so</span> <span data-start="1141.09" data-end="1142.08">this was it would look like this in</span> <span data-start="1142.08" data-end="1144.21">memory you know it's a total size of 50</span> <span data-start="1144.21" data-end="1147.33">tube lights you have offsets for qwali</span> <span data-start="1147.33" data-end="1149.7">20 arguments 40 and then at 20 and 40</span> <span data-start="1149.7" data-end="1152.549">you you have those structures there in</span> <span data-start="1152.549" data-end="1155.22">place so you can enumerate down if you</span> <span data-start="1155.22" data-end="1159.299">will so lateral ast structs there again</span> <span data-start="1159.299" data-end="1161.16">they're shared across both the hosts in</span> <span data-start="1161.16" data-end="1162.809">the observer one time the host right</span> <span data-start="1162.809" data-end="1165.12">stinkin creates them slowly and then the</span> <span data-start="1165.12" data-end="1166.83">runtime is strictly reading down</span> <span data-start="1166.83" data-end="1170.52">traversing it and it's really important</span> <span data-start="1170.52" data-end="1172.26">that we did this as continuous blobs as</span> <span data-start="1172.26" data-end="1174.75">you saw so that it was easy to send the</span> <span data-start="1174.75" data-end="1176.34">gpo you're basically sending from byte</span> <span data-start="1176.34" data-end="1179.22">you know start to bite end or a byte</span> <span data-start="1179.22" data-end="1181.52">start this many bytes and it's one</span> <span data-start="1181.52" data-end="1183.84">operation the Santa GPS we only have to</span> <span data-start="1183.84" data-end="1185.49">go through the drivers and sent it a</span> <span data-start="1185.49" data-end="1187.14">device one time the whole entire thing</span> <span data-start="1187.14" data-end="1189.72">as opposed to you know following a bunch</span> <span data-start="1189.72" data-end="1191.84">of pointers doing a bunch of writing so</span> <span data-start="1191.84" data-end="1194.22">and it's still simple a diverse on the</span> <span data-start="1194.22" data-end="1195.89">open CL side with a pointer arithmetic</span> <span data-start="1195.89" data-end="1197.79">so now we're gonna get the de sac base</span> <span data-start="1197.79" data-end="1200.22">interpreter this is where it gets fun</span> <span data-start="1200.22" data-end="1203.1">we had some building blocks this is all</span> <span data-start="1203.1" data-end="1206.07">stack base and it was the easiest thing</span> <span data-start="1206.07" data-end="1207.78">to do at the time because of the fact</span> <span data-start="1207.78" data-end="1212.52">that there is no recursion and we wanted</span> <span data-start="1212.52" data-end="1214.23">to get done fast we were lazy we didn't</span> <span data-start="1214.23" data-end="1216.12">do any compilation or anything so we</span> <span data-start="1216.12" data-end="1218.159">just did all stack base so there's a</span> <span data-start="1218.159" data-end="1219.78">stack for the ast traversal there's a</span> <span data-start="1219.78" data-end="1221.88">stack for call operations</span> <span data-start="1221.88" data-end="1224.58">do something with a particular part of</span> <span data-start="1224.58" data-end="1227.58">the ASD and then a return stack so after</span> <span data-start="1227.58" data-end="1229.95">you run an expression you have some sort</span> <span data-start="1229.95" data-end="1232.53">of result after that we push those</span> <span data-start="1232.53" data-end="1234.57">results on to the stack so they can be</span> <span data-start="1234.57" data-end="1237.3">popped up later there's other parts that</span> <span data-start="1237.3" data-end="1240">go symbol symbol table is important and</span> <span data-start="1240" data-end="1241.29">then there's just a loop that goes</span> <span data-start="1241.29" data-end="1244.56">through these these or fills up these</span> <span data-start="1244.56" data-end="1245.91">stacks of how things off these stacks to</span> <span data-start="1245.91" data-end="1247.53">interpret a code we're gonna see how</span> <span data-start="1247.53" data-end="1248.28">that works</span> <span data-start="1248.28" data-end="1250.17">here's the kernel function that that</span> <span data-start="1250.17" data-end="1253.05">does it's the looping we basically</span> </p>
<p><span data-start="1253.05" data-end="1254.76">Traverse as far down as we can until</span> <span data-start="1254.76" data-end="1256.05">there's nothing left in the diverse</span> <span data-start="1256.05" data-end="1258.06">stack and then we start popping things</span> <span data-start="1258.06" data-end="1260.04">off the call stack and running them that</span> <span data-start="1260.04" data-end="1261.51">things in the call stack could put more</span> <span data-start="1261.51" data-end="1263.52">things on Traverse stack like a for loop</span> <span data-start="1263.52" data-end="1268.05">for example but uh it once there once</span> <span data-start="1268.05" data-end="1269.85">both stacks are empty you're done your</span> <span data-start="1269.85" data-end="1271.58">your application knows ran to completion</span> <span data-start="1271.58" data-end="1274.44">so let's quickly interpret this far x</span> <span data-start="1274.44" data-end="1277.86">equals one plus two so here's the here's</span> <span data-start="1277.86" data-end="1280.23">the ast on the Left we start with empty</span> <span data-start="1280.23" data-end="1281.55">stacks right so first we're going at the</span> <span data-start="1281.55" data-end="1282.9">variable decoration it's going to push</span> <span data-start="1282.9" data-end="1286.2">itself onto the ast stack on the next</span> <span data-start="1286.2" data-end="1288.36">loop it's gonna be popped off and its</span> <span data-start="1288.36" data-end="1290.85">job is to push the variable decorator</span> <span data-start="1290.85" data-end="1292.56">ones with this ast stack so traversing</span> <span data-start="1292.56" data-end="1294.18">down at this point we're kind of going</span> <span data-start="1294.18" data-end="1296.52">down as deeply as we can and then we'll</span> <span data-start="1296.52" data-end="1297.93">kind of pull our way back up with the</span> <span data-start="1297.93" data-end="1300.48">results and stuff so so it pushes very</span> <span data-start="1300.48" data-end="1302.91">well decorator on pebble decorator pops</span> <span data-start="1302.91" data-end="1304.74">off and pushes out the identifier and</span> <span data-start="1304.74" data-end="1306.54">the binary expression onto the SD stack</span> <span data-start="1306.54" data-end="1308.1">and then puts itself in the call stack</span> <span data-start="1308.1" data-end="1312.33">to later retrieve results then binary</span> <span data-start="1312.33" data-end="1314.52">expression is is popped off puts its</span> <span data-start="1314.52" data-end="1316.8">both of its operands onto the ast stack</span> <span data-start="1316.8" data-end="1318.9">the left and the right which are just</span> <span data-start="1318.9" data-end="1321.45">literals so one literals popped off</span> <span data-start="1321.45" data-end="1323.07">putting the call stack the next ones put</span> <span data-start="1323.07" data-end="1324.84">in the call stack and then the</span> <span data-start="1324.84" data-end="1326.97">identifiers the last thing now our ast</span> <span data-start="1326.97" data-end="1328.74">traversals done we've hit every node</span> <span data-start="1328.74" data-end="1331.14">that we can we want to at this point</span> <span data-start="1331.14" data-end="1333.27">it's now we can actually start popping</span> <span data-start="1333.27" data-end="1334.98">off calls from the call stack and doing</span> <span data-start="1334.98" data-end="1337.02">something with them so identifier pops</span> <span data-start="1337.02" data-end="1338.55">this off off creates a JavaScript string</span> <span data-start="1338.55" data-end="1341.04">puts into the resolved stack literal</span> <span data-start="1341.04" data-end="1342.78">does the same thing pop self off puts a</span> </p>
<p><span data-start="1342.78" data-end="1344.52">JavaScript number and into the returned</span> <span data-start="1344.52" data-end="1345.87">stack is you know</span> <span data-start="1345.87" data-end="1348.69">and then same thing with two and then</span> <span data-start="1348.69" data-end="1351.059">binary pops off it pulls in the right</span> <span data-start="1351.059" data-end="1352.74">operand and then the left operand as you</span> <span data-start="1352.74" data-end="1355.08">could see right it was two and left was</span> <span data-start="1355.08" data-end="1357.99">one and then it does something with them</span> <span data-start="1357.99" data-end="1359.789">it wants to perform the binary</span> <span data-start="1359.789" data-end="1361.83">expression so it does the and it sees</span> <span data-start="1361.83" data-end="1363.419">the operators plus okay I'm gonna go</span> <span data-start="1363.419" data-end="1364.95">ahead and add them together the results</span> <span data-start="1364.95" data-end="1366.33">three and it pushes that result on to</span> <span data-start="1366.33" data-end="1368.76">the return and then the last thing in</span> <span data-start="1368.76" data-end="1370.2">the call stack is the variable decorator</span> <span data-start="1370.2" data-end="1373.529">so it pops off it pulls off the init</span> <span data-start="1373.529" data-end="1377.34">three and then it pulls off the ID X and</span> <span data-start="1377.34" data-end="1379.169">it says I'm gonna store into the symbol</span> <span data-start="1379.169" data-end="1381.659">table you know a symbol of X with it and</span> <span data-start="1381.659" data-end="1385.289">it has a value of three and now we're</span> <span data-start="1385.289" data-end="1387">done interpreting their code so that's</span> <span data-start="1387" data-end="1390.6">kind of how it works and anybody who is</span> <span data-start="1390.6" data-end="1394.83">a JavaScript interpreter guru maybe like</span> </p>
<p><span data-start="1394.83" data-end="1396.75">Andy is probably like this is the worst</span> <span data-start="1396.75" data-end="1397.85">thing I've ever seen in my life</span> <span data-start="1397.85" data-end="1400.86">because it is it really is but it was</span> <span data-start="1400.86" data-end="1402.179">this was all like a perfect concept</span> <span data-start="1402.179" data-end="1403.47">experiment to see what we can do with</span> <span data-start="1403.47" data-end="1405.51">this right so we wanted to see how it</span> <span data-start="1405.51" data-end="1407.309">would work how it would perform so we</span> <span data-start="1407.309" data-end="1408.84">just we did as quickly as kind of stack</span> <span data-start="1408.84" data-end="1412.26">base benchmark it it's actually to do so</span> <span data-start="1412.26" data-end="1414.059">we did a just a really small loop of</span> <span data-start="1414.059" data-end="1416.13">flops you know the harbor's really good</span> <span data-start="1416.13" data-end="1418.289">at flops we we mapped you know the power</span> <span data-start="1418.289" data-end="1419.52">operation to the native power</span> <span data-start="1419.52" data-end="1421.83">instruction on the GPU so it run as fast</span> <span data-start="1421.83" data-end="1423.84">as possible that's not the slowest part</span> <span data-start="1423.84" data-end="1427.23">of this thing though so we ran it the</span> <span data-start="1427.23" data-end="1430.95">lateral interpreter on both GPU and on</span> <span data-start="1430.95" data-end="1434.01">the CPU since OpenCL can do that it just</span> <span data-start="1434.01" data-end="1436.409">compiles with LLVM down to the x86</span> <span data-start="1436.409" data-end="1438.12">instructions or whatever process you're</span> <span data-start="1438.12" data-end="1440.52">running and and we just want to compare</span> <span data-start="1440.52" data-end="1441.84">the two and then we ran the same block</span> <span data-start="1441.84" data-end="1444.899">of code in v8 and this the results are</span> <span data-start="1444.899" data-end="1448.61">not that surprising GPU incredibly slow</span> <span data-start="1448.61" data-end="1450.779">116 milliseconds just to do that little</span> <span data-start="1450.779" data-end="1455.399">tiny thing this awful on the cpu is 0.2</span> <span data-start="1455.399" data-end="1457.25">2 milliseconds which is interesting</span> <span data-start="1457.25" data-end="1460.26">that's not not well it's kind of what it</span> <span data-start="1460.26" data-end="1462.48">is what we expected but the difference</span> <span data-start="1462.48" data-end="1463.89">is not what we expected is a huge</span> <span data-start="1463.89" data-end="1466.02">difference and v8</span> <span data-start="1466.02" data-end="1469.32">shocker is like no time at all it's in</span> <span data-start="1469.32" data-end="1473">the nanoseconds so you don't say</span> <span data-start="1473" data-end="1477.98">so surprising so like I mean this this</span> <span data-start="1477.98" data-end="1480.26">number the numbers in the lateral sigh</span> </p>
<p><span data-start="1480.26" data-end="1481.49">I'm giving too much credit I was gonna</span> <span data-start="1481.49" data-end="1482.659">say its inflated and a little bit</span> <span data-start="1482.659" data-end="1484.7">because it's doing some prep but it's</span> <span data-start="1484.7" data-end="1486.14">nothing has nothing to do with that</span> <span data-start="1486.14" data-end="1492.62">really the the interesting thing is when</span> <span data-start="1492.62" data-end="1494.69">I run this on my Mac Pro which is a much</span> <span data-start="1494.69" data-end="1496.07">better video card that numbers in half</span> <span data-start="1496.07" data-end="1498.35">so it's still terrible down</span> <span data-start="1498.35" data-end="1500.84">so overall the experiment failed but</span> <span data-start="1500.84" data-end="1502.73">we're not giving up and we just wanted</span> <span data-start="1502.73" data-end="1503.9">to get that done as fast as possible to</span> <span data-start="1503.9" data-end="1507.83">see can we do it and I feel free Kotori</span> <span data-start="1507.83" data-end="1509.51">us of conquering up and sale to actually</span> <span data-start="1509.51" data-end="1511.789">do something useful but it's not what</span> <span data-start="1511.789" data-end="1515.419">the harbor is meant to do at all but we</span> <span data-start="1515.419" data-end="1516.86">can take it further we can we can do</span> <span data-start="1516.86" data-end="1518.84">something with this but we had to recap</span> <span data-start="1518.84" data-end="1520.19">in like what we're wrong and the first</span> <span data-start="1520.19" data-end="1522.14">thing was everything went wrong I mean</span> <span data-start="1522.14" data-end="1523.61">we had to solve all those problems all</span> <span data-start="1523.61" data-end="1525.289">those headaches and that took more time</span> <span data-start="1525.289" data-end="1526.85">than doing that's that silly little</span> <span data-start="1526.85" data-end="1529.58">stack based interpreter so once we got</span> <span data-start="1529.58" data-end="1531.53">once we saw those problems we feel like</span> <span data-start="1531.53" data-end="1534.409">we can do anything at this point but you</span> <span data-start="1534.409" data-end="1535.49">know the sack to deter Birds just</span> <span data-start="1535.49" data-end="1537.44">following the yellow brick road of the</span> <span data-start="1537.44" data-end="1538.909">ast it was just no optimizations</span> <span data-start="1538.909" data-end="1539.96">whatsoever</span> <span data-start="1539.96" data-end="1542.299">it wasn't do any compilation or anything</span> <span data-start="1542.299" data-end="1544.669">like that so so that was not the right</span> <span data-start="1544.669" data-end="1546.83">way to do it or the best way to do it we</span> <span data-start="1546.83" data-end="1548.83">are accessing a lot of global memory</span> <span data-start="1548.83" data-end="1550.94">because of our dominant dynamic</span> <span data-start="1550.94" data-end="1554.15">allocation needs we had to suck that</span> <span data-start="1554.15" data-end="1555.89">teat a little bit or so we wanted it</span> <span data-start="1555.89" data-end="1559.88">really badly so we everything was done</span> <span data-start="1559.88" data-end="1565.22">in global memory and we had a lot of</span> <span data-start="1565.22" data-end="1566.72">access global memory that's the slowest</span> <span data-start="1566.72" data-end="1569.84">memory available so we we had no</span> <span data-start="1569.84" data-end="1571.4">optimizations there whatsoever we could</span> <span data-start="1571.4" data-end="1573.049">do a lot of caching and private memory</span> <span data-start="1573.049" data-end="1573.47">or whatnot</span> <span data-start="1573.47" data-end="1575.62">to speed things up and we never did that</span> <span data-start="1575.62" data-end="1577.909">and we never broke things up excuse me</span> <span data-start="1577.909" data-end="1580.669">never birth things up into any parallel</span> <span data-start="1580.669" data-end="1582.62">tasks for data or even just you know</span> <span data-start="1582.62" data-end="1586.97">standard instructions so let's reflect a</span> <span data-start="1586.97" data-end="1589.37">little bit stack-based slow it was a</span> <span data-start="1589.37" data-end="1590.78">memory halt good use a lot of memory</span> <span data-start="1590.78" data-end="1592.76">like it collapsed it I mean it's</span> <span data-start="1592.76" data-end="1595.61">terrible and just that just that one</span> <span data-start="1595.61" data-end="1599.69">statement hit the sack 30 times and then</span> <span data-start="1599.69" data-end="1601.549">in between that did a lot of dynamic</span> <span data-start="1601.549" data-end="1604.1">memory allocation and freeing you know</span> <span data-start="1604.1" data-end="1605.149">and it's our own software an</span> <span data-start="1605.149" data-end="1606.62">implementation of that so</span> <span data-start="1606.62" data-end="1610.25">it's really slow and you know again we</span> <span data-start="1610.25" data-end="1611.96">didn't know inline optimizations of the</span> <span data-start="1611.96" data-end="1614.87">actual code we just interpret it</span> <span data-start="1614.87" data-end="1617.54">directly from the AST so we were just</span> <span data-start="1617.54" data-end="1620.42">rate up lazy but we can do better I mean</span> <span data-start="1620.42" data-end="1621.77">we could do something like compiling</span> <span data-start="1621.77" data-end="1623.48">into byte code on the host and then</span> <span data-start="1623.48" data-end="1625.37">doing like a register based interpreter</span> <span data-start="1625.37" data-end="1629.059">on the on the device along with other</span> <span data-start="1629.059" data-end="1631.37">things that would make it worth you know</span> <span data-start="1631.37" data-end="1634.28">more a while so global memory access</span> <span data-start="1634.28" data-end="1637.61">again just too damn I we we have to</span> <span data-start="1637.61" data-end="1639.86">limit that I want to give it a we</span> <span data-start="1639.86" data-end="1642.37">conduct a little experiment to just see</span> <span data-start="1642.37" data-end="1645.26">what the difference really is I mean</span> <span data-start="1645.26" data-end="1646.61">there are theoretical bandwidth numbers</span> <span data-start="1646.61" data-end="1651.26">out there but so we we went ahead and</span> <span data-start="1651.26" data-end="1653.21">created like two little kernel functions</span> <span data-start="1653.21" data-end="1656.679">one that was going through a large loop</span> <span data-start="1656.679" data-end="1659.45">that acts as nothing but data or excuse</span> <span data-start="1659.45" data-end="1661.04">me actually stuff from a global memory</span> <span data-start="1661.04" data-end="1662.57">and then create another one that created</span> <span data-start="1662.57" data-end="1664.96">temp temporary private variables</span> <span data-start="1664.96" data-end="1666.89">incremented and touched them throughout</span> <span data-start="1666.89" data-end="1668.36">the loop when every loop iteration and</span> <span data-start="1668.36" data-end="1669.679">then just touch global memory one other</span> <span data-start="1669.679" data-end="1671.57">time at the end the difference is</span> <span data-start="1671.57" data-end="1674.36">astounding the first one ran in 11 point</span> <span data-start="1674.36" data-end="1676.58">1 2 seconds in the second one ran in</span> <span data-start="1676.58" data-end="1681.32">point 0 for 4 seconds so with the proper</span> <span data-start="1681.32" data-end="1683.12">optimizations on memory access I think</span> <span data-start="1683.12" data-end="1686.87">we can get pretty far with our speed but</span> <span data-start="1686.87" data-end="1689.059">that's not the only thing we need to do</span> <span data-start="1689.059" data-end="1692">we need to do some magic and that's try</span> <span data-start="1692" data-end="1694.309">to figure out a way to break up do here</span> <span data-start="1694.309" data-end="1695.929">your sticks on code and break things</span> <span data-start="1695.929" data-end="1698.48">into parallel tasks not even with the</span> <span data-start="1698.48" data-end="1702.05">developer explicitly asking for it there</span> <span data-start="1702.05" data-end="1704.27">are times where it's possible to do</span> <span data-start="1704.27" data-end="1708.44">detection on what's you know side-effect</span> <span data-start="1708.44" data-end="1710.059">free what is homogeneous what can be</span> <span data-start="1710.059" data-end="1713.21">homogeneous especially if you're doing</span> <span data-start="1713.21" data-end="1715.97">an interpreter you could actually find</span> <span data-start="1715.97" data-end="1717.5">things at runtime leakage it would and</span> <span data-start="1717.5" data-end="1719.12">then we can make it faster at that point</span> <span data-start="1719.12" data-end="1722.72">so things like this loop you know we</span> <span data-start="1722.72" data-end="1724.73">could've done heuristics and say well</span> <span data-start="1724.73" data-end="1726.88">you know what nothing's being changed</span> <span data-start="1726.88" data-end="1728.929">outside of each individual element of</span> <span data-start="1728.929" data-end="1730.28">this input array so we could break that</span> <span data-start="1730.28" data-end="1732.4">up into ten different operations</span> <span data-start="1732.4" data-end="1735.38">interpret them in at the same time and</span> <span data-start="1735.38" data-end="1737.09">tended from cores in the GPU and speed</span> <span data-start="1737.09" data-end="1740.51">things up in general</span> <span data-start="1740.51" data-end="1742.79">if the majority of your application</span> <span data-start="1742.79" data-end="1744.92">can't be sped up or accelerated in this</span> <span data-start="1744.92" data-end="1746.72">way then you're going to be limited by</span> <span data-start="1746.72" data-end="1748.88">indels wall eventually if you don't that</span> <span data-start="1748.88" data-end="1751.97">is you can look it up on Google but you</span> <span data-start="1751.97" data-end="1754.82">know the this can only go so far to be</span> <span data-start="1754.82" data-end="1757.76">practical but you know there's a lot of</span> <span data-start="1757.76" data-end="1759.59">experimentation to be done and we wanted</span> <span data-start="1759.59" data-end="1760.91">to see how far we can take it so we're</span> <span data-start="1760.91" data-end="1763.3">going to continue you know experimenting</span> <span data-start="1763.3" data-end="1766.04">we want to see if we can get the</span> <span data-start="1766.04" data-end="1767.51">performance of this interpreter all and</span> </p>
<p><span data-start="1767.51" data-end="1769.07">Cl devices to an acceptable state where</span> <span data-start="1769.07" data-end="1771.8">you can actually go ahead and send tasks</span> <span data-start="1771.8" data-end="1773.78">to a stateless you know no share memory</span> <span data-start="1773.78" data-end="1775.67">tasks but you can send remember you can</span> <span data-start="1775.67" data-end="1777.2">send parameter values to it they'll be</span> <span data-start="1777.2" data-end="1779.12">serialized over and then you can pull</span> <span data-start="1779.12" data-end="1783.65">that memory back and you know do high</span> <span data-start="1783.65" data-end="1785.81">level things like map map reduction and</span> <span data-start="1785.81" data-end="1787.88">whatnot these are things that River</span> <span data-start="1787.88" data-end="1788.9">Trail is doing very well</span> <span data-start="1788.9" data-end="1794.42">and you know there's there are</span> <span data-start="1794.42" data-end="1795.89">limitations there so we can get this</span> <span data-start="1795.89" data-end="1797.84">interpreter going then we can actually</span> <span data-start="1797.84" data-end="1800.09">have full compliant JavaScript on all</span> <span data-start="1800.09" data-end="1803.15">these you know fast GPU devices</span> <span data-start="1803.15" data-end="1804.98">accelerator processors and see if we can</span> <span data-start="1804.98" data-end="1807.92">get JavaScript up to the next level you</span> <span data-start="1807.92" data-end="1811.07">can even you know think further and set</span> <span data-start="1811.07" data-end="1812.3">up like a clustering system and actually</span> <span data-start="1812.3" data-end="1813.44">do these things on a bunch of different</span> <span data-start="1813.44" data-end="1815.6">systems and orchestrate them which are</span> <span data-start="1815.6" data-end="1819.77">pretty neat so so that's there's a those</span> <span data-start="1819.77" data-end="1821.72">are the things that we ran into and we</span> <span data-start="1821.72" data-end="1823.28">came out with and we're still working on</span> <span data-start="1823.28" data-end="1824.24">it these all this stuff's gonna be</span> <span data-start="1824.24" data-end="1826.91">open-source we solved like legal things</span> <span data-start="1826.91" data-end="1828.41">to take care of like copyrights and</span> <span data-start="1828.41" data-end="1829.76">whatnot but it's gonna be open source</span> <span data-start="1829.76" data-end="1831.05">just people to play around with and see</span> <span data-start="1831.05" data-end="1833.96">what it looks like it's a mess but we're</span> <span data-start="1833.96" data-end="1836.03">gonna clean it up it'll be it's fun so</span> <span data-start="1836.03" data-end="1837.02">if anybody wants to just play around</span> <span data-start="1837.02" data-end="1839.14">with it see if they can make it faster</span> <span data-start="1839.14" data-end="1843.31">you can I'll be posting and tweeting</span> <span data-start="1843.31" data-end="1846.71">about it and my Twitter's at your</span> </p>
<p><span data-start="1846.71" data-end="1847.94">Nichols so if you can follow me I'll</span> <span data-start="1847.94" data-end="1849.89">I'll be talking about this quite a bit</span> <span data-start="1849.89" data-end="1852.8">and you can stay up to date it's on my</span> <span data-start="1852.8" data-end="1854.06">github account I didn't put the link in</span> <span data-start="1854.06" data-end="1855.05">there I don't what the hell I was</span> <span data-start="1855.05" data-end="1858.02">thinking but it will be live soon it's</span> <span data-start="1858.02" data-end="1858.8">probably right now because they've</span> <span data-start="1858.8" data-end="1860.99">copyright stuff but it'll be live soon</span> <span data-start="1860.99" data-end="1863.26">but that's it that's my talk so</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
