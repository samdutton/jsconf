<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="web.dev LIVE video transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>unEuPvA2wnM</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/unEuPvA2wnM?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="15.71" data-end="18.77">hi everybody I'm psyched to be here I'm</span> <span data-start="18.77" data-end="22.22">psyched to talk about this so let's see</span> <span data-start="22.22" data-end="24.8">I'm Adam Wolfe and today I'm gonna talk</span> <span data-start="24.8" data-end="27.26">about rebuilding facebook chat and</span> <span data-start="27.26" data-end="29.45">actually there was a big project going</span> <span data-start="29.45" data-end="31.099">on to rebuild all a facebook chat</span> <span data-start="31.099" data-end="33.14">including the back end but I gotta focus</span> <span data-start="33.14" data-end="34.579">on the front end and the JavaScript</span> <span data-start="34.579" data-end="37.399">rewrote it seems appropriate and you may</span> <span data-start="37.399" data-end="39.86">wonder why we felt like we needed to</span> <span data-start="39.86" data-end="42.35">rebuild facebook chat and you know the</span> <span data-start="42.35" data-end="43.79">answer is that it was pretty terrible</span> <span data-start="43.79" data-end="46.1">and I pulled something that I remembered</span> <span data-start="46.1" data-end="48.079">from about a year ago this was like a</span> <span data-start="48.079" data-end="50.84">blog post announcing our new subscribe</span> <span data-start="50.84" data-end="52.34">feature so you could follow people on</span> </p>
<p><span data-start="52.34" data-end="54.53">Facebook and the very first comment it</span> <span data-start="54.53" data-end="56.089">was posted a minute after this went up</span> <span data-start="56.089" data-end="58.73">says improve the chat system and there</span> <span data-start="58.73" data-end="60.92">are thousand likes on that comment so um</span> <span data-start="60.92" data-end="62.629">and actually this is a problem for us</span> <span data-start="62.629" data-end="65.18">because the complaints about chat just</span> <span data-start="65.18" data-end="67.7">drowned out our overall user feedback it</span> <span data-start="67.7" data-end="69.83">was like really hard to tell when we had</span> <span data-start="69.83" data-end="71.15">new bugs and stuff because you know</span> <span data-start="71.15" data-end="72.67">people are always complaining about chat</span> <span data-start="72.67" data-end="75.68">and facebook chats I think it's somewhat</span> <span data-start="75.68" data-end="77.6">unique as a client-side application</span> <span data-start="77.6" data-end="79.939">because it's embedded in this browse</span> <span data-start="79.939" data-end="81.56">experience you know Facebook is still</span> <span data-start="81.56" data-end="83.509">delivered very much as like a page to</span> <span data-start="83.509" data-end="86.39">page classic web application so we can't</span> <span data-start="86.39" data-end="88.13">afford to like load a bunch of code and</span> <span data-start="88.13" data-end="89.81">then go back to the server to build up a</span> <span data-start="89.81" data-end="91.49">bunch of state because you know we're</span> <span data-start="91.49" data-end="94.219">gonna get paged out quickly the other</span> <span data-start="94.219" data-end="95.84">thing is that the scale of facebook chat</span> <span data-start="95.84" data-end="98.18">is enormous it's you know at our peak</span> <span data-start="98.18" data-end="100.34">it's hundreds of millions of concurrent</span> <span data-start="100.34" data-end="102.979">users so every extra fetch to the</span> <span data-start="102.979" data-end="106.159">backend means extra latency and extra</span> <span data-start="106.159" data-end="108.289">servers you know more cost for us and</span> <span data-start="108.289" data-end="110.78">the worse experience so you know I think</span> <span data-start="110.78" data-end="112.13">it's kind of funny we've been doing</span> </p>
<p><span data-start="112.13" data-end="114.56">JavaScript and web apps for like for a</span> <span data-start="114.56" data-end="116.659">while now and it's still not obvious how</span> <span data-start="116.659" data-end="118.31">you build a feature like this you know</span> <span data-start="118.31" data-end="120.17">everyone like builds their own language</span> <span data-start="120.17" data-end="121.7">and their own servers for this and</span> <span data-start="121.7" data-end="123.77">everything so you know we kind of</span> <span data-start="123.77" data-end="126.079">approach this like not not sure um how</span> <span data-start="126.079" data-end="129.16">what we were going to do to to fix this</span> <span data-start="129.16" data-end="132.5">and I before we go into like what we did</span> <span data-start="132.5" data-end="134.12">I want to show a little bit about what</span> <span data-start="134.12" data-end="136.58">facebook chat does or do people here use</span> <span data-start="136.58" data-end="139.52">facebook chat on the web like some</span> <span data-start="139.52" data-end="141.89">people do I I figure this is like more</span> <span data-start="141.89" data-end="144.05">of a Twitter crab but no worries I'll</span> <span data-start="144.05" data-end="146.45">show you what it does okay so here I</span> <span data-start="146.45" data-end="149.42">have my alter-ego to be Co Jones his</span> </p>
<p><span data-start="149.42" data-end="152.03">Facebook page and I'm going to start a</span> <span data-start="152.03" data-end="154.01">chat with nan one of the Facebook</span> <span data-start="154.01" data-end="156.59">contingent who's here and you know the</span> <span data-start="156.59" data-end="158.62">very first thing I want to show is that</span> <span data-start="158.62" data-end="161.569">when one thing that we did is oh thanks</span> <span data-start="161.569" data-end="164.66">nan one thing that we did is let's try</span> <span data-start="164.66" data-end="172.19">that again when we when we merged chat</span> <span data-start="172.19" data-end="174.68">and messages you know we used to have</span> <span data-start="174.68" data-end="176.319">two different products there was this</span> <span data-start="176.319" data-end="178.91">there was this jewel at the top we call</span> <span data-start="178.91" data-end="180.8">this thing up here the messages jewel</span> <span data-start="180.8" data-end="183.11">and then we also have chat windows and</span> <span data-start="183.11" data-end="185.36">um we merged the backend for these</span> <span data-start="185.36" data-end="186.5">things because we felt like hey you're</span> <span data-start="186.5" data-end="187.819">talking to your friend you know in</span> <span data-start="187.819" data-end="189.59">either interface they should be the same</span> <span data-start="189.59" data-end="191.63">thing but we didn't merge the front end</span> <span data-start="191.63" data-end="194.03">of these applications so the jewel was</span> <span data-start="194.03" data-end="196.01">controlled by like one set of client</span> <span data-start="196.01" data-end="198.14">code and the chat window was controlled</span> <span data-start="198.14" data-end="200.42">by another and they would get out of</span> <span data-start="200.42" data-end="201.83">sync all the time that was actually like</span> <span data-start="201.83" data-end="205.13">the dominant form of angry feedback so</span> <span data-start="205.13" data-end="208.13">man will you send me another message so</span> <span data-start="208.13" data-end="210.049">now you'll see that when nan sends me</span> <span data-start="210.049" data-end="213.89">another thanks with nan sends me another</span> <span data-start="213.89" data-end="215.18">message you see they appear in both</span> <span data-start="215.18" data-end="218.209">interfaces at the same time and so like</span> <span data-start="218.209" data-end="219.92">fundamentally like this was what we had</span> <span data-start="219.92" data-end="221.239">to do you know we had to introduce a</span> <span data-start="221.239" data-end="223.489">model for what chat was doing and make</span> <span data-start="223.489" data-end="226.25">it more than just like a very simple app</span> <span data-start="226.25" data-end="227.6">it used to be just something that was</span> <span data-start="227.6" data-end="229.82">all about the UI um couple other</span> <span data-start="229.82" data-end="231.739">features I want to show here let me</span> <span data-start="231.739" data-end="233.45">minimize this window and maybe nan will</span> <span data-start="233.45" data-end="236.66">send me one more message I think he's</span> <span data-start="236.66" data-end="238.37">out of prepared comments so hopefully</span> <span data-start="238.37" data-end="241.34">yeah he has to type something on this</span> <span data-start="241.34" data-end="243.739">phone we'll wait for that to come in</span> <span data-start="243.739" data-end="246.14">okay there we go so now I have a new</span> <span data-start="246.14" data-end="247.459">message and I'm gonna actually reload</span> <span data-start="247.459" data-end="251.209">the page here before um before I do and</span> <span data-start="251.209" data-end="253.94">what you'll see now is what I wanted to</span> <span data-start="253.94" data-end="255.44">point out about this is that you know</span> <span data-start="255.44" data-end="257.6">even though people have messages when</span> <span data-start="257.6" data-end="260.359">they come to facebook chat is not the</span> <span data-start="260.359" data-end="261.89">most important feature on Facebook</span> <span data-start="261.89" data-end="263.9">obviously it's the newsfeed so like half</span> <span data-start="263.9" data-end="265.76">of our users don't engage with chat at</span> <span data-start="265.76" data-end="268.639">all in a given day um so we can't afford</span> <span data-start="268.639" data-end="270.47">to like load all the messages when the</span> <span data-start="270.47" data-end="272.12">page comes up and what that means is</span> <span data-start="272.12" data-end="274.01">that now when I raise this chat window</span> <span data-start="274.01" data-end="275.57">you'll see a little tiny delay where we</span> <span data-start="275.57" data-end="278.45">have to go fetch the the conversation</span> <span data-start="278.45" data-end="282.08">before we can show it and even though</span> <span data-start="282.08" data-end="283.26">we've done that we</span> <span data-start="283.26" data-end="284.97">haven't loaded all the data for the</span> <span data-start="284.97" data-end="287.85">model like when we go look at our list</span> <span data-start="287.85" data-end="290.22">of conversations you'll see that has to</span> <span data-start="290.22" data-end="291.45">get loaded in as well</span> <span data-start="291.45" data-end="293.33">so we very much have to emphasize</span> <span data-start="293.33" data-end="296.52">incremental loading they did take away</span> <span data-start="296.52" data-end="299.67">my shaving cream yes that's right</span> <span data-start="299.67" data-end="302.37">okay oh and I'm getting lots of messages</span> <span data-start="302.37" data-end="307.11">here hi everybody one last thing I want</span> <span data-start="307.11" data-end="309.42">to show is that there's a group chat</span> <span data-start="309.42" data-end="312.24">feature here and you know this makes</span> <span data-start="312.24" data-end="315.15">this much more complicated so tobiko</span> <span data-start="315.15" data-end="318.45">here is gonna add Adam to this chat and</span> <span data-start="318.45" data-end="323.37">this is a new group chat and maybe then</span> <span data-start="323.37" data-end="325.65">can add some people too and the thing I</span> <span data-start="325.65" data-end="326.91">want to point out about this is it you</span> <span data-start="326.91" data-end="328.53">know nan can add people who are his</span> <span data-start="328.53" data-end="331.23">friends to this chat that and these are</span> <span data-start="331.23" data-end="333.6">people that tobiko doesn't know so he</span> <span data-start="333.6" data-end="334.86">doesn't have information about these</span> <span data-start="334.86" data-end="336.69">participants and those need to be loaded</span> <span data-start="336.69" data-end="338.82">incrementally sort of as these messages</span> <span data-start="338.82" data-end="342.78">come in and in sort of real-time so</span> <span data-start="342.78" data-end="345.66">whoops I lost focus there we go</span> <span data-start="345.66" data-end="347.67">so you know that's actually something</span> <span data-start="347.67" data-end="348.84">that we had to contend with and I'm</span> <span data-start="348.84" data-end="350.07">gonna show a little bit of code that</span> <span data-start="350.07" data-end="352.74">kind of gives an example of how we dealt</span> <span data-start="352.74" data-end="356.61">with that okay so back to presentation</span> <span data-start="356.61" data-end="359.04">so um you know we did this we did this</span> <span data-start="359.04" data-end="360.84">rewrite and I you know I think we can</span> <span data-start="360.84" data-end="363.33">say it was a success you know one thing</span> <span data-start="363.33" data-end="364.98">that we really got to do is we really</span> <span data-start="364.98" data-end="367.02">got to focus on the technology and the</span> <span data-start="367.02" data-end="369.45">quality we didn't have a bunch of new</span> <span data-start="369.45" data-end="371.16">features to add it was pretty minor in</span> <span data-start="371.16" data-end="373.95">that regard so that was very helpful we</span> <span data-start="373.95" data-end="376.14">developed a new command-line JavaScript</span> <span data-start="376.14" data-end="377.85">test framework as part of this project</span> <span data-start="377.85" data-end="380.28">and it's been adopted across Facebook</span> <span data-start="380.28" data-end="382.08">and now we're working to open source it</span> <span data-start="382.08" data-end="383.46">so I'll talk a little bit more about</span> <span data-start="383.46" data-end="385.5">that the whole project took six months</span> <span data-start="385.5" data-end="387.29">most of the time it was just for</span> <span data-start="387.29" data-end="392.1">engineers working on it so you know that</span> <span data-start="392.1" data-end="393.99">it wasn't like a gigantic project and</span> <span data-start="393.99" data-end="395.66">what I'm showing here is the graph of</span> <span data-start="395.66" data-end="397.92">user tickets now unfortunately a</span> <span data-start="397.92" data-end="400.32">facebook like each individual user</span> <span data-start="400.32" data-end="402.78">report surfaces to us is like you know</span> <span data-start="402.78" data-end="404.52">thousands of users complaining about</span> <span data-start="404.52" data-end="406.47">things every day but we can tell we're</span> <span data-start="406.47" data-end="408.18">doing better when those those thousands</span> <span data-start="408.18" data-end="410.4">become hundreds and that's kind of what</span> <span data-start="410.4" data-end="411.6">happened here and it's gotten better</span> <span data-start="411.6" data-end="414.18">since so you can see that this was you</span> <span data-start="414.18" data-end="415.71">know really helped with the quality</span> <span data-start="415.71" data-end="418.55">there are other things we were doing</span> <span data-start="418.55" data-end="421.56">but you know the very first thing that I</span> <span data-start="421.56" data-end="422.7">want to talk about and the most</span> <span data-start="422.7" data-end="424.89">important thing and like the the thing</span> <span data-start="424.89" data-end="426.3">that I would sort of suggest you</span> <span data-start="426.3" data-end="428.28">remember from this talk if you're gonna</span> <span data-start="428.28" data-end="430.71">remember one thing is that we introduced</span> <span data-start="430.71" data-end="433.02">modularity into the Facebook JavaScript</span> <span data-start="433.02" data-end="435.51">code base in order to deliver this</span> <span data-start="435.51" data-end="437.04">feature and that was like the single</span> <span data-start="437.04" data-end="440.28">best thing we did cuz like if you even</span> <span data-start="440.28" data-end="442.68">if you have a big steaming pile like if</span> <span data-start="442.68" data-end="444.45">you have a steaming pile that's like in</span> <span data-start="444.45" data-end="446.4">little buckets then you can fix them one</span> <span data-start="446.4" data-end="449.37">at a time and so that you know that's</span> <span data-start="449.37" data-end="451.55">like the single best thing that we did</span> <span data-start="451.55" data-end="454.17">so when I joined Facebook like a little</span> <span data-start="454.17" data-end="455.97">over two years ago all of our JavaScript</span> <span data-start="455.97" data-end="459.3">was effectively in a global namespace so</span> <span data-start="459.3" data-end="461.73">you know you just write like var blah</span> <span data-start="461.73" data-end="464.49">equals blah you know and then and that</span> <span data-start="464.49" data-end="466.02">would just like kind of run whenever it</span> <span data-start="466.02" data-end="468.3">ran you could you could give directives</span> <span data-start="468.3" data-end="469.62">that say like hey when you load this</span> <span data-start="469.62" data-end="471.15">file you also need to load these other</span> <span data-start="471.15" data-end="473.07">files but there's no guarantee about</span> <span data-start="473.07" data-end="474.84">what order that would happen so it made</span> <span data-start="474.84" data-end="478.64">it really really complicated and any any</span> </p>
<p><span data-start="478.64" data-end="480.81">JavaScript code could break any other</span> <span data-start="480.81" data-end="482.37">JavaScript code so it's like really easy</span> <span data-start="482.37" data-end="485.07">to cause a problem and then really hard</span> <span data-start="485.07" data-end="488.22">to figure out what who had done what and</span> <span data-start="488.22" data-end="489.27">the other thing was that like we had</span> <span data-start="489.27" data-end="491.58">this we have this stochastic packager</span> <span data-start="491.58" data-end="493.35">that actually takes data from production</span> <span data-start="493.35" data-end="495.45">and tries to do the most efficient job</span> <span data-start="495.45" data-end="497.07">it can like putting JavaScript files</span> <span data-start="497.07" data-end="497.73">together</span> <span data-start="497.73" data-end="500.91">so the packager would like change what</span> <span data-start="500.91" data-end="502.74">javascript with was delivered in what</span> <span data-start="502.74" data-end="504.75">bundle and that would cause bugs even</span> <span data-start="504.75" data-end="506.28">though no code had changed that makes it</span> <span data-start="506.28" data-end="507.78">really hard to figure out what's going</span> <span data-start="507.78" data-end="510.09">on and the last thing this is leads to</span> <span data-start="510.09" data-end="512.34">is like just layers and layers of</span> <span data-start="512.34" data-end="514.53">initialization because you kind of like</span> <span data-start="514.53" data-end="516.12">it's really hard to know when</span> <span data-start="516.12" data-end="518.04">everything's ready just everything sends</span> <span data-start="518.04" data-end="519.66">in an it event you know and you like end</span> <span data-start="519.66" data-end="521.55">up depending on like 20 init events</span> <span data-start="521.55" data-end="525.63">before you are ready to do anything so</span> <span data-start="525.63" data-end="527.97">we fixed that with you know common KS</span> <span data-start="527.97" data-end="530.1">effectively so now at Facebook when you</span> <span data-start="530.1" data-end="533.82">write a file you can require resources</span> <span data-start="533.82" data-end="536.55">and then you know you just can export</span> <span data-start="536.55" data-end="539.27">something this gets transformed into</span> <span data-start="539.27" data-end="541.74">like something like a defined function</span> <span data-start="541.74" data-end="543.54">along the lines of requirejs</span> <span data-start="543.54" data-end="545.9">we didn't actually pull in requirejs</span> <span data-start="545.9" data-end="548.04">because you know it's kind of easier</span> </p>
<p><span data-start="548.04" data-end="549.3">Facebook to just do it</span> <span data-start="549.3" data-end="552.54">unfortunately often but we're definitely</span> <span data-start="552.54" data-end="554.339">inspired by requirejs</span> <span data-start="554.339" data-end="556.709">so you can see that now like the</span> <span data-start="556.709" data-end="558.63">contents of a given file get run inside</span> <span data-start="558.63" data-end="561.18">a function you get you know global</span> <span data-start="561.18" data-end="562.709">namespace protection all kinds of good</span> <span data-start="562.709" data-end="564.39">stuff and you get this like</span> <span data-start="564.39" data-end="566.279">initialization guarantee you know</span> <span data-start="566.279" data-end="568.279">there's only one module named foo and</span> <span data-start="568.279" data-end="570.72">you kind of know know when it's ready</span> <span data-start="570.72" data-end="574.14">now um that ideally that would have been</span> <span data-start="574.14" data-end="576.779">enough but for our application it wasn't</span> <span data-start="576.779" data-end="578.88">and the problem that we had was that</span> <span data-start="578.88" data-end="581.279">most dependency chains in our app</span> <span data-start="581.279" data-end="584.16">actually start on the server so if you</span> <span data-start="584.16" data-end="586.41">think about like I'm gonna talk about</span> <span data-start="586.41" data-end="588.899">that chat tab window that appears at the</span> <span data-start="588.899" data-end="589.86">bottom of the screen and just like</span> <span data-start="589.86" data-end="591.54">imagine the control that renders that</span> <span data-start="591.54" data-end="593.97">right so in addition to all the data it</span> <span data-start="593.97" data-end="595.079">needs it needs a couple other things</span> <span data-start="595.079" data-end="597.54">like a like a configuration from the</span> <span data-start="597.54" data-end="599.339">server and also the templates we</span> <span data-start="599.339" data-end="601.01">actually deliver from the server as well</span> <span data-start="601.01" data-end="604.2">and you may wonder like why in a</span> <span data-start="604.2" data-end="605.37">client-side app we're delivering</span> <span data-start="605.37" data-end="607.56">templates from the server the best</span> <span data-start="607.56" data-end="609.26">answer is that initial is a</span> <span data-start="609.26" data-end="611.16">internationalization is really really</span> <span data-start="611.16" data-end="614.459">hard and we have a big legacy stack for</span> </p>
<p><span data-start="614.459" data-end="615.62">D not on the server so we</span> <span data-start="615.62" data-end="617.16">internationalized a template on the</span> <span data-start="617.16" data-end="618.87">server and then deliver it to the client</span> <span data-start="618.87" data-end="620.52">there are other things that we do in</span> <span data-start="620.52" data-end="621.99">these templates that are also helpful</span> <span data-start="621.99" data-end="624.329">but then you're back to this multi pass</span> <span data-start="624.329" data-end="625.8">initialization thing where you know you</span> <span data-start="625.8" data-end="628.649">have a module called chat tab view but</span> <span data-start="628.649" data-end="629.82">you can't use it right away</span> <span data-start="629.82" data-end="631.74">you know requiring it is not enough and</span> <span data-start="631.74" data-end="633.66">instead you also and the other thing</span> <span data-start="633.66" data-end="634.98">that you have is like when you want to</span> <span data-start="634.98" data-end="637.2">deliver these resources to the client</span> <span data-start="637.2" data-end="640.35">you have this like gross interconnect</span> <span data-start="640.35" data-end="643.14">between PHP and JavaScript where PHP in</span> <span data-start="643.14" data-end="645.329">our case sorry where you have to like</span> <span data-start="645.329" data-end="647.339">require this module and call a method on</span> <span data-start="647.339" data-end="649.56">it and you know this is a really hard</span> <span data-start="649.56" data-end="650.97">dependency to track like it's</span> <span data-start="650.97" data-end="653.04">effectively a string in PHP so if you</span> <span data-start="653.04" data-end="655.649">want to refactor that method it's a pain</span> <span data-start="655.649" data-end="657.57">also if you want to share this config</span> <span data-start="657.57" data-end="659.13">you know you end up doing this like 50</span> <span data-start="659.13" data-end="661.76">times so the way we fix this is we</span> <span data-start="661.76" data-end="663.48">introduce this idea of dynamic</span> <span data-start="663.48" data-end="665.699">dependencies where you can define</span> <span data-start="665.699" data-end="668.73">modules on the server so you just sort</span> <span data-start="668.73" data-end="671.1">of export like a bunch of configuration</span> <span data-start="671.1" data-end="675.269">as a dictionary or a template as even</span> <span data-start="675.269" data-end="677.07">just like a string and then you can</span> <span data-start="677.07" data-end="679.23">require these templates and now we don't</span> <span data-start="679.23" data-end="681.27">use the require keyword even though to</span> <span data-start="681.27" data-end="682.769">the client these things look the same</span> <span data-start="682.769" data-end="685.019">regular modules we use require dynamic</span> <span data-start="685.019" data-end="686.999">because you know the one thing about</span> <span data-start="686.999" data-end="689.129">this approach is that it is a little bit</span> <span data-start="689.129" data-end="690.779">fragile right like you can end up with a</span> <span data-start="690.779" data-end="692.73">client in a state where it needs a</span> <span data-start="692.73" data-end="695.489">module that the server forgot to prepare</span> <span data-start="695.489" data-end="697.529">for it so by using a required dynamic we</span> <span data-start="697.529" data-end="699.48">can kind of keep better track of what</span> <span data-start="699.48" data-end="701.309">the client needs in order to be able to</span> <span data-start="701.309" data-end="703.35">initialize but you can freely mix</span> <span data-start="703.35" data-end="705.6">require dynamic statements with regular</span> <span data-start="705.6" data-end="707.61">require statements and then go about</span> <span data-start="707.61" data-end="710.939">your business so you know this worked</span> <span data-start="710.939" data-end="712.35">really well and as I said like if</span> <span data-start="712.35" data-end="713.999">there's one thing that made this project</span> <span data-start="713.999" data-end="715.98">work it was the fact that we could put</span> <span data-start="715.98" data-end="718.17">our chat code our new shiny chat code in</span> <span data-start="718.17" data-end="720.42">modules that would not be broken by the</span> <span data-start="720.42" data-end="722.999">rest of the JavaScript at Facebook um</span> <span data-start="722.999" data-end="724.679">there's a couple things I feel like we</span> <span data-start="724.679" data-end="726.149">didn't quite get right so you know if</span> <span data-start="726.149" data-end="728.79">you go down this road there are things I</span> <span data-start="728.79" data-end="731.009">would do differently the very first</span> <span data-start="731.009" data-end="733.019">thing I would say is I I really wish we</span> <span data-start="733.019" data-end="735.029">hadn't allowed circular dependencies I</span> <span data-start="735.029" data-end="737.189">know that's part of the common Jas spec</span> <span data-start="737.189" data-end="739.41">and I'm I'd be fine allowing it for</span> <span data-start="739.41" data-end="741.779">third-party code but in our code you</span> <span data-start="741.779" data-end="743.339">know it leads to all kinds of problems</span> <span data-start="743.339" data-end="745.079">it's really hard to reason about these</span> <span data-start="745.079" data-end="747.179">circular dependencies and it's really</span> <span data-start="747.179" data-end="750.24">hard to know when you're looking at one</span> <span data-start="750.24" data-end="752.309">module that like it it's part of a</span> <span data-start="752.309" data-end="754.769">circular dependency chain the other</span> <span data-start="754.769" data-end="756.269">thing about it is that like anytime you</span> <span data-start="756.269" data-end="757.649">have something that can execute an</span> <span data-start="757.649" data-end="760.079">arbitrary order you almost always end up</span> <span data-start="760.079" data-end="761.999">with bugs when that order switches for</span> <span data-start="761.999" data-end="764.61">whatever reason um the other thing I</span> <span data-start="764.61" data-end="766.019">wish we'd done like while we were at it</span> </p>
<p><span data-start="766.019" data-end="768.779">I wish we had modularized JavaScript</span> <span data-start="768.779" data-end="770.639">codes access to the window and the</span> <span data-start="770.639" data-end="773.49">document in that window because just</span> <span data-start="773.49" data-end="775.319">being able to freely refer to the window</span> <span data-start="775.319" data-end="777.72">as a global basically means that you can</span> <span data-start="777.72" data-end="779.67">only have one window in your context and</span> </p>
<p><span data-start="779.67" data-end="780.959">I think like the destiny of all</span> <span data-start="780.959" data-end="783.149">JavaScript code is to run on the server</span> <span data-start="783.149" data-end="785.249">and when you move this code to the</span> <span data-start="785.249" data-end="786.99">server you have to context to fie it you</span> <span data-start="786.99" data-end="788.189">know you have to say like there's</span> <span data-start="788.189" data-end="791.009">there's one VM sort of per request and</span> <span data-start="791.009" data-end="792.6">then the last thing was just dumb we in</span> <span data-start="792.6" data-end="793.86">you know instead of doing like straight</span> <span data-start="793.86" data-end="795.329">common J ass where you can give file</span> <span data-start="795.329" data-end="797.339">names we did this thing where you kind</span> <span data-start="797.339" data-end="800.339">of like name your file using a comment</span> <span data-start="800.339" data-end="802.079">and that was just like it's unnecessary</span> <span data-start="802.079" data-end="804.66">garbage now in the system but overall</span> <span data-start="804.66" data-end="809.15">you know big success okay</span> <span data-start="809.16" data-end="811.92">the other side of modularity I think is</span> <span data-start="811.92" data-end="813.6">unit testing and I'm presenting these</span> <span data-start="813.6" data-end="815.25">things as if they're different but I see</span> <span data-start="815.25" data-end="817.319">them as very much the same like you can</span> <span data-start="817.319" data-end="819.06">build a module system but you don't know</span> <span data-start="819.06" data-end="820.86">you actually have modules unless you</span> <span data-start="820.86" data-end="823.62">have an expression for the seams between</span> <span data-start="823.62" data-end="825.209">these modules and that's what I see is</span> <span data-start="825.209" data-end="827.55">unit testing being about so you know I</span> <span data-start="827.55" data-end="829.199">feel like a lot of people feel like okay</span> <span data-start="829.199" data-end="831.06">we I know we need to do unit testing</span> <span data-start="831.06" data-end="832.35">yeah I know that it really helps</span> <span data-start="832.35" data-end="834.449">especially an environment like Facebook</span> <span data-start="834.449" data-end="835.62">where you have hundreds of Engineers</span> <span data-start="835.62" data-end="838.259">committing to the same codebase but you</span> <span data-start="838.259" data-end="839.699">know I think like one thing that people</span> <span data-start="839.699" data-end="841.47">don't talk about too much is like just</span> <span data-start="841.47" data-end="843.3">the workflow benefit of unit testing</span> <span data-start="843.3" data-end="846.149">like I think most developers I certainly</span> <span data-start="846.149" data-end="847.92">would rather interact with my console</span> <span data-start="847.92" data-end="849.99">and my keyboard then with the browser</span> <span data-start="849.99" data-end="852.779">and the mouse but in order to make that</span> <span data-start="852.779" data-end="854.069">really work you need to make the unit</span> <span data-start="854.069" data-end="856.92">testing really fast so you know when we</span> <span data-start="856.92" data-end="858.99">we had some unit testing for JavaScript</span> <span data-start="858.99" data-end="861.029">but it was actually slower to run the</span> <span data-start="861.029" data-end="862.649">unit test and it was to reload the</span> <span data-start="862.649" data-end="864.72">webpage and click on things so like you</span> <span data-start="864.72" data-end="866.25">know that's like the wrong set of</span> <span data-start="866.25" data-end="867.839">rewards there um</span> <span data-start="867.839" data-end="870.12">the other benefit of unit testing is is</span> <span data-start="870.12" data-end="873.6">this design benefit so you know if you</span> <span data-start="873.6" data-end="875.37">have a unit test like you're forced to</span> <span data-start="875.37" data-end="878.009">consider what is this unit you know what</span> <span data-start="878.009" data-end="879.839">are the guarantees that it provides and</span> <span data-start="879.839" data-end="882.66">what are the invariants so in order to</span> <span data-start="882.66" data-end="885.089">like really capture that design benefit</span> <span data-start="885.089" data-end="887.04">you need to setup your unit test system</span> <span data-start="887.04" data-end="888.029">so that it um</span> <span data-start="888.029" data-end="890.97">by default it isolates modules you know</span> <span data-start="890.97" data-end="892.709">you sort of encourage to test one thing</span> <span data-start="892.709" data-end="895.05">at a time I mean then then the last</span> <span data-start="895.05" data-end="896.43">thing and I think this is like really</span> <span data-start="896.43" data-end="898.17">common understanding of what unit</span> <span data-start="898.17" data-end="900.029">testing is for us is the idea that like</span> <span data-start="900.029" data-end="902.16">it's a signpost you know if you come</span> <span data-start="902.16" data-end="903.449">back or someone else comes back and</span> <span data-start="903.449" data-end="905.279">wants to change something like there's a</span> <span data-start="905.279" data-end="906.93">big long list of like well this is what</span> <span data-start="906.93" data-end="908.43">it does now you know if you're gonna</span> <span data-start="908.43" data-end="910.17">change it you need to like think about</span> <span data-start="910.17" data-end="912.899">the current spec but in order to make</span> <span data-start="912.899" data-end="915.18">that read well as a specification you</span> <span data-start="915.18" data-end="916.35">need to make sure your unit test</span> <span data-start="916.35" data-end="918.569">framework is really expressive and to</span> <span data-start="918.569" data-end="919.86">this end I think you need to make your</span> <span data-start="919.86" data-end="921.93">unit test framework hack hackable you</span> <span data-start="921.93" data-end="923.75">know you need to make it so that like</span> <span data-start="923.75" data-end="925.649">developers on the team think of</span> <span data-start="925.649" data-end="927.449">committing to the unit test framework</span> <span data-start="927.449" data-end="929.79">and the unit test as like just as</span> <span data-start="929.79" data-end="932.1">important as committing to the</span> <span data-start="932.1" data-end="934.379">production code and you know like</span> <span data-start="934.379" data-end="936">packing on the unit test stuff is fun</span> <span data-start="936" data-end="938.279">cuz like you know if you break it that's</span> <span data-start="938.279" data-end="939.42">really good</span> <span data-start="939.42" data-end="941.22">and and it's also like it's much more</span> <span data-start="941.22" data-end="942.66">abstract you know it only</span> <span data-start="942.66" data-end="946.11">runs in your dev environment one thing</span> <span data-start="946.11" data-end="948.06">unit testing I think is not for is like</span> <span data-start="948.06" data-end="950.879">as a wall you know and so people new to</span> <span data-start="950.879" data-end="952.5">unit testing sort of say like well I can</span> <span data-start="952.5" data-end="953.73">write this unit test but that doesn't</span> <span data-start="953.73" data-end="955.86">prevent you from like you know writing</span> <span data-start="955.86" data-end="957.6">some other module that mocks this</span> <span data-start="957.6" data-end="959.279">interface and does the wrong thing with</span> <span data-start="959.279" data-end="961.92">it and yeah you know absolutely and you</span> <span data-start="961.92" data-end="963.569">can write integration tests if you're</span> <span data-start="963.569" data-end="965.04">really worried about that but you know</span> <span data-start="965.04" data-end="966.93">this is unit testing is about other</span> <span data-start="966.93" data-end="968.939">thoughtful developers coming along and</span> <span data-start="968.939" data-end="972.12">like sincerely trying to do to do their</span> <span data-start="972.12" data-end="973.649">best to like keep things working you</span> <span data-start="973.649" data-end="974.55">know which I think most developers</span> <span data-start="974.55" data-end="978.269">that's what they want to do so this is</span> <span data-start="978.269" data-end="979.92">what it looks like and you know that we</span> <span data-start="979.92" data-end="984.06">we integrated j/s Dom so that you can</span> <span data-start="984.06" data-end="986.37">run browser code at the console it works</span> <span data-start="986.37" data-end="987.959">great you can see this is like a trivial</span> <span data-start="987.959" data-end="989.939">test it takes about under two tenths of</span> <span data-start="989.939" data-end="992.49">a second to run I still wish it were</span> <span data-start="992.49" data-end="994.17">faster but we made some trade-offs at</span> <span data-start="994.17" data-end="996.839">all that I'll describe now so the test</span> <span data-start="996.839" data-end="998.37">environment is written in nodejs</span> <span data-start="998.37" data-end="1000.769">and that alone gives us like a lot of</span> <span data-start="1000.769" data-end="1003.589">speed benefit so you know before we</span> <span data-start="1003.589" data-end="1004.97">start we actually kind of have to scan</span> <span data-start="1004.97" data-end="1006.589">all the JavaScript files it's really</span> <span data-start="1006.589" data-end="1008.389">easy to do that in parallel and notes oh</span> <span data-start="1008.389" data-end="1010.43">that's great we also had to integrate</span> <span data-start="1010.43" data-end="1012.709">j/s dom and could text fi in order to</span> <span data-start="1012.709" data-end="1014.99">support browser code and that slows us</span> <span data-start="1014.99" data-end="1016.819">down you know and again like I wish we</span> <span data-start="1016.819" data-end="1018.319">didn't need context to Phi that I think</span> <span data-start="1018.319" data-end="1023.6">was a mistake we made for isolation we</span> <span data-start="1023.6" data-end="1025.189">did a couple things one is we made it so</span> <span data-start="1025.189" data-end="1027.65">that the each test runs in its own VM</span> <span data-start="1027.65" data-end="1030.02">and that prevents cascading failures</span> <span data-start="1030.02" data-end="1032.299">because I think like if developers get</span> <span data-start="1032.299" data-end="1035">used to the idea that you know unit test</span> <span data-start="1035" data-end="1036.74">breakage doesn't necessarily mean that</span> <span data-start="1036.74" data-end="1038.48">something's broken they'll start to</span> <span data-start="1038.48" data-end="1040.01">ignore it and then you know the tests</span> <span data-start="1040.01" data-end="1042.079">rot really quickly the other thing that</span> <span data-start="1042.079" data-end="1044.299">we did is we made is that by default you</span> <span data-start="1044.299" data-end="1046.039">get a mock when you require something</span> <span data-start="1046.039" data-end="1048.14">and this was actually inspired by Felix</span> <span data-start="1048.14" data-end="1050.24">goose and darf who's I think he's here</span> <span data-start="1050.24" data-end="1053.809">at he presented at node Kampf like over</span> <span data-start="1053.809" data-end="1056.24">a year ago his micro test framework and</span> <span data-start="1056.24" data-end="1058.22">you know it's the idea of using a</span> <span data-start="1058.22" data-end="1061.039">require as a seam to inject test doubles</span> <span data-start="1061.039" data-end="1063.89">and it's great it works really well that</span> <span data-start="1063.89" data-end="1065.57">was pretty awesome than looking for that</span> <span data-start="1065.57" data-end="1068.99">guy but you know I can talk a little</span> <span data-start="1068.99" data-end="1071.03">more about that but I don't have a lot</span> <span data-start="1071.03" data-end="1072.74">of time okay and then the last thing is</span> <span data-start="1072.74" data-end="1074.539">you know this hack ability idea and</span> <span data-start="1074.539" data-end="1076.64">they're the best thing working for us</span> <span data-start="1076.64" data-end="1078.44">so at Facebook we don't have production</span> <span data-start="1078.44" data-end="1080.24">systems that run node but there are a</span> <span data-start="1080.24" data-end="1081.47">lot of people who do want to hack on</span> <span data-start="1081.47" data-end="1083.539">nodes so the very fact that it's all</span> <span data-start="1083.539" data-end="1084.89">written a note is great and then the</span> <span data-start="1084.89" data-end="1086.299">other thing that we did is instead of</span> <span data-start="1086.299" data-end="1088.19">integrating with crappy old legacy</span> <span data-start="1088.19" data-end="1090.35">systems we rewrote them you know even</span> <span data-start="1090.35" data-end="1092.21">though it was extra work it makes it</span> <span data-start="1092.21" data-end="1094.34">like all the code is shiny and new you</span> <span data-start="1094.34" data-end="1096.44">know when you go track down a dependency</span> <span data-start="1096.44" data-end="1098.24">chain like you're looking at JavaScript</span> <span data-start="1098.24" data-end="1102.83">code and not crazy legacy PHP okay the</span> <span data-start="1102.83" data-end="1104.33">last thing and this is like kind of</span> <span data-start="1104.33" data-end="1108.919">where it gets weird so come with me you</span> <span data-start="1108.919" data-end="1110.72">know we we sort of abandoned like</span> <span data-start="1110.72" data-end="1113">object-oriented programming for this or</span> <span data-start="1113" data-end="1114.769">at least like sort of the framework</span> <span data-start="1114.769" data-end="1118.76">style MVC I mean I want yeah and I want</span> <span data-start="1118.76" data-end="1120.98">to talk about you know why why we did</span> <span data-start="1120.98" data-end="1123.86">that so here let's again we'll consider</span> <span data-start="1123.86" data-end="1126.62">that chat tab view that window and you</span> <span data-start="1126.62" data-end="1128.86">know here's like a classic MVC</span> <span data-start="1128.86" data-end="1130.549">constructor for that thing we're gonna</span> <span data-start="1130.549" data-end="1133.46">take a thread object and the Dom node</span> <span data-start="1133.46" data-end="1134.659">and what we're gonna do is like attach</span> <span data-start="1134.659" data-end="1137.09">our template for the window to that Dom</span> <span data-start="1137.09" data-end="1138.83">node and like let's just think about</span> <span data-start="1138.83" data-end="1140.75">what we need to do to fill out the top</span> <span data-start="1140.75" data-end="1142.279">bar of that chat window that needs to</span> <span data-start="1142.279" data-end="1144.559">say like you know Adam man and two</span> <span data-start="1144.559" data-end="1147.71">others or whatever um so you know when</span> <span data-start="1147.71" data-end="1149.779">you start off and it's like a sunny day</span> <span data-start="1149.779" data-end="1151.909">and you know it's the first file of your</span> <span data-start="1151.909" data-end="1153.019">new project you write something like</span> <span data-start="1153.019" data-end="1154.97">this you say oh yeah the thread has</span> <span data-start="1154.97" data-end="1157.279">participants so we'll just get those</span> <span data-start="1157.279" data-end="1159.889">participants and we'll like map over all</span> <span data-start="1159.889" data-end="1161.63">the names of the participants and use</span> <span data-start="1161.63" data-end="1163.76">that to generate the title and you know</span> <span data-start="1163.76" data-end="1166.76">this works this is great toy program you</span> <span data-start="1166.76" data-end="1168.799">like go show it to the product manager</span> <span data-start="1168.799" data-end="1171.59">he's all excited you know keep going so</span> <span data-start="1171.59" data-end="1173.96">but then you realize that you know you</span> <span data-start="1173.96" data-end="1175.82">get sometimes you get a message and you</span> <span data-start="1175.82" data-end="1177.679">don't have the data for the thread you</span> <span data-start="1177.679" data-end="1178.669">need to be able to talk about this</span> <span data-start="1178.669" data-end="1181.549">thread just as an ID before you really</span> <span data-start="1181.549" data-end="1185.09">know what's in it so cross that out and</span> <span data-start="1185.09" data-end="1187.76">replace it with like some evented thing</span> <span data-start="1187.76" data-end="1190.159">where you know the the thread has a load</span> <span data-start="1190.159" data-end="1192.08">event that distinguishes between the</span> <span data-start="1192.08" data-end="1194.179">case where it's got data in it and it</span> <span data-start="1194.179" data-end="1195.38">doesn't and then you know you have to</span> <span data-start="1195.38" data-end="1197.269">kind of wring your hands a little bit</span> <span data-start="1197.269" data-end="1199.01">about like okay but what if it already</span> <span data-start="1199.01" data-end="1200.87">loaded by the time I get here you know</span> <span data-start="1200.87" data-end="1202.7">what does that mean but you know there</span> <span data-start="1202.7" data-end="1203.809">are answers to that question</span> <span data-start="1203.809" data-end="1206.059">so now you know you sort of wait for</span> <span data-start="1206.059" data-end="1207.289">this load event you register your</span> <span data-start="1207.289" data-end="1209">callback and then you get the</span> <span data-start="1209" data-end="1210.05">participants for this</span> <span data-start="1210.05" data-end="1212.39">red and that works for a little while</span> <span data-start="1212.39" data-end="1214.46">until you know you get to this group cap</span> <span data-start="1214.46" data-end="1216.8">feature where you realize that like you</span> <span data-start="1216.8" data-end="1219.32">may end up on the thread with</span> <span data-start="1219.32" data-end="1220.76">participants who you don't know about</span> <span data-start="1220.76" data-end="1222.14">yet and what are we gonna do about that</span> <span data-start="1222.14" data-end="1225.59">you know and this is where I you see two</span> <span data-start="1225.59" data-end="1228.8">approaches you know one is people try to</span> <span data-start="1228.8" data-end="1230.81">like have this invariant that we never</span> <span data-start="1230.81" data-end="1232.22">have threads that don't have</span> <span data-start="1232.22" data-end="1235.67">participants at the best case that leads</span> <span data-start="1235.67" data-end="1237.11">to over fetching right cuz like that</span> <span data-start="1237.11" data-end="1238.52">means that every time you find out about</span> <span data-start="1238.52" data-end="1240.11">a thread you have to reef a CH all the</span> <span data-start="1240.11" data-end="1241.31">participants um</span> <span data-start="1241.31" data-end="1243.8">worst case is like you have a bug or you</span> <span data-start="1243.8" data-end="1245.6">you know you've failed to capture this</span> <span data-start="1245.6" data-end="1248.21">untracked dependency and you get to the</span> <span data-start="1248.21" data-end="1249.92">client and you're you're trying to do</span> <span data-start="1249.92" data-end="1252.14">this render a thread you're missing</span> <span data-start="1252.14" data-end="1253.49">participant data and the only thing you</span> <span data-start="1253.49" data-end="1255.32">can do is error you've got no you know</span> <span data-start="1255.32" data-end="1258.32">you've got no way out of that so you</span> <span data-start="1258.32" data-end="1260">know probably the best thing to do is to</span> <span data-start="1260" data-end="1261.53">not do this and do the same thing to</span> <span data-start="1261.53" data-end="1263.93">participants that we did the threads so</span> <span data-start="1263.93" data-end="1266.42">we wait for the load of the thread and</span> <span data-start="1266.42" data-end="1267.95">then we have to wait for all the</span> <span data-start="1267.95" data-end="1270.23">participants to load and then we can</span> <span data-start="1270.23" data-end="1272.54">finally render the chat window and you</span> <span data-start="1272.54" data-end="1274.13">know by the time we get here like this</span> <span data-start="1274.13" data-end="1276.11">is no longer shiny and simple it's like</span> <span data-start="1276.11" data-end="1278.09">now really complicated and you've got</span> <span data-start="1278.09" data-end="1279.8">this sort of spaghetti evented system</span> <span data-start="1279.8" data-end="1281.99">you've got like subtle ordering</span> <span data-start="1281.99" data-end="1283.79">dependencies like if participants load</span> <span data-start="1283.79" data-end="1285.8">before threads that make aynd of change</span> <span data-start="1285.8" data-end="1287.6">the behavior here it's it's not obvious</span> <span data-start="1287.6" data-end="1291.98">what's going to happen so um you know</span> <span data-start="1291.98" data-end="1293.75">there there are two things that like I</span> <span data-start="1293.75" data-end="1295.64">really don't like about this style I'll</span> <span data-start="1295.64" data-end="1297.74">try to point them out quickly the first</span> <span data-start="1297.74" data-end="1301.3">one is you know let's just be okay with</span> <span data-start="1301.3" data-end="1303.83">constructors and initializers and like</span> <span data-start="1303.83" data-end="1307.61">you know class keyword thank you but but</span> <span data-start="1307.61" data-end="1310.43">you know we have two different kinds of</span> <span data-start="1310.43" data-end="1312.02">api's that don't look different right</span> <span data-start="1312.02" data-end="1314.9">like the thread knows it's ID and you</span> <span data-start="1314.9" data-end="1317.45">can always call get ID that's fine but</span> <span data-start="1317.45" data-end="1319.31">to call get participants you have to</span> <span data-start="1319.31" data-end="1321.35">wait for the load event and like there's</span> <span data-start="1321.35" data-end="1323.18">nothing obvious in the API that says</span> <span data-start="1323.18" data-end="1324.95">this you have to kind of like read</span> <span data-start="1324.95" data-end="1326.03">through the code or keep the</span> <span data-start="1326.03" data-end="1327.83">documentation up-to-date or whatever to</span> <span data-start="1327.83" data-end="1330.44">really know this and new developers will</span> <span data-start="1330.44" data-end="1331.49">come along and you know it works</span> <span data-start="1331.49" data-end="1334">sometime so it's like really confusing</span> <span data-start="1334" data-end="1337.25">um the other thing that really hurts is</span> <span data-start="1337.25" data-end="1339.35">testability right so like consider our</span> <span data-start="1339.35" data-end="1341.72">test for the participants behaviors</span> <span data-start="1341.72" data-end="1343.36">around threads</span> <span data-start="1343.36" data-end="1345.52">what we're gonna do is you know we can</span> <span data-start="1345.52" data-end="1347.83">make a new thread that's easy but when</span> <span data-start="1347.83" data-end="1349.66">we call get participants in the context</span> <span data-start="1349.66" data-end="1352.69">of a test it's like unclear what we need</span> <span data-start="1352.69" data-end="1355.15">to test here you know like we can do two</span> <span data-start="1355.15" data-end="1357.58">things one thing one thing we can do is</span> <span data-start="1357.58" data-end="1359.92">we can sort of return real participants</span> <span data-start="1359.92" data-end="1361.81">from this call in which case like now we</span> <span data-start="1361.81" data-end="1363.07">don't have a unit test we've got an</span> <span data-start="1363.07" data-end="1364.33">integration test of threads and</span> <span data-start="1364.33" data-end="1366.52">participants or we can return mock</span> <span data-start="1366.52" data-end="1368.44">participants from here in which case</span> <span data-start="1368.44" data-end="1371.02">like the mock four participants needs to</span> <span data-start="1371.02" data-end="1374.56">be really clear about like what what is</span> <span data-start="1374.56" data-end="1376.45">done by participants code and what is</span> <span data-start="1376.45" data-end="1378.43">done by thread code so you know you you</span> <span data-start="1378.43" data-end="1380.11">still bundled these things together and</span> <span data-start="1380.11" data-end="1381.61">pulling them apart again is pretty hard</span> <span data-start="1381.61" data-end="1384.16">um and you know this makes me wonder</span> <span data-start="1384.16" data-end="1385.84">like why do we do this whole</span> <span data-start="1385.84" data-end="1387.43">object-oriented programming thing like</span> <span data-start="1387.43" data-end="1390.61">what what got us here and you know the</span> <span data-start="1390.61" data-end="1392.56">first part that like the ones we're all</span> <span data-start="1392.56" data-end="1394.27">programmers you know the one thing I</span> <span data-start="1394.27" data-end="1396.13">think we're all good with is abstraction</span> <span data-start="1396.13" data-end="1397.51">right like you wouldn't you wouldn't</span> <span data-start="1397.51" data-end="1398.38">write code if you didn't like</span> <span data-start="1398.38" data-end="1400.36">abstraction and I think that's you know</span> <span data-start="1400.36" data-end="1403.27">that's something we can keep so in the</span> <span data-start="1403.27" data-end="1404.5">chat code they're definitely like</span> <span data-start="1404.5" data-end="1406.18">function constructors and function</span> <span data-start="1406.18" data-end="1408.1">prototypes they tend to be for like UI</span> <span data-start="1408.1" data-end="1410.74">controls you know like that menu or just</span> <span data-start="1410.74" data-end="1412.3">or the chat tab view things that we're</span> <span data-start="1412.3" data-end="1415">gonna have a few of but um but that's</span> <span data-start="1415" data-end="1417.19">where I would say it stops you know like</span> <span data-start="1417.19" data-end="1420.79">inheritance that you know that's when</span> <span data-start="1420.79" data-end="1422.29">we're like even in languages that are</span> <span data-start="1422.29" data-end="1424.9">built around inheritance like Java like</span> <span data-start="1424.9" data-end="1426.37">the best directive there is to use</span> <span data-start="1426.37" data-end="1428.14">delegation rather than inheritance</span> <span data-start="1428.14" data-end="1429.88">because you know it's just so brittle</span> <span data-start="1429.88" data-end="1431.44">like once you've put something in an</span> <span data-start="1431.44" data-end="1434.29">inheritance tree then you can't get it</span> <span data-start="1434.29" data-end="1436.18">from anywhere else except subclasses and</span> <span data-start="1436.18" data-end="1438.28">you know no one really does a good job</span> <span data-start="1438.28" data-end="1440.43">of like designing for inheritance like</span> <span data-start="1440.43" data-end="1442.54">designing an API is hard and then</span> <span data-start="1442.54" data-end="1444.4">designing a class that can be inherited</span> <span data-start="1444.4" data-end="1447.75">is like you know ten times harder</span> <span data-start="1447.75" data-end="1449.62">polymorphism is another one where like</span> <span data-start="1449.62" data-end="1450.97">if you have a language that has</span> <span data-start="1450.97" data-end="1452.92">first-class functions and callbacks I</span> <span data-start="1452.92" data-end="1455.02">just don't get why you'd have this crazy</span> <span data-start="1455.02" data-end="1457.06">contract that says like by naming this</span> <span data-start="1457.06" data-end="1459.94">function show I am participating in the</span> <span data-start="1459.94" data-end="1461.8">show able interface you know which is</span> <span data-start="1461.8" data-end="1464.07">like again this like super untracked</span> <span data-start="1464.07" data-end="1467.5">dependency in JavaScript and a callback</span> <span data-start="1467.5" data-end="1469.39">totally suffices there and is much more</span> <span data-start="1469.39" data-end="1471.61">flexible it means that you can have sort</span> <span data-start="1471.61" data-end="1474.07">of pieces of code that don't really that</span> <span data-start="1474.07" data-end="1475.57">aren't expressed as objects but can</span> <span data-start="1475.57" data-end="1477.1">still connect to</span> <span data-start="1477.1" data-end="1479.35">opponents that are um and then the last</span> <span data-start="1479.35" data-end="1481.299">one this is the worst one I don't even</span> <span data-start="1481.299" data-end="1483.1">get why this was a benefit in the first</span> <span data-start="1483.1" data-end="1487.36">place like data that is hidden is data</span> <span data-start="1487.36" data-end="1489.94">that you know is not serializable so</span> <span data-start="1489.94" data-end="1491.44">like you know when the browser page</span> <span data-start="1491.44" data-end="1493.66">unloads when the machine crashes when</span> <span data-start="1493.66" data-end="1495.7">you migrate data this is the stuff that</span> <span data-start="1495.7" data-end="1498.73">you lose and you know in facebook chat</span> <span data-start="1498.73" data-end="1499.929">what we found is it like we had to</span> <span data-start="1499.929" data-end="1501.91">externalise everything you know we have</span> <span data-start="1501.91" data-end="1503.74">to account for multiple clients marking</span> <span data-start="1503.74" data-end="1505.63">things as red or opening chat tabs or</span> <span data-start="1505.63" data-end="1508.27">whatever it's gonna be so like all of</span> <span data-start="1508.27" data-end="1510.37">our data ended up externalized and we</span> <span data-start="1510.37" data-end="1511.69">sort of now I think of like application</span> <span data-start="1511.69" data-end="1515.289">data should always just be JSON of old</span> <span data-start="1515.289" data-end="1517.39">data like it it should never be hidden</span> <span data-start="1517.39" data-end="1521.71">in this way okay so that's my little</span> <span data-start="1521.71" data-end="1525.37">rant what did we replace it with so you</span> <span data-start="1525.37" data-end="1528.22">know I have to scare quote this cuz like</span> <span data-start="1528.22" data-end="1531.73">we used a functional style not strict</span> <span data-start="1531.73" data-end="1533.08">functional at all and you know there are</span> <span data-start="1533.08" data-end="1535.419">places where we have objects and you</span> <span data-start="1535.419" data-end="1537.19">know it's it's intermixed but like in</span> <span data-start="1537.19" data-end="1540.01">general I would say you know modules are</span> <span data-start="1540.01" data-end="1542.169">connected by functions and not by events</span> <span data-start="1542.169" data-end="1545.26">or named interfaces instead of like</span> <span data-start="1545.26" data-end="1547.6">class instances so instead of a thread</span> <span data-start="1547.6" data-end="1550.12">instance we use a singleton to represent</span> <span data-start="1550.12" data-end="1553">like all the threads and then this last</span> <span data-start="1553" data-end="1554.23">thing is the thing I just talked about</span> <span data-start="1554.23" data-end="1556.48">we're like application data is generally</span> <span data-start="1556.48" data-end="1558.28">sort of thought of as always</span> <span data-start="1558.28" data-end="1561.4">serializable so let's go back and look</span> <span data-start="1561.4" data-end="1563.23">at that chat tab view example now and</span> <span data-start="1563.23" data-end="1564.61">you know the first thing you'll see is</span> <span data-start="1564.61" data-end="1565.78">that like the signature for this</span> <span data-start="1565.78" data-end="1567.19">constructor is different instead of</span> <span data-start="1567.19" data-end="1569.47">getting past a thread object it gets</span> <span data-start="1569.47" data-end="1571.539">past a thread ID which is just a string</span> <span data-start="1571.539" data-end="1574.39">and now to go get the data about that</span> <span data-start="1574.39" data-end="1577.03">thread sorry first we're gonna attach a</span> <span data-start="1577.03" data-end="1578.409">template that doesn't change we're gonna</span> <span data-start="1578.409" data-end="1580">pick out the title just so that we can</span> <span data-start="1580" data-end="1581.409">close over that it makes it code look</span> <span data-start="1581.409" data-end="1583.69">better but then when we want the data</span> <span data-start="1583.69" data-end="1586.33">about that we pass that ID back to the</span> <span data-start="1586.33" data-end="1590.71">threads singleton and go and pass a</span> <span data-start="1590.71" data-end="1593.32">continuation that will get handed the</span> <span data-start="1593.32" data-end="1595.69">data for about that Fred once we have it</span> <span data-start="1595.69" data-end="1597.28">and that means that like if we have it</span> <span data-start="1597.28" data-end="1598.87">great you get called back right away if</span> <span data-start="1598.87" data-end="1600.58">we don't we can go back to the server</span> <span data-start="1600.58" data-end="1602.1">and get it for you</span> <span data-start="1602.1" data-end="1604.75">so this continuation then gets the</span> <span data-start="1604.75" data-end="1606.49">thread metadata and we do the same trick</span> <span data-start="1606.49" data-end="1608.77">with participants and you'll notice that</span> <span data-start="1608.77" data-end="1610.54">thread and participants are completely</span> <span data-start="1610.54" data-end="1613.93">coupled in this case so you know this</span> <span data-start="1613.93" data-end="1616.12">changes the API it makes it simpler</span> <span data-start="1616.12" data-end="1618.61">right threads is just a singleton and</span> <span data-start="1618.61" data-end="1620.71">you can obviously tell like what things</span> <span data-start="1620.71" data-end="1622.66">support direct returns are like you know</span> <span data-start="1622.66" data-end="1623.8">let's say there's some trivial ID</span> <span data-start="1623.8" data-end="1625.18">transformation that we can do on the</span> <span data-start="1625.18" data-end="1627.61">client obviously you just pass in an ID</span> <span data-start="1627.61" data-end="1630.97">get back the normalized ID but the get</span> <span data-start="1630.97" data-end="1634.57">function here takes a continuation so</span> <span data-start="1634.57" data-end="1635.92">you know that you have to pass that</span> <span data-start="1635.92" data-end="1640.09">along with your call for testability</span> <span data-start="1640.09" data-end="1642.94">it's like a similar thing where you know</span> <span data-start="1642.94" data-end="1645.25">instead of being bound to the</span> <span data-start="1645.25" data-end="1646.93">participants data we can use like a mock</span> <span data-start="1646.93" data-end="1649">function here that we just made this</span> <span data-start="1649" data-end="1650.71">like utility knife function that can be</span> <span data-start="1650.71" data-end="1653.32">called as a constructor or an instance</span> <span data-start="1653.32" data-end="1655.3">method or raw function that captures the</span> <span data-start="1655.3" data-end="1657.46">calls and can also be used to inject</span> <span data-start="1657.46" data-end="1660.37">return data so here we just pass a mock</span> <span data-start="1660.37" data-end="1662.59">function to this callback and then we</span> <span data-start="1662.59" data-end="1664.15">can poke it off you know do various</span> <span data-start="1664.15" data-end="1665.29">things with the mocks make sure that</span> <span data-start="1665.29" data-end="1667.42">threads made an async request if we</span> <span data-start="1667.42" data-end="1668.92">expect it to whatever that's going to be</span> <span data-start="1668.92" data-end="1671.55">and then when we want to verify the data</span> <span data-start="1671.55" data-end="1674.08">again it can be expressed in JSON so we</span> <span data-start="1674.08" data-end="1675.52">just have like this simple equality</span> <span data-start="1675.52" data-end="1677.17">check to be able to talk about our</span> <span data-start="1677.17" data-end="1681.4">expectations there you know I do want to</span> <span data-start="1681.4" data-end="1683.29">at least build up a straw man and tear</span> <span data-start="1683.29" data-end="1684.88">it down about this functional style so</span> <span data-start="1684.88" data-end="1686.32">what are the what are some of the things</span> <span data-start="1686.32" data-end="1688.99">that I hear objections to you know I</span> <span data-start="1688.99" data-end="1691.21">think that most common ones like this is</span> <span data-start="1691.21" data-end="1693.91">too hard you know like four layers of</span> <span data-start="1693.91" data-end="1695.83">nested callbacks is like it's too hard</span> <span data-start="1695.83" data-end="1697.27">to follow the code it's hard to write</span> <span data-start="1697.27" data-end="1698.89">the code and and people usually talk</span> <span data-start="1698.89" data-end="1700.93">about this is like I get it but someone</span> <span data-start="1700.93" data-end="1704.2">else wouldn't and you know I guess what</span> </p>
<p><span data-start="1704.2" data-end="1706.18">I say is like yeah coatings hard you</span> <span data-start="1706.18" data-end="1708.34">know that's that's just the way it goes</span> <span data-start="1708.34" data-end="1711.39">buddy you know writing these apps are</span> <span data-start="1711.39" data-end="1713.71">like if they weren't hard to build then</span> <span data-start="1713.71" data-end="1714.91">everyone would build them and you know</span> <span data-start="1714.91" data-end="1716.68">we'd be out of a job</span> <span data-start="1716.68" data-end="1720.79">the the other side of this is that it's</span> <span data-start="1720.79" data-end="1722.47">like hard to follow you know it's like</span> <span data-start="1722.47" data-end="1725.44">kind of it can be like really and you</span> <span data-start="1725.44" data-end="1726.88">know this is related to the like super</span> <span data-start="1726.88" data-end="1728.98">indenting thing I guess what I would say</span> <span data-start="1728.98" data-end="1730.72">is I think it's clearer than the than</span> <span data-start="1730.72" data-end="1732.94">the tangle of events you get in a lot of</span> <span data-start="1732.94" data-end="1734.68">OOP code and so I like it better that</span> <span data-start="1734.68" data-end="1736.11">way</span> <span data-start="1736.11" data-end="1738.13">another thing you see is like there are</span> <span data-start="1738.13" data-end="1739.96">too many includes in these files and</span> <span data-start="1739.96" data-end="1741.19">it's true like at the bottom of our</span> <span data-start="1741.19" data-end="1742.72">dependency chains like I was looking at</span> <span data-start="1742.72" data-end="1743.44">chat tab</span> <span data-start="1743.44" data-end="1745.72">to prepare for this presentation and at</span> <span data-start="1745.72" data-end="1748.419">this point they're like forty includes</span> <span data-start="1748.419" data-end="1750.34">at the top of that file I guess the</span> <span data-start="1750.34" data-end="1751.57">thing I would say is like at least the</span> <span data-start="1751.57" data-end="1754">dependencies are tracked and not and not</span> <span data-start="1754" data-end="1755.379">on track the way they are in that</span> <span data-start="1755.379" data-end="1757.899">threads participants example and then</span> <span data-start="1757.899" data-end="1759.759">the last one is like this is legit like</span> <span data-start="1759.759" data-end="1761.71">you end up using bind a lot when you use</span> <span data-start="1761.71" data-end="1763.029">this style and that can be really</span> <span data-start="1763.029" data-end="1764.919">inefficient like if you bind at every</span> <span data-start="1764.919" data-end="1767.529">call site like every time you call a</span> <span data-start="1767.529" data-end="1770.86">method on another module and pass a</span> <span data-start="1770.86" data-end="1773.62">callback if you bind every time that</span> <span data-start="1773.62" data-end="1776.049">uses memory so you do have to watch out</span> <span data-start="1776.049" data-end="1779.32">for that one I hoped I'd have time for</span> <span data-start="1779.32" data-end="1780.49">questions but I don't you'll just have</span> <span data-start="1780.49" data-end="1782.379">to find me and I'd love to talk about</span> <span data-start="1782.379" data-end="1784.179">functional and OOP or chat or and</span> <span data-start="1784.179" data-end="1788.559">anything else but I guess here's what I</span> <span data-start="1788.559" data-end="1790.87">have to say modularity that's the big</span> <span data-start="1790.87" data-end="1792.46">win you know that that's what you</span> <span data-start="1792.46" data-end="1794.559">absolutely need to do unit testing goes</span> <span data-start="1794.559" data-end="1796.45">right with it I highly recommend it and</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
