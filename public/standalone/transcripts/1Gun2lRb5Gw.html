<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="web.dev LIVE video transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>1Gun2lRb5Gw</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/1Gun2lRb5Gw?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="10.06" data-end="11.12">Hi, I'm Mike Samuel.</span> <span data-start="11.12" data-end="16.119">I work on Google's security engineering team where we try to improve programming languages,</span> <span data-start="16.119" data-end="21.109">libraries, frameworks and other parts of our software development tool chain to make it</span> <span data-start="21.109" data-end="27.89">easier to secure robust software.</span> <span data-start="27.89" data-end="33.039">Practice of programming has some of the best advice on how to avoid bugs in your software.</span> <span data-start="33.039" data-end="38.11">So, every bug you can find can teach you how to prevent a similar bug from happening again,</span> <span data-start="38.11" data-end="42.079">or to recognize if it does.</span> <span data-start="42.079" data-end="47.5">And my colleagues and I put together a roadmap for Node.js security.</span> <span data-start="47.5" data-end="55.739">We want to understand what are the kinds of bugs that have security consequences in Node.js.</span> <span data-start="55.739" data-end="57.05">I'm not going to walk you through it.</span> </p>
<p><span data-start="57.05" data-end="64.89">I would like to show you a little bit about how security engineers go about our work.</span> <span data-start="64.89" data-end="70.82">How we identify classes of vulnerabilities and try to address them.</span> <span data-start="70.82" data-end="76.61">What I would like to impress upon you, given the right tools, we can address entire classes</span> <span data-start="76.61" data-end="78.57">of vulnerabilities.</span> <span data-start="78.57" data-end="84.5">Instead of just finding a particular instance, we want to deal with all instances of a bug</span> <span data-start="84.5" data-end="86.119">in a product.</span> <span data-start="86.119" data-end="89.189">So, I'm going to show you some mediocre code.</span> <span data-start="89.189" data-end="91.77">This is code that I've written.</span> </p>
<p><span data-start="91.77" data-end="96.97">And I'm going to walk through it and show you some bugs in it.</span> <span data-start="96.97" data-end="104.89">Then I want to show you how we can comprehensively address the root causes of those issues.</span> <span data-start="104.89" data-end="112.14">Then I'll get into some of the human factors and how web standards can help us advance</span> <span data-start="112.14" data-end="113.14">security.</span> <span data-start="113.14" data-end="117.81">So, let me show you some code.</span> <span data-start="117.81" data-end="122.119">So, can you is this is this something that people can see?</span> <span data-start="122.119" data-end="125.75">If this is too small, you might want to move forward.</span> <span data-start="125.75" data-end="130.27">So, as you can see, this is a vanilla Node.js server.</span> </p>
<p><span data-start="130.27" data-end="133.98">I'm requiring a bunch of modules up top.</span> <span data-start="133.98" data-end="140.36">The least popular of these modules has about 350,000 downloads per week.</span> <span data-start="140.36" data-end="144.52">So, these are not uncommon modules to see.</span> <span data-start="144.52" data-end="147.38">I'm setting some headers.</span> </p>
<p><span data-start="147.38" data-end="154.47">And, well, the Chrome people would be unhappy with me if I showed Chrome XSS protection</span> <span data-start="154.47" data-end="156.12">bypasses.</span> <span data-start="156.12" data-end="162.47">So, I'm putting in XSS zero for demo purposes.</span> <span data-start="162.47" data-end="165.28">And then I've got a function that creates a handler.</span> </p>
<p><span data-start="165.28" data-end="167.98">So, it does some session management.</span> <span data-start="167.98" data-end="172.44">Make sure there's a unique per client cookie.</span> <span data-start="172.44" data-end="177.11">And then we get into the bulk of the handler function.</span> <span data-start="177.11" data-end="183.52">So, you can see here in the middle it's I've defined the URL space.</span> <span data-start="183.52" data-end="187.31">We have slash, which is our index page.</span> <span data-start="187.31" data-end="191.84">Upload, which lets me upload a file.</span> <span data-start="191.84" data-end="194.99">Calculate, which calculates an expression.</span> <span data-start="194.99" data-end="196.13">And then we collect client errors.</span> <span data-start="196.13" data-end="200.15">So, let me show you how this works in practice.</span> <span data-start="200.15" data-end="206.34">So, the goal of this application is to let people upload equations and then compute them</span> <span data-start="206.34" data-end="207.71">with results.</span> <span data-start="207.71" data-end="215.01">And so, I can choose XPY just as the text X plus Y in it.</span> <span data-start="215.01" data-end="217.77">I upload that file.</span> <span data-start="217.77" data-end="222.83">It gives me something that I can share with other users.</span> <span data-start="222.83" data-end="225.99">And I can type some JSON into the box here.</span> <span data-start="225.99" data-end="229.27">You see that I've got a radio button.</span> </p>
<p><span data-start="229.27" data-end="236.14">And if I can type a line of JSON without screwing up.</span> <span data-start="236.14" data-end="238.48">I get one plus one is 42.</span> <span data-start="238.48" data-end="243.71">This isn't particularly surprising, but I have to wonder what it all means.</span> <span data-start="243.71" data-end="252.47">So, we've got our URL space and then we get into the handlers.</span> <span data-start="252.47" data-end="260.53">So, you can see when we're serving the index page, we spit out a bunch of HTML.</span> <span data-start="260.53" data-end="267.85">And we spit out a form with our text area and a radio button for each of our uploaded</span> <span data-start="267.85" data-end="269.93">files.</span> <span data-start="269.93" data-end="273.65">And at the bottom we have our upload form.</span> <span data-start="273.65" data-end="283.85">So, once we've got our equation, once once a user tries to upload forms, I use multi</span> <span data-start="283.85" data-end="287.35">party to handle the upload.</span> <span data-start="287.35" data-end="296.79">For each file I multi party gives us a random file name for each file.</span> <span data-start="296.79" data-end="299.83">It give uses a temporary file.</span> <span data-start="299.83" data-end="302.15">And we're calling out to the shell.</span> <span data-start="302.15" data-end="304.64">So, we see to the directory.</span> <span data-start="304.64" data-end="309.93">We create a directory for the current session if one doesn't exist.</span> <span data-start="309.93" data-end="321.06">We move the temporary file into a shared path which gives us which just has the same base</span> <span data-start="321.06" data-end="322.46">name as the temporary file.</span> </p>
<p><span data-start="322.46" data-end="324.97">That's an auto generated file name.</span> <span data-start="324.97" data-end="329.93">And then we link the shared file into the current user's directory.</span> <span data-start="329.93" data-end="334.82">So, you're probably thinking, he's calling out to the shell, this is a big security no</span> <span data-start="334.82" data-end="335.96">no.</span> <span data-start="335.96" data-end="343.07">This kind of thing happens in a lot of code because the shell is so seductively simple.</span> <span data-start="343.07" data-end="349.25">This is a very succinct piece of code that does something that will probably require</span> <span data-start="349.25" data-end="350.68">a dozen lines.</span> <span data-start="350.68" data-end="356.48">In addition, all of the inputs, FS route is controlled by the application.</span> </p>
<p><span data-start="356.48" data-end="361.66">This directory is based on random numbers generated by the application.</span> <span data-start="361.66" data-end="363.16">They're not controlled by an attacker.</span> <span data-start="363.16" data-end="365.88">The same for the rest of it.</span> <span data-start="365.88" data-end="370.21">The attacker controls none of this none of the inputs to this.</span> <span data-start="370.21" data-end="373.65">Except as it turns out, the file extension of the uploaded file.</span> <span data-start="373.65" data-end="381.46">So, this seems like a very incontroversial use of something that's known to be a hazard.</span> <span data-start="381.46" data-end="394.74">And as it turns out, there is a subtle bug in excuse me.</span> <span data-start="394.74" data-end="403.4">So, I can send a crafted input, if I don't fall off the stage.</span> <span data-start="403.4" data-end="408.51">I can send a crafted input to the upload form.</span> </p>
<p><span data-start="408.51" data-end="421.53">And it has this file name.</span> <span data-start="421.53" data-end="422.53">And that works.</span> <span data-start="422.53" data-end="425.82">You can see that it's generated the crafted upload here.</span> <span data-start="425.82" data-end="430.08">Based on this file extension.</span> <span data-start="430.08" data-end="437">That file extension is X.Y followed by an obscure Unicode new line.</span> </p>
<p><span data-start="437" data-end="440.09">Followed by something which breaks out of coded string.</span> <span data-start="440.09" data-end="444.59">Then it does touch, and then it continues on with something.</span> <span data-start="444.59" data-end="452.4">It reopens the quote so that the whole form is a valid shell string.</span> <span data-start="452.4" data-end="463.18">And if I look for the file, it's now sitting in the root directory of my application.</span> <span data-start="463.18" data-end="475.84">So, what happened was we a very quite uncontroversial use of the shell.</span> <span data-start="475.84" data-end="482.81">Due to an obscure bug in a in a third party library.</span> <span data-start="482.81" data-end="483.88">One that has been fixed, by the way.</span> <span data-start="483.88" data-end="488.51">So, I'm not reporting zero days here.</span> <span data-start="488.51" data-end="496.949">An obscure bug in a third party library lets me take offer the shell, get shell special</span> <span data-start="496.949" data-end="504.96">characters into where the user thought that there were only going to be alphanumerics</span> <span data-start="504.96" data-end="508.3">from a randomly generated file name.</span> <span data-start="508.3" data-end="514.8">And so, we need to have more consistent ways to address this problem.</span> </p>
<p><span data-start="514.8" data-end="518.26">And that's going to be a theme throughout this talk.</span> <span data-start="518.26" data-end="529.45">So, moving on, when we calculate the result, we lead the uploaded file, including the text,</span> <span data-start="529.45" data-end="531.76">plus one.</span> <span data-start="531.76" data-end="535.27">We parse some JSON.</span> <span data-start="535.27" data-end="540.77">When I showed you earlier, I showed you JSON which said X was 1 and Y was 41.</span> <span data-start="540.77" data-end="549.65">And then we get we use a library that checks that the uploaded file only contains arithmetic</span> <span data-start="549.65" data-end="551.02">operations.</span> </p>
<p><span data-start="551.02" data-end="555.529">And then the result of that is probably going to be a number.</span> <span data-start="555.529" data-end="558.5">So, we output a string if everything is okay.</span> <span data-start="558.5" data-end="563.04">If there's an error message, we tell you there's an error message.</span> <span data-start="563.04" data-end="564.7">We're careful to escape it.</span> <span data-start="564.7" data-end="568.2">If not, we don't.</span> <span data-start="568.2" data-end="572.79">There's a problem.</span> <span data-start="572.79" data-end="583.83">Arithmetic expressions in JavaScript sometimes produce strings.</span> <span data-start="583.83" data-end="592.08">And so, that allows me to run arbitrary JavaScript.</span> <span data-start="592.08" data-end="596.37">If you didn't catch that, there was an alert which popped up.</span> <span data-start="596.37" data-end="603.29">So, the payload is script alert, one script, I ran that on the client.</span> <span data-start="603.29" data-end="613.9">So, again, the this is the kind of error, you know, that occurs in a lot of, for example,</span> <span data-start="613.9" data-end="620.92">ad hock reporting software where you need to report client side expressions.</span> <span data-start="620.92" data-end="622">It's an easy mistake to make.</span> <span data-start="622" data-end="632.83">You need a consistent way that the developer has [audio breaking up] we need the best ways</span> <span data-start="632.83" data-end="647.07">to our security catching all of our different client and, you know, on the server side we</span> <span data-start="647.07" data-end="651.43">also often want to figure out which one is on the client.</span> </p>
<p><span data-start="651.43" data-end="662.74">So, log client error is a receiver for for messages from the client on the client I don't</span> <span data-start="662.74" data-end="666.02">know if you can see this.</span> <span data-start="666.02" data-end="673">We keep patch console.error so that it not only dumps things to the developer console,</span> <span data-start="673" data-end="678.4">it also phones home with error messages.</span> <span data-start="678.4" data-end="684.19">And this is intriguing style little zebra.</span> <span data-start="684.19" data-end="688.89">I don't know if you guys are familiar with the colors module.</span> <span data-start="688.89" data-end="696.94">Let me just show you what this looks like in practice.</span> <span data-start="696.94" data-end="704.81">So, let's try not to fall off this side either.</span> <span data-start="704.81" data-end="708.94">So, I did console that error, zebras are so fun.</span> <span data-start="708.94" data-end="714.19">You see it shows up in the developer console.</span> <span data-start="714.19" data-end="721.35">And you can see down here, zebras are so fun.</span> <span data-start="721.35" data-end="731.73">And that happens because and the colors module allows you to colorize your log output.</span> </p>
<p><span data-start="731.73" data-end="736.5">This is the kind of thing that, you know, an intern comes into your project.</span> <span data-start="736.5" data-end="742.39">They decide, I'm having trouble trolling through the logs to find what I'm going to do.</span> <span data-start="742.39" data-end="744.55">I'm going to make their logs a little bit more awesome.</span> <span data-start="744.55" data-end="747.98">You know, zebras are so fun.</span> <span data-start="747.98" data-end="749.91">Rainbows are awesome.</span> </p>
<p><span data-start="749.91" data-end="754.01">And they're even more awesome when they're in your log files.</span> <span data-start="754.01" data-end="761.87">So, an attacker can obviously Spam your logs now.</span> <span data-start="761.87" data-end="769.42">But unless if you're going to accept telemetry from the client at all, especially when the</span> <span data-start="769.42" data-end="777.02">client isn't in a consistent state, you need to, you know, accept that and filter it later.</span> <span data-start="777.02" data-end="782.84">But there's another thing that an attacker can do with this.</span> <span data-start="782.84" data-end="797.58">Because of another subtle flaw that has since been fixed in the color package, I can upload</span> <span data-start="797.58" data-end="798.89">a file.</span> </p>
<p><span data-start="798.89" data-end="810.11">So, I'm going to upload helloworld.js.</span> <span data-start="810.11" data-end="812.74">It gives me this random string.</span> <span data-start="812.74" data-end="821.81">So, I'm going to say nuance equals that random string rather than trying to type out an entire</span> <span data-start="821.81" data-end="826.59">tech.</span> <span data-start="826.59" data-end="836.3">So, this attack code you can see over here.</span> <span data-start="836.3" data-end="841.95">It does a post to client error, but with a style that's equal to dot, dot, dot slash,</span> <span data-start="841.95" data-end="846.87">dot, dot slash uploads, slash not.</span> <span data-start="846.87" data-end="853.66">So, there is a subtle flaw in colors.js.</span> <span data-start="853.66" data-end="863.02">Colors, if the type of the theme is string, then it requires a theme.</span> <span data-start="863.02" data-end="869.23">Which allows you to get an arbitrary string, possibly attacker controlled, treated as a</span> <span data-start="869.23" data-end="871.269">module name.</span> <span data-start="871.269" data-end="881.91">So, you can see down here that the attacker code ran, hello world, and then we've got</span> <span data-start="881.91" data-end="889.92">the generic message that the attacker sent.</span> </p>
<p><span data-start="889.92" data-end="898.47">So, we saw three different exploits.</span> <span data-start="898.47" data-end="903.339">We saw exploits in, you know, this is contrived code that I've put together.</span> <span data-start="903.339" data-end="908.48">I wanted to put together, it's about 140 lines of code that is vulnerable to three different</span> <span data-start="908.48" data-end="913.91">kinds of three different classes of vulnerabilities.</span> <span data-start="913.91" data-end="919.2">It is the kind of code that you might say there's something dodgy going on in code review,</span> <span data-start="919.2" data-end="923.899">but hopefully if I've done my job, you can't quite put your finger on why.</span> <span data-start="923.899" data-end="927.339">And yet it leave this is application wide open.</span> <span data-start="927.339" data-end="928.899">What we didn't see was malicious code.</span> <span data-start="928.899" data-end="935.11">None of this code was written with the no malicious code reached this until it was actually</span> <span data-start="935.11" data-end="938.21">running in production.</span> <span data-start="938.21" data-end="941.49">We saw that the developer tried to resist attacks.</span> <span data-start="941.49" data-end="944.95">So, they put escape.HTML in almost all the right places.</span> </p>
<p><span data-start="944.95" data-end="946.79">But not consistently.</span> <span data-start="946.79" data-end="950.43">We saw widely used dependencies.</span> <span data-start="950.43" data-end="955.39">We didn't see uncommon dependencies that have probably not had enough eyeballs to catch</span> <span data-start="955.39" data-end="957.709">the errors.</span> <span data-start="957.709" data-end="962.22">And we saw the server side is still vulnerable.</span> <span data-start="962.22" data-end="970.23">And an npm audit, it's awesome, by the way, if you haven't come across it.</span> <span data-start="970.23" data-end="974.86">Npm audit reports no problems with this code.</span> <span data-start="974.86" data-end="981.36">So, what we need is we need a way these are the common kind of errors that developers</span> <span data-start="981.36" data-end="982.36">make.</span> <span data-start="982.36" data-end="986.54">What we need is a way to make sure that even when developers make common errors that we're</span> <span data-start="986.54" data-end="987.54">not vulnerable.</span> <span data-start="987.54" data-end="994.079">So, I'm going to show you how to fix these in what I hope are comprehensive ways.</span> </p>
<p><span data-start="994.079" data-end="995.97">The three problems.</span> <span data-start="995.97" data-end="1003.39">The abuse of require via the our client logs collection.</span> <span data-start="1003.39" data-end="1006.899">Shell injection when on a file upload.</span> <span data-start="1006.899" data-end="1010.04">And cross site scripting.</span> <span data-start="1010.04" data-end="1016.49">So, to fix access S, the first thing we do, it's kind of ironic.</span> <span data-start="1016.49" data-end="1021.6">We get rid of our dependency on escape.HTML.</span> <span data-start="1021.6" data-end="1028.35">And we actually get rid of most of our code that generates HTML and move it into templates.</span> <span data-start="1028.35" data-end="1035.25">So, here we're requiring generated files that are compiled from templates.</span> <span data-start="1035.25" data-end="1040.009">So, all of this goes away.</span> <span data-start="1040.009" data-end="1047.689">And we end up calling response.end with a call to a template.</span> <span data-start="1047.689" data-end="1050.609">That template is compiled from a pug file.</span> <span data-start="1050.609" data-end="1054.379">If you're not familiar with pug, it's a template language.</span> <span data-start="1054.379" data-end="1057.619">It auto escapes content.</span> <span data-start="1057.619" data-end="1063.379">So, in the case of let me see.</span> <span data-start="1063.379" data-end="1067.1">I'm having a hard time reading this.</span> </p>
<p><span data-start="1067.1" data-end="1070.97">So, here is a dynamic expression.</span> <span data-start="1070.97" data-end="1072.66">The name of a radio button.</span> <span data-start="1072.66" data-end="1075.789">It includes radio and a number.</span> <span data-start="1075.789" data-end="1079.47">That will be automatically escaped.</span> <span data-start="1079.47" data-end="1083.799">In this case, the session will be automatically HTML escaped.</span> <span data-start="1083.799" data-end="1088.909">So, this HTML escapes isn't perfect.</span> <span data-start="1088.909" data-end="1098.279">It Pug templates are still vulnerable to URLs, I'm working on a plugin to fix that.</span> <span data-start="1098.279" data-end="1107.029">We have moved our HTML generation, generating code, to something that is safe by default.</span> <span data-start="1107.029" data-end="1109.009">Users can opt out of escaping.</span> </p>
<p><span data-start="1109.009" data-end="1114.22">But security people like me can make scanners that can find those kinds of problems.</span> <span data-start="1114.22" data-end="1122.629">What we then do is take the templates and wrap them in a function, so the result is</span> <span data-start="1122.629" data-end="1124.09">a trusted HTML.</span> <span data-start="1124.09" data-end="1130.619">A trusted HTML creates a trusted HTML value from a string.</span> <span data-start="1130.619" data-end="1132.179">We're using the type system.</span> <span data-start="1132.179" data-end="1136.83">Instead of just passing strings around, we want to distinguish strings that we know are</span> <span data-start="1136.83" data-end="1143.98">safe from strings that we don't know where they come from.</span> <span data-start="1143.98" data-end="1149.57">Then we monkey patch response.right and response.end.</span> <span data-start="1149.57" data-end="1158.19">And what this means is that if any plain old string reaches response.end and response.right,</span> <span data-start="1158.19" data-end="1161.62">it won't get written.</span> <span data-start="1161.62" data-end="1163.279">You'll get an exception instead.</span> <span data-start="1163.279" data-end="1170.48">This kind of guides developers towards using tools that produce trusted HTML.</span> <span data-start="1170.48" data-end="1172.51">And so, we've covered the two endpoints.</span> <span data-start="1172.51" data-end="1174.609">We've got our sources for creating trusted HTML.</span> <span data-start="1174.609" data-end="1178.999">And we have our end point that only accepts trusted HTML.</span> <span data-start="1178.999" data-end="1182.69">This is not perfect.</span> </p>
<p><span data-start="1182.69" data-end="1186.789">A malicious developer could probably work around this by reaching into prototypes to</span> <span data-start="1186.789" data-end="1191.019">get at the underlying response.right.</span> <span data-start="1191.019" data-end="1195.529">But it's pretty good when you trust your developers and work with them.</span> <span data-start="1195.529" data-end="1199.559">And then what we need to do is we want to make sure we still have the problem.</span> <span data-start="1199.559" data-end="1200.85">What can create trusted HTML?</span> <span data-start="1200.85" data-end="1203.49">Well, it turns out, anybody.</span> <span data-start="1203.49" data-end="1208.61">Which means that the path for least resistance for a developer is, I trust myself to make</span> <span data-start="1208.61" data-end="1209.61">trusted HTML.</span> <span data-start="1209.61" data-end="1213.029">So, I'll make trusted HTML.</span> <span data-start="1213.029" data-end="1222.35">There's some machinery in this augmentable tine, a super type of trusted HTML.</span> <span data-start="1222.35" data-end="1227.69">There's some machinery in there which lets us control who can create those values.</span> <span data-start="1227.69" data-end="1230.639">So, this appears in package.JSON.</span> <span data-start="1230.639" data-end="1240.019">It says we're granting the ability to create trusted HTML to the following packages, trustedtemplate.js.</span> </p>
<p><span data-start="1240.019" data-end="1244.149">That's the file to wrap the pug templates.</span> <span data-start="1244.149" data-end="1251.19">There's one more to close the loop, but I'll point that out later.</span> <span data-start="1251.19" data-end="1257.789">And then as an additional security measure, we put in a pretty strict content security</span> <span data-start="1257.789" data-end="1258.789">policy.</span> <span data-start="1258.789" data-end="1264.859">So, if you guys are unfamiliar with the content security policy error, it allows you to specify</span> <span data-start="1264.859" data-end="1267.47">what scripts can low.</span> <span data-start="1267.47" data-end="1277.83">It receives the header and says I will only allow in this case scripts that have the source</span> <span data-start="1277.83" data-end="1283.979">CSP a nonce that is this CSP nonce value.</span> <span data-start="1283.979" data-end="1294.94">That value is defined up there as a random string that is scoped to the session.</span> <span data-start="1294.94" data-end="1297.36">So, every sorry, scoped to the response.</span> <span data-start="1297.36" data-end="1300.48">So, every response has a different CSP nonce.</span> <span data-start="1300.48" data-end="1307.46">So, that means that only script tags that are marked that way will run.</span> </p>
<p><span data-start="1307.46" data-end="1315.129">And then if there are any violations, they get reported and that show up in our logs.</span> <span data-start="1315.129" data-end="1325.289">And in our pug template we mark our script tag with the CSP nonce so that our form validation</span> <span data-start="1325.289" data-end="1327.799">code runs.</span> <span data-start="1327.799" data-end="1335.609">And so, we crafted a solution from save by default tools, pug, auto escapes, unless you</span> <span data-start="1335.609" data-end="1336.84">opt out.</span> <span data-start="1336.84" data-end="1339.519">And we can control those opt out.</span> </p>
<p><span data-start="1339.519" data-end="1345.71">It distinguishes safe from unsafe values for particular context.</span> <span data-start="1345.71" data-end="1352.35">In this case, the HTML that is allowed to be a part of a response body.</span> <span data-start="1352.35" data-end="1354.489">We checked the safety at run time.</span> <span data-start="1354.489" data-end="1358.499">So, we guarded our response writer.</span> <span data-start="1358.499" data-end="1362.059">Response.write doesn't take strings, only trusted HTML.</span> <span data-start="1362.059" data-end="1369.739">And we grant privilege the ability to make trusted values are stored in source control</span> <span data-start="1369.739" data-end="1373.519">and they're checked at run time.</span> <span data-start="1373.519" data-end="1380.019">So, static linters like ESLint and TSLint, they can catch it, but they are unsound.</span> <span data-start="1380.019" data-end="1389.019">And  on to the next vulnerability.</span> <span data-start="1389.019" data-end="1391.119">You saw this code already.</span> <span data-start="1391.119" data-end="1397.299">We were granting trusted HTML to trusted template.</span> <span data-start="1397.299" data-end="1404.629">We also granted the ability to create to SH template tag the ability to create something</span> <span data-start="1404.629" data-end="1406.369">called SH fragment.</span> <span data-start="1406.369" data-end="1411.96">And that's going to figure in our solution to shell injection.</span> <span data-start="1411.96" data-end="1419.409">It looks like I am running out of time, so maybe I should move forward.</span> <span data-start="1419.409" data-end="1423.19">Okay.</span> </p>
<p><span data-start="1423.19" data-end="1432.309">So, what we end up doing is we end up replacing our callout to the child process with the</span> <span data-start="1432.309" data-end="1435.07">use of the SH template tag.</span> <span data-start="1435.07" data-end="1437.71">And SH template tag is like pug.</span> <span data-start="1437.71" data-end="1438.71">It auto escapes.</span> <span data-start="1438.71" data-end="1443.59">It auto escapes for the SH and bash grammars.</span> <span data-start="1443.59" data-end="1455.179">We use similar mechanisms to make sure that only SH fragments can reach child process.</span> <span data-start="1455.179" data-end="1463.86">And that involves hooking into require so that, for example, the only thing that can</span> <span data-start="1463.86" data-end="1468.799">require child process is the exec SH fragment.</span> <span data-start="1468.799" data-end="1474.899">If anything else tries to, we block it.</span> <span data-start="1474.899" data-end="1482.84">And then quickly, we can also use these require hooks to do things like figure out what are</span> <span data-start="1482.84" data-end="1484.809">all the production sources?</span> <span data-start="1484.809" data-end="1488.97">So, I instrumented them with the test runner.</span> <span data-start="1488.97" data-end="1495.88">After the tests run I walked the module graph starting at the main module.</span> <span data-start="1495.88" data-end="1496.88">Here is the main module.</span> <span data-start="1496.88" data-end="1500.46">The gray modules sorry if this is entirely unreadable.</span> </p>
<p><span data-start="1500.46" data-end="1504.399">The gray modules are all things under known modules.</span> <span data-start="1504.399" data-end="1508.239">And the white modules are the actual source code.</span> <span data-start="1508.239" data-end="1514.019">What we ended up with is we found 58 JavaScript files were needed out of the 114 installed</span> <span data-start="1514.019" data-end="1522.609">when only = prod are available under the Node modules.</span> <span data-start="1522.609" data-end="1535.46">We can hash those, and we can make sure that the block any requires of files that have</span> <span data-start="1535.46" data-end="1537.69">unrecognized hashes.</span> </p>
<p><span data-start="1537.69" data-end="1542.759">So, this solves or problem with the colors module.</span> <span data-start="1542.759" data-end="1551.919">And so, crafting strong security stories, having secured by design tools is useful is</span> <span data-start="1551.919" data-end="1557.039">great but they're only useful if people use them.</span> <span data-start="1557.039" data-end="1564.379">We can run our test code to establish a baseline before code becomes available and open to</span> <span data-start="1564.379" data-end="1567.259">attack.</span> <span data-start="1567.259" data-end="1572.57">We can use lightweight dynamic enforcement which actually solves the security problems.</span> <span data-start="1572.57" data-end="1580.409">And if done right, it guides developers towards these safe by design tools.</span> <span data-start="1580.409" data-end="1589.32">And module linking hooks let us close a loop and make guarantees about only these modules</span> <span data-start="1589.32" data-end="1592.639">would result in these kinds of security vulnerabilities.</span> </p>
<p><span data-start="1592.639" data-end="1598.759">Therefore, we can security people like me can focus our attention on those particular</span> <span data-start="1598.759" data-end="1600.45">modules.</span> <span data-start="1600.45" data-end="1605.809">So, security's a team effort.</span> <span data-start="1605.809" data-end="1611.009">With these techniques a team can opt into security processes.</span> <span data-start="1611.009" data-end="1616.07">They can record human judgments and source control about which modules they trust to</span> <span data-start="1616.07" data-end="1617.779">do what.</span> <span data-start="1617.779" data-end="1621.489">And they can enforce those judgments dynamically.</span> <span data-start="1621.489" data-end="1629.94">And I have lots of awesome froes diagrams, but if you guys are interested in standards,</span> <span data-start="1629.94" data-end="1635.07">here are four standards to keep an eye on that I think will help us with security.</span> </p>
<p><span data-start="1635.07" data-end="1636.599">The realm standard.</span> <span data-start="1636.599" data-end="1643.33">That gives privilege separation within a Node namespace and provides the kind of import</span> <span data-start="1643.33" data-end="1645.84">hooks that I think are useful.</span> <span data-start="1645.84" data-end="1650.809">Trusted types provides libraries for strings that are not just strings.</span> <span data-start="1650.809" data-end="1659.009">Strings that we trust to specify HTML or script or URLs we might load into an origin.</span> <span data-start="1659.009" data-end="1667.009">Module keys allows us to represent the identity of a module in a way that's not spoofable.</span> <span data-start="1667.009" data-end="1674.539">And decorators are not directly security relevant, but they provide things like annotations in</span> <span data-start="1674.539" data-end="1679.619">other languages which can improve the ergonomics of a lot of this.</span> </p>
<p><span data-start="1679.619" data-end="1686.129">And you can get the note security roadmap at that URL at the top.</span> <span data-start="1686.129" data-end="1691.369">The code for that I demoed is at that GitHub URL.</span> <span data-start="1691.369" data-end="1696.809">Here are some of the some of the standards that I talked about.</span> <span data-start="1696.809" data-end="1706.58">And if you like web security, I put together a series much web security puzzles.</span> <span data-start="1706.58" data-end="1708.7">And you can find me on Twitter @michaelsamuel.</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
