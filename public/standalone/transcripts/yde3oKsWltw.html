<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="web.dev LIVE video transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>yde3oKsWltw</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/yde3oKsWltw?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="5.68" data-end="8.96">thank you for staying so long and I'm</span> <span data-start="8.96" data-end="9.6">gonna be</span> <span data-start="9.6" data-end="12.63">about how we are embedding v8d</span> <span data-start="12.63" data-end="15.24">javascript engine v8 in the native</span> <span data-start="15.24" data-end="18.6">script project how's the muder it's</span> <span data-start="18.6" data-end="23.05">required</span> <span data-start="23.06" data-end="26.09">[Applause]</span> <span data-start="26.09" data-end="28.32">so before we start just to make sure</span> <span data-start="28.32" data-end="30.36">that we're on the same page we'll</span> <span data-start="30.36" data-end="34.35">explain a few basic terms first what is</span> <span data-start="34.35" data-end="37.14">the JavaScript engine so JavaScript</span> <span data-start="37.14" data-end="39.6">engine is a computer program that</span> <span data-start="39.6" data-end="41.309">executes J's code</span> <span data-start="41.309" data-end="45.51">thanks Wikipedia and also most modern</span> </p>
<p><span data-start="45.51" data-end="48.18">JavaScript engines utilize just-in-time</span> <span data-start="48.18" data-end="51.87">compilation and when I first read that a</span> <span data-start="51.87" data-end="55.589">few years back I was like wait you just</span> <span data-start="55.589" data-end="59.55">say compilation I taught it I was</span> <span data-start="59.55" data-end="61.71">writing in a language that's kind of</span> <span data-start="61.71" data-end="65.159">interpreted and not compiled and I was I</span> <span data-start="65.159" data-end="67.29">was reading through different blog post</span> <span data-start="67.29" data-end="68.97">doing some research trying to figure out</span> <span data-start="68.97" data-end="71.49">what is going on it's my whole life a</span> <span data-start="71.49" data-end="75.36">lie was a was a reading yeah so it turns</span> <span data-start="75.36" data-end="78.93">out that yeah javascript is interpreted</span> <span data-start="78.93" data-end="81.56">but it's not just that the first</span> </p>
<p><span data-start="81.56" data-end="84.119">JavaScript engine that was created was</span> <span data-start="84.119" data-end="86.609">just the interpreter but it turns out</span> <span data-start="86.609" data-end="88.859">that we started choosing jealously for a</span> <span data-start="88.859" data-end="91.409">lot of more things that it was initially</span> <span data-start="91.409" data-end="94.71">thought is gonna be used for so there</span> <span data-start="94.71" data-end="97.649">had to be some performance improvements</span> <span data-start="97.649" data-end="100.1">to the way the JavaScript engine works</span> <span data-start="100.1" data-end="105.81">so this is what actually the modern</span> </p>
<p><span data-start="105.81" data-end="110.28">JavaScript engine engines do and the</span> <span data-start="110.28" data-end="112.59">blog post that I got it from is the jasc</span> <span data-start="112.59" data-end="115.02">if starboard startup performance by eros</span> <span data-start="115.02" data-end="117.719">money you can find the link later but</span> <span data-start="117.719" data-end="119.64">the blog post says that this is actually</span> <span data-start="119.64" data-end="122.34">a simplification of what javascript</span> <span data-start="122.34" data-end="125.63">engine that's under the hood I was like</span> <span data-start="125.63" data-end="130.02">ok cool so why do we actually need that</span> <span data-start="130.02" data-end="133.74">and as I mentioned before well</span> <span data-start="133.74" data-end="136.1">performance that's it</span> <span data-start="136.1" data-end="140.64">so the first just-in-time compiler and</span> <span data-start="140.64" data-end="142.49">very Tina</span> <span data-start="142.49" data-end="145.93">script engine was trace monkey which is</span> <span data-start="145.93" data-end="148.63">actually part of the spider monkey</span> </p>
<p><span data-start="148.63" data-end="151.1">JavaScript engine which was owned by a</span> <span data-start="151.1" data-end="155.39">Mozilla and it was back in 2007 or</span> <span data-start="155.39" data-end="157.37">something like that a little bit after</span> <span data-start="157.37" data-end="160.31">that v8 was released and that was the</span> <span data-start="160.31" data-end="162.64">same time when chrome was released and</span> <span data-start="162.64" data-end="165.29">this really boosted the performance of</span> <span data-start="165.29" data-end="168.05">JavaScript in the browser and everywhere</span> <span data-start="168.05" data-end="168.65">else</span> <span data-start="168.65" data-end="173.36">and that kind of explains how the whole</span> <span data-start="173.36" data-end="176.81">JavaScript engine development happened</span> <span data-start="176.81" data-end="181.01">and why is it I mean we started from</span> <span data-start="181.01" data-end="183.86">just some interpreters and this is what</span> <span data-start="183.86" data-end="187.55">we've got now so if you want to read the</span> <span data-start="187.55" data-end="189.89">proper explanation of what JIT compiler</span> <span data-start="189.89" data-end="192.2">is I really recommend this blog post by</span> <span data-start="192.2" data-end="194.63">link work was here today just two hours</span> <span data-start="194.63" data-end="197.87">before and yeah really excited to be on</span> <span data-start="197.87" data-end="202.52">the same stage anyway and another great</span> <span data-start="202.52" data-end="205.76">great resource is the talk life of a</span> <span data-start="205.76" data-end="208.49">script which is really recent and it's</span> <span data-start="208.49" data-end="212.21">by Satya and Yaqoob from the VA team and</span> <span data-start="212.21" data-end="215.03">they're explaining all the optimizations</span> <span data-start="215.03" data-end="217.85">that the v8 engine does under the hood</span> <span data-start="217.85" data-end="223.13">in order to make JavaScript faster let's</span> <span data-start="223.13" data-end="223.64">move on</span> </p>
<p><span data-start="223.64" data-end="225.5">I'm already mentioned that I'm going to</span> <span data-start="225.5" data-end="227.51">be talking about v8 it is a JavaScript</span> <span data-start="227.51" data-end="230.06">engine it is built at Google for Chrome</span> <span data-start="230.06" data-end="236.3">and it was open sourced in 2008 and here</span> <span data-start="236.3" data-end="238.43">I have this really cool video that you</span> <span data-start="238.43" data-end="241.88">can check out later is by Wars back who</span> <span data-start="241.88" data-end="244.22">was the first tech lead for the v8</span> <span data-start="244.22" data-end="246.95">project and what he said in that video</span> <span data-start="246.95" data-end="251.24">is that v8 is not just something that</span> <span data-start="251.24" data-end="254.09">chrome uses underneath you can actually</span> <span data-start="254.09" data-end="257.29">take v8 as a standalone project and</span> <span data-start="257.29" data-end="262.07">embed it at different place and this</span> <span data-start="262.07" data-end="264.65">kind of worked out well because node.js</span> <span data-start="264.65" data-end="267.71">embedded v8 and this is how we get</span> </p>
<p><span data-start="267.71" data-end="270.44">JavaScript on the server and what we're</span> <span data-start="270.44" data-end="272.3">trying to do in projects like native</span> <span data-start="272.3" data-end="274.58">script is actually bring JavaScript the</span> <span data-start="274.58" data-end="277.83">mobile world as well</span> <span data-start="277.84" data-end="281.63">so native script a few words about me I</span> <span data-start="281.63" data-end="283.27">am developer it's progress</span> <span data-start="283.27" data-end="286.46">part of the native script team and so</span> <span data-start="286.46" data-end="288.77">recently I became a GD for angular and</span> <span data-start="288.77" data-end="291.23">12 technologies are important thing</span> <span data-start="291.23" data-end="292.88">about me is that I love web pack I do</span> <span data-start="292.88" data-end="294.89">quite a lot of web pack things in native</span> <span data-start="294.89" data-end="297.53">script and this is I'm sure this is a</span> <span data-start="297.53" data-end="299.48">wipeout carrier but as you can see I'm</span> <span data-start="299.48" data-end="303.05">smiling because you have to accept these</span> <span data-start="303.05" data-end="312.22">things all right back on native script I</span> <span data-start="312.22" data-end="315.05">want a real story I read a short story</span> <span data-start="315.05" data-end="318.08">and I know I mean it's kind of weird but</span> </p>
<p><span data-start="318.08" data-end="321.13">I kind of had a long flight and then I</span> <span data-start="321.13" data-end="325.7">actually wrote that story and then I</span> <span data-start="325.7" data-end="328.55">could it's like 8% of it because it gets</span> <span data-start="328.55" data-end="331.13">even more weird so that's just an</span> <span data-start="331.13" data-end="333.59">explanation why why why it's like that</span> <span data-start="333.59" data-end="334.61">anyway</span> <span data-start="334.61" data-end="336.89">so we have the JavaScript world and we</span> <span data-start="336.89" data-end="339.71">have these great magical creatures</span> <span data-start="339.71" data-end="342.919">living in the JavaScript world not</span> <span data-start="342.919" data-end="345.26">really technology technologically</span> <span data-start="345.26" data-end="347.51">advanced but they know a lot of spells</span> <span data-start="347.51" data-end="351.38">and they're kind of like elves but not</span> <span data-start="351.38" data-end="353.419">like the Santa Claus</span> <span data-start="353.419" data-end="355.76">kind of type but more like deals from</span> <span data-start="355.76" data-end="357.86">worth of the Rings like magical handsome</span> <span data-start="357.86" data-end="361.31">awesome creatures and so I don't think</span> <span data-start="361.31" data-end="362.87">about the elves is that they're pretty</span> <span data-start="362.87" data-end="367.58">expansive as a nation or tribe and they</span> <span data-start="367.58" data-end="370.31">kinda expanded the browser world but</span> <span data-start="370.31" data-end="373.07">here's the zero difference we shouldn't</span> <span data-start="373.07" data-end="377.21">mix the terms browser and JavaScript</span> <span data-start="377.21" data-end="378.7">because they are not interchangeable</span> <span data-start="378.7" data-end="381.26">they're chinks in the browser which are</span> <span data-start="381.26" data-end="382.69">not part of the JavaScript language</span> <span data-start="382.69" data-end="385.91">obviously the most obvious difference is</span> <span data-start="385.91" data-end="390.32">the DOM and HTML</span> <span data-start="390.32" data-end="396.939">of course the someone say CSS</span> <span data-start="396.939" data-end="400.479">we're gonna come back back to CSS later</span> <span data-start="400.479" data-end="403.909">anyway another important world in our</span> <span data-start="403.909" data-end="406.189">story is the Android world and the</span> <span data-start="406.189" data-end="408.579">androids world obviously is populated by</span> <span data-start="408.579" data-end="412.659">robots which have really great</span> <span data-start="412.659" data-end="415.219">technological knowledge and they have a</span> <span data-start="415.219" data-end="419.179">lot of native resources and native</span> <span data-start="419.179" data-end="420.679">resource what is it</span> <span data-start="420.679" data-end="424.849">so satellites geolocation Bluetooth</span> <span data-start="424.849" data-end="428.149">camera augmented reality kids she</span> <span data-start="428.149" data-end="429.619">warning kids basically everything you</span> <span data-start="429.619" data-end="432.919">have on your phone today the Android</span> <span data-start="432.919" data-end="435.349">people take it for granted and they have</span> <span data-start="435.349" data-end="440.359">access to it so I'm doing a really but</span> <span data-start="440.359" data-end="442.849">metaphor generate world use your mobile</span> <span data-start="442.849" data-end="448.639">phone anyway so what is the deal the</span> <span data-start="448.639" data-end="450.769">folks from the JavaScript world the</span> <span data-start="450.769" data-end="453.109">elves are pretty expansive and they want</span> <span data-start="453.109" data-end="454.819">to use the native resources from the</span> </p>
<p><span data-start="454.819" data-end="457.899">Android world but they're not great</span> <span data-start="457.899" data-end="461.36">diplomats I mean it's probably the whole</span> <span data-start="461.36" data-end="466.159">Java JavaScript think anyway there is</span> <span data-start="466.159" data-end="470.029">not a really easy way to use native</span> <span data-start="470.029" data-end="473.269">resources from the Android world from</span> <span data-start="473.269" data-end="476.629">JavaScript and this is the problem that</span> <span data-start="476.629" data-end="478.549">we're trying to solve in native script</span> <span data-start="478.549" data-end="482.509">and if I say we it's kind of weird</span> <span data-start="482.509" data-end="484.969">because yet neither script has been part</span> <span data-start="484.969" data-end="488.269">of my life for three years and a if I</span> <span data-start="488.269" data-end="492.259">say we I mean the name script team and I</span> <span data-start="492.259" data-end="493.789">know this is the same slide what I was</span> <span data-start="493.789" data-end="496.999">too lazy to change it okay so shortly</span> <span data-start="496.999" data-end="499.339">native script is a framework that allows</span> <span data-start="499.339" data-end="501.889">you to build native mobile apps for</span> </p>
<p><span data-start="501.889" data-end="504.549">Android and iOS with JavaScript or</span> <span data-start="504.549" data-end="507.139">something a bit more sophisticated like</span> <span data-start="507.139" data-end="514.55">your angular really short overview of</span> <span data-start="514.55" data-end="516.649">the architecture obviously we have</span> <span data-start="516.649" data-end="518.809">Android and iOS on the bottom we have</span> <span data-start="518.809" data-end="521.719">may skip runtimes which allow us to have</span> <span data-start="521.719" data-end="524.839">access to the native resources from</span> <span data-start="524.839" data-end="527.689">JavaScript don't top that we have a</span> <span data-start="527.689" data-end="530.48">common layer which unifies the end</span> <span data-start="530.48" data-end="534.11">in the i/os api's so for example you've</span> <span data-start="534.11" data-end="537.2">ever had to build user interface on</span> <span data-start="537.2" data-end="539.96">android and user interface on iOS you</span> <span data-start="539.96" data-end="542.33">would have realized that they're quite</span> <span data-start="542.33" data-end="545.87">different so we provide a common</span> <span data-start="545.87" data-end="549.56">layouting structure or system that</span> <span data-start="549.56" data-end="552.14">allows you to write the same code and it</span> <span data-start="552.14" data-end="554.66">should kind of work the same way on both</span> </p>
<p><span data-start="554.66" data-end="558.83">Android and iOS on top of that we have a</span> <span data-start="558.83" data-end="561.41">really really small layer for the</span> <span data-start="561.41" data-end="564.02">application flavor framework which gives</span> <span data-start="564.02" data-end="567.59">you data bindings and navigation and we</span> <span data-start="567.59" data-end="571.1">also support angular and view and the</span> <span data-start="571.1" data-end="573.89">last important bit is that if there is</span> <span data-start="573.89" data-end="577.1">some library out there in the Android</span> <span data-start="577.1" data-end="581.78">world you can just wrap that as a notes</span> <span data-start="581.78" data-end="584.84">package ship it to NPM and anyone can</span> <span data-start="584.84" data-end="588.05">npm install your package and use it in</span> <span data-start="588.05" data-end="591.92">your native script app but today we're</span> <span data-start="591.92" data-end="594.38">going to be focusing on the name Swift</span> <span data-start="594.38" data-end="594.95">runtimes</span> <span data-start="594.95" data-end="597.89">and how we access the native resources</span> <span data-start="597.89" data-end="600.17">and more specifically we're going to</span> <span data-start="600.17" data-end="602.84">focus on the Android runtime because</span> <span data-start="602.84" data-end="606.41">this is where we embed v8 for iOS we</span> <span data-start="606.41" data-end="608.8">actually embed another JavaScript engine</span> </p>
<p><span data-start="608.8" data-end="613.95">JavaScript core which is used in Safari</span> <span data-start="613.96" data-end="620.24">so native API access important thing</span> <span data-start="620.24" data-end="623.89">about the elves they're not just like</span> <span data-start="623.89" data-end="626.48">not advanced in technology they also</span> <span data-start="626.48" data-end="628.34">don't have great scientific knowledge</span> <span data-start="628.34" data-end="631.4">but that's fine so even if they had</span> <span data-start="631.4" data-end="633.29">access to the native resources they</span> <span data-start="633.29" data-end="636.08">wouldn't really know how to use them so</span> <span data-start="636.08" data-end="639.53">what they do in that case is that they</span> <span data-start="639.53" data-end="641.81">send out some spice in the Android world</span> <span data-start="641.81" data-end="645.44">and these PI's gather information about</span> <span data-start="645.44" data-end="648.29">the native resources so they go back to</span> <span data-start="648.29" data-end="649.7">the JavaScript world with that</span> <span data-start="649.7" data-end="653.36">information and now the elves know how</span> <span data-start="653.36" data-end="657.8">to use the native resources but they</span> <span data-start="657.8" data-end="659.84">have to get there so we're still not</span> <span data-start="659.84" data-end="661.91">quite there but they know how to use the</span> <span data-start="661.91" data-end="663.86">resources</span> <span data-start="663.86" data-end="668.459">how does that look like in more boring</span> <span data-start="668.459" data-end="671.43">way so we have a native library for</span> <span data-start="671.43" data-end="674.97">example Android SDK or some animation</span> <span data-start="674.97" data-end="680.399">library in Android we parse through the</span> <span data-start="680.399" data-end="683.449">whole library to generate metadata</span> <span data-start="683.449" data-end="686.67">basically we get every package every API</span> <span data-start="686.67" data-end="689.37">did that's available and gathering</span> <span data-start="689.37" data-end="691.829">information how we can use it so if</span> <span data-start="691.829" data-end="694.86">there is some method we should know what</span> <span data-start="694.86" data-end="697.86">how many arguments the method accepts</span> <span data-start="697.86" data-end="700.68">what are their types what is the return</span> <span data-start="700.68" data-end="703.019">type so we gather all that information</span> <span data-start="703.019" data-end="708.3">and package that inside the application</span> <span data-start="708.3" data-end="714.3">itself in some binary format and the</span> <span data-start="714.3" data-end="717.569">application package itself is not very</span> <span data-start="717.569" data-end="719.97">different from a regular Android</span> <span data-start="719.97" data-end="724.74">application so we have just the Android</span> <span data-start="724.74" data-end="726.99">application inside it we have the</span> </p>
<p><span data-start="726.99" data-end="731.37">JavaScript code as some assets and 20q</span> <span data-start="731.37" data-end="733.92">the JavaScript code we also have a</span> <span data-start="733.92" data-end="735.63">library which contains the native</span> <span data-start="735.63" data-end="738.329">scripts runtime and v8 which is the</span> <span data-start="738.329" data-end="743.61">engine that can execute JavaScript we</span> <span data-start="743.61" data-end="746.329">run the application the Weibull restarts</span> <span data-start="746.329" data-end="750.569">we initialize v8 then we set up some</span> <span data-start="750.569" data-end="751.92">callbacks that we're going to take a</span> <span data-start="751.92" data-end="756.42">look at right the next slide and then we</span> <span data-start="756.42" data-end="762.149">launch the regular Android activity and</span> <span data-start="762.149" data-end="765.329">we have a normal Android up running so</span> <span data-start="765.329" data-end="765.899">Kovaks</span> <span data-start="765.899" data-end="768.24">very important if you are ever gonna</span> <span data-start="768.24" data-end="771.68">embed v8 callbacks or everywhere</span> <span data-start="771.68" data-end="774.779">first we have a field get a callback so</span> <span data-start="774.779" data-end="777.72">con stop jack Tico's java.lang object is</span> <span data-start="777.72" data-end="780.149">actually a valid JavaScript code in</span> <span data-start="780.149" data-end="785.22">native script Java comes from something</span> <span data-start="785.22" data-end="788.13">that we set on the v8 instance as a</span> <span data-start="788.13" data-end="790.98">global object because it was inside the</span> <span data-start="790.98" data-end="794.389">metadata so we know that we can access</span> <span data-start="794.389" data-end="795.92">the Java</span> <span data-start="795.92" data-end="799.67">or Java because it's available in the</span> </p>
<p><span data-start="799.67" data-end="806.509">Android world java.lang is actually</span> <span data-start="806.509" data-end="808.699">where the field Gator Quebec is attached</span> <span data-start="808.699" data-end="811.85">so whenever someone calls java.lang from</span> <span data-start="811.85" data-end="814.309">the JavaScript world we trigger that</span> <span data-start="814.309" data-end="817.069">field get her callback and the Quebec</span> <span data-start="817.069" data-end="820.429">finds the metadata inside the java.lang</span> <span data-start="820.429" data-end="823.639">package and returns what is exactly</span> <span data-start="823.639" data-end="826.85">there in that package what we can what</span> <span data-start="826.85" data-end="828.129">we can use</span> <span data-start="828.129" data-end="831.769">and finally Java rank object just</span> <span data-start="831.769" data-end="834.529">returns the object class from the</span> <span data-start="834.529" data-end="842.299">java.lang metadata kind of constructor</span> <span data-start="842.299" data-end="845.179">Quebec okay whenever we try to create</span> <span data-start="845.179" data-end="847.299">the new instance of something in the</span> <span data-start="847.299" data-end="850.91">Android world we trigger a constructor</span> <span data-start="850.91" data-end="853.16">callback which was placed there by the</span> <span data-start="853.16" data-end="856.1">name super on time so the constructor</span> </p>
<p><span data-start="856.1" data-end="858.109">Quebec creates the objects in generate</span> <span data-start="858.109" data-end="861.679">world and it also creates a proxy object</span> <span data-start="861.679" data-end="864.35">in the JavaScript world and then returns</span> <span data-start="864.35" data-end="868.16">the proxy object the method Quebec</span> <span data-start="868.16" data-end="870.499">okay so what is special about the proxy</span> <span data-start="870.499" data-end="873.11">javascript object for example if we have</span> <span data-start="873.11" data-end="875.779">two methods in the Java object and we're</span> <span data-start="875.779" data-end="877.639">going to have exactly the same methods</span> <span data-start="877.639" data-end="881.389">in the JavaScript object and in these</span> <span data-start="881.389" data-end="885.169">methods we attach a method call back so</span> <span data-start="885.169" data-end="887.629">whenever someone calls that method on</span> <span data-start="887.629" data-end="889.699">the JavaScript object it's going to</span> <span data-start="889.699" data-end="892.22">trigger that Quebec in the Quebec is</span> <span data-start="892.22" data-end="894.019">actually gonna called the original Java</span> <span data-start="894.019" data-end="898.489">method and after it's caught we're going</span> <span data-start="898.489" data-end="902.029">to get some results and we're gonna pass</span> <span data-start="902.029" data-end="904.779">it back and this is a more of an</span> <span data-start="904.779" data-end="907.429">implementation detail but we can't</span> <span data-start="907.429" data-end="909.499">actually just pass back the return</span> <span data-start="909.499" data-end="913.339">result to the JavaScript function but we</span> <span data-start="913.339" data-end="916.85">have to set the result as a return</span> <span data-start="916.85" data-end="920.72">argument of that proxy function or</span> <span data-start="920.72" data-end="926.419">method okay so so far we know that we</span> <span data-start="926.419" data-end="929.87">have metadata but it is exactly</span> <span data-start="929.87" data-end="932.33">it's actually not enough to have</span> <span data-start="932.33" data-end="935.99">metadata in order to call stuff on the</span> <span data-start="935.99" data-end="939.41">native Android world so we're using</span> <span data-start="939.41" data-end="942.05">something called j'ni or Java native</span> <span data-start="942.05" data-end="946.16">interface and because currently we</span> <span data-start="946.16" data-end="948.56">started v8 this one virtual machine we</span> <span data-start="948.56" data-end="950.54">also have the dalvik virtual machine</span> <span data-start="950.54" data-end="955.22">running on the Android device J&I is the</span> <span data-start="955.22" data-end="958.91">thing that passes all calls from the</span> </p>
<p><span data-start="958.91" data-end="961.01">JavaScript virtual machine down to the</span> <span data-start="961.01" data-end="964.16">Java Virtual Machine and the same way</span> <span data-start="964.16" data-end="968.45">back this is the actual bridge if you</span> <span data-start="968.45" data-end="972.83">ever heard of a bridge inside of native</span> <span data-start="972.83" data-end="976.34">script okay but there's a little</span> <span data-start="976.34" data-end="978.8">complication here what happens if the</span> <span data-start="978.8" data-end="981.92">Java object the Java method returns a</span> <span data-start="981.92" data-end="983.32">string</span> <span data-start="983.32" data-end="987.05">well the shrink is gonna be of type Java</span> <span data-start="987.05" data-end="990.68">long string which is definitely not the</span> <span data-start="990.68" data-end="995.09">same as a JavaScript string or a string</span> <span data-start="995.09" data-end="996.98">object or even a string a string</span> <span data-start="996.98" data-end="999.5">primitive they're just two different</span> <span data-start="999.5" data-end="1003.25">data formats that's why we need some</span> <span data-start="1003.25" data-end="1006.19">kind of marshaling service that can</span> <span data-start="1006.19" data-end="1009.34">convert data from the Java world to the</span> </p>
<p><span data-start="1009.34" data-end="1013.92">JavaScript world and vice versa and</span> <span data-start="1013.92" data-end="1017.14">maybe you'd ask if you think more about</span> <span data-start="1017.14" data-end="1019.75">it what about objects I mean wouldn't it</span> <span data-start="1019.75" data-end="1023.05">be terribly slow if we start converting</span> <span data-start="1023.05" data-end="1026.079">objects from the Java world back to</span> <span data-start="1026.079" data-end="1028.72">JavaScript well I should this is why we</span> <span data-start="1028.72" data-end="1031.54">create proxies this and of course</span> <span data-start="1031.54" data-end="1036.13">attaching method call backs so we use</span> <span data-start="1036.13" data-end="1042.03">smush ring for primitives and arrays and</span> <span data-start="1042.03" data-end="1044.88">obviously the marshaling service and</span> <span data-start="1044.88" data-end="1049.21">j'ni are c-3po in our already weird</span> <span data-start="1049.21" data-end="1051.49">story because c-3po is a protocol droid</span> <span data-start="1051.49" data-end="1053.62">so it translates messages back and forth</span> <span data-start="1053.62" data-end="1059.57">and yeah really proud of that comparison</span> <span data-start="1059.58" data-end="1063.32">so let's see very quickly how that works</span> <span data-start="1063.32" data-end="1065.99">we're trying to instantiate a new native</span> <span data-start="1065.99" data-end="1068.98">object we call the constructor callback</span> <span data-start="1068.98" data-end="1071.509">this requests an instance of the class</span> <span data-start="1071.509" data-end="1075.799">from the Android virtual machine we get</span> <span data-start="1075.799" data-end="1079.009">back the instance of the class we return</span> <span data-start="1079.009" data-end="1080.809">which way the JavaScript proxy object</span> <span data-start="1080.809" data-end="1084.769">and return it back then we try to call</span> <span data-start="1084.769" data-end="1088.639">some method we come Kody method callback</span> <span data-start="1088.639" data-end="1091.48">that was attached on the proxy object</span> <span data-start="1091.48" data-end="1095.059">then through the method callback we call</span> <span data-start="1095.059" data-end="1098.419">the actual native method we get back the</span> <span data-start="1098.419" data-end="1101.12">result from the Java world and then</span> <span data-start="1101.12" data-end="1105.289">convert it to a JavaScript data format</span> <span data-start="1105.289" data-end="1109.58">and assign it to the variable so far so</span> <span data-start="1109.58" data-end="1113.36">good okay we're ready for I have no idea</span> <span data-start="1113.36" data-end="1116.75">how much time I have it's just getting</span> <span data-start="1116.75" data-end="1117.529">interesting</span> <span data-start="1117.529" data-end="1122.72">cool let's talk about multi-threading in</span> </p>
<p><span data-start="1122.72" data-end="1129.44">JavaScript weird cool I will try to</span> <span data-start="1129.44" data-end="1134.059">explain the term junk or there are a lot</span> <span data-start="1134.059" data-end="1138.679">of ways to code that behavior but here's</span> <span data-start="1138.679" data-end="1140.779">the thing most of the devices that we're</span> <span data-start="1140.779" data-end="1145.19">using nowadays have to draw something 60</span> <span data-start="1145.19" data-end="1148.159">times per second on the screen so this</span> <span data-start="1148.159" data-end="1152.72">is what we call a frame rate the frame</span> <span data-start="1152.72" data-end="1155.45">rate of a usual device nowadays is 60</span> <span data-start="1155.45" data-end="1158.299">frames per second and that means that we</span> <span data-start="1158.299" data-end="1161.48">basically have 16 milliseconds to draw a</span> <span data-start="1161.48" data-end="1165.009">single frame on the device and that</span> <span data-start="1165.009" data-end="1167.539">means that whatever computations we are</span> <span data-start="1167.539" data-end="1170">doing right now we have to finish in 16</span> <span data-start="1170" data-end="1171.649">milliseconds and be ready to draw</span> <span data-start="1171.649" data-end="1172.639">something on the screen</span> <span data-start="1172.639" data-end="1175.129">and of course 60 milliseconds is the</span> <span data-start="1175.129" data-end="1177.549">upper bound because there may be other</span> <span data-start="1177.549" data-end="1180.919">computations happening and this may be</span> <span data-start="1180.919" data-end="1184.22">actually down to 10 milliseconds in the</span> <span data-start="1184.22" data-end="1187.34">browser which is not a lot of time and</span> <span data-start="1187.34" data-end="1191.12">so what happens if we fail to meet that</span> <span data-start="1191.12" data-end="1196.01">10 milliseconds well we drop a frame or</span> <span data-start="1196.01" data-end="1197.32">we skip a frame</span> <span data-start="1197.32" data-end="1203.9">and when we start skipping frames where</span> <span data-start="1203.9" data-end="1206.36">things start to happen and this is the</span> <span data-start="1206.36" data-end="1209.9">term junk I'm gonna put that on a really</span> <span data-start="1209.9" data-end="1215.63">slow motion so that we can see the</span> <span data-start="1215.63" data-end="1221.6">actual animation cool awesome so here we</span> <span data-start="1221.6" data-end="1224.21">have a really smooth animation running</span> <span data-start="1224.21" data-end="1228.79">in 60 frames per second focus on D I</span> <span data-start="1228.79" data-end="1231.41">just realized this is a beard</span> </p>
<p><span data-start="1231.41" data-end="1239.059">I told it's a scarf anyway yeah so focus</span> <span data-start="1239.059" data-end="1242.45">on the beards 60 frames per seconds</span> <span data-start="1242.45" data-end="1246.08">looks pretty cool here it kind of keeps</span> <span data-start="1246.08" data-end="1249.74">a few frames right 15 frames per second</span> <span data-start="1249.74" data-end="1252.26">you can definitely see the difference</span> <span data-start="1252.26" data-end="1254.48">between this animation and this</span> <span data-start="1254.48" data-end="1257.24">animation so this is called junk and</span> <span data-start="1257.24" data-end="1259.52">it's very obvious when you start</span> <span data-start="1259.52" data-end="1265.7">scrolling and the list just steps or</span> <span data-start="1265.7" data-end="1271.61">lags cool why is that important well we</span> <span data-start="1271.61" data-end="1274.22">run the JavaScript in native script on a</span> <span data-start="1274.22" data-end="1277.07">single thread and that is obviously the</span> <span data-start="1277.07" data-end="1280.97">user interface thread so that might</span> <span data-start="1280.97" data-end="1284.27">cause junk in some cases it won't cause</span> <span data-start="1284.27" data-end="1284.75">jank</span> <span data-start="1284.75" data-end="1288.65">if you're using native script the right</span> <span data-start="1288.65" data-end="1292.49">way no if you're building user interface</span> <span data-start="1292.49" data-end="1294.35">you won't have any problem because</span> <span data-start="1294.35" data-end="1296.84">native script is using native components</span> <span data-start="1296.84" data-end="1299.62">underneath if you're building animations</span> <span data-start="1299.62" data-end="1301.73">that won't be a problem because</span> <span data-start="1301.73" data-end="1303.83">underneath we're using native animations</span> <span data-start="1303.83" data-end="1307.13">and so on and so on but it will cause</span> <span data-start="1307.13" data-end="1309.71">gen if you're executing CPU intensive</span> <span data-start="1309.71" data-end="1311.99">operations for example if you're trying</span> <span data-start="1311.99" data-end="1314.809">to calculate Fibonacci numbers in a very</span> <span data-start="1314.809" data-end="1317.69">an optimized way which is something we</span> <span data-start="1317.69" data-end="1319.39">do in our everyday lives</span> <span data-start="1319.39" data-end="1323.24">perfect example so this would cause Jan</span> <span data-start="1323.24" data-end="1325.22">because it will stress the main trait</span> <span data-start="1325.22" data-end="1329.66">and the matron won't be able to to put</span> <span data-start="1329.66" data-end="1330.77">out</span> <span data-start="1330.77" data-end="1334.37">you know 60 frames per second so how do</span> <span data-start="1334.37" data-end="1337.13">we solve that problem in JavaScript</span> <span data-start="1337.13" data-end="1342.17">well the browser has web workers and in</span> <span data-start="1342.17" data-end="1343.49">native script we call them worker</span> <span data-start="1343.49" data-end="1345.79">threads but basically they're just</span> <span data-start="1345.79" data-end="1348.83">background threads or separate threads</span> <span data-start="1348.83" data-end="1351.68">than the user interface thread in the</span> </p>
<p><span data-start="1351.68" data-end="1358.07">JavaScript world okay the deal with the</span> <span data-start="1358.07" data-end="1360.02">worker threads is that you can create</span> <span data-start="1360.02" data-end="1362.27">them they can do some computations in</span> <span data-start="1362.27" data-end="1364.91">the background and then they can return</span> <span data-start="1364.91" data-end="1367.73">some result that's the whole the whole</span> <span data-start="1367.73" data-end="1372.05">thing the downsides in a new script is</span> <span data-start="1372.05" data-end="1374.3">that you can't share JavaScript memory</span> <span data-start="1374.3" data-end="1376.94">you can actually share native objects</span> <span data-start="1376.94" data-end="1380.09">and also the communication is limited so</span> <span data-start="1380.09" data-end="1382.46">you it's not a great idea to return</span> <span data-start="1382.46" data-end="1386.81">really large objects or recursive</span> <span data-start="1386.81" data-end="1391.4">objects also can't be returned okay some</span> </p>
<p><span data-start="1391.4" data-end="1394.69">VA time the really interesting thing</span> <span data-start="1394.69" data-end="1398.3">what is the nice relate to v8 well this</span> <span data-start="1398.3" data-end="1400.91">is a running instance of the engine and</span> <span data-start="1400.91" data-end="1403.85">is actually a v8 way to allocate memory</span> <span data-start="1403.85" data-end="1406.12">for some script that's running and</span> <span data-start="1406.12" data-end="1409.46">isolate that memory so it can't be</span> <span data-start="1409.46" data-end="1413.99">accessed from other processes and also</span> <span data-start="1413.99" data-end="1416.87">you can have many isolates and they can</span> <span data-start="1416.87" data-end="1422.65">run in parallel another similar term or</span> <span data-start="1422.65" data-end="1425.69">related term is a context one isolate</span> <span data-start="1425.69" data-end="1428.77">can have multiple contexts the context</span> <span data-start="1428.77" data-end="1432.05">can run in parallel so basically when</span> <span data-start="1432.05" data-end="1434.27">when you're running a script in an</span> <span data-start="1434.27" data-end="1436.91">isolate you should explicitly specify</span> <span data-start="1436.91" data-end="1439.28">the the context what is the constant</span> <span data-start="1439.28" data-end="1443.89">context right now so how do you think we</span> <span data-start="1443.89" data-end="1446.72">implemented worker threads with isolates</span> <span data-start="1446.72" data-end="1454.52">or with context isolates contexts we</span> <span data-start="1454.52" data-end="1456.76">didn't implement</span> <span data-start="1456.76" data-end="1460.63">okay well the answer is isolate and</span> <span data-start="1460.63" data-end="1464.46">everyone raised their hint was no one</span> <span data-start="1464.46" data-end="1473.5">guessed right cool so worker traits are</span> <span data-start="1473.5" data-end="1475.69">isolates basically you create a new</span> <span data-start="1475.69" data-end="1479.71">instance of v8 you attach some callbacks</span> <span data-start="1479.71" data-end="1482.65">or that G to isolate can communicate and</span> <span data-start="1482.65" data-end="1484.6">that's how we have worker threads and</span> <span data-start="1484.6" data-end="1487.12">the way they work in browsers is pretty</span> <span data-start="1487.12" data-end="1489.13">similar okay</span> <span data-start="1489.13" data-end="1493.96">lasting snapshots let's talk about time</span> <span data-start="1493.96" data-end="1496.929">and I don't mean that I'm running out of</span> <span data-start="1496.929" data-end="1501.91">time although that's true but what takes</span> <span data-start="1501.91" data-end="1505.12">time in a mobile applications and more</span> <span data-start="1505.12" data-end="1508.39">specifically what takes time on startup</span> <span data-start="1508.39" data-end="1512.559">well obviously on the mobile device we</span> <span data-start="1512.559" data-end="1515.28">don't have Network requests all the</span> <span data-start="1515.28" data-end="1518.83">scripts that we're running when we're</span> <span data-start="1518.83" data-end="1520.75">starting the applications are already on</span> <span data-start="1520.75" data-end="1523.03">the device but we have to get them from</span> <span data-start="1523.03" data-end="1525.16">the file system so that takes time if</span> <span data-start="1525.16" data-end="1529.48">there are many files also parsing and</span> <span data-start="1529.48" data-end="1533.37">compiling JavaScript takes time because</span> </p>
<p><span data-start="1533.37" data-end="1538.809">JavaScript engines and how do we solve</span> <span data-start="1538.809" data-end="1541">the problem they actually these two</span> <span data-start="1541" data-end="1542.86">things can take quite a lot of time and</span> <span data-start="1542.86" data-end="1545.74">this is a screenshot from two years ago</span> <span data-start="1545.74" data-end="1549.28">and at the time that was how much it</span> <span data-start="1549.28" data-end="1552.429">took to start an a script application in</span> <span data-start="1552.429" data-end="1555.12">a very an optimized way of course and</span> <span data-start="1555.12" data-end="1558.85">two seconds just to load the JavaScript</span> <span data-start="1558.85" data-end="1563.679">up the app it's kind of weird so how do</span> <span data-start="1563.679" data-end="1566.679">we solve that problem first we can</span> <span data-start="1566.679" data-end="1569.77">borrow our app so we can use a tool like</span> <span data-start="1569.77" data-end="1572.5">web pack to get all of our millions of</span> <span data-start="1572.5" data-end="1576.37">files in our application and output a</span> <span data-start="1576.37" data-end="1580.6">few files for example — so that way we</span> <span data-start="1580.6" data-end="1582.7">won't be making millions of file</span> <span data-start="1582.7" data-end="1584.919">requests on startup we were making just</span> <span data-start="1584.919" data-end="1588.77">two file requests</span> <span data-start="1588.78" data-end="1591.12">person compiled obviously we can skip</span> <span data-start="1591.12" data-end="1593.1">that part we just have to isolate our</span> </p>
<p><span data-start="1593.1" data-end="1595.74">JavaScript code somehow but there is</span> <span data-start="1595.74" data-end="1598.08">this trick which is called custom</span> <span data-start="1598.08" data-end="1600.15">startup snapshots which is a really</span> <span data-start="1600.15" data-end="1602.04">great feature provided by the v8 engine</span> <span data-start="1602.04" data-end="1605.79">and I'm not sure if it's the only one</span> <span data-start="1605.79" data-end="1608.75">but it's definitely not provided by JSC</span> <span data-start="1608.75" data-end="1612.68">that's why we have it only on Android so</span> <span data-start="1612.68" data-end="1615.75">the way it works is that you take a</span> <span data-start="1615.75" data-end="1617.58">JavaScript file you run it through some</span> <span data-start="1617.58" data-end="1621.12">generation tool that outputs that</span> <span data-start="1621.12" data-end="1623.94">executes the code and then you take</span> <span data-start="1623.94" data-end="1626.43">basically a snapshot of the heap at the</span> <span data-start="1626.43" data-end="1629.34">current time and output that in some</span> <span data-start="1629.34" data-end="1632.94">binary file and the binary file gets in</span> <span data-start="1632.94" data-end="1634.65">your file pack in your application</span> <span data-start="1634.65" data-end="1638.19">package and when you start the app you</span> <span data-start="1638.19" data-end="1641.25">load the snapshot binary you set some</span> <span data-start="1641.25" data-end="1644.67">parameters for the isolates passing</span> <span data-start="1644.67" data-end="1647.01">these snapshots binary and then when you</span> <span data-start="1647.01" data-end="1648.84">create the new isolate you can basically</span> <span data-start="1648.84" data-end="1651.39">instruct it to create the new context</span> <span data-start="1651.39" data-end="1654.27">from the already loaded heap so it</span> <span data-start="1654.27" data-end="1656.61">doesn't have to load the JavaScript from</span> <span data-start="1656.61" data-end="1657.36">the filesystem</span> <span data-start="1657.36" data-end="1660.3">compile it parse it whatever it does</span> <span data-start="1660.3" data-end="1663.66">underneath and it basically takes these</span> <span data-start="1663.66" data-end="1668.52">two seconds to zero and this is a little</span> <span data-start="1668.52" data-end="1671.1">bit of code and if you're interested and</span> <span data-start="1671.1" data-end="1673.95">not it's not going to read it obviously</span> <span data-start="1673.95" data-end="1676.08">because I don't have time but you can</span> <span data-start="1676.08" data-end="1677.76">find it in the slides later I'm going to</span> <span data-start="1677.76" data-end="1681.66">share them and this section is C++ code</span> <span data-start="1681.66" data-end="1683.97">but the idea of the that code here was</span> <span data-start="1683.97" data-end="1686.07">that it's not that hard to get a grasp</span> <span data-start="1686.07" data-end="1690.65">of how you can embed v8 it's it's free</span> <span data-start="1690.65" data-end="1697.32">actually understandable API okay what</span> <span data-start="1697.32" data-end="1700.34">are the limitations of the snapshots</span> <span data-start="1700.34" data-end="1703.02">basically we are executing the code at</span> </p>
<p><span data-start="1703.02" data-end="1705.66">Build time so we don't have any access</span> <span data-start="1705.66" data-end="1708.42">to the native funds rate or whatever API</span> <span data-start="1708.42" data-end="1712.74">is also we don't have require and I</span> <span data-start="1712.74" data-end="1717.19">don't have time to explain that but</span> <span data-start="1717.2" data-end="1719.79">finally later I can talk to you about</span> <span data-start="1719.79" data-end="1721.58">require where does it</span> <span data-start="1721.58" data-end="1725.84">from and why it's not a JavaScript</span> <span data-start="1725.84" data-end="1729.23">Tinky actually anyway also third-party</span> <span data-start="1729.23" data-end="1732.35">codes can break the snapshots because</span> <span data-start="1732.35" data-end="1734.36">we're not sure if the third-party code</span> <span data-start="1734.36" data-end="1736.88">is now trying to access something which</span> <span data-start="1736.88" data-end="1740.45">is not available at Build time so how</span> <span data-start="1740.45" data-end="1742.82">can we solve that first we can wrap</span> <span data-start="1742.82" data-end="1746.33">native API access here obviously we're</span> <span data-start="1746.33" data-end="1749.6">trying to access new Android text format</span> <span data-start="1749.6" data-end="1752.33">time and if we execute that in a better</span> <span data-start="1752.33" data-end="1755.24">context without metadata without j'ni we</span> <span data-start="1755.24" data-end="1757.46">don't have hundred so this is going to</span> <span data-start="1757.46" data-end="1759.59">throw an error the way to fix that is</span> <span data-start="1759.59" data-end="1762.23">just to wrap that in a getter function</span> <span data-start="1762.23" data-end="1766.49">and you get the time lazily inside the</span> <span data-start="1766.49" data-end="1768.71">other function that does some</span> <span data-start="1768.71" data-end="1774.83">complicated things does the audio and if</span> <span data-start="1774.83" data-end="1777.17">you're really lazy I don't have time to</span> <span data-start="1777.17" data-end="1779.15">explain that code but you can create</span> <span data-start="1779.15" data-end="1782.57">getters like that I'm gonna give you</span> <span data-start="1782.57" data-end="1784.79">just a few seconds to wrap your hand</span> <span data-start="1784.79" data-end="1787.55">around the first thing it's a very</span> <span data-start="1787.55" data-end="1792.56">interesting function yeah I still don't</span> <span data-start="1792.56" data-end="1798.23">get it anyway so it is that you have to</span> <span data-start="1798.23" data-end="1800.69">be lazy when trying to access in 85</span> <span data-start="1800.69" data-end="1805.39">years and just really quick reference</span> <span data-start="1805.39" data-end="1809.99">the editor item is using snapshots to</span> <span data-start="1809.99" data-end="1812">optimize their startup time as well and</span> <span data-start="1812" data-end="1814.25">they have a great blog post on how they</span> <span data-start="1814.25" data-end="1820.36">used keep snapshots to to do that and</span> <span data-start="1820.36" data-end="1822.77">garbage collection and obviously if I</span> <span data-start="1822.77" data-end="1824.21">start talking about garbage collection</span> <span data-start="1824.21" data-end="1827.21">right now we can just flow into the next</span> <span data-start="1827.21" data-end="1830.18">day and if you're interesting in how</span> <span data-start="1830.18" data-end="1832.61">we're trying to synchronize to garbage</span> <span data-start="1832.61" data-end="1837.32">collectors the v8s one and Avex one you</span> <span data-start="1837.32" data-end="1839.42">can check out this blog post it's a very</span> <span data-start="1839.42" data-end="1843.47">interesting problem and that was it</span> <span data-start="1843.47" data-end="1845.4">thank you</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
