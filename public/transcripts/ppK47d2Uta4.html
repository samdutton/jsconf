<section>
<p><span data-start="0.979" data-end="5.49">sunscreen I so I'm Ferrin a director of</span> <span data-start="5.49" data-end="7.649">engineering and moving world's black</span> <span data-start="7.649" data-end="9.95">matrix everywhere so on the internet</span> <span data-start="9.95" data-end="12.36">this is where the slides are it's only</span> <span data-start="12.36" data-end="13.71">place on my slides I should have put it</span> <span data-start="13.71" data-end="17.94">in the back so just a little brief</span> <span data-start="17.94" data-end="19.859">overview I'm going to be discussing</span> <span data-start="19.859" data-end="23.43">server inject and register server</span> <span data-start="23.43" data-end="26.13">methods and the happy framework I hope</span> <span data-start="26.13" data-end="27.39">by the end of the framework you'll know</span> <span data-start="27.39" data-end="32.399">when and how to use both of them so the</span> <span data-start="32.399" data-end="35.01">inspiration of this talk came from you</span> <span data-start="35.01" data-end="36.6">know discovering issues while i was</span> <span data-start="36.6" data-end="39.329">developing our product for the public</span> <span data-start="39.329" data-end="43.469">launch too long damn right we used a</span> <span data-start="43.469" data-end="46.53">server inject as a stopgap so we made a</span> <span data-start="46.53" data-end="49.5">mistake essentially we found bugs before</span> <span data-start="49.5" data-end="53.34">we went live I kind of the backstory is</span> <span data-start="53.34" data-end="55.71">is that you know I wrote a lot of the</span> </p>
<p><span data-start="55.71" data-end="60.629">API a co-worker was going to work on the</span> <span data-start="60.629" data-end="63.449">front-end app but then we had some</span> <span data-start="63.449" data-end="65.25">designer issues and he had to jump on</span> <span data-start="65.25" data-end="68.01">that so you know I think what it was is</span> <span data-start="68.01" data-end="69.57">you know I was going through the</span> <span data-start="69.57" data-end="71.82">documentation of happy and I was like</span> <span data-start="71.82" data-end="74.79">what can I do to you know do this front</span> <span data-start="74.79" data-end="77.04">and stuff and I saw seven inject was</span> <span data-start="77.04" data-end="79.17">like I could do it with that i wish i</span> <span data-start="79.17" data-end="80.939">would have gone down a little bit first</span> <span data-start="80.939" data-end="82.71">but if i didn't do that i'm going to be</span> <span data-start="82.71" data-end="87.33">here talking about it today so so server</span> <span data-start="87.33" data-end="90.54">inject it uses the shot module for</span> <span data-start="90.54" data-end="92.22">performing injections without actually</span> <span data-start="92.22" data-end="96.84">making any network connections so it</span> <span data-start="96.84" data-end="101.31">takes two arguments options call back so</span> <span data-start="101.31" data-end="105.09">options you can either send it a string</span> <span data-start="105.09" data-end="108.659">or not object some of the properties of</span> <span data-start="108.659" data-end="111.119">the objects are method URL headers</span> <span data-start="111.119" data-end="113.64">payload credentials simulate I wrote a</span> <span data-start="113.64" data-end="115.17">bunch of stuff up there I'm going to be</span> <span data-start="115.17" data-end="118.56">talking about like elsewhere</span> <span data-start="118.56" data-end="124.36">then there's a callback which gets one</span> <span data-start="124.36" data-end="127.24">function which is an object and uses</span> <span data-start="127.24" data-end="129.989">status code headers payload wrap a load</span> <span data-start="129.989" data-end="133.48">just a raw object and then the results</span> <span data-start="133.48" data-end="136.989">and I'll talk a little bit about that</span> <span data-start="136.989" data-end="140.65">later so when and why you should use</span> <span data-start="140.65" data-end="144.28">server inject great use case testing</span> <span data-start="144.28" data-end="147.16">here I have some code that kind of just</span> <span data-start="147.16" data-end="150.7">goes over here you can kind of see like</span> <span data-start="150.7" data-end="153.22">you you a we're calling the URL to me</span> <span data-start="153.22" data-end="156.61">and we're looking at the status code see</span> <span data-start="156.61" data-end="159.88">if it's 200 ok and then we're also</span> <span data-start="159.88" data-end="162.819">looking at the available property set on</span> <span data-start="162.819" data-end="164.65">it and we want to make sure it's set to</span> <span data-start="164.65" data-end="171.37">know and it's basically that so I feel</span> <span data-start="171.37" data-end="172.63">like I'm talking really really loud</span> <span data-start="172.63" data-end="175.72">because of things in my bag do things</span> <span data-start="175.72" data-end="182.47">that server sorry so also it's useful</span> <span data-start="182.47" data-end="184.39">when you're doing things in your routing</span> <span data-start="184.39" data-end="187.75">that is very complex and you can't</span> <span data-start="187.75" data-end="190.6">really abstract it into a method also</span> <span data-start="190.6" data-end="193">you by using server inject you avoid</span> <span data-start="193" data-end="197.29">network stack and potentially you can</span> <span data-start="197.29" data-end="199.959">also isolate networking issues that way</span> <span data-start="199.959" data-end="202.239">the credential object is really</span> <span data-start="202.239" data-end="204.1">interesting too because you can bypass</span> <span data-start="204.1" data-end="206.14">you know authenticated strategies using</span> <span data-start="206.14" data-end="212.62">it so when you shouldn't use it anytime</span> <span data-start="212.62" data-end="217.329">you're not testing I'd oh so I as we</span> <span data-start="217.329" data-end="219.91">found out and all right some of the</span> <span data-start="219.91" data-end="223.87">issues we found res results not always</span> <span data-start="223.87" data-end="226.48">available and I actually found this</span> <span data-start="226.48" data-end="228.91">issue when i was using seek lies and i</span> <span data-start="228.91" data-end="232.75">don't remember the details of why so I</span> <span data-start="232.75" data-end="235.18">had to use res that payload which kind</span> <span data-start="235.18" data-end="237.4">of sucked because i had to parse it so i</span> <span data-start="237.4" data-end="240.12">can look at the data and then I had to</span> <span data-start="240.12" data-end="243.04">reinter to the client and that's a lot</span> <span data-start="243.04" data-end="246.97">of waste you know memory was also I kind</span> <span data-start="246.97" data-end="248.29">of kind of thought that there's a little</span> <span data-start="248.29" data-end="250.74">bit of an implicit assumption that</span> <span data-start="250.74" data-end="255.99">whatever you're injecting on you're</span> <span data-start="255.99" data-end="258.18">assuming that it's correct and if it's</span> <span data-start="258.18" data-end="260.22">not like because you're using server</span> <span data-start="260.22" data-end="262.95">inject and that's not correct there's so</span> <span data-start="262.95" data-end="265.74">much overhead and that can cause you</span> <span data-start="265.74" data-end="270.24">know some debugging issues so yeah as a</span> <span data-start="270.24" data-end="272.7">result you know once I figured this out</span> <span data-start="272.7" data-end="275.61">once I I saw some of the issues another</span> <span data-start="275.61" data-end="280.68">issue we had was because the the the way</span> <span data-start="280.68" data-end="285.69">it encoded on res dot payload that so</span> <span data-start="285.69" data-end="290.01">happy is utf-8 when I translate over the</span> <span data-start="290.01" data-end="293.25">wire its ASCII and awesome because of</span> <span data-start="293.25" data-end="298.4">that level in the discussion or whatever</span> <span data-start="298.4" data-end="301.83">it we would see like encoding issues on</span> <span data-start="301.83" data-end="304.17">our site and so then that's when we were</span> <span data-start="304.17" data-end="306">like how we got a code refactor we need</span> <span data-start="306" data-end="308.7">to use server methods so registered</span> <span data-start="308.7" data-end="310.86">methods they're awesome because you can</span> <span data-start="310.86" data-end="312.93">use them to you know share common</span> <span data-start="312.93" data-end="314.85">functions by attaching them to your</span> <span data-start="314.85" data-end="318.39">server object this means you don't have</span> <span data-start="318.39" data-end="320.85">to require common add modules all over</span> <span data-start="320.85" data-end="324.03">in your plugins you know so makes your</span> <span data-start="324.03" data-end="326.19">code more dry you can also cash your</span> <span data-start="326.19" data-end="327.81">methods which is really awesome with the</span> <span data-start="327.81" data-end="329.88">happiest native caching and you can</span> <span data-start="329.88" data-end="333.29">change this context within your methods</span> <span data-start="333.29" data-end="336.24">so you need it of course give your</span> <span data-start="336.24" data-end="338.37">method a name and you'll be able to</span> <span data-start="338.37" data-end="340.92">excess it later through server methods</span> <span data-start="340.92" data-end="345.27">name or if you're in kind of a handler</span> <span data-start="345.27" data-end="348.3">you'd have to do I think request server</span> <span data-start="348.3" data-end="353.19">methods name so a neat feature I thought</span> <span data-start="353.19" data-end="357.15">was that you can register names such as</span> <span data-start="357.15" data-end="359.52">user dot get and I'll register it as a</span> <span data-start="359.52" data-end="361.71">nested object and I think this is a</span> <span data-start="361.71" data-end="363.69">great way to actually kind of create</span> <span data-start="363.69" data-end="366.78">like a kind of method namespace you know</span> <span data-start="366.78" data-end="370.73">like here you see that I binded it to</span> <span data-start="370.73" data-end="374.7">our happiest equalised user model and</span> <span data-start="374.7" data-end="378.12">then use the sequel eyes finding count</span> <span data-start="378.12" data-end="382.77">all function</span> <span data-start="382.78" data-end="385.729">so you also have to give it a function</span> <span data-start="385.729" data-end="388.43">and it takes this format it's an</span> <span data-start="388.43" data-end="390.59">arbitrary amount of arguments with your</span> <span data-start="390.59" data-end="392.659">next call back and then the next is</span> <span data-start="392.659" data-end="394.759">pretty standard you know error first</span> <span data-start="394.759" data-end="397.34">your result and then optional TTL for</span> <span data-start="397.34" data-end="398.569">when you want your cash to expire on</span> <span data-start="398.569" data-end="404.21">that object you also can give it some</span> <span data-start="404.21" data-end="406.789">objects objects are buying cash call</span> <span data-start="406.789" data-end="410.87">back generic key cash is the normal as</span> <span data-start="410.87" data-end="412.94">river cash so that's pretty</span> <span data-start="412.94" data-end="414.71">straightforward call back i haven't used</span> <span data-start="414.71" data-end="417.74">this but apparently you can make your</span> <span data-start="417.74" data-end="419.3">function method survey method</span> <span data-start="419.3" data-end="421.52">synchronous and then you're out your</span> <span data-start="421.52" data-end="423.05">call bak actually takes a little bit of</span> <span data-start="423.05" data-end="426.05">a different form and then there's the</span> <span data-start="426.05" data-end="429.53">generate key for when your methods don't</span> <span data-start="429.53" data-end="431.659">actually return you know a string or</span> <span data-start="431.659" data-end="434.06">bullying or a number or JSON object so</span> <span data-start="434.06" data-end="435.83">then you figure out a way to do that and</span> <span data-start="435.83" data-end="439.029">then you could actually utilize the cash</span> <span data-start="439.029" data-end="442.43">so how do we do that how do we actually</span> <span data-start="442.43" data-end="445.61">make a server method there's two two</span> <span data-start="445.61" data-end="447.949">main ways as a separate parameter so you</span> <span data-start="447.949" data-end="450.62">define your function and then you</span> <span data-start="450.62" data-end="454.49">register it that way surfer method foo</span> <span data-start="454.49" data-end="457.699">foo go okay and then you could do it as</span> <span data-start="457.699" data-end="460.25">an object which I prefer this method</span> <span data-start="460.25" data-end="463.699">better because it see the tree just an</span> <span data-start="463.699" data-end="467.569">object name method and options then of</span> <span data-start="467.569" data-end="469.639">course you could do it again as an array</span> <span data-start="469.639" data-end="475.43">of objects so why should you use server</span> <span data-start="475.43" data-end="478.58">methods you know if you want to use dry</span> <span data-start="478.58" data-end="480.74">again you avoid having to require all</span> <span data-start="480.74" data-end="482.18">the common modules everywhere in your</span> <span data-start="482.18" data-end="486.319">code and just use it on the server</span> <span data-start="486.319" data-end="489.11">object so and then if you also want to</span> <span data-start="489.11" data-end="491.629">cash here your items it's a little bit</span> <span data-start="491.629" data-end="493.759">more difficult and doesn't really work</span> <span data-start="493.759" data-end="496.15">on sir inject</span> <span data-start="496.15" data-end="499.24">now when it should be used if it doesn't</span> <span data-start="499.24" data-end="501.46">fit your use case which means complexity</span> <span data-start="501.46" data-end="504.07">or if you only perform the operation</span> <span data-start="504.07" data-end="505.57">once because there's a slight over had</span> <span data-start="505.57" data-end="509.86">to just call the server methods so just</span> <span data-start="509.86" data-end="514.62">before I close I did a little bit of</span> <span data-start="514.62" data-end="518.2">code here like I really wanted to kind</span> <span data-start="518.2" data-end="520.87">of get into like like what we're looking</span> <span data-start="520.87" data-end="522.25">at but I couldn't really figure out like</span> <span data-start="522.25" data-end="524.46">how to get the actual like memory stack</span> <span data-start="524.46" data-end="528.01">but I could get the latency so this is</span> <span data-start="528.01" data-end="532.39">what I did with the Linux AV tool and as</span> <span data-start="532.39" data-end="534.79">you can see like just this coin get</span> <span data-start="534.79" data-end="539.08">users directly you know takes about gift</span> <span data-start="539.08" data-end="542.05">gives you about 4.33 requests per second</span> <span data-start="542.05" data-end="546.1">when you do with the wrapper which I</span> <span data-start="546.1" data-end="549.07">have directly from this code right here</span> <span data-start="549.07" data-end="553.57">you know just wrapping that code and its</span> <span data-start="553.57" data-end="557.41">way much slower it's terrible and then</span> <span data-start="557.41" data-end="560.68">if you do via method you can see that</span> <span data-start="560.68" data-end="563.88">it's a little bit less performant than</span> <span data-start="563.88" data-end="566.65">calling it directly and then when you</span> <span data-start="566.65" data-end="569.2">actually use the cash it's just insane</span> <span data-start="569.2" data-end="570.88">ninety-eight percent of the requests are</span> <span data-start="570.88" data-end="575.62">under 50 minute 150 milliseconds so use</span> <span data-start="575.62" data-end="580.92">the cash whenever you can oops nevermind</span> <span data-start="580.92" data-end="584.59">okay so in summary you serve in jax for</span> <span data-start="584.59" data-end="586.65">your tests in a happy frame work</span> <span data-start="586.65" data-end="590.56">elsewhere only if and only if your logic</span> <span data-start="590.56" data-end="592.24">is too complex to be abstracted it is</span> <span data-start="592.24" data-end="594.46">serving method use server methods if you</span> <span data-start="594.46" data-end="596.55">need to use the same pieces of code and</span> <span data-start="596.55" data-end="599.89">multiple locations and bonus points if</span> <span data-start="599.89" data-end="602.79">you speed up your responses with caching</span> </p>
</section>