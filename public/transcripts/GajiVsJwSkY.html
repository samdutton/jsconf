<section>
<p><span data-start="7.7" data-end="11.219">my name is constant k fur I'm going to</span> <span data-start="11.219" data-end="13.139">talk about not writing notes as</span> <span data-start="13.139" data-end="18">extensions with c++ and the v8 API you</span> <span data-start="18" data-end="21.3">can find me on get up and twitter under</span> <span data-start="21.3" data-end="28.01">the username of kk fur so I work for oh</span> <span data-start="28.01" data-end="31.019">yeah this is the page you want to show</span> <span data-start="31.019" data-end="33.36">you I work for a development seat we're</span> <span data-start="33.36" data-end="35.309">a small shop based in DC and we do</span> <span data-start="35.309" data-end="37.23">mapping stuff our project is called</span> <span data-start="37.23" data-end="39.87">matte box and it allows you to create</span> <span data-start="39.87" data-end="42.66">maps we all have tile milk which is like</span> </p>
<p><span data-start="42.66" data-end="44.489">I'm at the sign application you can</span> <span data-start="44.489" data-end="47.28">change the color here to basically</span> <span data-start="47.28" data-end="51.09">create your own maps I'm going to talk</span> <span data-start="51.09" data-end="55.55">about c++ and how you can use it to</span> <span data-start="55.55" data-end="59.73">write no extensions so we all know that</span> <span data-start="59.73" data-end="62.28">people's bus is faster than JavaScript</span> <span data-start="62.28" data-end="64.53">right that's what you learn is cool</span> <span data-start="64.53" data-end="70.08">right anyone agrees with that the</span> <span data-start="70.08" data-end="72.59">question is is it really faster and</span> <span data-start="72.59" data-end="75.96">turns out the v8 guys did a really great</span> <span data-start="75.96" data-end="79.2">job at making JavaScript run very fast</span> <span data-start="79.2" data-end="84.15">and I did a little experiment to really</span> <span data-start="84.15" data-end="85.979">find out whether it actually makes sense</span> <span data-start="85.979" data-end="91.77">to write C++ extensions for node and if</span> <span data-start="91.77" data-end="94.049">you can do what you want to do it all in</span> </p>
<p><span data-start="94.049" data-end="95.67">JavaScript you should probably do it in</span> <span data-start="95.67" data-end="97.229">JavaScript because it's probably going</span> <span data-start="97.229" data-end="100.89">to be faster not always but most of time</span> <span data-start="100.89" data-end="103.409">the reason for this is that crossing the</span> <span data-start="103.409" data-end="105.84">boundary between JavaScript and C++ is</span> <span data-start="105.84" data-end="110.31">very slow and the ape compiles the child</span> <span data-start="110.31" data-end="112.409">strip code you write into a native</span> <span data-start="112.409" data-end="114.75">bytecode that it's usually faster to</span> <span data-start="114.75" data-end="117.24">execute them like just run your</span> <span data-start="117.24" data-end="122.49">unoptimized C++ code so for my little</span> <span data-start="122.49" data-end="125.729">test i use this functions which is the</span> <span data-start="125.729" data-end="129.979">formula for calculating the answer to</span> <span data-start="129.979" data-end="134.87">everything and so when I write this in</span> <span data-start="134.87" data-end="136.28">native she has an executor I get about</span> <span data-start="136.28" data-end="139.099">80 million calls per second on my crappy</span> <span data-start="139.099" data-end="143.09">three year old laptop it's pretty fast</span> <span data-start="143.09" data-end="146.18">right is there at the same thing in the</span> <span data-start="146.18" data-end="148.4">aid as a node extension I only get 13</span> <span data-start="148.4" data-end="151.28">million code calls per second which is a</span> <span data-start="151.28" data-end="154.7">lot slower if I do this asynchronously</span> <span data-start="154.7" data-end="158.48">like if I pass a callback function Jim I</span> <span data-start="158.48" data-end="161.36">v8 function written in C++ I only get</span> <span data-start="161.36" data-end="164.299">one point seven and if I go through the</span> <span data-start="164.299" data-end="166.91">thread pool light I'll float the</span> <span data-start="166.91" data-end="168.829">calculation to another threat if you</span> <span data-start="168.829" data-end="175.28">will it's really slow so if like if what</span> <span data-start="175.28" data-end="177.769">you want to do that's like you can write</span> <span data-start="177.769" data-end="179.51">it in JavaScript if if you can't do that</span> <span data-start="179.51" data-end="184.34">otherwise I'm going to like talk to you</span> <span data-start="184.34" data-end="190.579">about how you can do it in C++ so why</span> <span data-start="190.579" data-end="192.41">would you do c++ if you can write</span> </p>
<p><span data-start="192.41" data-end="193.79">JavaScript so there are a few reasons</span> <span data-start="193.79" data-end="197.269">here the biggest reason is yayness</span> <span data-start="197.269" data-end="199.819">written in C++ to kind of have to write</span> <span data-start="199.819" data-end="202.79">C++ to write node extensions but why do</span> <span data-start="202.79" data-end="205.04">you want to write node extensions tab at</span> <span data-start="205.04" data-end="208.19">all so pretty much the only reason for</span> <span data-start="208.19" data-end="210.98">doing that is to wrap existing C++</span> <span data-start="210.98" data-end="212.569">libraries right you don't want to</span> <span data-start="212.569" data-end="214.76">reinvent the wheel of light someone else</span> <span data-start="214.76" data-end="217.88">has probably spent a lot of time and</span> <span data-start="217.88" data-end="221.45">effort to build existing libraries like</span> <span data-start="221.45" data-end="224.419">sequel I'd like coelom you don't want to</span> <span data-start="224.419" data-end="225.98">really implement that again in</span> </p>
<p><span data-start="225.98" data-end="230.569">JavaScript and maybe one of the biggest</span> <span data-start="230.569" data-end="234.019">reason is javascript is single trip at</span> <span data-start="234.019" data-end="237.019">single-threaded pretty much so if you</span> <span data-start="237.019" data-end="239.269">have this big beautiful eight core</span> <span data-start="239.269" data-end="242.09">machine that you want to use and you run</span> <span data-start="242.09" data-end="244.73">like JavaScript code or just chose to</span> <span data-start="244.73" data-end="247.16">code it on it you can't really use more</span> <span data-start="247.16" data-end="250.4">than one processor one core at a time so</span> <span data-start="250.4" data-end="253.669">by offloading work into another threat</span> <span data-start="253.669" data-end="258.299">you can use more of the CPU so</span> <span data-start="258.299" data-end="261.18">this is actually all there is to writing</span> <span data-start="261.18" data-end="263.879">a C++ module four node this is all all</span> <span data-start="263.879" data-end="267.08">the code you have to write to be able to</span> <span data-start="267.08" data-end="270.06">get started so there are a few things</span> <span data-start="270.06" data-end="271.11">here you have to include the header</span> <span data-start="271.11" data-end="274.59">files of course if it register module</span> <span data-start="274.59" data-end="276">function you can really name that anyway</span> <span data-start="276" data-end="278.33">you want us just let use that name and</span> <span data-start="278.33" data-end="281.789">you registered your module lower like</span> <span data-start="281.789" data-end="284.25">the register function with node by using</span> <span data-start="284.25" data-end="289.199">the node module macro and use this</span> <span data-start="289.199" data-end="291.479">boilerplate code to compile it just like</span> <span data-start="291.479" data-end="293.789">save it as w script in the same</span> <span data-start="293.789" data-end="298.319">directory and you're good to go so if</span> <span data-start="298.319" data-end="299.789">you want to follow along you can go to</span> <span data-start="299.789" data-end="304.139">github.com / kk for / node CPP modules</span> <span data-start="304.139" data-end="307.71">which sold a sample code and contains a</span> <span data-start="307.71" data-end="309.27">lot more comes as well so you can like</span> <span data-start="309.27" data-end="311.669">go back there later if you want to check</span> <span data-start="311.669" data-end="317.409">that out anyway so let's compile this</span> <span data-start="317.419" data-end="319.5">compelling is pretty easy with node you</span> <span data-start="319.5" data-end="322.83">chose type node Wow configure and it</span> <span data-start="322.83" data-end="327.029">configures all your stuff and to</span> <span data-start="327.029" data-end="330.479">actually compile it if you run the same</span> <span data-start="330.479" data-end="332.969">thing with build or nothing at all and</span> <span data-start="332.969" data-end="336">it compiles in links or module and saves</span> <span data-start="336" data-end="339.69">it as a build / release / module named</span> <span data-start="339.69" data-end="342.389">of node or whatever you named it in uu w</span> <span data-start="342.389" data-end="348.24">script file so let's run this code like</span> <span data-start="348.24" data-end="349.949">this is just the nine lines of code that</span> </p>
<p><span data-start="349.949" data-end="353.099">I showed you on this slide this is all</span> <span data-start="353.099" data-end="359.699">we compiled now so you can just require</span> <span data-start="359.699" data-end="361.65">this module like any other node module</span> <span data-start="361.65" data-end="364.349">and what you'll get back as an empty</span> <span data-start="364.349" data-end="365.699">object that's all there's there's</span> <span data-start="365.699" data-end="367.349">nothing you can do nothing with that</span> <span data-start="367.349" data-end="368.879">object could have done this in</span> <span data-start="368.879" data-end="373.529">JavaScript right but we'll get to some</span> <span data-start="373.529" data-end="378.12">more examples in a bit so a few general</span> <span data-start="378.12" data-end="381.33">recommendations for developing I</span> <span data-start="381.33" data-end="383.699">recommend using si Lang and that makes</span> <span data-start="383.699" data-end="386.06">it a lot easier because ceiling has</span> <span data-start="386.06" data-end="388.65">easier to comprehend error message</span> <span data-start="388.65" data-end="395.25">than GCC but you should also compile</span> <span data-start="395.25" data-end="397.139">your stuff we're test your stuff with</span> <span data-start="397.139" data-end="400.07">GCC because many assistants many users</span> <span data-start="400.07" data-end="402.87">still use GCC they don't have ceiling</span> <span data-start="402.87" data-end="405.3">installed and if you publish your module</span> <span data-start="405.3" data-end="408.99">in npm most of the people who will</span> <span data-start="408.99" data-end="411.21">download and install your module will</span> <span data-start="411.21" data-end="418.889">probably use GCC right so let's get to</span> <span data-start="418.889" data-end="421.919">some more interesting samples to let</span> <span data-start="421.919" data-end="424.199">create a function in JavaScript or in</span> </p>
<p><span data-start="424.199" data-end="426.87">C++ that you can access from JavaScript</span> <span data-start="426.87" data-end="428.669">you just like to find a regular c</span> <span data-start="428.669" data-end="432.03">function or c++ function and there are a</span> <span data-start="432.03" data-end="434.34">few things here I'm it returns a handle</span> <span data-start="434.34" data-end="438.21">a handle is like basically a wrapper</span> <span data-start="438.21" data-end="444.21">around some sort of value um takes arcs</span> <span data-start="444.21" data-end="446.4">or arguments which is pretty much the</span> <span data-start="446.4" data-end="448.68">same thing as the arcs arguments options</span> <span data-start="448.68" data-end="450.66">that you get in JavaScript functions as</span> <span data-start="450.66" data-end="453.3">well and there are a few things that are</span> <span data-start="453.3" data-end="456.69">new here so in line for we have the</span> <span data-start="456.69" data-end="460.169">handle scope the handle scope is</span> <span data-start="460.169" data-end="462.81">basically sort of a safeguard that keeps</span> <span data-start="462.81" data-end="465.3">track of all the handles that you create</span> <span data-start="465.3" data-end="466.949">of all the variables that you create in</span> <span data-start="466.949" data-end="469.86">this c++ function and cleans them up</span> <span data-start="469.86" data-end="472.74">after rewards so you don't leak any of</span> <span data-start="472.74" data-end="475.86">the any of the variables that you create</span> <span data-start="475.86" data-end="480.659">and when you want to return stuff you</span> <span data-start="480.659" data-end="482.909">don't want V 8 to clean that that</span> <span data-start="482.909" data-end="485.31">because like the child script that</span> <span data-start="485.31" data-end="487.8">expects the return value still wants to</span> <span data-start="487.8" data-end="490.32">use this right so you want to make sure</span> <span data-start="490.32" data-end="492.18">that it doesn't get cleaned up and the</span> <span data-start="492.18" data-end="495.63">way you do this is a call scope that</span> <span data-start="495.63" data-end="498.12">closed around this and return the result</span> <span data-start="498.12" data-end="504.419">of that so we still have to register</span> <span data-start="504.419" data-end="506.34">that function that we defined with our</span> <span data-start="506.34" data-end="508.979">node module and in the register module</span> <span data-start="508.979" data-end="511.26">function which just call them Acura note</span> <span data-start="511.26" data-end="513.87">set method and just like use an</span> <span data-start="513.87" data-end="516.51">arbitrary name that we want to and use</span> <span data-start="516.51" data-end="518.579">our function name and that's pretty much</span> <span data-start="518.579" data-end="522.05">it</span> <span data-start="522.06" data-end="525.64">the target parameter of the register</span> <span data-start="525.64" data-end="527.74">module function is pretty much the same</span> <span data-start="527.74" data-end="530.35">as the exports object that you have in</span> <span data-start="530.35" data-end="534.31">native JavaScript modules so you can</span> <span data-start="534.31" data-end="537.94">just add stuff to that to that object</span> <span data-start="537.94" data-end="541.48">and it'll show up in the c++ extension</span> <span data-start="541.48" data-end="544.45">when you require it so it's compiled</span> <span data-start="544.45" data-end="548.32">this compelling works the same way as</span> <span data-start="548.32" data-end="552.399">before with no left configure note with</span> <span data-start="552.399" data-end="557.86">build and when we require this we see</span> <span data-start="557.86" data-end="560.95">the function as expected right okay we</span> <span data-start="560.95" data-end="562.839">can call this and we get the return</span> <span data-start="562.839" data-end="569.31">value that we defined in the function so</span> <span data-start="569.31" data-end="573.94">accepting arguments is not that</span> <span data-start="573.94" data-end="576.279">complicated either usually is a good at</span> <span data-start="576.279" data-end="578.23">here to check that you actually like the</span> <span data-start="578.23" data-end="580.12">user actually pass arguments to the</span> <span data-start="580.12" data-end="583.959">function similar to the Chava script</span> <span data-start="583.959" data-end="586">arguments objects we also have that</span> <span data-start="586" data-end="589.75">length function or that length a way to</span> <span data-start="589.75" data-end="593.56">find out the number of arguments and we</span> <span data-start="593.56" data-end="600.13">can throw exceptions and yeah just like</span> <span data-start="600.13" data-end="602.73">return create a new error object</span> <span data-start="602.73" data-end="604.93">exception that hyper is basically the</span> <span data-start="604.93" data-end="608.079">same as new error in JavaScript to</span> <span data-start="608.079" data-end="610">create new JavaScript strings use string</span> <span data-start="610" data-end="615.49">down you and that way the user will get</span> <span data-start="615.49" data-end="619.6">a JavaScript exception when when they</span> <span data-start="619.6" data-end="621.1">try to call the function without an</span> <span data-start="621.1" data-end="623.74">argument so once you're past the check</span> <span data-start="623.74" data-end="625.75">and the user actually parsed an argument</span> <span data-start="625.75" data-end="628.3">we can convert that to integer and there</span> <span data-start="628.3" data-end="631.72">are a bunch of two functions that you</span> <span data-start="631.72" data-end="635.56">can use to convert the stuff convert the</span> <span data-start="635.56" data-end="639.67">variable unica the user pass to any to a</span> <span data-start="639.67" data-end="641.529">particular type that you want to work</span> <span data-start="641.529" data-end="646.06">with or that you expect so let's look at</span> <span data-start="646.06" data-end="649.24">the at the documentation of the v8</span> <span data-start="649.24" data-end="650.72">documentation</span> <span data-start="650.72" data-end="657.11">and we kind of see the datatype tree</span> <span data-start="657.11" data-end="658.97">here so this is pretty much the same</span> <span data-start="658.97" data-end="660.5">things that you know from javascript</span> <span data-start="660.5" data-end="661.91">because we're after all writing</span> </p>
<p><span data-start="661.91" data-end="665.779">JavaScript code just in C++ we have an</span> <span data-start="665.779" data-end="667.61">array we have date with this weird</span> <span data-start="667.61" data-end="671.449">things like the boolean object so I'm</span> <span data-start="671.449" data-end="673.36">sure most of you know that they're like</span> <span data-start="673.36" data-end="676.22">Williams and actual objects which are</span> <span data-start="676.22" data-end="680.75">not type of boolean and with strings</span> <span data-start="680.75" data-end="684.709">numbers you can go down there and the</span> <span data-start="684.709" data-end="688.25">interesting part is that the C++ API the</span> <span data-start="688.25" data-end="691.939">v8 C++ API actually have several number</span> <span data-start="691.939" data-end="693.889">types as opposed to JavaScript where you</span> <span data-start="693.889" data-end="696.56">only have a number the eight actually</span> <span data-start="696.56" data-end="701.899">supports like native integers which are</span> <span data-start="701.899" data-end="703.939">subclass of the number type so there's</span> <span data-start="703.939" data-end="709.399">just something to be aware of mmm okay</span> <span data-start="709.399" data-end="716.36">let's get okay so when you do when you</span> <span data-start="716.36" data-end="719.3">want to run stuff asynchronously you</span> <span data-start="719.3" data-end="722.059">usually accept a callback function that</span> <span data-start="722.059" data-end="724.339">you called when you are finished writing</span> <span data-start="724.339" data-end="729.29">your work and the way to do this is to</span> <span data-start="729.29" data-end="732.259">check whether it's a function and cast</span> <span data-start="732.259" data-end="735.529">this to a function basically very</span> <span data-start="735.529" data-end="737.149">similar to what we did before when we</span> <span data-start="737.149" data-end="740.8">casted it or converted it to an integer</span> <span data-start="740.8" data-end="743.66">then we just do our stuff our</span> <span data-start="743.66" data-end="746.059">calculations in soup or pulling out to</span> <span data-start="746.059" data-end="750.5">smc libraries or C++ libraries and when</span> <span data-start="750.5" data-end="751.879">you get an error this is just note</span> <span data-start="751.879" data-end="754.279">convention but it's probably a pretty</span> <span data-start="754.279" data-end="755.87">good idea to follow it because most</span> <span data-start="755.87" data-end="758.3">users are familiar with that convention</span> <span data-start="758.3" data-end="763.43">is the first argument to their callback</span> <span data-start="763.43" data-end="766.22">is an error object if an error occurred</span> <span data-start="766.22" data-end="769.1">otherwise it's no so when Noah record we</span> <span data-start="769.1" data-end="770.86">just create note for the first argument</span> <span data-start="770.86" data-end="774.62">when an error occurred we create a new</span> <span data-start="774.62" data-end="777.98">exception object and pass that as the</span> <span data-start="777.98" data-end="779.75">only argument right so we call the</span> <span data-start="779.75" data-end="782.01">callback function with one argument here</span> <span data-start="782.01" data-end="786.27">and with two arguments and the second</span> <span data-start="786.27" data-end="790.89">argument being the result you might have</span> <span data-start="790.89" data-end="792.87">noticed that we don't use scope to close</span> <span data-start="792.87" data-end="796.23">here and there are a few things that you</span> <span data-start="796.23" data-end="800.07">can return from C++ functions or from</span> <span data-start="800.07" data-end="802.38">the 8th C++ functions that you don't</span> <span data-start="802.38" data-end="804.21">have to wrap in scope the closest or</span> <span data-start="804.21" data-end="808.14">no true and false I'm not sure</span> <span data-start="808.14" data-end="810.45">whether more but at least these you can</span> <span data-start="810.45" data-end="812.1">just return without wrapping them and</span> <span data-start="812.1" data-end="818.15">scope that close so oh and one thing</span> <span data-start="818.15" data-end="820.8">when you call a function you don't have</span> <span data-start="820.8" data-end="823.32">to somehow make sure that the handles</span> <span data-start="823.32" data-end="825.36">will stay around because the call</span> <span data-start="825.36" data-end="828.87">function automatically make sure that VA</span> <span data-start="828.87" data-end="831.48">doesn't garbage collect or destroy them</span> <span data-start="831.48" data-end="835.23">any other way before before the call</span> <span data-start="835.23" data-end="839.7">function you're calling returned so oh</span> <span data-start="839.7" data-end="842.16">and one thing you really don't want to</span> <span data-start="842.16" data-end="844.29">forget the handle scope at the top</span> <span data-start="844.29" data-end="846.33">that's a pretty important piece if you</span> <span data-start="846.33" data-end="850.77">don't add that you'll run into troubles</span> <span data-start="850.77" data-end="853.17">and like your code starts or your module</span> <span data-start="853.17" data-end="856.14">starts to behave in a weird very weird</span> <span data-start="856.14" data-end="861.66">way and you run hard to debug errors so</span> <span data-start="861.66" data-end="863.31">make sure that you always have the</span> <span data-start="863.31" data-end="869.91">handles code but most of the stuff we</span> <span data-start="869.91" data-end="871.47">did so far as cereal right we just</span> <span data-start="871.47" data-end="872.91">implemented the same stuff that you</span> <span data-start="872.91" data-end="876.11">could have done in JavaScript and C++</span> <span data-start="876.11" data-end="879.05">let's do some stuff asynchronously</span> <span data-start="879.05" data-end="881.82">because like even if we just like call</span> <span data-start="881.82" data-end="883.17">the function here this is still</span> <span data-start="883.17" data-end="886.08">synchronous like the original call to</span> <span data-start="886.08" data-end="888.33">the callback function block until our</span> <span data-start="888.33" data-end="892.32">stuff is done so note has a thread pool</span> <span data-start="892.32" data-end="894.81">that we can use to offload work into</span> <span data-start="894.81" data-end="897.98">other threats and the way this works is</span> <span data-start="897.98" data-end="900.8">we have one main threat the eight threat</span> <span data-start="900.8" data-end="902.94">we're just running all the child strip</span> <span data-start="902.94" data-end="907.08">code and no it spawns a couple of worker</span> <span data-start="907.08" data-end="910.77">threads that you can dispatch work</span> <span data-start="910.77" data-end="913.8">requests to do this</span> <span data-start="913.8" data-end="916.529">you have to create three functions the</span> <span data-start="916.529" data-end="919.17">original function which takes all the</span> <span data-start="919.17" data-end="922.5">arguments and converts it to a native</span> <span data-start="922.5" data-end="925.83">p.o.d types or some other civil plus</span> <span data-start="925.83" data-end="930.3">types that are independent of v8 then it</span> <span data-start="930.3" data-end="932.07">is statuz that to the worker function</span> <span data-start="932.07" data-end="936.38">which runs in another thread and</span> <span data-start="936.38" data-end="938.37">afterwards when you're done when the</span> <span data-start="938.37" data-end="939.959">work of function which is the blocking</span> <span data-start="939.959" data-end="942.45">function returns you can convert it back</span> <span data-start="942.45" data-end="947.37">and call your original call back so like</span> </p>
<p><span data-start="947.37" data-end="950.61">I said it's single-threaded that's why</span> <span data-start="950.61" data-end="952.74">it's a pretty good idea to do any kind</span> <span data-start="952.74" data-end="957.47">of i/o and CPU or heavy cpu usage in the</span> <span data-start="957.47" data-end="960.63">worker thread function so you basically</span> <span data-start="960.63" data-end="963.45">have all the main thread like for plain</span> <span data-start="963.45" data-end="965.1">JavaScript functions for accepting</span> <span data-start="965.1" data-end="967.56">server connections and handling all the</span> <span data-start="967.56" data-end="973.89">blue code kind of work that's a pretty</span> <span data-start="973.89" data-end="978.51">important bit you should not ever access</span> <span data-start="978.51" data-end="982.56">any v8 variables any kind of handles</span> <span data-start="982.56" data-end="985.31">from the work of functions if you do</span> <span data-start="985.31" data-end="988.41">your program is probably going to crash</span> <span data-start="988.41" data-end="994.05">sooner rather than later so we still</span> <span data-start="994.05" data-end="995.97">want to get our data that we pass into</span> <span data-start="995.97" data-end="997.89">the original function to the work a</span> <span data-start="997.89" data-end="1001.7">friend the way we can do this is to just</span> <span data-start="1001.7" data-end="1005.149">create a struct or class or whatever you</span> <span data-start="1005.149" data-end="1008.779">want to do like the convention here is</span> <span data-start="1008.779" data-end="1011.54">to call it baton but you can really use</span> <span data-start="1011.54" data-end="1013.399">any other kind of name or you can also</span> <span data-start="1013.399" data-end="1017.17">use just like passive arbitrary pointer</span> <span data-start="1017.17" data-end="1020.39">whatever you come up with but I found</span> <span data-start="1020.39" data-end="1022.94">that this works pretty well and you can</span> <span data-start="1022.94" data-end="1025.339">do most things with it it's a pretty</span> <span data-start="1025.339" data-end="1027.98">good template so beef if you think's</span> <span data-start="1027.98" data-end="1032.3">here the work request allows you to</span> <span data-start="1032.3" data-end="1037.49">dispatch the call to another thread we</span> <span data-start="1037.49" data-end="1039.11">have the callback function that we want</span> <span data-start="1039.11" data-end="1041.51">to keep around so that we can call the</span> <span data-start="1041.51" data-end="1043.25">callback function later once we're done</span> <span data-start="1043.25" data-end="1046.1">with the work and this is just some arab</span> <span data-start="1046.1" data-end="1046.929">tracking code</span> <span data-start="1046.929" data-end="1051.399">so when our work if function fails we</span> <span data-start="1051.399" data-end="1054.61">can store those error messages with a</span> <span data-start="1054.61" data-end="1058.6">record error codes here and then create</span> <span data-start="1058.6" data-end="1061.96">error object when we're back in the main</span> <span data-start="1061.96" data-end="1064.96">v8 thread to give the user some</span> <span data-start="1064.96" data-end="1069.639">information so like I said this is just</span> <span data-start="1069.639" data-end="1071.259">a convention you can use any other kind</span> <span data-start="1071.259" data-end="1075.639">of scheme that you come up with one</span> <span data-start="1075.639" data-end="1077.49">important piece is the persistent handle</span> <span data-start="1077.49" data-end="1081.549">regular handles are not persistent</span> <span data-start="1081.549" data-end="1083.019">they're cleaned up at the handle scope</span> <span data-start="1083.019" data-end="1085.96">when you exit the function but we don't</span> <span data-start="1085.96" data-end="1089.049">want our callback function to be cleaned</span> <span data-start="1089.049" data-end="1090.429">up because you want to use it later on</span> <span data-start="1090.429" data-end="1095.139">again to call the user with the results</span> <span data-start="1095.139" data-end="1098.32">of our stuff right so this is why you we</span> <span data-start="1098.32" data-end="1105.139">use the persistent type of the handle so</span> <span data-start="1105.149" data-end="1110.899">this is basically how starting a</span> <span data-start="1110.909" data-end="1113.799">starting a worker process or at work a</span> <span data-start="1113.799" data-end="1117.85">threat looks like you just check that we</span> <span data-start="1117.85" data-end="1119.559">have a function here and convert it to a</span> <span data-start="1119.559" data-end="1123.399">function handle and create a new baton</span> <span data-start="1123.399" data-end="1126.399">of doing some set of work and create a</span> <span data-start="1126.399" data-end="1128.529">new persistent handle so that VA doesn't</span> <span data-start="1128.529" data-end="1133.929">clean this up and just NQ the work</span> <span data-start="1133.929" data-end="1137.95">request into the lib QV q and we pass to</span> <span data-start="1137.95" data-end="1140.95">function names this is a sink work this</span> <span data-start="1140.95" data-end="1143.529">is our worker function and this is the</span> <span data-start="1143.529" data-end="1146.74">aftra function which is called once the</span> <span data-start="1146.74" data-end="1152.649">async work function returns so the work</span> <span data-start="1152.649" data-end="1155.529">effect is pretty pretty easy or looks</span> <span data-start="1155.529" data-end="1160.769">pretty lightweight actually sorry just</span> <span data-start="1160.769" data-end="1163.779">convert the data which is like a</span> <span data-start="1163.779" data-end="1165.279">reference or a pointer to the bathroom</span> <span data-start="1165.279" data-end="1168.159">and you can basically do any kind of</span> <span data-start="1168.159" data-end="1171.669">work here what it can do is use any v8</span> <span data-start="1171.669" data-end="1173.769">stuff so you have to convert any kind of</span> <span data-start="1173.769" data-end="1175.45">data that you pass into the worker</span> <span data-start="1175.45" data-end="1177.58">thread in</span> <span data-start="1177.58" data-end="1181.15">the first function to some some sort of</span> <span data-start="1181.15" data-end="1188.08">native type so this fence is blocking so</span> <span data-start="1188.08" data-end="1189.76">you can basically do whatever you want</span> <span data-start="1189.76" data-end="1192.25">you can do long-running network</span> <span data-start="1192.25" data-end="1194.2">connections you can do file access you</span> <span data-start="1194.2" data-end="1197.26">can do expensive calculations and it</span> <span data-start="1197.26" data-end="1202.57">won't block the main v8 Fred like I said</span> <span data-start="1202.57" data-end="1205.87">don't don't don't use any v8 stuff in</span> <span data-start="1205.87" data-end="1214.33">there ok so once you're done lip UV make</span> <span data-start="1214.33" data-end="1217.06">sure to call your after function do the</span> <span data-start="1217.06" data-end="1218.89">same thing this time with a handles code</span> <span data-start="1218.89" data-end="1220.87">because this is executed back in the</span> <span data-start="1220.87" data-end="1224.05">main threat and do the same thing check</span> <span data-start="1224.05" data-end="1227.2">whether we had an error and when we did</span> <span data-start="1227.2" data-end="1229.45">just called a call back with an error</span> <span data-start="1229.45" data-end="1232.68">object or exception object otherwise</span> <span data-start="1232.68" data-end="1236.23">we'll pass the result back this is what</span> <span data-start="1236.23" data-end="1238.44">you also have to do because we created a</span> <span data-start="1238.44" data-end="1240.64">persistent handle of the call back</span> <span data-start="1240.64" data-end="1243.04">before we have to manually dispose of it</span> <span data-start="1243.04" data-end="1245.83">to make sure that that is cleaned up and</span> <span data-start="1245.83" data-end="1250.89">just like delete our delete our object</span> <span data-start="1250.89" data-end="1256">so yeah ok one thing that you have to be</span> <span data-start="1256" data-end="1259.27">aware of is when you call a callback</span> <span data-start="1259.27" data-end="1261.97">functions in in an after function that</span> <span data-start="1261.97" data-end="1264.19">returns from the GV is called the top of</span> <span data-start="1264.19" data-end="1267">the event loop of notes event loop so</span> <span data-start="1267" data-end="1269.95">this time you've to wrap it in a c++</span> <span data-start="1269.95" data-end="1273.51">try-catch or leg at the eight try-catch</span> <span data-start="1273.51" data-end="1277.02">so that it's possible for modules to use</span> <span data-start="1277.02" data-end="1281.92">process on uncaught exception in the</span> <span data-start="1281.92" data-end="1288.4">case the callback function fails so some</span> <span data-start="1288.4" data-end="1292.21">some words on API design the problem is</span> <span data-start="1292.21" data-end="1295.33">that most of the time you want to</span> <span data-start="1295.33" data-end="1298.12">convert a synchronous API that is</span> <span data-start="1298.12" data-end="1301.51">implemented in C or C++ into some sort</span> <span data-start="1301.51" data-end="1305.86">of a sink a way so they can use it from</span> </p>
<p><span data-start="1305.86" data-end="1309.4">JavaScript there's some patterns that</span> <span data-start="1309.4" data-end="1310.65">you can use here</span> <span data-start="1310.65" data-end="1312.81">the event emitter pattern if sometimes</span> <span data-start="1312.81" data-end="1316.56">pretty useful when you can fit your fit</span> <span data-start="1316.56" data-end="1320.88">the API the original API into the event</span> <span data-start="1320.88" data-end="1322.47">emitter pattern that's a pretty good way</span> <span data-start="1322.47" data-end="1326.93">to go cheney book hauls like jquery are</span> <span data-start="1326.93" data-end="1331.11">often a very useful thing to do and when</span> <span data-start="1331.11" data-end="1333.57">you do this you can like manually cue</span> <span data-start="1333.57" data-end="1336.39">the work requests in your original fed</span> <span data-start="1336.39" data-end="1338.49">before you dispatch them to the thread</span> <span data-start="1338.49" data-end="1341.85">pool and i'll show you an example for</span> <span data-start="1341.85" data-end="1347.73">that in a bit some previous or some</span> <span data-start="1347.73" data-end="1350.07">examples basically create objects with</span> <span data-start="1350.07" data-end="1353.43">new for any kind of things you can also</span> <span data-start="1353.43" data-end="1355.44">just create a native function or like a</span> <span data-start="1355.44" data-end="1356.94">plane function you don't have to wrap it</span> <span data-start="1356.94" data-end="1362.07">an object so it is just a simple API</span> <span data-start="1362.07" data-end="1365.85">call just like write a simple function</span> <span data-start="1365.85" data-end="1370.02">doesn't have to be complicated and this</span> <span data-start="1370.02" data-end="1373.11">is probably the most important bit of</span> <span data-start="1373.11" data-end="1376.94">advice make it very hard to misuse so</span> </p>
<p><span data-start="1376.94" data-end="1379.59">JavaScript programmers usually expect</span> <span data-start="1379.59" data-end="1382.02">that like the program doesn't crash</span> <span data-start="1382.02" data-end="1385.92">randomly so that they have to like call</span> <span data-start="1385.92" data-end="1390.87">things in a specific order so antigua</span> <span data-start="1390.87" data-end="1393.87">and c and c++ api's are different so</span> <span data-start="1393.87" data-end="1395.88">your program can crash if you don't use</span> <span data-start="1395.88" data-end="1400.02">the C++ or C API in the correct order so</span> <span data-start="1400.02" data-end="1402.21">your code should make sure that it's</span> <span data-start="1402.21" data-end="1404.01">impossible that the program will crash</span> <span data-start="1404.01" data-end="1407.73">and and even if you misuse it just throw</span> <span data-start="1407.73" data-end="1412.95">errors as opposed to crashing and yeah</span> <span data-start="1412.95" data-end="1415.35">just like make you feel as JavaScript as</span> <span data-start="1415.35" data-end="1418.35">possible that's what I usually do when</span> <span data-start="1418.35" data-end="1421.17">starting to write a note extension yes I</span> <span data-start="1421.17" data-end="1423.6">just like open up my editor and come up</span> <span data-start="1423.6" data-end="1426.78">with an API or like write some</span> </p>
<p><span data-start="1426.78" data-end="1428.7">JavaScript code that should be the API</span> <span data-start="1428.7" data-end="1431.99">and then see how it can implement it in</span> <span data-start="1431.99" data-end="1436.79">the aid or node c++ code so that it</span> <span data-start="1436.79" data-end="1440.59">looks like a good API</span> <span data-start="1440.59" data-end="1443.77">some examples for this to like show you</span> <span data-start="1443.77" data-end="1446.11">what I'm talking about is the notes to</span> <span data-start="1446.11" data-end="1448.809">collect three API to create a new</span> <span data-start="1448.809" data-end="1450.549">database object you just call the new</span> <span data-start="1450.549" data-end="1452.919">operator on a view there's no open</span> <span data-start="1452.919" data-end="1455.289">function or anything because when you</span> <span data-start="1455.289" data-end="1457.33">create a new database object like</span> <span data-start="1457.33" data-end="1459.61">openness pretty much implicit you like</span> <span data-start="1459.61" data-end="1462.49">don't want to open it separately that</span> <span data-start="1462.49" data-end="1464.98">eliminates a few staff you like things</span> <span data-start="1464.98" data-end="1467.74">you have to check for like you don't</span> <span data-start="1467.74" data-end="1469.659">have to check when you run a query Oh</span> <span data-start="1469.659" data-end="1472.11">has the user already called open because</span> <span data-start="1472.11" data-end="1476.02">it's already open implicitly and all of</span> <span data-start="1476.02" data-end="1478.809">those requests are cute so that they're</span> <span data-start="1478.809" data-end="1482.2">always executed after the database is</span> <span data-start="1482.2" data-end="1487.45">actually open yeah and there's also no</span> <span data-start="1487.45" data-end="1489.07">need to close the database handle</span> <span data-start="1489.07" data-end="1493.419">because once there once the once we ate</span> <span data-start="1493.419" data-end="1497.919">garbage collects the DB object here we</span> <span data-start="1497.919" data-end="1500.62">automatically close the database handle</span> <span data-start="1500.62" data-end="1503.14">so the user doesn't have to call close</span> <span data-start="1503.14" data-end="1510.159">manually and one other thing that I</span> <span data-start="1510.159" data-end="1512.32">implemented here is if you don't pass a</span> <span data-start="1512.32" data-end="1514.14">call that function like in this example</span> <span data-start="1514.14" data-end="1517.98">and the query can still failure right</span> <span data-start="1517.98" data-end="1522.279">and in that case I just omit an error</span> <span data-start="1522.279" data-end="1526.27">event on the database object so a note</span> <span data-start="1526.27" data-end="1527.38">has some code in there that</span> <span data-start="1527.38" data-end="1529.659">automatically like throws errors when</span> <span data-start="1529.659" data-end="1532.12">there is an uncaught error object on</span> <span data-start="1532.12" data-end="1536.5">some other object so that way like you</span> <span data-start="1536.5" data-end="1542.14">can still catch those another example is</span> <span data-start="1542.14" data-end="1544.99">no blend which the module dead just</span> <span data-start="1544.99" data-end="1548.5">blends together two images and we don't</span> <span data-start="1548.5" data-end="1550.72">have to like create a new operator here</span> <span data-start="1550.72" data-end="1552.789">which is called a function with two</span> <span data-start="1552.789" data-end="1555.399">buffers and we get a buffer pack so</span> <span data-start="1555.399" data-end="1557.35">there's no need to instantiate anything</span> <span data-start="1557.35" data-end="1560.83">here like we don't need any state so</span> <span data-start="1560.83" data-end="1562.779">there's no like various plant states so</span> <span data-start="1562.779" data-end="1565.36">we just like take images and blend them</span> <span data-start="1565.36" data-end="1569.11">together um there's some more</span> <span data-start="1569.11" data-end="1571.46">documentation of these links here</span> <span data-start="1571.46" data-end="1576.409">and yeah I check out the github</span> <span data-start="1576.409" data-end="1579.32">repository there are a lot more comments</span> <span data-start="1579.32" data-end="1582.669">in there there's also some samples for</span> <span data-start="1582.669" data-end="1585.47">creating objects in there like the new</span> <span data-start="1585.47" data-end="1590.899">operator and yeah thanks to mr aleph and</span> <span data-start="1590.899" data-end="1595.73">ice axe and orlando for for some of the</span> <span data-start="1595.73" data-end="1598.76">examples that I used and some of their</span> <span data-start="1598.76" data-end="1628.739">modules and yeah any questions</span> <span data-start="1628.749" data-end="1632.119">you mean like as opposed to using run</span> <span data-start="1632.119" data-end="1638.019">and get I did consider that the reason</span> <span data-start="1638.019" data-end="1640.7">there are different methods is that</span> <span data-start="1640.7" data-end="1642.83">symptoms you'd like just don't care</span> <span data-start="1642.83" data-end="1645.11">about the result you don't have to like</span> <span data-start="1645.11" data-end="1647.929">step over the result object so when you</span> <span data-start="1647.929" data-end="1650.119">don't care about the result you just use</span> <span data-start="1650.119" data-end="1652.039">run if you wanted to get just a single</span> <span data-start="1652.039" data-end="1654.47">value you can use get and there are some</span> <span data-start="1654.47" data-end="1656.059">where methods as well that are described</span> <span data-start="1656.059" data-end="1658.399">on the module website so that's the</span> <span data-start="1658.399" data-end="1660.859">reason for it you can also just always</span> <span data-start="1660.859" data-end="1667.309">use all or get there's no look no</span> <span data-start="1667.309" data-end="1673.4">damaging that</span> </p>
</section>