<section>
<p><span data-start="20.029" data-end="25.359">So we started off today with gPU programming and we're now moving on to compilers nice</span> <span data-start="27.199" data-end="33.219">Um my name is Francisca Hinkelman. I'm a software engineer on the Chrome V8 team</span> <span data-start="33.22" data-end="38.74">I'm also a node.js core collaborator and I talk about Profiling V8. I</span> <span data-start="44.15" data-end="50.619">Think we can all agree that Javascript is incredibly powerful like not only in what it can do</span> <span data-start="50.62" data-end="52.93">But also in how fast it can do it</span> <span data-start="53.87" data-end="56.32">it's amazing that the Javascript a</span> <span data-start="56.9" data-end="60.129">Scripting language you can run enterprise note service</span> <span data-start="60.13" data-end="67.809">And you can run websites with these huge complex frameworks like a Facebook website or linkedin or YouTube and all that was a scripting language</span> <span data-start="68.03" data-end="69.74">and</span> <span data-start="69.74" data-end="71.949">the performance of Javascript, or</span> <span data-start="72.829" data-end="78.339">the possibility to run such huge applications with Javascript of course comes down to the</span> </p>
<p><span data-start="78.859" data-end="84.189">Javascript engines the virtual machines that take your source code and turn it into an executable</span> <span data-start="84.56" data-end="90.909">Machine code make your website dynamic um so in this start, we'll look at V8</span> <span data-start="90.909" data-end="93.068">that's the Javascript engine in Chrome and</span> <span data-start="93.649" data-end="98.349">What it does to make Javascript so fast and how you can profile these optimizations?</span> <span data-start="100.46" data-end="104.739">So to put V8 into context the eight is not the only Javascript engine</span> <span data-start="106.039" data-end="111.159">The the Major Browsers all have their own Javascript engine we have check of our core that is in</span> <span data-start="111.439" data-end="116.828">Microsoft Edge you might have heard kind of talk yesterday. We have Javascript core and Safari</span> <span data-start="117.049" data-end="123.278">We have spider monkey and various other monkeys and firefox and we have V8 in chrome</span> <span data-start="123.95" data-end="130.149">If you're familiar with nodejs that also runs with a javascript engine your default node comes with V8</span> <span data-start="130.149" data-end="132.149">but you can also build it with Jack Krak for</span> </p>
<p><span data-start="134.25" data-end="137.059">Electron refer talks about electrons and status</span> <span data-start="137.76" data-end="141.709">Chromium and nodejs it has a V8 instance</span> <span data-start="141.709" data-end="146.479">And then there's other engines that are smaller if you took yun talks there</span> <span data-start="146.48" data-end="150.32">They are very good for iot devices because they're much much smaller</span> <span data-start="150.32" data-end="154.339">They are not as fast as the big ones, but you can fit them on your little micro controllers</span> <span data-start="154.41" data-end="157.309">So duct tape or Javascript are examples there</span> <span data-start="159.06" data-end="160.29">in</span> </p>
<p><span data-start="160.29" data-end="164.15">In order to talk successfully about program about profiling</span> <span data-start="164.819" data-end="169.909">In this talk will look a little bit of some of the internal key concepts of V8</span> <span data-start="170.37" data-end="174.11">So I'm hoping to give you some insight into this black box um</span> <span data-start="174.75" data-end="177.559">what we eight is doing under the hood how you go from</span> <span data-start="178.14" data-end="180.739">Source code to really fast machine code</span> <span data-start="181.26" data-end="185.39">And I'll show you some some tools. How you can Profile V8</span> <span data-start="185.39" data-end="187.55">so not profile Javascript on A</span> <span data-start="187.739" data-end="192.679">Higher level that would be probably more useful if you want the first performance gains</span> <span data-start="192.69" data-end="197.449">But really down at the Low level compiler level Javascript engine</span> <span data-start="198.81" data-end="204.829">The the tools I'm showing you on the one hand. They're tools that we use internally at V8</span> <span data-start="204.829" data-end="209.539">So if we want to make it faster if we want to figure out, why something slow, what is slow?</span> <span data-start="209.54" data-end="215.509">Yeah, those are the tools we use and then we change we ade internally to make it faster</span> <span data-start="215.51" data-end="220.34">but of course you can also use these tools to compile to profile your code and</span> <span data-start="221.13" data-end="223.759">Maybe make some changes there to gain performance</span> <span data-start="227.22" data-end="231.949">If you've used the chrome dev tools you might have seen there is a profile tab</span> </p>
<p><span data-start="231.95" data-end="237.32">So you have two console and you can inspect your hTML and css, but there's also a profile</span> <span data-start="237.989" data-end="243.589">profile Tab where you can record cPU profiles or heap snapshots and</span> <span data-start="244.23" data-end="249.799">When you do that for Javascript, or you can also do it for node.js server application?</span> <span data-start="250.59" data-end="253.009">You you start your app you load your website</span> </p>
<p><span data-start="253.01" data-end="259.459">You start recording after while you stop it? And then you you get a profile of which functions are being run a lot</span> <span data-start="260.01" data-end="265.909">So I did this year for compiling some typescript you see which function is spent</span> <span data-start="266.72" data-end="272.239">time being spent on but one thing you see he unfortunately is this little exclamation mark</span> <span data-start="272.55" data-end="275.06">Which of course means some kind of trouble?</span> <span data-start="275.91" data-end="283.339">In this case the function is related to gets a warning from the profiler saying not optimized and the reason is</span> <span data-start="283.62" data-end="285.62">optimized too many times</span> <span data-start="285.72" data-end="287.72">so the next</span> <span data-start="287.76" data-end="293.149">22 minutes, I want to dig into what does this optimization mean?</span> <span data-start="293.15" data-end="297.5">What are we trying to optimize and why is this not happening or possible in this case?</span> <span data-start="298.32" data-end="300.06">so</span> <span data-start="300.06" data-end="303.44">Let's start with some fundamentals. I guess um</span> <span data-start="305.4" data-end="311.39">Javascript is dynamically typed. It's not statically typed like C++. Or what you have arrest</span> <span data-start="311.39" data-end="317.779">It's dynamically typed that means the types of your variables can change all the time and the compiler</span> <span data-start="317.97" data-end="319.95">only influenced at runtime</span> </p>
<p><span data-start="319.95" data-end="321.03">What?</span> <span data-start="321.03" data-end="326.329">What kind of object or type it has it doesn't know that when I just sees the swiss code?</span> <span data-start="326.91" data-end="328.91">um</span> <span data-start="329.43" data-end="333.859">Here's a very simple example. It's an object defined as an object literal</span> <span data-start="334.38" data-end="340.459">X is 1 and y is 1 do you know what the properties of this object are I?</span> <span data-start="341.97" data-end="345.799">Mean it's it's very obvious x and y clearly our properties</span> <span data-start="346.08" data-end="352.399">But are they do the only properties know this object also gets all the properties of the object</span> </p>
<p><span data-start="353.01" data-end="358.069">Prototype or if you change the prototype it would get all the properties of that new prototype</span> <span data-start="359.61" data-end="365.75">Ok so we figure out properties are x and y and everything from the prototype chain can the compiler rely on this information?</span> <span data-start="366.6" data-end="370.369">No, because you can at any time delete properties of an object</span> <span data-start="370.77" data-end="376.31">So this object that you have can change all the time and only at runtime can the compiler say yes?</span> <span data-start="376.31" data-end="378.859">It has an x yes. It has y or not</span> <span data-start="379.44" data-end="381.919">And of course you can also add properties</span> <span data-start="382.2" data-end="389.059">So this type information is not available up front it's it's dynamic and the compiler always has to infer it</span> <span data-start="390.57" data-end="391.919">and</span> <span data-start="391.919" data-end="395.899">So since Java Script is dynamically typed. What all the</span> <span data-start="396.599" data-end="401.688">Modern Javascript engines do those that care about performance those that we use under browsers</span> <span data-start="401.689" data-end="405.259">Not necessarily on the smallest iot devices is so-called</span> <span data-start="405.869" data-end="407.869">just-in-Time compilation</span> <span data-start="407.969" data-end="411.858">So we compile as we execute a program in</span> </p>
<p><span data-start="412.649" data-end="418.789">C++ this is very different if you've ever done any C++. It is clearly ahead of time compilation</span> <span data-start="419.429" data-end="423.469">because you actually do two separate steps you first compile it and</span> <span data-start="424.019" data-end="427.699">You add a little bit and then you get an executable that you can run</span> <span data-start="428.039" data-end="432.199">There's no such thing in Javascript you you just run it. I mean you might</span> <span data-start="432.869" data-end="438.499">Transpile it first depending what you use, but there's no separate compilation step from the execution</span> <span data-start="440.459" data-end="447.709">But for Javascript because we don't have any type information anything can change all the time we need to do just-in-time compilation</span> <span data-start="454.499" data-end="458.689">I'm gonna look at this example a lot. It's it's super simple</span> <span data-start="458.689" data-end="462.439">it's a function that I called load and all it does it's it's</span> <span data-start="462.569" data-end="467.658">Accessing a property you wouldn't even put that in a function usually because it doesn't do much</span> <span data-start="467.729" data-end="471.888">but it's just return object that x given a parameter x and</span> </p>
<p><span data-start="472.169" data-end="477.588">Obviously you do property access all the time in Javascript even if you do console dot lock</span> <span data-start="478.139" data-end="481.909">Console is your object and blog as your property so it's just</span> <span data-start="482.129" data-end="488.419">Everywhere you can't do without property access and this looks super simple you have it all the time. It looks very harmless</span> <span data-start="488.419" data-end="491.118">You know what it does, but if you think about it carefully</span> <span data-start="491.519" data-end="498.888">what are all the things that could happen here as to return value well as the compiler tries to get the value object at x</span> <span data-start="498.889" data-end="500.189">um</span> </p>
<p><span data-start="500.189" data-end="504.379">First of all if you put an  as a parameter, it'll throw a type error</span> <span data-start="506.549" data-end="510.049">The object might not have two property x so it would be</span> <span data-start="511.829" data-end="518.929">Or it might be that the object itself doesn't have an own property x but somewhere up the prototype chain x was defined</span> <span data-start="519.089" data-end="523.938">so the compiler would have to look up recursively the prototype chain until it finds x</span> <span data-start="525.089" data-end="528.648">Object might be a proxy so we have to call it to get handler</span> <span data-start="530.31" data-end="537.089">And x might have been defined and eggman script sic style as an exerciser script where you have to call the get function</span> <span data-start="537.089" data-end="540.148">So you can have any kind of arbitrary side effects?</span> <span data-start="540.67" data-end="547.62">So for the compiler this very simple object at x is is a lot of stuff it has to worry about</span> <span data-start="548.86" data-end="550.86">um</span> <span data-start="551.11" data-end="553.979">This is a snippet from the Acma script</span> <span data-start="554.529" data-end="559.258">specification don't be worried about reading all this, but this is how the</span> <span data-start="559.93" data-end="562.349">Ordinary get us what they call it is Define</span> </p>
<p><span data-start="564.22" data-end="569.73">And you can tell this is quite involved for just a tiny little object that x down here</span> <span data-start="574.779" data-end="578.219">So since we have property accesses everywhere on the program</span> <span data-start="578.23" data-end="581.009">We eight needs to do a little trick because we can't afford</span> <span data-start="581.35" data-end="585.749">To do these steps every time you do a console that log or any kind of access</span> <span data-start="586.329" data-end="588.009">So let me show you what you do</span> </p>
<p><span data-start="588.009" data-end="589.92">So here's the simple load function</span> <span data-start="589.92" data-end="594.389">And we call it with this very simple object that is just a regular object</span> <span data-start="594.389" data-end="599.639">no changes on the prototype chain it has one property x and it's an integer, so</span> <span data-start="600.189" data-end="604.469">When we when the compiler encounters is this call of load?</span> <span data-start="605.769" data-end="607.769">Well, we do implement</span> <span data-start="608.829" data-end="613.619">Correct atmosphere Javascript, so the compiler has to follow these steps on a specification</span> </p>
<p><span data-start="614.139" data-end="619.979">Which is quite involved and eventually it figures out okay? It's a value to script. I have to return this value</span> <span data-start="619.98" data-end="622.709">Which is at a certain offset of this object?</span> <span data-start="623.559" data-end="629.759">Okay, so we found object at x and now what we do is. We cache this information and</span> <span data-start="630.85" data-end="633.569">What we are caching is we're caching for</span> <span data-start="634.179" data-end="636.299">these kind of objects</span> <span data-start="636.819" data-end="638.819">This is how you get the value?</span> <span data-start="639.009" data-end="645.628">So we're not caching that specific object and the 5V caching objects that look exactly like this</span> <span data-start="646.389" data-end="648.389">simple Literal in this case</span> <span data-start="648.999" data-end="650.999">we know the</span> <span data-start="651.309" data-end="657.989">Value for x is at a constant offset to our object, so that's some V8 internal that we know where it's stored</span> <span data-start="657.99" data-end="663.479">but but we know any object that looks like this, so just one property it's called x and it's an</span> <span data-start="664.27" data-end="666.66">This is how we get to the value if we needed?</span> <span data-start="667.42" data-end="671.819">And we associate that cash with the call with this property access</span> </p>
<p><span data-start="673.78" data-end="676.769">So when we later in the program called load again?</span> <span data-start="676.81" data-end="678.81">We're calling it now as a different object</span> <span data-start="678.85" data-end="685.35">this one has the object x is 17 and not 5 but they look very much the same if you think about the shape of</span> <span data-start="685.35" data-end="686.8">these objects</span> <span data-start="686.8" data-end="693.689">So when we do this again, and we get to this property access um well. We're being smart now</span> <span data-start="693.69" data-end="700.23">We check the cache first to see if maybe we have already figured out how to do that um and we realize yes</span> <span data-start="700.23" data-end="705.389">We have exactly these kind of objects we have an entry full objects that look like this in the cache</span> <span data-start="705.39" data-end="707.35">so let's just get the</span> <span data-start="707.35" data-end="713.639">Offset because that is where that value is and we furr can forget about these 10 steps that otherwise. We'd have to do</span> <span data-start="716.53" data-end="722.91">Ok and um these caches the the former name is inline caches. We shortcut them to ICs</span> </p>
<p><span data-start="723.34" data-end="727.439">So if you have a look at the 8 source code, there's a lot of ICs everywhere</span> <span data-start="729.58" data-end="733.74">You have an IC associated to every property access</span> <span data-start="734.14" data-end="739.35">Not to the function or the object but every single access so in this case you have two</span> <span data-start="740.05" data-end="746.159">Completely separate inline caches for both these lines even though it looks the same and it's the same function</span> <span data-start="746.65" data-end="750.389">and what you store in an IC is the keys a</span> </p>
<p><span data-start="751.18" data-end="758.849">Shape of objects and the values are the fast path how to get that value?</span> <span data-start="759.79" data-end="760.77">So in our case</span> <span data-start="760.77" data-end="766.98">We're storing what the object looks like and we had to get to 5 or a 17 over my axis</span> <span data-start="767.01" data-end="770.819">And when I say shape of objects internally we call this</span> <span data-start="771.22" data-end="777.989">map of an object and sometimes it's also referred to as a hidden class so since Javascript doesn't have</span> <span data-start="778.51" data-end="783.18">Classes, or didn't have classes until ES6 those are very different we call it</span> </p>
<p><span data-start="783.64" data-end="787.68">We give objects internally such a hidden internal class</span> <span data-start="789.04" data-end="794.31">Ok, so this is one way how we speed up the aid to do property accesses faster</span> <span data-start="795.52" data-end="800.86">That would not be yet to have a reactor immigrant in any reasonable time</span> <span data-start="803.09" data-end="807.819">What what any modern compiler has these days is at least?</span> <span data-start="808.25" data-end="812.32">two compilers a basic one and an optimizing compiler</span> <span data-start="814.43" data-end="821.259">in V8 we have actually two optimizing compilers at the moment the referred to as</span> <span data-start="821.66" data-end="825.369">crankshaft and Turbofan if you've ever come across that um</span> <span data-start="825.59" data-end="831.97">And so how that works is when you first run your program the basic compiler is trying to compile your code</span> <span data-start="832.37" data-end="834.37">very very fast</span> <span data-start="834.62" data-end="836.62">but too very</span> <span data-start="836.75" data-end="841.57">Naive machine code so it might not be super fast when you run your first executed</span> <span data-start="842.12" data-end="847.9">But after a while the basic compiler says well this function here that is executed all the time</span> <span data-start="847.97" data-end="853.839">we should really speed this up into better machine code so the optimizing compiler takes over and</span> <span data-start="854.66" data-end="856.869">recompiles a so-called hot function</span> <span data-start="857.72" data-end="859.28">into</span> </p>
<p><span data-start="859.28" data-end="863.829">Better machine code so you have more work because you have to recompile again</span> <span data-start="864.02" data-end="867.999">But you get much much faster codes when you run it a lot. It's worth it</span> <span data-start="868.7" data-end="870.7">and so if you combine</span> <span data-start="871.49" data-end="877.839">Optimization with these inline caches that's where you get a big big jump in in speed</span> <span data-start="881.96" data-end="883.19">Okay</span> <span data-start="883.19" data-end="886.57">So I hope you still with me. It's early um</span> <span data-start="887.72" data-end="888.92">if</span> <span data-start="888.92" data-end="894.099">If I lost you a little bit now would be a good time to get back um</span> <span data-start="897.17" data-end="904.989">I'm gonna show you no actual machine code for a simple function like that, so think about it you write</span> <span data-start="905.87" data-end="913.15">Javascript source code with cool frameworks and lots of stuff and everything's changing all the time everybody can put modules up</span> <span data-start="913.19" data-end="916.09">But when you compile it you get down to machine code</span> <span data-start="916.09" data-end="921.489">That's basically the same for decades, and I think it's really cool to see how like</span> <span data-start="922.1" data-end="927.189">The the high-level stuff what it ends up with in in machine code um</span> </p>
<p><span data-start="927.77" data-end="929.77">So just to recap</span> <span data-start="930.319" data-end="937.659">The Javascript engines they compile Javascript code down to machine code and I want to show you some machine code now</span> <span data-start="937.939" data-end="939.939">still for this load example</span> <span data-start="940.999" data-end="947.139">so this year is optimized for scene code for the simple load function that returns object at x and</span> <span data-start="947.689" data-end="953.739">It might look like a lot. I mean, it's a full page of code but for like low-level machine code</span> <span data-start="953.74" data-end="959.109">This is really not much, and I'm gonna show you what it actually does so up here. It says um</span> <span data-start="960.29" data-end="963.819">Call Stack check. This is where we entered a function?</span> <span data-start="963.819" data-end="968.199">We just have to make sure we don't have too much recursion recursion and we can still</span> <span data-start="969.92" data-end="973.3">Have space on the stack. So this is where we start the function</span> <span data-start="975.199" data-end="979.179">The next thing we do is a check nonce my sews my is</span> <span data-start="979.67" data-end="987.61">The aide internal language for a small integer we distinguish between small integers or objects on the heap</span> <span data-start="989.449" data-end="993.099">Anything that's an object must be on the heap if it's if it's a smile</span> </p>
<p><span data-start="993.1" data-end="995.35">You can check the hidden class of it or anything</span> <span data-start="995.509" data-end="1002.128">So this is just a backup check basically making sure we we do deal with some kind of object internally</span> <span data-start="1004.36" data-end="1006.009">and now the</span> <span data-start="1006.009" data-end="1012.479">What the function should do now is get object that x and return that so what we do in this?</span> <span data-start="1012.699" data-end="1018.628">Optimized piece of machine code is a so called check maps and I said map is our word for</span> <span data-start="1019.449" data-end="1021.539">internal class or the shape of the object</span> <span data-start="1022.059" data-end="1027.148">So what this optimist machine code is doing now. It's comparing the two maps of</span> <span data-start="1027.699" data-end="1029.409">the</span> <span data-start="1029.409" data-end="1031.409">Parameter that you passed into the function</span> </p>
<p><span data-start="1031.449" data-end="1038.579">So that object has a map it's comparing that to the map that we saved in the inline cache when the basic</span> <span data-start="1038.799" data-end="1044.999">Compiler ran this before and if those are the same just like in our example before if those are the same</span> <span data-start="1046.299" data-end="1048.299">then we can do the</span> <span data-start="1048.73" data-end="1055.439">cheap fast property access which in this case is a load named fear you know I'll just load this field at the</span> <span data-start="1055.57" data-end="1057.57">specific offset and</span> </p>
<p><span data-start="1057.61" data-end="1059.61">Be done with it return it</span> <span data-start="1059.77" data-end="1061.77">now if those map checks</span> <span data-start="1062.06" data-end="1063.84">if if we call</span> <span data-start="1063.84" data-end="1066.709">The load function with an object now that looks very different</span> <span data-start="1067.35" data-end="1071.63">Then the map check would fail we don't have the same as that what we had on the cache</span> <span data-start="1071.63" data-end="1074.69">And we have to jump when we end up down here</span> <span data-start="1075.42" data-end="1079.009">which says the optimization bailout, so</span> </p>
<p><span data-start="1080.28" data-end="1082.999">You run your code you fill your cache</span> <span data-start="1083.73" data-end="1090.83">eventually you decide let's make really fast machine code you use the information from the cache to make this machine code like it's</span> <span data-start="1091.08" data-end="1095.719">Hard-Coded in there. It says check the map at exactly this address and</span> <span data-start="1096.51" data-end="1101.599">Now when you're running this code when you put objects in that are very different from what?</span> <span data-start="1101.76" data-end="1108.379">You are expecting from something you can't handle in the inline cache then you end up in Addy optimization</span> <span data-start="1108.99" data-end="1115.25">So that's where the optimizing compiler says I can handle this and you go back to the basic slower compiler</span> <span data-start="1117.36" data-end="1124.16">Okay, so um I said here. We make one map check because we had exactly one object in our cache</span> <span data-start="1124.16" data-end="1130.7">So we only compared to this one object um that's why we distinguish different states of inline caches</span> <span data-start="1131.37" data-end="1135.56">So we have if there's exactly one entry we call them monomorphic</span> <span data-start="1135.57" data-end="1139.309">If there's a handful like up to four entries</span> <span data-start="1139.31" data-end="1140.13">We call it</span> <span data-start="1140.13" data-end="1147.71">polymorphic and anything more as mega morphic and if you want if you can you want your code to have mostly monomorphic</span> <span data-start="1148.01" data-end="1151.489">Or maybe polymorphic caches but avoid the mega morphic</span> <span data-start="1152.25" data-end="1153.45">um</span> </p>
<p><span data-start="1153.45" data-end="1159.739">So here in this example that I just showed you there was one map check because the cache that we assumed the cash was</span> <span data-start="1159.99" data-end="1164.15">monomorphic if our cache is polymorphic and then we</span> <span data-start="1164.88" data-end="1168.89">Generate this optimized code um it would look like this</span> <span data-start="1169.71" data-end="1172.189">which is exactly the same except that it has</span> <span data-start="1172.59" data-end="1179.449">Four map checks in there we would compare against these four entries that we have in the cache now if it's mega morphic</span> <span data-start="1179.45" data-end="1183.019">We can't keep going on with all these branches and we have to do</span> <span data-start="1184.02" data-end="1190.79">Computationally more expensive things so that's why you want if possible always objects of the same shape</span> <span data-start="1191.23" data-end="1193.23">at the property accesses</span> <span data-start="1194.12" data-end="1199.479">So same game as before we are checking but if it matches one of the entries in the cache</span> <span data-start="1199.73" data-end="1206.409">Then we can just fast jump and return if it doesn't match any one of them. We're back to this deoptimization</span> <span data-start="1209.36" data-end="1212.679">Okay, and um you can actually try all of that</span> <span data-start="1212.679" data-end="1217.119">You can just take chrome that you have anyways and if you started from the command line</span> <span data-start="1218.12" data-end="1222.279">Be behind chrome just put this flag — those J's flags</span> <span data-start="1222.889" data-end="1228.939">Equals and then put the V8 flags that you want so for this case if you put print opt coat</span> <span data-start="1229.159" data-end="1235.659">Print optimized code you can also do a print code comments that gives you exactly this output</span> <span data-start="1235.82" data-end="1242.169">So you start chrome put this behind it open a website and your console will go full with like output like this oh</span> <span data-start="1246.47" data-end="1248.47">these flags</span> </p>
<p><span data-start="1249.23" data-end="1250.37">Okay</span> <span data-start="1250.37" data-end="1255.339">so we care about what the state of the inline caches is and if you want to dig a</span> <span data-start="1255.529" data-end="1258.309">Little Deeper in what's going on in your application?</span> <span data-start="1258.86" data-end="1265">we have a nice little tool for it ice the Icy explorer wenjian where you can explore the</span> <span data-start="1265.399" data-end="1267.399">states of your inline caches</span> <span data-start="1268.46" data-end="1273.909">You generate the output like I just said put the flags behind chrome and then load the file here</span> <span data-start="1273.909" data-end="1278.648">And you can group your inline caches very nicely by different keys</span> <span data-start="1279.679" data-end="1282.999">you really do want to use this tool not just the editor because</span> </p>
<p><span data-start="1283.549" data-end="1287.259">Here was compiling some type script, and it's a million entries. This is</span> <span data-start="1288.019" data-end="1290.169">Very nice if you get this grouped for you</span> <span data-start="1291.74" data-end="1295.359">You can sort by different things like here for example</span> <span data-start="1295.36" data-end="1300.939">I sorted by a code location and I drill down on the function that I saw earlier that had the</span> <span data-start="1301.279" data-end="1306.969">Exclamation mark so I can see exactly okay. What is happening at the property accesses in this function?</span> <span data-start="1308.51" data-end="1315.939">So nice little tool to see what are the inline caches doing because they affect the speed and the optimizations</span> <span data-start="1316.94" data-end="1322.299">There's also a nice overview if you want to see which functions are actually being optimized that micro</span> <span data-start="1322.44" data-end="1328.83">Kyla and any functions d optimize if you do tres opt and trace d upped you get this information, so</span> <span data-start="1329.44" data-end="1334.32">Here if we run an example that calls load eventually if you run it often enough, you'll see</span> </p>
<p><span data-start="1335.379" data-end="1337.979">Optimizing the function load, so the optimizing compiler</span> <span data-start="1338.62" data-end="1342.059">Recompiles it generates machine code similar to what we just saw</span> <span data-start="1342.639" data-end="1349.109">And then if you keep calling it and eventually call it with very different objects you will see D</span> <span data-start="1349.45" data-end="1351.96">optimizing evicting entry from the code database</span> </p>
<p><span data-start="1352.899" data-end="1355.349">So what's what's happening? Here is um</span> <span data-start="1356.59" data-end="1361.62">In this optimize machine code that I showed you when the map check didn't work out?</span> <span data-start="1361.62" data-end="1365.879">we jumped all the way to the bottom and said Bailout the optimization and</span> <span data-start="1366.549" data-end="1368.549">what we aide is doing here, it's</span> </p>
<p><span data-start="1369.039" data-end="1375.419">Deleting this optimize code because it figured well we optimized it, but it doesn't quite work, so we throw it away</span> <span data-start="1375.419" data-end="1379.349">We start over with the slow basic compiler for this function again</span> <span data-start="1382.24" data-end="1384.24">so</span> <span data-start="1384.549" data-end="1391.168">You don't want to see this too much when you profile your app because it slows it down</span> <span data-start="1392.139" data-end="1399.029">So back to this original problem where we saw the exclamation mark warning not optimized optimize too many times um</span> <span data-start="1400.269" data-end="1403.289">Now we have a better understanding of what's going on here</span> <span data-start="1403.409" data-end="1406.859">We have this function is related to there are things like property</span> <span data-start="1407.169" data-end="1413.158">Excesses in it we run this function with the basic compiler we put entries into our inline caches</span> <span data-start="1414.669" data-end="1421.349">And eventually we optimize it using the information from the inline cache, but then we run it with stuff that doesn't match</span> <span data-start="1421.35" data-end="1426.779">What's in the cache and we d optimize it and we run it again and a slow compiler eventually say oh</span> <span data-start="1426.779" data-end="1434.549">let's optimize it again, and then we do this ten times and eventually the compiler says no point in optimizing this because</span> <span data-start="1435.429" data-end="1438.658">Generating the optimized code of course costs performance</span> <span data-start="1439.299" data-end="1444.959">Let's just not optimize this function anymore. I give up so this is where this exclamation mark Comes from</span> <span data-start="1445.629" data-end="1451.589">And so by by looking at the cPU profile looking at the inline caches</span> </p>
<p><span data-start="1452.44" data-end="1454.619">Looking at optimized machine code</span> <span data-start="1455.13" data-end="1458.94">So non-optimized code and looking at the original Javascript code</span> <span data-start="1459.07" data-end="1465.36">It's possible to figure out what kind of changes to make to get rid of this optimization the optimization optimization</span> <span data-start="1465.4" data-end="1472.079">Do you have to mutation thing? So when you make those changes you profile again? You don't get the exclamation mark Anymore</span> <span data-start="1473.95" data-end="1475.95">okay um</span> <span data-start="1478.24" data-end="1482.01">General warning as always with optimizations be very very careful</span> <span data-start="1482.35" data-end="1486.449">only optimize if you really must if you have performance problems</span> <span data-start="1486.45" data-end="1490.86">And then if you do optimize make sure you really measure and find your bottlenecks</span> <span data-start="1490.86" data-end="1494.04">Don't blindly optimize don't say oh I've heard something about</span> <span data-start="1494.41" data-end="1499.619">Optimizing compilers gonna start changing because here I can tweak and in my cache or something</span> <span data-start="1500.56" data-end="1504.06">You just introduce bugs and make your code really hard to maintain</span> <span data-start="1504.88" data-end="1507.989">That's just the usual optimization um</span> <span data-start="1509.32" data-end="1512.04">but in this case specifically I</span> </p>
<p><span data-start="1513.37" data-end="1519.39">Would almost advise against optimizing for things like that because those are V8 internals. They're not</span> <span data-start="1520.18" data-end="1524.879">Agreed upon by the Acma Script Committee to be like this</span> <span data-start="1526.39" data-end="1528.42">and they change internally like</span> <span data-start="1529.72" data-end="1535.319">Every commit that we make every canary version you get every night things might have changed</span> <span data-start="1535.51" data-end="1541.56">We might have figured a better way to do something. So when you did micro optimizations for something that is true today</span> <span data-start="1541.63" data-end="1543.63">It might actually be</span> <span data-start="1543.94" data-end="1545.97">Negatively affecting your performance tomorrow</span> </p>
<p><span data-start="1546.73" data-end="1551.219">And then obviously it's just we ate the other Javascript engines work very differently</span> <span data-start="1551.56" data-end="1555.839">so if you write your Javascript code in a specific weight, and they're only</span> <span data-start="1556.54" data-end="1559.649">Faster and this one engine, but probably not in the other engines</span> <span data-start="1562.9" data-end="1567.359">So I hope I was able to give you a little bit of an insight into this</span> <span data-start="1567.73" data-end="1573.75">Black box of Javascript engines what they do from source code to really fast machine code</span> <span data-start="1574.27" data-end="1579.42">If you want to play with any of this yourself and see what uh what's my app doing in general?</span> </p>
<p><span data-start="1579.43" data-end="1581.669">Or what a little code Snippets doing?</span> <span data-start="1581.98" data-end="1587.699">You can always just use chrome started from the command Line — - — j as flag</span> <span data-start="1587.95" data-end="1593.769">equals and in some things we looked at was a trace of trace deopt print opcode or</span> <span data-start="1594.38" data-end="1598.179">Trace I see if you're familiar with node you can also</span> </p>
<p><span data-start="1599.029" data-end="1603.999">Start a node server and put the V8 flags here. Just put them right behind node</span> <span data-start="1604.73" data-end="1607.12">and if you were more adventurous</span> <span data-start="1607.12" data-end="1614.289">You can compile a V8 yourself and get D8 then it's the V8 debugging shell and run that with all the flags</span> <span data-start="1614.51" data-end="1621.76">um if you use D8 you have the advantage that you don't get the overhead of things that happen in the browser or</span> <span data-start="1622.1" data-end="1628.029">Things that happen in node before your function actually starts up and if you want to</span> <span data-start="1628.519" data-end="1633.969">Explore your inline caches the ICC explorer is distributed with the V8 source code</span> <span data-start="1634.19" data-end="1640.09">There's a link to it um if you have any questions or feedback or performance questions</span> </p>
</section>