<section>
<p><span data-start="12.7" data-end="14.46">Hello, Ah it works, great.</span> <span data-start="14.46" data-end="16.46">View is fantastic from up here</span> <span data-start="16.94" data-end="19.52">Oh, I'm up there</span> <span data-start="19.8" data-end="22.22">Before I begin, I want to give a shout out to my mum.</span> <span data-start="22.22" data-end="26.64">She is a caretaker, and even though she doesn't understand anything about computers, she watches</span> <span data-start="26.64" data-end="28.55">all my talks.</span> </p>
<p><span data-start="28.55" data-end="32.87">I think in particular she will like this one about hand crafting web assembly.</span> <span data-start="32.87" data-end="34.969">So, yes, welcome, everyone.</span> <span data-start="34.969" data-end="40.339">We've heard a lot about JavaScript so far, and now it's time talk about WebAssembly,</span> <span data-start="40.339" data-end="44.219">so hold on to your brains.</span> <span data-start="44.219" data-end="45.66">My name is Emil Bay.</span> <span data-start="45.66" data-end="54.28">I live in Copenhagen in Denmark, and I'm an independent consultant primarily working with</span> <span data-start="54.28" data-end="60.479">crypto- mathematics, and drifted systems, and, when I say "crypto-"I mean the real,</span> <span data-start="60.479" data-end="65.089">the cryptology, not the currencies, and all that.</span> <span data-start="65.089" data-end="72.76">Yes, I used to study math but dropped out, and all that, and now I work in software.</span> <span data-start="72.76" data-end="75.46">So, as I said, I was also here last year.</span> <span data-start="75.46" data-end="81.27">I looked a little bit different, got a shave and a hair cut.</span> <span data-start="81.27" data-end="83.2">So, yes.</span> <span data-start="83.2" data-end="84.2">Okay.</span> <span data-start="84.2" data-end="86.109">So, WebAssembly.</span> <span data-start="86.109" data-end="89.52">Just want to get everyone on the same page.</span> <span data-start="89.52" data-end="94.02">So, we all understand what we are talking about here today.</span> </p>
<p><span data-start="94.02" data-end="96.869">So WebAssembly, this is from the WebAssembly website.</span> <span data-start="96.869" data-end="103.09">WebAssembly is a binary instruction format for stack-based virtual machine.</span> <span data-start="103.09" data-end="106.59">It sounds very fancy, but we can forget about that for today.</span> <span data-start="106.59" data-end="108.34">We're not going to use those big words.</span> <span data-start="108.34" data-end="114.569">So, it all looked like, there is a lot of technical terms in here.</span> <span data-start="114.569" data-end="121.119">Instead, maybe we should do a bit about the word "WebAssembly" "web" and "assembly", and</span> <span data-start="121.119" data-end="127.829">you might get connotation s in that it must be a computer language before you can do something</span> <span data-start="127.829" data-end="134.2">with maybe a web browser, something, but actually, WebAssembly is neither very web nor very assembly.</span> <span data-start="134.2" data-end="136.59">I don't know where this quote came from.</span> <span data-start="136.59" data-end="139.12">I think I read it online somewhere.</span> <span data-start="139.12" data-end="144.1">But it's not very web, because in WebAssembly, you cannot actually do very much.</span> </p>
<p><span data-start="144.1" data-end="151.75">You don't have access to any web APIs unless you give access, and it's also not very assembly</span> <span data-start="151.75" data-end="157.4">in the sense that it's not — WebAssembly is not the code that's running on the machine</span> <span data-start="157.4" data-end="164.36">— it's very close to the machine — but it is still an abstraction.</span> <span data-start="164.36" data-end="170.51">Just to clear everything out, I have another couple of points about what WebAssembly isn't</span> <span data-start="170.51" data-end="172.9">before we get to look at some code.</span> </p>
<p><span data-start="172.9" data-end="179.439">First of all, from WebAssembly, you cannot do sys calls which is a fancy word for saying</span> <span data-start="179.439" data-end="185.629">you cannot .. with the operating system unless you give WebAssembly explicit access, and</span> <span data-start="185.629" data-end="188.819">explicit access has to go through JavaScript as it is today.</span> <span data-start="188.819" data-end="193.099">From WebAssembly, you can only do the things you can in JavaScript and only if you give</span> <span data-start="193.099" data-end="195.819">it explicit access.</span> </p>
<p><span data-start="195.819" data-end="199.4">It also does not give you any new hardware access.</span> <span data-start="199.4" data-end="202.95">The reason I have this one on here is that people — the whole story about WebAssembly</span> <span data-start="202.95" data-end="206.98">is that you can take your native programmes and compile them in WebAssembly and run them</span> <span data-start="206.98" data-end="208.989">in a web browser.</span> <span data-start="208.989" data-end="215.489">That gives people the impression they can take any native app, like a Bluetooth library,</span> <span data-start="215.489" data-end="221.68">put it into a exiled with M script, whatever, into WebAssembly, and run it in the browser.</span> <span data-start="221.68" data-end="223.159">That's not how it, would.</span> <span data-start="223.159" data-end="226.82">You also don't get no new hardware access.</span> <span data-start="226.82" data-end="228.56">Actually will be you — actually, there's no magic.</span> <span data-start="228.56" data-end="232.159">It's pure computational WebAssembly.</span> <span data-start="232.159" data-end="237.26">So that was a lot of negativity, so what is WebAssembly?</span> <span data-start="237.26" data-end="243.159">Well, one thing I'm extremely excited about in WebAssembly is that we have 64-bit integers,</span> <span data-start="243.159" data-end="252.219">and we heard about BigInt earlier today, and 64-bit in WebAssembly means that we can pinpoint</span> <span data-start="252.219" data-end="257.55">precision optimisation of the things that have to do with computing with numbers.</span> </p>
<p><span data-start="257.55" data-end="265.24">I work with cryptography, and a lot of time, we are dealing with numbers that are 256-bits</span> <span data-start="265.24" data-end="269.89">or 512-bits long, and 4-bit integers are a real performance boost.</span> <span data-start="269.89" data-end="276.42">You get a performance boost by taking your code and converting it to WebAssembly but</span> <span data-start="276.42" data-end="280.26">not as much as people would like to think in my experience.</span> <span data-start="280.26" data-end="287.23">From most of the former benchmarks I've been running, I see a performance boost of about</span> <span data-start="287.23" data-end="293.47">20 to 30 per cent over JavaScript, and that is because JavaScript is very, very fast with</span> <span data-start="293.47" data-end="299.86">the new — the new engines like SpiderMonkey, and all that.</span> <span data-start="299.86" data-end="301.28">You get surgical precision.</span> <span data-start="301.28" data-end="307.98">In JavaScript, when you write code, you often don't know the exact performance profile of</span> <span data-start="307.98" data-end="313.56">what you're doing unless you have very deep knowledge about what the VM is doing underneath.</span> </p>
<p><span data-start="313.56" data-end="319.06">With WebAssembly, you get much closer to what it's going to be going on on your computer,</span> <span data-start="319.06" data-end="322.47">so you get a more predictable performance profile.</span> <span data-start="322.47" data-end="328.55">And, one thing I'm excited about WebAssembly, is that soon it may be the only language that</span> <span data-start="328.55" data-end="330.77">is truly run anywhere.</span> <span data-start="330.77" data-end="336.41">I'm seeing people do projects with writing WebAssembly drivers for the Linux kernel,</span> <span data-start="336.41" data-end="347.68">and there are also people embedding WebAssembly, and it's on the browser at load, and maybe</span> <span data-start="347.68" data-end="356.18">also come to embed it and WebAssembly is not a technical any woo we can use in the future,</span> <span data-start="356.18" data-end="358.75">we can use WebAssembly today.</span> <span data-start="358.75" data-end="366.21">We can see globally, it has 73 per cent support across the browsers, and it is also in Node</span> <span data-start="366.21" data-end="368.41">8.</span> <span data-start="368.41" data-end="372.22">So you can use this today.</span> <span data-start="372.22" data-end="377.27">That quote I had earlier from the WebAssembly website, there was something more to it, because</span> <span data-start="377.27" data-end="383.87">WebAssembly is the sign to be a format that you take your C++, or C programmes of Rust,</span> <span data-start="383.87" data-end="388.33">and now also Go programmes, and you can compile into WebAssembly.</span> </p>
<p><span data-start="388.33" data-end="396.18">The only problem is that I didn't read that, so, this is why today we're going talk about</span> <span data-start="396.18" data-end="397.59">the WebAssembly text format.</span> <span data-start="397.59" data-end="401.9">This is writing WebAssembly by hand, not taking computer programme and compiling it down as</span> <span data-start="401.9" data-end="402.9">WebAssembly.</span> <span data-start="402.9" data-end="408.18">No, we get full control, and we know what is going to happen inside the computer.</span> </p>
<p><span data-start="408.18" data-end="411.12">It's a very small programming language.</span> <span data-start="411.12" data-end="417.38">And it's one-to-one with the binary format with a through caveats, but you know exactly</span> <span data-start="417.38" data-end="420.65">the programme you wrote, what it's going to be compiled into.</span> <span data-start="420.65" data-end="425.72">There's no optimisation in between, and no moving things around, or anything like that.</span> <span data-start="425.72" data-end="428.63">You know exactly what is going to go on.</span> <span data-start="428.63" data-end="433.08">It has an appropriate acronym — "WHAT" — which is what you'll be saying most of the time</span> <span data-start="433.08" data-end="437.36">when you look at the WebAssembly programmes.</span> <span data-start="437.36" data-end="445.15">I want to make clear that the programming language we look at next is an official language</span> <span data-start="445.15" data-end="446.78">from the WebAssembly working group.</span> <span data-start="446.78" data-end="451.15">It is not something I invented or [unclear] someone else wrote.</span> </p>
<p><span data-start="451.15" data-end="453.38">It is official language.</span> <span data-start="453.38" data-end="455.65">So, that's enough talking.</span> <span data-start="455.65" data-end="458.64">Let's look at some code.</span> <span data-start="458.64" data-end="461.37">Here we have our first WebAssembly module.</span> <span data-start="461.37" data-end="464.59">This is the "hello, world" of WebAssembly.</span> <span data-start="464.59" data-end="470.03">If you squint a bit, you can see what this module does.</span> <span data-start="470.03" data-end="479.61">So that everyone gets it, I'm also for my own sake, going to walk through some highlights.</span> <span data-start="479.61" data-end="487.93">The function calls look beard because they are S expressions, and some people who may</span> <span data-start="487.93" data-end="490.61">have been programming in Clojure will find this familiar.</span> <span data-start="490.61" data-end="497.34">It is a little bit foreign is to to JavaScript developers but you get used to it very quickly.</span> <span data-start="497.34" data-end="501.12">It is like having a list before the function name or after.</span> <span data-start="501.12" data-end="506.13">There's not much more to it.</span> <span data-start="506.13" data-end="510.46">Next thing we notice is that we have to wrap everything in a module, and that's like an</span> </p>
<p><span data-start="510.46" data-end="511.46">ES6 module.</span> <span data-start="511.46" data-end="515.909">You can have one module per file as it is right now.</span> <span data-start="515.909" data-end="519.399">That's just a boilerplate.</span> <span data-start="519.399" data-end="525.35">Next we can see we have these dollar signs, and you might think that is going to be the</span> <span data-start="525.35" data-end="526.35">variables.</span> <span data-start="526.35" data-end="527.35">Not exactly.</span> <span data-start="527.35" data-end="531.769">It is more like a human-friendly name to be able to access the — you can see here, I</span> <span data-start="531.769" data-end="537.959">gave the function name call square with a dollar sign in front, but as soon as you compile</span> <span data-start="537.959" data-end="544.569">the programme, all of these texts are going to disappear and be replaced with a number</span> <span data-start="544.569" data-end="549.7">so the binary is going to be very small.</span> </p>
<p><span data-start="549.7" data-end="552.72">Next thing you know is that that explicit typing everywhere, and this is part of the</span> <span data-start="552.72" data-end="559.709">security module, so that the WebAssembly virtual machine can look at the binary and make sure</span> <span data-start="559.709" data-end="565.38">that it is going to be guaranteed to be well behaved, that it doesn't access memory it's</span> <span data-start="565.38" data-end="573.3">not supposed to, and the functions have matching types and you don't have  behaviour.</span> <span data-start="573.3" data-end="574.66">Also in the the third highlight there.</span> <span data-start="574.66" data-end="577.75">That's not actually a type but an operator.</span> <span data-start="577.75" data-end="583.649">They follow the convention that the first part of the name is the return type, and then,</span> <span data-start="583.649" data-end="585.379">after the dot, you have whatever you're doing.</span> </p>
<p><span data-start="585.379" data-end="594.009">Here, we are doing I32 ultimate multiplication, which is an integer that is 32 bits wide.</span> <span data-start="594.009" data-end="600.76">Those are the integers you can operate on in JavaScript, if you do — your number's</span> <span data-start="600.76" data-end="605.05">going to be cast to a 32-bit integer.</span> <span data-start="605.05" data-end="613.05">The last thing that makes it verbose is that you have to make all access explicit, so here</span> <span data-start="613.05" data-end="618.1">we get a local variable, a variable from the local scope where we are getting the parameter,</span> <span data-start="618.1" data-end="624.36">the input, and you can think of this goes and gets the values and replaces whatever</span> <span data-start="624.36" data-end="629.61">is in the text, and that's a way for you to evaluate what expressions in your head is</span> <span data-start="629.61" data-end="634.36">you can start from the — all the way from the inside, and then you can replace the things</span> <span data-start="634.36" data-end="640.699">as you go outside and try and evaluate it in your head.</span> <span data-start="640.699" data-end="647.279">So, also, the explicit access is something you will probably want to optimise in hard</span> <span data-start="647.279" data-end="651.749">code, so that is why it is also very nice that the accesses are very explicit, and you</span> <span data-start="651.749" data-end="654.87">know exactly what is happening.</span> </p>
<p><span data-start="654.87" data-end="657.499">So, we have our first module.</span> <span data-start="657.499" data-end="662.76">The next thing is we need to be able to run this, so we need a compiler.</span> <span data-start="662.76" data-end="669.91">The compiler that I'm using comes from the What project but my friend Mateus put it on</span> <span data-start="669.91" data-end="671.48">MPM so it is easy to install.</span> <span data-start="671.48" data-end="677.62">You run the web binary tool kit, it will fetch the latest version of the compiler and exile</span> <span data-start="677.62" data-end="681.26">it for you — compile it for you.</span> <span data-start="681.26" data-end="684.74">Let's look at the demo.</span> <span data-start="684.74" data-end="700.529">Because, now, we have — can I — oh, I have to do it like this.</span> </p>
<p><span data-start="700.529" data-end="707.81">Where's my .. . A terminal here.</span> <span data-start="707.81" data-end="712.449">I have a square function here, so this looks a little bit different because this is the</span> <span data-start="712.449" data-end="718.06">way that I planned it, the parentheses, messed up, because I have a tool in my editor to</span> <span data-start="718.06" data-end="721.05">help me out writing What code.</span> <span data-start="721.05" data-end="727.61">We will use the What-to-Wasm compiler.</span> <span data-start="727.61" data-end="731.079">Now we have the square dot WASM.</span> <span data-start="731.079" data-end="742.43">This is a binary file so I will use hex dump with the C option, and .. this is what the</span> <span data-start="742.43" data-end="745.75">binary module looks like.</span> </p>
<p><span data-start="745.75" data-end="751.16">You can see the function name because we exported it, so it needs to keep the string, and then,</span> <span data-start="751.16" data-end="755.37">if you're familiar with WebAssembly, you can see the up codes up there, so you can see</span> <span data-start="755.37" data-end="758.999">the access to the variables and the multiplications, and all that.</span> <span data-start="758.999" data-end="762.37">I'm no brain man, so I can't read this.</span> <span data-start="762.37" data-end="766.519">Where did my cursor go?</span> <span data-start="766.519" data-end="769.91">Damn it!</span> <span data-start="769.91" data-end="774.92">How do I escape?</span> <span data-start="774.92" data-end="779.18">There we go.</span> <span data-start="779.18" data-end="780.6">Okay.</span> <span data-start="780.6" data-end="785.79">Now, the next thing is we have the binary module, then we need to import it, and actually</span> <span data-start="785.79" data-end="786.79">use it.</span> </p>
<p><span data-start="786.79" data-end="792.689">So, this is the boilerplate from the JavaScript side that you use to read out the WebAssembly</span> <span data-start="792.689" data-end="793.769">module.</span> <span data-start="793.769" data-end="797.18">Now, this looks very complicated to me.</span> <span data-start="797.18" data-end="801.72">I have a very weird definition of what is complicated, so this is also packaged up in</span> <span data-start="801.72" data-end="804.019">a tool that you can use from MPM.</span> <span data-start="804.019" data-end="810.309">You can install What to JS which takes your What module, compiles it down to Wasm and</span> <span data-start="810.309" data-end="814.879">wraps it in a JavaScript function or module so you can import that directly instead of</span> <span data-start="814.879" data-end="820.259">having to go and fetch the WebAssembly module and do the instantiation, and all that.</span> <span data-start="820.259" data-end="828.649">So the way you do that is you would call what.js with your WebAssembly file and output a JavaScript</span> <span data-start="828.649" data-end="829.649">file.</span> <span data-start="829.649" data-end="838.69">Let's have a look at that.</span> <span data-start="838.69" data-end="840.86">I have it installed.</span> <span data-start="840.86" data-end="842.62">I'm going to take the squared of What.</span> <span data-start="842.62" data-end="849.279">Put it in square dot.</span> </p>
<p><span data-start="849.279" data-end="854.89">Then we have the — you can see I have the example file here.</span> <span data-start="854.89" data-end="861.079">It just imports the WASM module, and then the exporter function square with two, and</span> <span data-start="861.079" data-end="863.68">then we should see four will be right?</span> <span data-start="863.68" data-end="866.61">I'm going to run the example Node.</span> <span data-start="866.61" data-end="870.23">Got four.</span> <span data-start="870.23" data-end="874.079">Now we have a running WASM programme — very cool.</span> <span data-start="874.079" data-end="875.22">[Applause].</span> <span data-start="875.22" data-end="877.49">Thank you.</span> <span data-start="877.49" data-end="878.62">Okay.</span> <span data-start="878.62" data-end="885">Here is the code for reference.</span> <span data-start="885" data-end="890.55">Next step, now we have the basically flowdown, now we will look at a real What programme,</span> <span data-start="890.55" data-end="897.329">and also a programme structured like I write what What.</span> <span data-start="897.329" data-end="901.459">The function we look at is a function to compute the distance between points.</span> <span data-start="901.459" data-end="906.879">It might seem contrived but this could be a call function if you're building a physics</span> <span data-start="906.879" data-end="913.379">library, or maybe doing some machine-learning, or some other AI.</span> </p>
<p><span data-start="913.379" data-end="914.81">Distances are very important.</span> <span data-start="914.81" data-end="921.009">You can see we have a lot of new syntax here, so I'm just going to walk you through it.</span> <span data-start="921.009" data-end="926.26">The thing I said before about the brackets is that I have this plugin that is pretty</span> <span data-start="926.26" data-end="931.85">much all the most common editor is called .. that helps you set the brackets, so instead</span> <span data-start="931.85" data-end="936.029">of me having to type out the brackets manually, it decides where the brackets are supposed</span> <span data-start="936.029" data-end="939.11">to be put, based on indentation.</span> <span data-start="939.11" data-end="946.579">That's what you also know from Python, indentation is what decides how things are scoped.</span> <span data-start="946.579" data-end="949.269">Here is the tour of this module.</span> <span data-start="949.269" data-end="952.689">You can see up in the top I give it a name.</span> <span data-start="952.689" data-end="954.86">F64, and that's like the Wasm convention.</span> <span data-start="954.86" data-end="959.49">That's how I like to name my functions so I know what the return type is.</span> </p>
<p><span data-start="959.49" data-end="962.44">You can see the return type is F64.</span> <span data-start="962.44" data-end="965.779">F64 means double floating point.</span> <span data-start="965.779" data-end="969.99">That is exactly what numbers on JavaScript, so this is exactly like a number in JavaScript</span> <span data-start="969.99" data-end="971.379">where you have decimal places.</span> <span data-start="971.379" data-end="975.089">Then you can see I defined some local variables.</span> <span data-start="975.089" data-end="979.089">These local variables have to be all the way at the top of the function.</span> <span data-start="979.089" data-end="984.55">That's just how Wasm is so something to do with how to allocate the registers that are</span> <span data-start="984.55" data-end="986.6">required for this.</span> <span data-start="986.6" data-end="991.899">You can also see at the bottom we use a new function, the F64 square root, and then we</span> <span data-start="991.899" data-end="992.899">have a call here.</span> <span data-start="992.899" data-end="999.73">And the call is to the call is to the square function because this is a formula for the</span> <span data-start="999.73" data-end="1004.139">distance between two points.</span> <span data-start="1004.139" data-end="1005.6">The call here is important.</span> <span data-start="1005.6" data-end="1010.29">If you import a JavaScript function into a WebAssembly module, then you would also invoke</span> <span data-start="1010.29" data-end="1013.36">that function with the call — yes.</span> <span data-start="1013.36" data-end="1015.869">There is a problem, though.</span> </p>
<p><span data-start="1015.869" data-end="1022.31">If we try and compile this, we get a mismatch, and that's because, unlike in JavaScript,</span> <span data-start="1022.31" data-end="1028.26">you have to explicitly convert everything so, in this case, our I32 add goes back to</span> <span data-start="1028.26" data-end="1032.82">I32 because it says so, so we have to convert that.</span> <span data-start="1032.82" data-end="1038">So we add a new instruction, and this can lead to some verbosity, but I think this verbosity</span> <span data-start="1038" data-end="1044.08">is important because it does cost to convert between things so you want to keep your types</span> <span data-start="1044.08" data-end="1045.46">stable.</span> </p>
<p><span data-start="1045.46" data-end="1054.18">In this place here, the convert_u means that it doesn't have a sign, that it is a positive</span> <span data-start="1054.18" data-end="1056.05">number.</span> <span data-start="1056.05" data-end="1060.51">So, that was the distance function.</span> <span data-start="1060.51" data-end="1067.291">I'm going to show here, this is what it looks like when you call it, so the dot, I don't</span> <span data-start="1067.291" data-end="1073.2">want to give the wrong impression, this dot here we saw before, in the statement, it doesn't</span> <span data-start="1073.2" data-end="1075.64">mean that you put the distance on an object.</span> <span data-start="1075.64" data-end="1078.73">It is the name of the property.</span> <span data-start="1078.73" data-end="1080.27">So we have to invoke it like this.</span> <span data-start="1080.27" data-end="1083.06">So, are we having fun yet?</span> <span data-start="1083.06" data-end="1085.38">I said this was going to be fun.</span> <span data-start="1085.38" data-end="1088.19">So, but let's take it up a notch.</span> <span data-start="1088.19" data-end="1095.12">Now we're going to look at a more practical function, something you would go and use at</span> <span data-start="1095.12" data-end="1096.22">home.</span> <span data-start="1096.22" data-end="1101.94">We are going to do distance between vectors, and it sounds very fancy.</span> </p>
<p><span data-start="1101.94" data-end="1105.84">It means that we want to take the distance between two arrays.</span> <span data-start="1105.84" data-end="1107.64">Why would you do that?</span> <span data-start="1107.64" data-end="1113.69">For example, you can take an image from a canvas element, and some tracking from each</span> <span data-start="1113.69" data-end="1119.12">other, and that way, you can find a difference, and that's how most of the new visual tools</span> <span data-start="1119.12" data-end="1122.9">that work take two villages" subtract foreign minister them from each other, and you get</span> <span data-start="1122.9" data-end="1124.29">the artefacts of the difference.</span> </p>
<p><span data-start="1124.29" data-end="1128.91">You can see there is a lot of stuff going on here.</span> <span data-start="1128.91" data-end="1133.98">This is also a real-world example because now we're actually getting to deal with memory.</span> <span data-start="1133.98" data-end="1138.04">Memory is one of the big concepts that we never really talked too much about in JavaScript,</span> <span data-start="1138.04" data-end="1140.34">because it's all handled for us.</span> <span data-start="1140.34" data-end="1145.01">But, in WebAssembly, you have to be extremely explicit, allocate the memory itself, you</span> <span data-start="1145.01" data-end="1149.16">have to manage it yourself, and you only get one piece.</span> <span data-start="1149.16" data-end="1151.63">But memory is not too hard to think about.</span> <span data-start="1151.63" data-end="1153.28">It's just like a very big array.</span> <span data-start="1153.28" data-end="1155.93">Where you can put numbers into.</span> <span data-start="1155.93" data-end="1161.09">So, as you can see, we have a memory definition, and I export the memory, so I have access</span> <span data-start="1161.09" data-end="1162.09">to it from JavaScript.</span> <span data-start="1162.09" data-end="1166.87">You can choose not to export it if it is part of your security model, and you have the 1,</span> <span data-start="1166.87" data-end="1175.13">which means I want one page of memory, and a page of memory is 65 kilobytes.</span> <span data-start="1175.13" data-end="1177.32">When you want more memory, you increment in pages.</span> <span data-start="1177.32" data-end="1179.75">You can also see the parameters here.</span> </p>
<p><span data-start="1179.75" data-end="1181.5">I've given them funny Michelle Dewberry and Andy Walton.</span> <span data-start="1181.5" data-end="1187.18">If you've done anything with C, you will know about pointers, because now that we have one</span> <span data-start="1187.18" data-end="1192.42">big piece of memory, we need to have pointers into that memory, and pointer is just a fancy</span> <span data-start="1192.42" data-end="1197.82">word for index, so you know the I in the foreloop.</span> <span data-start="1197.82" data-end="1202.07">And since we're using pointers, the array doesn't have an inherent length, so we in</span> <span data-start="1202.07" data-end="1205.81">these to parts in the length — parse in the length explicitly.</span> <span data-start="1205.81" data-end="1208.84">This is how numbers look when they are put into memory.</span> <span data-start="1208.84" data-end="1215.44">At the topping you can see I have this i8 for an 8-bit integer, also called a byte,</span> <span data-start="1215.44" data-end="1217.89">so a byte array.</span> <span data-start="1217.89" data-end="1220.54">Next we will take examples from the typescript we've seen before.</span> <span data-start="1220.54" data-end="1229.36">For example, i42 takes — that is something to be aware about when you need to allocate</span> <span data-start="1229.36" data-end="1231.69">memory.</span> <span data-start="1231.69" data-end="1239.59">The way we are going to parse in our arrays is using the pointer and the link, and this</span> <span data-start="1239.59" data-end="1243.82">is what it is going to look like in the linear memory.</span> <span data-start="1243.82" data-end="1248.561">We have a pointer which is an index into the memory, so, just a number, and then we have</span> <span data-start="1248.561" data-end="1254.5">the length for how far we have used the memory.</span> </p>
<p><span data-start="1254.5" data-end="1262.4">You might also notice that these pointers are i32s, but before I said I was excited</span> <span data-start="1262.4" data-end="1268.7">about i64s because all addressing in Wembley is 32-bit, and — WebAssembly is 32 bit.</span> <span data-start="1268.7" data-end="1273.52">When I got my first computer, it was one of the first 64-bit computers because I could</span> <span data-start="1273.52" data-end="1276.3">have eight gigabytes of memory.</span> <span data-start="1276.3" data-end="1282.74">This is only 32 bits which only means your module can only use four gigabytes of memory.</span> <span data-start="1282.74" data-end="1290.9">It might change in the future, but for the — you only have four gigabytes at your disposal.</span> <span data-start="1290.9" data-end="1296.8">To put in data into the memory, I have written this little script here.</span> <span data-start="1296.8" data-end="1299.74">We are going with the idea of diffing two images.</span> <span data-start="1299.74" data-end="1303.96">First, we need to make sure that we have enough memory available otherwise we're going to</span> <span data-start="1303.96" data-end="1304.96">go out of bounds.</span> </p>
<p><span data-start="1304.96" data-end="1311.01">At the beginning, I allocate how long the two images are, make sure we have that memory</span> <span data-start="1311.01" data-end="1312.14">available.</span> <span data-start="1312.14" data-end="1319.09">Then I remember a point er to where I'm going to put the first image like we had in this</span> <span data-start="1319.09" data-end="1321.95">graphic.</span> </p>
<p><span data-start="1321.95" data-end="1323.23">And then I set the image.</span> <span data-start="1323.23" data-end="1329.03">You can just set it directly if you copy, type it in, and I increment the offset because</span> <span data-start="1329.03" data-end="1331.44">we put the first array in the beginning.</span> <span data-start="1331.44" data-end="1337.24">After that, we put the second array, and you can see in the end here, I then call the function</span> <span data-start="1337.24" data-end="1340.04">with the arguments we just saw.</span> <span data-start="1340.04" data-end="1344.46">In this case, this is going to give back a single number, but if, if I wanted, for example,</span> <span data-start="1344.46" data-end="1349.49">return the difference between the two images, I could also pass back a pointer which is</span> <span data-start="1349.49" data-end="1356.32">going to be a number, so that number I could use to go into the WASM memory and read out</span> <span data-start="1356.32" data-end="1359.13">what the difference image is.</span> <span data-start="1359.13" data-end="1362.25">One way to get image data, for example, with a canvas is like this.</span> <span data-start="1362.25" data-end="1364.82">Here, we get the image data.</span> <span data-start="1364.82" data-end="1370.17">You have loaded the image in our own, and you can find that — and the image data has</span> <span data-start="1370.17" data-end="1377.22">a data property which is a array with RGBA in each of the cells.</span> <span data-start="1377.22" data-end="1380.63">So that is an easy way to get started with this example.</span> <span data-start="1380.63" data-end="1384.46">The next code is when you need to access the memory from inside WebAssembly, you need to</span> <span data-start="1384.46" data-end="1389.2">be explicit about loading out things from memory, because loading from memory can also</span> <span data-start="1389.2" data-end="1391.07">be very expensive.</span> </p>
<p><span data-start="1391.07" data-end="1395.25">You can also see here that, because the pointer is a number, when I want to go to the next</span> <span data-start="1395.25" data-end="1401.61">element, I need to add two numbers together.</span> <span data-start="1401.61" data-end="1407.55">So here we load two bites, and you can see — bytes, you can see the underscore you.</span> <span data-start="1407.55" data-end="1416.82">Unsigned is — as you see, data array, that is just because of the way — of the data</span> <span data-start="1416.82" data-end="1421.34">I was loading.</span> </p>
<p><span data-start="1421.34" data-end="1426.46">Lasting we need here is that we want to iterate the whole array, so, the way we do that is</span> <span data-start="1426.46" data-end="1430.84">with something called of course a loop, but a loop in WebAssembly is a little bit different</span> <span data-start="1430.84" data-end="1435.53">than the loops you know from JavaScript, because in WebAssembly, it's about branching.</span> <span data-start="1435.53" data-end="1440.61">In JavaScript, we have branching we have continue and break which are two ways to branch inside</span> <span data-start="1440.61" data-end="1443.98">a foreloop or a wild loop, or whatever.</span> <span data-start="1443.98" data-end="1448.48">In this case, you can look at a loop as a do-while.</span> <span data-start="1448.48" data-end="1452.299">We look at the loop and execute our code.</span> <span data-start="1452.299" data-end="1457.24">At the end, we have a conditional branch, so that means we are going to go to back,</span> <span data-start="1457.24" data-end="1465.04">we're going to go back to the label, continue if our condition over here is true, so in</span> <span data-start="1465.04" data-end="1474.31">this case, I'm incrementing the offset, and checking the offset — reading out of bounds</span> <span data-start="1474.31" data-end="1479.15">is one of those notorious errors or security bugs that you get all the time in C programmes,</span> <span data-start="1479.15" data-end="1484.65">and you will get that in WebAssembly if you're not careful.</span> <span data-start="1484.65" data-end="1490.12">That was the business function, and this is I think a real world example.</span> <span data-start="1490.12" data-end="1496.67">I've used this to present a machine-learning algorithm which you can use to find primary</span> <span data-start="1496.67" data-end="1502.49">calls and images, and that kind of stuff, and I want to reiterate that this is not just</span> <span data-start="1502.49" data-end="1503.49">for fun.</span> </p>
<p><span data-start="1503.49" data-end="1504.6">I mean, we had fun, right?</span> <span data-start="1504.6" data-end="1506.01">It's not just for fun.</span> <span data-start="1506.01" data-end="1511.17">There is serious code out there, so I'm part of a GitHub organisation called Sodium Friends.</span> <span data-start="1511.17" data-end="1517.49">This is where we have a project called, with — we have bindings to Lip Sodium which is</span> <span data-start="1517.49" data-end="1525.94">a crypto-library written in C. What if you want to provide cryptography to your users</span> <span data-start="1525.94" data-end="1533.81">in the browser?.then you can go and install Sodium Universal which has five or ten algorithms</span> <span data-start="1533.81" data-end="1536.43">now handwritten in WebAssembly.</span> </p>
<p><span data-start="1536.43" data-end="1542.01">It has taken about a day to hand write each algorithm.</span> <span data-start="1542.01" data-end="1547.37">They are about a couple of thousand lines of code, but this is actual in production</span> <span data-start="1547.37" data-end="1554.58">now, Sodium Universal has 2,000 downloads a week, and it has even more downloads from</span> <span data-start="1554.58" data-end="1562.46">official channels, built into the bigger browser, and those don't show up in the statistics.</span> <span data-start="1562.46" data-end="1564.12">I see I have four minutes left.</span> <span data-start="1564.12" data-end="1567.13">I have something very exciting I want to show you.</span> <span data-start="1567.13" data-end="1570.43">This thing about writing WebAssembly, it can quickly become repetitive.</span> <span data-start="1570.43" data-end="1575.44">This is real-world code from the Lip Sodium project.</span> </p>
<p><span data-start="1575.44" data-end="1583.84">This is from a function called es cha-cha, it is really dense code, awkward to read,</span> <span data-start="1583.84" data-end="1586.12">repetitive.</span> <span data-start="1586.12" data-end="1594.4">It would be easier if you could define a function, call it, and then maybe search and replace,</span> <span data-start="1594.4" data-end="1595.78">and you can do that.</span> <span data-start="1595.78" data-end="1602.2">It's called macro-s in C. It's not build into — it's not built into WebAssembly.</span> <span data-start="1602.2" data-end="1603.97">It's easy to parse.</span> <span data-start="1603.97" data-end="1608.75">I built my pre-parser for web assemblies.</span> <span data-start="1608.75" data-end="1612.97">You can define macros which are like search and replace.</span> <span data-start="1612.97" data-end="1620.02">Suddenly, the big function that is hard to read becomes a lot more manageable.</span> <span data-start="1620.02" data-end="1622.26">I'm not sure what I want to call this project yet.</span> <span data-start="1622.26" data-end="1623.33">It's not public.</span> <span data-start="1623.33" data-end="1626.66">I was thinking something like What Up, something to that extent.</span> <span data-start="1626.66" data-end="1631.47">If you have good ideas, let me know on Twitter.</span> <span data-start="1631.47" data-end="1635.02">This was a little sneak peek of the future.</span> </p>
<p><span data-start="1635.02" data-end="1636.02">That's all I have to say.</span> <span data-start="1636.02" data-end="1637.02">Thank you!</span> </p>
</section>