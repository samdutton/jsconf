<section>
<p><span data-start="18.56" data-end="21.66">all right yeah so I'm here today to talk</span> <span data-start="21.66" data-end="24.54">to you about JSON and P L v8 inside of</span> <span data-start="24.54" data-end="27.63">Postgres and I also want to mention I</span> <span data-start="27.63" data-end="30.69">like birds and so I've been touring</span> <span data-start="30.69" data-end="33.81">around Amelia Island with my husband and</span> <span data-start="33.81" data-end="36.09">so I included a lot of pictures of the</span> <span data-start="36.09" data-end="37.92">birds that we've seen in the past few</span> <span data-start="37.92" data-end="39.87">days that we've been here so pardon</span> <span data-start="39.87" data-end="45.09">pardon my my birding but I I ended up</span> <span data-start="45.09" data-end="49.73">titling this schema liberation and the</span> <span data-start="49.73" data-end="53.79">reason why I use that phrase is there's</span> <span data-start="53.79" data-end="56.79">a lot of tension between managing your</span> <span data-start="56.79" data-end="60.45">data with schema design and what DBA is</span> <span data-start="60.45" data-end="64.35">typically do and the flexibility of JSON</span> <span data-start="64.35" data-end="67.14">objects and documents and there's a</span> <span data-start="67.14" data-end="69.39">misconception I think that once you</span> <span data-start="69.39" data-end="71.58">enter the world of database schemas that</span> <span data-start="71.58" data-end="74.79">it's just all twisty maze mazes of</span> <span data-start="74.79" data-end="78.509">sequel and slow tests and really sad sad</span> <span data-start="78.509" data-end="81.59">developers doing database migrations but</span> </p>
<p><span data-start="81.59" data-end="84.51">Posterous actually has for a long time</span> <span data-start="84.51" data-end="87.36">supported key value stores inside the</span> <span data-start="87.36" data-end="90.09">database this thing's called H store is</span> <span data-start="90.09" data-end="92.07">something that some of you here may may</span> <span data-start="92.07" data-end="95.79">have seen or used before but even with H</span> <span data-start="95.79" data-end="97.56">store there's kind of a mismatch between</span> <span data-start="97.56" data-end="100.89">what developers actually want to use and</span> <span data-start="100.89" data-end="104.25">how the database demanded that you store</span> <span data-start="104.25" data-end="107.909">and manipulate that so there really is</span> <span data-start="107.909" data-end="110.4">this gap between what DBAs think that</span> <span data-start="110.4" data-end="112.35">you should do and what developers really</span> <span data-start="112.35" data-end="116.189">actually want to do and I I want to talk</span> <span data-start="116.189" data-end="117.81">about this idea of schema liberation</span> <span data-start="117.81" data-end="121.86">from and I base this on conversations</span> </p>
<p><span data-start="121.86" data-end="125.61">I've had with people about MongoDB and</span> <span data-start="125.61" data-end="128.459">no one ever said those words to me</span> <span data-start="128.459" data-end="130.709">exactly but what they really did talk a</span> <span data-start="130.709" data-end="134.16">lot about was freedom this is from the</span> <span data-start="134.16" data-end="138.39">MongoDB documentation it's just a sort</span> <span data-start="138.39" data-end="140.43">excerpt that I think sums up a lot of</span> <span data-start="140.43" data-end="143.25">what data developers really love about</span> <span data-start="143.25" data-end="145.95">document store databases I think it's</span> <span data-start="145.95" data-end="148.47">it's this flexibility it's making</span> <span data-start="148.47" data-end="150.48">database objects that very closely</span> <span data-start="150.48" data-end="152.67">resemble what it is that you're</span> <span data-start="152.67" data-end="156.06">in the application and I hear this from</span> <span data-start="156.06" data-end="157.77">developers a lot that they wish changing</span> <span data-start="157.77" data-end="159.84">their schemas wasn't so hard that they</span> <span data-start="159.84" data-end="161.25">had better working relationships with</span> <span data-start="161.25" data-end="163.8">their DBAs and that deploying these</span> <span data-start="163.8" data-end="166.08">features into the datastore was just way</span> <span data-start="166.08" data-end="168.48">easier than it is so I just want to show</span> <span data-start="168.48" data-end="170.49">you an example of what this you know</span> <span data-start="170.49" data-end="172.32">what what this typically looks like and</span> <span data-start="172.32" data-end="174.93">what it what it really would be better</span> <span data-start="174.93" data-end="177.45">as so let's say you were recording your</span> <span data-start="177.45" data-end="181.56">bird sightings just a bunch of sequel</span> <span data-start="181.56" data-end="184.89">here this is what it might look like if</span> <span data-start="184.89" data-end="187.11">you were trying to store these sightings</span> <span data-start="187.11" data-end="188.91">in a sequel database you'd create a</span> <span data-start="188.91" data-end="191.01">bunch of tables a bird table allocations</span> <span data-start="191.01" data-end="194.97">table sightings table put this data into</span> <span data-start="194.97" data-end="196.68">the database a bunch of inserts and then</span> <span data-start="196.68" data-end="198.3">you'd have a joint able to put that in</span> <span data-start="198.3" data-end="201.45">there or you know we could just store</span> <span data-start="201.45" data-end="204.78">the JSON and looking at this it's really</span> <span data-start="204.78" data-end="206.459">obvious to me which one is more friendly</span> <span data-start="206.459" data-end="209.489">to the developer and I think for a long</span> <span data-start="209.489" data-end="210.15">time</span> </p>
<p><span data-start="210.15" data-end="212.79">DBAs have been pushing this problem of</span> <span data-start="212.79" data-end="215.1">early optimization on to developers and</span> <span data-start="215.1" data-end="218.88">I'm hoping that having JSON in Postgres</span> <span data-start="218.88" data-end="221.18">is going to make this a lot easier and</span> <span data-start="221.18" data-end="224.04">we can you know we can just help</span> <span data-start="224.04" data-end="226.41">developers enjoy working with relational</span> <span data-start="226.41" data-end="229.14">databases a lot better so could Postgres</span> <span data-start="229.14" data-end="230.82">be as flexible as want going to be could</span> <span data-start="230.82" data-end="233.07">we make developers as happy using a</span> <span data-start="233.07" data-end="235.049">relational database as they are using</span> <span data-start="235.049" data-end="237.63">document store databases well the</span> <span data-start="237.63" data-end="239.72">ingredients to do this right now</span> <span data-start="239.72" data-end="242.85">9.3 Postgres which is out in beta</span> <span data-start="242.85" data-end="244.739">currently you can download this and try</span> <span data-start="244.739" data-end="246.87">it out today or Heroku is actually</span> <span data-start="246.87" data-end="249.06">loaded all of these tools that I'm going</span> <span data-start="249.06" data-end="251.549">to show you today in their in their</span> <span data-start="251.549" data-end="253.29">development databases so you could fire</span> <span data-start="253.29" data-end="255">up a Heroku database and test it out and</span> <span data-start="255" data-end="258.51">they have PL VA ready to use there you</span> <span data-start="258.51" data-end="261.479">can also use it with 9.2 Postgres but</span> <span data-start="261.479" data-end="263.31">you have to load an extension called</span> </p>
<p><span data-start="263.31" data-end="265.35">JSON enhancements in order to get all</span> <span data-start="265.35" data-end="270.18">this functionality so v8 I mean I have</span> <span data-start="270.18" data-end="271.56">this slide in here it's mostly for the</span> <span data-start="271.56" data-end="273.06">benefit of the people who aren't here</span> <span data-start="273.06" data-end="275.82">today but after Brendan's talk of course</span> <span data-start="275.82" data-end="278.58">you all know what v8 is and PL v8 is</span> <span data-start="278.58" data-end="282.63">embedding v8 inside of Postgres and you</span> <span data-start="282.63" data-end="285.42">can see a lot more about PL v8</span> <span data-start="285.42" data-end="291.78">in that link there so I'm sure many of</span> <span data-start="291.78" data-end="294.18">you deal with normalized tables in the</span> <span data-start="294.18" data-end="296.4">database so let's say we have a table</span> <span data-start="296.4" data-end="297.87">called reports let's look at what this</span> <span data-start="297.87" data-end="301.8">might what this might be like and this</span> <span data-start="301.8" data-end="303.33">is an actual table that I have to deal</span> <span data-start="303.33" data-end="305.76">with there's like 38 columns here you</span> <span data-start="305.76" data-end="307.17">see all these different data types and</span> <span data-start="307.17" data-end="309.21">things like that and it's just not very</span> <span data-start="309.21" data-end="314.19">fun to deal with so let's just convert</span> <span data-start="314.19" data-end="317.22">this to JSON so if you're gonna take an</span> <span data-start="317.22" data-end="318.54">existing scheme you today and you wanted</span> <span data-start="318.54" data-end="320.28">to pull all the data out of it very</span> <span data-start="320.28" data-end="322.02">simple thing you can do is just a select</span> <span data-start="322.02" data-end="323.43">star from reports right and that would</span> <span data-start="323.43" data-end="325.71">give you all the data but I want to</span> <span data-start="325.71" data-end="327.45">convert it to JSON so there's actually a</span> <span data-start="327.45" data-end="329.22">function in Postgres that enables you to</span> <span data-start="329.22" data-end="333.18">do this it's called row to JSON but this</span> <span data-start="333.18" data-end="334.89">this query won't actually work you would</span> <span data-start="334.89" data-end="337.89">have to use a sub select in order to</span> <span data-start="337.89" data-end="340.23">pass it to it so because wrote a JSON</span> <span data-start="340.23" data-end="343.41">expects a record type so with this right</span> <span data-start="343.41" data-end="345.78">here I would pull all of the data out of</span> <span data-start="345.78" data-end="348.06">that reports table convert it to JSON</span> <span data-start="348.06" data-end="350.55">and spit it out but what I really want</span> <span data-start="350.55" data-end="351.69">is a table</span> </p>
<p><span data-start="351.69" data-end="353.61">I just want to shove this all into a</span> <span data-start="353.61" data-end="355.62">table and Postgres supports this really</span> <span data-start="355.62" data-end="359.34">great syntax for taking the output from</span> <span data-start="359.34" data-end="361.32">a query and dumping it directly into a</span> <span data-start="361.32" data-end="363.21">table you don't have to specify any of</span> <span data-start="363.21" data-end="364.47">the column types because post Chris</span> <span data-start="364.47" data-end="366.18">already knows what it is</span> <span data-start="366.18" data-end="369.84">so you can just put your sequel query</span> <span data-start="369.84" data-end="372.06">right in there generate a table so</span> <span data-start="372.06" data-end="375.6">magically there we go this is what it</span> <span data-start="375.6" data-end="377.55">looks like in Postgres you end up with</span> <span data-start="377.55" data-end="380.13">this table I called it liberated feeling</span> <span data-start="380.13" data-end="383.31">liberated and then my my column name is</span> <span data-start="383.31" data-end="384.57">wrote a JSON you could change that if</span> <span data-start="384.57" data-end="386.46">you wanted but that's how it turned out</span> <span data-start="386.46" data-end="391.08">and so I did this on a development</span> <span data-start="391.08" data-end="392.7">database that I have that has a copy of</span> <span data-start="392.7" data-end="396.15">our production data it took about two</span> <span data-start="396.15" data-end="398.22">minutes it was an older dev system this</span> <span data-start="398.22" data-end="400.1">entire table fit and memory is about a</span> <span data-start="400.1" data-end="403.23">two gig table and there were 2.7 million</span> <span data-start="403.23" data-end="405.39">rows in it so you know it was it was</span> <span data-start="405.39" data-end="406.62">pretty fast it didn't take me very long</span> <span data-start="406.62" data-end="411.03">and you know there's there's a penalty</span> <span data-start="411.03" data-end="413.94">for denormalization right in terms of</span> <span data-start="413.94" data-end="414.84">the amount of disk that we're going to</span> <span data-start="414.84" data-end="416.57">consume so you can see here the first</span> <span data-start="416.57" data-end="419.789">table my original table was two gigs</span> <span data-start="419.789" data-end="423.449">the JSON table was about four so you</span> <span data-start="423.449" data-end="425.46">know right well we pay a little bit of a</span> <span data-start="425.46" data-end="427.65">price there but honestly I don't really</span> <span data-start="427.65" data-end="430.71">care I got just to burn let's just</span> <span data-start="430.71" data-end="434.61">liberate our entire database right so I</span> <span data-start="434.61" data-end="438.27">wrote a function using PL v8 to liberate</span> <span data-start="438.27" data-end="440.189">your entire database and some friends of</span> <span data-start="440.189" data-end="441.15">mine have tried this out so it actually</span> <span data-start="441.15" data-end="441.839">does work</span> <span data-start="441.839" data-end="445.349">it's terrible JavaScript I apologize not</span> <span data-start="445.349" data-end="446.819">a JavaScript developer I think my</span> </p>
<p><span data-start="446.819" data-end="448.77">JavaScript looks like sequel well</span> <span data-start="448.77" data-end="449.669">there's a lot of sequel in there but</span> <span data-start="449.669" data-end="453.139">anyway so you could use this today to</span> <span data-start="453.139" data-end="457.229">convert some existing database that you</span> <span data-start="457.229" data-end="458.789">had in Postgres and I was just gonna go</span> <span data-start="458.789" data-end="460.05">through this really quickly to show you</span> <span data-start="460.05" data-end="464.849">kind of how simple this really is so a</span> <span data-start="464.849" data-end="466.649">lot of this is is this ended up being</span> <span data-start="466.649" data-end="468.96">about 25 lines with all my pluses and</span> <span data-start="468.96" data-end="470.52">whatever's in there but it's really only</span> <span data-start="470.52" data-end="472.589">about four lines of JavaScript there's</span> <span data-start="472.589" data-end="475.439">quite a bit of boilerplate so the first</span> <span data-start="475.439" data-end="476.999">thing here is this create schema</span> <span data-start="476.999" data-end="479.43">liberated and all this is is a namespace</span> <span data-start="479.43" data-end="481.62">the terminology and Postgres is a little</span> <span data-start="481.62" data-end="483.839">different than like MySQL we call a</span> <span data-start="483.839" data-end="485.909">cluster a group of databases and that's</span> <span data-start="485.909" data-end="488.669">like an instance of Postgres a database</span> <span data-start="488.669" data-end="490.529">contains schemas which and then these</span> <span data-start="490.529" data-end="491.999">schemas are these namespaces that</span> <span data-start="491.999" data-end="494.849">contain tables because I wanted to shove</span> <span data-start="494.849" data-end="495.99">those all in there and be able to you</span> <span data-start="495.99" data-end="499.589">know drop them when I was done easily so</span> <span data-start="499.589" data-end="501.18">then the boilerplate around here is</span> <span data-start="501.18" data-end="503.099">again it's pretty simple to create a</span> <span data-start="503.099" data-end="504.899">replace function</span> </p>
<p><span data-start="504.899" data-end="507.06">I gave it a function name and I'm not</span> <span data-start="507.06" data-end="508.68">passing any arguments because I'm just</span> <span data-start="508.68" data-end="510.599">going to convert everything it's gonna</span> <span data-start="510.599" data-end="512.899">return a boolean and then the language</span> <span data-start="512.899" data-end="516.839">is POV 8 obviously and then we've got an</span> <span data-start="516.839" data-end="518.76">ask function that signals ok now we're</span> <span data-start="518.76" data-end="520.05">going to show some JavaScript in there</span> <span data-start="520.05" data-end="524.039">and then the end and I had to sequel</span> <span data-start="524.039" data-end="525.329">queries in here that were a little bit</span> <span data-start="525.329" data-end="527.88">you know a little bit complex not too</span> <span data-start="527.88" data-end="529.829">bad and this right here shows you</span> <span data-start="529.829" data-end="532.199">pulling out all of the table names from</span> </p>
<p><span data-start="532.199" data-end="534.6">Postgres so when you're looking at</span> <span data-start="534.6" data-end="536.76">objects inside inside there</span> <span data-start="536.76" data-end="539.399">Postgres comes with a internal schema</span> <span data-start="539.399" data-end="542.55">called PG catalog and you can query all</span> <span data-start="542.55" data-end="544.38">of that data in there just as though you</span> <span data-start="544.38" data-end="546.75">were looking at an ordinary table so</span> <span data-start="546.75" data-end="547.89">that's kind of convenient so now I've</span> <span data-start="547.89" data-end="550.26">got a list of all of my tables that I</span> <span data-start="550.26" data-end="552.24">want to convert and then I'm just going</span> <span data-start="552.24" data-end="552.81">to Ryu</span> <span data-start="552.81" data-end="555.75">this query that I wrote earlier to</span> <span data-start="555.75" data-end="558">create all the tables that I want</span> <span data-start="558" data-end="559.98">without having to specify anything about</span> <span data-start="559.98" data-end="562.74">the the the actual structure of those</span> <span data-start="562.74" data-end="564.48">other than the fact that there's there's</span> <span data-start="564.48" data-end="568.08">a report query so you go so that's it</span> <span data-start="568.08" data-end="570.72">pretty simple VAR tables I've got a for</span> <span data-start="570.72" data-end="573.75">loop I'm doing a little elog in to let</span> <span data-start="573.75" data-end="576.57">me know that you know as each table is</span> <span data-start="576.57" data-end="580.56">being processed and then I execute it my</span> <span data-start="580.56" data-end="582.84">friend Craig tried it out so yes it does</span> <span data-start="582.84" data-end="583.86">work</span> <span data-start="583.86" data-end="586.11">he was already using the JSON data type</span> <span data-start="586.11" data-end="588.39">so it was like JSON within JSON which</span> <span data-start="588.39" data-end="591.09">wasn't very good test but anyway he</span> <span data-start="591.09" data-end="592.68">tried it out and it definitely did work</span> <span data-start="592.68" data-end="598.11">on our first try so if you're thinking</span> <span data-start="598.11" data-end="600.36">about using this I want to let you know</span> <span data-start="600.36" data-end="603.03">that the JSON data type is a first-class</span> <span data-start="603.03" data-end="606.12">data type you can index it you can join</span> <span data-start="606.12" data-end="608.37">against it you can compare it there are</span> <span data-start="608.37" data-end="610.8">operators that are defined for it you</span> <span data-start="610.8" data-end="612.39">can write functions for it as I as I</span> <span data-start="612.39" data-end="614.43">just showed and you can return it the</span> <span data-start="614.43" data-end="616.05">same way you would return an integer or</span> <span data-start="616.05" data-end="619.01">a text type or any other typical</span> <span data-start="619.01" data-end="622.62">database type so you might have already</span> <span data-start="622.62" data-end="625.59">inferred that this would be the syntax</span> <span data-start="625.59" data-end="626.67">for this but you know you can just</span> <span data-start="626.67" data-end="629.46">create table give a name to the column</span> <span data-start="629.46" data-end="631.86">and then you call the column JSON and</span> <span data-start="631.86" data-end="633.78">that'll create a table for you and then</span> <span data-start="633.78" data-end="635.64">inserting data in there is very simple</span> <span data-start="635.64" data-end="638.67">just insert into table name values and</span> <span data-start="638.67" data-end="640.44">then a JSON object straight into there</span> <span data-start="640.44" data-end="642.96">and then down below I show a select when</span> <span data-start="642.96" data-end="645.15">you select from it it just outputs</span> <span data-start="645.15" data-end="649.14">straight up JSON there's quite a bit of</span> <span data-start="649.14" data-end="651.84">predefined functions that we've put in</span> <span data-start="651.84" data-end="654.36">there for for helping you look at this</span> <span data-start="654.36" data-end="656.91">stuff so they're not always the best</span> <span data-start="656.91" data-end="657.96">names</span> <span data-start="657.96" data-end="661.59">maybe it's hard for us but they're very</span> <span data-start="661.59" data-end="663.54">well documented so I've got three here</span> <span data-start="663.54" data-end="665.52">they're pretty common commonly use JSON</span> <span data-start="665.52" data-end="669.38">object field text return field of text</span> </p>
<p><span data-start="669.38" data-end="671.73">JSON object field which will return a</span> <span data-start="671.73" data-end="673.92">quoted value in the event that you're</span> <span data-start="673.92" data-end="676.86">looking at things that aren't text and</span> <span data-start="676.86" data-end="679.08">then JSON object keys will return all</span> <span data-start="679.08" data-end="680.44">the keys in there</span> <span data-start="680.44" data-end="681.879">and like I said you can use these</span> <span data-start="681.879" data-end="685.089">because Postgres supports functions as</span> <span data-start="685.089" data-end="687.79">indexes you can create any kind of index</span> <span data-start="687.79" data-end="690.04">you want against this compare it join it</span> <span data-start="690.04" data-end="695.589">and use it just like any other column v8</span> <span data-start="695.589" data-end="698.199">is also trusted so you don't have to be</span> <span data-start="698.199" data-end="701.079">a super user to create and run functions</span> <span data-start="701.079" data-end="703.48">using Peele via inside the database this</span> <span data-start="703.48" data-end="705.16">is not this is not true of something</span> <span data-start="705.16" data-end="707.079">like Python for example pythons and</span> <span data-start="707.079" data-end="709.87">untrusted language and same goes for a</span> <span data-start="709.87" data-end="711.009">lot of the other languages that we</span> <span data-start="711.009" data-end="712.36">support we actually support Lua</span> <span data-start="712.36" data-end="715.12">as well Louis trusted anyway so you can</span> <span data-start="715.12" data-end="717.759">you can create and and run these just as</span> <span data-start="717.759" data-end="720.67">a normal user peel v8 automatically</span> <span data-start="720.67" data-end="722.889">parses JSON input so if you're doing</span> <span data-start="722.889" data-end="725.56">something like this where you input JSON</span> <span data-start="725.56" data-end="727.93">column and you have key text you can see</span> <span data-start="727.93" data-end="729.31">right there that I just immediately was</span> <span data-start="729.31" data-end="731.589">able to use that object without running</span> <span data-start="731.589" data-end="736.05">json.parse on it</span> </p>
<p><span data-start="736.06" data-end="738.25">POV eight of course also supports</span> <span data-start="738.25" data-end="740.35">running raw sequel and prepared</span> <span data-start="740.35" data-end="746.74">statements you can so yeah here's just</span> <span data-start="746.74" data-end="749.769">some examples execute prepare execute we</span> <span data-start="749.769" data-end="751.66">also support cursors which is an</span> <span data-start="751.66" data-end="753.13">advantage if you've got a lot of data</span> <span data-start="753.13" data-end="755.23">and you just want to transfer you know</span> <span data-start="755.23" data-end="757.87">one one row at a time and your return</span> <span data-start="757.87" data-end="763.99">function and I just threw this up here</span> <span data-start="763.99" data-end="767.259">because it makes me laugh you know we</span> <span data-start="767.259" data-end="768.6">could not only have sequel engine CH</span> <span data-start="768.6" data-end="770.259">injection but we can also have</span> <span data-start="770.259" data-end="772.269">JavaScript injection directly in the</span> <span data-start="772.269" data-end="774.88">database now because of support for PL</span> <span data-start="774.88" data-end="776.019">v8</span> </p>
<p><span data-start="776.019" data-end="777.25">I don't know that you'd want to actually</span> <span data-start="777.25" data-end="778.689">run this in production I do know some</span> <span data-start="778.689" data-end="779.829">people that have written things like</span> <span data-start="779.829" data-end="781.899">this and then stored their JavaScript</span> <span data-start="781.899" data-end="784.54">directly in the database to avoid having</span> <span data-start="784.54" data-end="786.939">to load lots of functions</span> <span data-start="786.939" data-end="788.68">time after time but yeah I don't know if</span> <span data-start="788.68" data-end="790.54">this is really advisable it's kind of</span> <span data-start="790.54" data-end="795.22">hilarious though so all that stuff</span> <span data-start="795.22" data-end="796.93">that's cute you know I'm telling you the</span> <span data-start="796.93" data-end="798.43">theory of you know how you might use</span> <span data-start="798.43" data-end="800.829">this but you know what what about in</span> <span data-start="800.829" data-end="802.209">production what does this actually look</span> <span data-start="802.209" data-end="805.87">like so I to work at Mozilla although</span> <span data-start="805.87" data-end="807.819">not on anything really JavaScript</span> <span data-start="807.819" data-end="811.329">related and I helped run this thing</span> <span data-start="811.329" data-end="812.47">called crash</span> <span data-start="812.47" data-end="814.87">that's at mozilla.com and this is every</span> <span data-start="814.87" data-end="817.9">time firefox crashes which I'm sure is</span> <span data-start="817.9" data-end="825.91">very rare I we look at those and and so</span> <span data-start="825.91" data-end="828.16">we have this this tool this is basically</span> <span data-start="828.16" data-end="831.28">a data warehouse tool analyzing this and</span> <span data-start="831.28" data-end="833.05">here's a picture this was made by a</span> <span data-start="833.05" data-end="837.43">contributor it looks it shows you what</span> <span data-start="837.43" data-end="840.91">our our internal structure is like you</span> <span data-start="840.91" data-end="842.35">know all the systems that are running to</span> <span data-start="842.35" data-end="845.2">make this thing go and you can see</span> <span data-start="845.2" data-end="847.15">there's two main data stores here we've</span> <span data-start="847.15" data-end="849.19">got HBase up there in the corner and</span> <span data-start="849.19" data-end="851.59">then Postgres you know very looming</span> <span data-start="851.59" data-end="853.48">large in the middle as you can kind of</span> <span data-start="853.48" data-end="855.85">see the contributors preference for</span> </p>
<p><span data-start="855.85" data-end="857.68">Postgres here it's a little misleading</span> <span data-start="857.68" data-end="859.57">though because our HBase cluster is</span> <span data-start="859.57" data-end="862.69">actually about 150 terabytes and the</span> <span data-start="862.69" data-end="864.39">Postgres cluster is only about two</span> <span data-start="864.39" data-end="866.5">there's a lot more interaction you know</span> <span data-start="866.5" data-end="869.8">a lot more tools that are interacting</span> <span data-start="869.8" data-end="871.63">with Postgres than HBase but you know</span> <span data-start="871.63" data-end="873.1">anyway so I thought I'd point that out</span> <span data-start="873.1" data-end="875.86">so we've got all of this data in each</span> <span data-start="875.86" data-end="877.87">base that's about you know 70 to 75</span> <span data-start="877.87" data-end="880.03">machines there and then there's only you</span> <span data-start="880.03" data-end="881.98">know three or four systems running the</span> <span data-start="881.98" data-end="884.83">post rest database so if we go back to</span> <span data-start="884.83" data-end="887.23">this reports table which is sometimes</span> <span data-start="887.23" data-end="889.69">the bane of my existence it's you know</span> <span data-start="889.69" data-end="893.05">very large it's complex it's not very</span> <span data-start="893.05" data-end="896.56">well documented exactly and it becomes a</span> <span data-start="896.56" data-end="899.56">real pain to you know I it's it's not</span> <span data-start="899.56" data-end="901.51">too difficult for me to add columns to</span> <span data-start="901.51" data-end="903.73">this when we add new information to our</span> <span data-start="903.73" data-end="906.64">crashes but you know it's it's not it's</span> <span data-start="906.64" data-end="909.37">not the greatest either so we started</span> <span data-start="909.37" data-end="911.47">talking about this when 92 came out and</span> <span data-start="911.47" data-end="914.68">we ended up upgrading our systems last</span> <span data-start="914.68" data-end="916.99">fall to 92 and then we just created this</span> <span data-start="916.99" data-end="920.65">table has the crash UUID</span> <span data-start="920.65" data-end="922.51">which is how we identify uniquely</span> <span data-start="922.51" data-end="923.89">identify all our crashes it has the date</span> <span data-start="923.89" data-end="925.93">processed and then it just has this JSON</span> <span data-start="925.93" data-end="929.92">blob of everything in it and we put this</span> <span data-start="929.92" data-end="932.7">into production at the beginning of May</span> <span data-start="932.7" data-end="936.25">and here's a look at what this looks</span> <span data-start="936.25" data-end="937.75">like it's very similar to the depth</span> <span data-start="937.75" data-end="939.79">system that I just showed you actually</span> <span data-start="939.79" data-end="942.1">so our production reports table is about</span> <span data-start="942.1" data-end="944.33">2 gigs in size</span> <span data-start="944.33" data-end="946.28">the production raw crashes table</span> <span data-start="946.28" data-end="949.94">containing all the JSON is about five</span> <span data-start="949.94" data-end="954.38">gigs so you know we I actually had</span> <span data-start="954.38" data-end="957.56">forecasted this out that it potentially</span> <span data-start="957.56" data-end="959.18">could be quite a bit larger we don't</span> <span data-start="959.18" data-end="962.42">know what size the crash object is going</span> <span data-start="962.42" data-end="963.65">to be ahead of time there's no way to</span> <span data-start="963.65" data-end="967.07">tell but you know I had suspected it</span> <span data-start="967.07" data-end="968.81">would be somewhere you know some</span> <span data-start="968.81" data-end="971.3">somewhere around here and so anyway so</span> <span data-start="971.3" data-end="972.56">we had to upgrade all our just to</span> <span data-start="972.56" data-end="974.39">support this but now we're we're pushing</span> <span data-start="974.39" data-end="977.36">somewhere around five gigs of raw JSON</span> <span data-start="977.36" data-end="979.1">into the database and we're going to</span> <span data-start="979.1" data-end="981.29">probably double that very shortly</span> <span data-start="981.29" data-end="983.24">because we actually have in addition to</span> <span data-start="983.24" data-end="985.13">the Rock crashes we have a processed</span> <span data-start="985.13" data-end="987.29">crash that has a little more metadata in</span> <span data-start="987.29" data-end="990.86">it that we're going to shove in there so</span> <span data-start="990.86" data-end="992.69">if you look at this the the comparison</span> <span data-start="992.69" data-end="997.13">here is you know JSON at 2k per crash</span> <span data-start="997.13" data-end="998.81">and then a normalized table would be</span> <span data-start="998.81" data-end="1003.19">somewhere about around 0.8 K so there's</span> <span data-start="1003.19" data-end="1004.63">there's a couple lessons from that like</span> <span data-start="1004.63" data-end="1006.25">one of course you know right we're we're</span> <span data-start="1006.25" data-end="1007.57">gonna burn some desk when we do this</span> <span data-start="1007.57" data-end="1010.51">it's also that you know good DBAs do you</span> <span data-start="1010.51" data-end="1012.61">actually save you some desk there's a</span> <span data-start="1012.61" data-end="1015.67">reason why we normalize the data but</span> <span data-start="1015.67" data-end="1017.65">when you're in a situation like we are</span> <span data-start="1017.65" data-end="1019.51">where we don't really know what kinds of</span> <span data-start="1019.51" data-end="1021.79">reports we want to run ahead of time</span> <span data-start="1021.79" data-end="1024.7">it's very useful to have immediate</span> <span data-start="1024.7" data-end="1027.88">access to that to that data which brings</span> <span data-start="1027.88" data-end="1029.47">me to what really is the killer</span> <span data-start="1029.47" data-end="1031.21">advantage of doing something like this</span> <span data-start="1031.21" data-end="1037.11">in Postgres as opposed to say HBase and</span> <span data-start="1037.11" data-end="1044.01">it really is this so I needed to look at</span> <span data-start="1044.01" data-end="1046.81">you know a single value we were we were</span> <span data-start="1046.81" data-end="1048.31">interested in the garbage collection and</span> <span data-start="1048.31" data-end="1050.83">you know is garbage collection running</span> <span data-start="1050.83" data-end="1054.88">when Firefox crashes and so I first</span> <span data-start="1054.88" data-end="1057.78">wrote a MapReduce you know we use a pig</span> <span data-start="1057.78" data-end="1059.77">and then there's another tool called</span> <span data-start="1059.77" data-end="1061.57">j-tube which is actually you can write</span> <span data-start="1061.57" data-end="1063.7">some Python and then run a MapReduce in</span> <span data-start="1063.7" data-end="1065.89">sage space so I so I wrote my initial</span> <span data-start="1065.89" data-end="1067.06">query and I was looking at about you</span> <span data-start="1067.06" data-end="1068.74">know a week to two weeks worth of data</span> <span data-start="1068.74" data-end="1072.25">and it literally took 30 minutes for me</span> <span data-start="1072.25" data-end="1074.92">to get all of that data transfer it you</span> <span data-start="1074.92" data-end="1076.63">know to the host system and then</span> <span data-start="1076.63" data-end="1078.19">process it into a report they would be</span> <span data-start="1078.19" data-end="1082.57">useful to somebody on Postgres took 24</span> <span data-start="1082.57" data-end="1086.68">seconds so that saves me you know my</span> <span data-start="1086.68" data-end="1089.32">time you know as a developer's finite</span> <span data-start="1089.32" data-end="1091.93">and if that's gonna save me 25 minutes</span> <span data-start="1091.93" data-end="1093.13">for every time I need to run an ad-hoc</span> <span data-start="1093.13" data-end="1095.44">report it's totally worth it to chew up</span> <span data-start="1095.44" data-end="1097.78">all the disk so that that's really been</span> <span data-start="1097.78" data-end="1101.53">my motivation to moving this into</span> </p>
<p><span data-start="1101.53" data-end="1103.72">Postgres we're still going to use HBase</span> <span data-start="1103.72" data-end="1107.65">for storing the we've got these these</span> <span data-start="1107.65" data-end="1111.13">dumps these binary dumps of data that</span> <span data-start="1111.13" data-end="1112.96">are a little bit large you know they can</span> <span data-start="1112.96" data-end="1114.7">be they can be quite large so we're not</span> <span data-start="1114.7" data-end="1116.02">going to store those and Postgres but</span> <span data-start="1116.02" data-end="1117.58">all the metadata all of the JSON that</span> <span data-start="1117.58" data-end="1119.74">we're storing we're just gonna pull pull</span> <span data-start="1119.74" data-end="1126.36">it all in in the in the coming weeks so</span> <span data-start="1126.36" data-end="1129.73">why would you use Postgres just to sum</span> <span data-start="1129.73" data-end="1133.24">up this stuff why would you use Postgres</span> <span data-start="1133.24" data-end="1136.99">to store your JSON and as opposed to a</span> <span data-start="1136.99" data-end="1140.59">new sequel system well I think the the</span> <span data-start="1140.59" data-end="1142.57">most compelling thing especially for</span> <span data-start="1142.57" data-end="1145.12">those of you who are running reporting</span> <span data-start="1145.12" data-end="1147.55">systems and doing visualizations of data</span> <span data-start="1147.55" data-end="1149.02">and I think there's you know there's</span> <span data-start="1149.02" data-end="1152.32">quite a bit of that going on right now I</span> <span data-start="1152.32" data-end="1154.24">like to call him I started calling this</span> <span data-start="1154.24" data-end="1156.49">bulk bag schema design it's something I</span> <span data-start="1156.49" data-end="1158.74">got from will lean Weber who got it from</span> <span data-start="1158.74" data-end="1161.41">some comedy podcasts but I think it it</span> <span data-start="1161.41" data-end="1163">really describes what you're trying to</span> <span data-start="1163" data-end="1165.33">do you just want to throw everything</span> <span data-start="1165.33" data-end="1168.49">into an unstructured data store</span> <span data-start="1168.49" data-end="1170.44">initially and then have the option to</span> <span data-start="1170.44" data-end="1173.32">optimize it over time initially</span> <span data-start="1173.32" data-end="1174.91">especially in the prototyping stage you</span> <span data-start="1174.91" data-end="1177.01">don't really know what your reports are</span> <span data-start="1177.01" data-end="1178.18">going to look like you don't really know</span> <span data-start="1178.18" data-end="1180.25">how you want the data to be stored and</span> <span data-start="1180.25" data-end="1182.32">that premature optimization I think is</span> <span data-start="1182.32" data-end="1186.7">is a silly and unnecessary hurdle to</span> <span data-start="1186.7" data-end="1192.58">develop it at this point in time</span> <span data-start="1192.59" data-end="1194.87">if you're using Postgres you're really</span> <span data-start="1194.87" data-end="1196.91">it's gonna be easy for you to scale to</span> <span data-start="1196.91" data-end="1200.45">multi terabyte database instances and</span> <span data-start="1200.45" data-end="1202.37">particularly for these these write and</span> <span data-start="1202.37" data-end="1203.9">read heavy loads having to do with</span> <span data-start="1203.9" data-end="1206.78">reporting like our workload is is mostly</span> <span data-start="1206.78" data-end="1209.96">right and Postgres does a really great</span> <span data-start="1209.96" data-end="1213.77">job of handling that my one caveat on</span> <span data-start="1213.77" data-end="1215.78">this is that if you're if you're scaling</span> <span data-start="1215.78" data-end="1217.88">to multi terabytes non cloud storage is</span> <span data-start="1217.88" data-end="1219.71">probably a better option particularly</span> <span data-start="1219.71" data-end="1221.45">for the reporting workloads there are</span> <span data-start="1221.45" data-end="1223.16">some great examples of people using the</span> <span data-start="1223.16" data-end="1225.77">cloud for with Postgres and I think</span> </p>
<p><span data-start="1225.77" data-end="1227.72">Instagram is probably the best example</span> <span data-start="1227.72" data-end="1229.61">of that and they've they've published a</span> <span data-start="1229.61" data-end="1231.29">few different talks about how they're</span> <span data-start="1231.29" data-end="1234.05">managing that but it is it is pretty</span> <span data-start="1234.05" data-end="1235.94">easy to scale these these individual</span> <span data-start="1235.94" data-end="1240.08">post rest instances to multiple</span> <span data-start="1240.08" data-end="1242.27">terabytes and finally I think</span> <span data-start="1242.27" data-end="1243.98">post-arrest is a really great option</span> <span data-start="1243.98" data-end="1245.99">because you can manage your data with</span> <span data-start="1245.99" data-end="1247.22">the language that you already know and</span> <span data-start="1247.22" data-end="1252.44">love which has not really always been an</span> <span data-start="1252.44" data-end="1256.25">option right previously people would you</span> <span data-start="1256.25" data-end="1257.3">know you'd either have to write raw</span> <span data-start="1257.3" data-end="1259.37">sequel or you would have to use a</span> <span data-start="1259.37" data-end="1262.97">language like peel PG SQL and I think</span> <span data-start="1262.97" data-end="1265.7">that being able to write JavaScript</span> <span data-start="1265.7" data-end="1267.56">inside the database makes it far more</span> <span data-start="1267.56" data-end="1269.87">maintainable I think it makes it a lot</span> <span data-start="1269.87" data-end="1271.55">more likely that the developers that I'm</span> <span data-start="1271.55" data-end="1273.47">working with will actually write data</span> <span data-start="1273.47" data-end="1277.4">processing code as opposed to leaving</span> <span data-start="1277.4" data-end="1280.73">that to the the database experts and</span> <span data-start="1280.73" data-end="1282.74">then also being able to put that code</span> <span data-start="1282.74" data-end="1284.36">right next to the data inside the</span> <span data-start="1284.36" data-end="1285.98">database makes it a lot more efficient</span> <span data-start="1285.98" data-end="1287.45">because you're not having to transfer it</span> <span data-start="1287.45" data-end="1292.78">over the network to process it</span> <span data-start="1292.79" data-end="1298.64">so like I said 9.3 beta it's out today</span> <span data-start="1298.64" data-end="1301.49">you can download it and play with it all</span> <span data-start="1301.49" data-end="1302.78">these tools that I was talking about</span> <span data-start="1302.78" data-end="1305.54">they're also available if if you want to</span> <span data-start="1305.54" data-end="1307.13">like create a developer instance in</span> </p>
<p><span data-start="1307.13" data-end="1309.47">Heroku you can play around with it and</span> <span data-start="1309.47" data-end="1313.1">it works really awesome and if you want</span> <span data-start="1313.1" data-end="1315.41">to know a little more about the types of</span> <span data-start="1315.41" data-end="1317.48">features I just listed like a bunch of</span> <span data-start="1317.48" data-end="1319.82">things here I'm not gonna like go into</span> <span data-start="1319.82" data-end="1320.9">you know all the cool things about</span> <span data-start="1320.9" data-end="1323.9">Postgres but I just ripped most of this</span> <span data-start="1323.9" data-end="1327.26">from a slide from from Craig there are</span> <span data-start="1327.26" data-end="1329.15">so many things about Postgres like I've</span> <span data-start="1329.15" data-end="1331.37">been talking with quite a few people</span> <span data-start="1331.37" data-end="1334.67">here at the conference about the JSON</span> <span data-start="1334.67" data-end="1336.29">data type and I've had more than one</span> <span data-start="1336.29" data-end="1337.97">person say why didn't you tell me about</span> <span data-start="1337.97" data-end="1341.57">this last year I have had to I've had to</span> </p>
<p><span data-start="1341.57" data-end="1343.4">I've had to build things in the last</span> <span data-start="1343.4" data-end="1344.78">year that really would have this this</span> <span data-start="1344.78" data-end="1346.31">really would have helped me out and I</span> <span data-start="1346.31" data-end="1348.29">think that Postgres actually has a lot</span> <span data-start="1348.29" data-end="1349.82">of those types of features where you're</span> <span data-start="1349.82" data-end="1351.44">like oh wow like that would be really</span> <span data-start="1351.44" data-end="1354.7">great but anyway I made a list here</span> <span data-start="1354.7" data-end="1356.9">definitely definitely check it out and</span> <span data-start="1356.9" data-end="1358.28">you know feel free to ask me questions</span> <span data-start="1358.28" data-end="1365.09">and so liberate your data let me let me</span> <span data-start="1365.09" data-end="1367">help you liberate your schema today</span> </p>
<p><span data-start="1367" data-end="1382.76">Thanks</span> </p>
</section>