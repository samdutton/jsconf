<section>
<p><span data-start="26.14" data-end="32.05">Hi everybody. This is JavaScript forensics. It's about your awesome</span> <span data-start="32.05" data-end="38.48">web-applications and how they completely fail for your end users. It's about diagnosing</span> <span data-start="38.48" data-end="45.07">and debugging production web-applications. In a lot of ways, we're still running in the</span> <span data-start="45.07" data-end="51.37">wild, wild web. There are dozens of tools we use to build our applications and we combine</span> <span data-start="51.37" data-end="57.71">that with all the different devices and browsers and plug-ins that our end users use when visiting</span> <span data-start="57.71" data-end="63.829">it, over a network we don't control and is often unpredictable, that leaves a lot of</span> <span data-start="63.829" data-end="70.99">room for JavaScript out laws, that's what we are going to talk about today. Five of</span> <span data-start="70.99" data-end="78.179">the most common JavaScript at laws that rage havoc on applications, we are going to look</span> <span data-start="78.179" data-end="85.03">at what information we can capture about them, how do we diagnose them and how do we fix</span> <span data-start="85.03" data-end="92.22">them. To do that we need to lure in the out laws, here is what we are going to do that,</span> <span data-start="92.22" data-end="101.159">it's a little app called soliloquy, any venture capitalists, get your cheques ready.</span> <span data-start="101.159" data-end="108.759">It's what I call Anand Vemuri social network, it's kind of like Twitter, it let's you type</span> <span data-start="108.759" data-end="116.39">in status up dates like Twitter , an awesome timeline of events like Twitter, awesome in</span> <span data-start="116.39" data-end="129.06">line adds like Twitter, some fantastic sponsors like cats, Hasselhoff, bears â€” \{Laughter\},</span> <span data-start="129.06" data-end="137.66">but it leaves off the most irritating part about Twitter, other people! \{Laughter\} .</span> </p>
<p><span data-start="137.66" data-end="144.06">Because with soliloquy, it's only about you, only you can write up dates only you can see</span> <span data-start="144.06" data-end="151.06">your up dates, obviously it's going to be huge, like next year, millions and millions</span> <span data-start="151.06" data-end="156.69">of dollars. So, I need to protect it, as I'm building it out this thing is going to be</span> <span data-start="156.69" data-end="162.43">big, I need to make sure my users have a great experience, I'm going to be watching how they</span> <span data-start="162.43" data-end="170.87">are reacting with t, to do that, a little application helped work on, track JS, a JavaScript</span> <span data-start="170.87" data-end="175.849">error monitoring tool, with that let's dig into the first errors.</span> <span data-start="175.849" data-end="185.4">Here are the first ones, scripty Jo, it comes in as script error, hiding the application</span> <span data-start="185.4" data-end="194.14">hard, it hits really hard in the first week I launched soliloquy, I had one 400 errors</span> <span data-start="194.14" data-end="204.909">coming in, it's not limited one thing, hitting everything. So let's look at it and debug</span> <span data-start="204.909" data-end="207.95">this ands' if we can understand what exactly is going on.</span> </p>
<p><span data-start="207.95" data-end="217.519">If we pop open the debugger console and start looking at this, when we load it we see two</span> <span data-start="217.519" data-end="223.849">errors in our console right away, we see we were able to record a message, script error,</span> <span data-start="223.849" data-end="228.53">but Chrome nicely can tell me all sorts of other information about it, the Chrome debugger</span> <span data-start="228.53" data-end="234.53">is independent of the constraints of a JavaScript execution environment, it can tell me real</span> <span data-start="234.53" data-end="240.64">information, programmatically, what I was able to capture from the browsing session</span> <span data-start="240.64" data-end="247.849">and pull back to my server to see the errors, is a very unhelpful message, "Script error",</span> <span data-start="247.849" data-end="255.15">with no file, no line, no column and no stack trace. That's hard, we don't even know where</span> <span data-start="255.15" data-end="261.039">to start with this, it's like something blew up swear, we don't know how. How did this</span> <span data-start="261.039" data-end="267.789">come to exist? Chrome nicely told us that this, the real error involved here this reference</span> <span data-start="267.789" data-end="273.53">error from side bar add provider. However, I want to be able to know what the real errors</span> <span data-start="273.53" data-end="278.72">are when we are interacting with this, let's look at the side bar add provider.</span> <span data-start="278.72" data-end="283.33">What's interesting about this, it's not necessarily what is in this script, but where it comes</span> <span data-start="283.33" data-end="292.099">from. The side bar add provider is being loaded from adds.local, if you see in the very small</span> <span data-start="292.099" data-end="299.789">upper corner, it's being loaded from local host, it's being served from a different domain</span> <span data-start="299.789" data-end="304.71">and now subject to the same original policy protections on the browser.</span> </p>
<p><span data-start="304.71" data-end="311.539">In the last presentation we learned about calls for posting requests to different end</span> <span data-start="311.539" data-end="316.89">points, we can apply some of the same things here, so because we are loading the side bar</span> <span data-start="316.89" data-end="321.86">add provider from a different domain the browser is saying, "Hey, I don't trust that", so when</span> <span data-start="321.86" data-end="334.589">it blows up it obfuscates the error. It trusts it enough to get the error message, to do</span> <span data-start="334.589" data-end="341.38">that we need to serve the add bar side provider with the errors. If we look at how it's getting</span> <span data-start="341.38" data-end="350.159">served.. I've already added these from my advertising provider has already added to</span> <span data-start="350.159" data-end="355.649">these to the network and the script server says it can be loaded from anywhere with the</span> <span data-start="355.649" data-end="367.86">wild card, I now need to teach Chrome, load it and give the same policy. Let's a look</span> <span data-start="367.86" data-end="374.789">at the code and see how it works, here's the main document, I trust everybody had their</span> <span data-start="374.789" data-end="380.64">NDAs in order.</span> <span data-start="380.64" data-end="385.25">Here at the bottom is where I'm loading all of my JavaScript, here's the side bar add</span> <span data-start="385.25" data-end="393.39">provider, here's the very last one, adding from ASDA local, none of my scripts are coming</span> <span data-start="393.39" data-end="399.349">from my origin, none of them are coming from local host, I'm letting my scripts from a</span> </p>
<p><span data-start="399.349" data-end="408.33">CDN to improve performance and so this is going to be a problem persuasive across my</span> <span data-start="408.33" data-end="413.88">application. So I can teach the browser that I want to go ahead and trust all of these</span> <span data-start="413.88" data-end="418.69">scripts, as long as those scripts are served with the cross origin headers we can get rid</span> <span data-start="418.69" data-end="425.36">of this error, so we can decorate the script elements with the attribute cross origin and</span> <span data-start="425.36" data-end="434.839">it will tell newer browsers to go ahead and look for the CORS errors.</span> <span data-start="434.839" data-end="446.02">You will see that we actually haven't fixed the error yet, but we have allowed us to do</span> <span data-start="446.02" data-end="451.849">is capture real information about this JavaScript error. Now, what ever we are able to pull</span> <span data-start="451.849" data-end="456.909">out from our real browser sessions has real information that we can use to aggregate and</span> <span data-start="456.909" data-end="464.18">analyse our data, we can see that this was a uncaught error, from my side bar add provider</span> <span data-start="464.18" data-end="470.7">with a full stack trace, now we dent have to deal with script error any more.</span> </p>
<p><span data-start="470.7" data-end="478.029">So this was scripty Jo, it's browser obfuscation you well have to deal with this right away</span> <span data-start="478.029" data-end="488.37">if you track client side errors, if you load some of the CTN, it conceals all the real</span> <span data-start="488.37" data-end="493.539">problems your application has, now we have this one out of the way, let's move on to</span> <span data-start="493.539" data-end="501.969">another one. Jane Adsy, the actual underlying area, the get random adds is not defined.</span> <span data-start="501.969" data-end="508.19">What's odd about Jane Adsy, I didn't change soliloquy, it has been stable, I didn't want</span> <span data-start="508.19" data-end="515.12">to change it before the conference, all of a Sutton yesterday it blew up, no change from</span> <span data-start="515.12" data-end="522.25">me at all, I had tonnes and tonnes of errors, I don't know how that could be. So let's take</span> <span data-start="522.25" data-end="531.82">a look at it again and see if we can figure out what happened: we see the uncaught reference,</span> <span data-start="531.82" data-end="537.13">get random add is not defined, we can navigate directly to the file and take a look at what's</span> <span data-start="537.13" data-end="538.23">going on.</span> </p>
<p><span data-start="538.23" data-end="545.21">So this, again, is from my third party, I do not own this script I just bring it in</span> <span data-start="545.21" data-end="550.26">because I pay the side bar add provider, or they pay me to place</span> <span data-start="550.26" data-end="556.3">adds on their site, or my site. So they are serving this JavaScript that's calling function,</span> <span data-start="556.3" data-end="563.1">get random add and it's not there. If we look around in the file we see that there is another</span> <span data-start="563.1" data-end="569.84">function a bit further down, called get random adds, maybe somebody dropped an s, when they</span> <span data-start="569.84" data-end="572.36">were trying to save a file.</span> <span data-start="572.36" data-end="578">Could be we just had a fat finger situation with the advertising provider, when we bring</span> <span data-start="578" data-end="584.2">up a local copy we see that there is these two calls to get random add, although it doesn't</span> <span data-start="584.2" data-end="590.99">exist. If we pull a local copy of this file and save it without the stray character in</span> <span data-start="590.99" data-end="600.89">it.. check-out all the awesome new adds that I now have on it, for more bears, bacon and</span> <span data-start="600.89" data-end="605.19">Hasselhoff.</span> <span data-start="605.19" data-end="611.44">So Jane third party adsy, can cause errors in your application any time you bring in</span> <span data-start="611.44" data-end="616.06">a third party. This is something we don't often recognise, we're usually just trying</span> <span data-start="616.06" data-end="621.88">to build the software we are trying to build for are customers, we bring in social networks,</span> <span data-start="621.88" data-end="627.7">advertising, payment processors, all kinds of really valuable third party tools but we</span> <span data-start="627.7" data-end="633.24">are giving them the ability to run JavaScript on our application and sometimes to change</span> <span data-start="633.24" data-end="638.69">the JavaScript without telling us, it can cause all kinds of uncontrolled changes in</span> <span data-start="638.69" data-end="640.7">your environment.</span> </p>
<p><span data-start="640.7" data-end="649.93">So, the next error is Susan scopes, it's cannot read property destroy of , a major</span> <span data-start="649.93" data-end="656.92">global error not happening to everybody, we see a strong correlation, every time a user</span> <span data-start="656.92" data-end="662.21">is trying to delete something out of their timeline we see we get this error in the console,</span> <span data-start="662.21" data-end="667.34">or we get this error reported shortly thereafter. We can take a look at it again and receive</span> <span data-start="667.34" data-end="670.73">we can recreate the situation.</span> <span data-start="670.73" data-end="676.34">So the error report that we get is that the user tries to delete one of the statements</span> <span data-start="676.34" data-end="679.02">and they can't, it loads up for them.</span> </p>
<p><span data-start="679.02" data-end="692.33">So, let's open our console back up, we will try to delete the statement, we saw console</span> <span data-start="692.33" data-end="696.71">messages printed out saying trying to delete the statement. Then we recorded, "Cannot read</span> <span data-start="696.71" data-end="705.13">property, destroy of ", just like we saw in the tool. Chrome nicely reported</span> <span data-start="705.13" data-end="711.26">as well, it's telling us this is coming from statement ujs line 30, let's gig into a little</span> <span data-start="711.26" data-end="718.71">bit more, pop over the stack trace there, it's awesome, there was an anonymous function</span> <span data-start="718.71" data-end="726.03">on that line, something blew up there, we don't really have any context. So Chrome,</span> <span data-start="726.03" data-end="731.01">about six or eight months ago, shipped a really cool thing that's probably my favourite thing</span> <span data-start="731.01" data-end="737.529">they have ever done, it's this little check box right here in the 'Sources' tab, it's</span> <span data-start="737.529" data-end="742.42">hidden away and you wouldn't notice it if you didn't look for it, if you turn it on,</span> <span data-start="742.42" data-end="748.8">it will let us get over the big stack trace limitation in JavaScript, because JavaScript</span> <span data-start="748.8" data-end="756.13">is async and is usually responding to an event, the step trace can only go back to the place</span> <span data-start="756.13" data-end="762.04">where that event started, I don't know what attached that click handler, or started that,</span> <span data-start="762.04" data-end="773.12">or created an AJAX fault, I know what it up, Chrome has access â€” so if we turn this on</span> <span data-start="773.12" data-end="782.3">and reload, let's go ahead and delete another statement, blew up again, just like we expected.</span> </p>
<p><span data-start="782.3" data-end="788.04">Now if we check-out the stack trace, there is all kinds or more awesomeness here, anonymous</span> <span data-start="788.04" data-end="795.21">function on statement view line 30, but that was passed to a set Time Out, it was called</span> <span data-start="795.21" data-end="800.5">by a function called 'On delete', called in response to jquery events that seems to make</span> <span data-start="800.5" data-end="801.32">sense with the actions</span> <span data-start="801.32" data-end="806.98">I took, I clicked the button, vent thrown, caught it on delete, then passing into set</span> <span data-start="806.98" data-end="817.2">Time Out, let's look at statement of UJS and see what's happening.</span> <span data-start="817.2" data-end="825.47">Here's line 30, of are on delete, right away here's the code smell, it's we're passing</span> <span data-start="825.47" data-end="831.66">functional argument in and using the word, "This",. This is obviously the most common</span> <span data-start="831.66" data-end="838.85">error that we all seem to make over hand over and over again, parsing a value when it's</span> <span data-start="838.85" data-end="846.71">going to change context over it's lifetime. There is a couple of ways to fix this, the</span> <span data-start="846.71" data-end="852.92">comment, the most obvious ones are either var that = this, or var self = this. Which,</span> <span data-start="852.92" data-end="858.19">you know, depends on which JavaScript book you read first is your preference! \{Laughter\}</span> <span data-start="858.19" data-end="862.839">It might be a little bit more obvious because we're only doing this one thing, it's to say</span> <span data-start="862.839" data-end="871.16">var model equals this.model and simple reference it as model. Or if we want to be super cool</span> <span data-start="871.16" data-end="881.41">and hip, we could use the new ways of doing things and use a bind, and chain.bind this</span> <span data-start="881.41" data-end="886.27">to the end of that function. Which will glue the value of this from the outer context into</span> <span data-start="886.27" data-end="891.72">the value of this on the inner context. Thatâ€™s pretty cool, except it won't work quite everywhere.</span> </p>
<p><span data-start="891.72" data-end="897.68">I want Soliloquy to be super compatible. So instead of doing that maybe I will use a utility.</span> <span data-start="897.68" data-end="904.47">I will bring in underscore, low dash or whatever your preference is there and use it's bind</span> <span data-start="904.47" data-end="909.56">method to tie the 2 together. This will be super compatible it will let me go back all</span> <span data-start="909.56" data-end="913.25">the way to IE 8 or 7 support for it.</span> </p>
<p><span data-start="913.25" data-end="919.56">Now we have actually bound up this thing together we can try to delete stuff again. Now we can</span> <span data-start="919.56" data-end="928.4">delete to our hearts content. Awesome.</span> <span data-start="928.4" data-end="937.16">So, the Susan, this and that Scopes happens any time we get a functional argument and</span> <span data-start="937.16" data-end="942.47">usually manifest itself as something is not defined. This will happen any time you are</span> <span data-start="942.47" data-end="946.92">using youâ€™re parsing a functional argument in, either using call backs or promises or</span> <span data-start="946.92" data-end="952.24">anything like that. Now typically you could find these sorts of errors before they made</span> <span data-start="952.24" data-end="956.13">it out into your production environment, there is a finite set of things that can go wrong</span> <span data-start="956.13" data-end="961.58">here. However JavaScript apps once they reach a certain size get difficult to test every</span> <span data-start="961.58" data-end="967.05">possible condition. I still see this in production a whole lot.</span> <span data-start="967.05" data-end="975.529">All right. Logan No Loadâ€™em. Inline ads it's not a function. So we saw this error</span> <span data-start="975.529" data-end="982.38">start coming up. It doesn't happen to everybody, but it happens to a lot of people. We saw</span> <span data-start="982.38" data-end="992.589">Soliloquy gets 2500 hits a week but we see about 130 people encounter this error, this</span> <span data-start="992.589" data-end="998.18">a.inline ads is not a function. So it's not everybody, it always seems to happen like</span> <span data-start="998.18" data-end="1004.72">right away when it does happen so let's see if we can understand why that would exist.</span> <span data-start="1004.72" data-end="1013.17">So let's pop back into Soliloquy. So when I just load my app, it obviously is not throwing</span> <span data-start="1013.17" data-end="1019.529">that error. Doesn't happen for me here on this network. So let's look in our code for</span> <span data-start="1019.529" data-end="1027.22">where is inline ads even being defined. If we search Soliloquy for inline ads. There's</span> <span data-start="1027.22" data-end="1033.439">2 places, the first is in the inline ad provider. The inline ad provider is another advertising</span> <span data-start="1033.439" data-end="1040.309">network I use to make some money for Soliloquy it defines this API, the window.inline ads</span> <span data-start="1040.309" data-end="1046.63">will be a function that I will pass stuff into. There in my main function, my main initialisation</span> </p>
<p><span data-start="1046.63" data-end="1052.59">I try to set up my ads Soliloquy I use the API they define for me this window.inline</span> <span data-start="1052.59" data-end="1057.87">ads I pass in this information about what I want.</span> <span data-start="1057.87" data-end="1064.57">So it should never be , window.inline ads it's called here inside of a ready function,</span> <span data-start="1064.57" data-end="1070.46">we're waiting until the DOM is done, and the inline ad provider is loaded here just directly</span> <span data-start="1070.46" data-end="1078.77">from a script, so I cannot imagine why this wouldn't work. We load it doesn't happen.</span> <span data-start="1078.77" data-end="1085.16">So, let's see what would it manifest itself if it didn't load. Let just comment this out.</span> <span data-start="1085.16" data-end="1092.1">Let's say hey maybe somebody is striping that out. Here's definitely the error we're seeing</span> <span data-start="1092.1" data-end="1098.23">reported. A.inline ads is into the function, but look at the experience that my end user</span> <span data-start="1098.23" data-end="1103.71">got when they encountered this problem. It's not just like the inline ads didn't load,</span> <span data-start="1103.71" data-end="1109.64">this nothing loaded. The status list didn't load the inline ads, the sidebar ads didn't</span> <span data-start="1109.64" data-end="1120.46">load if they try and type a message, it just fails. The app is completely broken for them</span> <span data-start="1120.46" data-end="1122.8">when this issue happens to happen.</span> </p>
<p><span data-start="1122.8" data-end="1129.309">So looking into this, this was one of the things that surprised me most understanding</span> <span data-start="1129.309" data-end="1140.89">production JavaScript debugging is that sometimes due to craziness of online networks, one script</span> <span data-start="1140.89" data-end="1146.28">will fail to load in your application. Just one. Maybe it's DNS look up failed because</span> <span data-start="1146.28" data-end="1153.429">you are changing cell networks, or maybe they had a blip in their CDN, and so we have seen</span> <span data-start="1153.429" data-end="1157.79">numerous cases where a single script in your application fails to load and so depending</span> <span data-start="1157.79" data-end="1163.11">on what script that is, it can vastly, you can end up in a vastly different situation</span> <span data-start="1163.11" data-end="1171.92">in the case of Soliloquy catastrophic this app failed to load entirely, maybe you are</span> <span data-start="1171.92" data-end="1177.51">bringing in a payment processor, PayPal or Braintree to do your work. What if their script</span> <span data-start="1177.51" data-end="1182.52">fails to load because of a network blip? What state does that leave your credit card form</span> <span data-start="1182.52" data-end="1188.67">in when their script just is not on the page? So here in my code in Soliloquy, I wasn't</span> <span data-start="1188.67" data-end="1193.13">being very safe and recognising that this situation could happen. Because I am just</span> <span data-start="1193.13" data-end="1200.679">calling window.online ads directly as my main execution. So when this doesn't exist, it</span> <span data-start="1200.679" data-end="1206.429">stops, set up ads doesn't work, sidebar ad fails to work, when we return from set up</span> <span data-start="1206.429" data-end="1212.5">ads I never fetch my main statement list, I never do the main things as part of Soliloquy.</span> </p>
<p><span data-start="1212.5" data-end="1217.2">So what we need to do is we need to be more cautious about the APIs that we use before</span> <span data-start="1217.2" data-end="1221.78">we use them. Just because it's the script is supposed to be there doesn't mean it will</span> <span data-start="1221.78" data-end="1228.33">always be there. So we can do this real simple, just a check. Let's see if window.inline ads</span> <span data-start="1228.33" data-end="1234.809">is a thing before we use, if it's a thing we'll go ahead and call it.</span> <span data-start="1234.809" data-end="1244.22">If it's not a thing, maybe we should log something. We should a complaint to our inline ad provider</span> <span data-start="1244.22" data-end="1252.97">see if we can get a discount next time.</span> <span data-start="1252.97" data-end="1258.37">So now the real simple check in place, the experience from my end user is much better,</span> <span data-start="1258.37" data-end="1262.92">it's still not great for me because I am not getting impressions on this ad, my inline</span> <span data-start="1262.92" data-end="1267.33">ads are not there but the end user doesn't really notice. Would you really notice if</span> </p>
<p><span data-start="1267.33" data-end="1275.11">Twitter loaded and there weren't any inline ads anymore?</span> <span data-start="1275.11" data-end="1281.679">So Logan, missing script. This happens all kinds of reason, flaky networks, poor network</span> <span data-start="1281.679" data-end="1286.929">infrastructure, maybe a new deployment is happening right when a request is being made.</span> <span data-start="1286.929" data-end="1295">There are infinite edge cases here that can cause a script to fell to load on the internet.</span> <span data-start="1295" data-end="1300.08">As you are bringing in scripts, third parties, always verify the script exist successfully</span> <span data-start="1300.08" data-end="1304.48">before you use it the wise an error will cause a catastrophic change that will stop all future</span> <span data-start="1304.48" data-end="1305.52">execution.</span> </p>
<p><span data-start="1305.52" data-end="1315.429">This is the error I will talk about today this my browser crashing. My browser crashing</span> <span data-start="1315.429" data-end="1322.99">happens we're seeing reports of slowing performance of Soliloquy. narcissistically writing all</span> <span data-start="1322.99" data-end="1330.9">their thoughts into soliloquy, after hours of typing they tell us their browser has crashed.</span> <span data-start="1330.9" data-end="1336.96">There's no good way to record the browser crashed in JavaScript, because the browser</span> <span data-start="1336.96" data-end="1343.65">crashed. So we can't really get an AJAX call out the door before it crashes. So we have</span> <span data-start="1343.65" data-end="1348.309">to rely on the old school way of figuring out your reports, people complaining on the</span> <span data-start="1348.309" data-end="1354.19">internet. The worse is they are complaining probably on Twitter which is the thing we're</span> <span data-start="1354.19" data-end="1356.26">trying to get rid off.</span> <span data-start="1356.26" data-end="1365.77">Let take a look at Soliloquy, see if we can identify why this happens, slowing performance</span> <span data-start="1365.77" data-end="1373.64">crashing the browser. Sounds like maybe we have a memory leak, let's look to see if we</span> <span data-start="1373.64" data-end="1379.49">have a memory leak. Oh let's fix our inline ads provider, probably want that loading again.</span> <span data-start="1379.49" data-end="1388.64">So we're going to check out a memory leak. There's a couple of different ways we can</span> <span data-start="1388.64" data-end="1396.049">too this my personal favourite is to check out the timeline. Now the timeline is one</span> <span data-start="1396.049" data-end="1402.54">of the newer tools in the Chrome debugger, and it let's us capture all kinds of interesting</span> <span data-start="1402.54" data-end="1407.96">state changes as our application is running. So what I am going to do here I am going to</span> <span data-start="1407.96" data-end="1412.549">type a few status into Soliloquy, then I will delete them back out which will hopefully</span> <span data-start="1412.549" data-end="1418.9">return me to same state my application was in before. Hopefully, the same level of memory</span> <span data-start="1418.9" data-end="1422.299">utilisation and if it doesn't, that could indicate a leak.</span> </p>
<p><span data-start="1422.299" data-end="1429.66">So I am going to go ahead and start recording here. I am going to type in some messages.</span> <span data-start="1429.66" data-end="1435.96">Soliloquy also has this awesome â€˜I am feeling randomâ€™ button which will generate a random</span> <span data-start="1435.96" data-end="1443.26">series of characters an stick it in. It's great for the creativity. So I created 3 I</span> <span data-start="1443.26" data-end="1448.62">will delete these 3 back out.</span> <span data-start="1448.62" data-end="1461.72">Then let's take a look and what we captured. All right so there's a lot going on here.</span> <span data-start="1461.72" data-end="1468.309">There's a lot going on here. It's hard to know where to start. So, I like to start down</span> <span data-start="1468.309" data-end="1475.47">here in this main thread where we see in blue the total amount of JavaScript memory that's</span> <span data-start="1475.47" data-end="1482.08">being used and in orange, golden rod whatever , the total number of JavaScript listeners.</span> </p>
<p><span data-start="1482.08" data-end="1487.99">And we see ingredient number of nodes. If we just look at those things, we see a pattern</span> <span data-start="1487.99" data-end="1493.86">happening here. It's here at the beginning we see it a tick up in all 3, and tick us</span> <span data-start="1493.86" data-end="1499.38">up again, and again, and again, it looks like we clean a little bit up, then it keeps going</span> <span data-start="1499.38" data-end="1504.58">right back up. At no point did we back out, at no point did we really clean up back to</span> <span data-start="1504.58" data-end="1506.57">our original state.</span> <span data-start="1506.57" data-end="1511.1">So this is not really enough to go off of, so we need to understand a little bit more.</span> <span data-start="1511.1" data-end="1515.07">So what we're going to do is before I really figured out how to become productive with</span> <span data-start="1515.07" data-end="1519.69">my life, I spent a lot of time playing video games particularly old Counterstrike. We're</span> <span data-start="1519.69" data-end="1528">going to use classic Counterstrike controls to fly into this chart and understand more</span> <span data-start="1528" data-end="1533.98">what happens so yet just WSAD, standard first person shooter controls, we'll start flying</span> <span data-start="1533.98" data-end="1540.69">into these different reports we can start seeing some information about them.</span> <span data-start="1540.69" data-end="1550.13">So, as we get closer, we see that this step is not one thing, but several little things.</span> <span data-start="1550.13" data-end="1554.33">We can strafe round here we can just left, right make sure we dodging and weaving, make</span> <span data-start="1554.33" data-end="1557.11">sure the memory leaking bullets are not</span> <span data-start="1557.11" data-end="1570.53">hitting us. That's not the one I want either. We will have to strafe again. Here is an interesting</span> <span data-start="1570.53" data-end="1573.2">one, there we go that's the one I want.</span> </p>
<p><span data-start="1573.2" data-end="1578.01">So now we're going to fly in here even closer, we're going to see more sufficient about here</span> <span data-start="1578.01" data-end="1583.679">and as we dig in we can start seeing really good detail about the timeline and what's</span> <span data-start="1583.679" data-end="1588.64">actually happening, causing these changes in memory leaks in documents. We see that</span> <span data-start="1588.64" data-end="1597.75">this call is stemming from a timer in sidebarAdProvider that's causing a memory to tick up, and again,</span> <span data-start="1597.75" data-end="1602.54">a timer in a sidebarAdProvider causing a memory to tick up. This is giving us a good invitation</span> <span data-start="1602.54" data-end="1605.94">of where our memory leak might be.</span> </p>
<p><span data-start="1605.94" data-end="1612.26">So if we take a look at the sidebarAdProvider, we can see how it works. It's calling set</span> <span data-start="1612.26" data-end="1616.86">interval, on an interval we're clearing out our advertising container we're just zeroing</span> <span data-start="1616.86" data-end="1624.88">out the contents of it then it's get a random ad from the advertising server, places it</span> <span data-start="1624.88" data-end="1629.49">with this function here. Placing it just amounts to it goes out gets the HTML text it needs</span> <span data-start="1629.49" data-end="1635.58">forward when it's got it, it sticks it in the container and binds a click event, but</span> <span data-start="1635.58" data-end="1641.66">here's our root issue. Because we're just dynamically creating an element and attaching</span> <span data-start="1641.66" data-end="1652.04">an event to it, at no point are we ever removing that click handler. So we're getting hundreds</span> <span data-start="1652.04" data-end="1657.669">and hundreds of thousands and thousands of these elements hanging out in the DOM waiting</span> <span data-start="1657.669" data-end="1662.26">for you to click on them, even though they are not visible anymore. Because at no point</span> <span data-start="1662.26" data-end="1669.13">was the execution or was this event ever detached. So we can see this happening if we just look</span> <span data-start="1669.13" data-end="1675.4">at Soliloquy, we see this sidebar going off. Every few seconds it refreshes and puts new</span> <span data-start="1675.4" data-end="1681.429">ads there. The old ads are still on the page. Another way of thinking about that over the</span> <span data-start="1681.429" data-end="1688.03">course of a couple of hours of using Soliloquy there could be literally millions of David</span> <span data-start="1688.03" data-end="1694.539">Hasselhoffs hanging out on your page waiting for you to click on them. \{laughter\}</span> <span data-start="1694.539" data-end="1702.21">So my browser crashing the most common source of these are memory leaks caused by detached</span> <span data-start="1702.21" data-end="1708.98">DOM elements. You get elements in the DOM and attached a listener to if you don't detach</span> <span data-start="1708.98" data-end="1715.309">the listener when you poll them back out it can slowly inflate the size of the browser's</span> <span data-start="1715.309" data-end="1719.7">memory over time. Which is particularly trouble some if you have a long lived application</span> <span data-start="1719.7" data-end="1722.78">like Soliloquy.</span> </p>
<p><span data-start="1722.78" data-end="1728.72">So these were the 5 JavaScript outlaws that we tracked down today. Script error is browser</span> <span data-start="1728.72" data-end="1734.44">opportunities obsfuscation it's the first thing you need to track, every time you bring</span> <span data-start="1734.44" data-end="1739.84">in a third party script you are introducing risk they can change with your control. Context</span> <span data-start="1739.84" data-end="1747.24">errors is the most common logical thing passing the value of this will change. Loading errors</span> <span data-start="1747.24" data-end="1753.26">because sometimes one of your scripts will fail to load, causing unique failure conditions</span> <span data-start="1753.26" data-end="1758.59">in your application. Finally, memory errors we are leaking DOM or elements are created</span> <span data-start="1758.59" data-end="1764.48">dynamically. So all of these errors we capture with a little bit of help from this other</span> <span data-start="1764.48" data-end="1769.929">project I work on called track.js. If you are interested in that check that out, this</span> <span data-start="1769.929" data-end="1774.53">was JavaScript forensic, I was your sheriff @toddhgardner on Twitter if you use that</span> </p>
</section>