<section>
<p><span data-start="9.429" data-end="10.429">Wow.</span> <span data-start="10.429" data-end="12.84">I mean, thank you by the way to JSConf EU for having me here.</span> <span data-start="12.84" data-end="19.81">It's an absolute privilege to be at the last JSConf EU of its time.</span> <span data-start="19.81" data-end="22.27">Can you guys give it up for JSConf EU?</span> <span data-start="22.27" data-end="25.45">I can't believe it.</span> <span data-start="25.45" data-end="26.45">[Applause].</span> </p>
<p><span data-start="26.45" data-end="27.45">I cannot believe it.</span> <span data-start="27.45" data-end="32.5">So, you know, biggest JavaScript conference in Europe, I think biggest JavaScript conference</span> <span data-start="32.5" data-end="33.5">in the world.</span> <span data-start="33.5" data-end="37.5">Going to be talking about building a JS engine.</span> <span data-start="37.5" data-end="38.579">No pressure at all!</span> </p>
<p><span data-start="38.579" data-end="40.01">It will be completely fine!</span> <span data-start="40.01" data-end="41.14">I should probably introduce myself.</span> <span data-start="41.14" data-end="42.14">I'm Jason Williams.</span> <span data-start="42.14" data-end="49.78">I'm a senior software engineer at Bloomberg in the UK in London, dare I say Europe?</span> <span data-start="49.78" data-end="53">We're still clinging on.</span> <span data-start="53" data-end="57.23">I used to work at the BBC as well.</span> <span data-start="57.23" data-end="59.19">Are there BBC people?</span> </p>
<p><span data-start="59.19" data-end="60.19">Here?</span> <span data-start="60.19" data-end="62.129">Yes, wow!</span> <span data-start="62.129" data-end="68.97">I've also been involved in sort of TC39, so I've been working on the proposal over the</span> <span data-start="68.97" data-end="74.601">past year which allows you to get on board all of your promises, regardless of the state</span> <span data-start="74.601" data-end="81.81">whether fulfilled or rejected, and you have control then to do what you want with them.</span> <span data-start="81.81" data-end="84.56">On the Rust side, I've also been involved in Rust as well.</span> <span data-start="84.56" data-end="88.77">I used to be the maintainer of the Sublime Text Rust plugin.</span> <span data-start="88.77" data-end="98.38">I've since moved into the Rust DevTools team, and they focus on sort of ID plugins, tooling,</span> <span data-start="98.38" data-end="101.86">and then the Rust language server as well which is pretty cool which is a single process</span> <span data-start="101.86" data-end="107.5">that handles things like debugging, hinting, and all the editors can make use of that.</span> </p>
<p><span data-start="107.5" data-end="113.45">So I thought doing some specifications with JavaScript, really interesting, you know,</span> <span data-start="113.45" data-end="118.14">working a little bit on Rust as well, my two favourite things, how can I marry these two</span> <span data-start="118.14" data-end="121.84">things together?</span> <span data-start="121.84" data-end="124.09">My two languages that I love so much?</span> <span data-start="124.09" data-end="125.57">How can I bring these together?</span> <span data-start="125.57" data-end="129.59">And by the way, the biggest JavaScript conference in the world, I know it's a ballsy move talking</span> <span data-start="129.59" data-end="131.65">about Rust, but I'm going to go with it.</span> <span data-start="131.65" data-end="133.65">Bear with me.</span> </p>
<p><span data-start="133.65" data-end="137.919">I thought why not build a JavaScript engine written in Rust?</span> <span data-start="137.919" data-end="144.93">Take the fun and accessibility of JavaScript and then power that with Rust, and then see</span> <span data-start="144.93" data-end="147.26">what we can get?</span> <span data-start="147.26" data-end="148.959">It was a bit ambitious.</span> <span data-start="148.959" data-end="150.68">It was quite checking.</span> <span data-start="150.68" data-end="156.209">I actually started off by looking for a place where I could contribute to this.</span> <span data-start="156.209" data-end="160.15">Nowhere existed, like no-one had built one in Rust before, at least two years ago, anyway.</span> <span data-start="160.15" data-end="168.169">There was one single project called js.rs, and the maintainer abandoned it.</span> <span data-start="168.169" data-end="170.2">It was six years old.</span> <span data-start="170.2" data-end="175.26">I tried to build it, and there were 650 errors.</span> <span data-start="175.26" data-end="181.239">It was basically because he made it at a time when Rust wasn't 1.0 and so the syntax had</span> <span data-start="181.239" data-end="187.419">changed and moved on, and it was faster to build one from scratch than it was to try</span> <span data-start="187.419" data-end="189.319">and get this working.</span> <span data-start="189.319" data-end="191.699">That's exactly what I did.</span> <span data-start="191.699" data-end="196.78">I'm not an expert by the way in parsing, or writing compilers, or any of that.</span> <span data-start="196.78" data-end="201.499">I mean, I even struggle to read CSS in the morning, so I'm not an expert in parsing source</span> <span data-start="201.499" data-end="203.779">code, so I thought let's start from somewhere.</span> </p>
<p><span data-start="203.779" data-end="205.879">I thought it was a jump.</span> <span data-start="205.879" data-end="212.769">Doing small things in Rust, and going from like "hello, world" to full-on JavaScript</span> <span data-start="212.769" data-end="214.629">interpreter was probably a bit of a jump.</span> <span data-start="214.629" data-end="221.62">I probably should have done something in between like a to-do MVC, or something like that.</span> </p>
<p><span data-start="221.62" data-end="225.319">I knew I was on to something here that I had a good language, something to work with.</span> <span data-start="225.319" data-end="229.36">There were a couple of reasons that I wanted to use Rust to build this engine.</span> <span data-start="229.36" data-end="231.479">One was control.</span> <span data-start="231.479" data-end="235.23">One of the things Rust says to you we're going to give you the control you can have plus</span> <span data-start="235.23" data-end="237.219">all the safety.</span> </p>
<p><span data-start="237.219" data-end="243.26">And so I can utilise a sort of close to the metalness of Rust and do the things I need</span> <span data-start="243.26" data-end="247.609">to do, and then the compile time means I don't fall over myself.</span> <span data-start="247.609" data-end="256.01">It was quite fast, so it is built on top of LOVM which means the years of the LOVM compiler</span> <span data-start="256.01" data-end="259.289">they've done, Rust can tap into that and make use of it.</span> <span data-start="259.289" data-end="268.68">Sometimes, you can get faster CodeGen which produces C. There's memory safety as well.</span> <span data-start="268.68" data-end="271.439">Rust has an ownership system which is quite unique.</span> <span data-start="271.439" data-end="276.43">Basically, if you were passing a value into a function, the function is now the owner</span> <span data-start="276.43" data-end="280.419">of that value, so there can only be one owner to a value.</span> <span data-start="280.419" data-end="284.57">That means when Rust wants to get rid of data it can do so with 100 per cent confidence</span> <span data-start="284.57" data-end="287.26">because nothing else is pointing to that thing.</span> </p>
<p><span data-start="287.26" data-end="290.699">You don't have dangling pointers, or anything like that.</span> <span data-start="290.699" data-end="297.37">Currency, I might want to make use of this at some point.</span> <span data-start="297.37" data-end="302.509">Again, because of the ownership model, I won't have to worry too much about multiple threads,</span> <span data-start="302.509" data-end="306.28">trying to access the same value, and then what I need to worry about data races.</span> <span data-start="306.28" data-end="311.699">All of that is taken care of at compile time which means at run time, I'm not penalised</span> <span data-start="311.699" data-end="312.9">on performance.</span> </p>
<p><span data-start="312.9" data-end="317.55">So, yes I thought it's a good start.</span> <span data-start="317.55" data-end="319.569">Let's get going.</span> <span data-start="319.569" data-end="320.569">So I started.</span> <span data-start="320.569" data-end="325.479">About two years ago, I started, I made a Git Repo, an engine called Boa.</span> <span data-start="325.479" data-end="329.02">Someone asked me why I called that?</span> <span data-start="329.02" data-end="330.81">An evil boa in a zoo in Australia.</span> <span data-start="330.81" data-end="333.689">I thought I'm naming my engine after that.</span> <span data-start="333.689" data-end="338.889">I'm going to start with a high-level view here.</span> <span data-start="338.889" data-end="344.01">So the architecture that I'm going to go with for now is going to be a few things missing,</span> <span data-start="344.01" data-end="348.889">for those of you who are familiar with compilers, but the view that I'm going to start with</span> <span data-start="348.889" data-end="354.37">is taking some source code, and that can be from, say, a network, or in this case reading</span> <span data-start="354.37" data-end="357.319">from a file, basically.</span> </p>
<p><span data-start="357.319" data-end="361.509">Taking the source code, bringing it into as a string buffer, so just imagine a big string</span> <span data-start="361.509" data-end="363.24">of JavaScript.</span> <span data-start="363.24" data-end="367.97">And I'm going to use the scanner that I've made to break that down into some various</span> <span data-start="367.97" data-end="368.97">tokens.</span> </p>
<p><span data-start="368.97" data-end="375.159">And these tokens, they're basically like groups of characters that are bunched together to</span> <span data-start="375.159" data-end="376.659">have some sort of semantic meaning.</span> <span data-start="376.659" data-end="384.169">In this case, we've got function as a tone, or fu, or the opening parenthesis here.</span> <span data-start="384.169" data-end="397.74">We are going to send them on to the parser operation.</span> <span data-start="397.74" data-end="400.349">These expressions are different.</span> <span data-start="400.349" data-end="402.27">Expressions are hold other for example s.</span> <span data-start="402.27" data-end="408.05">If you've got the opening of a function, you've got function declaration.</span> <span data-start="408.05" data-end="412.539">The block inside that function, we've got some variable declaration, so the variable</span> <span data-start="412.539" data-end="416.19">declarations would be children to that function.</span> <span data-start="416.19" data-end="418.99">That's generally the idea.</span> <span data-start="418.99" data-end="421.319">Let's just step into that a little bit closer.</span> <span data-start="421.319" data-end="427.85">I'm going to take that line of JS here.</span> <span data-start="427.85" data-end="432.039">I showed this to someone earlier, and they were like, "You should have used const!"</span> <span data-start="432.039" data-end="433.199">Sorry, I forgot.</span> <span data-start="433.199" data-end="437.999">I'm going to start with Let.</span> </p>
<p><span data-start="437.999" data-end="442.909">Imagine you're scanning this, so the thing that reads the file has done its job now and</span> <span data-start="442.909" data-end="444.31">it's going to pass this through.</span> <span data-start="444.31" data-end="449.629">The first thing we are sitting on is the Let.</span> <span data-start="449.629" data-end="451.099">We will produce a token from that.</span> <span data-start="451.099" data-end="453.83">The token in this case is our object.</span> <span data-start="453.83" data-end="454.83">We've got the value.</span> <span data-start="454.83" data-end="456.13">We want to keep hold of the value.</span> </p>
<p><span data-start="456.13" data-end="457.13">That's useful.</span> <span data-start="457.13" data-end="458.83">We want to make a category for the tone.</span> <span data-start="458.83" data-end="460.97">In this case, it's a key word.</span> <span data-start="460.97" data-end="465.199">The reason I know that it is a key word is because I took a look on the spec, grabbed</span> <span data-start="465.199" data-end="468.55">key words and codified against that.</span> <span data-start="468.55" data-end="474.92">So, when I take a string like let that's got no quotes at the beginning, I know it's going</span> <span data-start="474.92" data-end="480.379">to be either an identifier, or maybe even a token, so what I start off by doing is checking</span> <span data-start="480.379" data-end="487.759">off against my list of key words, and I know that this one is a key word.</span> <span data-start="487.759" data-end="497.09">Conf does the same thing but it doesn't exist as a key word so we assume it's an identifier.</span> <span data-start="497.09" data-end="500.16">We are keeping track of the position.</span> <span data-start="500.16" data-end="503.569">The compiler doesn't really need that per se, but it's good if you're debugging and</span> <span data-start="503.569" data-end="507.749">you can output that there's a problem on this line, or if there is a token we're not expecting,</span> <span data-start="507.749" data-end="512.719">we can say there was an issue here, and it's on this column, this line number.</span> </p>
<p><span data-start="512.719" data-end="516.539">Punctuation gets its own category.</span> <span data-start="516.539" data-end="522.87">Again with, we want to keep the value and where we are and so on.</span> <span data-start="522.87" data-end="523.87">So here we've got.</span> <span data-start="523.87" data-end="527.019">Some punctuation, a string, and an identifier, and a key word.</span> <span data-start="527.019" data-end="531.76">We're going to place this into an array, and then pass it on to our parser.</span> <span data-start="531.76" data-end="534.95">This makes it easier for us to deal with when we're traversing through the source code.</span> <span data-start="534.95" data-end="540.82">If you want to look at Rust, don't worry about understanding the syntax or anything like</span> <span data-start="540.82" data-end="544.25">that, but I make use of Rust pattern-matching.</span> <span data-start="544.25" data-end="545.52">Think of Switch Case.</span> <span data-start="545.52" data-end="548.149">It is similar but more powerful.</span> <span data-start="548.149" data-end="554.55">The idea is that you can take a character, or anything, actually, and then the pattern-matching</span> <span data-start="554.55" data-end="556.79">allows you to do some destructuring on that.</span> <span data-start="556.79" data-end="559.76">You can say is it this or this?</span> <span data-start="559.76" data-end="564.69">You can do bindings which I don't have an example about here, or we can say is it a</span> <span data-start="564.69" data-end="566.709">digit, or is it alphabetic?</span> </p>
<p><span data-start="566.709" data-end="573.44">This this case, we're on let, so it is alphabetic, so we go into a state of trying to parse and</span> <span data-start="573.44" data-end="575.21">an identifier.</span> <span data-start="575.21" data-end="580.41">And then we take this, put it in a loop, and of through each character in our source code</span> <span data-start="580.41" data-end="581.82">and you do the same thing.</span> <span data-start="581.82" data-end="584.62">With each character you land on, that's a state.</span> <span data-start="584.62" data-end="586.37">It's a state machine going on.</span> <span data-start="586.37" data-end="588.66">If you're in a quote, it's a state of parsing a string.</span> <span data-start="588.66" data-end="593.85">If you're in a character, it's parsing an identifier and a key word, and so on.</span> <span data-start="593.85" data-end="598.48">I've got a demo.</span> <span data-start="598.48" data-end="599.69">This is something I did earlier.</span> <span data-start="599.69" data-end="605.24">I was going to do it live, but Paul Irish is around, so I just wanted to make sure that</span> <span data-start="605.24" data-end="607.649">he's not going to get interference, or anything!</span> <span data-start="607.649" data-end="614.51">This is a quick writing conf, equals JSConf.</span> <span data-start="614.51" data-end="616.8">We will output some tones.</span> <span data-start="616.8" data-end="621.76">Very similar to what I showed you earlier.</span> </p>
<p><span data-start="621.76" data-end="626.37">We have key words, an identifier, and our punctuation, et cetera.</span> <span data-start="626.37" data-end="627.37">This is now ready to go.</span> <span data-start="627.37" data-end="630.29">We're Aldershot Town done in this area.</span> <span data-start="630.29" data-end="634.97">With parsing, we're going to sort of take that array of tokens, and we are going to</span> <span data-start="634.97" data-end="637.88">try to build a tree structure now.</span> </p>
<p><span data-start="637.88" data-end="640.57">So we are going to start building expressions from these tokens.</span> <span data-start="640.57" data-end="644.36">The way we do that is similar to how we were iterating for the tokens as well.</span> <span data-start="644.36" data-end="647.86">With the characters, we had some pattern-matching going on.</span> <span data-start="647.86" data-end="650.59">We're going to do the same thing.</span> <span data-start="650.59" data-end="653.16">This time, though, we're able to pattern-match on tokens.</span> <span data-start="653.16" data-end="657.98">Now we can say we are sitting on a token that is representing a key word, or representing</span> <span data-start="657.98" data-end="659.78">an identifier.</span> <span data-start="659.78" data-end="664.89">If it is a key word, we can say this is the key word that we are currently sitting on.</span> <span data-start="664.89" data-end="667.16">A quick side note about pattern-matching.</span> <span data-start="667.16" data-end="675.43">It's been so successful in Rust, it's had a lot of success that there's been, there's</span> <span data-start="675.43" data-end="679.99">been a proposal in stage one to bring pattern-matching across into JavaScript.</span> <span data-start="679.99" data-end="682.32">Keep an eye on that.</span> <span data-start="682.32" data-end="686.97">In this case here, we are sitting on top of an "if", and we know our next token should</span> <span data-start="686.97" data-end="688.93">be an open parenthesis.</span> </p>
<p><span data-start="688.93" data-end="696.9">I've made a utility function here called expect punc, expect to have a premises or error out</span> <span data-start="696.9" data-end="698.62">at that point.</span> <span data-start="698.62" data-end="700.43">We can then parse our condition.</span> <span data-start="700.43" data-end="705.6">This is between the parenthesis, and we can make an expression there, and we can do the</span> <span data-start="705.6" data-end="708.89">same thing with the "if" body, and that is the expression underneath.</span> <span data-start="708.89" data-end="716.22">"Next" there chemicals it if the token is "else", which is optional.</span> </p>
<p><span data-start="716.22" data-end="718.019">We may or may not have angles.</span> <span data-start="718.019" data-end="721.699">If we do, we parse that as well.</span> <span data-start="721.699" data-end="727.98">After that, we've got three expressions: the condition, the body, and then potentially</span> <span data-start="727.98" data-end="733.18">the else, and we add those expressions underneath the if "if" expression, so you can start to</span> <span data-start="733.18" data-end="736.199">see the free structure we've got.</span> <span data-start="736.199" data-end="743.17">Don't worry about the syntax of this, but this is implemented using an enum.</span> </p>
<p><span data-start="743.17" data-end="746.5">The expressions are what they call variants.</span> <span data-start="746.5" data-end="748.339">Each variant can hold another expression.</span> <span data-start="748.339" data-end="754.829">You get the recursive structure, and the if variant holds an expression which is a condition</span> <span data-start="754.829" data-end="758.56">which is another expression that might hold other things.</span> <span data-start="758.56" data-end="764.8">The if body, and we wrap the "else" in an option which basically means we may or may</span> <span data-start="764.8" data-end="766.11">not have a value there.</span> <span data-start="766.11" data-end="771.42">It's basically a way of way of us checking to say is there angles?</span> <span data-start="771.42" data-end="776.48">If not, we move on and we get a non-value.</span> <span data-start="776.48" data-end="781.17">The box you can see as well, so these are like the types and the box is basically saying</span> <span data-start="781.17" data-end="784.85">that these are going to live on the heap.</span> <span data-start="784.85" data-end="787.39">And it will manage that for us.</span> <span data-start="787.39" data-end="789.73">So, take a look at this.</span> </p>
<p><span data-start="789.73" data-end="791.54">I've added a bit more code now.</span> <span data-start="791.54" data-end="793.899">We had a let const.</span> <span data-start="793.899" data-end="798.22">I've added more around that.</span> <span data-start="798.22" data-end="803.54">If we started with our function, we get a function declaration expression.</span> <span data-start="803.54" data-end="811.7">And as we work our way down, we get a let const, and that generates is a "let" generation</span> <span data-start="811.7" data-end="816.91">expression underneath the function, and the const expression is just a little, so that</span> <span data-start="816.91" data-end="822.72">is basically saying it's a value that we don't need to evaluate, it's already there.</span> <span data-start="822.72" data-end="825.97">That is also a child of the let declaration.</span> <span data-start="825.97" data-end="831.16">The reason for that is that you can declare variables without defining what they are.</span> <span data-start="831.16" data-end="834.1">In this case, we are defining it as well.</span> <span data-start="834.1" data-end="842.98">So we go down to our "if", and we have our if expression which holds an operation, a</span> <span data-start="842.98" data-end="846.089">condition, a then, and angles.</span> <span data-start="846.089" data-end="850.232">As I said earlier, the else was wrapped in an option, and we didn't use else in this</span> <span data-start="850.232" data-end="852.8">case so we just return as non.</span> <span data-start="852.8" data-end="859.77">Then we go into our if body which is the block expression, and we have another let declaration,</span> <span data-start="859.77" data-end="863.05">and that also has a concept underneath that as well.</span> </p>
<p><span data-start="863.05" data-end="868.74">The last thing is the return which gives us the return expression.</span> <span data-start="868.74" data-end="872.37">So the source code that you see on the left is what would generate the tree we have on</span> <span data-start="872.37" data-end="873.37">the right.</span> <span data-start="873.37" data-end="879.459">Again, a demo, so, hope you can run this.</span> <span data-start="879.459" data-end="882.069">And then there we go.</span> <span data-start="882.069" data-end="883.069">Yes.</span> <span data-start="883.069" data-end="885.629">And so there is a lot more going on there, and that is because I can only cover one more</span> <span data-start="885.629" data-end="889.74">on one slide, but there are more expressions.</span> <span data-start="889.74" data-end="892.93">In this case, there's a block expression at the top, and that represents the global scope,</span> <span data-start="892.93" data-end="895.62">and you've got the function declaration underneath.</span> <span data-start="895.62" data-end="898.199">But you kind of get the idea.</span> <span data-start="898.199" data-end="904.709">So, now we are going to try and evaluate the tree that we've generated.</span> <span data-start="904.709" data-end="909.12">And there are a couple of things that we need to do and bear in mind.</span> <span data-start="909.12" data-end="915.319">The idea is that we want to walk through the tree and then make decisions based on which</span> <span data-start="915.319" data-end="917.569">expression we land on.</span> <span data-start="917.569" data-end="926.36">So, in this example here, we've got a let declaration expression, and the JavaScript</span> <span data-start="926.36" data-end="930.06">underneath is just an example of what that has generated, and so, on the right, we've</span> <span data-start="930.06" data-end="931.06">got the Rust code.</span> </p>
<p><span data-start="931.06" data-end="938.11">What I decided to do was to represent JavaScript values in an email, and so we've got the sort</span> <span data-start="938.11" data-end="941.399">of values that you can have on the right-hand side.</span> <span data-start="941.399" data-end="943.569">A symbol is missing.</span> <span data-start="943.569" data-end="946.54">PRs are welcome.</span> <span data-start="946.54" data-end="952.68">But we've got null , boolean string number, integer, object, and function.</span> <span data-start="952.68" data-end="960.379">Some people wandering why we have integer if all numbers are 64, 64-bit floating points?</span> </p>
<p><span data-start="960.379" data-end="965.48">If you're doing stuff around bit-wise operations, we need to convert them to a number, do the</span> <span data-start="965.48" data-end="970.329">operation on that, and then convert it back into a floating point.</span> <span data-start="970.329" data-end="973.11">So it's kind of used internally.</span> <span data-start="973.11" data-end="979.69">Then we take a value and wrap it in a GC so there is a great GC library that somebody</span> <span data-start="979.69" data-end="985.079">made and it was super useful, and the reason I needed that is because in JavaScript, you</span> <span data-start="985.079" data-end="990.56">can reference one value for multiple functions, and so that value goes out of scope.</span> </p>
<p><span data-start="990.56" data-end="995.19">You need to make sure that it stays alive, and so the idea here is I can take a value</span> <span data-start="995.19" data-end="1001.37">that I've made, put it in the GC, and that GC will automatically handle not garbage-collecting</span> <span data-start="1001.37" data-end="1006.279">that until nothing else needs it, or at least until it goes out of scope and nothing else</span> <span data-start="1006.279" data-end="1008.769">can possibly point to it.</span> <span data-start="1008.769" data-end="1010.55">Manesh worked on that.</span> <span data-start="1010.55" data-end="1018.23">He did a great job on that.</span> <span data-start="1018.23" data-end="1024.94">I have my value data which is a string, and I pass my string in, and I now have my value,</span> <span data-start="1024.94" data-end="1028.84">which is great.</span> <span data-start="1028.84" data-end="1030.66">We need to put the value somewhere.</span> </p>
<p><span data-start="1030.66" data-end="1035.56">So I started off by using hashmaps.</span> <span data-start="1035.56" data-end="1042.26">The idea was that I had a naïve approach which was whenever we come across a function,</span> <span data-start="1042.26" data-end="1043.26">create a hashmap.</span> <span data-start="1043.26" data-end="1045.38">Anything inside that function, I will throw in there.</span> <span data-start="1045.38" data-end="1047.22">This is to get going.</span> <span data-start="1047.22" data-end="1049.22">It got me surprisingly far.</span> <span data-start="1049.22" data-end="1053.9">As you saw the tree earlier, every time I stepped on to a function declaration, I would</span> <span data-start="1053.9" data-end="1061.82">step on to a hashmap.</span> <span data-start="1061.82" data-end="1067.58">Every time I came across a let declaration, I would add the value straight in.</span> <span data-start="1067.58" data-end="1074">Real engines do more than this, but if you want to get going, it was pretty effective.</span> <span data-start="1074" data-end="1078.92">You can see here, though, that quickly it start to fail, because we have our B here</span> <span data-start="1078.92" data-end="1085.02">that is in same environment as the conf and the B should probably be removed once that</span> <span data-start="1085.02" data-end="1087.96">block expression finishes.</span> </p>
<p><span data-start="1087.96" data-end="1093.29">So I realised I do need to have more environments than just the one for function.</span> <span data-start="1093.29" data-end="1094.86">Took a look at the spec.</span> <span data-start="1094.86" data-end="1100.3">The specification actually points out five of them, and it calls them records.</span> <span data-start="1100.3" data-end="1104.78">I'm not going to read them out, but you kind of get the idea.</span> <span data-start="1104.78" data-end="1111.07">And is to I then took the environment section of the spec and basically implemented that.</span> <span data-start="1111.07" data-end="1112.44">It was not easy.</span> <span data-start="1112.44" data-end="1114.02">It was not easy at all.</span> <span data-start="1114.02" data-end="1118.95">But basically, what I do now is I created function records, I created block scope records,</span> <span data-start="1118.95" data-end="1124.06">global scope records, and even modular records, and then the idea is every time I made a new</span> <span data-start="1124.06" data-end="1133.08">record, I would add metadata to add value, and I would give it a parent property as well,</span> <span data-start="1133.08" data-end="1136.961">so that I could point to the record I made of previously and then you start to have a</span> <span data-start="1136.961" data-end="1140.24">sort of chain, the scope chain, where we can do our look-ups.</span> </p>
<p><span data-start="1140.24" data-end="1144.58">If you go back to our tree, the idea is that I make a function declaration, and I make</span> <span data-start="1144.58" data-end="1146.34">a function environment.</span> <span data-start="1146.34" data-end="1150.44">I have a declaration, I add my value in there.</span> <span data-start="1150.44" data-end="1155.72">Have a block expression, I make a declarative environment, add my value in there.</span> <span data-start="1155.72" data-end="1158.89">So far, so good.</span> <span data-start="1158.89" data-end="1162.2">Return is interesting, because the Conf is not in the turn the current environment I've</span> <span data-start="1162.2" data-end="1167.25">just made, so I have to make use of the patient property to do a lockup.</span> <span data-start="1167.25" data-end="1169.85">In this case, I'm trying to find where const is.</span> <span data-start="1169.85" data-end="1171.75">I'm saying can you give me the value for const?</span> <span data-start="1171.75" data-end="1172.75">It doesn't find it.</span> <span data-start="1172.75" data-end="1177.82">It gets it from the function declaration scope and gets it from there.</span> <span data-start="1177.82" data-end="1184">This is basically the scope chain that you probably heard obviously people talk about.</span> <span data-start="1184" data-end="1190.15">You can actually put your code into various tools that show you the tree, so there's AST</span> <span data-start="1190.15" data-end="1191.15">Explorer.</span> <span data-start="1191.15" data-end="1199.491">I think it's astexplorer.com or dot net, and you can put your view in there and see how</span> <span data-start="1199.491" data-end="1202.58">it would be expressed as an abstract stream.</span> </p>
<p><span data-start="1202.58" data-end="1205.61">With all of this.</span> <span data-start="1205.61" data-end="1210.44">Let's give this a try.</span> <span data-start="1210.44" data-end="1212.65">I'm going to console.log it out.</span> <span data-start="1212.65" data-end="1219.62">It implements the console.log which prints the value given.</span> <span data-start="1219.62" data-end="1226.25">There we go.</span> <span data-start="1226.25" data-end="1231.11">And so we have JSConf EU.</span> <span data-start="1231.11" data-end="1235.43">Thank you!</span> <span data-start="1235.43" data-end="1237.59">[Applause].</span> <span data-start="1237.59" data-end="1241.06">It's pretty fast as well.</span> <span data-start="1241.06" data-end="1243.54">Yes, there we go.</span> <span data-start="1243.54" data-end="1245.4">Got it working.</span> </p>
<p><span data-start="1245.4" data-end="1250.01">To begin with, I got small things working, then I slowly started adding some other stuff,</span> <span data-start="1250.01" data-end="1256.14">so I think this week, you know, it can do let and comps, a bit better, arrow functions</span> <span data-start="1256.14" data-end="1257.84">were easy to add.</span> <span data-start="1257.84" data-end="1261.92">Once you get the building blocks there, it becomes easier and easier to add more stuff.</span> <span data-start="1261.92" data-end="1267.94">A couple of performance opportunities: so one is maybe don't parse everything.</span> <span data-start="1267.94" data-end="1269.3">Most functions are declared.</span> <span data-start="1269.3" data-end="1274.4">Don't end up evening being .. so it's not worth parsing every single thing you come</span> <span data-start="1274.4" data-end="1277.71">across because that can slow things down.</span> <span data-start="1277.71" data-end="1285.74">Spider Monkey and V8 do lazy parsing and may not add it to the syntax free straightaway</span> <span data-start="1285.74" data-end="1293.23">and make a note of it and parse it will have before it is ran and parse lazily.</span> <span data-start="1293.23" data-end="1296.76">It will check through functions but not actually add them to the AST.</span> </p>
<p><span data-start="1296.76" data-end="1299.34">That's one tip.</span> <span data-start="1299.34" data-end="1302.05">Don't parse functions that aren't going to be called.</span> <span data-start="1302.05" data-end="1305.34">All the JS engines in use today already do this.</span> <span data-start="1305.34" data-end="1309.37">Another opportunity is to make use of the concurrency in Rust, so I can actually break</span> <span data-start="1309.37" data-end="1314.53">these tasks apart, have them run on separate threads and pass data between each etch other.</span> <span data-start="1314.53" data-end="1320.24">Got a scanner, pass the tokens across into the parser, because a scanner doesn't need</span> <span data-start="1320.24" data-end="1325.13">those values anymore, and it doesn't need to hold on to them.</span> <span data-start="1325.13" data-end="1327.8">I can go further than this.</span> <span data-start="1327.8" data-end="1339.66">I can go further and have a work er reading the files into the parser.</span> <span data-start="1339.66" data-end="1343.03">This is something that script engines do today.</span> <span data-start="1343.03" data-end="1344.6">It's called script-screaming.</span> <span data-start="1344.6" data-end="1348.82">The new WebAssembly cider monkey does this.</span> <span data-start="1348.82" data-end="1352.13">As the script is downloading, it can start running straightaway.</span> </p>
<p><span data-start="1352.13" data-end="1354.54">V8 does this already as well.</span> <span data-start="1354.54" data-end="1360.73">A couple of good things — implementing JavaScript, I need to do that.</span> <span data-start="1360.73" data-end="1368.83">JIT compilation, hopeful working for us with a good package called Holy JIT — I like that.</span> <span data-start="1368.83" data-end="1379.12">I will do more stuff on the event loop, and more tests around that, and United States</span> <span data-start="1379.12" data-end="1380.85">advertising tests 262.</span> </p>
<p><span data-start="1380.85" data-end="1382">That's it.</span> <span data-start="1382" data-end="1385.97">I've brought JavaScript to the Rust ecosystem.</span> <span data-start="1385.97" data-end="1388.68">People in the Rust world can make use of it if they want to tokenise.</span> <span data-start="1388.68" data-end="1394.47">It's quite modular, if they want to have a parser in the Rust world, they can do it.</span> <span data-start="1394.47" data-end="1395.47">They can use it.</span> <span data-start="1395.47" data-end="1396.47">They have some JavaScript.</span> <span data-start="1396.47" data-end="1400.74">Then I thought have I married my love of these two things together?</span> <span data-start="1400.74" data-end="1403.43">I brought JS into the world of Rust.</span> <span data-start="1403.43" data-end="1408.42">Can I bring this piece of Rust into the world of JavaScript?</span> <span data-start="1408.42" data-end="1412.44">Yes, I can!</span> <span data-start="1412.44" data-end="1415.13">There's WebAssembly.</span> <span data-start="1415.13" data-end="1417.99">I can bring this whole thing into the browser.</span> <span data-start="1417.99" data-end="1420.04">I know!</span> <span data-start="1421.26" data-end="1424.7">The Rust team and the WebAssembly working group have been working together for quite</span> <span data-start="1424.7" data-end="1431.75">a while now to make Wasm really awesome especially via Rust, working on great tooling over the</span> <span data-start="1431.75" data-end="1433.6">past few years.</span> </p>
<p><span data-start="1433.6" data-end="1434.74">Why not take of those.</span> <span data-start="1434.74" data-end="1442.96">One of those tools is Wasm bind be and let's take that and use it with Boa, bring it into</span> <span data-start="1442.96" data-end="1447.74">the browser, running JS.</span> <span data-start="1447.74" data-end="1449.4">The way that works is pretty peaceful.</span> <span data-start="1449.4" data-end="1456.37">You take WebAssembly, bring it on to a place where you want expose.</span> <span data-start="1456.37" data-end="1461.98">Something like this, exposed as a ES6 module.</span> <span data-start="1461.98" data-end="1467.74">I thought let's add Wasm into that, build my package.</span> <span data-start="1467.74" data-end="1471.01">It will generate WebAssembly, and I can use that.</span> <span data-start="1471.01" data-end="1473.2">There are some advantages to this.</span> <span data-start="1473.2" data-end="1475.34">It is quite fast.</span> <span data-start="1475.34" data-end="1478.36">When the browser pulls it in, it can run it straightaway.</span> <span data-start="1478.36" data-end="1482.47">But it's compiled, it's more compact, so you've got a faster download because you're downloading</span> <span data-start="1482.47" data-end="1483.61">less code.</span> <span data-start="1483.61" data-end="1487.75">There's still the safety aspect there as well because it follows the same rules, like same</span> <span data-start="1487.75" data-end="1492.13">origin and browser limitations, so you don't get the ballot box making requests where it</span> <span data-start="1492.13" data-end="1494.03">shouldn't be.</span> </p>
<p><span data-start="1494.03" data-end="1496.79">I can expose it to JavaScript.</span> <span data-start="1496.79" data-end="1502.48">I can use it as though it's a JS module.</span> <span data-start="1502.48" data-end="1504.61">It's actually Rust I'm importing there.</span> <span data-start="1504.61" data-end="1507.4">It's not JS.</span> </p>
<p><span data-start="1507.4" data-end="1509.85">I can pass it a string.</span> <span data-start="1509.85" data-end="1514.34">And I can run it.</span> <span data-start="1514.34" data-end="1516.04">That's the Wasm attribute.</span> <span data-start="1516.04" data-end="1519.74">You put that on to be of the function of any function you want to expose in the JS world</span> <span data-start="1519.74" data-end="1524.95">and it will build your package into a Wasm file and then export it.</span> <span data-start="1524.95" data-end="1527.03">Like this.</span> <span data-start="1527.03" data-end="1531.66">I'm going to build it.</span> <span data-start="1531.66" data-end="1534.36">I'm doing Yarn serve because there's a WebAssembly plugin.</span> <span data-start="1534.36" data-end="1537.88">That's going to build that out.</span> <span data-start="1537.88" data-end="1538.88">Take a look on the left.</span> <span data-start="1538.88" data-end="1540.56">It's going to generate a package folder.</span> </p>
<p><span data-start="1540.56" data-end="1542.9">It's pretty quick.</span> <span data-start="1542.9" data-end="1546.68">I can make changes to Rust code and that are long-run, and the browser will reload.</span> <span data-start="1546.68" data-end="1549.2">It's like I'm writing JavaScript, basically.</span> <span data-start="1549.2" data-end="1563.34">Now we have a Boa bind gen Wasm file, and you can import that</span> <span data-start="1563.34" data-end="1570.14">into — we're going to write it, scan it, parse it would be evaluate it.</span> <span data-start="1570.14" data-end="1576.25">And then we're going to bring that back into JavaScript, and then basically print the value</span> <span data-start="1576.25" data-end="1577.25">out.</span> </p>
<p><span data-start="1577.25" data-end="1580.82">I'm going to try to do something challenging.</span> <span data-start="1580.82" data-end="1584.12">Over time, it will get more challenging, but this is the most I can do right now.</span> <span data-start="1584.12" data-end="1596.62">Hopefully, we get — we can return "hello", we can do plus JSConf, second function.</span> <span data-start="1596.62" data-end="1604">Are you ready?</span> <span data-start="1604" data-end="1606.45">Oh!</span> </p>
<p><span data-start="1606.45" data-end="1611.37">Come on!</span> <span data-start="1611.37" data-end="1613.83">[Applause].</span> <span data-start="1613.83" data-end="1616.15">That's what keeps me up.</span> <span data-start="1616.15" data-end="1617.15">This is why I'm in the industry.</span> <span data-start="1617.15" data-end="1620.86">This is that's Rust running there.</span> <span data-start="1620.86" data-end="1623.17">There's no network request.</span> <span data-start="1623.17" data-end="1628.77">That's Rust running in the browser executing that JS, scanning it would be parsing it,</span> <span data-start="1628.77" data-end="1632.19">evaluating, and the JavaScript is there as well.</span> <span data-start="1632.19" data-end="1634.23">They work hand in hand.</span> <span data-start="1634.23" data-end="1642.87">The takeaway is you can take the .. performance-sensitive parts of your application, build them in Rust,</span> <span data-start="1642.87" data-end="1647.15">as and you only need to change those bits, not the whole application.</span> </p>
<p><span data-start="1647.15" data-end="1654.38">The next time you're thinking of building a JS parse er like this one, or a game engine,</span> <span data-start="1654.38" data-end="1657.79">it was super easy and worth doing.</span> <span data-start="1657.79" data-end="1659.65">It's definitely worth thinking about.</span> <span data-start="1659.65" data-end="1662.02">You can actually play with the demo as well.</span> <span data-start="1662.02" data-end="1664.28">It's on that GitHub repo.</span> <span data-start="1664.28" data-end="1668">You can go with there and play it live.</span> </p>
</section>