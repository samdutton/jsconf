<section>
<p><span data-start="11.24" data-end="17.43">hello hi welcome to my talk it's very</span> <span data-start="17.43" data-end="20.789">loud there we go better still pretty</span> <span data-start="20.789" data-end="24.269">loud so my talk is called untitled thank</span> <span data-start="24.269" data-end="26.609">you all for coming here no just kidding</span> <span data-start="26.609" data-end="28.38">it's called breaking the rules mitering</span> <span data-start="28.38" data-end="32.669">your node application and my name is ron</span> <span data-start="32.669" data-end="36.239">i am from company called upbeat and we</span> <span data-start="36.239" data-end="39.57">do monitoring and this talk sort of came</span> <span data-start="39.57" data-end="41.52">out of some of the recent work we've</span> <span data-start="41.52" data-end="44.309">been doing with node and specifically</span> <span data-start="44.309" data-end="47.16">monitoring in node so it's gonna talk</span> <span data-start="47.16" data-end="49.98">about how you can do monitoring in node</span> <span data-start="49.98" data-end="52.92">in sort of a general way hopefully is</span> <span data-start="52.92" data-end="54.18">going to be interesting and hopefully</span> <span data-start="54.18" data-end="56.28">we're going to be breaking some some of</span> <span data-start="56.28" data-end="60.09">the rules a bit m so the goal here is</span> <span data-start="60.09" data-end="62.76">and i want to show you how you can get</span> <span data-start="62.76" data-end="66.15">out of the box monitoring for your web</span> <span data-start="66.15" data-end="69.6">application in node and so our box</span> <span data-start="69.6" data-end="72.299">monitoring for me means that i can see</span> <span data-start="72.299" data-end="74.63">how long my endpoints are taking to</span> <span data-start="74.63" data-end="77.939">respond but I can also see how long time</span> </p>
<p><span data-start="77.939" data-end="80.46">I'm spending in each endpoint talking to</span> <span data-start="80.46" data-end="82.979">Mongo Mongo DB for example how long time</span> <span data-start="82.979" data-end="85.68">I'm taking it how long time it takes to</span> <span data-start="85.68" data-end="88.14">talk to Redis how long time I'm spending</span> <span data-start="88.14" data-end="90.06">rendering templates etc and I want this</span> <span data-start="90.06" data-end="93.27">/ end point but further than that I</span> <span data-start="93.27" data-end="95.4">wanted to be out of the box so that I</span> <span data-start="95.4" data-end="96.72">don't have to go and change my</span> <span data-start="96.72" data-end="97.979">application very much to get this</span> <span data-start="97.979" data-end="100.29">monitoring so I wanted to work in a way</span> <span data-start="100.29" data-end="102.27">that I can just request a module and</span> <span data-start="102.27" data-end="103.649">that basically gives me out of the box</span> <span data-start="103.649" data-end="107.96">monitoring so how do you do that so</span> <span data-start="107.96" data-end="112.32">first i will introduce a bunch of a</span> <span data-start="112.32" data-end="117.689">small little things primitives and so</span> <span data-start="117.689" data-end="120.09">this is a trace bookkeeper it's very</span> <span data-start="120.09" data-end="122.61">very simple you can call call start and</span> <span data-start="122.61" data-end="124.86">end on a trace bookkeeper and basically</span> <span data-start="124.86" data-end="127.5">it will create a new trees if it doesn't</span> <span data-start="127.5" data-end="129.509">already have one with this name that you</span> <span data-start="129.509" data-end="132.81">gave it then call start on it and then</span> <span data-start="132.81" data-end="133.71">you can in the tree</span> <span data-start="133.71" data-end="137.37">ace em with a specific name so that's</span> <span data-start="137.37" data-end="139.77">pretty simple and I want to keep one of</span> <span data-start="139.77" data-end="142.2">these trace bookkeepers around for each</span> <span data-start="142.2" data-end="146.64">request to my application trace looks</span> <span data-start="146.64" data-end="150.51">like this and so when you do monitoring</span> <span data-start="150.51" data-end="153.56">a lot of stuff goes on at the same time</span> <span data-start="153.56" data-end="157.35">how do you measure time spent in an</span> <span data-start="157.35" data-end="160.11">application it's that can be kind of</span> <span data-start="160.11" data-end="162.78">tricky so let's say you have two Mongol</span> <span data-start="162.78" data-end="164.85">crew is going on at the same time you</span> <span data-start="164.85" data-end="166.41">doesn't really make sense to sort of add</span> <span data-start="166.41" data-end="167.88">the time up that each each one of them</span> <span data-start="167.88" data-end="171.63">spent so the the semantics around how</span> <span data-start="171.63" data-end="172.95">you actually how you actually measure</span> <span data-start="172.95" data-end="174.78">time when stuff happens concurrently</span> <span data-start="174.78" data-end="176.76">it's kind of interesting and what this</span> <span data-start="176.76" data-end="179.37">trace thing we'll do is that let's say</span> <span data-start="179.37" data-end="181.83">you have to Mongo queries that start</span> <span data-start="181.83" data-end="183.78">approximate at the same time but one</span> <span data-start="183.78" data-end="186.54">ends a way later than the other one then</span> <span data-start="186.54" data-end="190.83">with this trace a primitive here we're</span> <span data-start="190.83" data-end="192.45">going to count the time from the first</span> <span data-start="192.45" data-end="194.97">one started to the last one ended hey</span> <span data-start="194.97" data-end="197.82">what it also does is it can sort of</span> <span data-start="197.82" data-end="201.42">measure consecutive traces so if you</span> <span data-start="201.42" data-end="203.67">start a mockery and then end it it'll</span> <span data-start="203.67" data-end="206.31">take that time and summit with the next</span> </p>
<p><span data-start="206.31" data-end="210.42">Mongol crew you're doing so if so if you</span> <span data-start="210.42" data-end="212.07">have mon crews are not overlapping it</span> <span data-start="212.07" data-end="214.29">will some the time for each mockery</span> <span data-start="214.29" data-end="217.53">together okay so there was some</span> <span data-start="217.53" data-end="220.08">low-level all of the stuff and sorry</span> <span data-start="220.08" data-end="221.73">that was some primitives I think one</span> <span data-start="221.73" data-end="223.32">more thing to notice here is that I'm</span> <span data-start="223.32" data-end="225.9">using the high resolution timer and if</span> <span data-start="225.9" data-end="228.54">you're doing timing a sort of monitoring</span> <span data-start="228.54" data-end="229.71">like this you should be using the high</span> <span data-start="229.71" data-end="231.66">resolution high resolution timer because</span> <span data-start="231.66" data-end="234.48">it's much more a low-level then then</span> <span data-start="234.48" data-end="236.1">breaking out dates and started starting</span> <span data-start="236.1" data-end="239.88">to compare them and yeah okay so let's</span> <span data-start="239.88" data-end="242.16">not bring some rules first we want to</span> <span data-start="242.16" data-end="245.19">hook into HTTP server ed listener that's</span> <span data-start="245.19" data-end="247.32">part of the reason why we do that is</span> <span data-start="247.32" data-end="249.6">part of the idea that it should be</span> <span data-start="249.6" data-end="251.21">something that works out of the box and</span> <span data-start="251.21" data-end="253.56">so what I'm actually going to do is I'm</span> <span data-start="253.56" data-end="258.39">gonna monkey patch a the ed listener a</span> <span data-start="258.39" data-end="262.71">method on HTTP server and there's a lot</span> <span data-start="262.71" data-end="265.77">of stuff going on here but what you</span> <span data-start="265.77" data-end="267.45">actually need to sort of</span> <span data-start="267.45" data-end="271.11">is that we will call on request instead</span> <span data-start="271.11" data-end="274.35">of the original call back and we'll</span> <span data-start="274.35" data-end="277.05">we'll start a new trace bookkeeper for</span> <span data-start="277.05" data-end="279.12">this particular request will set it on</span> <span data-start="279.12" data-end="280.86">the request and once the request is</span> <span data-start="280.86" data-end="283.95">finished we extract the route name from</span> <span data-start="283.95" data-end="286.2">the request and we call this mythical</span> <span data-start="286.2" data-end="291.02">request finished so this obviously</span> <span data-start="291.02" data-end="292.95">requires that you're building an Express</span> <span data-start="292.95" data-end="294.9">application but you can do the same</span> <span data-start="294.9" data-end="296.13">thing for most of the other frameworks</span> <span data-start="296.13" data-end="306.3">out there yes okay now this was sort of</span> <span data-start="306.3" data-end="308.7">our hook into the request response cycle</span> <span data-start="308.7" data-end="310.62">now let's actually start measuring some</span> <span data-start="310.62" data-end="313.47">code so this is an example of how you</span> <span data-start="313.47" data-end="316.62">could be calling Redis talking to radis</span> <span data-start="316.62" data-end="318.03">this could happen anywhere in your</span> <span data-start="318.03" data-end="321.39">application and it's pretty standard so</span> <span data-start="321.39" data-end="323.79">you try to get a key from ritas and when</span> <span data-start="323.79" data-end="325.11">you when you get it you can log it out</span> <span data-start="325.11" data-end="327.51">to the console so how would we measure</span> <span data-start="327.51" data-end="328.89">the time it actually took to get this</span> <span data-start="328.89" data-end="331.53">key from ritas this is one way to do it</span> <span data-start="331.53" data-end="334.44">you can see that i'm using something</span> <span data-start="334.44" data-end="336.24">called trace code here and i gave trace</span> <span data-start="336.24" data-end="339.69">code is the name that i'm passing in</span> <span data-start="339.69" data-end="342.06">this time it's just ready to get sort of</span> <span data-start="342.06" data-end="344.43">indicates what I'm what I'm currently</span> <span data-start="344.43" data-end="347.06">trying to measure and you see that the</span> <span data-start="347.06" data-end="349.95">trace code will return a function that</span> <span data-start="349.95" data-end="353.34">then wraps the original call back so</span> <span data-start="353.34" data-end="355.32">when I call trace code it'll start the</span> <span data-start="355.32" data-end="357.27">timer and then when the callback is</span> <span data-start="357.27" data-end="358.59">called I'll stop the timer and then call</span> <span data-start="358.59" data-end="362.58">the original call back you could monkey</span> <span data-start="362.58" data-end="363.96">patch the register library if you wanted</span> <span data-start="363.96" data-end="366.33">to get this out of the box I'm going to</span> <span data-start="366.33" data-end="368.58">leave that as an exercise but it's quite</span> <span data-start="368.58" data-end="372.24">simple to do and you can see what trace</span> <span data-start="372.24" data-end="375.03">code looks like here so it's also quite</span> <span data-start="375.03" data-end="378.33">simple M will call stop on the current</span> <span data-start="378.33" data-end="379.98">on the book key before the current</span> <span data-start="379.98" data-end="382.95">request and when the when trace cold is</span> <span data-start="382.95" data-end="385.44">called and then we return this function</span> <span data-start="385.44" data-end="387.69">and that will wrap the original call</span> <span data-start="387.69" data-end="389.67">back and call end on the on the</span> <span data-start="389.67" data-end="392.04">bookkeeper for this for this name so you</span> <span data-start="392.04" data-end="393.27">might think this actually doesn't work</span> <span data-start="393.27" data-end="394.56">because there's something missing here</span> <span data-start="394.56" data-end="396.9">and then you will be right the request</span> <span data-start="396.9" data-end="400.68">is missing so what's going on here</span> <span data-start="400.68" data-end="403.77">is we have a request that comes in</span> <span data-start="403.77" data-end="408.33">through our HTTP server and we want to</span> <span data-start="408.33" data-end="409.889">measure some code that happens somewhere</span> <span data-start="409.889" data-end="411.75">else in my application and connect it to</span> <span data-start="411.75" data-end="413.55">this request because I'm not per request</span> <span data-start="413.55" data-end="416.639">oh poor endpoint measurements so how do</span> <span data-start="416.639" data-end="419.55">you do that that's pretty difficult</span> <span data-start="419.55" data-end="422.759">because a lot of stuff can go on in</span> <span data-start="422.759" data-end="424.59">between the request to the web server</span> <span data-start="424.59" data-end="426.449">and you actually measure measuring some</span> <span data-start="426.449" data-end="429.419">code somewhere in your application so</span> <span data-start="429.419" data-end="432.9">connecting measurements to a request is</span> <span data-start="432.9" data-end="437.28">not that simple um you have event loop</span> <span data-start="437.28" data-end="439.32">chicks and you have a lot of requests</span> <span data-start="439.32" data-end="442.979">going on at the same time so there was</span> <span data-start="442.979" data-end="445.05">this wonderful API called create a sink</span> <span data-start="445.05" data-end="448.43">listener and the quote there's from the</span> <span data-start="448.43" data-end="452.729">documentation and what this does is it</span> <span data-start="452.729" data-end="454.65">basically gives us a hook into the event</span> <span data-start="454.65" data-end="457.11">loop so that means we get a call back</span> <span data-start="457.11" data-end="458.94">just before anything is put on the event</span> <span data-start="458.94" data-end="462.81">loop and we get a call back just after</span> <span data-start="462.81" data-end="465.3">something is about to start that was on</span> <span data-start="465.3" data-end="468.06">the event you and just before we put</span> <span data-start="468.06" data-end="469.32">something on your win loop we get the</span> <span data-start="469.32" data-end="471.659">option to store some data that will then</span> <span data-start="471.659" data-end="473.94">be restored when that thing that we're</span> <span data-start="473.94" data-end="475.349">about to put on the event loop actually</span> <span data-start="475.349" data-end="479.099">runs and do we use using this you can</span> <span data-start="479.099" data-end="482.96">actually pass down the request from the</span> <span data-start="482.96" data-end="486.15">from where the request from where we</span> <span data-start="486.15" data-end="488.849">hook into the HP server all the way down</span> <span data-start="488.849" data-end="492.75">to where we want to trace our code so</span> <span data-start="492.75" data-end="494.099">it's like a primitive to actually allow</span> <span data-start="494.099" data-end="497.82">us to pass a context between a sinking</span> <span data-start="497.82" data-end="500.13">ticks in node that's wonderful that's</span> <span data-start="500.13" data-end="503.009">exactly what we need unfortunately it</span> <span data-start="503.009" data-end="505.349">only live in node for very very short</span> <span data-start="505.349" data-end="509.33">period of time that's really unfortunate</span> <span data-start="509.33" data-end="512.88">so how do we solve this we do some</span> <span data-start="512.88" data-end="515.61">monkey patching so basically what you</span> <span data-start="515.61" data-end="517.77">can do is you can monkey patch every</span> <span data-start="517.77" data-end="519.69">single time or in every single scenario</span> <span data-start="519.69" data-end="521.07">that something gets put on the event</span> <span data-start="521.07" data-end="523.289">loop and obtain the same functionality</span> <span data-start="523.289" data-end="526.68">and that's pretty complicated some</span> <span data-start="526.68" data-end="528.48">libraries out there they've tried to do</span> <span data-start="528.48" data-end="530.85">it and so the most popular one is the</span> <span data-start="530.85" data-end="533.01">esig listener there's also some stuff</span> <span data-start="533.01" data-end="534.12">going on in anglo</span> <span data-start="534.12" data-end="538.32">world with zone j/s and there's</span> <span data-start="538.32" data-end="539.79">something called a shrink wrap and as a</span> <span data-start="539.79" data-end="541.8">working group that is working with this</span> <span data-start="541.8" data-end="546.029">which is the most promising of the sort</span> <span data-start="546.029" data-end="550.11">of native primitives right now and it's</span> <span data-start="550.11" data-end="552.36">not the not in yet but hopefully it'll</span> <span data-start="552.36" data-end="553.56">be that soon so we don't have to monkey</span> <span data-start="553.56" data-end="556.95">patch so badly ah but so for right now</span> <span data-start="556.95" data-end="558.12">you have to you actually have to monkey</span> <span data-start="558.12" data-end="561.27">patch so there's this library called</span> </p>
<p><span data-start="561.27" data-end="563.49">Essex state that Thomas wrote some of</span> <span data-start="563.49" data-end="566.76">this right here and it's based on a</span> <span data-start="566.76" data-end="569.82">solicitor so it takes this pretty</span> <span data-start="569.82" data-end="571.5">convoluted interface that's called a</span> <span data-start="571.5" data-end="573.93">create a sink listener and basically</span> <span data-start="573.93" data-end="576.75">allows you to save some state anywhere</span> <span data-start="576.75" data-end="580.17">in your code and all the stuff that you</span> <span data-start="580.17" data-end="581.94">put on the event loop will then have a</span> <span data-start="581.94" data-end="584.58">this state available for you and so it's</span> <span data-start="584.58" data-end="585.839">a much more intuitive interface and it</span> <span data-start="585.839" data-end="587.94">looks like this so you require a sixth</span> <span data-start="587.94" data-end="591.99">eighth you basically set something on</span> <span data-start="591.99" data-end="595.14">the Essex state and then it gets sort of</span> <span data-start="595.14" data-end="597.96">frozen so when I put something on the</span> <span data-start="597.96" data-end="600.029">event loop it's going to take whatever</span> <span data-start="600.029" data-end="602.91">is in my currently well whatever is</span> <span data-start="602.91" data-end="605.82">currently in my state in Essex state and</span> <span data-start="605.82" data-end="607.38">make that available when the when the</span> <span data-start="607.38" data-end="609.18">thing runs that I've that I've put on</span> <span data-start="609.18" data-end="612.15">the event loop so this will print foo</span> <span data-start="612.15" data-end="614.67">and then bar which is a little bit</span> <span data-start="614.67" data-end="615.89">counterintuitive if you look at the</span> <span data-start="615.89" data-end="619.83">execution order here um but that's sort</span> <span data-start="619.83" data-end="623.31">of a simplified or a much easier</span> <span data-start="623.31" data-end="625.38">interface for us to use to pass data</span> <span data-start="625.38" data-end="629.31">between execution context so let's go</span> <span data-start="629.31" data-end="633.24">back to our beautifully wrapped HTTP</span> <span data-start="633.24" data-end="636.74">server so the new thing here is that</span> <span data-start="636.74" data-end="641.49">when I have a new request I actually put</span> <span data-start="641.49" data-end="644.31">the request in my asking state which</span> <span data-start="644.31" data-end="646.35">means that all the stuff all the things</span> <span data-start="646.35" data-end="647.459">that I put on the event loop now will</span> <span data-start="647.459" data-end="649.68">have access to the quest and which is</span> <span data-start="649.68" data-end="651.36">great that we like what we need that</span> <span data-start="651.36" data-end="655.35">means that in my trace code helper I can</span> <span data-start="655.35" data-end="657.209">just pull out the request and start</span> <span data-start="657.209" data-end="662.22">doing my measurements on the request but</span> <span data-start="662.22" data-end="665.99">that's quite useful</span> <span data-start="666" data-end="669.02">and all we need to do now is actually to</span> <span data-start="669.02" data-end="671.1">when our request is finished we need to</span> <span data-start="671.1" data-end="672.57">take all the measurements that we made</span> <span data-start="672.57" data-end="675.48">for this request and sort of put it in a</span> <span data-start="675.48" data-end="677.16">in a global somewhere that we can access</span> <span data-start="677.16" data-end="679.5">and so that's what fit request finish</span> <span data-start="679.5" data-end="683.3">does this is what that looks like and</span> <span data-start="683.3" data-end="686.31">it's very simple just to sort of take</span> <span data-start="686.31" data-end="688.35">the stuff that is in bookkeeper and put</span> <span data-start="688.35" data-end="692.1">it in request stats and I can spend too</span> <span data-start="692.1" data-end="695.16">much time with that and then finally we</span> <span data-start="695.16" data-end="697.65">can expose it as an end point in my</span> </p>
<p><span data-start="697.65" data-end="699.15">Express application so that's what this</span> <span data-start="699.15" data-end="700.86">thing does you see at the bottom here I</span> <span data-start="700.86" data-end="706.35">have / stats and calling that I will get</span> <span data-start="706.35" data-end="709.08">a nice JSON that actually shows what the</span> <span data-start="709.08" data-end="711.45">time has been spent on and so what i'm</span> <span data-start="711.45" data-end="714.6">doing here is i go over all the stuff</span> <span data-start="714.6" data-end="717.68">that i have in my request stats and</span> <span data-start="717.68" data-end="720.36">average average things out so i can see</span> <span data-start="720.36" data-end="722.21">on average how much time is being spent</span> <span data-start="722.21" data-end="726.06">in Redis how much time is being spent in</span> <span data-start="726.06" data-end="730.2">on go etc and so it looks like this</span> <span data-start="730.2" data-end="734.46">basically exposed to the endpoint you</span> <span data-start="734.46" data-end="735.63">can see how many requests are being made</span> <span data-start="735.63" data-end="739.56">to each endpoint and you can see em how</span> <span data-start="739.56" data-end="742.08">many red is gets how much time i'll</span> <span data-start="742.08" data-end="743.97">never spend on ready skate how much time</span> </p>
<p><span data-start="743.97" data-end="747.33">I spend on L range and how much time I</span> <span data-start="747.33" data-end="751.55">spend rendering the index view and etc</span> <span data-start="751.55" data-end="754.14">yeah so that was sort of a whirlwind of</span> <span data-start="754.14" data-end="758.64">how you can patch up your your node</span> <span data-start="758.64" data-end="759.96">application to get performance out of</span> <span data-start="759.96" data-end="762.08">the box and there's a lot of</span> <span data-start="762.08" data-end="765.03">complications involved here and so add</span> <span data-start="765.03" data-end="766.29">up at upbeat we've been working on this</span> <span data-start="766.29" data-end="768.57">and if you don't want to spend all that</span> <span data-start="768.57" data-end="770.52">time doing it yourself you can can check</span> <span data-start="770.52" data-end="775.86">out of it it looks like this and that's</span> <span data-start="775.86" data-end="779.07">pretty much it actually that was 12</span> <span data-start="779.07" data-end="782.249">minutes</span> </p>
</section>