<section>
<p><span data-start="18.92" data-end="22.32">12 12 okay so I'm really here today to</span> <span data-start="22.32" data-end="23.88">introduce the children's book that I'm</span> <span data-start="23.88" data-end="26.519">writing about virtual machines and help</span> <span data-start="26.519" data-end="29.039">you wake up with some simple JavaScript</span> <span data-start="29.039" data-end="32.489">code well maybe not so my name is slow</span> <span data-start="32.489" data-end="34.2">and I'm a compiler engineer at Google</span> <span data-start="34.2" data-end="36">and I'm usually thinking about compiling</span> <span data-start="36" data-end="38.76">various languages into the various other</span> <span data-start="38.76" data-end="42.18">native languages native code but today I</span> <span data-start="42.18" data-end="43.92">will be talking about compiling other</span> <span data-start="43.92" data-end="45.51">languages in two languages the backyard</span> <span data-start="45.51" data-end="47.579">compiled to native code a very simple</span> <span data-start="47.579" data-end="49.98">stuff so and i will be using the small</span> <span data-start="49.98" data-end="53.07">talk as a first language that gets</span> <span data-start="53.07" data-end="54.899">compiled to something because i like the</span> <span data-start="54.899" data-end="56.34">small talk it's an awesome language and</span> </p>
<p><span data-start="56.34" data-end="58.109">I heard it's very easy to compile to</span> <span data-start="58.109" data-end="59.789">JavaScript if you put enough regular</span> <span data-start="59.789" data-end="63.87">expressions into your compiler and it is</span> <span data-start="63.87" data-end="65.909">so amazing this power of regular</span> <span data-start="65.909" data-end="68.22">expressions to get a very tight output</span> <span data-start="68.22" data-end="70.32">from your compiler which she looks</span> <span data-start="70.32" data-end="72.09">almost like something that the normal</span> </p>
<p><span data-start="72.09" data-end="74.189">JavaScript programmer would write and of</span> <span data-start="74.189" data-end="76.59">course it has zero overhead i'm planning</span> <span data-start="76.59" data-end="78.2">to patent it as soon as they return home</span> <span data-start="78.2" data-end="82.5">so however there is a small problem here</span> <span data-start="82.5" data-end="84.479">if i try to run this program in</span> <span data-start="84.479" data-end="86.189">Smalltalk trying to compute a dot</span> <span data-start="86.189" data-end="89.43">product of a 10 and the vector i get an</span> <span data-start="89.43" data-end="91.59">error actually because the 10 does not</span> <span data-start="91.59" data-end="94.68">understand the message x and in</span> </p>
<p><span data-start="94.68" data-end="97.38">JavaScript I get not a number everybody</span> <span data-start="97.38" data-end="101.579">likes not a number in JavaScript so and</span> <span data-start="101.579" data-end="103.439">this problem really repeats itself again</span> <span data-start="103.439" data-end="105.42">and again when people release compilers</span> <span data-start="105.42" data-end="107.189">for different languages into JavaScript</span> <span data-start="107.189" data-end="109.71">because they forget about one very small</span> <span data-start="109.71" data-end="112.259">detail it's called semantic in German</span> <span data-start="112.259" data-end="115.13">and this word comes from a Greek word</span> <span data-start="115.13" data-end="117.899">everybody can read Greek which actually</span> <span data-start="117.899" data-end="119.909">means significant and how would we call</span> <span data-start="119.909" data-end="122.009">compiler that forgets a significant</span> <span data-start="122.009" data-end="124.14">thing about the source language we call</span> <span data-start="124.14" data-end="127.829">this compiler hm so how make a compiler</span> <span data-start="127.829" data-end="130.619">that is not a xem well there is one easy</span> <span data-start="130.619" data-end="133.24">way for example in</span> <span data-start="133.24" data-end="135.52">small talk everything even the binary</span> <span data-start="135.52" data-end="137.8">operations on numbers are messages that</span> <span data-start="137.8" data-end="139.78">you send to your objects so you can</span> <span data-start="139.78" data-end="141.37">instead for using the JavaScript</span> <span data-start="141.37" data-end="144.91">operators for computing like Sam and</span> <span data-start="144.91" data-end="147.82">multiplication you just send a message</span> <span data-start="147.82" data-end="150.22">using this small utility function that</span> <span data-start="150.22" data-end="152.59">you write called send and this of course</span> <span data-start="152.59" data-end="154.51">looks a little bit slow if you write it</span> <span data-start="154.51" data-end="156.76">like that in JavaScript so let's confirm</span> <span data-start="156.76" data-end="158.65">it by benchmarking and then put in</span> <span data-start="158.65" data-end="160.27">benchmarking in quotes because I don't</span> <span data-start="160.27" data-end="162.37">want anybody to call me out on bed</span> <span data-start="162.37" data-end="164.53">benchmarks in this talk because I'm just</span> <span data-start="164.53" data-end="167.14">using it to promote my ideas so I'm</span> <span data-start="167.14" data-end="169.81">cooking the numbers basically but I did</span> <span data-start="169.81" data-end="173.47">not tell you that please cut it out so I</span> <span data-start="173.47" data-end="175.03">wrote this small piece of JavaScript</span> <span data-start="175.03" data-end="178.6">code which just takes a an array of</span> <span data-start="178.6" data-end="180.76">vectors and then computes some of them</span> <span data-start="180.76" data-end="183.58">and then computes the length or length</span> <span data-start="183.58" data-end="186.46">squared of this the resulting vector</span> <span data-start="186.46" data-end="189.22">using the dot product and it makes no</span> <span data-start="189.22" data-end="190.69">sense but I like the benchmarks that</span> <span data-start="190.69" data-end="193.96">make no sense so and then I translated</span> <span data-start="193.96" data-end="195.67">it to my small talk ified version of</span> </p>
<p><span data-start="195.67" data-end="197.17">Java Script where everything is replaced</span> <span data-start="197.17" data-end="200.2">with message sense to object and and</span> <span data-start="200.2" data-end="201.58">when you see the code on my slides don't</span> <span data-start="201.58" data-end="204.61">try to read all the code just let it go</span> <span data-start="204.61" data-end="206.35">into your brain and when you sleep in</span> <span data-start="206.35" data-end="208.18">tonight you will suddenly have an</span> <span data-start="208.18" data-end="209.65">Enlightenment what actually went there</span> <span data-start="209.65" data-end="214.99">King so then I wrote this sent function</span> <span data-start="214.99" data-end="217.45">that just sends a message to the object</span> <span data-start="217.45" data-end="219.91">very simple apply slice call arguments</span> <span data-start="219.91" data-end="222.58">to yeah everybody writes code like that</span> <span data-start="222.58" data-end="225.28">because it's JavaScript and so cool and</span> <span data-start="225.28" data-end="227.44">then because I am also kind of evil I</span> <span data-start="227.44" data-end="229.18">also put some stuff on the number</span> <span data-start="229.18" data-end="230.86">prototype because i want to send message</span> <span data-start="230.86" data-end="233.92">plus to the numbers and i want to send</span> <span data-start="233.92" data-end="235.78">message add to array so i just modified</span> <span data-start="235.78" data-end="238.06">the prototypes of array and number so</span> <span data-start="238.06" data-end="240.76">that just works out of the box and then</span> <span data-start="240.76" data-end="243.31">a benchmark and lo and behold it's only</span> <span data-start="243.31" data-end="244.84">five thousand times slower than the</span> <span data-start="244.84" data-end="248.74">baseline version it's actually fine</span> <span data-start="248.74" data-end="250.75">because that's the speed the JavaScript</span> <span data-start="250.75" data-end="254.22">used to run just ten years ago so</span> <span data-start="254.22" data-end="257.47">however the reason for that is simple we</span> <span data-start="257.47" data-end="258.91">made it too complicated for VA to</span> <span data-start="258.91" data-end="260.38">optimize there is a single congestion</span> <span data-start="260.38" data-end="262.57">point in our code through which all the</span> <span data-start="262.57" data-end="263.979">message sends are going this sent</span> <span data-start="263.979" data-end="266.229">function and actually wrote it in the</span> <span data-start="266.229" data-end="267.17">way that cannot</span> <span data-start="267.17" data-end="269.3">optimized by v8 if I think that I can</span> <span data-start="269.3" data-end="271.88">get maybe a factor of 10 speed up but it</span> <span data-start="271.88" data-end="274.07">will not be enough the factor of four</span> <span data-start="274.07" data-end="275.39">hundred it will still be missing there</span> <span data-start="275.39" data-end="279.17">so yeah Jovi it cannot do anything it</span> <span data-start="279.17" data-end="281.75">just calls and calls sent in our hot</span> <span data-start="281.75" data-end="285.35">loop so does it mean that v8 or does it</span> <span data-start="285.35" data-end="286.64">mean that the universal vm the</span> <span data-start="286.64" data-end="288.14">javascript as a universal vm for other</span> <span data-start="288.14" data-end="291.32">languages is just a Fed live well i</span> <span data-start="291.32" data-end="292.88">don't believe that because actually</span> <span data-start="292.88" data-end="294.56">believe that is a superhero that</span> <span data-start="294.56" data-end="296.92">can save us all it just needs a sidekick</span> <span data-start="296.92" data-end="299.45">that would help it to solve to save us</span> <span data-start="299.45" data-end="302.78">all hmm and i was searching for this</span> <span data-start="302.78" data-end="305.36">sidekick and then i realized that there</span> <span data-start="305.36" data-end="307.1">is another language in the world which</span> <span data-start="307.1" data-end="309.71">claims to have a great vm and the</span> <span data-start="309.71" data-end="312.02">vibrant ecosystem of libraries and so on</span> <span data-start="312.02" data-end="313.61">and so forth and they have a lot of</span> <span data-start="313.61" data-end="315.46">languages that compiled to this vm and</span> <span data-start="315.46" data-end="317.96">people like it and of course this</span> <span data-start="317.96" data-end="320.63">language is java the what they used to</span> <span data-start="320.63" data-end="322.46">run different languages human javascript</span> <span data-start="322.46" data-end="324.65">on the GV m which is originally was a</span> <span data-start="324.65" data-end="327.23">virtual machine for static statically</span> <span data-start="327.23" data-end="328.97">typed programming languages like Java</span> <span data-start="328.97" data-end="333.2">well it was only BM for java so they</span> <span data-start="333.2" data-end="336.17">introduced this bytecode into the vm</span> <span data-start="336.17" data-end="338.06">that allows them to have a dynamic</span> <span data-start="338.06" data-end="340.79">behavior and we can start reading a lot</span> <span data-start="340.79" data-end="343.04">of text about the invoke dynamic</span> <span data-start="343.04" data-end="345.68">specification and sooner or later maybe</span> <span data-start="345.68" data-end="348.05">a week or two in this text will figure</span> <span data-start="348.05" data-end="349.85">out this invoke dynamic is somehow</span> <span data-start="349.85" data-end="352.19">related to the call site sing and then</span> <span data-start="352.19" data-end="353.96">oh there are even more texts describing</span> <span data-start="353.96" data-end="356.12">what course itís it's truly like java a</span> <span data-start="356.12" data-end="358.07">lot of text so let me highlight you the</span> <span data-start="358.07" data-end="361.61">most important part of this text</span> <span data-start="361.61" data-end="364.909">so we know what variable is in</span> </p>
<p><span data-start="364.909" data-end="367.46">JavaScript and if we store function into</span> <span data-start="367.46" data-end="369.319">a variable and then what happens the</span> <span data-start="369.319" data-end="371.539">behavior of the call of this through</span> <span data-start="371.539" data-end="374.24">this variable changes as we change the</span> <span data-start="374.24" data-end="375.49">value that is stored in the variable</span> <span data-start="375.49" data-end="379.039">basically enlightenment in JavaScript</span> <span data-start="379.039" data-end="380.689">every invoke is already dynamic so we</span> <span data-start="380.689" data-end="384.199">don't need this stuff and we can easily</span> <span data-start="384.199" data-end="387.169">map things from the GBM specification</span> <span data-start="387.169" data-end="389.629">into the javascript cause i think that</span> <span data-start="389.629" data-end="392.18">the heaven java is just a variable the</span> <span data-start="392.18" data-end="393.83">invoke dynamic instruction is just an</span> <span data-start="393.83" data-end="395.93">invocation through that variable method</span> </p>
<p><span data-start="395.93" data-end="397.61">Kendall thing that is actually stored in</span> <span data-start="397.61" data-end="399.56">the call site in Java is just a closure</span> <span data-start="399.56" data-end="402.83">and relinking action that happens when</span> <span data-start="402.83" data-end="404.599">you change the target of the call side</span> <span data-start="404.599" data-end="409.669">is just an operator equals done so let's</span> <span data-start="409.669" data-end="411.529">use it to make our code run with a speed</span> <span data-start="411.529" data-end="413.689">of I don't know sick elephant or</span> <span data-start="413.689" data-end="416.569">actually healthy elephant so we used to</span> <span data-start="416.569" data-end="418.939">have this edition in my micro benchmark</span> <span data-start="418.939" data-end="420.74">somewhere I did not sure where but</span> <span data-start="420.74" data-end="423.71">believe me it was there so and then I</span> <span data-start="423.71" data-end="425.569">rewrote it in a nice and tight way with</span> <span data-start="425.569" data-end="429.56">a small talk sense and now we are doing</span> <span data-start="429.56" data-end="431.539">the invoke dynamic thing for each sent</span> <span data-start="431.539" data-end="434.479">that will use to send like st. X colon</span> <span data-start="434.479" data-end="437.15">we just introduce a special global</span> <span data-start="437.15" data-end="439.069">variable which will be specialized for</span> <span data-start="439.069" data-end="440.99">this scent and so on so forth for each</span> <span data-start="440.99" data-end="443.539">sent in the program and of course we</span> <span data-start="443.539" data-end="445.25">could initialize them in this simple way</span> <span data-start="445.25" data-end="446.69">but this will not give us any</span> <span data-start="446.69" data-end="447.919">performance right we're just doing the</span> <span data-start="447.919" data-end="449.24">same stuff that we used to do and we</span> <span data-start="449.24" data-end="453.11">know it's a 5,000 times slower so what</span> <span data-start="453.11" data-end="454.55">we are going to do instead will be more</span> </p>
<p><span data-start="454.55" data-end="456.319">Java like and use object-oriented</span> <span data-start="456.319" data-end="458.9">programming to solve other issues we</span> <span data-start="458.9" data-end="460.58">introduced the thing that encapsulates</span> <span data-start="460.58" data-end="463.37">the management of the of this global</span> <span data-start="463.37" data-end="465.08">variable it knows which message we want</span> <span data-start="465.08" data-end="466.58">to send through this global variable and</span> <span data-start="466.58" data-end="469.099">then it also knows how to produce the</span> <span data-start="469.099" data-end="471.289">small closure and patch it into this</span> <span data-start="471.289" data-end="473.629">global variable so there is a lot of</span> <span data-start="473.629" data-end="475.939">code here it actually does that and I</span> <span data-start="475.939" data-end="477.439">don't want you to read all of it as I</span> <span data-start="477.439" data-end="478.789">said so let me highlight the most</span> <span data-start="478.789" data-end="480.529">important part so this bootstrapping</span> <span data-start="480.529" data-end="482.479">procedure for this global variable it</span> <span data-start="482.479" data-end="484.699">consists of the compilation of handlers</span> <span data-start="484.699" data-end="487.61">that will handle this send side and then</span> <span data-start="487.61" data-end="489.8">we just linked it into the call side so</span> <span data-start="489.8" data-end="491.99">a compilation is Lou to a lot of black</span> <span data-start="491.99" data-end="494.029">voodoo magic it has to string on the</span> <span data-start="494.029" data-end="495.35">function and then users</span> <span data-start="495.35" data-end="497.54">load a show on the score doesn't matter</span> <span data-start="497.54" data-end="499.91">so what it essentially does it plays a</span> <span data-start="499.91" data-end="502.4">little bit of PHP with your source code</span> <span data-start="502.4" data-end="507.35">so it takes some things and splices them</span> <span data-start="507.35" data-end="508.79">into the source code like for example</span> <span data-start="508.79" data-end="510.2">here you can splice the list of</span> <span data-start="510.2" data-end="512.9">arguments into the function and then you</span> <span data-start="512.9" data-end="515.21">can splice the operation that depends on</span> <span data-start="515.21" data-end="516.47">these arguments and there is also this</span> <span data-start="516.47" data-end="518.78">unique identifier built in this is to</span> <span data-start="518.78" data-end="520.729">trick create to distinguish the</span> <span data-start="520.729" data-end="522.38">different handles that we are manually</span> <span data-start="522.38" data-end="524.69">compiling because otherwise it will just</span> <span data-start="524.69" data-end="526.88">merge those of them that textually match</span> <span data-start="526.88" data-end="528.2">together because it has a compilation</span> <span data-start="528.2" data-end="532.49">cash so here's how example the scent</span> <span data-start="532.49" data-end="535.16">that sends a message X to the object and</span> <span data-start="535.16" data-end="538.27">this is the message + send to an object</span> <span data-start="538.27" data-end="541.49">so and linking as i said is just storing</span> <span data-start="541.49" data-end="543.65">the handler which is our closure into</span> <span data-start="543.65" data-end="545.57">the global variable with a given name</span> <span data-start="545.57" data-end="548.45">very simple and we are now only three</span> <span data-start="548.45" data-end="551.33">times slower so we regained like a</span> <span data-start="551.33" data-end="553.01">factor of thousand and performance</span> <span data-start="553.01" data-end="557.36">success and the reason why we are slow</span> <span data-start="557.36" data-end="558.95">if we look in the intermediate</span> <span data-start="558.95" data-end="560.96">representation of the code that we got</span> <span data-start="560.96" data-end="565.01">from running this benchmark is that v8</span> <span data-start="565.01" data-end="568.51">went completely berserk with numerics</span> <span data-start="568.51" data-end="570.59">basically iteration variable that was</span> <span data-start="570.59" data-end="573.74">integer in the quad loop became suddenly</span> <span data-start="573.74" data-end="575.45">a double and it's constantly baktun</span> <span data-start="575.45" data-end="580.12">unbox consuming all our performance so</span> <span data-start="580.12" data-end="582.53">it's because we have a single congestion</span> <span data-start="582.53" data-end="584.27">point for numeric steal it's this</span> <span data-start="584.27" data-end="585.53">function that we patched into the</span> <span data-start="585.53" data-end="588.02">prototype of the number and all the</span> <span data-start="588.02" data-end="590.78">operations with numbers be they integers</span> <span data-start="590.78" data-end="592.34">or doubles they go in through the single</span> <span data-start="592.34" data-end="594.98">congestion point how do we solve it well</span> <span data-start="594.98" data-end="596.48">we already learned how we can solve the</span> <span data-start="596.48" data-end="598.49">same tissue we just need to put this end</span> <span data-start="598.49" data-end="600.59">into the handler so we need to put this</span> <span data-start="600.59" data-end="603.05">arithmetic into the handler specialized</span> <span data-start="603.05" data-end="606.26">the handler for the arithmetic we change</span> <span data-start="606.26" data-end="608.54">the template in a way that it now does</span> <span data-start="608.54" data-end="610.46">the check before it does the operation</span> <span data-start="610.46" data-end="612.68">and if it the check failed it goes and</span> <span data-start="612.68" data-end="614.75">handles it somewhere else in a</span> <span data-start="614.75" data-end="618.95">site-specific way ha so for numbers the</span> <span data-start="618.95" data-end="620.36">check is obvious you just need to check</span> <span data-start="620.36" data-end="621.77">that the left side and the right hand</span> <span data-start="621.77" data-end="626.36">side of the operation is a number and if</span> <span data-start="626.36" data-end="628.04">it is we just perform the operation in</span> <span data-start="628.04" data-end="629.18">the fast way instead of even you</span> <span data-start="629.18" data-end="633.56">in the call on the message so this is</span> <span data-start="633.56" data-end="636.59">how the scent of operation less than now</span> <span data-start="636.59" data-end="638.69">looks like a whiskey check left side</span> <span data-start="638.69" data-end="641.39">right side if there are numbers you just</span> <span data-start="641.39" data-end="642.47">return the result of this operation</span> <span data-start="642.47" data-end="646.15">otherwise you go into the mists case and</span> <span data-start="646.15" data-end="648.08">now we are only twenty five percent</span> <span data-start="648.08" data-end="650.33">slower so we solved most of the</span> <span data-start="650.33" data-end="653.87">performance issues that we had and the</span> <span data-start="653.87" data-end="655.22">twenty-five percent thing might be</span> <span data-start="655.22" data-end="656.96">scaring you but actually when you look</span> <span data-start="656.96" data-end="659.36">in the code that we had produced you see</span> <span data-start="659.36" data-end="661.46">the picture is nice and actually better</span> <span data-start="661.46" data-end="663.38">than I expected when I was testing this</span> <span data-start="663.38" data-end="667.34">because these things that are gray on</span> <span data-start="667.34" data-end="669.11">the picture I actually the false cases</span> <span data-start="669.11" data-end="671.9">of type of equals equals number</span> <span data-start="671.9" data-end="674.63">comparisons v8 was able to figure out</span> <span data-start="674.63" data-end="676.16">that certain things are definitely</span> <span data-start="676.16" data-end="678.41">numbers so all our Miss cases are</span> <span data-start="678.41" data-end="683.27">unreachable and optimized away so we are</span> <span data-start="683.27" data-end="686.27">good the hope is back maybe we can run</span> <span data-start="686.27" data-end="688.49">small talk efficiently on the JavaScript</span> <span data-start="688.49" data-end="691.73">engine however the bad part is the</span> <span data-start="691.73" data-end="693.71">semantics is still broken if I try to</span> <span data-start="693.71" data-end="695.09">send this message that I was trying to</span> <span data-start="695.09" data-end="696.71">send in the beginning I discovered that</span> <span data-start="696.71" data-end="698.33">is not a function this is</span> <span data-start="698.33" data-end="701.93">universal truth and mmm however this</span> <span data-start="701.93" data-end="703.55">universal truth doesn't apply to small</span> <span data-start="703.55" data-end="704.99">talk because there is no  there</span> <span data-start="704.99" data-end="707.9">something is still worked in the scheme</span> <span data-start="707.9" data-end="712.07">of dynamic programming languages how can</span> <span data-start="712.07" data-end="715.4">we solve that well we know how we can</span> <span data-start="715.4" data-end="716.96">solve it we can say which message</span> <span data-start="716.96" data-end="719.12">messages the vector understands it</span> <span data-start="719.12" data-end="722.3">understands x.x call an eager why why</span> <span data-start="722.3" data-end="725.18">call and so on and i'm using echo script</span> <span data-start="725.18" data-end="726.5">six features because Sigma script 6</span> <span data-start="726.5" data-end="731.99">which is a cool like set so however we</span> <span data-start="731.99" data-end="733.58">don't know how to rewrite the handler we</span> <span data-start="733.58" data-end="735.2">want to have a check and then we want to</span> <span data-start="735.2" data-end="737.15">send the message directly but you don't</span> <span data-start="737.15" data-end="738.68">know what we can check we can check for</span> <span data-start="738.68" data-end="741.92">example something like this we can ask</span> <span data-start="741.92" data-end="744.05">the constructor of the receiver whether</span> <span data-start="744.05" data-end="746.78">it has this set and it understands the x</span> <span data-start="746.78" data-end="750.29">and then we call X so it looks</span> <span data-start="750.29" data-end="752.6">reasonable however it is very hard for</span> <span data-start="752.6" data-end="754.4">v8 to optimize because it doesn't see</span> <span data-start="754.4" data-end="756.14">the connection between the constructor</span> <span data-start="756.14" data-end="757.91">of an object and the fact that it has</span> <span data-start="757.91" data-end="760.07">this set and the fact that this set is</span> <span data-start="760.07" data-end="761.63">actually mutable there is no way to tell</span> <span data-start="761.63" data-end="762.769">it that this set is a mute</span> <span data-start="762.769" data-end="765.379">so it can't optimize that however one</span> <span data-start="765.379" data-end="766.97">thing that we it can do efficiently is</span> <span data-start="766.97" data-end="768.829">the load constructor from an object if</span> <span data-start="768.829" data-end="770.72">it already knows the objects hidden</span> <span data-start="770.72" data-end="774.769">class so we just will compare the</span> <span data-start="774.769" data-end="776.869">constructor of an object with some value</span> <span data-start="776.869" data-end="780.709">and then do a message sent directly but</span> <span data-start="780.709" data-end="782.6">unlike with a number case we don't know</span> <span data-start="782.6" data-end="784.279">with what to compare ahead of time when</span> <span data-start="784.279" data-end="786.199">we bootstrap the handler for the hour</span> <span data-start="786.199" data-end="788.6">send side so we need to obtain this</span> <span data-start="788.6" data-end="791.059">value somewhere as our program runs and</span> <span data-start="791.059" data-end="794.629">the way we can do it is we can remember</span> <span data-start="794.629" data-end="797.209">that we can relink call site as a our</span> <span data-start="797.209" data-end="801.739">sin side as the program executes and</span> <span data-start="801.739" data-end="804.41">this is where the power of this system</span> <span data-start="804.41" data-end="808.22">with sin sites adapting to the things</span> <span data-start="808.22" data-end="812.149">they see comes from so the solution is</span> <span data-start="812.149" data-end="814.369">to put strap and initialized handler and</span> <span data-start="814.369" data-end="817.04">then relink it when we miss so the</span> <span data-start="817.04" data-end="818.629">bootstrap function is now very simple</span> <span data-start="818.629" data-end="820.249">it's just always misses it always goes</span> <span data-start="820.249" data-end="823.6">to this site that means thing and</span> <span data-start="823.6" data-end="825.709">because the check is specified to be</span> <span data-start="825.709" data-end="830.24">false then when we miss in the Miss case</span> <span data-start="830.24" data-end="832.879">we can check if the constructor has the</span> <span data-start="832.879" data-end="834.619">understanding and the understand</span> <span data-start="834.619" data-end="838.279">declares that this object understands</span> <span data-start="838.279" data-end="841.519">this message then we can compile a</span> <span data-start="841.519" data-end="843.319">specialized handler for this particular</span> <span data-start="843.319" data-end="845.66">constructor and link it into this site</span> <span data-start="845.66" data-end="848.449">otherwise you throw this nice message</span> <span data-start="848.449" data-end="850.009">that says this object does not</span> <span data-start="850.009" data-end="855.439">understand this message okay the</span> <span data-start="855.439" data-end="857.029">template now looks something like that</span> <span data-start="857.029" data-end="859.579">so we have the constructor captured as a</span> <span data-start="859.579" data-end="862.429">closure variable in the tender itself</span> <span data-start="862.429" data-end="864.199">and we compare the constructor against</span> <span data-start="864.199" data-end="868.04">it and we send the message directly nice</span> <span data-start="868.04" data-end="872.059">and efficient you will say however we</span> <span data-start="872.059" data-end="873.439">just lost all of the performance that we</span> <span data-start="873.439" data-end="875.869">previously gained somehow so something</span> <span data-start="875.869" data-end="879.11">in our calculations was wrong and the</span> <span data-start="879.11" data-end="881.709">thing that was wrong there was our</span> <span data-start="881.709" data-end="884.48">assumption that we ate will behave nice</span> <span data-start="884.48" data-end="887.72">and tight with us but it really decided</span> <span data-start="887.72" data-end="888.799">that it doesn't want to inline the</span> <span data-start="888.799" data-end="890.689">handlers for us anymore after we're a</span> <span data-start="890.689" data-end="894.169">link them that's because the v8 has</span> <span data-start="894.169" data-end="896.06">these guys built in the</span> <span data-start="896.06" data-end="897.71">run around and try to figure out what</span> <span data-start="897.71" data-end="899.66">your program is actually doing and how</span> <span data-start="899.66" data-end="902.54">to optimize it however they're not only</span> <span data-start="902.54" data-end="905.63">smart enough so we need to help them be</span> <span data-start="905.63" data-end="912.23">smarter stop how much I'm so I went into</span> <span data-start="912.23" data-end="916.31">the source code of the v8 and this is</span> <span data-start="916.31" data-end="919.55">not JavaScript the C C++ and I found</span> <span data-start="919.55" data-end="922.34">that there is a heuristic which checks</span> <span data-start="922.34" data-end="923.87">whether the function that we are trying</span> <span data-start="923.87" data-end="927.35">to in line is an old function so it</span> <span data-start="927.35" data-end="928.91">survived a lot of garbage collections</span> <span data-start="928.91" data-end="931.01">and if it is then it is worth it to in</span> <span data-start="931.01" data-end="933.23">line otherwise it is not worth it</span> <span data-start="933.23" data-end="934.88">because it potentially can change it was</span> <span data-start="934.88" data-end="938.21">just created so I just treat this</span> <span data-start="938.21" data-end="940.88">heuristic to be very smart and if the</span> <span data-start="940.88" data-end="942.53">name of the global variable starts with</span> <span data-start="942.53" data-end="945.08">the Greek letter Sigma Capital then we</span> <span data-start="945.08" data-end="948.77">in line no matter what a great solution</span> </p>
<p><span data-start="948.77" data-end="950.81">I'm not going to submit this page to v8</span> <span data-start="950.81" data-end="953.78">because it's unlikely that it will be</span> <span data-start="953.78" data-end="955.37">accepted though I think it's cool</span> <span data-start="955.37" data-end="956.66">because nobody also calls their</span> <span data-start="956.66" data-end="958.58">functions with a Greek letter Sigma in</span> <span data-start="958.58" data-end="960.17">the beginning so it will be a fine</span> <span data-start="960.17" data-end="965.78">heuristic and with this we regained then</span> <span data-start="965.78" data-end="966.95">excellent in terms of the performance</span> <span data-start="966.95" data-end="968.87">because now we in line the handlers</span> <span data-start="968.87" data-end="971.69">however there is still a problem with</span> <span data-start="971.69" data-end="976.85">our code so i can sumption that the boss</span> <span data-start="976.85" data-end="978.74">left hand side and the right hand side</span> <span data-start="978.74" data-end="980.57">of the comparison that we use in the</span> <span data-start="980.57" data-end="986.03">check are constants and it is true for</span> <span data-start="986.03" data-end="988.16">the self dot constructor expression we</span> <span data-start="988.16" data-end="990.35">it was able to figure out that it is a</span> <span data-start="990.35" data-end="992.42">constant however the constructor</span> <span data-start="992.42" data-end="994.7">variable that is captured in the context</span> <span data-start="994.7" data-end="997.66">of the handler closure is not a constant</span> <span data-start="997.66" data-end="1001.86">it just loaded from the context and the</span> <span data-start="1001.86" data-end="1004.48">context itself is a constant so he</span> <span data-start="1004.48" data-end="1006.19">strange the tree it did not fall these</span> <span data-start="1006.19" data-end="1008.47">things together so i took my precision</span> <span data-start="1008.47" data-end="1011.47">hammer again and i went into v8 again</span> <span data-start="1011.47" data-end="1013.99">and then i edit these lines of code they</span> <span data-start="1013.99" data-end="1016.54">just say if the variable that is in the</span> <span data-start="1016.54" data-end="1018.43">context is never assigned after it was</span> <span data-start="1018.43" data-end="1021.34">initialized and the context itself is no</span> <span data-start="1021.34" data-end="1023.11">during compilation time then we can just</span> <span data-start="1023.11" data-end="1024.94">load it in the compilation time because</span> <span data-start="1024.94" data-end="1027.19">it is totally it's true that it will</span> <span data-start="1027.19" data-end="1029.779">never change and then you can use it as</span> <span data-start="1029.779" data-end="1032.539">constant constant yes otherwise you just</span> <span data-start="1032.539" data-end="1036.139">do the normal load and we are almost</span> <span data-start="1036.139" data-end="1037.879">there where we want it to be we're only</span> <span data-start="1037.879" data-end="1041.209">twenty-five percent slower again and you</span> <span data-start="1041.209" data-end="1043.249">can implement the ad thing so there's a</span> <span data-start="1043.249" data-end="1044.719">thing we set is that you want to check</span> <span data-start="1044.719" data-end="1047.119">bounced when you do the scent of add to</span> <span data-start="1047.119" data-end="1049.309">the array you also don't want to patch</span> <span data-start="1049.309" data-end="1052.309">array prototype anymore so you can use</span> <span data-start="1052.309" data-end="1055.129">it the same techniques to produce a</span> <span data-start="1055.129" data-end="1056.929">specialized handler for the ad Colin</span> <span data-start="1056.929" data-end="1060.83">send and even if after you do it you</span> <span data-start="1060.83" data-end="1062.179">still will be only twenty-five percent</span> <span data-start="1062.179" data-end="1063.919">slower so you don't lose any performance</span> <span data-start="1063.919" data-end="1067.58">so we are good we're perfect and the</span> <span data-start="1067.58" data-end="1069.95">semantics is now correct if I try to</span> <span data-start="1069.95" data-end="1071.869">send this dot colon message to the</span> <span data-start="1071.869" data-end="1074.509">vector I get the nice error that object</span> <span data-start="1074.509" data-end="1076.7">n doesn't understand x and if i try to</span> <span data-start="1076.7" data-end="1079.129">access the array out of bounds and like</span> <span data-start="1079.129" data-end="1080.599">in javascript where you get the</span> <span data-start="1080.599" data-end="1082.249">and then undefined is not a</span> <span data-start="1082.249" data-end="1086.749">function you get a nice error you can</span> <span data-start="1086.749" data-end="1088.219">ask me where are those twenty five</span> <span data-start="1088.219" data-end="1091.779">percent and i could spend another talk</span> <span data-start="1091.779" data-end="1093.71">trying to explain where they're coming</span> <span data-start="1093.71" data-end="1095.33">from basically their deficiencies in the</span> <span data-start="1095.33" data-end="1097.849">compilation pipeline but the timer here</span> <span data-start="1097.849" data-end="1100.419">is very scary so i will not do that so</span> <span data-start="1100.419" data-end="1104.45">if i use the hammer long enough then</span> <span data-start="1104.45" data-end="1106.249">they can regain almost all of it by</span> <span data-start="1106.249" data-end="1108.789">hacking in various parts of the v8</span> <span data-start="1108.789" data-end="1110.719">basically it's the register allocator</span> <span data-start="1110.719" data-end="1114.71">issues and various optimizations and i'm</span> <span data-start="1114.71" data-end="1116.57">positive that you can regain even more</span> <span data-start="1116.57" data-end="1120.139">you just need to use a bigger hammer and</span> <span data-start="1120.139" data-end="1121.669">it's actually depends on the cpu because</span> <span data-start="1121.669" data-end="1123.229">they produced code i looked at it in the</span> <span data-start="1123.229" data-end="1126.469">disassembler it's almost the same but is</span> <span data-start="1126.469" data-end="1128.719">for this hot look that I cooked for this</span> <span data-start="1128.719" data-end="1132.289">before for this talk and then when I ran</span> <span data-start="1132.289" data-end="1133.639">it on different machines it behaves</span> <span data-start="1133.639" data-end="1134.749">differently for example on my</span> <span data-start="1134.749" data-end="1137.96">workstation at work it is roughly the</span> <span data-start="1137.96" data-end="1140.419">same performance with the baseline</span> <span data-start="1140.419" data-end="1144.859">version so during the course of this</span> <span data-start="1144.859" data-end="1147.379">talk you should have figured out the</span> </p>
<p><span data-start="1147.379" data-end="1149.57">JavaScript itself is an invoke dynamic</span> <span data-start="1149.57" data-end="1153.799">one big invoke dynamic and we have</span> <span data-start="1153.799" data-end="1155.719">enough expressivity in the language that</span> <span data-start="1155.719" data-end="1159.619">to actually solve these problems what we</span> <span data-start="1159.619" data-end="1161.33">don't have enough of these optimizations</span> <span data-start="1161.33" data-end="1163.34">so their VMS are almost there</span> <span data-start="1163.34" data-end="1166.07">not entirely there because well they're</span> <span data-start="1166.07" data-end="1168.89">not completely optimized for this use</span> <span data-start="1168.89" data-end="1172.03">case of compiling the dynamic</span> <span data-start="1172.03" data-end="1173.75">programming languages into the</span> <span data-start="1173.75" data-end="1178.25">JavaScript so we want to get rid of the</span> <span data-start="1178.25" data-end="1180.41">heuristics that govern this inlining and</span> <span data-start="1180.41" data-end="1182.72">specialization and so on and we want to</span> <span data-start="1182.72" data-end="1185.45">have a set of conventions so invoke</span> <span data-start="1185.45" data-end="1186.86">dynamic for javascript is just a set of</span> <span data-start="1186.86" data-end="1188.54">conventions that would guarantee that</span> <span data-start="1188.54" data-end="1190.31">the certain functions are always in line</span> <span data-start="1190.31" data-end="1192.47">on all virtual machines that run</span> </p>
<p><span data-start="1192.47" data-end="1196.58">JavaScript and so on and we will use</span> <span data-start="1196.58" data-end="1199.01">those conventions to squash all these</span> <span data-start="1199.01" data-end="1201.68">cockroaches like slipper you use when</span> <span data-start="1201.68" data-end="1203.65">you want to squash cockroaches and</span> <span data-start="1203.65" data-end="1205.94">actually the oldest presentation is</span> <span data-start="1205.94" data-end="1207.35">alive because there is a much harder</span> <span data-start="1207.35" data-end="1209.48">thing to compile in smalltalk which is</span> <span data-start="1209.48" data-end="1213.71">the non-local return but well let's for</span> <span data-start="1213.71" data-end="1215.51">the next time so thank you for your</span> </p>
</section>