<section>
<p><span data-start="0.16" data-end="5.569">We Started Using Webpack and it Took a While — Salem Hilal</span> <span data-start="5.569" data-end="6.569"Audience member: Hello?</span> <span data-start="6.569" data-end="7.569">Hello, hi!, oh, my God, oh, my God, oh, my God, I'm so excited!</span> <span data-start="7.569" data-end="8.569">My coworker, Salem, is about to come up on stage and tell you about the migration process</span> <span data-start="8.569" data-end="9.86">of moving to Webpack and what a kind of disaster that was.</span> <span data-start="9.86" data-end="10.92">But it's a really interesting disaster, I promise.</span> <span data-start="10.92" data-end="12.53">So Salem gave me some fun facts but I'm going to go totally on my own and tell you my fun</span> <span data-start="12.53" data-end="13.53">facts and favorite things about Salem.</span> <span data-start="13.53" data-end="14.53">The first thing that you need to know about Salem is he gives the world's best hugs, literally,</span> <span data-start="14.53" data-end="15.53">so all of you need to be good-enough friends with him by the end of the conference so that</span> <span data-start="15.53" data-end="16.53">he could give you a hug and trust me, you will, like, love it for the rest of your life.</span> <span data-start="16.53" data-end="17.53">The other thing that you need to know about Salem is that we have regular Etsy-wide smash</span> <span data-start="17.53" data-end="18.53">tournaments, we had one the other night.</span> <span data-start="18.53" data-end="19.53">I was not there, but my husband went, and apparently do not let him play at duck hunt</span> <span data-start="19.53" data-end="20.53">because he will hide in the corner and throw beans at everybody.</span> </p>
<p><span data-start="20.53" data-end="21.53">All right, so everyone, gave it up for Salem Hilal.</span> <span data-start="21.53" data-end="22.53">[applause]</span> <span data-start="22.53" data-end="23.53">Oh, my gosh, that was the nicest thing that anyone has ever said about me.</span> <span data-start="23.53" data-end="24.53">It's also very bright up here, everyone's right, everybody said that already.</span> <span data-start="24.53" data-end="25.53">Thank you, Katie, I'll say thank you so much to everybody who has organized JSConf, it</span> <span data-start="25.53" data-end="26.53">is unreal to be up on stage.</span> <span data-start="26.53" data-end="27.53">I can hear my voice echo.</span> <span data-start="27.53" data-end="28.53">That makes it sound like I'm in a stadium, that's so cool.</span> <span data-start="28.53" data-end="29.53">My name is Salem, if you know about the cat, and my pronouns are he/him, and I work at</span> <span data-start="29.53" data-end="30.53">Etsy and we're hiring.</span> <span data-start="30.53" data-end="31.53">This is my very first conference talk, as well, so if you have any feedback for me,</span> <span data-start="31.53" data-end="32.53">please do not withhold it.</span> <span data-start="32.53" data-end="33.53">I would love to hear about it.</span> <span data-start="33.53" data-end="34.53">So.</span> <span data-start="34.53" data-end="41.37">OK, cool I wanted to talk about how we migrated from an in-house system to Webpack and specifically</span> </p>
<p><span data-start="41.37" data-end="47.63">I want to talk about why it took us so long to do that.</span> <span data-start="47.63" data-end="52.399">I work at a team at Etsy called the web platform team.</span> <span data-start="52.399" data-end="55.54">If you've ever worked at a place that has a front-end infrastructure team it's probably</span> <span data-start="55.54" data-end="62.769">very similar.</span> <span data-start="62.769" data-end="69.86">This talk is essentially about how we moved from one build system another, but this doesn't</span> <span data-start="69.86" data-end="78.861">mean I'm going to talk about  —  my goal here is to talk about the weird problems that we</span> <span data-start="78.861" data-end="81.61">unearthed and how we fixed them and where all my hair went.</span> <span data-start="81.61" data-end="82.61">[laughter]</span> <span data-start="82.61" data-end="86.57">So this talk is like about five parts.</span> <span data-start="86.57" data-end="89.63">I'm going to first tell you about a little bit about Etsy and our old build system that</span> <span data-start="89.63" data-end="101.48">we called Builda, and then this really weird rolling it out.</span> <span data-start="101.48" data-end="109.17">So that's going to be a fun one, so if the beginning parts are boring, at least stay</span> <span data-start="109.17" data-end="110.31">till the end.</span> <span data-start="110.31" data-end="115.39">So before I get into it, there are two caveats that are worth mentioning, number one, the</span> <span data-start="115.39" data-end="120.75">decisions that we made were true at the time we made them.</span> </p>
<p><span data-start="120.75" data-end="130.1">JavaScript as you all probably know changes very quickly, which is the whole reason that</span> <span data-start="130.1" data-end="134.37">we wanted a really flexible build system in the first place and No. 2, all of the things</span> <span data-start="134.37" data-end="136.93">that I'm going to talk about today are big team efforts.</span> <span data-start="136.93" data-end="147.28">I know a whole lot about how Etsy's front end infrastructure on behalf of my whole team</span> <span data-start="147.28" data-end="150.6">that kind of collectively built and researched all the things that I'm going to talk about</span> <span data-start="150.6" data-end="151.6">today.</span> <span data-start="151.6" data-end="154">They kick ass, and I really love working with them.</span> </p>
<p><span data-start="154" data-end="159.44">I think Joe is right up there somewhere in the front.</span> <span data-start="159.44" data-end="161.08">That's my teammate Joe.</span> <span data-start="161.08" data-end="173.26">There's also John and Natalia who are not here but they're great to work with.</span> <span data-start="173.26" data-end="177.07">It's hard to tell you about a migration process without giving you a little bit of context.</span> <span data-start="177.07" data-end="184.12">So here it is, this is Etsy's codebase, it's like anyone's codebase at a medium sized company.</span> <span data-start="184.12" data-end="186.27">Some.</span> <span data-start="186.27" data-end="198.31">That is to say, the code that makes Etsy show up in your web browser from the API all the</span> <span data-start="198.31" data-end="201.45">way down to the CSS lives in one.</span> <span data-start="201.45" data-end="208.05">We call our mono repoetsy web, it's worked surprisingly well for us, it has helped us</span> <span data-start="208.05" data-end="213.8">facilitate.</span> <span data-start="213.8" data-end="222.41">One thing that did not scale very well when we moved was the JavaScript part of our codebase.</span> </p>
<p><span data-start="222.41" data-end="225.6">And.</span> <span data-start="225.6" data-end="240.25">So this system is something that we named Builda.</span> <span data-start="240.25" data-end="245.94">For those of you who may not be familiar with JavaScript build systems, a build system is</span> <span data-start="245.94" data-end="251.52">something that takes our files, resolves their dependencies, bundles them together, makes</span> <span data-start="251.52" data-end="259.38">them as small and efficient as possible, and (audio is breaking out).</span> <span data-start="259.38" data-end="270.41">we got to hit play on this part.</span> <span data-start="270.41" data-end="282.55">It's going to be like a carnival game where I have to aim on the screen.</span> <span data-start="282.55" data-end="283.55">Boop?</span> <span data-start="283.55" data-end="284.55">One more time.</span> <span data-start="284.55" data-end="288.56">Yay, there it goes, so when BBuilda was first written, it wasn't this sleek interactive</span> <span data-start="288.56" data-end="294.91">home page that you see here, complete with cool animations and a responsive navigation</span> <span data-start="294.91" data-end="297.6">bar and a really cool branding.</span> </p>
<p><span data-start="297.6" data-end="304.09">It looked more like that.</span> <span data-start="304.09" data-end="307.78">Having one file depend on another was pretty infrequent and when that did happen it was</span> <span data-start="307.78" data-end="314.4">usually for large globally scoped libraries, like JQuery ..</span> <span data-start="314.4" data-end="321.56">Production builds took very little time.</span> <span data-start="321.56" data-end="323.06">At Etsy, this is pretty important.</span> <span data-start="323.06" data-end="327.31">We deploy code dozens of times in a single day and slowing down deployment is something</span> <span data-start="327.31" data-end="331.38">we'd try to avoid at all costs.</span> <span data-start="331.38" data-end="334.49">So developing JavaScript was similarly pretty simple.</span> <span data-start="334.49" data-end="336.84">That's supposed to be me.</span> </p>
<p><span data-start="336.84" data-end="341">If we load a page in development that requests some JavaScript, that JavaScript file would</span> <span data-start="341" data-end="345.01">be built from our source and sent back inside of one request.</span> <span data-start="345.01" data-end="349.48">To keep track of all the possible files that we might need to request, we kept a list of</span> <span data-start="349.48" data-end="352.18">all of them which we brilliantly called the build list.</span> <span data-start="352.18" data-end="355.65">When we served a file we'd make sure it was in that list somewhere.</span> <span data-start="355.65" data-end="359.46">The build list was used in production then later to determine the entirety of what we</span> <span data-start="359.46" data-end="365.669">needed to build when we deployed [inaudible] in development if a requested file was not</span> <span data-start="365.669" data-end="371.83">the build list we'd respond with some JavaScript that threw us an exception.</span> <span data-start="371.83" data-end="376.11">This ensured that we could essentially build any file we wanted on demand.</span> <span data-start="376.11" data-end="384.81">We used require.js to manage our delinquencies.</span> <span data-start="384.81" data-end="388.67">Maybe you haven't even heard of this because it's a relatively old library but we still</span> <span data-start="388.67" data-end="397.53">used it and it was pretty simple up until we moved to Webpack, that is.</span> <span data-start="397.53" data-end="400.13">We'd follow it down with some of our own code.</span> <span data-start="400.13" data-end="404.639">Require.js then allows our own code to use any style module definitions as you can see</span> <span data-start="404.639" data-end="405.639">here.</span> <span data-start="405.639" data-end="408.92">For some of you this might sound out of the stone age but for us it was pretty cutting</span> <span data-start="408.92" data-end="415.9">edge when we did this.</span> </p>
<p><span data-start="415.9" data-end="419.68">Async .. We defined an array of imports which require</span> <span data-start="419.68" data-end="424.32">then resolve for us.</span> <span data-start="424.32" data-end="427.89">All of our code goes to the body of one of these callbacks where it has access to all</span> <span data-start="427.89" data-end="429.83">of the imports.</span> <span data-start="429.83" data-end="434.62">Builda's job was to make sure that all of the necessary modules were bundled into one</span> <span data-start="434.62" data-end="439.87">JavaScript file so that require.js has access to everything it needed in the browser.</span> <span data-start="439.87" data-end="442.91">At some point, React came along.</span> <span data-start="442.91" data-end="448.11">React is just a library that makes writing large, client-side applications a lot easier.</span> <span data-start="448.11" data-end="453.81">Sometime around 2016, we decided it would be a really good fit for some of our seller</span> <span data-start="453.81" data-end="455.74">tools.</span> <span data-start="455.74" data-end="456.74">Everyone was excited.</span> <span data-start="456.74" data-end="462.9">React, however, strongly relies on a syntax that looks like HTML controversially aligned</span> <span data-start="462.9" data-end="463.9">into JavaScript.</span> </p>
<p><span data-start="463.9" data-end="467.462">If you want to be able to use this syntax, we need to make a build system that it can</span> <span data-start="467.462" data-end="474.28">do more than just build files together.</span> <span data-start="474.28" data-end="476.74">So we used an old version of.</span> <span data-start="476.74" data-end="484.52">(Audio breaking out) So it's a stapler.</span> <span data-start="484.52" data-end="496.48">I added the staples last night.</span> </p>
<p><span data-start="496.48" data-end="501.751">There was one problem with this setup, however, because we built every file only when it was</span> <span data-start="501.751" data-end="506.09">requested rather than when some part of it was edited we had no way of knowing if it</span> <span data-start="506.09" data-end="509.229">had changed or not since the last time it was requested.</span> <span data-start="509.229" data-end="513.719">So we had to rebuild every asset every time we wanted to use it.</span> <span data-start="513.719" data-end="520.969">Transpiling JSX into JavaScript  —  so React heavily ended up taking a good bit longer</span> <span data-start="520.969" data-end="523.74">in order to be served.</span> <span data-start="523.74" data-end="530.629">But JSX was new, so few few people felt the pain of long rebuild times in development.</span> <span data-start="530.629" data-end="534.449">Besides, it's just JavaScript, right?</span> <span data-start="534.449" data-end="538.139">We know it didn't last very long.</span> <span data-start="538.139" data-end="542.58">All of these quirks together meant that loading something large, like a single-page app implied</span> <span data-start="542.58" data-end="547.149">rebuilding the entire thing from scratch every time the page reloaded, plus our codebase</span> <span data-start="547.149" data-end="556.529">was only getting bigger, we had over 1,000 separate JavaScript assets to output.</span> <span data-start="556.529" data-end="560.379">React code was use in a lot more places and it started to take the better part of a minute</span> <span data-start="560.379" data-end="564.899">to show up on the page in development which made iterating very, very tedious, on top</span> <span data-start="564.899" data-end="568.329">of this, developers were starting to ask for the ability to use ES6.</span> </p>
<p><span data-start="568.329" data-end="574.889">It felt like a nonstarter for us, React support was difficult to implement and when it worked,</span> <span data-start="574.889" data-end="577.47">it certainly wasn't sustainable.</span> <span data-start="577.47" data-end="581.91">We knew we needed to do something.</span> <span data-start="581.91" data-end="585.839">This is where I've told myself that I'm going to drink water and you all are going to take</span> <span data-start="585.839" data-end="589.98">15 seconds to introduce yourself to the people next to you so that you don't hear me gulping</span> <span data-start="589.98" data-end="591.29">over the microphone.</span> </p>
<p><span data-start="591.29" data-end="592.29">All right, time's up.</span> <span data-start="592.29" data-end="593.29">I'm going to test all of you later so I hope you all paid attention.</span> <span data-start="593.29" data-end="594.29">OK, I gotta hurry up because I'm already running behind my schedule.</span> <span data-start="594.29" data-end="595.29">(mic is cutting in and out.)</span> <span data-start="595.29" data-end="596.29">Can you hear me OK?</span> <span data-start="596.29" data-end="597.29"Audience member: Can you still hear me OK?</span> <span data-start="597.29" data-end="598.29">All right, awesome.</span> </p>
<p><span data-start="598.29" data-end="599.29">OK, cool.</span> <span data-start="599.29" data-end="600.29">So I drank my water and it is now time for me to talk about the solution to every one</span> <span data-start="600.29" data-end="601.29">of our problems.</span> <span data-start="601.29" data-end="603.44">People started talking around this time about this brand new open source build system, it</span> <span data-start="603.44" data-end="605.18">was called Webpack.</span> <span data-start="605.18" data-end="606.529">You might have heard of it.</span> <span data-start="606.529" data-end="613.389">These are all the GIFs for my entire presentation, they are just right here.</span> <span data-start="613.389" data-end="616.509">All right, any new developer that we hired, asked if we could use Webpack and the internet</span> <span data-start="616.509" data-end="626.97">made it sound like every tech company that used JavaScript also used Webpack.</span> <span data-start="626.97" data-end="631.839">It sounded a lot like Builda in that it built stuff, but it also sounded very different</span> <span data-start="631.839" data-end="637.05">in that it had a robust development experience, it was highly extensible and it had a bunch</span> <span data-start="637.05" data-end="640.79">of built-in performance optimizations for our code.</span> </p>
<p><span data-start="640.79" data-end="645.79">Most of all it was supposed to be very fast, especially for development.</span> <span data-start="645.79" data-end="646.79">So we did a little research.</span> <span data-start="646.79" data-end="651.72">I wanted to point out, this is a fast chicken.</span> <span data-start="651.72" data-end="654.29">[laughter]</span> <span data-start="654.29" data-end="657.249">It's a recurring motif, so keep it in mind.</span> <span data-start="657.249" data-end="661.339">So we did a little bit of research, we evaluated a bunch of alternatives and we decided that</span> <span data-start="661.339" data-end="665.119">going down the path of building our JavaScript with Webpack instead of Builda was the right</span> <span data-start="665.119" data-end="669.899">path.</span> <span data-start="669.899" data-end="673.36">We had two requirements for any new system that we wanted to adopt.</span> <span data-start="673.36" data-end="677.86">Number one, it would have to take care of development builds without too much interacts</span> <span data-start="677.86" data-end="683.28">from developers, one of the nicest things about Builda, you could navigate the entire</span> <span data-start="683.28" data-end="692.91">site without having to worry about how the Builda requirement looked.</span> <span data-start="692.91" data-end="696.04">Etsy deploys code to production dozens of times in a day.</span> <span data-start="696.04" data-end="701.129">If our builds took longer than five minutes, Etsy's deployments would slow down, which</span> <span data-start="701.129" data-end="703.209">is not a good thing for us.</span> <span data-start="703.209" data-end="709.41">So Webpack, what was cool about Webpack for us, well, it's highly configurable.</span> </p>
<p><span data-start="709.41" data-end="719.259">Instead of a build list, Webpack uses a configuration file usually called Webpack.config.</span> <span data-start="719.259" data-end="723.379">From how you'd like to support templates, if any, to what sort of performance optimizations</span> <span data-start="723.379" data-end="724.379">you'd like to make.</span> <span data-start="724.379" data-end="729.04">This oftentimes means really large really scary config files, which isn't always the</span> <span data-start="729.04" data-end="731.889">right idea for small projects.</span> <span data-start="731.889" data-end="738.059">But having something that could adapt and fit to our code was very invaluable.</span> <span data-start="738.059" data-end="745.91">We spent a while writing out a really nice Webpack.config file and also different features</span> <span data-start="745.91" data-end="749.87">that Builda currently supported which at the time included everything from transpiling</span> <span data-start="749.87" data-end="753.29">templates.</span> <span data-start="753.29" data-end="757.799">After spending hours, setting things up just right, we finally got Webpack to build our</span> <span data-start="757.799" data-end="761.809">whole codebase, but it wasn't quite what we expected.</span> <span data-start="761.809" data-end="764.16">It took about a half hour to do.</span> </p>
<p><span data-start="764.16" data-end="770.76">It ate up 20 gigs of our servers' memory and maxed out every single one of its cores.</span> <span data-start="770.76" data-end="772.959">This is a real screenshot.</span> <span data-start="772.959" data-end="781.94">And it had the unclear progress indicator that everyone has come to know and love.</span> <span data-start="781.94" data-end="785.029">[laughter]</span> <span data-start="785.029" data-end="789.04">This made it exceptionally hard to figure out why it was so slow.</span> <span data-start="789.04" data-end="792.139">So we definitely had a lot to learn about improving Webpack's performance but at the</span> <span data-start="792.139" data-end="797.489">end of the day we needed to change a lot about how our codebase worked and how Webpack worked</span> <span data-start="797.489" data-end="800.639">with it if we wanted to use it with Etsy.</span> <span data-start="800.639" data-end="808.679">All right, I'm drinking water again, so tell the person next to you what your text editor</span> <span data-start="808.679" data-end="811.93">of choice is without trying to convince them that yours is the right one.</span> <span data-start="811.93" data-end="812.93">[laughter]</span> <span data-start="812.93" data-end="813.93">OK, how we doing?</span> <span data-start="813.93" data-end="814.93">Good?</span> <span data-start="814.93" data-end="815.93">All right.</span> </p>
<p><span data-start="815.93" data-end="816.93">I gotta hurry up.</span> <span data-start="816.93" data-end="817.93">I am, like I said, not on schedule.</span> <span data-start="817.93" data-end="818.93">I hope the answer was vim, but that's OK if it wasn't.</span> <span data-start="818.93" data-end="819.93">[applause]</span> <span data-start="819.93" data-end="825.009">OK, our first order of business was to get a development workflow that was good.</span> <span data-start="825.009" data-end="828.109">If engineers could develop with Webpack and validate that their code still worked with</span> <span data-start="828.109" data-end="839.079">Builda in production we wouldn't be able to offer new features like ES6 yet since Builda</span> <span data-start="839.079" data-end="841.439">didn't know anything about ES6 transformation.</span> <span data-start="841.439" data-end="845.899">But maybe we could let the engineers have a good time doing it.</span> <span data-start="845.899" data-end="852.05">And so why does Webpack take so long to build.</span> <span data-start="852.05" data-end="856.059">When Webpack first starts it does a complete build of all of your code first.</span> <span data-start="856.059" data-end="860.579">Then it enters watch mode.</span> <span data-start="860.579" data-end="863.36">It kicks off a portion rebuild every time it sees one.</span> <span data-start="863.36" data-end="867.489">This pattern developed to be extremely fast.</span> <span data-start="867.489" data-end="873.879">We figured that the longer builds would probably be much better but if that initial build took</span> <span data-start="873.879" data-end="879.259">a half hour and ate up all of our memory, it wouldn't be all that good.</span> </p>
<p><span data-start="879.259" data-end="881.809">So our codebase was really big and was getting even bigger.</span> <span data-start="881.809" data-end="886.66">So it would have to scale.</span> <span data-start="886.66" data-end="893.3">Well, Webpack makes inferences about your code in the context of your whole project.</span> <span data-start="893.3" data-end="898.059">For example, it is smart enough to group commonly requested modules together so that they can</span> <span data-start="898.059" data-end="900.339">be cast efficiently between pages.</span> <span data-start="900.339" data-end="904">It can only make these optimizations if it understands your entire project, not just</span> <span data-start="904" data-end="905.499">your individual files.</span> </p>
<p><span data-start="905.499" data-end="914.639">This is good if your project is nicely scoped but it makes a lot less sense in a mono repo.</span> <span data-start="914.639" data-end="919.259">So we started by trying to make Webpack faster and less resource intensive in general, something</span> <span data-start="919.259" data-end="921.339">that's really hard to do both of at the same time.</span> <span data-start="921.339" data-end="927.999">We got a lot of mileage from caching plugins like cache-loader and hard source and allowing</span> <span data-start="927.999" data-end="934.699">modules in parallel but at the end of the day we still had a prohibitively heavy first</span> <span data-start="934.699" data-end="935.769">build time.</span> <span data-start="935.769" data-end="937.929">I can't believe I found this image.</span> <span data-start="937.929" data-end="939.279">It's amazing.</span> </p>
<p><span data-start="939.279" data-end="941.179">We also looked at Webpack's development server.</span> <span data-start="941.179" data-end="947.999">The development server chooses to keep everything in memory.</span> <span data-start="947.999" data-end="952.29">For us this meant that our whole codebase, plus all the transformation information about</span> <span data-start="952.29" data-end="958.369">the whole codebase, plus all of the build files for the whole codebase had to fit in</span> <span data-start="958.369" data-end="959.779">memory.</span> <span data-start="959.779" data-end="966.179">There isn't a way to turn this off without modifying the development servers source code</span> <span data-start="966.179" data-end="970.449">which is actually a really nicely written repository and if you're interested in how</span> <span data-start="970.449" data-end="974.419">these things work, I would totally recommend reading through the source.</span> <span data-start="974.419" data-end="978.579">Even if there was a way to turn this off, it wasn't clear that it would save ourselves</span> <span data-start="978.579" data-end="987.97">from the size of our mono repo over time.</span> <span data-start="987.97" data-end="991.429">One really easy solution was just to make a bunch of different config files for different</span> <span data-start="991.429" data-end="995.439">areas of the codebase and only build the one that was being used at the time.</span> <span data-start="995.439" data-end="999.069">We can make each region be small enough so that memory is reasonable and initial build</span> <span data-start="999.069" data-end="1002.11">times are closer to one minute rather than 11.</span> </p>
<p><span data-start="1002.11" data-end="1016.41">For us this meant splitting our codebase into 11 regions was</span> <span data-start="1016.41" data-end="1018.809">the right number.</span> <span data-start="1018.809" data-end="1023.089">Juggling a bunch of configurations just to browser on Etsy on your work machine was not</span> <span data-start="1023.089" data-end="1024.089">ideal.</span> <span data-start="1024.089" data-end="1026.91">This meant that we probably needed to write something of our own.</span> </p>
<p><span data-start="1026.91" data-end="1031.38">So we wrote a thing called Kevin.</span> <span data-start="1031.38" data-end="1035.959">Kevin is a plugin for the express web server framework.</span> <span data-start="1035.959" data-end="1038.62">And its only job is to manage a bunch of Webpack instances.</span> <span data-start="1038.62" data-end="1041.04">Why did we name it Kevin?</span> <span data-start="1041.04" data-end="1042.64">Look how funny he is.</span> </p>
<p><span data-start="1042.64" data-end="1048.449">When a request for any file comes in, Kevin determines when Webpack config is responsible</span> <span data-start="1048.449" data-end="1053.7">for building that file, if any, and then it starts a Webpack instance for that config.</span> <span data-start="1053.7" data-end="1058.33">Once the compiler is finished, it starts running that code in watch mode rebuilding files as</span> <span data-start="1058.33" data-end="1061.51">they're edited.</span> <span data-start="1061.51" data-end="1066.36">If Kevin gets a request for another file in a different config, it does the same thing.</span> <span data-start="1066.36" data-end="1072.81">If there are too many compilers running, Kevin will shut down that compiler based on a frequency</span> <span data-start="1072.81" data-end="1074.51">and recency model.</span> <span data-start="1074.51" data-end="1078.49">This keeps us from building the whole codebase and it has an added benefit of making sure</span> <span data-start="1078.49" data-end="1085.31">that the codebase has regions of it that are all related to each other.</span> <span data-start="1085.31" data-end="1089.57">The only extra thing to consider is that really long first build.</span> <span data-start="1089.57" data-end="1095.01">If a request for a JavaScript file times out after 30 seconds, and starting up the Webpack</span> <span data-start="1095.01" data-end="1098.56">server takes closer to a minute we're going to end up timing in development for what seems</span> <span data-start="1098.56" data-end="1100.26">like no reason.</span> </p>
<p><span data-start="1100.26" data-end="1102.53">Kid in time out.</span> <span data-start="1102.53" data-end="1109.99">That's a joke.</span> <span data-start="1109.99" data-end="1113.43">It is modeled after the Domino's Pizza tracker.</span> <span data-start="1113.43" data-end="1117.62">We also exposed some data about the status of every active compiler so that the overlay</span> <span data-start="1117.62" data-end="1124.13">is able to monitor the status of its build.</span> <span data-start="1124.13" data-end="1128.42">Keeps memory usage low and keeps engineers informed about the state of all of their builds</span> <span data-start="1128.42" data-end="1131.11">without requiring them to manage a build system.</span> <span data-start="1131.11" data-end="1134.79">With any luck, Kevin will be available as open source software very soon.</span> <span data-start="1134.79" data-end="1136.79">All right, another water break.</span> <span data-start="1136.79" data-end="1140.64">In 15 seconds or less, tell a neighbor what you did for adventure day.</span> <span data-start="1140.64" data-end="1141.64">Go!</span> <span data-start="1141.64" data-end="1142.64">All right, that is the 15-second warning.</span> <span data-start="1142.64" data-end="1145.5">Let me really quickly talk about productionizing your code and then that GC bug that I've been</span> <span data-start="1145.5" data-end="1150.88">waiting for.</span> <span data-start="1150.88" data-end="1155.43">I want to talk about localization, since there's a lot of other less interesting things that</span> <span data-start="1155.43" data-end="1158.05">went into getting our code production ready.</span> </p>
<p><span data-start="1158.05" data-end="1161.3">So at this point development was working.</span> <span data-start="1161.3" data-end="1165.391">We even started to onboard a handful of developers so they could start giving us feedback, most</span> <span data-start="1165.391" data-end="1166.61">of which was pretty good.</span> <span data-start="1166.61" data-end="1174.97">Because we weren't building production code with Builda packet.</span> <span data-start="1174.97" data-end="1179.28">The benefits of Webpack brought to the development speed were wins in and of themselves.</span> <span data-start="1179.28" data-end="1182.79">Our next order of business was to get production to have that same speed.</span> </p>
<p><span data-start="1182.79" data-end="1187.031">There is that chicken again, reminding us that we need to get five-minute production</span> <span data-start="1187.031" data-end="1188.22">goals.</span> <span data-start="1188.22" data-end="1192.67">A working development environment meant that we were at least able to successfully build</span> <span data-start="1192.67" data-end="1195.33">our code.</span> <span data-start="1195.33" data-end="1199.57">This involved minifying it but more critically it meant localizing all of our assets into</span> <span data-start="1199.57" data-end="1202.03">11 different languages.</span> </p>
<p><span data-start="1202.03" data-end="1205.86">Localization is a little tricky with Webpack.</span> <span data-start="1205.86" data-end="1209.51">You need to kick off a separate Webpack build.</span> <span data-start="1209.51" data-end="1213.72">Webpack's localization plugin uses a file that provides localized strings that you provide</span> <span data-start="1213.72" data-end="1216.34">and.</span> <span data-start="1216.34" data-end="1218.41">It seems simple enough.</span> <span data-start="1218.41" data-end="1222.36">Using this method, constant strings can be defined in one file and swapped out between</span> <span data-start="1222.36" data-end="1225.04">builds without your JavaScript changing.</span> <span data-start="1225.04" data-end="1227.58">There is an implication here that is a little tricky.</span> <span data-start="1227.58" data-end="1232.37">Webpack ends up with a different configuration because the plugin needs to be configured</span> <span data-start="1232.37" data-end="1234.14">differently will for each language.</span> </p>
<p><span data-start="1234.14" data-end="1239.04">This means that in order to run 11 different languages, you need to run 11 Webpack builds.</span> <span data-start="1239.04" data-end="1246.71">Again, 34 course, 62 gigs of ram?</span> <span data-start="1246.71" data-end="1250.35">It's really big.</span> <span data-start="1250.35" data-end="1254.41">We could maybe run two in parallel and have the resources and get like 8 or 9 minutes</span> <span data-start="1254.41" data-end="1255.41">for those two builds.</span> <span data-start="1255.41" data-end="1260.58">But that would still mean that all of our builds would take like an hour.</span> <span data-start="1260.58" data-end="1269.67">We  couldn't just ask for new hardware, let alone</span> <span data-start="1269.67" data-end="1272.79">a dozen or so of the most powerful computers that we used to have.</span> <span data-start="1272.79" data-end="1278.45">If we were trying to keep pace with Builda, we were going to have to cheat a little bit.</span> <span data-start="1278.45" data-end="1282.92">Luckily for us, cheating is OK, because Builda cheats, too.</span> <span data-start="1282.92" data-end="1287.83">Let me explain what I mean here.</span> </p>
<p><span data-start="1287.83" data-end="1293.32">Builda doesn't build that code 11 different times.</span> <span data-start="1293.32" data-end="1300.09">Later, when that Builda's mostly done and it looks like word salad, it goes back through</span> <span data-start="1300.09" data-end="1306.2">each file, finds those placeholders and swaps them out for actual localized strings in every</span> <span data-start="1306.2" data-end="1307.39">language.</span> <span data-start="1307.39" data-end="1313.18">If you speak French, you will know that this is an accurate translation.</span> <span data-start="1313.18" data-end="1317.16">Compared with Webpack's apparently deprecated international plugin, this seemed like a much</span> <span data-start="1317.16" data-end="1318.5">faster approach.</span> <span data-start="1318.5" data-end="1323.67">I actually didn't know this was deprecated at the time I wrote this talk, so like I said,</span> <span data-start="1323.67" data-end="1325.44">JavaScript changes very quickly.</span> <span data-start="1325.44" data-end="1333.87">Anyways, we tweaked our plugins and had them insert placeholders, instead.</span> <span data-start="1333.87" data-end="1344.38">From there, we would do a find and replace.</span> <span data-start="1344.38" data-end="1346.86">This is actually a lot easier than it sounds.</span> </p>
<p><span data-start="1346.86" data-end="1350.04">This whole screenshot is essentially all of the code but here are the juicy bits.</span> <span data-start="1350.04" data-end="1357.77">We're able to take our source code and call dot split on it with our placeholder.</span> <span data-start="1357.77" data-end="1363.78">Would iterate through the odd indexes and translate them.</span> <span data-start="1363.78" data-end="1372.05">In case you're curious we get our translations from a separate service that we maintain.</span> </p>
<p><span data-start="1372.05" data-end="1377.14">This message was actually so fast that we were able to provide localization in development.</span> <span data-start="1377.14" data-end="1380.93">That's why Kevin has Italian on his forehead.</span> <span data-start="1380.93" data-end="1385.08">We could do this quick enough by translating things as they were requested, rather than</span> <span data-start="1385.08" data-end="1387.81">build every file into every language possible.</span> <span data-start="1387.81" data-end="1390.74">Thanks to this method we were able to get our production builds ready in well under</span> <span data-start="1390.74" data-end="1391.84">5 minutes.</span> <span data-start="1391.84" data-end="1398.06">OK, in 15 seconds or less, tell your neighbor if you can speak more than one language.</span> <span data-start="1398.06" data-end="1399.06">OK, that is about 15 seconds.</span> <span data-start="1399.06" data-end="1400.06">Give or take.</span> <span data-start="1400.06" data-end="1401.06">I heard more than yes or no, so I don't know what you were talking about.</span> <span data-start="1401.06" data-end="1402.24">For the last part of this talk, let me tell you about that 4 milliseconds that kept us</span> <span data-start="1402.24" data-end="1405.9">from building this whole thing 3 months earlier than we actually did.</span> <span data-start="1405.9" data-end="1410.67">So we felt we were ready to try Webpack on code production traffic.</span> <span data-start="1410.67" data-end="1414.83">We were very excited.</span> <span data-start="1414.83" data-end="1417.88">A bunch of our end to end tests showed that things were the same.</span> </p>
<p><span data-start="1417.88" data-end="1421.29">However, build systems are very hard to replace.</span> <span data-start="1421.29" data-end="1426.15">A new build system has to work in every language in every page in the site like we talked about,</span> <span data-start="1426.15" data-end="1433.48">but it also has to work on every browser, no mart how old or cutting edge it may be.</span> <span data-start="1433.48" data-end="1437.33">So what do we want to do?</span> </p>
<p><span data-start="1437.33" data-end="1440.96">We run an A/B test.</span> <span data-start="1440.96" data-end="1443.64">A stock photo of an A/B test.</span> <span data-start="1443.64" data-end="1447.56">We actually ran five separate ones, and they all look pretty good.</span> <span data-start="1447.56" data-end="1450.68">You can see the important metrics that we checked.</span> <span data-start="1450.68" data-end="1457.45">And yet, in spite of all this, we had some pretty alarming changes in every one of our</span> <span data-start="1457.45" data-end="1459.54">browser performance metrics.</span> <span data-start="1459.54" data-end="1462.54">Every page was running way slower than we expected.</span> <span data-start="1462.54" data-end="1466.97">Some of our pages are up to 14% slower which is unheard of.</span> </p>
<p><span data-start="1466.97" data-end="1473.14">In the general view if your site's performance gets worse, so does your site's money.</span> <span data-start="1473.14" data-end="1478.14">We had to figure out what was going on before we could launch Webpack.</span> <span data-start="1478.14" data-end="1481.39">Before I go on, let me talk about our client-side metrics very quickly.</span> <span data-start="1481.39" data-end="1484.45">Many of you probably know this sort of thing, but some of you may not and I hope this is</span> <span data-start="1484.45" data-end="1485.45">a good refresher.</span> <span data-start="1485.45" data-end="1490.58">At Etsy we track a lot of things, but two in particular.</span> <span data-start="1490.58" data-end="1494.08">One is DOMContentLoaded and one is page load.</span> <span data-start="1494.08" data-end="1499.46">So when the browser parses our HTML it goes through line by line and evals everything</span> <span data-start="1499.46" data-end="1503.13">one line at a time.</span> <span data-start="1503.13" data-end="1506.94">It downloads and executes the whole thing before continuing to parse the page.</span> </p>
<p><span data-start="1506.94" data-end="1515">Some things like this image tag will  —  here is our JavaScript at the very bottom.</span> <span data-start="1515" data-end="1519.88">Like CSS, JavaScript is downloaded and executed before the browser can continue.</span> <span data-start="1519.88" data-end="1524.21">Some JavaScript code, like a network request or timeout calls do not block the browser</span> <span data-start="1524.21" data-end="1528.5">and are added to a list of tasks that the browser can take care of at a later time.</span> <span data-start="1528.5" data-end="1533.04">Finally it fires the DOM-content loaded event.</span> <span data-start="1533.04" data-end="1538.83">There it is!</span> <span data-start="1538.83" data-end="1545.49">Once all of our subresources load  —  that is a thing that you can buy on Etsy.com</span> <span data-start="1545.49" data-end="1549">Once all of our subresources load like that image and when the browser has run enough</span> <span data-start="1549" data-end="1561.49">tasks to really take care of it says that the fires the page.</span> <span data-start="1561.49" data-end="1566.67">Both of these were slower for us, this raised two questions: What is so small, yet so different</span> <span data-start="1566.67" data-end="1568.13">that we've miss it had?</span> <span data-start="1568.13" data-end="1572.99">And two, if something is so different, why do people still buy things on Etsy.com so</span> <span data-start="1572.99" data-end="1577.27">we started investigating or performance monitoring code and we double-checked that we weren't</span> <span data-start="1577.27" data-end="1581.52">shipping extra code to our clients but both of these things turned up nothing so we decided</span> <span data-start="1581.52" data-end="1585.31">to investigate how our code was running in the browser.</span> </p>
<p><span data-start="1585.31" data-end="1591.43">This is a flame graph for the listing page that shows the item for sale on Etsy.</span> <span data-start="1591.43" data-end="1594.32">The graph shows our code built with Builda.</span> <span data-start="1594.32" data-end="1602.28">Horizontal axis represents time the every rectangle represents a function call, and</span> <span data-start="1602.28" data-end="1606.56">everything below that is a subtask related to it.</span> <span data-start="1606.56" data-end="1612.87">This shows what the browser does when it parses the main JavaScript file on the page.</span> <span data-start="1612.87" data-end="1615.37">Now, what does Webpack's look like?</span> </p>
<p><span data-start="1615.37" data-end="1617">A lot worse.</span> <span data-start="1617" data-end="1621.31">This is the same file as the previous graph, but it's taking 4 times as long.</span> <span data-start="1621.31" data-end="1623.69">For kicks, here they are side by side.</span> <span data-start="1623.69" data-end="1625.77">Clearly Builda is doing a lot less.</span> <span data-start="1625.77" data-end="1629.95">So this is kind of concerning.</span> <span data-start="1629.95" data-end="1631.52">So why is this happening?</span> <span data-start="1631.52" data-end="1634.6">Even if our conversion numbers look good, this big difference may mean that we're missing</span> <span data-start="1634.6" data-end="1636.21">a performance win.</span> <span data-start="1636.21" data-end="1639.23">Let's take another look at the whole graph built with Builda.</span> <span data-start="1639.23" data-end="1641.96">This is roughly the area that we were looking at before.</span> <span data-start="1641.96" data-end="1646.89">This is where DOMContentLoading fires, this is page load and this is where our JavaScript</span> <span data-start="1646.89" data-end="1648.74">file was actually getting executed.</span> </p>
<p><span data-start="1648.74" data-end="1655.65">So zooming in a little bit, that rectangle there is the main body of our JavaScript file.</span> <span data-start="1655.65" data-end="1666.23">In other words, our performance metrics were not accounting for the time it took to actually</span> <span data-start="1666.23" data-end="1671.94">run our JavaScript, but rather when that JavaScript was built with Builda.</span> <span data-start="1671.94" data-end="1674.36">Code built with Webpack did not have this problem.</span> <span data-start="1674.36" data-end="1677.88">So we no why people were still buying stuff, the same things have happened, but our measurements</span> <span data-start="1677.88" data-end="1681">have moved.</span> <span data-start="1681" data-end="1685.82">So let's look back at our two metrics, specifically at load, and very specifically let's look</span> <span data-start="1685.82" data-end="1689.76">at the part that say there are no outstanding scripts waiting to be executed.</span> <span data-start="1689.76" data-end="1695.21">What if the browser was being tricked into ready.</span> <span data-start="1695.21" data-end="1700.27">Very quick because I know I'm way over time.</span> <span data-start="1700.27" data-end="1702.97">As ooh reminder, requires a library that Builda was built around.</span> <span data-start="1702.97" data-end="1709.39">We sent a copy of it to our browsers, where it's responsible for starting up our code.</span> </p>
<p><span data-start="1709.39" data-end="1715.16">Here's where require.js kicks off our execution and it's wrapped in this next tick function.</span> <span data-start="1715.16" data-end="1725.82">It looks like it's just a 4ms set time outscore.</span> <span data-start="1725.82" data-end="1729.559">This isn't a hard and fast time and the browser is totally allowed to push things back a little</span> <span data-start="1729.559" data-end="1731.01">bit later if it needs.</span> <span data-start="1731.01" data-end="1736.07">In other words, require.js tells the browser that none of our code needs to run right away.</span> </p>
<p><span data-start="1736.07" data-end="1739.96">Require.js may do this because it gives the browser a second to finish loading the page</span> <span data-start="1739.96" data-end="1742.03">before starting any JavaScript.</span> <span data-start="1742.03" data-end="1745.59">It also might do this because set timeout was a great way to make your performance numbers</span> <span data-start="1745.59" data-end="1747.55">look good in 2010.</span> <span data-start="1747.55" data-end="1755.26">So knowing that this was a bug, what did we do?</span> <span data-start="1755.26" data-end="1757.47">We did not wrap all of our code in set timeout calls.</span> <span data-start="1757.47" data-end="1760.61">That would make our numbers look better but it wouldn't tell us anything that we needed</span> <span data-start="1760.61" data-end="1765.86">to D but we did add some new metrics.</span> <span data-start="1765.86" data-end="1768.78">We added a timer to every one of our top five pages.</span> <span data-start="1768.78" data-end="1771.33">Here yellow is Webpack and lower is better.</span> <span data-start="1771.33" data-end="1774.76">Those timers were supposed to measure how long it took for all of our JavaScript to</span> <span data-start="1774.76" data-end="1776.42">run on those pages.</span> <span data-start="1776.42" data-end="1778.32">We were very happy with this graph.</span> <span data-start="1778.32" data-end="1780.68">OK, I'm about done.</span> <span data-start="1780.68" data-end="1784">In conclusion it took us almost a year and a half to move to Webpack.</span> </p>
<p><span data-start="1784" data-end="1790.61">That is a very long time and it's a lot of hair-pulling.</span> <span data-start="1790.61" data-end="1794.8">At the end of the day, we had a lot to learn about build systems, performance and our own</span> <span data-start="1794.8" data-end="1795.8">codebase.</span> <span data-start="1795.8" data-end="1800.76">I felt like there should be a three-point slide thing, but there were so many winnings</span> <span data-start="1800.76" data-end="1802.72">that we had that it's kind of hard to pick 3.</span> <span data-start="1802.72" data-end="1804.9">But I tried anyways.</span> <span data-start="1804.9" data-end="1807.85">Number one, your codebase gets bigger, not smaller.</span> <span data-start="1807.85" data-end="1815.16">If you're trying to find small performance win, it probably won't last very long.</span> <span data-start="1815.16" data-end="1822.37">Number 2: Always question what other companies, websites, articles and blogs claim to be best</span> <span data-start="1822.37" data-end="1823.37">practices.</span> </p>
<p><span data-start="1823.37" data-end="1826.35">What works well for one person may not always work well everywhere.</span> <span data-start="1826.35" data-end="1830.65">If we accepted that Webpack's internationalisation plugin was the only option we'd still be waiting</span> <span data-start="1830.65" data-end="1832.46">for our JavaScript to build.</span> <span data-start="1832.46" data-end="1841.07">And finally if you can take a risk on a big build project, you absolutely should.</span> <span data-start="1841.07" data-end="1846.52">We really hated that that metrics bug cost us months of time but we ended up learning</span> <span data-start="1846.52" data-end="1851.14">so much more about performance, the browser and our code and at the end of the day after</span> <span data-start="1851.14" data-end="1855.17">almost a year and a half of wild problems and pulling my hair out, Webpack is pretty</span> <span data-start="1855.17" data-end="1856.71">great software.</span> </p>
<p><span data-start="1856.71" data-end="1858.12">So that is my talk.</span> <span data-start="1858.12" data-end="1861.1">If you have any questions, please hit me up on Slack or Twitter.</span> <span data-start="1861.1" data-end="1872.22">If you like this stuff, my team is hiring and of course, thank you all so very much.</span> </p>
</section>