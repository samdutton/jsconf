<section>
<p><span data-start="15.34" data-end="17.17">yeah and I'm here to talk about chakra</span> <span data-start="17.17" data-end="19.39">in case it's not such a household name</span> <span data-start="19.39" data-end="22.33">as v8 chakra is the JavaScript engine in</span> <span data-start="22.33" data-end="26.65">99 9 10 and in april of this year at JS</span> <span data-start="26.65" data-end="29.02">convey you multi suggested that I come</span> <span data-start="29.02" data-end="31.029">and talk about chakra I got really</span> <span data-start="31.029" data-end="32.86">excited because even though we've been</span> <span data-start="32.86" data-end="34.54">working on it for about four years we</span> <span data-start="34.54" data-end="36.16">really haven't spoken publicly very much</span> <span data-start="36.16" data-end="40.3">about the internals and then as the talk</span> <span data-start="40.3" data-end="42.61">drew near I realized that I have 30</span> <span data-start="42.61" data-end="43.84">minutes for it then I thought oh crap</span> </p>
<p><span data-start="43.84" data-end="45.4">I'm going to have 30 minutes to tell you</span> <span data-start="45.4" data-end="46.93">about what we've been up to in the last</span> <span data-start="46.93" data-end="49.27">four years and then it occurred to me</span> <span data-start="49.27" data-end="50.38">that one of the best things I could do</span> <span data-start="50.38" data-end="54.19">is shift over here too let's see if you</span> <span data-start="54.19" data-end="57.309">can see that will switch over to my this</span> <span data-start="57.309" data-end="60.07">way this way there we go will fire off</span> <span data-start="60.07" data-end="62.86">our command line JavaScript host and</span> <span data-start="62.86" data-end="65.259">I'll just run some JavaScript and will</span> <span data-start="65.259" data-end="67.42">spit out the machine code that we emit</span> <span data-start="67.42" data-end="68.92">and then I can kind of walk you through</span> <span data-start="68.92" data-end="70.81">the details of it and no letter probably</span> <span data-start="70.81" data-end="73.33">feel about 30 minutes of our time maybe</span> <span data-start="73.33" data-end="74.38">a little bit more so maybe it's not such</span> <span data-start="74.38" data-end="76.93">a good idea so instead of dancing you</span> <span data-start="76.93" data-end="78.64">with my compiler voodoo knowledge I will</span> <span data-start="78.64" data-end="82.27">instead try to amaze you with my fancy</span> <span data-start="82.27" data-end="84.58">animated slides let me take that one out</span> <span data-start="84.58" data-end="91.41">of the way alright great so chakra Oh</span> <span data-start="91.41" data-end="94.959">focus there we go start working now</span> <span data-start="94.959" data-end="98.619">there we go under the hood in 30 minutes</span> <span data-start="98.619" data-end="100.509">or less let's see how much I can show</span> <span data-start="100.509" data-end="103.69">you some way started the project four</span> <span data-start="103.69" data-end="107.289">years ago in sometime late in 2008 we</span> <span data-start="107.289" data-end="109.02">obviously wanted to rewrite the</span> </p>
<p><span data-start="109.02" data-end="111.759">JavaScript engine to be faster so we</span> <span data-start="111.759" data-end="114.19">ripped out the old JavaScript engine</span> <span data-start="114.19" data-end="117.91">from ie8 we added JIT compiler obviously</span> <span data-start="117.91" data-end="119.19">the main goal was to make things faster</span> <span data-start="119.19" data-end="121.42">but at the same time we didn't want to</span> <span data-start="121.42" data-end="123.459">sacrifice security and we didn't want to</span> <span data-start="123.459" data-end="126.33">sacrifice in a bit of interoperability</span> <span data-start="126.33" data-end="129.009">as it turns out adding a jit to any</span> <span data-start="129.009" data-end="131.44">process is a very juicy target for a</span> <span data-start="131.44" data-end="134.349">potential attacker we will take some</span> <span data-start="134.349" data-end="136.239">performance hits in order to maintain</span> <span data-start="136.239" data-end="138.25">security will dive in this a little bit</span> <span data-start="138.25" data-end="140.08">more and then second we wanted to be</span> <span data-start="140.08" data-end="142.09">sure they were absolutely compliant with</span> <span data-start="142.09" data-end="145.269">the ACMA scripts spec so you know and I</span> <span data-start="145.269" data-end="148.03">the dark days of ie8 and before you have</span> <span data-start="148.03" data-end="149.2">to deal with all kinds of quirks</span> <span data-start="149.2" data-end="150.97">such we are to be sure that that's not a</span> <span data-start="150.97" data-end="153.879">problem in ie9 and and beyond so you</span> <span data-start="153.879" data-end="155.08">want to be sure you write script once</span> <span data-start="155.08" data-end="156.79">and it runs consistently on all the</span> <span data-start="156.79" data-end="162.849">browsers yeah and even our view of</span> <span data-start="162.849" data-end="164.95">performance is somewhat more nuanced and</span> <span data-start="164.95" data-end="167.349">balanced we want to be sure that we we</span> <span data-start="167.349" data-end="168.7">are really good on page load because</span> <span data-start="168.7" data-end="170.5">that's important as well as on just the</span> <span data-start="170.5" data-end="173.319">raw execution and really what I want to</span> <span data-start="173.319" data-end="174.849">tell you about this kind of the story of</span> <span data-start="174.849" data-end="177.34">building chakra why was built they were</span> <span data-start="177.34" data-end="179.26">was built what's different about it then</span> <span data-start="179.26" data-end="180.94">in some of the other engines and then</span> <span data-start="180.94" data-end="182.769">what is new and I 10 since we're just</span> <span data-start="182.769" data-end="184.81">about ready to ship it publicly</span> <span data-start="184.81" data-end="187.03">officially so we'll dive under the hood</span> <span data-start="187.03" data-end="189.61">a little bit there so let's start with</span> <span data-start="189.61" data-end="191.44">security oh by the way I promised some</span> <span data-start="191.44" data-end="193.36">assembly in my intro there will be some</span> <span data-start="193.36" data-end="196.18">of that so that's a quick preview of</span> <span data-start="196.18" data-end="199.15">what we're about to see I'm so security</span> </p>
<p><span data-start="199.15" data-end="202.239">I'm when you add a jit to the process</span> <span data-start="202.239" data-end="205.54">becomes a very potentially juicy target</span> <span data-start="205.54" data-end="207.459">for for an attack we want to be sure</span> <span data-start="207.459" data-end="209.29">that our engine is not the source of</span> <span data-start="209.29" data-end="211.569">exploits in the browser if you think</span> <span data-start="211.569" data-end="213.13">about what the JIT compiler does it</span> <span data-start="213.13" data-end="214.9">basically writes a bunch of data in the</span> <span data-start="214.9" data-end="217.389">memory and then points the CPU and the</span> <span data-start="217.389" data-end="220.389">data and says run that stuff and if your</span> <span data-start="220.389" data-end="221.92">attacker that's almost exactly what you</span> <span data-start="221.92" data-end="223.15">want to do you want to be able to write</span> <span data-start="223.15" data-end="224.44">some malicious code and then you want</span> <span data-start="224.44" data-end="227.2">the the processor to run that for you so</span> <span data-start="227.2" data-end="228.639">if you can get ahold of the chunk of</span> <span data-start="228.639" data-end="230.38">memory where where the JIT compiler</span> <span data-start="230.38" data-end="231.88">emitted some code and then you can write</span> <span data-start="231.88" data-end="233.68">your own stuff in there you pretty much</span> <span data-start="233.68" data-end="236.47">own the process so we take a number of</span> <span data-start="236.47" data-end="238.18">steps to make that as difficult as</span> <span data-start="238.18" data-end="241.12">possible for starters the most important</span> <span data-start="241.12" data-end="242.62">thing the most important mitigation that</span> <span data-start="242.62" data-end="245.41">we have is we actually lock the pages</span> <span data-start="245.41" data-end="247.959">that we write our code to so we mark</span> <span data-start="247.959" data-end="250.359">them as not executable sorry nan</span> <span data-start="250.359" data-end="252.7">writable but executable which means no</span> <span data-start="252.7" data-end="254.319">one else can write to that to those</span> <span data-start="254.319" data-end="255.76">pages any more data after we've</span> <span data-start="255.76" data-end="258.459">generated code that minimizes the window</span> <span data-start="258.459" data-end="261.519">that anyone can have to try to modify</span> <span data-start="261.519" data-end="263.08">things after we've written them to that</span> <span data-start="263.08" data-end="265.99">piece of code and then we also make it</span> <span data-start="265.99" data-end="267.849">difficult to figure out exactly where</span> <span data-start="267.849" data-end="269.71">the code is emitted first we use some of</span> <span data-start="269.71" data-end="271.289">the operating system mechanisms the</span> <span data-start="271.289" data-end="274.63">address space layout randomization but</span> <span data-start="274.63" data-end="276.82">then we also randomly layout where the</span> <span data-start="276.82" data-end="279.22">function start so we add some no ops in</span> <span data-start="279.22" data-end="280.72">the beginning sometimes there are no up</span> <span data-start="280.72" data-end="281.8">sometimes there are interrupt</span> <span data-start="281.8" data-end="283.2">instructions</span> <span data-start="283.2" data-end="285.58">we actually emit some random no ops</span> <span data-start="285.58" data-end="287.26">within the body of a function just</span> <span data-start="287.26" data-end="289.15">randomly sprinkle them throughout which</span> <span data-start="289.15" data-end="290.68">again makes it that much more difficult</span> <span data-start="290.68" data-end="293.28">to figure out where where the code lives</span> <span data-start="293.28" data-end="296.74">and then it turns out that if you write</span> </p>
<p><span data-start="296.74" data-end="298.09">JavaScript you actually have control</span> <span data-start="298.09" data-end="300.07">over some pieces of the data that we</span> <span data-start="300.07" data-end="302.08">will write out if you imagine when you</span> <span data-start="302.08" data-end="304.39">have a constant say a value 12 somewhere</span> <span data-start="304.39" data-end="307.81">we say in VAR x equals 12 that value has</span> <span data-start="307.81" data-end="310.87">to be encoded somewhere and then it</span> <span data-start="310.87" data-end="313.96">turns out that it only takes 16 bits to</span> <span data-start="313.96" data-end="316.96">encode an instruction in assembly on at</span> <span data-start="316.96" data-end="319.06">least in those processors so technically</span> <span data-start="319.06" data-end="320.65">speaking if you can have a constant that</span> <span data-start="320.65" data-end="323.23">is 16 bits or more you can put</span> <span data-start="323.23" data-end="325.3">instructions directly in the indie code</span> <span data-start="325.3" data-end="328.06">that we admit so to to take that control</span> <span data-start="328.06" data-end="329.71">away from you will actually encode those</span> <span data-start="329.71" data-end="332.86">60 bit 16-bit or more values by</span> <span data-start="332.86" data-end="335.08">extraordinary so that's what you see in</span> <span data-start="335.08" data-end="337.33">here and then on top of that we do a</span> <span data-start="337.33" data-end="339.04">couple of other things we actually cap</span> <span data-start="339.04" data-end="340.6">the amount of code that we will generate</span> <span data-start="340.6" data-end="342.49">just to be sure you cannot fill the</span> <span data-start="342.49" data-end="344.95">entire memory with with random code and</span> <span data-start="344.95" data-end="346.99">then jump somewhere there or write to a</span> <span data-start="346.99" data-end="349.84">random location and then one actually</span> <span data-start="349.84" data-end="351.25">comes to allocating pages we also</span> <span data-start="351.25" data-end="353.32">randomized those allocations so all</span> <span data-start="353.32" data-end="355.12">these things combined make it very</span> <span data-start="355.12" data-end="357.52">difficult to own the code that we omit</span> <span data-start="357.52" data-end="360.82">in any way and the first part that I</span> <span data-start="360.82" data-end="362.26">mentioned the locking of the pages is</span> <span data-start="362.26" data-end="363.79">actually different between chakra and</span> <span data-start="363.79" data-end="366.01">any of the other engines and does have</span> <span data-start="366.01" data-end="368.11">some implications like we we ourselves</span> <span data-start="368.11" data-end="370">are not able to modify the code after</span> <span data-start="370" data-end="372.28">you wrote it out so that's one of the</span> <span data-start="372.28" data-end="373.93">cases we will take some performance hit</span> <span data-start="373.93" data-end="376.54">to get that security and that's</span> <span data-start="376.54" data-end="377.74">something that differentiate is from</span> <span data-start="377.74" data-end="381.13">from others the other thing I mentioned</span> <span data-start="381.13" data-end="384.97">was the compliance spec compliance akma</span> <span data-start="384.97" data-end="386.919">script is a well-written spec but it's</span> <span data-start="386.919" data-end="388.96">every spec it leaves some little nuances</span> <span data-start="388.96" data-end="391.419">kind of up to interpretation so we</span> <span data-start="391.419" data-end="392.65">believe that it's important to have a</span> <span data-start="392.65" data-end="394.63">suite of tests that can empirically</span> <span data-start="394.63" data-end="396.85">verify that we all agree on what the</span> <span data-start="396.85" data-end="398.89">spec says so we worked with Google and</span> <span data-start="398.89" data-end="402.07">with others to create the test 262 which</span> <span data-start="402.07" data-end="405.7">now has some 11,000 different tests that</span> <span data-start="405.7" data-end="407.56">verify compliance Lakmal script and up</span> <span data-start="407.56" data-end="408.91">until about two weeks ago we were</span> <span data-start="408.91" data-end="410.919">actually passing all of them but then</span> <span data-start="410.919" data-end="413.02">sometime two weeks ago a few more out</span> <span data-start="413.02" data-end="414.76">were added to deal with the utf-8</span> <span data-start="414.76" data-end="416.249">encoding and</span> <span data-start="416.249" data-end="417.719">turns out there is a some there's a bug</span> <span data-start="417.719" data-end="419.219">in the unknowing OS in some weird</span> <span data-start="419.219" data-end="422.129">sorting algorithm that affects us so</span> <span data-start="422.129" data-end="423.989">we're now failing one test but we're</span> <span data-start="423.989" data-end="425.699">still actually doing quite well when it</span> <span data-start="425.699" data-end="427.349">comes to the pass rate and again we're</span> <span data-start="427.349" data-end="429.029">committed to making sure that that we</span> <span data-start="429.029" data-end="431.789">stay compliant with the spec so with</span> <span data-start="431.789" data-end="433.169">more tests are added that actually</span> <span data-start="433.169" data-end="435.449">expose issues that we might have we'll</span> <span data-start="435.449" data-end="437.249">make sure we fix them and the good news</span> <span data-start="437.249" data-end="438.749">for you is generally speaking all the</span> <span data-start="438.749" data-end="440.279">other browsers are also converging on a</span> <span data-start="440.279" data-end="442.259">very high pass rate so you can really</span> <span data-start="442.259" data-end="444.779">count on on your xmas crypt compliant</span> <span data-start="444.779" data-end="446.999">spec I mean script to run in all the</span> <span data-start="446.999" data-end="450.689">browsers in the same way okay great most</span> <span data-start="450.689" data-end="451.919">of the talk will be about performance</span> <span data-start="451.919" data-end="454.319">though and I did say that we care about</span> <span data-start="454.319" data-end="457.049">page load why do we care about page load</span> <span data-start="457.049" data-end="459.629">well even though the web is evolving and</span> <span data-start="459.629" data-end="461.129">the apps are getting more fancy and more</span> <span data-start="461.129" data-end="462.719">sophisticated most of the people still</span> <span data-start="462.719" data-end="464.249">experience the web is a bunch of pages</span> <span data-start="464.249" data-end="466.889">that they navigate to and their</span> <span data-start="466.889" data-end="468.539">experience is primarily affected by how</span> <span data-start="468.539" data-end="470.899">quickly those pages load and since</span> </p>
<p><span data-start="470.899" data-end="473.159">JavaScript execution is oftentimes on</span> <span data-start="473.159" data-end="474.989">the critical path of that we try to make</span> <span data-start="474.989" data-end="476.159">sure that we get out of the way as</span> <span data-start="476.159" data-end="478.829">quickly as we can so that dictated that</span> <span data-start="478.829" data-end="481.499">we kept an interpreter in chakra we have</span> <span data-start="481.499" data-end="483.299">a compiler but we retain the interpreter</span> <span data-start="483.299" data-end="485.249">so we can start executing your code as</span> <span data-start="485.249" data-end="487.829">fast as possible so here's a quick</span> <span data-start="487.829" data-end="489.389">little diagram of what we do with your</span> <span data-start="489.389" data-end="491.069">code when we see source code we pass it</span> <span data-start="491.069" data-end="493.199">through the parser we produce an ASD</span> <span data-start="493.199" data-end="494.909">then we feed it to a byte code generator</span> <span data-start="494.909" data-end="497.339">which generates bytecode which then we</span> <span data-start="497.339" data-end="499.199">start interpreting as fast as we can and</span> <span data-start="499.199" data-end="501.029">please do appreciate my pulsating</span> <span data-start="501.029" data-end="505.469">interpreter right there but the main</span> <span data-start="505.469" data-end="507.749">point here is we believe generating</span> <span data-start="507.749" data-end="510.029">bytecode is faster than then compiling</span> <span data-start="510.029" data-end="512.309">to machine instructions so in order to</span> <span data-start="512.309" data-end="515.159">give you as fast startup as possible we</span> <span data-start="515.159" data-end="517.529">will get to the interpreter first and</span> <span data-start="517.529" data-end="520.319">we'll start executing there but we do</span> <span data-start="520.319" data-end="524.459">more it turns out most of the sites</span> <span data-start="524.459" data-end="526.259">bring in a bunch of JavaScript libraries</span> <span data-start="526.259" data-end="528.149">out of which only a small portion is</span> <span data-start="528.149" data-end="530.399">ever executed and even a small smaller</span> <span data-start="530.399" data-end="532.68">portion is executed at startup so it's</span> <span data-start="532.68" data-end="534.209">important that we don't spend all the</span> <span data-start="534.209" data-end="536.04">time parsing all the code and generating</span> <span data-start="536.04" data-end="537.72">the bytecode for all the stuff that is</span> <span data-start="537.72" data-end="540.36">never used so we do instead is we defer</span> <span data-start="540.36" data-end="541.68">parsing of anything that is not</span> <span data-start="541.68" data-end="544.5">immediately executed so we actually wait</span> <span data-start="544.5" data-end="546.75">until you call a function before we do</span> <span data-start="546.75" data-end="548.269">all the all the work that is required</span> <span data-start="548.269" data-end="550.5">there's a caveat there</span> <span data-start="550.5" data-end="553.09">requirement of the spec is that we parse</span> <span data-start="553.09" data-end="555.13">everything for syntax errors but that's</span> <span data-start="555.13" data-end="558.07">a relatively quick pass so you know the</span> </p>
<p><span data-start="558.07" data-end="559.54">FIR loading of your code is still a good</span> <span data-start="559.54" data-end="561.28">idea because we will have to parse all</span> <span data-start="561.28" data-end="563.2">of it at least for syntax errors but</span> <span data-start="563.2" data-end="564.55">generally speaking all the hard work is</span> <span data-start="564.55" data-end="565.99">deferred until it's absolutely required</span> <span data-start="565.99" data-end="568.98">and we try to do even more we try to</span> <span data-start="568.98" data-end="571.27">preserve some of the information that we</span> <span data-start="571.27" data-end="572.92">have between one page load and another</span> <span data-start="572.92" data-end="574.48">will actually keep track of the</span> <span data-start="574.48" data-end="575.8">functions in JavaScript that got</span> <span data-start="575.8" data-end="577.51">executed to make sure that we parse</span> <span data-start="577.51" data-end="579.07">those right away and we defer everything</span> <span data-start="579.07" data-end="581.53">else and then I'll tell you more about</span> <span data-start="581.53" data-end="583.48">Windows 8 applications at the end but</span> <span data-start="583.48" data-end="585.1">for those written in JavaScript we</span> <span data-start="585.1" data-end="586.93">actually even cache the bytecode so we</span> <span data-start="586.93" data-end="588.79">don't have to parse or generate bytecode</span> <span data-start="588.79" data-end="590.95">at all which helps us greatly on startup</span> <span data-start="590.95" data-end="595.99">for those so page load is important but</span> <span data-start="595.99" data-end="597.28">of course we care about executing</span> </p>
<p><span data-start="597.28" data-end="599.11">JavaScript as fast as possible to for</span> <span data-start="599.11" data-end="602.14">the larger apps so we start an</span> <span data-start="602.14" data-end="604.93">interpreter and as we interpret we</span> <span data-start="604.93" data-end="607.92">collect there we go profile information</span> <span data-start="607.92" data-end="610.87">basically data about what types of</span> <span data-start="610.87" data-end="613.51">parameters variables properties we saw</span> <span data-start="613.51" data-end="616.66">it's kind of similar to what v8 does and</span> <span data-start="616.66" data-end="619.99">what Firefox also does and then we feed</span> <span data-start="619.99" data-end="621.52">that information when the function is</span> <span data-start="621.52" data-end="624.13">hot enough to start compiling into our</span> <span data-start="624.13" data-end="626.65">jit compiler along with the bytecode for</span> <span data-start="626.65" data-end="628.6">the given function now what's different</span> <span data-start="628.6" data-end="630.97">in chakra is that we've bet heavily on</span> <span data-start="630.97" data-end="633.13">concurrency we believe there's a trend</span> <span data-start="633.13" data-end="635.77">in in hardware to having more and more</span> <span data-start="635.77" data-end="637.24">cores so you want to take advantage of</span> <span data-start="637.24" data-end="639.28">them as much as possible so in this case</span> <span data-start="639.28" data-end="641.32">our jit compiler runs concurrently on a</span> <span data-start="641.32" data-end="642.91">background thread and if you have</span> <span data-start="642.91" data-end="645.04">multiple cores you can get the</span> <span data-start="645.04" data-end="646.72">compilation while you're executing the</span> <span data-start="646.72" data-end="648.49">code so we can continue running your</span> <span data-start="648.49" data-end="650.74">code in the interpreter even as the JIT</span> <span data-start="650.74" data-end="652.96">compiler produces machine code for a</span> <span data-start="652.96" data-end="654.94">given function and then when that</span> <span data-start="654.94" data-end="656.89">machine code is ready we will swap it</span> <span data-start="656.89" data-end="658.69">back in and i will continue executing</span> <span data-start="658.69" data-end="660.82">just the machine code not interpreted</span> <span data-start="660.82" data-end="664.12">anymore so that minimizes any pauses</span> <span data-start="664.12" data-end="665.56">that might be introduced on the UI</span> <span data-start="665.56" data-end="668.59">thread by compilation everything is done</span> <span data-start="668.59" data-end="673.54">on the background thread and then the</span> <span data-start="673.54" data-end="675.01">other component of the system the</span> <span data-start="675.01" data-end="676.69">garbage collector is also designed to be</span> <span data-start="676.69" data-end="678.21">run concurrently as much as possible</span> <span data-start="678.21" data-end="680.92">most of the marketing and the sweeping</span> <span data-start="680.92" data-end="682.48">that we do leave a mark and sweep</span> <span data-start="682.48" data-end="684.19">collector is actually done concurrently</span> <span data-start="684.19" data-end="686.26">well there are some portions that we</span> <span data-start="686.26" data-end="688.06">have to do on the UI thread I won't get</span> <span data-start="688.06" data-end="690.19">into great detail of that but for the</span> <span data-start="690.19" data-end="691.51">most part we do the bulk of the work</span> <span data-start="691.51" data-end="693.4">concurrently so if you have three cores</span> <span data-start="693.4" data-end="696.07">and if you need to compile and garbage</span> <span data-start="696.07" data-end="697.63">collect and run your code concurrently</span> <span data-start="697.63" data-end="699.67">we can do all that stuff as long as you</span> <span data-start="699.67" data-end="701.68">have enough course and we believe we can</span> <span data-start="701.68" data-end="703.21">actually expand that relatively easily</span> <span data-start="703.21" data-end="705.52">to paralyse over more cores of those</span> <span data-start="705.52" data-end="707.86">become available so that's the key</span> <span data-start="707.86" data-end="709.39">aspect of our architecture there is</span> <span data-start="709.39" data-end="712.09">different from from other browsers and</span> <span data-start="712.09" data-end="716.26">then that the rest of the talk I'll</span> <span data-start="716.26" data-end="717.73">spend talking about the changes we've</span> <span data-start="717.73" data-end="719.5">made in ie10 particularly our jit</span> <span data-start="719.5" data-end="723.01">compiler because we've changed it quite</span> <span data-start="723.01" data-end="725.23">dramatically so you may or may not know</span> <span data-start="725.23" data-end="728.05">that in ie9 we we were able to generate</span> <span data-start="728.05" data-end="731.68">machine code only for x86 if you rent a</span> <span data-start="731.68" data-end="734.44">64-bit version of IE 9 you're actually</span> <span data-start="734.44" data-end="737.23">running in the interpreter only in i-10</span> <span data-start="737.23" data-end="739.42">we added machine code for x64 and</span> <span data-start="739.42" data-end="742.24">forearm as well so in all these cases we</span> <span data-start="742.24" data-end="745.15">have full JIT compilers now and then we</span> <span data-start="745.15" data-end="747.76">change the general philosophy of our jit</span> <span data-start="747.76" data-end="750.31">code that we omit I'll talk about that</span> <span data-start="750.31" data-end="752.14">in some detail but we we kind of adopted</span> <span data-start="752.14" data-end="753.94">a similar model do you see and other</span> <span data-start="753.94" data-end="756.31">browsers today of generating optimistic</span> <span data-start="756.31" data-end="758.62">code and then if things go wrong then</span> <span data-start="758.62" data-end="760.87">we'll just bail out and we read it if we</span> <span data-start="760.87" data-end="763.27">need to and that gives us a number of</span> <span data-start="763.27" data-end="765.61">other benefits we can generate faster</span> <span data-start="765.61" data-end="768.82">math both floating point and integer we</span> <span data-start="768.82" data-end="771.19">can do function inlining and we can we</span> <span data-start="771.19" data-end="772.12">actually have a number of other</span> <span data-start="772.12" data-end="773.83">optimizations are just strictly from the</span> <span data-start="773.83" data-end="776.38">compiler land and we also added support</span> <span data-start="776.38" data-end="778.09">for typed arrays that's not really a</span> <span data-start="778.09" data-end="779.68">compiler optimization but it gives you</span> <span data-start="779.68" data-end="781.78">if you really want access to native data</span> <span data-start="781.78" data-end="785.86">that is critical alright so the</span> <span data-start="785.86" data-end="788.02">optimistic profile based jet what is</span> <span data-start="788.02" data-end="789.43">that beast now if you're hanging out in</span> <span data-start="789.43" data-end="792.07">the in the bubble room this morning you</span> <span data-start="792.07" data-end="793.72">probably have seen much of that</span> <span data-start="793.72" data-end="795.1">explained but for those who are in there</span> </p>
<p><span data-start="795.1" data-end="798.22">I'll cover some of the basics so in ie9</span> <span data-start="798.22" data-end="800.29">the code that we would omit looks kind</span> <span data-start="800.29" data-end="802.51">of like this graphically we basically</span> <span data-start="802.51" data-end="804.76">try to handle all the nooks and crannies</span> <span data-start="804.76" data-end="807.52">of the of the JavaScript semantics so if</span> <span data-start="807.52" data-end="809.77">you have a plus B you know maybe two</span> <span data-start="809.77" data-end="811.27">numbers that you have to add by maybe it</span> <span data-start="811.27" data-end="813.16">is two strings I have to concatenate or</span> <span data-start="813.16" data-end="814.75">what have you we were trying to handle</span> <span data-start="814.75" data-end="817.12">all these cases which meant for</span> <span data-start="817.12" data-end="817.57">everything</span> <span data-start="817.57" data-end="819.01">other than integers we'd have to call</span> <span data-start="819.01" data-end="820.87">into the run time to do the operation</span> <span data-start="820.87" data-end="822.64">get back the result and then try to</span> <span data-start="822.64" data-end="824.68">continue which oftentimes men that we</span> <span data-start="824.68" data-end="826.06">have to call back into the runtime and</span> <span data-start="826.06" data-end="829.15">back and forth so for for integer</span> <span data-start="829.15" data-end="830.83">operations we were generally pretty</span> <span data-start="830.83" data-end="832.57">pretty good but for certain other things</span> <span data-start="832.57" data-end="836.56">we were not in 90 10 we're doing things</span> <span data-start="836.56" data-end="838.18">differently so we will collect the</span> <span data-start="838.18" data-end="840.16">profile that I mentioned before so now</span> <span data-start="840.16" data-end="842.08">we know that we primarily operates a on</span> <span data-start="842.08" data-end="843.91">floating point numbers so we'll generate</span> <span data-start="843.91" data-end="845.82">the code that is specialized for those</span> <span data-start="845.82" data-end="848.08">which typically results in a much</span> <span data-start="848.08" data-end="849.73">shorter and more compact and more</span> <span data-start="849.73" data-end="851.56">efficient code but then we have to check</span> <span data-start="851.56" data-end="853.99">that the conditions that we expect are</span> <span data-start="853.99" data-end="855.97">still true so if now he passes a bunch</span> <span data-start="855.97" data-end="857.56">of strings we have to do something else</span> <span data-start="857.56" data-end="859.78">so that's their little diamond on top we</span> <span data-start="859.78" data-end="861.49">check the conditions and if they turn</span> <span data-start="861.49" data-end="863.26">out to be false we have to bail out so</span> <span data-start="863.26" data-end="865.83">in our case bailing out means</span> <span data-start="865.83" data-end="868.06">transferring the state of execution over</span> <span data-start="868.06" data-end="870.04">to the interpreter and then continuing</span> <span data-start="870.04" data-end="872.35">that function in the interpreter when we</span> <span data-start="872.35" data-end="874.53">call the function again we will reach</span> <span data-start="874.53" data-end="876.94">re-enter the digit code if the</span> <span data-start="876.94" data-end="878.41">conditions are still not met will bail</span> <span data-start="878.41" data-end="880.62">out again if that happens sufficiently</span> <span data-start="880.62" data-end="882.67">frequently we will decide that it's time</span> <span data-start="882.67" data-end="885.07">to reach it that code with a different</span> <span data-start="885.07" data-end="886.69">set of conditions maybe it's a more</span> <span data-start="886.69" data-end="888.07">generic code again that is a little</span> <span data-start="888.07" data-end="890.08">slower but if that's the data you gave</span> <span data-start="890.08" data-end="891.97">us that's what we have to work with so</span> <span data-start="891.97" data-end="894.46">generally speaking our code adapts over</span> <span data-start="894.46" data-end="898.78">time to the data that you pass us great</span> <span data-start="898.78" data-end="901.15">and I mentioned that gives us a chance</span> <span data-start="901.15" data-end="904.54">to generate more efficient code but</span> <span data-start="904.54" data-end="905.86">first a little bit of a background why</span> <span data-start="905.86" data-end="908.5">that even matters you probably are well</span> <span data-start="908.5" data-end="910.69">familiar than JavaScript variables are</span> <span data-start="910.69" data-end="913.57">dynamically typed so at any given point</span> <span data-start="913.57" data-end="915.67">say a in this case could be a number</span> <span data-start="915.67" data-end="918.64">first then the floating point number are</span> <span data-start="918.64" data-end="921.13">straying that an object then even a data</span> <span data-start="921.13" data-end="924.76">a piece of date and we have to deal with</span> <span data-start="924.76" data-end="926.14">all the different values so typically</span> <span data-start="926.14" data-end="928.69">they were encoded on the heap with some</span> <span data-start="928.69" data-end="931.09">form of a type tag and then the value to</span> <span data-start="931.09" data-end="932.83">tell us how to deal with those those</span> <span data-start="932.83" data-end="936.22">types of values and they have to be</span> <span data-start="936.22" data-end="937.51">allocated on the heap and then the</span> <span data-start="937.51" data-end="938.74">garbage collector when they're no longer</span> <span data-start="938.74" data-end="941.05">used has to collect them all which has a</span> <span data-start="941.05" data-end="942.76">high overhead of course when it comes to</span> <span data-start="942.76" data-end="946.15">memory and then this also means that</span> <span data-start="946.15" data-end="948.28">that up the basic operations are quite</span> <span data-start="948.28" data-end="949.72">inefficient so if you just take this</span> <span data-start="949.72" data-end="951.37">simple a plus B plus C</span> <span data-start="951.37" data-end="952.42">you kind of break it down into</span> <span data-start="952.42" data-end="954.01">individual operations you have to add a</span> <span data-start="954.01" data-end="955.99">and B and then add the result to see and</span> <span data-start="955.99" data-end="958.99">then return that it turns out that it's</span> <span data-start="958.99" data-end="960.4">this lengthy sequence of things that you</span> <span data-start="960.4" data-end="962.08">have to do so you have to get a type of</span> <span data-start="962.08" data-end="965.47">a type of B then the value of a in value</span> <span data-start="965.47" data-end="967.81">of B then based on the types we have to</span> <span data-start="967.81" data-end="969.58">decide what to do maybe it's adding two</span> <span data-start="969.58" data-end="971.25">numbers maybe it's concatenated strings</span> <span data-start="971.25" data-end="973.75">then finally we have to execute that</span> <span data-start="973.75" data-end="976.81">operation get the result back stick it</span> <span data-start="976.81" data-end="978.22">back on the heap and only then we can</span> <span data-start="978.22" data-end="982.27">return it that's very inefficient in 99</span> <span data-start="982.27" data-end="984.55">we we employ the same trick that most of</span> <span data-start="984.55" data-end="986.35">the modern engines now do and that's</span> <span data-start="986.35" data-end="987.88">kind of a common thing in dynamically</span> <span data-start="987.88" data-end="991.38">typed languages we we use number tagging</span> <span data-start="991.38" data-end="993.61">if you're not familiar with it the idea</span> <span data-start="993.61" data-end="996.37">is generally pointers are aligned to a</span> <span data-start="996.37" data-end="998.23">certain boundary so the least</span> <span data-start="998.23" data-end="1000.69">significant bits typically three or four</span> <span data-start="1000.69" data-end="1003.66">are always zero so we can stick a one in</span> <span data-start="1003.66" data-end="1005.279">one of those bits and then use the rest</span> <span data-start="1005.279" data-end="1006.779">of the bits to indicate to actually</span> <span data-start="1006.779" data-end="1009.21">store the value of the integer it's like</span> <span data-start="1009.21" data-end="1010.8">in this case the number 3 can be encoded</span> <span data-start="1010.8" data-end="1012.89">directly in the register or on the stack</span> <span data-start="1012.89" data-end="1014.91">that helps because we don't have to</span> <span data-start="1014.91" data-end="1016.8">allocate it on the heap and grab it from</span> <span data-start="1016.8" data-end="1019.47">a heap every single time so in 99 we</span> <span data-start="1019.47" data-end="1022.38">were using that in ie10 on the 64-bit</span> <span data-start="1022.38" data-end="1024.839">platform we have more bits available so</span> <span data-start="1024.839" data-end="1026.55">we can stick floating-point numbers and</span> <span data-start="1026.55" data-end="1029.25">large integers also directly into</span> <span data-start="1029.25" data-end="1032.73">registers on a stack so that helps with</span> <span data-start="1032.73" data-end="1034.98">the math operations there are so long</span> <span data-start="1034.98" data-end="1036.99">sequence of steps but each of those</span> <span data-start="1036.99" data-end="1039.24">steps is a whole lot cheaper so if it</span> <span data-start="1039.24" data-end="1040.98">comes when it comes to grabbing the type</span> <span data-start="1040.98" data-end="1043.02">we just have to check for that one bit</span> <span data-start="1043.02" data-end="1045.15">we don't have to go the heap to get the</span> <span data-start="1045.15" data-end="1046.74">value we just have to remove the bit</span> <span data-start="1046.74" data-end="1049.35">that's also cheaper then we know what</span> <span data-start="1049.35" data-end="1051.51">operation to do just add two numbers and</span> <span data-start="1051.51" data-end="1053.85">at the end we just have to tag the</span> <span data-start="1053.85" data-end="1055.2">number instead of sticking back on the</span> <span data-start="1055.2" data-end="1057.75">heat great so there was better than the</span> <span data-start="1057.75" data-end="1060.24">you know and I ate but night n we can do</span> <span data-start="1060.24" data-end="1062.16">much better than that because now we</span> <span data-start="1062.16" data-end="1063.809">don't have to worry about all the other</span> <span data-start="1063.809" data-end="1065.9">conditions that we might want to handle</span> <span data-start="1065.9" data-end="1069.03">so that's just an example of an</span> <span data-start="1069.03" data-end="1070.559">operation a set of operations that we</span> <span data-start="1070.559" data-end="1072.15">will do from the SunSpider benchmark</span> <span data-start="1072.15" data-end="1074.25">this little loop right there basically</span> <span data-start="1074.25" data-end="1076.11">translates into that assembly do you see</span> <span data-start="1076.11" data-end="1077.85">on the right and if you well versed in</span> <span data-start="1077.85" data-end="1079.83">assembly you can get an idea that's</span> <span data-start="1079.83" data-end="1081.57">probably there's just about as tight as</span> <span data-start="1081.57" data-end="1083.85">it can be that's the something that a</span> <span data-start="1083.85" data-end="1085.17">c++ compiler wouldn't</span> <span data-start="1085.17" data-end="1086.76">be particularly ashamed of generating</span> <span data-start="1086.76" data-end="1088.86">for the same kind of code so it's quite</span> <span data-start="1088.86" data-end="1090.48">efficient with a one little exception</span> <span data-start="1090.48" data-end="1091.98">over there we have to check for the</span> <span data-start="1091.98" data-end="1093.78">overflow which is just required by the</span> <span data-start="1093.78" data-end="1096.48">semantics of the JavaScript operations</span> <span data-start="1096.48" data-end="1098.91">and if overflow happens you will notice</span> <span data-start="1098.91" data-end="1100.35">will actually bail out of this code and</span> <span data-start="1100.35" data-end="1104.04">and will try to reach it so that make</span> <span data-start="1104.04" data-end="1107.19">that makes integer math much faster for</span> <span data-start="1107.19" data-end="1108.48">floating-point math this is even more</span> <span data-start="1108.48" data-end="1110.19">important because previously you always</span> <span data-start="1110.19" data-end="1111.9">have to box the floating-point numbers</span> <span data-start="1111.9" data-end="1114.21">back and forth another example from</span> <span data-start="1114.21" data-end="1116.43">sunspider and again if you look at the</span> <span data-start="1116.43" data-end="1118.11">instructions on the right it's basically</span> <span data-start="1118.11" data-end="1120.03">just floating point operations on</span> <span data-start="1120.03" data-end="1122.79">registers so it's quite efficient a</span> <span data-start="1122.79" data-end="1124.68">couple exceptions there we actually take</span> <span data-start="1124.68" data-end="1126.75">a register spill this move SD that is</span> <span data-start="1126.75" data-end="1129">marked in red our linear scan register</span> <span data-start="1129" data-end="1131.07">allocator has some limitations in this</span> <span data-start="1131.07" data-end="1133.47">case it shows to spill this register and</span> <span data-start="1133.47" data-end="1136.23">then there's also the overflow check but</span> <span data-start="1136.23" data-end="1137.97">again generally speaking for local</span> <span data-start="1137.97" data-end="1139.98">variables for parameters they can</span> <span data-start="1139.98" data-end="1141.63">generate very tight and very efficient</span> <span data-start="1141.63" data-end="1145.23">floating-point and energy map there are</span> <span data-start="1145.23" data-end="1147.27">some limitations to it when you start</span> <span data-start="1147.27" data-end="1149.04">sticking those values into properties or</span> <span data-start="1149.04" data-end="1150.6">or extracting in front properties we</span> <span data-start="1150.6" data-end="1152.69">still have to box them or or tag them</span> <span data-start="1152.69" data-end="1155.28">and it turns out that you do actually do</span> <span data-start="1155.28" data-end="1157.41">a lot of operations on properties so</span> <span data-start="1157.41" data-end="1161.07">property access is also important and we</span> <span data-start="1161.07" data-end="1163.35">did a lot to make it faster in 99 we did</span> <span data-start="1163.35" data-end="1165.6">even more in ie10 I'll cover some of</span> <span data-start="1165.6" data-end="1167.94">that in the next few slides so generally</span> <span data-start="1167.94" data-end="1169.56">speaking it as a background which may be</span> <span data-start="1169.56" data-end="1171.66">obvious javascript objects just bags of</span> <span data-start="1171.66" data-end="1173.67">properties so traditionally you never</span> <span data-start="1173.67" data-end="1175.74">knew if you wanted to grab property X</span> <span data-start="1175.74" data-end="1177.84">you know when you were to find the value</span> <span data-start="1177.84" data-end="1179.37">of that property you always have to do a</span> <span data-start="1179.37" data-end="1181.56">dictionary you look up get the value and</span> <span data-start="1181.56" data-end="1184.85">then the same thing next time around</span> <span data-start="1184.85" data-end="1187.38">inline caches are typically used to help</span> <span data-start="1187.38" data-end="1189.3">that what they really are or just a way</span> <span data-start="1189.3" data-end="1192">to store to remember some information so</span> <span data-start="1192" data-end="1193.38">if you remember the object that you saw</span> <span data-start="1193.38" data-end="1195.39">before and know where to find property X</span> <span data-start="1195.39" data-end="1200.04">next time you could do it faster alright</span> <span data-start="1200.04" data-end="1203.36">so in ie9 we we added inline caches and</span> <span data-start="1203.36" data-end="1205.53">for the inline caches we have to keep</span> <span data-start="1205.53" data-end="1208.35">track of shapes of the objects or</span> <span data-start="1208.35" data-end="1209.76">internal classes as they're called in</span> <span data-start="1209.76" data-end="1212.58">the eighth and we kind of typically call</span> <span data-start="1212.58" data-end="1215.13">them internal types so here's an example</span> <span data-start="1215.13" data-end="1217.26">of a constructor that creates two</span> <span data-start="1217.26" data-end="1218.64">different objects and just gives an x</span> <span data-start="1218.64" data-end="1219">and y</span> <span data-start="1219" data-end="1222.06">properties and shapes are basically</span> <span data-start="1222.06" data-end="1224.34">sequences of properties that are added</span> <span data-start="1224.34" data-end="1226.47">to an object so we follow the evolution</span> <span data-start="1226.47" data-end="1228.84">of an object and then we associate a</span> <span data-start="1228.84" data-end="1230.79">certain shape with that object so here</span> <span data-start="1230.79" data-end="1233.58">the shape would be X Y and the bubble</span> <span data-start="1233.58" data-end="1235.02">indicates that it's the right from a</span> <span data-start="1235.02" data-end="1237.36">certain prototype if then you create the</span> <span data-start="1237.36" data-end="1240.03">second object b2 which follows the exact</span> <span data-start="1240.03" data-end="1242.43">same code path it'll have the same type</span> <span data-start="1242.43" data-end="1246.09">or shape and then subsequent accesses</span> <span data-start="1246.09" data-end="1247.65">the properties of those objects will be</span> <span data-start="1247.65" data-end="1249.63">monomorphic meaning the objects will</span> <span data-start="1249.63" data-end="1251.61">have the same shape and we can do quite</span> <span data-start="1251.61" data-end="1254.49">well in ie9 for for those types of</span> <span data-start="1254.49" data-end="1257.76">objects here's just a quick example if</span> <span data-start="1257.76" data-end="1259.95">you now call this reset method in a loop</span> <span data-start="1259.95" data-end="1263.07">which then tries to set x and y 20 we</span> <span data-start="1263.07" data-end="1264.63">have an inline cassius o ciated right</span> <span data-start="1264.63" data-end="1266.22">here with that instruction and the</span> <span data-start="1266.22" data-end="1267.93">inline cash remembers the type and</span> <span data-start="1267.93" data-end="1272.01">remembers the slot at which we found</span> <span data-start="1272.01" data-end="1274.47">property X last time it starts zeroed</span> <span data-start="1274.47" data-end="1276.51">out there is nothing there and this is</span> <span data-start="1276.51" data-end="1278.1">roughly the code that we would omit for</span> <span data-start="1278.1" data-end="1280.32">to access that property you don't have</span> <span data-start="1280.32" data-end="1282.6">to understand all of it the key thing</span> <span data-start="1282.6" data-end="1285.18">here is we check the type or the shape</span> <span data-start="1285.18" data-end="1287.82">of the object against the shape shape</span> <span data-start="1287.82" data-end="1289.55">that we remember in the inline cash</span> <span data-start="1289.55" data-end="1291.66">right now they don't match because the</span> <span data-start="1291.66" data-end="1293.19">cash is not initialized so we have to do</span> <span data-start="1293.19" data-end="1295.8">a slow look up but after we're done we</span> <span data-start="1295.8" data-end="1297.21">store that information in the inline</span> <span data-start="1297.21" data-end="1299.73">cash and so next time around when you go</span> <span data-start="1299.73" data-end="1302.4">through that loop and get to this type</span> <span data-start="1302.4" data-end="1305.19">check it succeeds and so if it succeeds</span> <span data-start="1305.19" data-end="1307.05">we have a fast way of getting them or</span> <span data-start="1307.05" data-end="1308.55">setting the value of that property we</span> <span data-start="1308.55" data-end="1309.87">just made those those three instructions</span> <span data-start="1309.87" data-end="1312.6">so that works really well if the shapes</span> <span data-start="1312.6" data-end="1315.21">match but in JavaScript you can throw</span> <span data-start="1315.21" data-end="1316.59">additional properties into objects</span> <span data-start="1316.59" data-end="1319.86">afterwards and in this case if b2 got a</span> <span data-start="1319.86" data-end="1321.87">property see now it has a different</span> <span data-start="1321.87" data-end="1323.58">shape so we have two different objects</span> <span data-start="1323.58" data-end="1325.95">with different shapes and so access has</span> <span data-start="1325.95" data-end="1329.19">become polymorphic and a 99 there are</span> <span data-start="1329.19" data-end="1331.08">some limitations to how fast you can be</span> <span data-start="1331.08" data-end="1333.21">with the polymorphic properties because</span> <span data-start="1333.21" data-end="1335.52">we only remember one type at a time so</span> <span data-start="1335.52" data-end="1337.68">here is the same example with with those</span> <span data-start="1337.68" data-end="1339.84">two modified objects and we started off</span> <span data-start="1339.84" data-end="1343.08">the same way we populate the cash but</span> <span data-start="1343.08" data-end="1344.28">then on a second iteration of the loop</span> <span data-start="1344.28" data-end="1346.44">when it comes to this check we remember</span> </p>
<p><span data-start="1346.44" data-end="1350.31">XY what we have now is XYZ so we the</span> <span data-start="1350.31" data-end="1352.99">types don't match and we have to go down</span> <span data-start="1352.99" data-end="1355.24">that so basically in the worst possible</span> <span data-start="1355.24" data-end="1357.01">case if you were just flip-flopping</span> <span data-start="1357.01" data-end="1359.44">between two different types we would</span> <span data-start="1359.44" data-end="1360.97">always go down the slow path and our</span> <span data-start="1360.97" data-end="1362.32">inline caches weren't particularly</span> <span data-start="1362.32" data-end="1364.78">helpful it turned out that uh for the</span> <span data-start="1364.78" data-end="1366.73">most part the accesses aren't exactly</span> <span data-start="1366.73" data-end="1368.89">alternating like that so most of the</span> <span data-start="1368.89" data-end="1370.54">time you're still hitting the cash but</span> <span data-start="1370.54" data-end="1372.28">there's a some performance overhead of</span> <span data-start="1372.28" data-end="1375.34">polymorphic properties so night n we</span> <span data-start="1375.34" data-end="1377.71">actually added two polymorphic caches</span> <span data-start="1377.71" data-end="1380.14">that can keep track of virtually</span> <span data-start="1380.14" data-end="1381.61">unlimited number of types so our</span> <span data-start="1381.61" data-end="1383.11">polymorphic property access is much</span> <span data-start="1383.11" data-end="1386.64">better and then we took advantage of the</span> <span data-start="1386.64" data-end="1389.59">optimistic code generation to get better</span> <span data-start="1389.59" data-end="1392.559">property access using object type</span> <span data-start="1392.559" data-end="1394.15">specialization I will explain that and</span> <span data-start="1394.15" data-end="1395.95">then we generally streamlight our object</span> <span data-start="1395.95" data-end="1397.24">layout to make them thinner and</span> <span data-start="1397.24" data-end="1399.34">requiring fewer allocations and then</span> <span data-start="1399.34" data-end="1400.929">some of the compiler optimizations added</span> <span data-start="1400.929" data-end="1403.78">also apply to those and so here's an</span> <span data-start="1403.78" data-end="1405.79">example on the left hand side it would</span> <span data-start="1405.79" data-end="1407.65">be the code that we would generate a 99</span> <span data-start="1407.65" data-end="1409.48">to add the values of those three</span> <span data-start="1409.48" data-end="1412.21">properties and on the right hand side is</span> <span data-start="1412.21" data-end="1414.4">what we do at i-10 so 99 you see that we</span> <span data-start="1414.4" data-end="1416.02">execute the same sequence of operations</span> <span data-start="1416.02" data-end="1417.97">for every one of those those property</span> <span data-start="1417.97" data-end="1420.37">loads we checked the type of 0 every</span> <span data-start="1420.37" data-end="1421.66">single time even though it's the same</span> <span data-start="1421.66" data-end="1424.42">object oh so it seems redundant it turns</span> <span data-start="1424.42" data-end="1426.22">out it wasn't trivial to eliminate but</span> <span data-start="1426.22" data-end="1428.29">9010 we did get smarter we just omit</span> <span data-start="1428.29" data-end="1430.12">this check once and then subsequent</span> <span data-start="1430.12" data-end="1431.95">property loads we just know exactly</span> <span data-start="1431.95" data-end="1434.23">where to find x y&z once we know the</span> <span data-start="1434.23" data-end="1437.32">shape of of 0 and you notice those</span> <span data-start="1437.32" data-end="1438.97">bailout instructions there on the light</span> <span data-start="1438.97" data-end="1441.4">on the right those basically mean that</span> <span data-start="1441.4" data-end="1442.99">if we're the objects shape does not</span> <span data-start="1442.99" data-end="1444.25">match we have to jump out to the</span> <span data-start="1444.25" data-end="1446.02">interpreter and we have to deal with it</span> <span data-start="1446.02" data-end="1448.059">there and we will recompile the the</span> <span data-start="1448.059" data-end="1451.66">function later so this is great that</span> <span data-start="1451.66" data-end="1453.79">actually is more efficient where you get</span> <span data-start="1453.79" data-end="1455.38">the biggest bang for the buck is when</span> <span data-start="1455.38" data-end="1457.63">that type of instruction is executed in</span> <span data-start="1457.63" data-end="1460.179">the loop with the loop invariant code</span> <span data-start="1460.179" data-end="1462.79">motion we can detect that the object o</span> <span data-start="1462.79" data-end="1464.86">is now changing and we can hoist all</span> <span data-start="1464.86" data-end="1466.39">these expensive checks outside of the</span> <span data-start="1466.39" data-end="1468.67">loop we run them once and then in the</span> <span data-start="1468.67" data-end="1472.96">loop the execute multiple times we avoid</span> <span data-start="1472.96" data-end="1475.3">the overhead in this trivial example it</span> <span data-start="1475.3" data-end="1478.45">turns out that x y&z also don't change</span> <span data-start="1478.45" data-end="1481.39">so we hoist the loads of those and since</span> <span data-start="1481.39" data-end="1483.82">they don't change the plus operations</span> <span data-start="1483.82" data-end="1485.83">are also redundant and they can be moved</span> <span data-start="1485.83" data-end="1486.79">out of the loop so</span> <span data-start="1486.79" data-end="1488.17">this trivial example the loop itself</span> <span data-start="1488.17" data-end="1492.67">becomes quite trivial but then if you</span> <span data-start="1492.67" data-end="1494.53">were to insert a function call into that</span> <span data-start="1494.53" data-end="1496.96">loop we would have a problem because it</span> <span data-start="1496.96" data-end="1499.09">turns out in JavaScript function calls</span> <span data-start="1499.09" data-end="1501.79">can change half of the world so the</span> <span data-start="1501.79" data-end="1503.83">function calculate for all we know could</span> <span data-start="1503.83" data-end="1505.63">be changing the shape of o may be</span> <span data-start="1505.63" data-end="1508.21">removed property X or something and so</span> <span data-start="1508.21" data-end="1510.25">now we have to execute all these checks</span> <span data-start="1510.25" data-end="1511.96">and all these loads on every iteration</span> <span data-start="1511.96" data-end="1514.54">of the loop so function calls tend to</span> <span data-start="1514.54" data-end="1516.91">kill most of the optimizations than any</span> <span data-start="1516.91" data-end="1519.16">of the engines can do and that's why</span> <span data-start="1519.16" data-end="1520.51">function inlining is such a critical</span> <span data-start="1520.51" data-end="1523.77">piece of of every video of every</span> </p>
<p><span data-start="1523.77" data-end="1526.99">JavaScript engine today so if you can</span> <span data-start="1526.99" data-end="1530.2">inline calculate we can see inside that</span> <span data-start="1530.2" data-end="1531.85">we can prove that Oh still doesn't</span> <span data-start="1531.85" data-end="1534.04">change and XYZ still doesn't change so</span> <span data-start="1534.04" data-end="1535.39">all these things can be still hoisted</span> <span data-start="1535.39" data-end="1537.67">outside of the loop so not only do we</span> <span data-start="1537.67" data-end="1539.26">eliminate the overhead of the function</span> <span data-start="1539.26" data-end="1541.06">call but we get to retain some of the</span> <span data-start="1541.06" data-end="1542.85">other optimizations that we did before</span> <span data-start="1542.85" data-end="1546.22">so in lining in ie10 is also a great</span> <span data-start="1546.22" data-end="1549.37">benefit and so yeah so better math</span> <span data-start="1549.37" data-end="1551.59">better property access a function</span> <span data-start="1551.59" data-end="1552.91">aligning those are the critical pieces</span> <span data-start="1552.91" data-end="1555.37">that we added in i-10 and it kind of</span> <span data-start="1555.37" data-end="1557.67">covers the basics of the JIT compiler</span> <span data-start="1557.67" data-end="1560.89">and I am I about five minutes left I</span> <span data-start="1560.89" data-end="1562.21">only want to mention a couple of</span> <span data-start="1562.21" data-end="1563.59">additional things I alluded to this</span> <span data-start="1563.59" data-end="1566.65">already you may or may not know that in</span> </p>
<p><span data-start="1566.65" data-end="1568.51">Windows 8 we actually took a big bet on</span> <span data-start="1568.51" data-end="1571.33">JavaScript and HTML so we can build</span> <span data-start="1571.33" data-end="1574.12">native applications in Windows 8 using</span> <span data-start="1574.12" data-end="1576.52">web technologies they're not running any</span> <span data-start="1576.52" data-end="1577.72">kind of a web control or anything like</span> <span data-start="1577.72" data-end="1579.4">that they're actually native apps that</span> <span data-start="1579.4" data-end="1582.04">have access to all the native API and in</span> <span data-start="1582.04" data-end="1584.02">fact several of the apps that we ship in</span> <span data-start="1584.02" data-end="1585.94">box with windows 8 are written in</span> </p>
<p><span data-start="1585.94" data-end="1588.22">JavaScript and HTML so if you ever</span> <span data-start="1588.22" data-end="1590.35">wanted to stretch your muscle flexing</span> <span data-start="1590.35" data-end="1591.94">JavaScript muscles on a different</span> <span data-start="1591.94" data-end="1594.58">platform use definitely encouraged to</span> <span data-start="1594.58" data-end="1597.04">try to grab the windows 8 and then try</span> <span data-start="1597.04" data-end="1598.6">to play with it we think it's an</span> <span data-start="1598.6" data-end="1599.77">interesting opportunity and it's</span> <span data-start="1599.77" data-end="1601.93">definitely we believe that it's where</span> <span data-start="1601.93" data-end="1605.23">the future is and we want to support the</span> <span data-start="1605.23" data-end="1607.6">platform the web platform as a way of</span> <span data-start="1607.6" data-end="1610.99">developing apps for Windows 8 and then</span> <span data-start="1610.99" data-end="1614.2">my last cheesy slide for the day are we</span> <span data-start="1614.2" data-end="1615.67">done of course we're not there's a bunch</span> <span data-start="1615.67" data-end="1616.95">of other things that we'd like to do</span> <span data-start="1616.95" data-end="1618.94">there are some things that are not as</span> <span data-start="1618.94" data-end="1620.62">efficient as they as they should</span> <span data-start="1620.62" data-end="1622.57">but there is also a bunch of trends that</span> <span data-start="1622.57" data-end="1623.89">we kind of follow that you want to make</span> <span data-start="1623.89" data-end="1627.49">sure chakra is a great engine for so of</span> <span data-start="1627.49" data-end="1630.16">course as es5 gets more adoption there</span> <span data-start="1630.16" data-end="1631.75">are certain things we like to optimize</span> <span data-start="1631.75" data-end="1634.66">as Ahmed script 6 is evolving we also</span> <span data-start="1634.66" data-end="1636.73">want to be sure that we first comply</span> <span data-start="1636.73" data-end="1637.87">with the spec second that the</span> <span data-start="1637.87" data-end="1641.86">implementation is fast html5 games</span> <span data-start="1641.86" data-end="1643.54">certainly an important target for us</span> </p>
<p><span data-start="1643.54" data-end="1645.61">Windows 8 apps of course you want to</span> <span data-start="1645.61" data-end="1646.99">make sure that they run very fast and</span> <span data-start="1646.99" data-end="1649.27">then other things your web workers are</span> <span data-start="1649.27" data-end="1651.309">an interesting trend for instance maybe</span> <span data-start="1651.309" data-end="1653.74">more concurrent compilation they more</span> <span data-start="1653.74" data-end="1655.059">concurrent garbage collection as in</span> <span data-start="1655.059" data-end="1658.63">order to handle concurrency in advanced</span> <span data-start="1658.63" data-end="1660.85">apps and so on and so forth the bottom</span> <span data-start="1660.85" data-end="1663.16">line is we want to be sure that chakra</span> <span data-start="1663.16" data-end="1665.14">is a great platform for building the</span> <span data-start="1665.14" data-end="1666.46">kind of apps that you want to build</span> <span data-start="1666.46" data-end="1668.98">today and tomorrow and with that I think</span> <span data-start="1668.98" data-end="1671.559">we have about three minutes left so I'm</span> <span data-start="1671.559" data-end="1673.6">happy to take questions you can also</span> <span data-start="1673.6" data-end="1685.66">grab me with by email or Twitter thanks</span> <span data-start="1685.66" data-end="1687.929">but I was I had a quick question you</span> <span data-start="1687.929" data-end="1690.97">said that you just in time compile in 64</span> <span data-start="1690.97" data-end="1692.29">bit but I was under the impression that</span> <span data-start="1692.29" data-end="1694.33">data execution protection was mandatory</span> <span data-start="1694.33" data-end="1697.36">for 64-bit applications so which would</span> <span data-start="1697.36" data-end="1701.29">make the memory not not executable how</span> <span data-start="1701.29" data-end="1702.97">do you get around that no there's there</span> <span data-start="1702.97" data-end="1705.16">is an API that a process can call to</span> <span data-start="1705.16" data-end="1707.37">make a piece of executable or data</span> <span data-start="1707.37" data-end="1710.8">executable and we call that API but what</span> <span data-start="1710.8" data-end="1712.54">we what we make sure is that the window</span> <span data-start="1712.54" data-end="1716.02">of of time that you have to potentially</span> <span data-start="1716.02" data-end="1718.12">override the code that we omit it before</span> <span data-start="1718.12" data-end="1720.7">it's locked up is minimal it's just</span> <span data-start="1720.7" data-end="1722.44">really the time between we copy the</span> <span data-start="1722.44" data-end="1725.26">buffer into the right page and we lock</span> <span data-start="1725.26" data-end="1733.08">it</span> <span data-start="1733.09" data-end="1736.21">so so my main question is can you</span> <span data-start="1736.21" data-end="1738.01">actually see the generated code on a</span> <span data-start="1738.01" data-end="1740.86">normal chakra not on some custom build</span> <span data-start="1740.86" data-end="1744.13">no you can't set an internal tool that</span> <span data-start="1744.13" data-end="1745.9">that basically host chakra in a</span> <span data-start="1745.9" data-end="1748.78">statically well if you were able to</span> <span data-start="1748.78" data-end="1751.33">build a checked build of chakra than yes</span> <span data-start="1751.33" data-end="1753.34">all the switches for dumping the output</span> <span data-start="1753.34" data-end="1755.47">are there but that's not what we should</span> </p>
<p><span data-start="1755.47" data-end="1762.16">I have a question about the the inline</span> <span data-start="1762.16" data-end="1764.23">caches yeah so since you can't actually</span> <span data-start="1764.23" data-end="1768.19">right into the memory once it's been the</span> <span data-start="1768.19" data-end="1770.08">code has already been generated where do</span> <span data-start="1770.08" data-end="1771.67">you actually keep yes that's an</span> <span data-start="1771.67" data-end="1772.84">excellent question i forgot to mention</span> <span data-start="1772.84" data-end="1775.6">that specifically so inline caches are</span> <span data-start="1775.6" data-end="1776.8">implemented differently on different</span> <span data-start="1776.8" data-end="1778.93">engines in some cases an inline cash is</span> <span data-start="1778.93" data-end="1781.27">actually a snippet of code with directly</span> <span data-start="1781.27" data-end="1783.79">hard-coded values in our case that</span> <span data-start="1783.79" data-end="1785.71">cannot be because we need to be able to</span> <span data-start="1785.71" data-end="1787.63">update the cache so for us a cache is</span> <span data-start="1787.63" data-end="1790.21">just a piece of data that that our code</span> <span data-start="1790.21" data-end="1792.37">references so we have our we hard code</span> <span data-start="1792.37" data-end="1794.74">the location of the inline cash in the</span> <span data-start="1794.74" data-end="1797.41">assembly that we omit but then the cash</span> <span data-start="1797.41" data-end="1799.18">itself is just data and is not protected</span> <span data-start="1799.18" data-end="1803.52">so we can override it that make sense</span> <span data-start="1803.52" data-end="1806.68">all right um so you mentioned bytecode</span> <span data-start="1806.68" data-end="1808.66">caching for Windows 8 apps so you</span> <span data-start="1808.66" data-end="1810.46">compile the bytecode and you put that in</span> <span data-start="1810.46" data-end="1812.17">the store and we down with that does</span> <span data-start="1812.17" data-end="1815.29">that work for or am I am I correct and</span> <span data-start="1815.29" data-end="1817.15">how that works and why don't you do that</span> <span data-start="1817.15" data-end="1820.57">for caching JavaScript and i-10 right so</span> <span data-start="1820.57" data-end="1821.98">it's actually slightly different than</span> <span data-start="1821.98" data-end="1824.29">that we regenerate bytecode on the</span> <span data-start="1824.29" data-end="1826.41">target machine when you install the app</span> <span data-start="1826.41" data-end="1829.33">we schedule the byte code generation</span> <span data-start="1829.33" data-end="1830.89">sort of in the background and whenever</span> <span data-start="1830.89" data-end="1833.11">that is available we will start using</span> <span data-start="1833.11" data-end="1835.06">the bytecode until then we can we can</span> <span data-start="1835.06" data-end="1836.38">still run from source code there's no</span> <span data-start="1836.38" data-end="1838.81">limitation there so the bike go is not</span> <span data-start="1838.81" data-end="1840.19">in the store strictly speaking it sits</span> <span data-start="1840.19" data-end="1842.11">on the machine we did contemplate</span> <span data-start="1842.11" data-end="1844.06">putting it in the browser and it's so</span> <span data-start="1844.06" data-end="1845.35">very much a question that we're</span> <span data-start="1845.35" data-end="1847.84">considering it's a little harder in a</span> <span data-start="1847.84" data-end="1849.88">sense that you don't have a moment when</span> <span data-start="1849.88" data-end="1851.47">the app is installed in the box and</span> <span data-start="1851.47" data-end="1853.33">certainly JavaScript can be you know the</span> </p>
<p><span data-start="1853.33" data-end="1855.25">JavaScript that you load can be changing</span> <span data-start="1855.25" data-end="1857.26">more frequently than then the app that</span> <span data-start="1857.26" data-end="1858.61">is installed in the box but there's</span> <span data-start="1858.61" data-end="1861.01">nothing technically you're making it</span> <span data-start="1861.01" data-end="1862.06">impossible and we certainly are</span> <span data-start="1862.06" data-end="1865.09">contemplating that as well if</span> <span data-start="1865.09" data-end="1868.57">will windows phone 8 be running chakra</span> <span data-start="1868.57" data-end="1871.51">true well windows phone 8 windows why I</span> <span data-start="1871.51" data-end="1875.14">guess we'll get I 10 yes okay that</span> <span data-start="1875.14" data-end="1877.48">didn't answer the question uh what what</span> <span data-start="1877.48" data-end="1879.28">do you mean by chakra to you mean they</span> <span data-start="1879.28" data-end="1881.92">would run the same JavaScript and yeah</span> <span data-start="1881.92" data-end="1888.28">okay sorry any the question all right</span> <span data-start="1888.28" data-end="1889.72">let's see that's it thank you very much</span> </p>
</section>