<section>
<p><span data-start="17.91" data-end="21.939">well it's good to be here I'm pleased to</span> <span data-start="21.939" data-end="24.43">see that as soon as anyone puts up a</span> <span data-start="24.43" data-end="26.89">chat at a conference people try and hack</span> <span data-start="26.89" data-end="29.739">it with cross-site scripting it's a good</span> <span data-start="29.739" data-end="34.03">good sign for a tech conference I'm Alex</span> <span data-start="34.03" data-end="36.73">macaw and actually we're already off to</span> <span data-start="36.73" data-end="38.5">a good start because in my last</span> <span data-start="38.5" data-end="40.36">presentation that J's Kampf</span> <span data-start="40.36" data-end="43.649">I actually spelled my name wrong so</span> <span data-start="43.649" data-end="45.879">they're already off to a good start</span> <span data-start="45.879" data-end="50.43">so this the this slides about the</span> <span data-start="50.43" data-end="52.539">deconstruction of a JavaScript web app</span> <span data-start="52.539" data-end="54.87">and this JavaScript web app is called</span> <span data-start="54.87" data-end="58">monocle now I can't want to give you a</span> <span data-start="58" data-end="59.579">warning that this presentation is really</span> <span data-start="59.579" data-end="63.73">code heavy but pretty pretty much every</span> <span data-start="63.73" data-end="66.64">slide has code on it and we're going to</span> <span data-start="66.64" data-end="68.08">try and cover the whole out which also</span> <span data-start="68.08" data-end="71.259">means Ruby and CoffeeScript so a little</span> <span data-start="71.259" data-end="74.5">warning there so what is monocle well</span> <span data-start="74.5" data-end="76.84">it's the social news aggregation side</span> <span data-start="76.84" data-end="79.09">it's a lot like hacking use if you use</span> <span data-start="79.09" data-end="81.55">that and you can go and check it out</span> <span data-start="81.55" data-end="86.53">monocle dot IO and it's got a very</span> <span data-start="86.53" data-end="88.42">pretty in a face done by a designer</span> <span data-start="88.42" data-end="91.239">friend of mine and we have posted on the</span> </p>
<p><span data-start="91.239" data-end="94.929">Left content on the right and members</span> <span data-start="94.929" data-end="98.739">can post new links and post comments and</span> <span data-start="98.739" data-end="100.27">they're just we're extracting a bit of</span> <span data-start="100.27" data-end="104.289">the post a bit of text from the post and</span> <span data-start="104.289" data-end="107.95">we're also extracting a preview image so</span> <span data-start="107.95" data-end="111.28">today I'm open sourcing this see if you</span> <span data-start="111.28" data-end="113.349">actually go to github.com slash macman</span> <span data-start="113.349" data-end="116.8">slash monocle you can download it and I</span> <span data-start="116.8" data-end="119.86">actually suggest you clone it right now</span> <span data-start="119.86" data-end="122.739">so you can actually go through the code</span> <span data-start="122.739" data-end="125.2">as I'm talking about it it'll give you a</span> <span data-start="125.2" data-end="128.17">lot more context to the app so I'm just</span> <span data-start="128.17" data-end="132.789">gonna give you a few moments to do that</span> <span data-start="132.799" data-end="136.859">if you open it up you'll see the</span> <span data-start="136.859" data-end="139.95">structure structure and you'll notice</span> <span data-start="139.95" data-end="142.23">that it's using Sinatra the whole app is</span> <span data-start="142.23" data-end="145.26">built on Sinatra and most of the</span> <span data-start="145.26" data-end="146.639">application code is under the app</span> <span data-start="146.639" data-end="148.829">directory so notice we also have this</span> </p>
<p><span data-start="148.829" data-end="151.2">MVC architecture we have models views</span> <span data-start="151.2" data-end="153.45">controllers in this case we call</span> <span data-start="153.45" data-end="157.709">controllers routes now any client-side</span> <span data-start="157.709" data-end="161.549">code is on their app assets and the</span> <span data-start="161.549" data-end="163.26">father bootstraps the whole app is</span> <span data-start="163.26" data-end="167.879">called AB dot RB makes sense right this</span> <span data-start="167.879" data-end="169.31">is what it looks like</span> <span data-start="169.31" data-end="171.599">notice we're adding each route as</span> <span data-start="171.599" data-end="174.18">middleware each route is its own Sinatra</span> <span data-start="174.18" data-end="176.01">app which is I think the best way of</span> <span data-start="176.01" data-end="179.879">actually architecting Sinatra apps so we</span> <span data-start="179.879" data-end="181.76">are adding rec deflator therefore</span> <span data-start="181.76" data-end="185.79">gzipping support we are adding RAC CSRF</span> <span data-start="185.79" data-end="187.76">there for cross-site scripting</span> <span data-start="187.76" data-end="190.739">cross-site request forgery attack</span> <span data-start="190.739" data-end="193.109">prevention and then we're adding our own</span> <span data-start="193.109" data-end="195.78">routes so we have static first not just</span> <span data-start="195.78" data-end="198.93">static files we have the users for users</span> </p>
<p><span data-start="198.93" data-end="201.12">API we have the route the posts are out</span> <span data-start="201.12" data-end="204.06">for the posts API comments for comments</span> <span data-start="204.06" data-end="206.519">API and the client and the last one is</span> <span data-start="206.519" data-end="208.409">actually what serves up our JavaScript</span> <span data-start="208.409" data-end="210.78">client so let's mosey down into the</span> <span data-start="210.78" data-end="213.479">client and have a look at that if you</span> <span data-start="213.479" data-end="217.169">open up client dot RB you can see our</span> <span data-start="217.169" data-end="219.079">client is bootstrapped in a few steps</span> <span data-start="219.079" data-end="223.29">first any request to / or / posts is</span> <span data-start="223.29" data-end="227.159">caught now this rather ugly regex is</span> <span data-start="227.159" data-end="229.439">what's doing that there's a there's</span> <span data-start="229.439" data-end="232.109">actually a better way of doing this but</span> <span data-start="232.109" data-end="234.72">for now we're using a regex so our</span> </p>
<p><span data-start="234.72" data-end="236.459">JavaScript client will be served up at</span> <span data-start="236.459" data-end="239.34">any of those URLs so regardless of if</span> <span data-start="239.34" data-end="240.87">they're for a force so we didn't</span> <span data-start="240.87" data-end="242.519">actually check to see if a URL is rather</span> <span data-start="242.519" data-end="246.15">at this point we also check to see if</span> <span data-start="246.15" data-end="247.859">the request is from supported mobile</span> <span data-start="247.859" data-end="250.799">client and if it is then we serve up a</span> <span data-start="250.799" data-end="253.159">specialized mobile version of the app so</span> <span data-start="253.159" data-end="256.229">let's took take a look at index dot our</span> <span data-start="256.229" data-end="259.829">er B which is being rendered there this</span> <span data-start="259.829" data-end="261.329">is what it looks like we have one</span> <span data-start="261.329" data-end="264.63">concatenated CSS file one concatenated</span> <span data-start="264.63" data-end="266.17">javascript file</span> <span data-start="266.17" data-end="268.91">we have nothing in the body tag and</span> <span data-start="268.91" data-end="271.79">everything is generated and notice how</span> <span data-start="271.79" data-end="273.91">we have defer and all the script tags</span> <span data-start="273.91" data-end="276.29">that makes sure that the page isn't</span> <span data-start="276.29" data-end="278.84">blocked during rendering and also notice</span> <span data-start="278.84" data-end="281.39">that we have the setup to J's file which</span> <span data-start="281.39" data-end="284.57">is actually going to bootstrap the app</span> <span data-start="284.57" data-end="286.97">it's going to accentuate the app with</span> <span data-start="286.97" data-end="290.03">pre-loaded data so we jump back to</span> <span data-start="290.03" data-end="292.13">client client dot RB we can actually see</span> <span data-start="292.13" data-end="294.59">how these assets are generated anything</span> <span data-start="294.59" data-end="296.81">under slash assets is being served up by</span> <span data-start="296.81" data-end="297.98">sprockets</span> <span data-start="297.98" data-end="301.28">which is a Ruby asset manager I use it</span> <span data-start="301.28" data-end="303.56">everywhere I highly recommend you use it</span> <span data-start="303.56" data-end="305.93">and the thing underst</span> <span data-start="305.93" data-end="309.47">it set up the gist is generated by that</span> <span data-start="309.47" data-end="312.59">little function there it actually</span> <span data-start="312.59" data-end="314.36">generates this JavaScript file and it</span> <span data-start="314.36" data-end="316.76">pre-populated with data you can see</span> <span data-start="316.76" data-end="318.65">we're doing a sequel query here we're</span> <span data-start="318.65" data-end="320.72">setting up some options instance</span> <span data-start="320.72" data-end="322.4">variable and then we're rendering the</span> <span data-start="322.4" data-end="325.55">setup DRB a template if we jump down</span> <span data-start="325.55" data-end="329.3">into that you can see that the EOB</span> <span data-start="329.3" data-end="331.61">generates some JavaScript and you can</span> <span data-start="331.61" data-end="333.2">see all it's doing is requiring the app</span> <span data-start="333.2" data-end="335.87">and I'll get on a bit later in the talk</span> <span data-start="335.87" data-end="338.84">about how require actually works and</span> <span data-start="338.84" data-end="342.22">then instantiating this app variable and</span> <span data-start="342.22" data-end="345.95">appending it to the body so if we go</span> <span data-start="345.95" data-end="347.42">through the steps again browser</span> <span data-start="347.42" data-end="351.49">navigates to slash the client which</span> <span data-start="351.49" data-end="354.52">matches this the client slash route</span> <span data-start="354.52" data-end="357.47">returns indexed or ARB whereas the</span> <span data-start="357.47" data-end="359.39">fetches CSS and JavaScript and then also</span> <span data-start="359.39" data-end="361.79">the setup that Jas and then the browser</span> <span data-start="361.79" data-end="364.21">is instantiated and then app is ready so</span> <span data-start="364.21" data-end="366.83">so we look at the front end which is</span> <span data-start="366.83" data-end="368.69">probably better topic for this</span> <span data-start="368.69" data-end="370.13">conference</span> <span data-start="370.13" data-end="372.44">it's an MVC structure — - we have</span> <span data-start="372.44" data-end="374.8">controllers we have models we have views</span> <span data-start="374.8" data-end="379.01">and in this case the views are eco</span> <span data-start="379.01" data-end="382.15">templates which is a CoffeeScript</span> <span data-start="382.15" data-end="387.37">templating framework or language</span> <span data-start="387.37" data-end="389.51">actually it's much easier to look at</span> <span data-start="389.51" data-end="391.67">these controllers visually we have one</span> <span data-start="391.67" data-end="393.89">main app controller which encompasses</span> <span data-start="393.89" data-end="396.23">the whole app everything else belongs to</span> <span data-start="396.23" data-end="399.08">that then we have two main sub</span> <span data-start="399.08" data-end="399.65">controllers</span> <span data-start="399.65" data-end="403.46">the sidebar this is Sabo doc modular</span> <span data-start="403.46" data-end="407.3">coffee and then we have hosts the post</span> <span data-start="407.3" data-end="409.25">controller posts top modular coffee and</span> <span data-start="409.25" data-end="411.789">then those two main sub controllers</span> <span data-start="411.789" data-end="415.759">themselves have self controllers we have</span> <span data-start="415.759" data-end="419.84">the post details and we also have post</span> <span data-start="419.84" data-end="422.96">comments now the key thing is to note</span> <span data-start="422.96" data-end="424.55">that none of these controllers know</span> <span data-start="424.55" data-end="426.35">about the other controllers they only</span> <span data-start="426.35" data-end="428.21">know about the sub controllers they only</span> <span data-start="428.21" data-end="429.979">know about models so although they're</span> <span data-start="429.979" data-end="432.5">all really decoupled if we're going to</span> <span data-start="432.5" data-end="434.6">talk about decoupling we can't not talk</span> <span data-start="434.6" data-end="437.21">about conscious modules so if you notice</span> <span data-start="437.21" data-end="439.82">all this files on the front-end have dot</span> <span data-start="439.82" data-end="441.949">module in the file name this is because</span> <span data-start="441.949" data-end="444.77">they're common jeaious modules now what</span> <span data-start="444.77" data-end="447.05">exactly does that mean well commonjs</span> <span data-start="447.05" data-end="448.52">gives you require and it gives you</span> <span data-start="448.52" data-end="451.76">exports and they're absolutely critical</span> <span data-start="451.76" data-end="454.82">to building I think any large JavaScript</span> <span data-start="454.82" data-end="457.55">apps without them you get spaghetti code</span> <span data-start="457.55" data-end="460.94">and you get a namespace pollution so if</span> <span data-start="460.94" data-end="464.03">you're using sprockets then you can</span> <span data-start="464.03" data-end="466.37">easily get a common chair support by</span> <span data-start="466.37" data-end="469.19">just adding the gem sprockets comment</span> <span data-start="469.19" data-end="472.91">yes there you just add that gem and</span> <span data-start="472.91" data-end="475.58">you're good to go all you have to do is</span> <span data-start="475.58" data-end="477.889">put module on the file name and we'll</span> <span data-start="477.889" data-end="481.13">wrap it up as a common Janus module and</span> <span data-start="481.13" data-end="483.53">essentially this means the file is</span> <span data-start="483.53" data-end="485.659">wrapped by some boiler pote boilerplate</span> <span data-start="485.659" data-end="489.44">code and so it's executed in a local</span> <span data-start="489.44" data-end="491.3">scope and that boilerplate code also</span> <span data-start="491.3" data-end="494.659">gives it the require function and the</span> <span data-start="494.659" data-end="497.69">ability to export values and functions</span> <span data-start="497.69" data-end="500.659">so you have required at the top you can</span> <span data-start="500.659" data-end="502.37">require the modules and then at the</span> <span data-start="502.37" data-end="503.78">bottom of every single module you have</span> <span data-start="503.78" data-end="508.13">an export which basically exposes</span> <span data-start="508.13" data-end="511.909">particular values so if you now go back</span> <span data-start="511.909" data-end="514.459">to index dot module dot RB a few things</span> <span data-start="514.459" data-end="516.229">should make more sense now this is the</span> <span data-start="516.229" data-end="518.709">main app controller if you remember</span> <span data-start="518.709" data-end="521.029">everything else belongs to that at the</span> <span data-start="521.029" data-end="524.39">top we're loading in all the controllers</span> <span data-start="524.39" data-end="528.079">and models we're going to need and then</span> <span data-start="528.079" data-end="530.779">we create this class code app this is</span> <span data-start="530.779" data-end="533.13">the Harriton from controller and</span> <span data-start="533.13" data-end="536.519">exporting at the bottom when app is</span> <span data-start="536.519" data-end="539.1">instantiated we're setting we're using</span> <span data-start="539.1" data-end="540.66">all the preloaded data passed him by</span> <span data-start="540.66" data-end="544.29">selectively Jas and then finally we</span> <span data-start="544.29" data-end="546.69">instantiate our main sub controllers</span> <span data-start="546.69" data-end="550.5">pending them to the page and then if you</span> <span data-start="550.5" data-end="552.3">have a look at post controller it's very</span> <span data-start="552.3" data-end="554.85">similar we're doing the same thing we're</span> <span data-start="554.85" data-end="556.649">acquiring our controllers we're</span> <span data-start="556.649" data-end="558.569">listening to events and we're appending</span> <span data-start="558.569" data-end="561">sub-controllers so it's fairly</span> <span data-start="561" data-end="563.61">straightforward now you may have noticed</span> <span data-start="563.61" data-end="565.079">this controller object they were</span> <span data-start="565.079" data-end="567.06">inheriting from what exactly is that</span> <span data-start="567.06" data-end="570.48">well if you've built MVC II apps before</span> <span data-start="570.48" data-end="573.269">you may be familiar with controllers the</span> </p>
<p><span data-start="573.269" data-end="577.41">C part of MVC a lot of MVC libraries</span> <span data-start="577.41" data-end="579.75">call these views like backbone I call</span> <span data-start="579.75" data-end="582.949">them controllers is just terminology now</span> <span data-start="582.949" data-end="585.54">in molecule I'm not actually using</span> <span data-start="585.54" data-end="587.25">backbone I'm not actually using spine</span> <span data-start="587.25" data-end="589.68">I'm using this pasteurization of both of</span> <span data-start="589.68" data-end="593.37">them which it combines what I think is</span> <span data-start="593.37" data-end="594.54">some of the best ideas from both for</span> <span data-start="594.54" data-end="596.04">them and I actually want to take you</span> <span data-start="596.04" data-end="597.66">through some of this library because I</span> <span data-start="597.66" data-end="599.85">think it's simple and has some neat</span> <span data-start="599.85" data-end="602.13">approaches that you can apply to your</span> <span data-start="602.13" data-end="604.11">own apps even if you're not using the</span> <span data-start="604.11" data-end="607.68">sly berry so this is controller dot</span> <span data-start="607.68" data-end="610.889">module dock coffee and this is found in</span> <span data-start="610.889" data-end="613.5">the vendor directory and this is the</span> <span data-start="613.5" data-end="614.79">whole library right here</span> <span data-start="614.79" data-end="617.67">so a controller's job is scoping</span> <span data-start="617.67" data-end="621.06">behavior to a single element so every</span> <span data-start="621.06" data-end="623">single controller has a single element</span> <span data-start="623" data-end="626.49">called e/l now there might be a little</span> <span data-start="626.49" data-end="628.259">hard to read it might be a bit small I'm</span> <span data-start="628.259" data-end="630.36">sorry about that but you can see at the</span> <span data-start="630.36" data-end="633.689">top we're creating this element and then</span> <span data-start="633.689" data-end="635.759">we're creating a jquery wrapped version</span> <span data-start="635.759" data-end="637.319">of this element which is called dollar</span> <span data-start="637.319" data-end="641.759">e-l and then a lot of controllers have</span> <span data-start="641.759" data-end="643.23">this class named property if that's</span> <span data-start="643.23" data-end="646.86">present we're adding it to the element</span> <span data-start="646.86" data-end="648.75">we're heading at class to the element</span> <span data-start="648.75" data-end="650.88">and what was it going to listen to this</span> <span data-start="650.88" data-end="652.23">removed event I'm going to talk more</span> <span data-start="652.23" data-end="656.339">about that later ignore it for now so</span> <span data-start="656.339" data-end="658.079">most of the controller functions are</span> <span data-start="658.079" data-end="660.18">just delegating straits to that jQuery</span> <span data-start="660.18" data-end="662.639">wrapped element and they're adding</span> <span data-start="662.639" data-end="665.459">events appending bits of HTML that kind</span> <span data-start="665.459" data-end="666.799">of thing</span> <span data-start="666.799" data-end="670.229">so the last two functions in this</span> <span data-start="670.229" data-end="672.329">controller file of view and template and</span> <span data-start="672.329" data-end="675.599">they make it really easy to to fetch an</span> <span data-start="675.599" data-end="678.569">eco template and render it and pass</span> <span data-start="678.569" data-end="680.489">through helpers to it so you can see</span> <span data-start="680.489" data-end="683.939">that sprockets creates this global</span> <span data-start="683.939" data-end="686.819">variable called jst and it hatches all</span> <span data-start="686.819" data-end="689.879">the templates to it as properties now</span> <span data-start="689.879" data-end="692.279">you can just fetch your template there</span> <span data-start="692.279" data-end="695.339">it'll be a function you look it up by</span> <span data-start="695.339" data-end="697.139">property it'll be function and then you</span> <span data-start="697.139" data-end="699.239">can execute that function pass through a</span> <span data-start="699.239" data-end="703.499">context and you'll get a string all view</span> <span data-start="703.499" data-end="705.539">is doing is actually decorating the</span> <span data-start="705.539" data-end="708.959">context with any helpers that are</span> <span data-start="708.959" data-end="713.22">present so in otherwise you render views</span> <span data-start="713.22" data-end="716.639">like this you pass a view a function</span> <span data-start="716.639" data-end="719.759">named sorry ever a template name it</span> <span data-start="719.759" data-end="722.939">returns a function itself and then I you</span> <span data-start="722.939" data-end="724.679">basically execute that function in you</span> <span data-start="724.679" data-end="727.439">pass your context so when it compiled</span> <span data-start="727.439" data-end="729.419">rendered as a string and then you just</span> <span data-start="729.419" data-end="731.659">set the elements HTML to that string</span> <span data-start="731.659" data-end="733.349">pretty straightforward</span> <span data-start="733.349" data-end="735.089">now let's talk about something pretty</span> <span data-start="735.089" data-end="736.739">neat let's jump back into the controller</span> <span data-start="736.739" data-end="738.779">library and talk about that removed</span> <span data-start="738.779" data-end="741.479">event now this removed event will</span> <span data-start="741.479" data-end="742.889">actually be fired whenever that</span> <span data-start="742.889" data-end="745.639">controller is removed from the DOM and</span> <span data-start="745.639" data-end="749.699">then our release function is called now</span> <span data-start="749.699" data-end="752.189">this is a pretty useful little utility</span> <span data-start="752.189" data-end="754.679">because if you've registered any global</span> <span data-start="754.679" data-end="757.919">event handlers say listening to keyboard</span> <span data-start="757.919" data-end="760.289">events for example in the controllers</span> <span data-start="760.289" data-end="763.109">constructor then in the release function</span> <span data-start="763.109" data-end="765.209">the bottom you can unregister those</span> <span data-start="765.209" data-end="768.239">events basically cleanup a global event</span> <span data-start="768.239" data-end="771.089">lessness other language like objective-c</span> <span data-start="771.089" data-end="775.019">have same kind of thing so how does that</span> <span data-start="775.019" data-end="776.399">removed event as you get fired</span> <span data-start="776.399" data-end="779.659">well we're kind of using this neat trick</span> <span data-start="779.659" data-end="783.029">called jquery a special events and you</span> <span data-start="783.029" data-end="784.859">can have a look this is basically the</span> <span data-start="784.859" data-end="787.559">entire codes to fire that removed event</span> <span data-start="787.559" data-end="790.169">and it's in jQuery dot event or remove</span> <span data-start="790.169" data-end="790.909">dot coffee</span> <span data-start="790.909" data-end="793.799">so whenever jquery removes an element it</span> <span data-start="793.799" data-end="797.249">actually passes it through this clean</span> <span data-start="797.249" data-end="799.74">data function jquery dot clean data</span> <span data-start="799.74" data-end="801.18">which actually goes through a removes</span> <span data-start="801.18" data-end="802.74">all the event listeners the jQuery is</span> <span data-start="802.74" data-end="804.84">added to that element and now this is</span> <span data-start="804.84" data-end="806.99">useful because in some browsers like IE</span> <span data-start="806.99" data-end="809.61">event listeners aren't removed properly</span> <span data-start="809.61" data-end="811.92">and you get memory leaks so jQuery has</span> <span data-start="811.92" data-end="814.59">to actually remove all the event</span> <span data-start="814.59" data-end="816.15">listeners from itself and you can just</span> <span data-start="816.15" data-end="818.91">tap into that functionality and define</span> <span data-start="818.91" data-end="821.22">your own event and the zone your own</span> <span data-start="821.22" data-end="823.65">events could removed and wait and when</span> <span data-start="823.65" data-end="825.39">jQuery tries to clean up this event from</span> <span data-start="825.39" data-end="828.12">elements you actually fire it rather</span> <span data-start="828.12" data-end="830.97">than clean it up and so then you</span> <span data-start="830.97" data-end="832.64">automatically fire this removed event</span> <span data-start="832.64" data-end="835.2">and then it'll trigger the release</span> <span data-start="835.2" data-end="837.09">function and controllers and you</span> <span data-start="837.09" data-end="838.77">automatically cleaning up controllers</span> <span data-start="838.77" data-end="840.69">and there's a very simple way of doing</span> <span data-start="840.69" data-end="844.53">that so we cover the controller library</span> <span data-start="844.53" data-end="847.97">let's jump back into the post controller</span> <span data-start="847.97" data-end="852.68">notice we've got the state objects now</span> <span data-start="852.68" data-end="854.94">which we're adding an event listener to</span> <span data-start="854.94" data-end="860.1">this post property now whenever I want</span> <span data-start="860.1" data-end="862.68">had to have global state in my app I</span> <span data-start="862.68" data-end="865.82">have to attach it to the state object</span> <span data-start="865.82" data-end="868.02">now I try to keep global state to a</span> <span data-start="868.02" data-end="871.86">minimum and and actually a monocle the</span> <span data-start="871.86" data-end="873.81">only property is in global state are the</span> <span data-start="873.81" data-end="875.67">current user the current environment</span> <span data-start="875.67" data-end="878.09">like developmental production and</span> <span data-start="878.09" data-end="880.11">crucially the currently viewed post</span> <span data-start="880.11" data-end="881.7">which is what we're listening to here so</span> <span data-start="881.7" data-end="883.95">whenever that changes the controller is</span> <span data-start="883.95" data-end="886.86">going to re-render itself if you have a</span> <span data-start="886.86" data-end="888.3">look at the state module state of</span> <span data-start="888.3" data-end="890.31">modular coffee it essentially looks like</span> <span data-start="890.31" data-end="892.44">this we have a state class that inherits</span> <span data-start="892.44" data-end="895.68">from model and and notice the bottom</span> <span data-start="895.68" data-end="898.47">that we're actually instantiating that</span> <span data-start="898.47" data-end="901.35">state class there's only ever one</span> <span data-start="901.35" data-end="904.41">instance of their state class so there</span> <span data-start="904.41" data-end="907.08">are other models too that represent all</span> <span data-start="907.08" data-end="908.58">the major data structures in the app we</span> <span data-start="908.58" data-end="911.07">have posts comments etc these are all</span> <span data-start="911.07" data-end="913.32">whole data related state rather than</span> <span data-start="913.32" data-end="915.06">view related state which is a realm of</span> <span data-start="915.06" data-end="918.18">the controller and if you have a look at</span> <span data-start="918.18" data-end="920.61">the post mod model post on wanted of</span> <span data-start="920.61" data-end="924.09">coffee it looks a bit like this however</span> </p>
<p><span data-start="924.09" data-end="926.22">I'm gonna stop right there because it's</span> <span data-start="926.22" data-end="927.6">unlikely you're going to be using this</span> <span data-start="927.6" data-end="929.67">custom MVC framework</span> <span data-start="929.67" data-end="931.529">there's got no following your support</span> <span data-start="931.529" data-end="932.73">it's just something I like tinkering</span> <span data-start="932.73" data-end="935.579">around with so I won't expand a much of</span> <span data-start="935.579" data-end="938.399">this part of app but what I do want to</span> <span data-start="938.399" data-end="941.49">cover is parts that you are gonna reuse</span> <span data-start="941.49" data-end="943.079">that it hopefully be useful in the kind</span> <span data-start="943.079" data-end="944.6">of JavaScript apps that you're making</span> <span data-start="944.6" data-end="949.05">such as scoping CSS so let's take a</span> <span data-start="949.05" data-end="951.39">simple controller this is the landing</span> <span data-start="951.39" data-end="953.94">page this is displayed if no post is</span> <span data-start="953.94" data-end="956.55">selected notice the top we have this</span> <span data-start="956.55" data-end="960.57">class name property pretty much every</span> <span data-start="960.57" data-end="962.79">controller has this when instantiated</span> <span data-start="962.79" data-end="964.62">this class name will be actually being</span> <span data-start="964.62" data-end="968.67">added to the controller's element every</span> <span data-start="968.67" data-end="971.04">controller has a corresponding CSS file</span> <span data-start="971.04" data-end="975.47">so posts landing dot module has this</span> <span data-start="975.47" data-end="976.62">post</span> <span data-start="976.62" data-end="981.329">unschooling dot CSS style CSS file now</span> </p>
<p><span data-start="981.329" data-end="983.459">I'm not actually using stylus sorry I'm</span> <span data-start="983.459" data-end="985.11">not actually using plain CSS I'm using</span> <span data-start="985.11" data-end="987.57">stylus for this if you're not familiar</span> <span data-start="987.57" data-end="989.399">stylus it's just another CSS</span> <span data-start="989.399" data-end="994.29">preprocessor like less or sass but the</span> <span data-start="994.29" data-end="995.519">key thing here is that notice that</span> <span data-start="995.519" data-end="998.64">everything in this CSS file is named</span> <span data-start="998.64" data-end="1001.67">spaced by the class name property we</span> <span data-start="1001.67" data-end="1005.449">said earlier so all the CSS is specific</span> <span data-start="1005.449" data-end="1009.44">to that controller so my advice is to</span> <span data-start="1009.44" data-end="1011.24">make CSS as specific as possible when</span> <span data-start="1011.24" data-end="1013.3">you're making the large JavaScript apps</span> <span data-start="1013.3" data-end="1015.44">don't worry about China's too much</span> <span data-start="1015.44" data-end="1017.51">repetition will be removed a lot by</span> <span data-start="1017.51" data-end="1019.459">gzipping there may be a performance</span> <span data-start="1019.459" data-end="1021.949">impact for this but again you can</span> <span data-start="1021.949" data-end="1025">approach that later if if it's a problem</span> <span data-start="1025" data-end="1027.74">now if a controller has sub controllers</span> <span data-start="1027.74" data-end="1029.569">then you may find that a controller CSS</span> <span data-start="1029.569" data-end="1032.24">is actually affecting all those elements</span> <span data-start="1032.24" data-end="1035.569">that are appended to it and this just</span> <span data-start="1035.569" data-end="1037.01">means you need to get more specific you</span> <span data-start="1037.01" data-end="1039.26">can use the right-hand bracket here and</span> <span data-start="1039.26" data-end="1041.569">that's what only select the direct</span> <span data-start="1041.569" data-end="1045.47">children of this element I want to talk</span> <span data-start="1045.47" data-end="1047.51">a bit about how we created the</span> <span data-start="1047.51" data-end="1051.25">scrollable list and the side bar of</span> </p>
<p><span data-start="1051.25" data-end="1054.44">Monaco and also how we added keyboard</span> <span data-start="1054.44" data-end="1056.179">shortcuts to it if you use the up and</span> <span data-start="1056.179" data-end="1057.59">down arrow keys you'll notice that they</span> <span data-start="1057.59" data-end="1060.89">work right in Monaco you have this</span> <span data-start="1060.89" data-end="1063.5">infinite list a post in the sidebar</span> <span data-start="1063.5" data-end="1065.059">now this list is actually rendered by</span> <span data-start="1065.059" data-end="1067.789">the posts lists controller and each list</span> <span data-start="1067.789" data-end="1070.7">item is rendered by the posts item</span> <span data-start="1070.7" data-end="1073.46">controller it makes sense if we open up</span> <span data-start="1073.46" data-end="1076.34">the posts lists controller post list or</span> <span data-start="1076.34" data-end="1079.429">modular coffee we can step through the</span> <span data-start="1079.429" data-end="1082">execution flow and see what's going on</span> <span data-start="1082" data-end="1085.85">okay so the controller is instantiated</span> <span data-start="1085.85" data-end="1088.809">and we're calling render immediately</span> <span data-start="1088.809" data-end="1091.12">surrender just cleans up the dom</span> <span data-start="1091.12" data-end="1094.669">basically empties all the elements in</span> <span data-start="1094.669" data-end="1098.02">the controller and then cause a doll and</span> <span data-start="1098.02" data-end="1102.47">then a doll will iterate through this</span> <span data-start="1102.47" data-end="1103.669">collection the collection is basically</span> <span data-start="1103.669" data-end="1106.309">just an array of posts instances and</span> <span data-start="1106.309" data-end="1108.169">then for each one and we'll call this</span> <span data-start="1108.169" data-end="1112.22">add one function and that just append a</span> <span data-start="1112.22" data-end="1115.28">new post item to the controller's</span> <span data-start="1115.28" data-end="1117.98">element now the post item controller</span> <span data-start="1117.98" data-end="1120.23">will take care of rendering itself</span> <span data-start="1120.23" data-end="1122.72">rendering a little section of that list</span> <span data-start="1122.72" data-end="1125.33">and it'll take care of rear-ending it if</span> <span data-start="1125.33" data-end="1128.27">the name changes of the the vote the</span> <span data-start="1128.27" data-end="1130.58">upvote score increases that kind of</span> <span data-start="1130.58" data-end="1132.59">thing and it'll also take care of</span> <span data-start="1132.59" data-end="1134.419">listening to click events when people up</span> <span data-start="1134.419" data-end="1138.59">vary posts now if you remember earlier</span> <span data-start="1138.59" data-end="1140.419">we had this global state with a post</span> <span data-start="1140.419" data-end="1143.15">property so if we actually listen to</span> <span data-start="1143.15" data-end="1145.94">that we can actually light whichever</span> <span data-start="1145.94" data-end="1149.51">post is currently selected so we're</span> <span data-start="1149.51" data-end="1154.159">listening to the change post anyway we</span> <span data-start="1154.159" data-end="1155.299">can get rid of the little video the</span> <span data-start="1155.299" data-end="1159.169">bottom it's kind of blocking the code so</span> <span data-start="1159.169" data-end="1162.23">we're listening to the the posts</span> <span data-start="1162.23" data-end="1163.88">property on state and we're calling the</span> <span data-start="1163.88" data-end="1166.73">set post function whenever it changes</span> <span data-start="1166.73" data-end="1171.11">now if we define set post function what</span> <span data-start="1171.11" data-end="1173.33">we can do is we're setting this instance</span> <span data-start="1173.33" data-end="1175.61">variable called at post and then we're</span> <span data-start="1175.61" data-end="1178.28">calling set active instead active will</span> <span data-start="1178.28" data-end="1181.4">iterate through all the Dom elements in</span> <span data-start="1181.4" data-end="1182">the list</span> <span data-start="1182" data-end="1184.97">remove the active class and then if</span> <span data-start="1184.97" data-end="1187.789">there is a post it'll try and find that</span> <span data-start="1187.789" data-end="1190.94">using a data ID selector and add the</span> <span data-start="1190.94" data-end="1192.919">class of accident to it and then we've</span> <span data-start="1192.919" data-end="1195.08">got this interesting function scroll</span> <span data-start="1195.08" data-end="1197.089">into view if needed</span> <span data-start="1197.089" data-end="1199.789">and what exactly does that do well is</span> <span data-start="1199.789" data-end="1202.849">actually a little-known WebKit function</span> <span data-start="1202.849" data-end="1205.309">it's on elements inside WebKit and it</span> <span data-start="1205.309" data-end="1208.399">does what it says on the tin so in this</span> <span data-start="1208.399" data-end="1211.879">case of abstracted it — jQuery plug-in</span> <span data-start="1211.879" data-end="1213.32">but slightly just a method on Dom</span> <span data-start="1213.32" data-end="1215.659">elements and if you call it Atlas it'll</span> <span data-start="1215.659" data-end="1217.94">scroll that element into the view it's</span> <span data-start="1217.94" data-end="1220.549">super useful and in other browsers that</span> <span data-start="1220.549" data-end="1223.429">aren't WebKit based there and you can</span> <span data-start="1223.429" data-end="1226.909">just use this shim so this ensures that</span> <span data-start="1226.909" data-end="1229.039">whatever current element is selected</span> <span data-start="1229.039" data-end="1231.769">it'll be visible which is important when</span> <span data-start="1231.769" data-end="1233.989">you're doing up-and-down keyboard</span> <span data-start="1233.989" data-end="1238.219">navigation which is the next section so</span> <span data-start="1238.219" data-end="1239.95">we can add up and down</span> <span data-start="1239.95" data-end="1242.839">keyboard bindings to the sidebar</span> <span data-start="1242.839" data-end="1243.529">controller</span> <span data-start="1243.529" data-end="1245.269">so again if you open up side by top</span> <span data-start="1245.269" data-end="1248.719">modular coffee we can add a global event</span> <span data-start="1248.719" data-end="1251.239">listener for key down in the constructor</span> <span data-start="1251.239" data-end="1254.479">here and then we can clean that up in</span> <span data-start="1254.479" data-end="1255.859">the release function they remember</span> <span data-start="1255.859" data-end="1257.749">that's quite important because if the</span> <span data-start="1257.749" data-end="1259.519">controller's roof removed from the Dom</span> <span data-start="1259.519" data-end="1265.549">we want that to be cleaned up now we</span> <span data-start="1265.549" data-end="1267.829">actually have a key mapping property on</span> <span data-start="1267.829" data-end="1270.229">here now you can see that that's just</span> <span data-start="1270.229" data-end="1273.769">mapping a key code to a function name so</span> <span data-start="1273.769" data-end="1277.339">38 is the up key 40 down key we also</span> <span data-start="1277.339" data-end="1280.969">have this key down event listener</span> <span data-start="1280.969" data-end="1282.95">callback which is what we were listening</span> <span data-start="1282.95" data-end="1285.32">to it's listening to keyboard events in</span> <span data-start="1285.32" data-end="1288.95">the document so basically all it does is</span> <span data-start="1288.95" data-end="1292.339">check to see if there's a key mapping</span> <span data-start="1292.339" data-end="1295.339">for a specific event key code and if</span> <span data-start="1295.339" data-end="1299.749">there is it'll execute it so in this</span> <span data-start="1299.749" data-end="1302.539">case we have two callbacks 38 40 up and</span> <span data-start="1302.539" data-end="1306.889">down caret keys and the keyboard so down</span> <span data-start="1306.889" data-end="1309.469">arrow down a rate goes down key which in</span> <span data-start="1309.469" data-end="1312.829">turn calls next post notice that what</span> <span data-start="1312.829" data-end="1315.469">we're doing is looking to see which item</span> <span data-start="1315.469" data-end="1318.159">has an active class and then we're using</span> <span data-start="1318.159" data-end="1322.329">jQuery is next and dot previous</span> <span data-start="1322.329" data-end="1324.799">functions to try and find whatever the</span> <span data-start="1324.799" data-end="1327.259">next previous element is click on it and</span> <span data-start="1327.259" data-end="1330.38">we just basically simulate a click it</span> <span data-start="1330.38" data-end="1332.99">as if the user clicked it themselves but</span> <span data-start="1332.99" data-end="1334.1">we have a problem here we have a</span> <span data-start="1334.1" data-end="1337.19">scrolling conflict because the browser</span> <span data-start="1337.19" data-end="1339.17">also uses the up and down arrow keys to</span> <span data-start="1339.17" data-end="1341.27">scroll the contents so if you remember</span> <span data-start="1341.27" data-end="1343.1">we're actually managing the scrolling of</span> <span data-start="1343.1" data-end="1344.75">the sidebar ourselves were scrolling to</span> <span data-start="1344.75" data-end="1347.78">view if needed we could just cancel all</span> <span data-start="1347.78" data-end="1349.85">the scroll events but the scrolling that</span> <span data-start="1349.85" data-end="1351.26">needs to happen in other parts of the</span> <span data-start="1351.26" data-end="1353.78">app so these are actually the two main</span> <span data-start="1353.78" data-end="1356.39">scroll areas we have the sidebar we have</span> <span data-start="1356.39" data-end="1358.82">the main content so we basically need to</span> <span data-start="1358.82" data-end="1361.19">figure out which areas focus if the</span> <span data-start="1361.19" data-end="1363.8">sidebar has focus then we can just</span> <span data-start="1363.8" data-end="1367.43">cancel scroll events or and that are</span> <span data-start="1367.43" data-end="1368.78">associated with the up and down arrow</span> <span data-start="1368.78" data-end="1370.82">keys and do the scrolling ourselves if</span> <span data-start="1370.82" data-end="1375.07">it's if the main part number two has</span> <span data-start="1375.07" data-end="1380.32">focus then we need to not scroll the</span> <span data-start="1380.32" data-end="1382.34">sidebar and we just need to let the</span> <span data-start="1382.34" data-end="1385.45">browser as you scroll the content itself</span> <span data-start="1385.45" data-end="1389.42">so if you think about it the the active</span> <span data-start="1389.42" data-end="1392.45">areas with is whichever area was clicked</span> <span data-start="1392.45" data-end="1396.74">last so I try to find a browser API to</span> <span data-start="1396.74" data-end="1399.89">do this doesn't exist I tried for hours</span> <span data-start="1399.89" data-end="1402.85">you think it would exist it's kind of a</span> <span data-start="1402.85" data-end="1405.05">logical thing to put in the browser but</span> <span data-start="1405.05" data-end="1407.54">it doesn't so we're gonna have to do</span> <span data-start="1407.54" data-end="1410.75">this ourselves we can create this jQuery</span> <span data-start="1410.75" data-end="1414.14">door active area Coffee jQuery plugin</span> <span data-start="1414.14" data-end="1416.48">and all it does is you can mark up</span> <span data-start="1416.48" data-end="1418.64">active areas in your app and it will</span> <span data-start="1418.64" data-end="1421.16">listen to click events on them when a</span> <span data-start="1421.16" data-end="1424.82">click event is listed or activated it's</span> <span data-start="1424.82" data-end="1426.95">going to call this active area callback</span> <span data-start="1426.95" data-end="1429.11">and then it's just going to set the</span> <span data-start="1429.11" data-end="1432.5">current variable and then we can have</span> <span data-start="1432.5" data-end="1434.21">another function that just checks to see</span> <span data-start="1434.21" data-end="1438.56">if if specific Dom element is the</span> <span data-start="1438.56" data-end="1442.64">current one so let's mark up our active</span> <span data-start="1442.64" data-end="1444.05">areas and the posts and sidebar</span> <span data-start="1444.05" data-end="1445.55">controller</span> <span data-start="1445.55" data-end="1449.09">these are our two main areas that are</span> <span data-start="1449.09" data-end="1450.89">scrollable if you remember now these are</span> <span data-start="1450.89" data-end="1451.64">going to be listened to</span> <span data-start="1451.64" data-end="1454.46">now we go back to our sidebar controller</span> <span data-start="1454.46" data-end="1458.54">what we can do is check to see if the</span> <span data-start="1458.54" data-end="1461.81">element is active if it's not just</span> <span data-start="1461.81" data-end="1464.21">ignore the event it's that simple</span> </p>
<p><span data-start="1464.21" data-end="1468.08">I want to talk a bit about dynamic</span> <span data-start="1468.08" data-end="1471.86">pagination now this is a pretty tricky</span> <span data-start="1471.86" data-end="1475.67">problem actually so in molecule thus</span> <span data-start="1475.67" data-end="1477.32">order a post on the left side is</span> <span data-start="1477.32" data-end="1479.36">actually dynamic a single vote could</span> <span data-start="1479.36" data-end="1482.27">cause the post to raise up or down and</span> <span data-start="1482.27" data-end="1484.67">also there's a time decay which also</span> <span data-start="1484.67" data-end="1487.85">affects rankings but once the user is</span> <span data-start="1487.85" data-end="1489.5">scroll to the bottom of this list we</span> <span data-start="1489.5" data-end="1490.85">need to figure out what the next pages</span> <span data-start="1490.85" data-end="1494.75">fetch it and add it to the list we we</span> <span data-start="1494.75" data-end="1497.12">need to figure out the next page even if</span> <span data-start="1497.12" data-end="1499.61">it involves not putting duplicates in</span> <span data-start="1499.61" data-end="1500.9">this one even if the list has already</span> <span data-start="1500.9" data-end="1505.09">changed so what do other people do well</span> <span data-start="1505.09" data-end="1507.35">what does hacking use do well actually</span> <span data-start="1507.35" data-end="1509.96">stores every single possible sort</span> <span data-start="1509.96" data-end="1513.56">combination in enclosure and as you can</span> <span data-start="1513.56" data-end="1516.01">imagine this gets bigger and bigger is</span> <span data-start="1516.01" data-end="1518.48">exponentially huge as you have more</span> <span data-start="1518.48" data-end="1523.85">posts so what what happens ultimately</span> <span data-start="1523.85" data-end="1527.32">well the garbage collector kicks in and</span> <span data-start="1527.32" data-end="1531.02">and then it cleans up this closures and</span> <span data-start="1531.02" data-end="1533.57">that means you get expired pagination</span> <span data-start="1533.57" data-end="1534.98">link so you may have seen it in hacker</span> <span data-start="1534.98" data-end="1538.46">news it's kind of shitty really it kind</span> <span data-start="1538.46" data-end="1540.29">of does the same thing except it shows</span> <span data-start="1540.29" data-end="1542.03">even more duplicates on the second page</span> <span data-start="1542.03" data-end="1548.3">so how do you solve this well I was on</span> <span data-start="1548.3" data-end="1549.86">holiday would take Thornton recently and</span> <span data-start="1549.86" data-end="1551.63">he told me what he did with medium and</span> <span data-start="1551.63" data-end="1555.17">it's very simple but it's very good I</span> <span data-start="1555.17" data-end="1559.01">think hex to this problem so in other</span> <span data-start="1559.01" data-end="1561.32">words what you do is whenever you fetch</span> <span data-start="1561.32" data-end="1563.87">the next page of posts you send an array</span> <span data-start="1563.87" data-end="1565.76">containing all the previously fetched</span> <span data-start="1565.76" data-end="1568.43">post items IDs so the ones that you</span> <span data-start="1568.43" data-end="1570.29">already have on the page you send that</span> <span data-start="1570.29" data-end="1572.57">to the server then whenever you return</span> <span data-start="1572.57" data-end="1575.2">posts from the server you ensure that</span> <span data-start="1575.2" data-end="1579.19">those ideas are not referenced in the</span> <span data-start="1579.19" data-end="1583.46">from the resulting set so this is what</span> <span data-start="1583.46" data-end="1585.83">the Ruby code looks like you find the</span> <span data-start="1585.83" data-end="1588.38">popular posts you exclude any which have</span> <span data-start="1588.38" data-end="1590.72">an ID of the array that's passed in and</span> <span data-start="1590.72" data-end="1594.17">then you return them you limit it by 30</span> <span data-start="1594.17" data-end="1596.48">and routes you return the next page it</span> <span data-start="1596.48" data-end="1598.37">works great</span> <span data-start="1598.37" data-end="1600.61">that's the solution to that problem</span> <span data-start="1600.61" data-end="1602.63">real-time streaming while actually</span> <span data-start="1602.63" data-end="1604.82">monocle uses real-time streaming to keep</span> <span data-start="1604.82" data-end="1606.92">us interface up-to-date so if you up</span> <span data-start="1606.92" data-end="1609.53">vote a posts or add a new comment or add</span> <span data-start="1609.53" data-end="1611.63">a new post those things are gonna be</span> <span data-start="1611.63" data-end="1613.16">reflected instantly across everyone</span> <span data-start="1613.16" data-end="1616.37">viewing well how do we do this serve a</span> <span data-start="1616.37" data-end="1618.89">certain event now this is the easiest</span> <span data-start="1618.89" data-end="1620.84">form of real-time streaming I think on</span> <span data-start="1620.84" data-end="1623.36">the browser if you only need pub/sub and</span> <span data-start="1623.36" data-end="1624.83">you don't need bi-directional</span> <span data-start="1624.83" data-end="1626.96">communication use server-side events</span> <span data-start="1626.96" data-end="1629.3">they are so much simpler than WebSockets</span> <span data-start="1629.3" data-end="1631.28">they don't have a binary protocol it's</span> <span data-start="1631.28" data-end="1633.32">very simple in fact I can show you the</span> <span data-start="1633.32" data-end="1637.58">protocol right here in a ruby example so</span> <span data-start="1637.58" data-end="1639.02">all you have to do is make sure that</span> <span data-start="1639.02" data-end="1642.02">spot responses contain this content type</span> <span data-start="1642.02" data-end="1645.11">of text slash event stream then you need</span> <span data-start="1645.11" data-end="1647.3">to keep the connection open then to</span> <span data-start="1647.3" data-end="1649.82">write to a streams connection you just</span> <span data-start="1649.82" data-end="1652.34">write data code on and then the message</span> <span data-start="1652.34" data-end="1654.47">and then you line your line and that is</span> <span data-start="1654.47" data-end="1656.72">the entire protocol that's what</span> </p>
<p><span data-start="1656.72" data-end="1659.15">WebSockets should have beat but yeah we</span> <span data-start="1659.15" data-end="1660.85">had luckily we have server sent events</span> <span data-start="1660.85" data-end="1663.92">so back in the day I used to have this</span> <span data-start="1663.92" data-end="1666.02">project called juggernaut which as she</span> <span data-start="1666.02" data-end="1668.24">did real-time streaming every flash when</span> <span data-start="1668.24" data-end="1670.309">server-side events came along I call it</span> <span data-start="1670.309" data-end="1671.3">a day I was like</span> <span data-start="1671.3" data-end="1673.52">the browser has fixed this problem we</span> <span data-start="1673.52" data-end="1675.95">can deprecated Jagga no problem is</span> <span data-start="1675.95" data-end="1678.11">solved however what I realized is that</span> <span data-start="1678.11" data-end="1681.2">people want abstraction and I wanted</span> <span data-start="1681.2" data-end="1682.28">abstraction for monocle</span> <span data-start="1682.28" data-end="1684.35">so I made this thing called Sinatra -</span> <span data-start="1684.35" data-end="1687.71">pops up so gem anyone can use it and</span> <span data-start="1687.71" data-end="1689.48">it'll deal with channels and they'll</span> <span data-start="1689.48" data-end="1692.09">deal with cross-origin request headers</span> <span data-start="1692.09" data-end="1694.01">and I'll deal with keep our lives and</span> <span data-start="1694.01" data-end="1696.79">read as pub/sub and it's it's kind of</span> <span data-start="1696.79" data-end="1699.91">geared towards using it on Heroku</span> <span data-start="1699.91" data-end="1702.71">so here's another example of using this</span> <span data-start="1702.71" data-end="1705.02">library here we're publishing a talk</span> <span data-start="1705.02" data-end="1707.54">message to the tick channel and we have</span> <span data-start="1707.54" data-end="1710.6">a client subscribing to it so on the</span> <span data-start="1710.6" data-end="1712.7">client side you just use this event</span> <span data-start="1712.7" data-end="1716.72">source object and you just pass it</span> <span data-start="1716.72" data-end="1718.73">through a URL and then it will start</span> <span data-start="1718.73" data-end="1723.35">streaming from the server and this slash</span> <span data-start="1723.35" data-end="1725.99">subscribe route is actually what set up</span> <span data-start="1725.99" data-end="1728.36">by Sinatra pops up so that is all you</span> <span data-start="1728.36" data-end="1730.22">need to do to stream this talk message</span> <span data-start="1730.22" data-end="1733.73">claim and in fact if you go to J's can't</span> <span data-start="1733.73" data-end="1736.789">- ticked at her oh crap calm I set up</span> <span data-start="1736.789" data-end="1738.95">the simple example of this you know</span> <span data-start="1738.95" data-end="1741.71">it'll just stream these tick messages</span> <span data-start="1741.71" data-end="1743.419">it's pretty boring to be honest it</span> <span data-start="1743.419" data-end="1747.26">doesn't do much more than that so I'm</span> <span data-start="1747.26" data-end="1748.549">telling you all of this because Monica</span> <span data-start="1748.549" data-end="1751.57">has the streaming setup server under</span> <span data-start="1751.57" data-end="1755.299">stream Monica bio and if you look at the</span> <span data-start="1755.299" data-end="1758.45">stream module in vendor I've abstracted</span> <span data-start="1758.45" data-end="1761.78">event source a bit and I made it pass or</span> <span data-start="1761.78" data-end="1764.63">the event or the messages that it</span> <span data-start="1764.63" data-end="1767.98">actually gets so I made it pass through</span> </p>
<p><span data-start="1767.98" data-end="1771.559">Jason and then I'm firing my own event</span> <span data-start="1771.559" data-end="1776.63">on this stream module so if you have a</span> <span data-start="1776.63" data-end="1778.909">look on the server side notice that we</span> <span data-start="1778.909" data-end="1782.63">have this is an example of how a post is</span> <span data-start="1782.63" data-end="1785.15">voted we have this publish method right</span> <span data-start="1785.15" data-end="1787.61">here and this publish method basically</span> <span data-start="1787.61" data-end="1790.309">interacts with Sinatra pub/sub rise the</span> <span data-start="1790.309" data-end="1793.52">message to all channels in this case</span> <span data-start="1793.52" data-end="1795.289">we're publishing that a post got voted</span> <span data-start="1795.289" data-end="1798.14">upon and now if we have a look</span> <span data-start="1798.14" data-end="1801.62">and I client-side again it's just kind</span> <span data-start="1801.62" data-end="1804.44">of cut out you we can perform the</span> <span data-start="1804.44" data-end="1806.33">appropriate action we can listen to the</span> <span data-start="1806.33" data-end="1811.159">posts vote event and then we can in this</span> <span data-start="1811.159" data-end="1812.299">case what we're doing is we're just</span> <span data-start="1812.299" data-end="1813.98">refreshing that post we're fetching it</span> <span data-start="1813.98" data-end="1815.809">again from the server and we'll have the</span> <span data-start="1815.809" data-end="1818.75">updated book count so you in other ways</span> <span data-start="1818.75" data-end="1819.98">you can add this kind of real-time</span> <span data-start="1819.98" data-end="1822.4">streaming to your app very very simply</span> <span data-start="1822.4" data-end="1826.46">probably do only take you half now so</span> <span data-start="1826.46" data-end="1829.72">adding SEO to Monica was pretty easy</span> </p>
<p><span data-start="1829.72" data-end="1831.88">Google have this Ajax crawling</span> <span data-start="1831.88" data-end="1835.13">specification and basically all we need</span> <span data-start="1835.13" data-end="1836.929">to do is set up a robot friendly version</span> <span data-start="1836.929" data-end="1839.09">of the site's one that isn't rented with</span> <span data-start="1839.09" data-end="1842.48">JavaScript so if you go to this URL and</span> <span data-start="1842.48" data-end="1845.75">you include the underscore skate of the</span> <span data-start="1845.75" data-end="1847.309">score fragment under Scott exactly as</span> <span data-start="1847.309" data-end="1848.929">shown there you'll see the robots</span> <span data-start="1848.929" data-end="1851.27">friendly version of the site and it</span> <span data-start="1851.27" data-end="1855.049">looks a bit like this it's just a plain</span> <span data-start="1855.049" data-end="1857.69">HTML there's no JavaScript in there or</span> <span data-start="1857.69" data-end="1861.14">anything else now the key to making a</span> <span data-start="1861.14" data-end="1864.169">google fetch your page like this</span> <span data-start="1864.169" data-end="1866.749">is this metatag you just put it in your</span> <span data-start="1866.749" data-end="1872.359">main site and what Google do as soon as</span> <span data-start="1872.359" data-end="1874.489">it comes across this meta tag it all</span> <span data-start="1874.489" data-end="1877.279">read request the page again and they'll</span> <span data-start="1877.279" data-end="1880.19">add that underscore escape fragment</span> <span data-start="1880.19" data-end="1883.129">underscore to the URL what you can do on</span> <span data-start="1883.129" data-end="1885.259">the server side is just detect if that</span> <span data-start="1885.259" data-end="1887.57">is there and then you can render your</span> <span data-start="1887.57" data-end="1892.1">spider friendly page so you simply</span> <span data-start="1892.1" data-end="1893.72">implement a route that checks for it and</span> <span data-start="1893.72" data-end="1896.509">in fact in Sinatra you can do this in a</span> <span data-start="1896.509" data-end="1898.879">little nicer way what you can do is add</span> <span data-start="1898.879" data-end="1901.489">a route condition so this route or any</span> <span data-start="1901.489" data-end="1904.1">match if escape fragment is in the</span> <span data-start="1904.1" data-end="1909.35">parameters on the client side in in the</span> <span data-start="1909.35" data-end="1911.929">rendered ARB it looks a bit like this we</span> <span data-start="1911.929" data-end="1914.72">just have plain HTML we have an h1 tag</span> <span data-start="1914.72" data-end="1916.879">important for SEO we have a Meta</span> </p>
<p><span data-start="1916.879" data-end="1918.95">Description tag again important for SEO</span> <span data-start="1918.95" data-end="1922.039">that is what is displayed inside Google</span> <span data-start="1922.039" data-end="1926.6">search engine and then and then that's</span> <span data-start="1926.6" data-end="1928.46">it we have SEO if you go to a site</span> <span data-start="1928.46" data-end="1930.23">kernel monocle to i/o if you just google</span> <span data-start="1930.23" data-end="1932.659">that you'll see there's a bunch of</span> <span data-start="1932.659" data-end="1934.789">monocle has been indexed by Google it</span> <span data-start="1934.789" data-end="1938.48">works pretty well so I want to make sure</span> <span data-start="1938.48" data-end="1942.049">that the user doesn't quit the tab when</span> <span data-start="1942.049" data-end="1944.09">certain Ajax requests are in the fly</span> <span data-start="1944.09" data-end="1947.989">such as creating new posts voting that</span> <span data-start="1947.989" data-end="1948.559">kind of thing</span> <span data-start="1948.559" data-end="1951.139">so what we can do for this is use the</span> <span data-start="1951.139" data-end="1954.47">under for unload event which we can use</span> <span data-start="1954.47" data-end="1956.539">to warn the user they mean lose data if</span> <span data-start="1956.539" data-end="1959.749">they continue closing the tab now this</span> <span data-start="1959.749" data-end="1961.609">event is actually really a pseudo event</span> <span data-start="1961.609" data-end="1963.409">it's not really event can only have one</span> </p>
<p><span data-start="1963.409" data-end="1965.84">Handler and it's called just before the</span> <span data-start="1965.84" data-end="1968.33">page closes and now if a string is</span> <span data-start="1968.33" data-end="1972.289">returned from this event then that all</span> <span data-start="1972.289" data-end="1973.669">that string will be prompted to the</span> <span data-start="1973.669" data-end="1975.98">clients and then they had the option to</span> <span data-start="1975.98" data-end="1978.2">close the tab or not so that's the only</span> <span data-start="1978.2" data-end="1979.94">control you have for security reasons</span> <span data-start="1979.94" data-end="1982.909">now jQuery has this active property it's</span> <span data-start="1982.909" data-end="1987.409">an undocumented but it'll an active</span> <span data-start="1987.409" data-end="1989.059">property is basically in an integer</span> <span data-start="1989.059" data-end="1991.879">count of the current Ajax connections so</span> <span data-start="1991.879" data-end="1993.83">there's more than one connection and</span> <span data-start="1993.83" data-end="1997.14">then this flow control would turn true</span> <span data-start="1997.14" data-end="1999.39">a string will be returned the user be</span> <span data-start="1999.39" data-end="2001.49">prompted to see if they actually want to</span> <span data-start="2001.49" data-end="2005.87">close the tab now actually I found a bug</span> <span data-start="2005.87" data-end="2007.73">in Google Chrome where the cache gets</span> <span data-start="2007.73" data-end="2012.17">completely booked if you use on before</span> <span data-start="2012.17" data-end="2015.71">unload so the only way to actually walk</span> <span data-start="2015.71" data-end="2019.28">around this is set before I unload only</span> <span data-start="2019.28" data-end="2020.63">when the page isn't and then that</span> <span data-start="2020.63" data-end="2023.66">unnoted will state so if you have a look</span> <span data-start="2023.66" data-end="2026.15">at jQuery done close this is another</span> <span data-start="2026.15" data-end="2027.76">plugin than the vendor read directory</span> <span data-start="2027.76" data-end="2031.46">which I wrote from wanaka you can see</span> <span data-start="2031.46" data-end="2034.94">that if whenever there's an ajax request</span> <span data-start="2034.94" data-end="2037.85">being sent out we're incrementing our</span> <span data-start="2037.85" data-end="2041.69">own active transforms integer and then</span> <span data-start="2041.69" data-end="2043.13">we're adding the handler if there are</span> <span data-start="2043.13" data-end="2045.14">active transforms and then we're doing</span> <span data-start="2045.14" data-end="2047.21">the opposite when the HX request is</span> <span data-start="2047.21" data-end="2051.56">complete lastly I want to talk about the</span> <span data-start="2051.56" data-end="2054.56">wake event so we want to make sure that</span> <span data-start="2054.56" data-end="2056.48">the computer wakes up the browser</span> <span data-start="2056.48" data-end="2058.78">fetches the latest posts from Monika</span> <span data-start="2058.78" data-end="2061.13">because people keep tabs open for a long</span> <span data-start="2061.13" data-end="2061.58">time</span> <span data-start="2061.58" data-end="2063.429">we don't want data to get stale on there</span> <span data-start="2063.429" data-end="2067.3">but there's no browser API API for this</span> <span data-start="2067.3" data-end="2070.25">there is a browser API for page</span> <span data-start="2070.25" data-end="2072.47">visibility but actually doesn't help</span> <span data-start="2072.47" data-end="2074.899">here so we again we have to do it</span> <span data-start="2074.899" data-end="2075.46">ourselves</span> </p>
<p><span data-start="2075.46" data-end="2080.27">I've ridden this plugin again as she's</span> <span data-start="2080.27" data-end="2082.76">caught jquery waked up coffee nodejs</span> <span data-start="2082.76" data-end="2086.03">but what we can what it's doing here is</span> <span data-start="2086.03" data-end="2088.76">using timers to detect if we think</span> <span data-start="2088.76" data-end="2092.36">there's been a page sleep now since</span> <span data-start="2092.36" data-end="2094.61">timers executed a relatively predictable</span> <span data-start="2094.61" data-end="2097.61">interval we can check each iteration and</span> <span data-start="2097.61" data-end="2099.89">see if it matches at the current time is</span> <span data-start="2099.89" data-end="2103.31">is what we expect it to be if it isn't</span> <span data-start="2103.31" data-end="2105.32">the likelihood is that the computer</span> <span data-start="2105.32" data-end="2108.32">probably paused the timers during asleep</span> <span data-start="2108.32" data-end="2110.77">and then we can execute our awake event</span> <span data-start="2110.77" data-end="2114.68">now all we have to do in index don't</span> <span data-start="2114.68" data-end="2116.54">want to do the coffee is listen to this</span> <span data-start="2116.54" data-end="2119.3">wake event refresh the posts and we're</span> <span data-start="2119.3" data-end="2123.08">done I want to thank you very much for</span> <span data-start="2123.08" data-end="2124.55">listening to this talk and if you have</span> <span data-start="2124.55" data-end="2132.069">any questions we have it</span> <span data-start="2132.079" data-end="2135.51">all right thank you so much Alex now we</span> <span data-start="2135.51" data-end="2137.549">have a time for a few questions before</span> <span data-start="2137.549" data-end="2140.15">we go on a break</span> <span data-start="2140.15" data-end="2144.809">does anyone have any questions please</span> <span data-start="2144.809" data-end="2145.5">raise your hands</span> <span data-start="2145.5" data-end="2148.17">all right there's a gentleman here um so</span> </p>
<p><span data-start="2148.17" data-end="2150.63">I've just got once what go back quite a</span> <span data-start="2150.63" data-end="2153.079">bit into the talk with your issues with</span> <span data-start="2153.079" data-end="2156.21">pagination have there been any issues</span> <span data-start="2156.21" data-end="2158.43">with a move on into the mewar even just</span> <span data-start="2158.43" data-end="2160.079">theoretical with the URLs getting too</span> <span data-start="2160.079" data-end="2162.329">long by requesting so many existing</span> <span data-start="2162.329" data-end="2165.69">posts ladies are getting too long yes</span> <span data-start="2165.69" data-end="2169.41">yes they well spotted URLs have a set</span> <span data-start="2169.41" data-end="2172.92">length and if you put too many IDs in</span> <span data-start="2172.92" data-end="2174.03">that then you're gonna have problems</span> <span data-start="2174.03" data-end="2177.18">that's why you use a post okay yeah so</span> <span data-start="2177.18" data-end="2179.4">use a post for your yeah pagination</span> </p>
</section>