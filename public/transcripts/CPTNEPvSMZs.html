<section>
<p><span data-start="0.17" data-end="1.18">Invisible Code: Building JavaScript Libraries For Non-Technical People</span> <span data-start="27.83" data-end="31.539">[Applause] JOHN: So everybody in this room, it's probably</span> <span data-start="31.539" data-end="36.05">their domain to add new functionality to the website but what about the majority of website</span> <span data-start="36.05" data-end="41.129">owners, what about that salon daughter who has his daughter hack together a website for</span> <span data-start="41.129" data-end="42.129">him?</span> </p>
<p><span data-start="42.129" data-end="48.179">It starts off simple and then he has a script tag added here, a widget, an image gallery,</span> <span data-start="48.179" data-end="53.769">a couple of analytics tracking tools for some reason, so over time the small, simple website</span> <span data-start="53.769" data-end="57.78">turns into this multimegabyte monstrosity.</span> <span data-start="57.78" data-end="60.309">It's not really his fault.</span> <span data-start="60.309" data-end="63.909">He doesn't know exactly what he is doing, he doesn't know the end result is going to</span> <span data-start="63.909" data-end="70.2">make his website cooler, so how can we as developers of this third party embedded code</span> <span data-start="70.2" data-end="73.89">make this situation a little better?</span> </p>
<p><span data-start="73.89" data-end="79.32">Before we get started my name is John Fawcett, I have been building out our AMP experience,</span> <span data-start="79.32" data-end="81.46">you may know Google AMP.</span> <span data-start="81.46" data-end="86.27">Also been helping out on our apps team so I have been writing quite a bit of embedded</span> <span data-start="86.27" data-end="89.81">JavaScript lately and it has been fun.</span> <span data-start="89.81" data-end="97.049">So before we get started into the main thing, let's take a look at some presumably reputable</span> <span data-start="97.049" data-end="105.81">survey, so according to Netcraft back in 2016 we hit over 1 billion unique host names and</span> <span data-start="105.81" data-end="110.229">that's Carl up there just for effect, right, he has nothing to do with this and also I</span> <span data-start="110.229" data-end="115.909">added an emoji about an hour ago because everybody else seems to have them, so a billion host</span> <span data-start="115.909" data-end="122.439">names, and 72% of these pages make more than 51 requests and we can imagine that seems</span> <span data-start="122.439" data-end="129.929">a little high and, of course, there is a bunch that make way too many requests, right, so</span> <span data-start="129.929" data-end="133.81">the reason I'm showing you this is just to give you perspective.</span> <span data-start="133.81" data-end="139.65">We are developers and we kind of know what we are doing maybe, and the rest of the people</span> <span data-start="139.65" data-end="144.53">that maybe own the rest of the billion host names on the Internet probably don't know</span> <span data-start="144.53" data-end="147.33">as much.</span> </p>
<p><span data-start="147.33" data-end="153.14">We should get inside their head, how are they even adding this functionality to their website?</span> <span data-start="153.14" data-end="156.06">There's really three sort of scenarios they go through.</span> <span data-start="156.06" data-end="158.739">They either know enough to be a little bit dangerous.</span> <span data-start="158.739" data-end="163.26">They find a script tag on the Internet and then just paste it into their site and then</span> <span data-start="163.26" data-end="164.879">tweet things until it works.</span> </p>
<p><span data-start="164.879" data-end="176.55">Then there's CMS plugins like Wix and Squarespace, but maybe just ask a developer, or they copy</span> <span data-start="176.55" data-end="181.942">and paste as well, but we are going to focus on these first two because at the end of the</span> <span data-start="181.942" data-end="184.069">day these are pretty much exactly the same.</span> <span data-start="184.069" data-end="189.87">Maybe in WordPress you have a few extra APIs but these pretty much have the same constraints.</span> <span data-start="189.87" data-end="192.95">What are the constraints?</span> <span data-start="192.95" data-end="195.53">The first thing is environment.</span> <span data-start="195.53" data-end="202.26">This is a huge umbrella term, I know, but when writing a web app we have a very well-defined</span> <span data-start="202.26" data-end="205.98">audience that we can actually develop for.</span> <span data-start="205.98" data-end="210.5">And for building embedded code we actually have two different kinds of users.</span> <span data-start="210.5" data-end="214.549">We have the person that's going to be consuming the code and pasting it on their website one</span> <span data-start="214.549" data-end="219.049">way or the other, and we have the end users, and we can't make assumptions about what those</span> <span data-start="219.049" data-end="220.53">end users really are.</span> <span data-start="220.53" data-end="226.42">We want our code to be basically run everywhere and that's pretty difficult, right?</span> <span data-start="226.42" data-end="229.489">So yeah, it's weird.</span> <span data-start="229.489" data-end="231.29">Next thing is file size.</span> </p>
<p><span data-start="231.29" data-end="237.26">We really need to respect the end user's bandwidth and capacity to parse JavaScript.</span> <span data-start="237.26" data-end="243.469">We also need to respect the website owner so these are no-brainer things but we really</span> <span data-start="243.469" data-end="249.83">have to keep them in mind when running or making third party code to be embedded.</span> <span data-start="249.83" data-end="255.64">And browser compatibility, again if you can define your audience you know, but we can't</span> <span data-start="255.64" data-end="263.23">really define that, it's their audience, so browser compatibility is more about global</span> <span data-start="263.23" data-end="271.06">trends so you are going to have to support older versions of IE than you want to.</span> </p>
<p><span data-start="271.06" data-end="280.83">And the user is an excuse for poor developer ergonomics so they are creating a single JavaScript</span> <span data-start="280.83" data-end="287.81">that is hand-rolled to be ES5 compliant and it's not maintainable, and it gets worse and</span> <span data-start="287.81" data-end="290.47">worse over time.</span> <span data-start="290.47" data-end="297.85">So network: you are likely being embedded in a page where there's a ton of network requests</span> <span data-start="297.85" data-end="304.19">because they have three different analytics libraries that are all tracking clicks and</span> <span data-start="304.19" data-end="309.56">the mouse movements, so something you need to keep in mind is you may be trying to perform</span> <span data-start="309.56" data-end="314.89">a network request when there's a bunch of other network requests going on, so maybe</span> <span data-start="314.89" data-end="318.82">we can do something, maybe we can check to see how many network requests are going on</span> <span data-start="318.82" data-end="324.97">and try to push our pay load at a time when it's less chatty.</span> <span data-start="324.97" data-end="331.521">So you are thinking you are going to write a little widget for general consumption, maybe</span> <span data-start="331.521" data-end="339.4">an image gallery or anything, and let's just — basic stuff, I know you guys know this.</span> <span data-start="339.4" data-end="340.8">You don't need fonts, okay?</span> <span data-start="340.8" data-end="342.22">Just use the host environment.</span> <span data-start="342.22" data-end="343.9">Fonts are crazy.</span> <span data-start="343.9" data-end="345.31">You don't need them.</span> <span data-start="345.31" data-end="348.15">No global rules; compress your images if you have them.</span> </p>
<p><span data-start="348.15" data-end="354.65">Maybe even [sound problem] .. okay, back to what we are talking about.</span> <span data-start="354.65" data-end="358.98">You may be asking: okay, we are going to write some isolated DOM stuff and we are going to</span> <span data-start="358.98" data-end="359.98">style it.</span> <span data-start="359.98" data-end="365.56">The question is do I have an external sheet or do I go with inline styles?</span> <span data-start="365.56" data-end="367.44">Okay.</span> <span data-start="367.44" data-end="370.85">It actually doesn't matter so much because the problems you are going to run up against</span> <span data-start="370.85" data-end="373.48">are pretty much exactly the same.</span> </p>
<p><span data-start="373.48" data-end="377.34">You are being sane, you are prefixing your styles, you are doing inline and then you</span> <span data-start="377.34" data-end="383.41">run across a global style, like this is going to happen pretty much at least 20% of the</span> <span data-start="383.41" data-end="391.96">pages you are embedded on, somebody is overwriting it dev style, okay, and you are like: okay,</span> <span data-start="391.96" data-end="399.16">maybe I can be very specific about my style sheets and only — I will check for all these</span> <span data-start="399.16" data-end="400.16">things.</span> <span data-start="400.16" data-end="404.89">Then some reset comes along and has an important tag, and you are like: oh!</span> <span data-start="404.89" data-end="407.18">Okay, what can we do about this.</span> <span data-start="407.18" data-end="412.481">What can we do about the global styles that resets are putting important on, and one of</span> <span data-start="412.481" data-end="416.1">the things you can do is custom tags.</span> <span data-start="416.1" data-end="420.44">This works in IE9 and up and everything else for the most part.</span> <span data-start="420.44" data-end="428.37">It's not compliant with the HTML5 spec but it's one way to get style isolation.</span> <span data-start="428.37" data-end="434.51">In IE9 you need to create an element of the name before you use it so here we have a custom</span> <span data-start="434.51" data-end="440.73">element called my widget and we have got style isolation for the most part, so we solve that</span> <span data-start="440.73" data-end="445.67">and then somebody has got an all elements select over and it's adding a border radius</span> <span data-start="445.67" data-end="453.88">to your newly designed and styled widget, and you are like: okay, let's figure this</span> <span data-start="453.88" data-end="455.12">out.</span> </p>
<p><span data-start="455.12" data-end="461.25">So anyway, so we've got this and what do we do about this situation?</span> <span data-start="461.25" data-end="465.08">There's one thing that we can do and it's to use iframes.</span> <span data-start="465.08" data-end="471.58">That's the only way you are going to achieve true style isolation and it's a good idea</span> <span data-start="471.58" data-end="476.71">to run your widget inside the iframe anyway because it's a little more respectful of the</span> <span data-start="476.71" data-end="477.8">host's environment.</span> <span data-start="477.8" data-end="484.66">Yes, I guess we are having some interface problems but I will go on.</span> </p>
<p><span data-start="484.66" data-end="492.25">So iframes, if you run a little bit of code on the host environment that puts an iframe</span> <span data-start="492.25" data-end="498.57">on the page that's going to run maybe more code in the background, some of that code</span> <span data-start="498.57" data-end="503.06">can be prioritised and not pretty much overtake the page.</span> <span data-start="503.06" data-end="511.31">Let's find out what's going on with this slide situation, and then I will continue.</span> <span data-start="511.31" data-end="514.51">This is the part of the talk where I say, "How's everybody feeling?</span> <span data-start="514.51" data-end="522.25">Get up and take a stretch".</span> <span data-start="522.25" data-end="530.85">Well, you've maybe been seeing this crazy scrolling thing, and there's like a bunch</span> <span data-start="530.85" data-end="536.92">of JavaScript CSS properties in there, so what we can do with the iframe if we embed</span> <span data-start="536.92" data-end="545.279">it and we do this for some isolation is to put the iframe in the DOM and then apply our</span> <span data-start="545.279" data-end="552.629">own defaults to it, and we take pretty much every single CSS property and put it on that</span> <span data-start="552.629" data-end="560.269">iframe so we can have an expected behaviour locally and on anybody else's page.</span> <span data-start="560.269" data-end="568.66">Of course, there's still edge cases but this does cover some of them.</span> </p>
<p><span data-start="568.66" data-end="572.93">The iframe brings us to JavaScript, right, we are creating the iframe and adding all</span> <span data-start="572.93" data-end="581.04">those CSS properties, so what are the pitfalls and crazy stories?</span> <span data-start="581.04" data-end="586.22">Well, first off let's get the basics out of the way — and keep flashing my slides.</span> <span data-start="586.22" data-end="588.939">Well, all right.</span> <span data-start="588.939" data-end="593.14">I could just turn my computer around and everybody can come closer.</span> <span data-start="593.14" data-end="594.43">[Laughter] >> It was flashing all of yesterday as well.</span> </p>
</section>

<section>
<p><span data-start="594.43" data-end="596.579"><span class="speaker">John</span>: Yes, I will just go through it, and we will just deal with it.</span> <span data-start="596.579" data-end="598.6">So anyway, let's get the basics out of the way.</span> <span data-start="598.6" data-end="602.93">There is some really simple stuff that I know everybody knows: don't use globals, of course.</span> <span data-start="602.93" data-end="604.249">We've known this for a while.</span> </p>
<p><span data-start="604.249" data-end="609.24">Please, for the love of God, don't, don't mess with the prototype, don't depend on a</span> <span data-start="609.24" data-end="613.24">library that messes with the prototype.</span> <span data-start="613.24" data-end="614.65">Minify your code.</span> <span data-start="614.65" data-end="616.22">Don't make a bunch of requests.</span> </p>
<p><span data-start="616.22" data-end="621.36">If you have something you need to phone home with, create a route that you can batch request</span> <span data-start="621.36" data-end="625.959">to so you are only sending one, so if somebody is on a mobile phone the biggest problem is</span> <span data-start="625.959" data-end="631.949">latency and if you are making a bunch of requests phoning home just at least make a route that's</span> <span data-start="631.949" data-end="635.529">going to be able to accept multiple of those requests, it's not too hard.</span> <span data-start="635.529" data-end="638.43">And of course profile your code.</span> <span data-start="638.43" data-end="643.35">The biggest problem I feel on a lot of these sites is they've can included 47 jQuery plugins</span> <span data-start="643.35" data-end="648.93">and not all of them were very considerate of performance.</span> <span data-start="648.93" data-end="655.959">If you are going to be having a copy and paste script tag consider within the script tag</span> <span data-start="655.959" data-end="663.2">itself — I saw it and was, "Holy crap", this is a great idea, and got a lot of feedback</span> <span data-start="663.2" data-end="666.54">from non-technical people, saying, "That's all you have to do?"</span> <span data-start="666.54" data-end="670.54">Yes, that's all you have to do.</span> </p>
<p><span data-start="670.54" data-end="676.459">A little story about building the AMP viewer.</span> <span data-start="676.459" data-end="681.999">If you can imagine a block of code here and then imagine a scenario I put myself in, we</span> <span data-start="681.999" data-end="688.75">will be in good shape here, so we are reason the AMP viewer and the AMP viewer — actually,</span> <span data-start="688.75" data-end="691.62">how many people are familiar with AMP from Google?</span> </p>
<p><span data-start="691.62" data-end="695.319">So you know when you search for Donald Trump and you are wondering why I'm searching for</span> <span data-start="695.319" data-end="702.129">Donald Trump, and you go to the search results, it has the little carousel — oh, look at that,</span> <span data-start="702.129" data-end="703.129">Cloudflare!</span> <span data-start="703.129" data-end="707.36">Hmm, that seems to be extending my desktop now.</span> <span data-start="707.36" data-end="712.04">You want to check that out?</span> <span data-start="712.04" data-end="714.37">I guess it's in Preferences.</span> <span data-start="714.37" data-end="719.18">We can maybe move it over.</span> <span data-start="719.18" data-end="732.55">Let's check out Preferences.</span> <span data-start="732.55" data-end="735.899">Display.</span> <span data-start="735.899" data-end="737.58">There we go.</span> <span data-start="737.58" data-end="738.58">Perfect.</span> <span data-start="738.58" data-end="746.329">Okay, so I will go back talking about AMP viewer real quick, so you click on a miniature</span> <span data-start="746.329" data-end="750.829">carousel in a search result, it has that little lightning bolt and you instantly load the</span> <span data-start="750.829" data-end="751.98">page.</span> </p>
<p><span data-start="751.98" data-end="756.249">Google does this by pre-rendering the document or pre-rendering the document they loaded</span> <span data-start="756.249" data-end="758.399">in an iframe in the background.</span> <span data-start="758.399" data-end="763.189">They've got it in a Google CDM and when you click the article it flashes in the view and</span> <span data-start="763.189" data-end="768.11">tells the AMP document: hey, you are now visible, you are now allowed to download images and</span> <span data-start="768.11" data-end="773.79">to download your analytics tracking tools and actually start tracking so that's kind</span> <span data-start="773.79" data-end="775.019">of what the AMP viewer does.</span> </p>
<p><span data-start="775.019" data-end="780.79">So anyway, I had some similar code as this and we had already deployed it to thousands</span> <span data-start="780.79" data-end="786.579">of sites, and we've started collecting data and one of the pieces of data we collected</span> <span data-start="786.579" data-end="789.48">was that this list was .</span> <span data-start="789.48" data-end="795.36">If you — you don't really have to understand the code but the iterator function to the</span> <span data-start="795.36" data-end="800.42">enumeration methods like map and filter receive three arguments, and the third is list.</span> <span data-start="800.42" data-end="804.569">It's the original list that you are iterating on.</span> <span data-start="804.569" data-end="810.16">So why, in what scenario is list actually ?</span> <span data-start="810.16" data-end="816.47">The answer is: when somebody overrides your prototype with an implementation of map that</span> <span data-start="816.47" data-end="818.589">does not include list.</span> <span data-start="818.589" data-end="819.839">And who does this?</span> <span data-start="819.839" data-end="825.16">Well, prototype.js actually did it before 2012 and they realised their folly in 2012</span> <span data-start="825.16" data-end="834.54">and released a new version but there's still a ton of websites that use pre-2012 prototype.js.</span> <span data-start="834.54" data-end="837.199">What do you even do about that?</span> <span data-start="837.199" data-end="840.44">How far do you go in not trusting JavaScript?</span> </p>
<p><span data-start="840.44" data-end="846.029">The answer is for us, you know, we went ahead and fixed it and said: okay, let's not rely</span> <span data-start="846.029" data-end="853.22">on that variable because there's too many people that are relying on Prototype.js, pre-2012</span> <span data-start="853.22" data-end="856.139">I might add.</span> <span data-start="856.139" data-end="857.57">So it's up to you.</span> <span data-start="857.57" data-end="860.589">You really need to be collecting that data though, that's the important part.</span> </p>
<p><span data-start="860.589" data-end="861.709">How do you do it?</span> <span data-start="861.709" data-end="863.459">Well, we used Sentry.</span> <span data-start="863.459" data-end="866.329">If you haven't used Sentry, it's really awesome, okay?</span> <span data-start="866.329" data-end="869.149">I'm just going to zoom in here.</span> </p>
<p><span data-start="869.149" data-end="874.97">I mean, you get all kinds of great information, you get the browser and all, the device and</span> <span data-start="874.97" data-end="882.069">the breakdown of browser and the errors that are occurring and you will see here the stack</span> <span data-start="882.069" data-end="887.79">trace comes in, and we are running completely uglified code and yet when the error comes</span> <span data-start="887.79" data-end="892.459">in we can actually see the line that had the error and you see this is a TypeScript file</span> <span data-start="892.459" data-end="898.76">which we will talk about a little bit later in developer ergonomics, so yes, we have TypeScript</span> <span data-start="898.76" data-end="902.18">or we have Sentry error reporting.</span> <span data-start="902.18" data-end="908.18">Now, we only run this for a sample of our users so not everybody is going to be reporting</span> <span data-start="908.18" data-end="911.24">errors to us, and it's a pretty easy thing to do.</span> <span data-start="911.24" data-end="917.61">You just say: hey, script actually report errors to Sentry; or don't report errors to</span> <span data-start="917.61" data-end="918.61">Sentry.</span> <span data-start="918.61" data-end="920.139">So that's another thing about being a little bit responsible.</span> <span data-start="920.139" data-end="926.35">You don't want every single one of your pieces of code phoning home for whatever reason,</span> <span data-start="926.35" data-end="927.87">but there's a problem.</span> <span data-start="927.87" data-end="933.23">If you've ever used Sentry you know there's a line called Raven.js which is a sort of</span> <span data-start="933.23" data-end="938.999">embedded library of sorts as well and they follow the pattern of a massive JavaScript</span> <span data-start="938.999" data-end="945.759">file that is about 2400 lines of code at the end of the day and it's 24 kilobytes minified</span> <span data-start="945.759" data-end="954.809">and you have to wonder how many SHR wrappers there are on any given website so Raven.js</span> <span data-start="954.809" data-end="961.399">is great, it does a lot of stuff for you, but it was too much for us.</span> </p>
<p><span data-start="961.399" data-end="967.04">So what we did is we already had our own SHR wrapper, we already had the ability to parse</span> <span data-start="967.04" data-end="970.12">stack traces.</span> <span data-start="970.12" data-end="972.87">We just used the API, right?</span> <span data-start="972.87" data-end="976.45">If we have access to the API, we can go ahead and push all that error information and we</span> <span data-start="976.45" data-end="979.769">don't have that insane amount of code in our build.</span> <span data-start="979.769" data-end="984.439">What this really looks like is you are just hooking into the on air function on window</span> <span data-start="984.439" data-end="991.199">and you can't use at event listener, Air, I've already tried, but you can override this</span> <span data-start="991.199" data-end="994.86">function and hopes nobody else does as well.</span> </p>
<p><span data-start="994.86" data-end="1000.23">You also need to check that the file name coming through is actually your file because</span> <span data-start="1000.23" data-end="1002.73">there's going to be a ton of errors on the page and you don't want to be reporting them</span> <span data-start="1002.73" data-end="1007.119">all to your Sentry incidents.</span> <span data-start="1007.119" data-end="1015.97">So how do you get rid of those SHR wrappers and one of the things we came up with is API</span> <span data-start="1015.97" data-end="1017.689">fingerprinting.</span> <span data-start="1017.689" data-end="1021.87">We live in a world where jQuery of us this dominant library and still is, even though</span> <span data-start="1021.87" data-end="1029.22">we rarely use it anymore as developers in this room, so — well, let's just look.</span> <span data-start="1029.22" data-end="1037.74">According to some survey 89.5% of their top websites use jQuery and then estimates for</span> <span data-start="1037.74" data-end="1046.14">the entire Internet is just under 20% so you have a very high likelihood that $.AJAX exists</span> <span data-start="1046.14" data-end="1047.55">already.</span> </p>
<p><span data-start="1047.55" data-end="1056.28">So we should start building little abstractions that make it look like Fetch exists for everybody,</span> <span data-start="1056.28" data-end="1062.91">even if they don't have Fetch and maybe they have jQuery, and yes, it's a pretty good chance</span> <span data-start="1062.91" data-end="1064.65">had a they do have jQuery.</span> <span data-start="1064.65" data-end="1065.65">What if they don't?</span> <span data-start="1065.65" data-end="1066.65">Object query?</span> <span data-start="1066.65" data-end="1067.65">Try something else.</span> <span data-start="1067.65" data-end="1072.41">These are really cheap and then you have a really nice interface.</span> <span data-start="1072.41" data-end="1079.87">So what if this embedded code is still running and relying on the Fetch API?</span> <span data-start="1079.87" data-end="1081.89">You need to download it.</span> <span data-start="1081.89" data-end="1086.31">Or you could say this code is not going to work and I'm going to error out and you are</span> <span data-start="1086.31" data-end="1089.03">like: oh, I have a 80% likelihood that my code will work.</span> <span data-start="1089.03" data-end="1090.93">No, we can do better.</span> <span data-start="1090.93" data-end="1098.681">We can actually just dynamically fetch polyfill or jQuery even because maybe they have it</span> <span data-start="1098.681" data-end="1099.681">cached.</span> <span data-start="1099.681" data-end="1110.91">A problem: we are seeing if some code exists and then if it doesn't we have some asynchronous</span> <span data-start="1110.91" data-end="1117.01">step that must occur and in reality we would want an interface that just works.</span> </p>
<p><span data-start="1117.01" data-end="1123.65">You pull in a module statistically from your bundle and you say: get me this resource and</span> <span data-start="1123.65" data-end="1126.4">you want to be able to just check the body, right?</span> <span data-start="1126.4" data-end="1128.48">You want this.</span> <span data-start="1128.48" data-end="1133.26">But in a situation where dependencies may not have even been loaded yet, we need to</span> <span data-start="1133.26" data-end="1139.13">queue up these requests and once the dependencies are satisfied and the API has been defined,</span> <span data-start="1139.13" data-end="1143.26">then we can go ahead and resume those requests but to a developer it should feel just like</span> <span data-start="1143.26" data-end="1145.34">this.</span> <span data-start="1145.34" data-end="1148.63">So we created a little library.</span> <span data-start="1148.63" data-end="1154.37">It's essentially dependency injection, right, but it's a little bit different.</span> <span data-start="1154.37" data-end="1157.78">So we just had these little decorators and of course the decorators are a little bit</span> <span data-start="1157.78" data-end="1164.37">of fluff, they are not that much code to add in, but you could use the non-decorator API</span> <span data-start="1164.37" data-end="1165.63">just as well.</span> </p>
<p><span data-start="1165.63" data-end="1171.3">So we let these functions though that we need the fetch API and whatever the fetch API that</span> <span data-start="1171.3" data-end="1178.43">will be defined by us, and we also want to let it know that any call to these functions</span> <span data-start="1178.43" data-end="1184.4">should be queued up until the fetch API actually exists and has been resolved.</span> <span data-start="1184.4" data-end="1188.39">So what does defining the fetch API look like for this?</span> <span data-start="1188.39" data-end="1195.91">The first thing, the same little library we build, we are going to pull in a definer option</span> <span data-start="1195.91" data-end="1200.55">where we set up the dependencies, let it know what they mean.</span> <span data-start="1200.55" data-end="1206.72">We pull in some strategies from the other part of the library and we only pull in the</span> <span data-start="1206.72" data-end="1210.47">things that we are actually looking for because our module bundler is going to do some tree</span> <span data-start="1210.47" data-end="1215.36">shaking, right, and we are going to have as little code as possible so we pull in these</span> <span data-start="1215.36" data-end="1219.52">different strategies and then we go ahead and define what Fetch would be and it's just</span> <span data-start="1219.52" data-end="1220.57">a chain of these strategies.</span> </p>
<p><span data-start="1220.57" data-end="1226.27">We are going to look for the built in global fetch, then look for jQueries and wrap it,</span> <span data-start="1226.27" data-end="1233.62">then build an external resource, wait for it to load and then apply the jQuery strategy.</span> <span data-start="1233.62" data-end="1242.65">I say jQuery because probably others are cached just from their travels.</span> <span data-start="1242.65" data-end="1244.66">That takes care of that.</span> </p>
<p><span data-start="1244.66" data-end="1249.58">Let's keep our bundle size down.</span> <span data-start="1249.58" data-end="1261.55">Performance tips: I can't really say a whole lot — many have already said, and maybe Jason,</span> <span data-start="1261.55" data-end="1264.55">but we will go over a little bit of stuff.</span> <span data-start="1264.55" data-end="1269.45">The main thing we found is we don't want to negatively affect performance on the page</span> <span data-start="1269.45" data-end="1274.2">and we don't want necessarily the best performance but we should probably queue our expensive</span> <span data-start="1274.2" data-end="1281.23">actions so with the AMP viewer for a lot of our customers there is this discovery step,</span> <span data-start="1281.23" data-end="1282.23">right?</span> <span data-start="1282.23" data-end="1285.8">And we are going to take all the links on the page and then check an external service</span> <span data-start="1285.8" data-end="1289.38">to see if any of those links are AMP.</span> </p>
<p><span data-start="1289.38" data-end="1293.98">And then we are going to modify the DOM with little icons that say: this is an AMP link.</span> <span data-start="1293.98" data-end="1296.74">If you click on it, it's going to be really fast.</span> <span data-start="1296.74" data-end="1299.93">And that's an expensive operation because we are calling up to a service and then modifying</span> <span data-start="1299.93" data-end="1303.44">the DOM so what can we do about that?</span> <span data-start="1303.44" data-end="1311.14">The thing we came up with to non-effect performance on initial load is a measure of FPS and you</span> <span data-start="1311.14" data-end="1316.82">can do that by using request animation and counting the frames.</span> <span data-start="1316.82" data-end="1324.83">So the measure XHR is not super-reliable and I'm not even going to talk about it.</span> <span data-start="1324.83" data-end="1329.83">Some expensive operation just needs to be put on a queue and be deferred until later</span> <span data-start="1329.83" data-end="1336.08">and we can go ahead and just tell it: hey, when the FPS is at least 30, then maybe it's</span> <span data-start="1336.08" data-end="1338.1">a safe time to go ahead and do this.</span> </p>
<p><span data-start="1338.1" data-end="1344.1">We will probably want to wait until other libraries have done their thing and this will</span> <span data-start="1344.1" data-end="1347.62">probably work.</span> <span data-start="1347.62" data-end="1353.76">So developer ergonomics, earlier I said a lot of these embedded JavaScript libraries,</span> <span data-start="1353.76" data-end="1361.06">they sacrifice a lot of the modern development practices that we've learned over the past</span> <span data-start="1361.06" data-end="1368.19">few years in favour of creating a very small, tight, single JavaScript file, and I'm arguing</span> <span data-start="1368.19" data-end="1373.35">that that will result in crappier code that will not be maintained properly, so just think</span> <span data-start="1373.35" data-end="1374.61">about it.</span> </p>
<p><span data-start="1374.61" data-end="1378.61">So for AMP viewer reading TypeScript as I said before, it's really great, it produces</span> <span data-start="1378.61" data-end="1383.95">fairly small type code that's ES5 compliant and we have a really great developer experience</span> <span data-start="1383.95" data-end="1384.95">from it.</span> <span data-start="1384.95" data-end="1385.971">So what does the AMP viewer do?</span> <span data-start="1385.971" data-end="1387.99">This is what I was explaining before.</span> <span data-start="1387.99" data-end="1391.84">A little BMW cable, that's not going to work.</span> <span data-start="1391.84" data-end="1393.78">That is cool.</span> </p>
<p><span data-start="1393.78" data-end="1398.4">Let's try to go back and see if it does it.</span> <span data-start="1398.4" data-end="1401.28">Whatever, you guys know what I was talking about.</span> <span data-start="1401.28" data-end="1406.25">It handles push state history API, it has got very smooth animations and we are actually</span> <span data-start="1406.25" data-end="1412.22">using a library called Preact and Jason Miller is giving a talk right now about it and it's</span> <span data-start="1412.22" data-end="1419.54">a 3.5 version of React so it works really well, we've got it on thousands of websites</span> <span data-start="1419.54" data-end="1425.81">right now and some of the builds are under 15 kilobytes which to me still seems too much.</span> <span data-start="1425.81" data-end="1428.44">3.5 of those kilobytes is Preact.</span> <span data-start="1428.44" data-end="1436.72">I am pretty sure we can get this down, all the components, everything, and once I figure</span> <span data-start="1436.72" data-end="1442.41">out how to properly mangle all my props using Closure Compiler I think we will be in a pretty</span> <span data-start="1442.41" data-end="1444.5">good state.</span> </p>
<p><span data-start="1444.5" data-end="1449.38">So anyway, like I said, we've got this really beautiful component-based architecture using</span> <span data-start="1449.38" data-end="1454.44">TypeScript so everything is checked statically at compile time and we didn't really have</span> <span data-start="1454.44" data-end="1461.05">to sacrifice the code in order to have a small file size.</span> <span data-start="1461.05" data-end="1467.34">Also, you know, module bundlers these days roll up in webpack, they can export things</span> <span data-start="1467.34" data-end="1473.14">to globals and just use function closures so you are having really tight code that is</span> <span data-start="1473.14" data-end="1478.05">just wrapped by functions rather than something like browser — little header file or a little</span> <span data-start="1478.05" data-end="1483.83">header part that helps load the module at run time so you don't have a whole lot of</span> <span data-start="1483.83" data-end="1489.21">overhead and you can also export to multiple targets, right?</span> </p>
<p><span data-start="1489.21" data-end="1492.75">The general consumption target is going to be to global.</span> <span data-start="1492.75" data-end="1495.52">Something they are going to copy and paste that needs to self-register under the page</span> <span data-start="1495.52" data-end="1500.01">is going to be text supported, right?</span> <span data-start="1500.01" data-end="1505.52">But so many times I have downloaded or tried to use an analytics tool and they say the</span> <span data-start="1505.52" data-end="1511.72">way to install this is you copy and paste this chunk of minified onto your page, and</span> <span data-start="1511.72" data-end="1521.9">I end up copying and pasting that into its own little module so it's all in my bundle,</span> <span data-start="1521.9" data-end="1522.9">right?</span> <span data-start="1522.9" data-end="1526.15">So it's so easy to just have a different target for your developers.</span> <span data-start="1526.15" data-end="1532.24">You have an ES6 target and you say in your package data: here is my ES next entry point</span> <span data-start="1532.24" data-end="1536.97">and here is my main entry point, my widget.</span> <span data-start="1536.97" data-end="1545.19">It's really easy to do so use rollup or webpack please and also export to global for the non-techies.</span> <span data-start="1545.19" data-end="1551.34">So we've kind of gone all over the place and I hope that you maybe learned a little bit</span> <span data-start="1551.34" data-end="1553.85">from my travels.</span> </p>
<p><span data-start="1553.85" data-end="1559.32">So please responsibly code and maybe try out the fingerprinting API.</span> <span data-start="1559.32" data-end="1562.76">That should be open source pretty soon.</span> <span data-start="1562.76" data-end="1568.99">And queue your expensive operations because, yes, it's good for the world.</span> <span data-start="1568.99" data-end="1569.99">So thanks.</span> </p>
</section>