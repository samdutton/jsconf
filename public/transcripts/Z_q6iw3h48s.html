<section>
<p><span data-start="34.86" data-end="37.11">my name is reached a fever of well</span> <span data-start="37.11" data-end="39.27">friends and non Russian speakers call me</span> <span data-start="39.27" data-end="43.05">Slava and I walk in denmark on v8 for</span> <span data-start="43.05" data-end="45.09">the last two years and initially I</span> <span data-start="45.09" data-end="46.62">planned to call my talk one day of life</span> <span data-start="46.62" data-end="49.53">in v8 but then it was explained to me</span> <span data-start="49.53" data-end="50.82">that nobody will give me the whole day</span> <span data-start="50.82" data-end="54.809">on the miserable 30 minutes and so I had</span> <span data-start="54.809" data-end="57.6">to chop it down to something much</span> <span data-start="57.6" data-end="60.15">shorter and more energetic like directly</span> <span data-start="60.15" data-end="62.04">proceed to questions answers for example</span> <span data-start="62.04" data-end="68.91">but yeah so oh my god so it's pretty</span> <span data-start="68.91" data-end="72.99">often that people ask me can we do</span> <span data-start="72.99" data-end="74.94">something like here's a piece of code</span> <span data-start="74.94" data-end="78.54">what we can do is that and my goal for</span> <span data-start="78.54" data-end="81.33">today is actually encourage you to look</span> <span data-start="81.33" data-end="86.67">under v8 hood and to understand what we</span> <span data-start="86.67" data-end="89.16">eat can or cannot do and maybe</span> <span data-start="89.16" data-end="91.05">contribute something back to eat if you</span> <span data-start="91.05" data-end="92.31">see that way it can do something better</span> <span data-start="92.31" data-end="97.02">and it's not scary so I will be maybe I</span> <span data-start="97.02" data-end="99.9">will try to be a fear killer by showing</span> <span data-start="99.9" data-end="102.18">you some horrible machine code or</span> <span data-start="102.18" data-end="107.28">something like that and yeah so that's</span> <span data-start="107.28" data-end="109.83">nagar i decided to use examples of code</span> <span data-start="109.83" data-end="114.33">that people sent to me in various / time</span> <span data-start="114.33" data-end="117.479">and like for example asking what we ate</span> <span data-start="117.479" data-end="121.29">can do with this multiplication of dot</span> <span data-start="121.29" data-end="124.82">product of two vectors representatives</span> <span data-start="124.82" data-end="129.869">external WebGL erase or maybe what it</span> <span data-start="129.869" data-end="133.11">can do if it just represented that if</span> <span data-start="133.11" data-end="134.489">these vectors are represented as a</span> <span data-start="134.489" data-end="136.709">normal JavaScript arrays because they</span> <span data-start="136.709" data-end="138.39">heard that they are less efficient in v8</span> <span data-start="138.39" data-end="142.08">then the typed arrays or maybe a piece</span> <span data-start="142.08" data-end="144.06">of horrible code like that that can be</span> <span data-start="144.06" data-end="146.34">found in some library like prototype I</span> <span data-start="146.34" data-end="149.549">think where you have this constructor</span> <span data-start="149.549" data-end="151.47">with an apple application of the</span> <span data-start="151.47" data-end="154.41">initialization function and people ask</span> <span data-start="154.41" data-end="156.269">oh there is a apply and there is an</span> <span data-start="156.269" data-end="158.459">arguments I heard they are very</span> <span data-start="158.459" data-end="161.79">inefficient and what we eat can do is</span> <span data-start="161.79" data-end="165.35">that compared to the old school</span> <span data-start="165.35" data-end="167.66">structure which just construct an object</span> <span data-start="167.66" data-end="171.73">and doesn't try to be clever and and</span> <span data-start="171.73" data-end="174.59">even code like that so some functional</span> <span data-start="174.59" data-end="179.21">programmers they ask I like high order</span> <span data-start="179.21" data-end="181.58">functions i like to map my reduce and</span> <span data-start="181.58" data-end="185.9">reduce my map and currently oh my god</span> <span data-start="185.9" data-end="190.64">can we ate can we ate can we eat</span> <span data-start="190.64" data-end="194.5">transform it to a native loop maybe</span> <span data-start="194.5" data-end="198.77">please please please and so the answer</span> <span data-start="198.77" data-end="200.57">to these questions are actually pretty</span> <span data-start="200.57" data-end="202.25">simple you just need to look at the code</span> <span data-start="202.25" data-end="205.49">that regenerates and of course you can</span> <span data-start="205.49" data-end="207.83">do that we does not hide it anywhere and</span> <span data-start="207.83" data-end="210.98">doesn't try to I don't know put it</span> <span data-start="210.98" data-end="213.2">somewhere on the protected data center</span> <span data-start="213.2" data-end="217.28">it runs on your computer so yes of</span> <span data-start="217.28" data-end="219.11">course you can look at the code we it</span> <span data-start="219.11" data-end="223.22">generates unfortunately you have to</span> <span data-start="223.22" data-end="224.99">build v8 yourself to do that we don't</span> <span data-start="224.99" data-end="227.27">ship it together with chrome by default</span> <span data-start="227.27" data-end="229.46">because it occupies some space like</span> <span data-start="229.46" data-end="231.62">there is a built-in disassembler who</span> <span data-start="231.62" data-end="233.21">wants a built-in disassembler in the web</span> <span data-start="233.21" data-end="239.09">browser not that useful so well I am NOT</span> <span data-start="239.09" data-end="240.65">going to explain what's these days you</span> <span data-start="240.65" data-end="242.24">just build wit with some options and</span> <span data-start="242.24" data-end="243.71">then you run rate with some options and</span> <span data-start="243.71" data-end="245.3">then you can see everything that it</span> <span data-start="245.3" data-end="247.19">produces including the internal</span> <span data-start="247.19" data-end="249.86">representations of the functions it</span> <span data-start="249.86" data-end="252.89">optimizes and now we will try to apply</span> <span data-start="252.89" data-end="257">this sacred knowledge to the examples</span> <span data-start="257" data-end="258.799">that I have shown in the beginning of my</span> <span data-start="258.799" data-end="263.6">speech so this is an example and hear</span> <span data-start="263.6" data-end="266.03">somebody who actually reads what's</span> <span data-start="266.03" data-end="268.13">written and the slide can say oh my god</span> <span data-start="268.13" data-end="270.32">what's this that it wasn't there there</span> <span data-start="270.32" data-end="273.59">is something some dirty trick what's</span> <span data-start="273.59" data-end="277.43">happening the dance is very simple you</span> <span data-start="277.43" data-end="279.98">have to force me to optimize your code</span> <span data-start="279.98" data-end="281.93">in a sense that it does not try to</span> <span data-start="281.93" data-end="285.28">optimize anything that doesn't occupy</span> <span data-start="285.28" data-end="287.81">well any measurable time in the</span> <span data-start="287.81" data-end="290.45">execution of your program why waste an</span> <span data-start="290.45" data-end="291.7">effort and</span> <span data-start="291.7" data-end="294.22">so you have to put a pressure on this</span> <span data-start="294.22" data-end="297.7">function to get it optimized and to may</span> <span data-start="297.7" data-end="300.79">create to some work and produce some</span> <span data-start="300.79" data-end="305.32">sweat yeah so and here's the questions</span> <span data-start="305.32" data-end="307.39">that you should ask yourself when you</span> <span data-start="307.39" data-end="309.04">look at the JavaScript code of this</span> <span data-start="309.04" data-end="313.06">function is that can we eat hoist a dot</span> <span data-start="313.06" data-end="315.58">length it's one of the religious</span> <span data-start="315.58" data-end="317.8">questions actually i think in JavaScript</span> <span data-start="317.8" data-end="320.05">community should I cash this in the</span> <span data-start="320.05" data-end="322.48">local variable or should I just write it</span> <span data-start="322.48" data-end="326.68">like this fight fight and the other</span> <span data-start="326.68" data-end="329.68">question is can they access here be as</span> <span data-start="329.68" data-end="333.25">efficient as an array existence see well</span> <span data-start="333.25" data-end="335.14">because you everybody knows that the</span> <span data-start="335.14" data-end="338.32">race in JavaScript just normal objects</span> <span data-start="338.32" data-end="342.87">and the properties have names and erase</span> <span data-start="342.87" data-end="345.49">they have property which is called zero</span> <span data-start="345.49" data-end="349.87">probability called one etc and another</span> <span data-start="349.87" data-end="352.72">question is that can lv 8 avoid boxing</span> <span data-start="352.72" data-end="355.48">are temporaries produced by the</span> <span data-start="355.48" data-end="359.74">computation so we ate allocates</span> <span data-start="359.74" data-end="363.72">floating-point values in the boxes and</span> <span data-start="363.72" data-end="366.82">it doesn't sound very efficient so the</span> <span data-start="366.82" data-end="368.53">question is can it avoid doing that for</span> <span data-start="368.53" data-end="372.46">the local results and the other question</span> <span data-start="372.46" data-end="374.71">which is quite similar to this one is</span> <span data-start="374.71" data-end="377.38">can we eat avoid using floating</span> <span data-start="377.38" data-end="380.53">precision numbers entirely because here</span> <span data-start="380.53" data-end="382.21">we have one variable which is obviously</span> <span data-start="382.21" data-end="384.58">an integer and it doesn't make sense to</span> <span data-start="384.58" data-end="387.64">use the whole floating-point number to</span> <span data-start="387.64" data-end="391.45">represent it and here is an answer to</span> <span data-start="391.45" data-end="395.13">all the questions</span> <span data-start="395.14" data-end="402.02">so I actually skip the ski removed all</span> <span data-start="402.02" data-end="405.2">the comments to make it fit on the slide</span> <span data-start="405.2" data-end="408.65">actually v8 produces more than just this</span> <span data-start="408.65" data-end="412.28">loop entry comment it actually annotates</span> <span data-start="412.28" data-end="416.57">everything with like why did I produce</span> <span data-start="416.57" data-end="420.8">this bunch of assembly here like there</span> <span data-start="420.8" data-end="422.33">was an addition so I produce this</span> <span data-start="422.33" data-end="424.82">instruction but here i will be your</span> <span data-start="424.82" data-end="430.16">comment with a Russian accent so let's</span> <span data-start="430.16" data-end="435.14">start so this is this is a comparison so</span> <span data-start="435.14" data-end="437.86">they'll end the conditional branch</span> <span data-start="437.86" data-end="441.35">somewhere obviously it corresponds to</span> <span data-start="441.35" data-end="444.56">the loop condition because we will head</span> <span data-start="444.56" data-end="447.8">like I less than array dot length so if</span> <span data-start="447.8" data-end="449.54">we think a little bit about it it</span> <span data-start="449.54" data-end="452.75">becomes obvious that aesi contains I</span> <span data-start="452.75" data-end="455.169">andy sixx contains rate at length and</span> <span data-start="455.169" data-end="459.08">this already answers our question there</span> <span data-start="459.08" data-end="461.06">is no load of a rated lengths in the</span> <span data-start="461.06" data-end="463.94">body and it sits in the register and</span> <span data-start="463.94" data-end="467.45">obviously we ate somehow managed to move</span> <span data-start="467.45" data-end="471.38">it out of the loop so sometimes guys who</span> <span data-start="471.38" data-end="476">say your girls who say diversity that</span> <span data-start="476" data-end="478.94">you don't have to cash lengths they are</span> <span data-start="478.94" data-end="482.06">completely right then there is a bunch</span> <span data-start="482.06" data-end="483.41">of code that we can just keep because</span> <span data-start="483.41" data-end="485.39">there is no corresponding JavaScript</span> <span data-start="485.39" data-end="488.12">code it was produced just to support</span> <span data-start="488.12" data-end="490.85">such stuff like pausing the script</span> <span data-start="490.85" data-end="492.86">execution with the pause button in the</span> <span data-start="492.86" data-end="496.31">dev tools or terminating the busy loops</span> <span data-start="496.31" data-end="498.71">when some evil guy ships you a page</span> <span data-start="498.71" data-end="503.02">which has while to do something and</span> <span data-start="503.02" data-end="506.33">chrome will pop up the windows that you</span> <span data-start="506.33" data-end="508.31">ask you where they want to break this</span> <span data-start="508.31" data-end="510.56">loop and this is this code so we can</span> <span data-start="510.56" data-end="512.99">just keep it this is a load from the</span> <span data-start="512.99" data-end="515.419">array you can see a bounced check we're</span> <span data-start="515.419" data-end="517.4">checking whether something is inside the</span> <span data-start="517.4" data-end="521.33">bounds so ESI contains I ebx apparently</span> <span data-start="521.33" data-end="523.49">contains the lengths of a</span> <span data-start="523.49" data-end="526.85">and ii IX apparently contains length of</span> </p>
<p><span data-start="526.85" data-end="528.83">B and then there are loads of this</span> <span data-start="528.83" data-end="531.68">double floating-point double precision</span> <span data-start="531.68" data-end="535.1">values into XML registers so it looks</span> <span data-start="535.1" data-end="537.23">very similar to what a C compiler would</span> <span data-start="537.23" data-end="540.2">spread you so you could actually ask GCC</span> <span data-start="540.2" data-end="543.11">to produce their assembly and compare it</span> <span data-start="543.11" data-end="547.13">and it's pretty similar and here is a</span> <span data-start="547.13" data-end="548.899">multiplication addition so you don't</span> <span data-start="548.899" data-end="552.17">need a like any there is so you know</span> <span data-start="552.17" data-end="554.54">there are three volume of overall your</span> <span data-start="554.54" data-end="557.36">mental reference manuals and you don't</span> <span data-start="557.36" data-end="558.77">actually need them to understand that</span> <span data-start="558.77" data-end="562.3">this is a multiplication it says mal SD</span> </p>
<p><span data-start="562.3" data-end="566.57">SD we can skip mal so and then there is</span> <span data-start="566.57" data-end="569.149">an addition and you can notice that d it</span> <span data-start="569.149" data-end="572.08">also sits in the register xmm too so</span> <span data-start="572.08" data-end="574.61">everything looks very nice very tight</span> <span data-start="574.61" data-end="577.399">very compact and then they do the loop</span> <span data-start="577.399" data-end="580.7">increment so here somebody might have</span> <span data-start="580.7" data-end="582.86">might ask wait wait a second wait</span> <span data-start="582.86" data-end="584.45">javascript is a dynamically typed</span> <span data-start="584.45" data-end="588.709">language and where is all the type</span> <span data-start="588.709" data-end="591.02">checks and stuff like that there is</span> <span data-start="591.02" data-end="593.18">nothing like this in the loop at all we</span> <span data-start="593.18" data-end="595.399">just increment load but you don't check</span> <span data-start="595.399" data-end="596.72">the types we don't check that the array</span> <span data-start="596.72" data-end="599.45">is an array how does it happen well</span> <span data-start="599.45" data-end="601.82">actually we it moved everything let's</span> <span data-start="601.82" data-end="606.529">invariant like we know that a stays the</span> <span data-start="606.529" data-end="608.39">same during the whole loop so all these</span> <span data-start="608.39" data-end="610.459">checks they were moved out of the loop</span> <span data-start="610.459" data-end="613.339">entirely and if you look was before the</span> <span data-start="613.339" data-end="617.36">loop so the number 146 kind of indicates</span> <span data-start="617.36" data-end="619.87">that there is something before that and</span> <span data-start="619.87" data-end="622.04">there are a lot of stuff before that</span> <span data-start="622.04" data-end="624.709">here is for example the load of length</span> <span data-start="624.709" data-end="628.399">array that links properties so and he's</span> <span data-start="628.399" data-end="630.17">this is the magical number that allows</span> <span data-start="630.17" data-end="632.86">me to check whether something has a</span> <span data-start="632.86" data-end="635.81">certain like shape this is called the</span> <span data-start="635.81" data-end="637.339">hidden class so map in the eighth</span> <span data-start="637.339" data-end="639.529">basically every object has this attached</span> <span data-start="639.529" data-end="642.44">to it and then need only one instruction</span> <span data-start="642.44" data-end="644.899">to say to determine whether something</span> <span data-start="644.899" data-end="648.05">has the particular type and then if it</span> <span data-start="648.05" data-end="650.66">does not have UD optimized so there was</span> <span data-start="650.66" data-end="653.959">a talk about multiple tiered compilation</span> <span data-start="653.959" data-end="656.57">in JavaScript code before and so it</span> <span data-start="656.57" data-end="657.279">should be already</span> </p>
<p><span data-start="657.279" data-end="660.399">Amelia with this term and there is a</span> <span data-start="660.399" data-end="662.879">load so everything looks pretty</span> <span data-start="662.879" data-end="669.009">understandable after a year or two so</span> <span data-start="669.009" data-end="671.319">and here's the question how we do does</span> <span data-start="671.319" data-end="675.069">that and the answer is pretty simple</span> <span data-start="675.069" data-end="678.91">tons of this text but what this boils</span> <span data-start="678.91" data-end="683.259">down to is actually that v8 observes the</span> <span data-start="683.259" data-end="686.079">execution of your program somehow and</span> <span data-start="686.079" data-end="689.68">then it adapts itself and the code to</span> <span data-start="689.68" data-end="692.079">this execution so if you have stable</span> <span data-start="692.079" data-end="694.839">types stable ranges for your variables</span> <span data-start="694.839" data-end="698.199">we it would be will be able to adapt the</span> <span data-start="698.199" data-end="700.98">code to get the most out of the</span> <span data-start="700.98" data-end="703.509">execution like here we it adapted the</span> <span data-start="703.509" data-end="711.04">loop to use like WebGL load from the</span> </p>
<p><span data-start="711.04" data-end="713.11">WebGL erase because it have seen that</span> <span data-start="713.11" data-end="718.449">this loads are loading doubles from the</span> <span data-start="718.449" data-end="723.55">floor 64 a and the key thing here I</span> <span data-start="723.55" data-end="728.5">inline caches so every thing that has</span> <span data-start="728.5" data-end="731.529">dynamic her like behavior dynamic lookup</span> <span data-start="731.529" data-end="734.559">built-in has a corresponding inline</span> <span data-start="734.559" data-end="739">caching v8 and inline cash remembers</span> <span data-start="739" data-end="741.069">what it have seen it's the whole goal of</span> <span data-start="741.069" data-end="743.92">caching so when they tries to optimize</span> <span data-start="743.92" data-end="746.47">this function it will just ask the</span> <span data-start="746.47" data-end="748.93">inline cash what did have seen and then</span> <span data-start="748.93" data-end="751.779">specialized the code for this</span> <span data-start="751.779" data-end="754.649">information so different colors indicate</span> <span data-start="754.649" data-end="760.139">like the yellow one so whatever this is</span> <span data-start="760.139" data-end="765">is like a lookup of a property and</span> <span data-start="765" data-end="769.12">purple I don't know what's pink pink</span> <span data-start="769.12" data-end="773.829">ones are like numeric operations or</span> <span data-start="773.829" data-end="778.6">comparisons and the other important</span> <span data-start="778.6" data-end="780.85">moment is that we it makes optimistic</span> <span data-start="780.85" data-end="785.009">assumptions about the code it compiles</span> <span data-start="785.009" data-end="788.98">basically it says okay you used float64</span> <span data-start="788.98" data-end="790.3">array and</span> <span data-start="790.3" data-end="792.79">cash tells me this I will assume that</span> <span data-start="792.79" data-end="796.33">this is always true and if this is not</span> <span data-start="796.33" data-end="798.85">true i will just sorry guys this will</span> <span data-start="798.85" data-end="801.79">run slow i will be optimized and this</span> <span data-start="801.79" data-end="807.01">enables the whole basically this enables</span> <span data-start="807.01" data-end="809.86">me to make the whole function fast path</span> <span data-start="809.86" data-end="814.98">for the stable types and stable behavior</span> <span data-start="814.98" data-end="818.14">so if you are not stable in your</span> </p>
<p><span data-start="818.14" data-end="820.03">JavaScript programs and your tight</span> <span data-start="820.03" data-end="822.21">computational kick kernels are not</span> <span data-start="822.21" data-end="827.17">stable it typed this is not go this is</span> <span data-start="827.17" data-end="833.17">not good I'm sorry okay so here is an</span> <span data-start="833.17" data-end="834.82">example of optimistic assumption which</span> <span data-start="834.82" data-end="837.28">v8 makes it doesn't like out of bounds</span> <span data-start="837.28" data-end="841.51">reads from the typed arrays it just</span> <span data-start="841.51" data-end="843.13">checks the bounce and then it does not</span> <span data-start="843.13" data-end="845.47">try to handle this situation it just</span> <span data-start="845.47" data-end="847.3">goes to some address which doesn't even</span> <span data-start="847.3" data-end="849.85">belong to this function it goes to some</span> <span data-start="849.85" data-end="852.79">deep cuts off fee to switch to none</span> <span data-start="852.79" data-end="856.03">optimized code and twice this is the</span> <span data-start="856.03" data-end="859.54">case why why is this the case on English</span> <span data-start="859.54" data-end="863.71">is difficult language and the reason is</span> <span data-start="863.71" data-end="865.12">very simple JavaScript has a very</span> <span data-start="865.12" data-end="866.83">peculiar semantics as you might be aware</span> <span data-start="866.83" data-end="869.17">if you do an out-of-bounds free it from</span> <span data-start="869.17" data-end="872.47">the typed array I think you should do a</span> <span data-start="872.47" data-end="876.31">prototype look up and go up rota type</span> <span data-start="876.31" data-end="878.29">chain so you can write something like</span> <span data-start="878.29" data-end="881.74">this very easily so you can have a gator</span> <span data-start="881.74" data-end="884.14">on the object prototype for the property</span> <span data-start="884.14" data-end="887.53">called too and if you make a floater 64</span> <span data-start="887.53" data-end="889.42">array of a length 1 and look up the</span> <span data-start="889.42" data-end="895.19">property to you will get getter executed</span> <span data-start="895.2" data-end="897.61">that's why you don't want to implement</span> <span data-start="897.61" data-end="900.01">this in Fast Pass it will just make the</span> <span data-start="900.01" data-end="902.5">whole loop huge if you start handling</span> <span data-start="902.5" data-end="906.88">these cases and it will also it will not</span> <span data-start="906.88" data-end="910.3">allow me to like assume that after the</span> <span data-start="910.3" data-end="912.43">load from the array there is there were</span> <span data-start="912.43" data-end="916.15">no side effects at all by then this</span> <span data-start="916.15" data-end="918.04">basically inhibits all optimizations if</span> <span data-start="918.04" data-end="921.059">we ate can't assume that so</span> <span data-start="921.059" data-end="924.599">this is the this explains why we does a</span> <span data-start="924.599" data-end="927.959">lot of local assumptions here somebody</span> <span data-start="927.959" data-end="930.689">evil or maybe not so evil moderately</span> <span data-start="930.689" data-end="934.409">evil might ask what if I write the code</span> <span data-start="934.409" data-end="937.139">like this to add a function call to the</span> <span data-start="937.139" data-end="940.349">mix and if there is a function called v8</span> <span data-start="940.349" data-end="942.749">can't do anything because it makes local</span> <span data-start="942.749" data-end="946.439">assumptions obviously can i defeat v8 I</span> <span data-start="946.439" data-end="950.489">want to defeat we 80 year and the answer</span> <span data-start="950.489" data-end="954.449">is no no not so simple my friend we does</span> <span data-start="954.449" data-end="957.449">in line of functions as well so yes it</span> <span data-start="957.449" data-end="959.369">can't do anything across cause but if it</span> <span data-start="959.369" data-end="961.769">knows the target of the call it will in</span> <span data-start="961.769" data-end="964.049">line it and the inline code will be</span> <span data-start="964.049" data-end="966.629">accessible for the analysis it will</span> <span data-start="966.629" data-end="970.529">analyze and it will see that there is no</span> <span data-start="970.529" data-end="972.449">side effects and stuff like that so</span> <span data-start="972.449" data-end="974.279">that's what happens here so the cold</span> <span data-start="974.279" data-end="975.989">almost didn't change because the</span> <span data-start="975.989" data-end="978.569">function is in line but of course if you</span> <span data-start="978.569" data-end="980.189">look before the loop then there will be</span> <span data-start="980.189" data-end="982.109">a piece of code that checks that the</span> <span data-start="982.109" data-end="983.819">target of the call is the same and you</span> <span data-start="983.819" data-end="985.439">can also notice that this check was</span> <span data-start="985.439" data-end="987.119">moved out of the loop as well like all</span> <span data-start="987.119" data-end="992.909">other checks so now I will try to scare</span> <span data-start="992.909" data-end="994.649">away in lining so there are constructs</span> <span data-start="994.649" data-end="997.379">that Lee does not like because there's</span> </p>
<p><span data-start="997.379" data-end="999.959">Carrie and one of the scary constructs</span> <span data-start="999.959" data-end="1006.619">ease with which is all scary and yes it</span> <span data-start="1006.619" data-end="1009.019">it is so scary that the proper use code</span> <span data-start="1009.019" data-end="1011.419">is also scary because it scared away in</span> <span data-start="1011.419" data-end="1014.779">lining and v8 had to produce some pretty</span> <span data-start="1014.779" data-end="1017.479">generic code for the loop so instead of</span> <span data-start="1017.479" data-end="1019.129">looking at the generated code I</span> <span data-start="1019.129" data-end="1021.229">encourage you in this case is to look at</span> <span data-start="1021.229" data-end="1023.419">the high level intermediate</span> <span data-start="1023.419" data-end="1025.819">representation used during optimization</span> <span data-start="1025.819" data-end="1028.189">it's much less scary than the native</span> <span data-start="1028.189" data-end="1031.22">code and much more verbose so this is an</span> <span data-start="1031.22" data-end="1034.97">example of this or both stuff disregards</span> <span data-start="1034.97" data-end="1039.199">faiz they are coming from something</span> <span data-start="1039.199" data-end="1042.579">called single static assignment form and</span> <span data-start="1042.579" data-end="1045.399">what we should pay attention to is this</span> <span data-start="1045.399" data-end="1048.799">stuff this is an invocation of our</span> <span data-start="1048.799" data-end="1051.649">function called mal and it has this</span> <span data-start="1051.649" data-end="1054.04">scary changes</span> <span data-start="1054.04" data-end="1056.53">square brackets star thing it says that</span> <span data-start="1056.53" data-end="1058.3">we it can't su menacing a decent</span> <span data-start="1058.3" data-end="1060.28">vacation because it can change</span> <span data-start="1060.28" data-end="1064.93">everything and of course we it can't</span> <span data-start="1064.93" data-end="1068.08">optimize anything across the the</span> <span data-start="1068.08" data-end="1069.82">indication of this function because it</span> <span data-start="1069.82" data-end="1072.81">no knows nothing about side effects like</span> <span data-start="1072.81" data-end="1075.1">what will happen what if somebody will</span> <span data-start="1075.1" data-end="1078.58">define a property on them like float64</span> <span data-start="1078.58" data-end="1082.17">array which also has a gator or whatever</span> <span data-start="1082.17" data-end="1086.41">so the load of the length property now</span> <span data-start="1086.41" data-end="1090.1">in the loop so they did not manage to</span> <span data-start="1090.1" data-end="1092.68">hoist it out and there is untagging</span> <span data-start="1092.68" data-end="1094.57">which you can disregard and there is</span> <span data-start="1094.57" data-end="1096.88">this strange stuff so we call the</span> <span data-start="1096.88" data-end="1101.77">malfunction and then returns t46 which</span> <span data-start="1101.77" data-end="1104.74">will then convert to double so t46 is a</span> <span data-start="1104.74" data-end="1107.82">boxed double and we need to extract the</span> <span data-start="1107.82" data-end="1112">double which sits in the box take it and</span> <span data-start="1112" data-end="1114.43">then they all sorry and then actually do</span> <span data-start="1114.43" data-end="1117.91">a an addition on the doubles so you can</span> <span data-start="1117.91" data-end="1120.43">see that so when we inhibited these</span> <span data-start="1120.43" data-end="1123.34">optimizations by scaring away the</span> <span data-start="1123.34" data-end="1127.78">inlining we could not avoid boxing on</span> <span data-start="1127.78" data-end="1130.54">the boundary of the function call and it</span> <span data-start="1130.54" data-end="1133.84">could not host out the lengths load from</span> <span data-start="1133.84" data-end="1137.98">the rail loop so the know the advice</span> <span data-start="1137.98" data-end="1139.5">here is that if you have a tight</span> <span data-start="1139.5" data-end="1142.15">computational kernels you should ensure</span> <span data-start="1142.15" data-end="1145.09">that we it is able to inline all the</span> <span data-start="1145.09" data-end="1146.38">functions that you are calling these</span> <span data-start="1146.38" data-end="1148.81">tight computational kernels usually it</span> <span data-start="1148.81" data-end="1150.37">is able but you should check that out</span> <span data-start="1150.37" data-end="1153.37">and some people see like maybe ten</span> <span data-start="1153.37" data-end="1155.8">twenty percent improvement if they are</span> <span data-start="1155.8" data-end="1157.75">then lined by hand what we decided that</span> <span data-start="1157.75" data-end="1160.12">it can't in line for some reason or just</span> <span data-start="1160.12" data-end="1162.52">make it suitable for in line and this</span> <span data-start="1162.52" data-end="1164.91">all is visible under like high level</span> <span data-start="1164.91" data-end="1168.91">representations and stuff ok now let's</span> <span data-start="1168.91" data-end="1175.18">quickly go through this case so I remove</span> <span data-start="1175.18" data-end="1179.17">the type to race entirely because some</span> <span data-start="1179.17" data-end="1182.8">people ask her we heard that typed</span> <span data-start="1182.8" data-end="1184">arrays are more efficient yes they were</span> <span data-start="1184" data-end="1187.1">but now we are working on enabling v</span> <span data-start="1187.1" data-end="1189.98">to understand when your array contains</span> <span data-start="1189.98" data-end="1192.26">only numbers on the doubles and unbox it</span> <span data-start="1192.26" data-end="1194.57">automatically so you wouldn't table you</span> <span data-start="1194.57" data-end="1198.35">would not need to use verbose flow 64a</span> <span data-start="1198.35" data-end="1201.49">just write a normal JavaScript code and</span> <span data-start="1201.49" data-end="1204.169">this is the Chi removed all the codes</span> <span data-start="1204.169" data-end="1208.1">left only the loads from the array so it</span> <span data-start="1208.1" data-end="1209.539">looks pretty similar to what we have</span> <span data-start="1209.539" data-end="1212.809">seen in the load from type theory but</span> <span data-start="1212.809" data-end="1214.85">there is some strange stuff they're</span> <span data-start="1214.85" data-end="1216.65">still in addition to it like comparison</span> <span data-start="1216.65" data-end="1219.59">is some strange constant and this is</span> <span data-start="1219.59" data-end="1224.45">because float this is because normal</span> </p>
<p><span data-start="1224.45" data-end="1226.25">JavaScript arrays they can contain holes</span> <span data-start="1226.25" data-end="1231.53">and if you load something from the</span> <span data-start="1231.53" data-end="1233.96">nimbus which is the whole you have to go</span> <span data-start="1233.96" data-end="1235.61">up through prototype and we in the v8</span> <span data-start="1235.61" data-end="1238.37">again does not support that so for typed</span> <span data-start="1238.37" data-end="1239.809">arrays we know that there are no holes</span> <span data-start="1239.809" data-end="1244.52">but for GS erase that were unboxed they</span> <span data-start="1244.52" data-end="1246.049">can still contain holes like you can</span> <span data-start="1246.049" data-end="1248.99">delete the property with index 2 and we</span> <span data-start="1248.99" data-end="1251.419">don't want to convert the array if you</span> <span data-start="1251.419" data-end="1253.58">delete one element there we don't want</span> <span data-start="1253.58" data-end="1256.07">to convert it to a hash table because</span> <span data-start="1256.07" data-end="1259.15">this is an insanity so we use a special</span> <span data-start="1259.15" data-end="1264.919">non-value to indicate that this is a</span> <span data-start="1264.919" data-end="1267.71">hole because the non values are very</span> <span data-start="1267.71" data-end="1270.049">nice you can have different names even</span> <span data-start="1270.049" data-end="1271.69">if you can't observe that from</span> </p>
<p><span data-start="1271.69" data-end="1274.22">JavaScript so we use a special name to</span> <span data-start="1274.22" data-end="1278.14">detect that and this is the whole name</span> <span data-start="1278.14" data-end="1282.86">okay anyways yeah this is what we do and</span> <span data-start="1282.86" data-end="1285.35">here one can also suggest for example</span> <span data-start="1285.35" data-end="1287.24">and then submit as a change list which</span> <span data-start="1287.24" data-end="1289.909">we will accept and land maybe I'm pretty</span> <span data-start="1289.909" data-end="1292.76">sure we will that tracks the denseness</span> <span data-start="1292.76" data-end="1295.159">of the name of an array because it will</span> <span data-start="1295.159" data-end="1297.289">have to remove these holes checks and</span> <span data-start="1297.289" data-end="1300.35">make the loop even tighter and more</span> <span data-start="1300.35" data-end="1303.14">concise and faster obviously and</span> <span data-start="1303.14" data-end="1305.63">everybody who does computation in pure</span> </p>
<p><span data-start="1305.63" data-end="1307.659">JavaScript will be happy and praise you</span> <span data-start="1307.659" data-end="1310.28">so please do this if you want to</span> <span data-start="1310.28" data-end="1315.48">experience something beautiful</span> <span data-start="1315.49" data-end="1319.79">now this example there was this applied</span> <span data-start="1319.79" data-end="1323.99">arguments which I removed and so I do</span> <span data-start="1323.99" data-end="1325.91">test which creates this new class with a</span> <span data-start="1325.91" data-end="1328.52">class constructor which has this dot a</span> <span data-start="1328.52" data-end="1331.1">neat apply these arguments in sighs okay</span> <span data-start="1331.1" data-end="1333.74">who thinks that this can be as efficient</span> <span data-start="1333.74" data-end="1338.39">as a old-school constructor one person</span> <span data-start="1338.39" data-end="1340.55">you don't believe in the eighth it can</span> <span data-start="1340.55" data-end="1343.4">be there is no apply at all if we look</span> <span data-start="1343.4" data-end="1345.71">at the high level representation that</span> <span data-start="1345.71" data-end="1347.66">something we did recently so there is an</span> <span data-start="1347.66" data-end="1350">object allocation then we in line vector</span> <span data-start="1350" data-end="1353.41">function and then we load init function</span> <span data-start="1353.41" data-end="1356.39">then we do a couple of checks directly</span> <span data-start="1356.39" data-end="1358.25">push the arguments because we are in the</span> <span data-start="1358.25" data-end="1359.93">inline context so we know how many</span> <span data-start="1359.93" data-end="1361.7">arguments are there there is no need to</span> <span data-start="1361.7" data-end="1363.53">materialize have been subject at all and</span> <span data-start="1363.53" data-end="1365.48">the semantics of the apply function is</span> <span data-start="1365.48" data-end="1368.18">known and inline cash tells us that it's</span> <span data-start="1368.18" data-end="1370.97">always an apply so we can just in line</span> <span data-start="1370.97" data-end="1373.13">everything and directly invoke the</span> <span data-start="1373.13" data-end="1375.17">function so yes we can apply it</span> <span data-start="1375.17" data-end="1379.84">completely gun and this example</span> <span data-start="1379.84" data-end="1383.06">unfortunately not now so I had to</span> <span data-start="1383.06" data-end="1384.38">include something that we can't do</span> <span data-start="1384.38" data-end="1386">otherwise it would look that way it can</span> <span data-start="1386" data-end="1387.56">do everything which is obviously not</span> <span data-start="1387.56" data-end="1393.05">true and but actually the whole</span> <span data-start="1393.05" data-end="1396.26">crankshaft pipeline was developed with a</span> <span data-start="1396.26" data-end="1397.85">thought in mind that you can do all</span> <span data-start="1397.85" data-end="1402.26">kinds of strange optimizations then this</span> <span data-start="1402.26" data-end="1403.79">optimization is available kind of</span> <span data-start="1403.79" data-end="1405.38">well-known optimization the functional</span> <span data-start="1405.38" data-end="1408.74">programming world when you combine</span> <span data-start="1408.74" data-end="1411.38">several high-level function in vacations</span> <span data-start="1411.38" data-end="1414.71">into a one tight loop so if you do this</span> <span data-start="1414.71" data-end="1418.37">plumbing so the infrastructure is there</span> <span data-start="1418.37" data-end="1420.65">which allows you to say this is the map</span> <span data-start="1420.65" data-end="1423.23">function this is a reduced function and</span> <span data-start="1423.23" data-end="1425.42">you know there is semantics so you can</span> <span data-start="1425.42" data-end="1427.87">just transform it into a loop like that</span> <span data-start="1427.87" data-end="1430.91">with some additional plumping I can't</span> <span data-start="1430.91" data-end="1433.55">say what's the length length of the pipe</span> <span data-start="1433.55" data-end="1435.89">that you need to stack their to do that</span> <span data-start="1435.89" data-end="1439.85">but it's doable so we accept patches as</span> <span data-start="1439.85" data-end="1441.77">i said i'm looking forward to see one</span> <span data-start="1441.77" data-end="1444.5">and there is this site which i will skip</span> <span data-start="1444.5" data-end="1447.61">and proceed to the questions and answers</span> </p>
</section>