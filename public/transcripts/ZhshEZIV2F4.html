<section>
<p><span data-start="15.3" data-end="18.36">my name is Michele rotzinger I work for</span> <span data-start="18.36" data-end="21.72">Google as a software engineer I work on</span> <span data-start="21.72" data-end="25.08">the v8 team which is now totally based</span> <span data-start="25.08" data-end="27.419">in in Munich so we ate this developed in</span> </p>
<p><span data-start="27.419" data-end="31.02">Munich and engineering office and the</span> <span data-start="31.02" data-end="32.279">purpose of this talk is basically</span> <span data-start="32.279" data-end="35.16">twofold one is performance of course we</span> <span data-start="35.16" data-end="37.019">are all talking about performance but</span> <span data-start="37.019" data-end="39.18">the second point is the memory footprint</span> <span data-start="39.18" data-end="41.87">that all the performance optimizations</span> <span data-start="41.87" data-end="46.32">introduced and so I want to give it a</span> <span data-start="46.32" data-end="48.21">different spin from all the other talks</span> <span data-start="48.21" data-end="51.54">that have been given about v8 and see</span> <span data-start="51.54" data-end="53.549">how we can get both of best worlds so</span> <span data-start="53.549" data-end="56.159">great performance and low memory</span> <span data-start="56.159" data-end="61.32">footprint so before I head off into that</span> <span data-start="61.32" data-end="65.25">first one slide basic overview of how v8</span> <span data-start="65.25" data-end="68.61">works and kind of a reminder of what you</span> <span data-start="68.61" data-end="71.64">might have already heard so the main</span> <span data-start="71.64" data-end="73.92">thing there are a few things at Google</span> <span data-start="73.92" data-end="75.96">that we know to be true and one of those</span> <span data-start="75.96" data-end="78.75">things is fast is better than slow so</span> <span data-start="78.75" data-end="81.179">obviously that's the main driving force</span> <span data-start="81.179" data-end="84.21">for v8 we want to be the fastest</span> <span data-start="84.21" data-end="89.67">javascript engine out there how do we</span> <span data-start="89.67" data-end="91.499">try to achieve that so there are a few</span> <span data-start="91.499" data-end="95.149">ingredients as to that one would be</span> <span data-start="95.149" data-end="98.52">inline caching which allows us to access</span> <span data-start="98.52" data-end="100.679">properties of objects fast because</span> <span data-start="100.679" data-end="102.659">that's the main thing that all</span> </p>
<p><span data-start="102.659" data-end="105.27">JavaScript applications do manipulate</span> <span data-start="105.27" data-end="108.659">objects access properties then as we</span> <span data-start="108.659" data-end="110.52">heard in a previous talk optimizing</span> <span data-start="110.52" data-end="113.009">compiler to really kick ass at the hot</span> <span data-start="113.009" data-end="117.869">methods and also another important</span> <span data-start="117.869" data-end="119.549">ingredients an efficient garbage</span> <span data-start="119.549" data-end="121.799">collector and we actually have a new GC</span> <span data-start="121.799" data-end="125.34">that's an incremental low post garbage</span> <span data-start="125.34" data-end="130.86">collector it's generational and we try</span> <span data-start="130.86" data-end="133.56">to get the power the post post times as</span> <span data-start="133.56" data-end="135.9">low as possible by basically</span> <span data-start="135.9" data-end="139.65">interleaving mutator work so work that</span> <span data-start="139.65" data-end="141.51">your application has to do with garbage</span> <span data-start="141.51" data-end="144.06">collection work slicing these up and</span> <span data-start="144.06" data-end="145.98">interleaving it so that we can make</span> <span data-start="145.98" data-end="148.2">progress with garbage collection as well</span> <span data-start="148.2" data-end="149.12">as pro</span> <span data-start="149.12" data-end="153.349">with your application and a lot of other</span> <span data-start="153.349" data-end="155.45">ingredients  â€” is we mix those up and</span> <span data-start="155.45" data-end="159.2">stir them well and hopefully get high</span> <span data-start="159.2" data-end="161.36">performance characteristics in our</span> <span data-start="161.36" data-end="167.81">engine so we got speed awesome but what</span> <span data-start="167.81" data-end="168.98">else did we get with death</span> <span data-start="168.98" data-end="171.11">imagine your you bought a new car and</span> <span data-start="171.11" data-end="174.2">you know it has a pretty damn engine in</span> <span data-start="174.2" data-end="176.51">there and you want to take it out for a</span> <span data-start="176.51" data-end="178.579">quick Drive and suddenly you find</span> <span data-start="178.579" data-end="182.299">yourself in here so you look around and</span> <span data-start="182.299" data-end="185.18">see you want the other cars and start</span> <span data-start="185.18" data-end="187.25">thinking about well hang on wait a</span> <span data-start="187.25" data-end="189.079">second what is the footprint of all of</span> <span data-start="189.079" data-end="191.45">that in your car you might be worried</span> <span data-start="191.45" data-end="194">about carbon footprint if you're talking</span> <span data-start="194" data-end="196.25">about JavaScript engines you might be</span> <span data-start="196.25" data-end="202.819">worried about memory footprint so before</span> </p>
<p><span data-start="202.819" data-end="204.37">I dive off into the memory footprint</span> <span data-start="204.37" data-end="206.629">first of all how would you optimize a</span> <span data-start="206.629" data-end="210.019">JavaScript application the most</span> <span data-start="210.019" data-end="211.94">important thing first of all is to find</span> <span data-start="211.94" data-end="213.95">the actual hotspots find what is</span> <span data-start="213.95" data-end="216.099">important for your application</span> <span data-start="216.099" data-end="218.81">performance wise that would be functions</span> <span data-start="218.81" data-end="221.419">that are worth being optimized because</span> <span data-start="221.419" data-end="223.88">they are executed often frequently a lot</span> <span data-start="223.88" data-end="226.31">of times memory wise that would be</span> <span data-start="226.31" data-end="229.879">finding objects that dominate the heap</span> <span data-start="229.879" data-end="232.87">that are omnipresent in the heap and</span> <span data-start="232.87" data-end="235.94">they live long or that have a bad memory</span> <span data-start="235.94" data-end="240.889">layout but once you found the actual</span> <span data-start="240.889" data-end="243.019">object is causing a problem you need to</span> <span data-start="243.019" data-end="244.849">understand why it's actually causing a</span> <span data-start="244.849" data-end="247.519">problem so without understanding the</span> <span data-start="247.519" data-end="249.349">actual problem there is no way you can</span> <span data-start="249.349" data-end="255.139">fix it and then you fix it and the last</span> <span data-start="255.139" data-end="258.579">item is really just that fixing it so</span> <span data-start="258.579" data-end="261.099">here is my very personal very</span> <span data-start="261.099" data-end="264.02">unscientific opinion of how much time</span> <span data-start="264.02" data-end="267.68">you need to invest into these steps so</span> <span data-start="267.68" data-end="269.75">fixing it is really just that if you</span> <span data-start="269.75" data-end="271.849">understood the problem getting rid of it</span> <span data-start="271.849" data-end="273.46">should be easy</span> <span data-start="273.46" data-end="275.81">this talk is mainly gonna focus about</span> <span data-start="275.81" data-end="278.32">understanding the problem at hand and</span> <span data-start="278.32" data-end="279.919">since these fix things</span> <span data-start="279.919" data-end="282.169">since fixing is so easy we will also</span> <span data-start="282.169" data-end="287.569">do that okay so let's look at a few</span> <span data-start="287.569" data-end="289.58">examples and three examples that I want</span> <span data-start="289.58" data-end="292.46">to present here are objects like</span> <span data-start="292.46" data-end="294.699">tracking array representation and</span> <span data-start="294.699" data-end="298.879">execution context we will look at three</span> <span data-start="298.879" data-end="302.029">examples in depth and discuss a few best</span> <span data-start="302.029" data-end="305.659">practices how to improve hot code around</span> <span data-start="305.659" data-end="307.969">those optimizations the first one will</span> <span data-start="307.969" data-end="310.639">be about how our objects represented in</span> <span data-start="310.639" data-end="312.74">memory second one our area is</span> <span data-start="312.74" data-end="314.839">represented in memory and the third one</span> <span data-start="314.839" data-end="317.719">how is your actual execution environment</span> <span data-start="317.719" data-end="320.62">of some function represented in memory</span> <span data-start="320.62" data-end="323.06">okay let's dive into that so the first</span> <span data-start="323.06" data-end="326.689">thing objects like tracking most of you</span> <span data-start="326.689" data-end="328.4">might have already seen this example the</span> <span data-start="328.4" data-end="331.219">famous point example and how would this</span> <span data-start="331.219" data-end="335.21">point be represented in memory so please</span> <span data-start="335.21" data-end="336.71">stick with me I'm gonna give it a</span> <span data-start="336.71" data-end="339.02">different spin this time with the</span> <span data-start="339.02" data-end="342.05">addition of slack tracking so let's go</span> <span data-start="342.05" data-end="343.58">through that application step by step</span> <span data-start="343.58" data-end="348.83">and I promise so I try to do this</span> <span data-start="348.83" data-end="351.11">without assembler so I just have fancy</span> <span data-start="351.11" data-end="352.939">graphics explaining it know assembler</span> <span data-start="352.939" data-end="355.849">code I hope that's okay so the first</span> <span data-start="355.849" data-end="357.8">thing when we execute that constructor</span> <span data-start="357.8" data-end="362.149">is we actually allocate the object in</span> <span data-start="362.149" data-end="366.199">memory you probably know that we have a</span> <span data-start="366.199" data-end="368.36">hidden class system behind all of that</span> <span data-start="368.36" data-end="371.21">because JavaScript in itself is a very</span> <span data-start="371.21" data-end="374.12">loosely typed language and to really</span> <span data-start="374.12" data-end="376.189">optimize for for certain objects we need</span> <span data-start="376.189" data-end="378.8">to have a more precise type system</span> <span data-start="378.8" data-end="382.039">behind it so we invent our own types and</span> <span data-start="382.039" data-end="385.43">call them hidden classes and we just</span> <span data-start="385.43" data-end="386.99">give that new object a little bit of</span> <span data-start="386.99" data-end="389.24">slack so in this graphic that would be</span> <span data-start="389.24" data-end="391.43">four slots that are available directly</span> <span data-start="391.43" data-end="394.669">in the object so there is no indirection</span> <span data-start="394.669" data-end="396.469">going on here you don't have a packing</span> <span data-start="396.469" data-end="399.08">store where the actual content will be</span> <span data-start="399.08" data-end="401.149">stored it's directly in the object that</span> <span data-start="401.149" data-end="405.379">also serves as an identity so let's add</span> <span data-start="405.379" data-end="409.49">the first property that would be X we we</span> <span data-start="409.49" data-end="411.889">add it and since we now modify the</span> <span data-start="411.889" data-end="414.919">object layout we actually added a new</span> <span data-start="414.919" data-end="416.15">property that can be ax</span> <span data-start="416.15" data-end="418.19">we also need to transition the hidden</span> <span data-start="418.19" data-end="420.74">class so it's now a new type in our type</span> <span data-start="420.74" data-end="423.02">system and we remember that transition</span> <span data-start="423.02" data-end="424.91">so whenever we start from the first</span> <span data-start="424.91" data-end="427.729">hidden class at X we'll go to the next</span> <span data-start="427.729" data-end="431.72">hidden class and as I mentioned before</span> <span data-start="431.72" data-end="434.54">we store the value directly in the</span> <span data-start="434.54" data-end="437.449">object so accessing it is just taking</span> <span data-start="437.449" data-end="439.61">it's just loading one word out of the</span> <span data-start="439.61" data-end="443.66">object no indirection second step</span> <span data-start="443.66" data-end="446.72">obvious add a new property transition to</span> <span data-start="446.72" data-end="450.68">a hidden class again so if you think of</span> <span data-start="450.68" data-end="453.65">this transition chain or transition tree</span> <span data-start="453.65" data-end="455.09">that you get on the on the on the right</span> <span data-start="455.09" data-end="458.3">hand side you can imagine what would</span> <span data-start="458.3" data-end="460.4">happen if you suddenly add these</span> <span data-start="460.4" data-end="462.62">properties in a different order you</span> <span data-start="462.62" data-end="464.479">would end up with a different in class</span> <span data-start="464.479" data-end="467.27">in the end so that would be one point to</span> <span data-start="467.27" data-end="473.03">avoid now let's repeat that with the</span> <span data-start="473.03" data-end="474.59">follow up down there so we get two</span> <span data-start="474.59" data-end="477.62">objects both have x and y and now we</span> <span data-start="477.62" data-end="481.01">have this fancy modification of the</span> <span data-start="481.01" data-end="482.75">object that comes right after the</span> <span data-start="482.75" data-end="484.97">constructor so how would we deal with</span> <span data-start="484.97" data-end="487.78">that so every second object gets a set</span> <span data-start="487.78" data-end="490.58">property okay we can just add that no</span> <span data-start="490.58" data-end="494.18">problem we still have slack in the</span> <span data-start="494.18" data-end="496.7">object so both objects are actually over</span> <span data-start="496.7" data-end="498.889">allocated we allocated too much memory</span> <span data-start="498.889" data-end="503.96">for those objects and at some point when</span> <span data-start="503.96" data-end="505.639">we have enough of these objects we</span> <span data-start="505.639" data-end="510.5">decide to basically freeze T the T</span> <span data-start="510.5" data-end="512.15">transition tree we say okay your</span> <span data-start="512.15" data-end="514.81">application has allocated enough objects</span> <span data-start="514.81" data-end="517.4">they are probably gonna look like this</span> <span data-start="517.4" data-end="519.86">most of the time so we are gonna freeze</span> <span data-start="519.86" data-end="522.56">that state and say okay those are those</span> <span data-start="522.56" data-end="524.6">are the classes two hidden classes that</span> <span data-start="524.6" data-end="527.089">you're gonna work with now we actually</span> <span data-start="527.089" data-end="528.98">want to get rid of the slack that we</span> <span data-start="528.98" data-end="530.87">have at the end of each object and we</span> <span data-start="530.87" data-end="533.779">can do that we just shrink the objects</span> <span data-start="533.779" data-end="537.41">the problem is every point that you</span> <span data-start="537.41" data-end="539.089">instantiate with the point constructor</span> <span data-start="539.089" data-end="541.88">can either have two or three properties</span> <span data-start="541.88" data-end="545.3">and we don't know how many so we need to</span> <span data-start="545.3" data-end="548.3">keep around at least three slacks in</span> <span data-start="548.3" data-end="549.92">each newly allocated</span> <span data-start="549.92" data-end="551.81">check and that means for half of the</span> <span data-start="551.81" data-end="554.24">object we waste that memory it's really</span> <span data-start="554.24" data-end="558.589">wasted so that's probably bad if that's</span> <span data-start="558.589" data-end="560.42">a hot object meaning you have like a</span> <span data-start="560.42" data-end="561.889">million of those objects floating around</span> <span data-start="561.889" data-end="567.68">in memory that would be pretty bad so we</span> <span data-start="567.68" data-end="569.209">hopefully understood the problem now how</span> <span data-start="569.209" data-end="571.459">can we fix it well fixing it is easy</span> <span data-start="571.459" data-end="574.22">just use two constructors meaning you</span> <span data-start="574.22" data-end="576.86">come up with to transition freeze or</span> <span data-start="576.86" data-end="580.22">transition chains and both Maps can be</span> <span data-start="580.22" data-end="583.97">optimized for their object size so that</span> <span data-start="583.97" data-end="588.769">fix is pretty easy and either so I left</span> <span data-start="588.769" data-end="590.36">the implementation of those to construct</span> <span data-start="590.36" data-end="592.13">this point one point two and point three</span> <span data-start="592.13" data-end="592.55">out</span> <span data-start="592.55" data-end="594.86">you can either implement them directly</span> <span data-start="594.86" data-end="596.72">which means you have some duplication in</span> <span data-start="596.72" data-end="600.17">there you could use some frameworks that</span> <span data-start="600.17" data-end="601.639">are out there like the prototype</span> <span data-start="601.639" data-end="606.529">framework all types of inheritance you</span> <span data-start="606.529" data-end="610.699">could even use you from within point</span> <span data-start="610.699" data-end="612.5">three you could call the point two</span> <span data-start="612.5" data-end="616.49">constructor by using point to call this</span> <span data-start="616.49" data-end="618.26">and pass the arguments through that</span> <span data-start="618.26" data-end="620.899">would all work the object layout would</span> <span data-start="620.899" data-end="622.579">still look like this important thing is</span> <span data-start="622.579" data-end="625.64">use two different constructors tell the</span> </p>
<p><span data-start="625.64" data-end="627.709">VM that you actually are dealing with</span> <span data-start="627.709" data-end="632.99">two different types here so I said we</span> <span data-start="632.99" data-end="636.529">should measure it I hacked this pattern</span> <span data-start="636.529" data-end="639.35">into a ray tracer which deals with about</span> <span data-start="639.35" data-end="643.459">600 points 600 thousand points and up to</span> <span data-start="643.459" data-end="648.44">three wasted stack as select slots in</span> <span data-start="648.44" data-end="649.91">the in the objects and keeps them alive</span> <span data-start="649.91" data-end="652.819">in memory and that's improvement that</span> <span data-start="652.819" data-end="655.61">you get out of that and those are forty</span> <span data-start="655.61" data-end="659.87">percent so forty percent less memory</span> <span data-start="659.87" data-end="662.149">that your application consumes which is</span> <span data-start="662.149" data-end="670.91">quite ok I guess so now since if you</span> <span data-start="670.91" data-end="673.73">don't want to to to to think through all</span> <span data-start="673.73" data-end="675.709">of this every time and and come up with</span> <span data-start="675.709" data-end="678.17">the actual representation that your</span> <span data-start="678.17" data-end="681.5">object is gonna be in memory I will give</span> <span data-start="681.5" data-end="683.24">you a few best practices that you can</span> <span data-start="683.24" data-end="683.75">follow</span> <span data-start="683.75" data-end="685.79">and that will hopefully allow you to</span> <span data-start="685.79" data-end="687.139">write applications that are both</span> <span data-start="687.139" data-end="690.41">extremely fast and slick memory</span> <span data-start="690.41" data-end="693.74">consumption wise so first thing is try</span> <span data-start="693.74" data-end="696.29">to initialize all properties in the</span> <span data-start="696.29" data-end="700.009">constructor and as I mentioned before at</span> <span data-start="700.009" data-end="701.449">all the properties in the same order</span> <span data-start="701.449" data-end="703.399">because otherwise that would screw up or</span> <span data-start="703.399" data-end="707.99">our hidden classes and avoid object</span> <span data-start="707.99" data-end="710.209">layout modification after the fact so</span> <span data-start="710.209" data-end="712.009">after the constructor has come up with</span> <span data-start="712.009" data-end="717.649">the initial object layout now this might</span> <span data-start="717.649" data-end="719.839">sound like I'm taking away a little bit</span> <span data-start="719.839" data-end="722.959">of freedom from the from there from the</span> <span data-start="722.959" data-end="724.779">expressiveness that you have in</span> </p>
<p><span data-start="724.779" data-end="728.36">JavaScript but let me tell you a story</span> <span data-start="728.36" data-end="731.75">about that so I went into this I went to</span> <span data-start="731.75" data-end="733.85">this pup recently and that the entry</span> <span data-start="733.85" data-end="737.269">they had to sign and it said this pup</span> <span data-start="737.269" data-end="741.05">serves food that is good cheap and</span> <span data-start="741.05" data-end="744.829">served fast you can choose 3 you can</span> <span data-start="744.829" data-end="749.059">choose 2 and that's kind of this kind of</span> <span data-start="749.059" data-end="750.879">reminded me of this so you have</span> <span data-start="750.879" data-end="754.009">performance speed only one hand then you</span> <span data-start="754.009" data-end="755.87">have memory footprint on the other hand</span> <span data-start="755.87" data-end="757.73">and then you have the expressive power</span> <span data-start="757.73" data-end="759.649">or the freedom that JavaScript gives you</span> <span data-start="759.649" data-end="761.389">and I'm not claiming that those three</span> <span data-start="761.389" data-end="763.55">are actually all the time mutually</span> <span data-start="763.55" data-end="766.85">exclusive but knowing about those three</span> <span data-start="766.85" data-end="769.309">points in the triangle understanding it</span> <span data-start="769.309" data-end="771.23">and knowing where you're located in this</span> <span data-start="771.23" data-end="773.72">triangle might help you to write better</span> <span data-start="773.72" data-end="779">applications ok so let's move on to the</span> <span data-start="779" data-end="782.449">second example array representation so</span> <span data-start="782.449" data-end="784.73">far we only talked about named</span> <span data-start="784.73" data-end="786.98">properties now it's gonna be about index</span> <span data-start="786.98" data-end="791.329">properties so again we have something</span> <span data-start="791.329" data-end="793.129">that is used as a constructor or that</span> <span data-start="793.129" data-end="795.41">that used as a factory to instantiate</span> <span data-start="795.41" data-end="799.22">arrays and again it's a hot method</span> <span data-start="799.22" data-end="800.75">because it's executed several times</span> <span data-start="800.75" data-end="802.759">there by the array it repeats it</span> <span data-start="802.759" data-end="807.829">produces is a hot object and might make</span> <span data-start="807.829" data-end="812.209">up a bulk of your heap so the first</span> <span data-start="812.209" data-end="813.86">thing we do here is we actually</span> <span data-start="813.86" data-end="816.45">instantiate a new array</span> <span data-start="816.45" data-end="819.72">for Aries we want to have an object it</span> <span data-start="819.72" data-end="821.55">represents its identity that would be</span> <span data-start="821.55" data-end="824.82">the small box at the top that also</span> <span data-start="824.82" data-end="827.04">stores the length so how many elements</span> <span data-start="827.04" data-end="828.69">how many index properties do you</span> <span data-start="828.69" data-end="830.7">actually have another array and we over</span> <span data-start="830.7" data-end="833.31">reserved the backing store again so we</span> <span data-start="833.31" data-end="835.35">again have like four entries that we can</span> <span data-start="835.35" data-end="837.57">fill up after the fact without resizing</span> <span data-start="837.57" data-end="840.63">the actual packing store so we can do</span> <span data-start="840.63" data-end="844.65">that we add in index property with the</span> <span data-start="844.65" data-end="848.49">name zero we add the index property with</span> <span data-start="848.49" data-end="851.25">the name one and now we add another</span> <span data-start="851.25" data-end="854.61">property that's actually a double value</span> <span data-start="854.61" data-end="857.76">so the packing store is intended to</span> <span data-start="857.76" data-end="861.66">store integers or small integers</span> <span data-start="861.66" data-end="863.94">actually so now that we store a double</span> <span data-start="863.94" data-end="865.83">into it we actually want to have an</span> <span data-start="865.83" data-end="867.6">efficient representation of that packing</span> <span data-start="867.6" data-end="869.73">store efficient performance wise that</span> <span data-start="869.73" data-end="871.89">means we actually want to unbox those</span> <span data-start="871.89" data-end="874.17">doubles in that packing store that means</span> <span data-start="874.17" data-end="875.82">we have to change the layout of that</span> <span data-start="875.82" data-end="878.64">packing store and we do that it's now</span> <span data-start="878.64" data-end="884.37">taking 64-bit words and that packing</span> <span data-start="884.37" data-end="886.62">store is able to store doubles directly</span> <span data-start="886.62" data-end="889.65">in them so as you see the 0.5 is stored</span> <span data-start="889.65" data-end="891.78">directly into that packing store that</span> <span data-start="891.78" data-end="894">means we have to convert all the</span> <span data-start="894" data-end="896.07">previous small integers into actual</span> <span data-start="896.07" data-end="898.65">doubles now that conversion takes a bit</span> <span data-start="898.65" data-end="901.44">of time takes additional memory but that</span> <span data-start="901.44" data-end="902.91">doesn't matter that much because the old</span> <span data-start="902.91" data-end="905.04">one is no longer reference and can be</span> <span data-start="905.04" data-end="910.64">garbage collected so and next we store</span> <span data-start="910.64" data-end="913.92">an object and the true value in that</span> <span data-start="913.92" data-end="915.93">packing store that's represented as an</span> <span data-start="915.93" data-end="918.9">object and that means the work we just</span> <span data-start="918.9" data-end="921.66">did most bogus we have to go back to the</span> <span data-start="921.66" data-end="924.54">old representation again 32-bit and now</span> <span data-start="924.54" data-end="927.78">we actually need to box the 0.5 to</span> <span data-start="927.78" data-end="930.63">double value which again means we have</span> <span data-start="930.63" data-end="932.79">wasted a few cycles by converting back</span> <span data-start="932.79" data-end="935.13">and forth allocated a new backing store</span> <span data-start="935.13" data-end="938.46">again and collected by a bunch of hidden</span> <span data-start="938.46" data-end="941.31">class transitions that track those</span> <span data-start="941.31" data-end="945.99">transitions so if we generate lots of</span> <span data-start="945.99" data-end="947.87">these arrays</span> <span data-start="947.87" data-end="950.21">it's gonna get gonna have a bad</span> <span data-start="950.21" data-end="952.76">performance and also you see there are a</span> <span data-start="952.76" data-end="954.23">lot of packing stores which actually</span> <span data-start="954.23" data-end="958.58">contain the same the same values so that</span> <span data-start="958.58" data-end="960.23">doesn't look very efficient neither</span> <span data-start="960.23" data-end="964.64">performance wise nor memory wise so what</span> <span data-start="964.64" data-end="967.01">would be a possible fix of that possible</span> <span data-start="967.01" data-end="970.25">fix would be to not use this strange</span> <span data-start="970.25" data-end="973.76">construct at all but use an array</span> <span data-start="973.76" data-end="977.27">literal with an array literal b8 can</span> <span data-start="977.27" data-end="979.43">basically infer the optimal</span> <span data-start="979.43" data-end="981.08">representation of the backing store I</span> <span data-start="981.08" data-end="983.12">locate that right away and the most</span> <span data-start="983.12" data-end="985.25">important thing we can share the backing</span> <span data-start="985.25" data-end="987.65">store between the Aries and those</span> <span data-start="987.65" data-end="989.06">backing store is now becoming a</span> <span data-start="989.06" data-end="990.92">copy-on-write backing store that's what</span> <span data-start="990.92" data-end="994.4">the cow should indicate that means we</span> <span data-start="994.4" data-end="995.93">can share the backing store as long as</span> <span data-start="995.93" data-end="997.82">you don't modify any anything that's</span> <span data-start="997.82" data-end="999.68">stored in it as soon as you start</span> <span data-start="999.68" data-end="1002.02">writing to one of those backing stores</span> <span data-start="1002.02" data-end="1004.81">it will be copied and modified so all</span> <span data-start="1004.81" data-end="1006.07">the other areas will still share the</span> <span data-start="1006.07" data-end="1010.3">backing store and this change should</span> <span data-start="1010.3" data-end="1012.88">give you a performance boost and the</span> <span data-start="1012.88" data-end="1015.76">memory boost awesome right you can have</span> <span data-start="1015.76" data-end="1021.88">but best of both worlds and again there</span> <span data-start="1021.88" data-end="1023.35">are a few easy things to follow here</span> <span data-start="1023.35" data-end="1026.47">which should allow you to avoid this</span> <span data-start="1026.47" data-end="1031.9">kind of trap the most obvious one is if</span> <span data-start="1031.9" data-end="1034.689">you use the Eric if you're able to use</span> <span data-start="1034.689" data-end="1037.03">area literals try to use array literals</span> <span data-start="1037.03" data-end="1038.5">they're really awesome we can generate</span> <span data-start="1038.5" data-end="1040.39">highly optimized code for it and we can</span> <span data-start="1040.39" data-end="1041.92">immediately come up with the optimal</span> <span data-start="1041.92" data-end="1044.73">representation in memory for it</span> <span data-start="1044.73" data-end="1046.78">pre-allocate small arrays to the correct</span> <span data-start="1046.78" data-end="1049.63">size so that basically means pass if you</span> <span data-start="1049.63" data-end="1051.37">know the size ahead of time pass it to</span> <span data-start="1051.37" data-end="1055.3">the constructor and most importantly try</span> <span data-start="1055.3" data-end="1058.66">to use arrays for to store only one kind</span> <span data-start="1058.66" data-end="1062.41">of element in it so especially try to</span> <span data-start="1062.41" data-end="1067.57">avoid mixing object values with double</span> <span data-start="1067.57" data-end="1073.51">or integer values okay the last thing is</span> <span data-start="1073.51" data-end="1079.24">about execution context so javascript is</span> <span data-start="1079.24" data-end="1080.87">a functional language</span> <span data-start="1080.87" data-end="1084.17">and what that means is that on one hand</span> <span data-start="1084.17" data-end="1088.04">you can have so one thing is functions</span> <span data-start="1088.04" data-end="1090.11">are first class object so that means you</span> <span data-start="1090.11" data-end="1094.64">can pass them around as in variables you</span> <span data-start="1094.64" data-end="1096.71">can have nested functions inside each</span> <span data-start="1096.71" data-end="1098.63">other and they have a proper lexical</span> <span data-start="1098.63" data-end="1100.55">scoping so that means the inner function</span> <span data-start="1100.55" data-end="1103.58">can reference any variable that's</span> <span data-start="1103.58" data-end="1106.4">declared in the outside function so what</span> <span data-start="1106.4" data-end="1109.25">does it mean in this example we have an</span> <span data-start="1109.25" data-end="1111.64">auto function may closure with two</span> <span data-start="1111.64" data-end="1114.23">variables in it large value small value</span> <span data-start="1114.23" data-end="1116.57">so obviously large value is going to be</span> <span data-start="1116.57" data-end="1119.78">the bumpy one we have two inner</span> <span data-start="1119.78" data-end="1122.36">functions in it and closure and both</span> <span data-start="1122.36" data-end="1125.2">reference some of the auto values and</span> <span data-start="1125.2" data-end="1129.02">then we call this function a closure</span> <span data-start="1129.02" data-end="1131.21">several times so what does this actually</span> <span data-start="1131.21" data-end="1136.49">mean since the inner functions reference</span> <span data-start="1136.49" data-end="1137.99">variables from the outer functions we</span> <span data-start="1137.99" data-end="1139.61">need to preserve that execution</span> <span data-start="1139.61" data-end="1141.92">environment in some way so it means it</span> <span data-start="1141.92" data-end="1144.98">needs to be stored in memory and the way</span> <span data-start="1144.98" data-end="1148.13">we do that is we have a context object</span> <span data-start="1148.13" data-end="1150.11">that's actually in heap object that's</span> <span data-start="1150.11" data-end="1152.75">allocated on the heap and we put the</span> <span data-start="1152.75" data-end="1156.59">values that are basically gonna survive</span> <span data-start="1156.59" data-end="1159.29">the execution of the outer function in</span> <span data-start="1159.29" data-end="1162.559">there so arguments can be context</span> <span data-start="1162.559" data-end="1165.17">allocated in this case the size argument</span> <span data-start="1165.17" data-end="1167.95">because it's used by a nested function</span> <span data-start="1167.95" data-end="1170.51">so should the nested function in it</span> <span data-start="1170.51" data-end="1173.21">escape that outer closure we need to</span> <span data-start="1173.21" data-end="1176.39">preserve that execution environment same</span> <span data-start="1176.39" data-end="1178.28">thing applies for variables they can</span> <span data-start="1178.28" data-end="1180.14">also be context allocated they are also</span> <span data-start="1180.14" data-end="1184.52">going to be put into that context and as</span> </p>
<p><span data-start="1184.52" data-end="1185.99">I said this context is going to be</span> <span data-start="1185.99" data-end="1187.76">referenced by the nested function so</span> <span data-start="1187.76" data-end="1190.37">this context is the execution context</span> <span data-start="1190.37" data-end="1192.02">the execution environment for those</span> <span data-start="1192.02" data-end="1194.059">nested functions so they are gonna keep</span> <span data-start="1194.059" data-end="1196.94">it alive until as long as they itself</span> <span data-start="1196.94" data-end="1202.94">survive so what does that mean if one of</span> <span data-start="1202.94" data-end="1204.47">those functions dies like the init</span> <span data-start="1204.47" data-end="1207.02">function it's gonna go away but the</span> <span data-start="1207.02" data-end="1209.179">context is still alive because it's</span> <span data-start="1209.179" data-end="1211.28">referenced by the closure function which</span> <span data-start="1211.28" data-end="1214.15">escaped the outer function and</span> <span data-start="1214.15" data-end="1217.3">large value can be some huge objects and</span> <span data-start="1217.3" data-end="1219.97">huge array which is basically the bloat</span> <span data-start="1219.97" data-end="1221.98">in your application and you want to get</span> <span data-start="1221.98" data-end="1227.55">rid of that so how would you fix that</span> <span data-start="1227.55" data-end="1230.5">easiest solution just get rid of that</span> <span data-start="1230.5" data-end="1234.48">large value context allocated variable</span> <span data-start="1234.48" data-end="1237.19">move it in today into the inner function</span> <span data-start="1237.19" data-end="1239.26">that's the easiest way thereby you got</span> <span data-start="1239.26" data-end="1241">rid of the context allocated variable</span> <span data-start="1241" data-end="1244.36">and the closure function will no longer</span> <span data-start="1244.36" data-end="1247.99">keep alive the bloat so again I wanted</span> <span data-start="1247.99" data-end="1251.64">to measure this and measuring this</span> <span data-start="1251.64" data-end="1254.23">giving a percentage here is just is just</span> <span data-start="1254.23" data-end="1256.51">pointless basically most of the</span> <span data-start="1256.51" data-end="1257.8">application developers will just</span> <span data-start="1257.8" data-end="1262.23">consider this to be a leak so</span> <span data-start="1262.23" data-end="1264.58">understanding this construct</span> <span data-start="1264.58" data-end="1267.52">understanding this way that we ate</span> <span data-start="1267.52" data-end="1270.01">context allocates variables and that</span> <span data-start="1270.01" data-end="1273.15">functions can keep alive whole contexts</span> <span data-start="1273.15" data-end="1276.55">might allow you to fix severe memory</span> <span data-start="1276.55" data-end="1283.27">memory leaks in your application so here</span> <span data-start="1283.27" data-end="1288.01">are again the basic best practices the</span> <span data-start="1288.01" data-end="1290.08">first and most important thing is you</span> <span data-start="1290.08" data-end="1292.57">should be aware of context allocated</span> <span data-start="1292.57" data-end="1294.25">variables so you should be aware that</span> <span data-start="1294.25" data-end="1300.88">these things exist and ensure that what</span> <span data-start="1300.88" data-end="1302.56">closures so basically closures that you</span> <span data-start="1302.56" data-end="1305.35">generate often have us have a small</span> <span data-start="1305.35" data-end="1309.34">outer context and move variables as deep</span> <span data-start="1309.34" data-end="1311.2">as possible into the nested functions</span> <span data-start="1311.2" data-end="1319.03">thereby about avoiding those leaks so we</span> <span data-start="1319.03" data-end="1323.19">just got rid of all the bloat and</span> <span data-start="1323.19" data-end="1326.62">hopefully this allows you to to write</span> <span data-start="1326.62" data-end="1330.61">applications that that that don't</span> <span data-start="1330.61" data-end="1331.96">introduce memory bloat that are</span> <span data-start="1331.96" data-end="1337.03">performant after all and hopefully this</span> <span data-start="1337.03" data-end="1338.62">might also apply to other virtual</span> <span data-start="1338.62" data-end="1343.45">machines because so although all the</span> <span data-start="1343.45" data-end="1345.01">examples I gave are highly highly</span> <span data-start="1345.01" data-end="1347.33">targeted for for v8 so they</span> <span data-start="1347.33" data-end="1349.61">they discussed how how v8 represents</span> <span data-start="1349.61" data-end="1353.21">these objects in memory but I guess the</span> <span data-start="1353.21" data-end="1356.99">same same optimizations could be applied</span> <span data-start="1356.99" data-end="1359.42">in other VMs I cannot judge that but it</span> <span data-start="1359.42" data-end="1361.43">should allow you to drive all of your</span> <span data-start="1361.43" data-end="1363.98">engines safely and have a free highway</span> <span data-start="1363.98" data-end="1369.23">like this so with that I want to thank</span> <span data-start="1369.23" data-end="1382.1">you very much for listening in so I hope</span> </p>
<p><span data-start="1382.1" data-end="1383.63">I could convey some of the basic</span> <span data-start="1383.63" data-end="1388.12">concepts how v8 come comes up with</span> <span data-start="1388.12" data-end="1390.2">representations of objects in memory and</span> <span data-start="1390.2" data-end="1392.66">how to avoid some booby traps that are</span> <span data-start="1392.66" data-end="1394.97">hidden in there not intentionally if you</span> <span data-start="1394.97" data-end="1397.31">want to know more ever ask me now</span> <span data-start="1397.31" data-end="1398.93">because we have yeah actually we have</span> <span data-start="1398.93" data-end="1402.53">lots of time and you can also find me in</span> <span data-start="1402.53" data-end="1403.88">the break during the breaks at the</span> </p>
<p><span data-start="1403.88" data-end="1407.69">Google booth or contact me directly so</span> <span data-start="1407.69" data-end="1413.63">if you have questions shoot I've got a</span> <span data-start="1413.63" data-end="1415.25">question about hidden classes</span> <span data-start="1415.25" data-end="1419.68">you said you prefer if people would</span> <span data-start="1419.68" data-end="1421.61">create instance variables in</span> <span data-start="1421.61" data-end="1424.73">constructors yes that said also work if</span> <span data-start="1424.73" data-end="1426.5">you do something like object of</span> <span data-start="1426.5" data-end="1429.26">prototype dot variable name equals</span> <span data-start="1429.26" data-end="1436.01">something or other so if you if you</span> <span data-start="1436.01" data-end="1438.92">store an and property on the prototype</span> <span data-start="1438.92" data-end="1440.42">of an object that means it's actually</span> <span data-start="1440.42" data-end="1442.94">gonna be stored in a different object</span> <span data-start="1442.94" data-end="1446.87">that's referenced through the done the</span> <span data-start="1446.87" data-end="1451.24">proto field as I learned yesterday and</span> <span data-start="1451.24" data-end="1454.04">so whenever we access that property we</span> <span data-start="1454.04" data-end="1456.35">have to follow that down the property</span> <span data-start="1456.35" data-end="1458.54">field and then access that object but</span> <span data-start="1458.54" data-end="1460.97">the representation of that object same</span> <span data-start="1460.97" data-end="1462.83">rules apply there so how you come up</span> <span data-start="1462.83" data-end="1466.7">with that representation is again</span> <span data-start="1466.7" data-end="1472.49">follows the same rules so probably it</span> <span data-start="1472.49" data-end="1474.2">the prototype object that you use for</span> <span data-start="1474.2" data-end="1476.6">this object is gonna be shared among a</span> <span data-start="1476.6" data-end="1479.58">different among several objects so</span> <span data-start="1479.58" data-end="1481.89">most of the time the prototype objects</span> <span data-start="1481.89" data-end="1484.11">aren't hot in a sense that they that</span> <span data-start="1484.11" data-end="1485.82">several of them exists on the heap</span> <span data-start="1485.82" data-end="1487.83">they are just hot because they are used</span> <span data-start="1487.83" data-end="1491.96">often so they should have a performant</span> <span data-start="1491.96" data-end="1493.68">implementation performant memory</span> <span data-start="1493.68" data-end="1496.32">representation but if you waste some</span> <span data-start="1496.32" data-end="1498.42">space in there it's probably not that</span> <span data-start="1498.42" data-end="1507.59">important</span> </p>
<p><span data-start="1507.6" data-end="1510.39">Thanks so I was I want a one at the</span> <span data-start="1510.39" data-end="1512.1">example where you had two different</span> <span data-start="1512.1" data-end="1514.16">representations so at this point he and</span> <span data-start="1514.16" data-end="1516.93">usually if this object is hot it's it's</span> <span data-start="1516.93" data-end="1519.45">used very often and yeah and yet it's</span> <span data-start="1519.45" data-end="1521.64">much much faster if it's monomorphic so</span> <span data-start="1521.64" data-end="1523.41">my general advice would be to say only</span> <span data-start="1523.41" data-end="1526.86">have one car that has three fields and</span> <span data-start="1526.86" data-end="1529.14">if you don't use this deep field just</span> <span data-start="1529.14" data-end="1531.27">but  and you will be just fast</span> <span data-start="1531.27" data-end="1537.18">and I mean it's 32 bits okay yes you</span> <span data-start="1537.18" data-end="1538.59">obviously understand the problem at hand</span> </p>
<p><span data-start="1538.59" data-end="1541.35">I hope I could teach that underlying</span> <span data-start="1541.35" data-end="1543.18">general underlying problem to more</span> <span data-start="1543.18" data-end="1545.16">people but knowing about this trade of</span> <span data-start="1545.16" data-end="1547.86">either waste space or have a monomorphic</span> <span data-start="1547.86" data-end="1552.53">object brings you forward and a huge</span> <span data-start="1552.53" data-end="1562.12">second question was functions function</span> <span data-start="1562.13" data-end="1564.15">you have to run through the whole</span> <span data-start="1564.15" data-end="1567.12">function to to see what where those are</span> <span data-start="1567.12" data-end="1569.22">captured or in the nested function yeah</span> <span data-start="1569.22" data-end="1571.71">why not also see if the init function</span> <span data-start="1571.71" data-end="1574.23">itself is actually captured itself or</span> <span data-start="1574.23" data-end="1575.88">leaves the scope so in this case it's</span> <span data-start="1575.88" data-end="1578.34">called from within the constructor so</span> <span data-start="1578.34" data-end="1579.75">you know it's not going to capture any</span> <span data-start="1579.75" data-end="1584.52">variable yeah so you could just say okay</span> </p>
<p><span data-start="1584.52" data-end="1587.25">I see you drive I look at all the code</span> <span data-start="1587.25" data-end="1589.44">and see it but it requires escape</span> <span data-start="1589.44" data-end="1591.21">analysis because you need to find out</span> <span data-start="1591.21" data-end="1592.65">whether that function escapes are not</span> <span data-start="1592.65" data-end="1593.82">well but you're really looking if</span> <span data-start="1593.82" data-end="1596.91">something is kind of I mean you have to</span> <span data-start="1596.91" data-end="1598.59">see if large values inside the init</span> <span data-start="1598.59" data-end="1600.45">function so you just keep tracking the</span> <span data-start="1600.45" data-end="1602.22">unit to so it doesn't seem that</span> <span data-start="1602.22" data-end="1605.01">difficult you just I mean if it if n it</span> <span data-start="1605.01" data-end="1606.75">is used in a non calling function</span> <span data-start="1606.75" data-end="1610.26">context okay then just say we need to</span> <span data-start="1610.26" data-end="1611.88">capture everything in there but that</span> <span data-start="1611.88" data-end="1613.23">doesn't look that difficult it's not</span> <span data-start="1613.23" data-end="1616.88">really a difficult analysis no it's not</span> <span data-start="1616.88" data-end="1619.32">maybe it's not a difficult analysis but</span> <span data-start="1619.32" data-end="1621.21">the problem is you need some optimizing</span> <span data-start="1621.21" data-end="1623.64">compiler for that and layout of the</span> <span data-start="1623.64" data-end="1627.15">context you need to get them right the</span> <span data-start="1627.15" data-end="1630.02">first time so when you have when you</span> <span data-start="1630.02" data-end="1632.87">didn't optimize the function yet or</span> <span data-start="1632.87" data-end="1636.72">otherwise transition that context layout</span> <span data-start="1636.72" data-end="1638.85">somehow if you optimize a function</span> <span data-start="1638.85" data-end="1640.05">because you already created some</span> <span data-start="1640.05" data-end="1641.34">instances of the</span> <span data-start="1641.34" data-end="1643.71">function object they escaped into your</span> <span data-start="1643.71" data-end="1645.39">hip they're floating around and now you</span> <span data-start="1645.39" data-end="1648.75">decide to optimize this whole mess this</span> <span data-start="1648.75" data-end="1650.4">whole make closure thing and you come up</span> <span data-start="1650.4" data-end="1652.94">with more with a better representation</span> <span data-start="1652.94" data-end="1655.41">but there is already the bad</span> <span data-start="1655.41" data-end="1659.27">representation out there so if we could</span> <span data-start="1659.27" data-end="1662.91">if we crank shift everything then we</span> <span data-start="1662.91" data-end="1664.65">would be smarter about that but then</span> <span data-start="1664.65" data-end="1667.32">start a performant would suck so again</span> <span data-start="1667.32" data-end="1669.81">classic trade-off</span> <span data-start="1669.81" data-end="1671.91">one more quite detailed question you</span> <span data-start="1671.91" data-end="1673.35">were talking about allocating and</span> <span data-start="1673.35" data-end="1674.37">assigning all the properties and</span> <span data-start="1674.37" data-end="1676.4">constructors so that you can presumably</span> <span data-start="1676.4" data-end="1678.99">allocate the precise amount of space and</span> <span data-start="1678.99" data-end="1681.15">the object itself how accurate can you</span> <span data-start="1681.15" data-end="1682.98">be in that can you can you really</span> <span data-start="1682.98" data-end="1684.99">determine precisely how much to allocate</span> <span data-start="1684.99" data-end="1687.51">or will you ever have to spill to so</span> <span data-start="1687.51" data-end="1692.67">it's not right the perfect scenario</span> <span data-start="1692.67" data-end="1695.49">forum from a VM implementer point of</span> <span data-start="1695.49" data-end="1697.86">view is if you just have simple this</span> <span data-start="1697.86" data-end="1699.57">assignments in the constructor so if you</span> <span data-start="1699.57" data-end="1701.7">construct it looks like this is this is</span> <span data-start="1701.7" data-end="1703.44">this is we just look at that code see</span> <span data-start="1703.44" data-end="1705.66">during parse time so now optimizing</span> <span data-start="1705.66" data-end="1708.3">compiler we see the layout there in the</span> <span data-start="1708.3" data-end="1710.46">code and just boom come up with the</span> <span data-start="1710.46" data-end="1713.13">optimal representation and when the in</span> <span data-start="1713.13" data-end="1715.02">line when when we optimize the function</span> <span data-start="1715.02" data-end="1717.21">boom in line that know how it looks like</span> <span data-start="1717.21" data-end="1719.61">so that's the optimal way but that takes</span> <span data-start="1719.61" data-end="1721.89">away a lot of freedom from JavaScript</span> <span data-start="1721.89" data-end="1723.21">eval I was asking about the more</span> <span data-start="1723.21" data-end="1724.62">complicated case where you might have</span> <span data-start="1724.62" data-end="1726.99">some branching or whatever which you</span> <span data-start="1726.99" data-end="1731.49">know yeah the one solution we we use is</span> <span data-start="1731.49" data-end="1733.35">this objects like tracking so we overall</span> <span data-start="1733.35" data-end="1735.51">allocate all the time like this and</span> <span data-start="1735.51" data-end="1739.2">after we have observed fixed amount of</span> <span data-start="1739.2" data-end="1741.8">allocations we shrink the objects and</span> <span data-start="1741.8" data-end="1745.46">heal their size if you want so that</span> <span data-start="1745.46" data-end="1748.2">gives us the most flexibility even if</span> <span data-start="1748.2" data-end="1753.03">you have non simple constructors okay I</span> </p>
</section>