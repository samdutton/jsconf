<section>
<p><span data-start="23.67" data-end="28.38">Hey, everyone, I had to set everything up for just a moment, and you know mac os and</span> <span data-start="28.38" data-end="35.34">Apple software. So hey I'm Christoph I work at Facebook as front-end engineer</span> <span data-start="35.34" data-end="41.46">in JavaScript infrastructure team. I'm going to tell you how evolved our front end source</span> <span data-start="41.46" data-end="48.62">space. And I'll teach you how to do large scale tool assisted co‑changes to your JavaScript</span> <span data-start="48.62" data-end="56.05">code effectively. And the word that we use for this at Facebook is codemod,code modification,we</span> <span data-start="56.05" data-end="63.559">kind of invented it, that's just what question call it. And at Facebook sometimes we use</span> <span data-start="63.559" data-end="68.09">it inter change establish sometimes it'smanual change, sometimes it's an automatic change,</span> <span data-start="68.09" data-end="73.83">it always refers to large scale changes to a big portion of our code base (Manual) at</span> </p>
<p><span data-start="73.83" data-end="78.56">Facebook we have tens of thousands of judgment modules and we need to make sure that the</span> <span data-start="78.56" data-end="84.09">health of our code base is very good and we have a good handle on that, what's more is</span> <span data-start="84.09" data-end="91.52">that we want to enable every engineer at Facebook to move fast, even with breaking changes.</span> <span data-start="91.52" data-end="97.03">We often add new shiny abstractions, new language features because it's always easy to add something</span> <span data-start="97.03" data-end="103.659">new, we tell people, use that, use Latin\h‑‑ not var anymore, we never go back and tell</span> <span data-start="103.659" data-end="109.109">people, hey, we need to clean this up, can you deprecate your code and remove it. It's</span> <span data-start="109.109" data-end="113.899">always really hard to get rid of deprecated code, especially if you have thousands of</span> <span data-start="113.899" data-end="119.84">callers around your code base (Deprecated) browsers also new capabilities, frameworks</span> <span data-start="119.84" data-end="128.119">gain new features as well. We need to somehow handle this. Everything just becomes more</span> <span data-start="128.119" data-end="133.12">complex. The problem is that even though we add all those new features, the health of</span> <span data-start="133.12" data-end="138.97">our code base more and more declines because we have multiple ways of doing the same thing.</span> </p>
<p><span data-start="138.97" data-end="143.51">We also want to encourage people to always just write code using the new patterns, but,</span> <span data-start="143.51" data-end="147.64">especially if you're new at a company or new at a code base and you just started looking</span> <span data-start="147.64" data-end="151.92">at it and you true to figure out how something is done you usually look at how other people</span> <span data-start="151.92" data-end="157.099">around you did the same thing, then you discovered all the code, you tonight know if it's deprecated</span> <span data-start="157.099" data-end="162.319">or not, you use the code around you and you write it like it was the latest and greatest</span> <span data-start="162.319" data-end="167.26">thing, like more and more deprecated code even though you shouldn't be using the patterns</span> <span data-start="167.26" data-end="173.739">anymore. We often have hundreds of thousands of calls of something, we have a web UI that</span> <span data-start="173.739" data-end="179.23">allows you to search quickly across all the code. I had to make a change and I was looking</span> <span data-start="179.23" data-end="185.569">at how many lines of code and how many invalid patterns are we using there that we have to</span> <span data-start="185.569" data-end="189.62">update, and in this case there were almost a hundred thousand results and then it tells</span> <span data-start="189.62" data-end="196.15">you, oh, I cannot display this to you because it would crash your browser. So going through</span> <span data-start="196.15" data-end="202.65">every call set manually is not a solution. It's not even an option for us in some cases.</span> </p>
<p><span data-start="202.65" data-end="211.209">This is a codemod they ran on our code base, we have a tool called codemod, it's very simple,</span> <span data-start="211.209" data-end="217.829">it's an internal tool, I have this string and I want to replace it with this other thing.</span> <span data-start="217.829" data-end="221.799">This has served us really well to evolve our code base over time, it's really good when</span> <span data-start="221.799" data-end="230.719">you do a simple rename, you rename JSCONUS and up load to the web site and you're done.</span> <span data-start="230.719" data-end="234.61">But we're way beyond simple renames and also the syntax for JavaScript becomes more and</span> <span data-start="234.61" data-end="240.569">more complex and also ambiguous, so we can't really use regx anymore so this is something</span> <span data-start="240.569" data-end="247.269">I actually ran at our UI class at Facebook. It has been around for a long time, but we</span> <span data-start="247.269" data-end="255.879">use an early class of ES 1 , ECMI script it was just final iced now called ES2015. Hopefully</span> <span data-start="255.879" data-end="265.39">it's 2015, if I say ES6, I'll buy you a beer later. So I haven't done regX code much in</span> <span data-start="265.39" data-end="270.47">a long time, I figured I can do this with a renaleX the problem I tried to solve was</span> <span data-start="270.47" data-end="275.64">add a new call to create an instance of the URI class instead of calling as a function,</span> <span data-start="275.64" data-end="281.22">we had a pattern for the same path, we had a code to allow tin stance of this class,</span> <span data-start="281.22" data-end="287.58">with new and without new. figured, okay, I can do this with a regX. So I wrote one regX</span> <span data-start="287.58" data-end="291.77">didn't catch all the cases, wrote another, didn't catch all the cases either, wrote a</span> <span data-start="291.77" data-end="296.47">few more, then at some point I was in a mess for some reason everything was broken because</span> <span data-start="296.47" data-end="302.19">one of my regX wasn't very good,I probably had a star, or a dot or something, I was just</span> <span data-start="302.19" data-end="307.41">really frustrated, then I rewrote this using an EST base codemod and it was don't in two</span> <span data-start="307.41" data-end="313.83">minutes and basically two lains of code. I mention ASTs, codemods that operate on the</span> </p>
<p><span data-start="313.83" data-end="320.25">AST, abstract syntax representation of JavaScript instead of source text representation. They</span> <span data-start="320.25" data-end="325.04">can really help us make a difference. If you build a strong codemod for an API change you're</span> <span data-start="325.04" data-end="329.27">making you can rework and apply it every time you make a change to the code that you're</span> <span data-start="329.27" data-end="335.75">trying to build. And what about rebasing? When you manually update your code on a long‑lived</span> <span data-start="335.75" data-end="341.07">branch when working on a new feature, you have to redo changes potentially every time</span> <span data-start="341.07" data-end="346.92">when you pull from master or something like that. With AST codemods I can rerun them before</span> <span data-start="346.92" data-end="353.35">I push my change, done. But, I also want to talk about the frustration around the deaspiration</span> <span data-start="353.35" data-end="359.66">that one often feels when they're thinking of making or braking API change. Good codemods</span> <span data-start="359.66" data-end="365.53">are really hard. And I'm sure, everyone of you, at least once, decided not to run a codemod</span> <span data-start="365.53" data-end="370.16">because it seemed too difficult and they just kept the old API around, didn't make a breaking</span> <span data-start="370.16" data-end="375.87">change, it just wasn't, you didn't have the right tooling for that. However, quite often,</span> <span data-start="375.87" data-end="381.13">there's simply no other way around codemods. We can't just rewriting write our entire code</span> <span data-start="381.13" data-end="390.66">base because we have a couple of bad abstractions. We must find ways to evolve our code base</span> <span data-start="390.66" data-end="397.24">incrementally or well change complex systems incrementally. With a clearly envisioned end</span> <span data-start="397.24" data-end="402.91">state in mind. At Facebook we hack everything and I put up these posters around the product</span> <span data-start="402.91" data-end="407.61">infrastructure team and someone guestening this and made their own version of it. I actually</span> <span data-start="407.61" data-end="414.47">like this better than the original title. But we also need to be confident when we make</span> <span data-start="414.47" data-end="420.36">these large changes to the code base. There's no point in running a codemod if it disrupts</span> <span data-start="420.36" data-end="425.41">every single engineer at your whole company. The whole point of this is not to break anything</span> <span data-start="425.41" data-end="430.38">and tone able every engineer to move faster. And codemod tools help us do this. And the</span> <span data-start="430.38" data-end="437.13">tool that we build at Facebook is called JS code shift it was built by Felix Kling, he</span> <span data-start="437.13" data-end="442.11">built it more than a year ago then he kept it secret for a really long time. He was sitting</span> <span data-start="442.11" data-end="447.11">next to me at the time at Facebook and we casually talked about this new API that I</span> <span data-start="447.11" data-end="451.4">wanted to build and I had this idea of what I wanted to build and I just didn't know how</span> <span data-start="451.4" data-end="456.66">to get there. It was impossible to do. And then he was like, oh, yeah, so I built this</span> <span data-start="456.66" data-end="461.6">tool, it's probably not very good, and I was look, okay, let's take a look at this. I looked</span> <span data-start="461.6" data-end="467.32">at it, I was like holy shit this is amazing, we have to Open Source this and we the. This</span> <span data-start="467.32" data-end="474.3">is really good. Let's dive into how I got started with this kind of codemod work. It's</span> <span data-start="474.3" data-end="479.41">exciting to be able to talk about how we built a relay framework. I know if you heard about</span> <span data-start="479.41" data-end="486.28">prelate it's a data framework on top of fame work. This year at React JSCON we wanted to</span> <span data-start="486.28" data-end="501.09">build a new API, wanted to move away from create graph QL.mix in to relay.create container.</span> </p>
<p><span data-start="501.09" data-end="506.31">So in relay we used to have this mix‑in, but used internal React APIs we couldn't shift</span> <span data-start="506.31" data-end="512.51">to Open Source API, it broke all the time because we act changed all the time as well.</span> <span data-start="512.51" data-end="516.14">And we also couldn't\h‑‑ because we were using a mix‑in we weren't sueable to support</span> <span data-start="516.14" data-end="523.87">ES 2016 class components, it was also a way cleaner implementation. We really wanted to</span> <span data-start="523.87" data-end="530.87">move to this. But the problem is, this completely changed the full public API relay and admittedly</span> <span data-start="530.87" data-end="536.99">it's not a big public API, but it changed the entire API. At that point in time, herbally</span> <span data-start="536.99" data-end="542.41">this year, there were already hundreds of files using\h‑‑ written using relay, and</span> <span data-start="542.41" data-end="547.87">the product teams using product\h‑‑ was moving really fast. Building this enough API</span> <span data-start="547.87" data-end="553.529">took about a month to complete. I built a codemod and had to run it at least ten to</span> <span data-start="553.529" data-end="561.279">fifteen times to test different stages of the new API. If I had done this manually,</span> <span data-start="561.279" data-end="565.49">while we were building this new API for a month, I would have had to change those hundreds</span> <span data-start="565.49" data-end="570.519">of files manually every time when some product developer changed something and it would be</span> <span data-start="570.519" data-end="575.79">a huge mess. It's painful, just to get a better idea of here's the before and after. It doesn't</span> <span data-start="575.79" data-end="580.06">matter if you know relay or React, t matters that you have pattern matching capabilities</span> <span data-start="580.06" data-end="584.819">in your brain and just compare those those code pieces side by side the left side is</span> <span data-start="584.819" data-end="590.879">before the right side after. If you ever removed a mix in and made a higher order component</span> <span data-start="590.879" data-end="596.31">yourself you know what the challenges are involved here. But in this case, the original</span> <span data-start="596.31" data-end="600.97">example, I guess this laser pointer doesn't work that well here, we had a mix‑in up</span> <span data-start="600.97" data-end="606.06">there and statics the new version didn't have the mix‑in anymore, and then we had on‑line</span> <span data-start="606.06" data-end="610.829">fifteen the relay.create container that was thereabout before, and then also we moved</span> <span data-start="610.829" data-end="618.54">the stat ticks into the secondary argument, to the function call. And traditionally we</span> <span data-start="618.54" data-end="624.389">would solve this with regx, right. A lot you this doesn't seem that difficult, I can probably</span> <span data-start="624.389" data-end="628.93">do this with a renaleX, I could maybe do it, I wouldn't be confident and I'm sure it would</span> <span data-start="628.93" data-end="637.499">break badly. And here's why, I could probably bulled a reg X from the example before, look</span> <span data-start="637.499" data-end="641.999">at the variation of a similar module on the right, it's just a different developer built</span> <span data-start="641.999" data-end="647.949">a similar module with a different code convention. This had a second mix‑in so we can't remove</span> <span data-start="647.949" data-end="653.74">the whole mix‑in line, had different stat ticks and different in how it was exported.</span> </p>
<p><span data-start="653.74" data-end="657.579">But also for this change I had to add a new module that didn't exist before and remove</span> <span data-start="657.579" data-end="663.779">an old one from the require Blog. We have human code conventions as everyone does, I</span> <span data-start="663.779" data-end="667.93">had to enter the new requirement statement at the right alphabetical locations, this</span> <span data-start="667.93" data-end="673.769">is just a lot of work with regx. You know. This is what I wanted to show you what can</span> <span data-start="673.769" data-end="678.56">be different from one module to another module and quite often that night be two people working</span> <span data-start="678.56" data-end="683.949">on the same team, working on the same product, you know, and the whole point of this is to</span> <span data-start="683.949" data-end="688.72">output some code that looks like a human had written this. So, I need to figure out how</span> <span data-start="688.72" data-end="696.689">can I write a codemod that looks like I wrote this code. But there's more, what does this</span> <span data-start="696.689" data-end="703.589">piece of JavaScript mean? Does anyone know? Anyone seen this before? Everyone's quite.</span> <span data-start="703.589" data-end="708.67">So we don't actually know because it depends on what context this is used in. So this is</span> <span data-start="708.67" data-end="714.54">an entirely different piece of JavaScript. Anyone, anyone has an idea? Everyone's shaking</span> <span data-start="714.54" data-end="720.069">their head. So the first win, this is actually a block statement with a label called JavaScript</span> <span data-start="720.069" data-end="725.199">and the value that it maps to is a binary expression is awesome and concatenates that</span> <span data-start="725.199" data-end="730.279">together. But the second one, this is an object expression where the key is JavaScript, it</span> <span data-start="730.279" data-end="742.319">only has one property and the it's awesome I've talked about why\h‑‑ what is JS code</span> <span data-start="742.319" data-end="750.139">shift? What does it do for us, simple description is an ST toST codemod, we need to dig deeper</span> <span data-start="750.139" data-end="755.17">and figure out what tools are involved and what concepts do we need to understand. So</span> <span data-start="755.17" data-end="761.449">let's ask ourselves what do we actually want to do here? We want to take one piece of JavaScript</span> <span data-start="761.449" data-end="765.41">and output a different piece of JavaScript, and we're going to operate on the ST, so we</span> <span data-start="765.41" data-end="772.22">need to parse JavaScript source code into an ST then we need to find the nodes that</span> <span data-start="772.22" data-end="778.1">we want to replace, create new nodes that we want to insert, then update the EST at</span> <span data-start="778.1" data-end="783.079">the right location and then print it back into JavaScript source ideally with proper</span> <span data-start="783.079" data-end="788.62">formatting and it should look like a human wrote this. I want to point out that all we</span> <span data-start="788.62" data-end="793.899">do here is simple tree operations. As Front‑End developers you should all know what this is</span> <span data-start="793.899" data-end="799.899">doing, right? We're dealing with the DOM all the time we find, create and update nodes</span> <span data-start="799.899" data-end="806.11">it's same for ASTs, let's look at these step‑by‑step. First up parse, I talk about the abstract</span> <span data-start="806.11" data-end="814.35">syntax tree. I'm pretty sure most of you are look nope, sounds like stat tick analysis,</span> <span data-start="814.35" data-end="821.23">it doesn't matter if you know ASTs or don't, I'm going to show you what an AST looks like</span> <span data-start="821.23" data-end="826.569">and you can time me if you want to. There's a tool that we built at Facebook called AST</span> <span data-start="826.569" data-end="839.389">explorer. I'm go going to\h‑‑ (Explorer) cool, I'm at the demo. This is not very big,</span> <span data-start="839.389" data-end="844.73">this is better. All right, cool. So this the the AST explorer, you can follow along if</span> <span data-start="844.73" data-end="850.48">you have your laptop open. All it does is it gives you two panels, there's the code</span> <span data-start="850.48" data-end="856.22">you can write, and then the AST representation of the same code. AST tonight be scared, it's</span> <span data-start="856.22" data-end="862.949">just a simple JSON data structure, this tool helps visualize, in this sample code we have</span> <span data-start="862.949" data-end="868.35">two statements and one of them is a variable declaration and one of them is a function</span> <span data-start="868.35" data-end="874.8">declaration, it's not very exciting, it's just\h‑‑ it's initialized using an array</span> <span data-start="874.8" data-end="881.209">expression. It's called tips and that's an identifier. Let's look at some other code.</span> </p>
<p><span data-start="881.209" data-end="885.959">So, I showed you this example before, right. And you were shaking your head and you're</span> <span data-start="885.959" data-end="889.97">like what are you talking about, this doesn't make sense, this looks like an October. No,</span> <span data-start="889.97" data-end="894.92">actually this is a block statement. It has a label here, the label is called JavaScript,</span> <span data-start="894.92" data-end="901.61">and the body of the block statement is binary expression. So, now, let's wrap it in parens</span> <span data-start="901.61" data-end="908.49">and now suddenly this is an object expression, it has one property and then this property</span> <span data-start="908.49" data-end="913.639">has a key that's an identifier called name and then a value with a binary expression.</span> <span data-start="913.639" data-end="919.569">That is awesome expression. All right, cool. Remember what an object expression looks like,</span> <span data-start="919.569" data-end="924.559">I'll go over this in a moment, this is important. We also can do function calls, a little bit</span> <span data-start="924.559" data-end="930.98">of German here. In this case, this is also important, there's a call expression, thecal</span> <span data-start="930.98" data-end="938.119">Lee is called hallow, and the arguments is a string literal called JSConfEU. All right.</span> <span data-start="938.119" data-end="946.55">Let's do something quick, we can create a class JSConfEU has awesome food. Does it have</span> <span data-start="946.55" data-end="957.819">awesome food? Yes, hell yeah! This probably extends probably JSCONF, we can see this is</span> <span data-start="957.819" data-end="965.819">a class declaration, it's ID, it's name is JSConfEU, it has a super class it extends</span> <span data-start="965.819" data-end="971.949">and then here it has a class body and it has a method called has awesome food, and of course,</span> <span data-start="971.949" data-end="987.829">this somewhere returns true. So that's an AST. So next I want to talk about create.</span> <span data-start="987.829" data-end="993.579">We're going to skip over find, I hope you allow me to do this. I said before we're dealing</span> <span data-start="993.579" data-end="999.17">with a simple objected day the structure, we could build up an object and\h‑‑ A</span> </p>
<p><span data-start="999.17" data-end="1004.67">ST, you can do that but you tonight have type guarantees and probably end up in a mess because</span> <span data-start="1004.67" data-end="1009.639">you make a Typo nothing works anymore, but there's a project created by Ben jaw listic</span> <span data-start="1009.639" data-end="1017.91">anyone who used to work at Facebook, it has a the similar syntax to Babels creation system.</span> <span data-start="1017.91" data-end="1025.059">This is an API to define AST types and then it gives us a functional API to compose those</span> <span data-start="1025.059" data-end="1030.179">AST nodes, gives you type safety, tells you when you cannot create an AST node with what</span> <span data-start="1030.179" data-end="1037.66">the type you in the mind. You saw the object expression before, here on the left side we</span> <span data-start="1037.66" data-end="1043.429">define an object expression, basad on an expression built up using properties and the field properties</span> <span data-start="1043.429" data-end="1049.79">is an array of property and you can property right below that, property based on a node,</span> <span data-start="1049.79" data-end="1056.78">built up the kind the key and the value. The kind is iter init, or setter, usually init,</span> <span data-start="1056.78" data-end="1062.18">we're scared of getter and setters, and then there's\h‑‑ getters and setters, a key</span> <span data-start="1062.18" data-end="1071.83">(Getter) a field value that can be any expression, the value can be any expression it can also</span> <span data-start="1071.83" data-end="1077.11">be an objects expression because objects expression is based on an expression. On the right‑hand</span> <span data-start="1077.11" data-end="1083.33">side you can see how we build this up, basically we get a function called objects expression</span> <span data-start="1083.33" data-end="1088.46">we pass in the property, and if we were to print that code, it would print JavaScript</span> <span data-start="1088.46" data-end="1093.24">is awesome, over course depending ton context it would add parens, otherwise it would be</span> <span data-start="1093.24" data-end="1099.4">a label statement and we don't know what to do. There's more in JS code shift you can</span> <span data-start="1099.4" data-end="1106.83">type it out in a template literal and then reparse that JS code and then you can actually\h‑‑</span> <span data-start="1106.83" data-end="1113.41">using substitution to output proper AST nodes. And then, this is from an example that converts</span> <span data-start="1113.41" data-end="1118.76">four loops into a\h‑‑ loop. This is really cool. Going to skip over update, hope you</span> <span data-start="1118.76" data-end="1123.9">allow me to to that use. We talked about parse and create, let's talk about printing, this</span> <span data-start="1123.9" data-end="1130.24">is really hard. The project we're using for in is recast. It was created by Ben newman</span> <span data-start="1130.24" data-end="1138.21">also. it's really awesome, gives us one API, it's called recast drought print. What's the</span> <span data-start="1138.21" data-end="1148.48">point of 24?\h‑‑ what's the point of this\h‑‑ it\h‑‑ if you build a JS Compiler like</span> <span data-start="1148.48" data-end="1154.03">babble you don't care about the out put of your transformed code (Don't really care)</span> <span data-start="1154.03" data-end="1160.75">the only thing that see it is output is the browser, and we usually minute FYcode, if</span> <span data-start="1160.75" data-end="1165.42">you write a codemod you don't want to find yourself in a situation where the code you</span> <span data-start="1165.42" data-end="1169.9">printed that you didn't even touch looks completely different from before. If I do this, if I</span> <span data-start="1169.9" data-end="1175.23">run a codemod and I only change one tiny little thing here and output looks component model</span> <span data-start="1175.23" data-end="1179.28">plately different and I run it on tens of thousands of JavaScript modules every engineering</span> <span data-start="1179.28" data-end="1186.69">company is going to be annoyed by me. I don't want any engineer to know I'm even doing this.</span> <span data-start="1186.69" data-end="1195.21">(Don't) you can provide options on what the code style is, that you ear using in your</span> <span data-start="1195.21" data-end="1200.5">code, like indentation, what's even better, it doesn't try to reprint the code you didn't</span> <span data-start="1200.5" data-end="1207.99">touch that's important, you're only changing the things that you're actually changing.</span> </p>
<p><span data-start="1207.99" data-end="1214.52">And this is why we cannot just use Babel which is a Compiler to to this not yet any stay</span> <span data-start="1214.52" data-end="1224.73">tuned. We talked about creating ST nodes and hao we print the ST back into source code.</span> <span data-start="1224.73" data-end="1231.12">For find and update this is were JS code ties it together, provides a neat little package</span> <span data-start="1231.12" data-end="1237.28">for you to do these AST codemods, in the past we simply didn't have tool set enable us to</span> <span data-start="1237.28" data-end="1242.34">do this. We didn't have a standard for JSAST a couple of years ago, we needed all these</span> <span data-start="1242.34" data-end="1250.01">tools before that. So let's do a demo, everyone loves demos, we'll write a transform that</span> <span data-start="1250.01" data-end="1255.08">get rids of a hypothetical module called merge, this is a module that exist in the three different</span> <span data-start="1255.08" data-end="1261.77">variations at Facebook and then I killed them all at Facebook, they're not there anymore,</span> <span data-start="1261.77" data-end="1266.76">you can search the source code, it's not there, I promise. Took all the arguments you pass</span> <span data-start="1266.76" data-end="1272.33">into it create add new object and created all the passing properties into that new object</span> <span data-start="1272.33" data-end="1279.19">create add new object. Then we created a new syntax for React in the beginning we realized</span> <span data-start="1279.19" data-end="1284.3">this is also awesome for objects we can use the spread property, the three dots right</span> <span data-start="1284.3" data-end="1288.38">there that you see in the second lain to spread all the properties of an object into a new</span> <span data-start="1288.38" data-end="1294.02">object, this is really powerful syntax. This is not a standard yet, but we hope it will</span> <span data-start="1294.02" data-end="1300.82">be in ES 2016 or 2017. We're transforming what you see in the first line to what you</span> <span data-start="1300.82" data-end="1306.29">see in the second line, ironically because it's not a standard we're using Babel to transform</span> <span data-start="1306.29" data-end="1312.51">it into third lain for the browser. So this is actually really funny. But given those</span> <span data-start="1312.51" data-end="1317.69">merge calls that could be nested. And that could be nested merge calls and really deep</span> <span data-start="1317.69" data-end="1322.45">object structures you could have like whole function in the merge calls like we had a</span> <span data-start="1322.45" data-end="1328.01">module that pulled in another module and then merged new functions on to that module. This</span> <span data-start="1328.01" data-end="1334.62">is impossible to deal with in reg "X,"just cannot be done. And how do you form at the</span> <span data-start="1334.62" data-end="1338.61">output, right? If we tonight have recast we don't know how to format what we're doing</span> <span data-start="1338.61" data-end="1344.38">here. So, I ran this code it was no big deal, I got rid about a thousand caller of this</span> <span data-start="1344.38" data-end="1350.86">function and four thousand callers of the other two modules. No one noticed I had to</span> <span data-start="1350.86" data-end="1356.97">tell people afterwards. But it's gone and now everyone's using the same thing and hopefully</span> <span data-start="1356.97" data-end="1375.35">will become a JavaScript standard. We have a call expression here. It has three properties</span> <span data-start="1375.35" data-end="1383.84">(Gone) it has an identifier, I'm just going to show you what the output is going to look</span> <span data-start="1383.84" data-end="1391.78">like. We need to parens as I showed you before. It's going to be something like A, object</span> <span data-start="1391.78" data-end="1404.37">expressions be inlined. Two of them are spread properties and one of them is a spread property.</span> </p>
<p><span data-start="1404.37" data-end="1412.14">All right. So we built this AST explorer and we're look can we put JS code into this and</span> <span data-start="1412.14" data-end="1419.31">we did. Let me just so we got this live coding environment here, it's really cool. So the</span> <span data-start="1419.31" data-end="1426.71">JS code API is basically you create a file and it export asfunction that you can then</span> <span data-start="1426.71" data-end="1433.59">apply using a runner that runs in concurrently across your entire code base. It gives you</span> <span data-start="1433.59" data-end="1438.36">the file, the source of the file and the API of the code shift here on‑line five I'm</span> <span data-start="1438.36" data-end="1443.88">mapping it to J, J does everything for us, writing it quite often that's why it's a short</span> <span data-start="1443.88" data-end="1449.63">one character identifier, we just pass the thing into J and gives us this cool object,</span> <span data-start="1449.63" data-end="1456.58">it's magical you should read the documentation (It's magical) this is the standard transform,</span> <span data-start="1456.58" data-end="1462.59">we find all the identifiers and we update them. What we do is we just\h‑‑ reverse</span> <span data-start="1462.59" data-end="1467.76">the identifier. This is not a useful transform unless you wrote the code originally right</span> <span data-start="1467.76" data-end="1480.23">to left. Any way cool thing is we can live code here. If you're feeling German you cupper</span> <span data-start="1480.23" data-end="1484.98">case all of your code and it will still work, which is awesome. These not very useful for</span> <span data-start="1484.98" data-end="1492.86">us. So we realized up there we need to operate on call expressions, so this is a call expression.</span> </p>
<p><span data-start="1492.86" data-end="1499.62">And then it doesn't work. It's just the name is actually call.name,\h‑‑ calllee.name,</span> <span data-start="1499.62" data-end="1505.1">now there's only merge, we don't want that. So we want to replace it with an object expression,</span> <span data-start="1505.1" data-end="1510.56">that's what we saw before, and that we noticed that takes an array. All right, that's cool,</span> <span data-start="1510.56" data-end="1515.73">it doesn't really do a lot, but we replaced all the personal calls with object expression.</span> <span data-start="1515.73" data-end="1522.4">The problem is, this is not merge, and it's also replaced. We don't want that. So this</span> <span data-start="1522.4" data-end="1535.66">gives us the ability to actually do pattern matching here. All right, so now we're only</span> <span data-start="1535.66" data-end="1541.44">actually updating all the merge calls, and then here, what we can do is, we map over</span> <span data-start="1541.44" data-end="1549.84">all the arguments so we have DST note here. Then we have the arguments and then we return</span> <span data-start="1549.84" data-end="1559.54">a spread property with the argument. And boom, we're done. Let me just format this, whatever.</span> </p>
<p><span data-start="1559.54" data-end="1563.84">Okay, but this is not what we wanted, all right, we wanted to align the object, let's</span> <span data-start="1563.84" data-end="1569.15">look for the type here, object expression, and then return all the properties of this</span> <span data-start="1569.15" data-end="1573.88">argument. Instead, all right, this doesn't work, we actually need to use this really</span> <span data-start="1573.88" data-end="1581.96">awesome short version of ES2015 code with recursive flat implementation. And boom, now</span> <span data-start="1581.96" data-end="1586.47">you can see that we successfully replaced that personal module. So this is actually</span> <span data-start="1586.47" data-end="1601.63">just five lines of code. All right ( applause) and to me 24 was like learning a super power.</span> <span data-start="1601.63" data-end="1610.63">When you learn how how to do this you can write Babel plug‑ins,\h‑‑ so one more</span> <span data-start="1610.63" data-end="1616.04">thing, JavaScript now has a class creation mechanism that we're supporting in React,</span> <span data-start="1616.04" data-end="1622.78">I figured we can transform React.create class with a codemod, superintendent that fun? I</span> <span data-start="1622.78" data-end="1629.84">built a codemod can automatically do this, if you look at the example, inlines it into</span> <span data-start="1629.84" data-end="1634.62">the new con instructor, it removes this access and props because it's now local variable,</span> <span data-start="1634.62" data-end="1639.75">it does a lot of stuff. It also adds the prop types later on. But, I talked a little bit</span> <span data-start="1639.75" data-end="1644.63">about this, we the a demo, just like a tiny little sample code, that's not really fun,</span> <span data-start="1644.63" data-end="1653.38">you know. I found this project on get hundred that's did he recall UI for React. Now let's</span> <span data-start="1653.38" data-end="1657.93">run this thing. Takes a little while, can I wants over all the mix‑ins because we</span> <span data-start="1657.93" data-end="1661.16">don't have a good solution for that, but you can build your own codemods to get rid of</span> <span data-start="1661.16" data-end="1668.55">them if you use them a lot. Takes a little while. Tested it yesterday, I'm 200\hpercent</span> <span data-start="1668.55" data-end="1674.32">sure it works really well. Now we're done it used all the cores of my MacBook and transferred</span> <span data-start="1674.32" data-end="1696.97">all the files, yeah, looks about right. Nope .. can we send a pull request. Do I have</span> <span data-start="1696.97" data-end="1719.35">internet? I should probably push it. All right. Where is it had are? Button is not working,</span> <span data-start="1719.35" data-end="1744.06">all right, here it is. All right (Applause) there it is. This was fun (Laughing) that</span> <span data-start="1744.06" data-end="1750.95">was 845 files and probably 5‑10,000 lines of code. If anyone asks I didn't touch the</span> <span data-start="1750.95" data-end="1757.31">code, I just wrote the JavaScript that wrote the JavaScript, so my favorite editor is JavaScript.</span> </p>
<p><span data-start="1757.31" data-end="1763.16">But sometimes you cannot fix something automatically, not possible, we tonight have all the tools</span> <span data-start="1763.16" data-end="1768.85">yet. What I found at Facebook is that you can bribe really well with t‑shirts. So</span> <span data-start="1768.85" data-end="1775.66">at Facebook we have been using an early draft of ES2015 classes for two and half years.</span> <span data-start="1775.66" data-end="1780.78">It allowed every edge near at the company to move way faster that they could have using</span> <span data-start="1780.78" data-end="1787.2">ES 5 features. You have to consider that a lot of engineers at Facebook didn't grow up</span> <span data-start="1787.2" data-end="1792.64">with JavaScript in their heart like all of us here did. You know. The problem with our</span> <span data-start="1792.64" data-end="1800.16">implementation of classes was that we didn't require soup erto be called in a child class</span> <span data-start="1800.16" data-end="1805.72">something that's required in ES2015. We had about a thousand invalid callers, how did</span> </p>
<p><span data-start="1805.72" data-end="1813.61">I detect them I wrote a codemod script to detect the code. We were able to fix about600</span> <span data-start="1813.61" data-end="1817.61">of them automatically because they the president have interesting parent con instructors, four</span> <span data-start="1817.61" data-end="1822.46">hundred we had to fix manually. We do hack tons everyone at Facebook, promised everyone</span> <span data-start="1822.46" data-end="1835.38">a t‑shirts, we had 400 call sites per person. And we did it. Everyone got a T‑shirt, we</span> <span data-start="1835.38" data-end="1840.35">high fived each other, it was great. But the whole point of this is that I want to point</span> <span data-start="1840.35" data-end="1845.23">out that codemods are not\h‑‑ they're not going to solve all your problems but they're</span> <span data-start="1845.23" data-end="1853.8">really useful and assist you when you do manual clean ups. what's the impact on Open Source.</span> <span data-start="1853.8" data-end="1859.35">It's important how we approach Open Source at Facebook. We only Open Source what we use</span> <span data-start="1859.35" data-end="1866.1">in production and add scale. The React team they're responsible for deploying new versions</span> <span data-start="1866.1" data-end="1873.08">of React inturnly on ever respousetory, they're responsible for making sure that we move to</span> <span data-start="1873.08" data-end="1879.12">new APIs as fast as possible. And they're making sure that we move fast even with breaking</span> <span data-start="1879.12" data-end="1887.69">changes. But we always use master. If master is broken Facebook is broken. So this should</span> <span data-start="1887.69" data-end="1891.4">explain why we have invest in the this kind of code tooling, we have a lot of React code</span> <span data-start="1891.4" data-end="1896.14">. But the tooling is influenced how we approach</span> </p>
<p><span data-start="1896.14" data-end="1900.47">Open Source code, if you have looked at recent release notes of React native or React, you</span> <span data-start="1900.47" data-end="1906.32">see that we actually published codes mods for React and React DOM political up in 0.14</span> <span data-start="1906.32" data-end="1910.08">you can run a script if you have a large code base and it will be fixed auto3459ically for</span> <span data-start="1910.08" data-end="1916.57">you. 24 is great. When we make breaking changes and we can write you a script and up grayeds</span> <span data-start="1916.57" data-end="1924.03">your code automatically when you update your version of React, the whole community wins.</span> <span data-start="1924.03" data-end="1927.64">And people have been really happy with this. This person found this tool and in less than</span> <span data-start="1927.64" data-end="1932.53">two hours he safely transformed thousands of lines of code, this is outside of opinion,</span> <span data-start="1932.53" data-end="1939.23">it's really cool. What I found about this is that I recently rap a codemod on every</span> <span data-start="1939.23" data-end="1944.71">test file at Facebook. And a day later after I made the changes I wanted to figure out</span> <span data-start="1944.71" data-end="1950.46">how many lines of code did I change. It was 40,000 lines of code, I didn't notice that</span> <span data-start="1950.46" data-end="1956.51">when I was doing the change, no problems, all the tests are still running, everything's</span> <span data-start="1956.51" data-end="1965.46">great. One more tiny little thing, I'm sorry we're a little bit over. Then Abramov was</span> <span data-start="1965.46" data-end="1972.72">asking for an on‑line babble editor, I was like didn't I show you the same thing with</span> <span data-start="1972.72" data-end="1984.37">JS code shift. Do you want to see that really quick? All right, this only takes ten seconds,</span> </p>
<p><span data-start="1984.37" data-end="1991.06">I promise. So here we just go into Babel. And then what we're going to do is Translate</span> <span data-start="1991.06" data-end="1997.44">our Babel script to German, because that's fun. That's it. Thank you so much for listening.</span> <span data-start="1997.44" data-end="1997.94">(Applause) wow, that was awesome. Thank you so much. So we're just going to do a very</span> <span data-start="1997.94" data-end="1998.05">quick scene change here and bring up Thomas who's got probably the better GitHub user</span> <span data-start="1998.05" data-end="1998.17">names, it's Watson and he's\h‑‑ come on up, get set up, man. In the time honored tradition</span> <span data-start="1998.17" data-end="1998.3">of writing lots and lots NPM modules you can see Thomas has written such hits as bay 64</span> <span data-start="1998.3" data-end="1998.41">and coding things as Emoji. Enabling the T‑Cup protocol. On HTTP servers. While you guys</span> </p>
</section>