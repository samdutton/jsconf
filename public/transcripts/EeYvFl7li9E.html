<section>
<p><span data-start="7.73" data-end="13.25">I'm going to talk about node so briefly</span> <span data-start="13.25" data-end="17.57">so notice is a server-side j/s platform</span> <span data-start="17.57" data-end="23.13">it's built on Google's v8 it does it I</span> <span data-start="23.13" data-end="25.65">Oh in a very special way which I will</span> <span data-start="25.65" data-end="29.55">describe in great detail it uses the</span> <span data-start="29.55" data-end="34.28">common J's module system and it's</span> <span data-start="34.28" data-end="37.8">written in C which has confused a lot of</span> <span data-start="37.8" data-end="40.739">people so it's a rather large C project</span> <span data-start="40.739" data-end="47.909">actually so the thesis is that IO has to</span> <span data-start="47.909" data-end="52.35">be done differently we're doing it wrong</span> <span data-start="52.35" data-end="55.26">everything the way that we're thinking</span> <span data-start="55.26" data-end="60.659">about doing IO really makes things</span> <span data-start="60.659" data-end="64.019">difficult so writing servers and writing</span> <span data-start="64.019" data-end="67.56">any sort of application is difficult</span> <span data-start="67.56" data-end="70.11">because of how we're doing</span> <span data-start="70.11" data-end="75.509">io so a lot of web applications have</span> <span data-start="75.509" data-end="80.25">such line of code like you query a</span> <span data-start="80.25" data-end="82.53">database and then you return a result</span> <span data-start="82.53" data-end="87.27">and then you use the result and so the</span> <span data-start="87.27" data-end="89.64">question is what is your web framework</span> <span data-start="89.64" data-end="93.24">doing well that while this line of code</span> <span data-start="93.24" data-end="99.329">is running so in many cases you're not</span> <span data-start="99.329" data-end="101.1">doing anything at all you're just</span> <span data-start="101.1" data-end="103.85">sitting there while the database is</span> <span data-start="103.85" data-end="107.899">waiting to respond and that might be</span> <span data-start="107.899" data-end="115.49">that the database is in San Francisco or</span> <span data-start="115.49" data-end="119.719">it might be</span> <span data-start="119.729" data-end="126.969">thank you there's a lot of reasons okay</span> <span data-start="126.969" data-end="132.879">well the point is is that you can't just</span> <span data-start="132.879" data-end="136.93">wait for it to respond there's a big</span> <span data-start="136.93" data-end="139.989">difference between what happens inside</span> <span data-start="139.989" data-end="143.14">your CPU inside your memory and what</span> <span data-start="143.14" data-end="145.06">happens when you go to something outside</span> <span data-start="145.06" data-end="148.629">of that if you go to a disk or if you go</span> <span data-start="148.629" data-end="151.36">to a network if you have to do a TCP</span> <span data-start="151.36" data-end="153.13">connection to a different server even if</span> <span data-start="153.13" data-end="157.63">it's in your same hosting center then</span> <span data-start="157.63" data-end="160.06">you're talking about millions of clock</span> <span data-start="160.06" data-end="162.43">cycles instead of hundreds of clock</span> <span data-start="162.43" data-end="167.829">cycles or tens of clock cycles so you</span> <span data-start="167.829" data-end="170.799">can't do nothing so obviously better</span> <span data-start="170.799" data-end="174.01">software can do better than just wait</span> <span data-start="174.01" data-end="177.06">for the database to respond it can</span> <span data-start="177.06" data-end="180.129">multitask so you can have different</span> <span data-start="180.129" data-end="186.4">threads of execution running so the</span> <span data-start="186.4" data-end="188.2">question is is that the best that we can</span> <span data-start="188.2" data-end="192.43">do and I think you can look at two</span> <span data-start="192.43" data-end="195.67">popular web servers and see how they're</span> <span data-start="195.67" data-end="200.799">doing i/o and decide if what what</span> <span data-start="200.799" data-end="202.239">they're doing right and what they're</span> <span data-start="202.239" data-end="206.889">doing wrong so here's a benchmark which</span> <span data-start="206.889" data-end="213.819">is possibly not visible to you but it</span> <span data-start="213.819" data-end="216.91">shows concurrency on like the number of</span> <span data-start="216.91" data-end="218.829">concurrent clients on the web server on</span> <span data-start="218.829" data-end="221.65">the horizontal axis and on the vertical</span> <span data-start="221.65" data-end="225.01">axis it shows requests per second and so</span> <span data-start="225.01" data-end="229.15">this is engine X and Apache and what you</span> <span data-start="229.15" data-end="234.51">see is that the the engine X is is</span> <span data-start="234.51" data-end="238.209">responding faster not so much faster</span> <span data-start="238.209" data-end="240.88">twice as fast three times as fast</span> <span data-start="240.88" data-end="242.47">especially when you get to higher</span> <span data-start="242.47" data-end="247.57">concurrency who cares but the big</span> <span data-start="247.57" data-end="250.97">difference is when you look at</span> <span data-start="250.97" data-end="255.93">versus memory so again on the horizontal</span> <span data-start="255.93" data-end="259.229">axis is is the number of clients on your</span> <span data-start="259.229" data-end="262.32">server but now on the vertical axis you</span> <span data-start="262.32" data-end="282.08">have memory and</span> <span data-start="282.09" data-end="288.16">it looks great online okay so the point</span> <span data-start="288.16" data-end="291.19">is is that Apache uses tons of memory</span> <span data-start="291.19" data-end="293.32">when you start getting a lot of clients</span> <span data-start="293.32" data-end="296.47">if you have 3,000 people like connecting</span> <span data-start="296.47" data-end="299.47">to your Apache server you're using mini</span> <span data-start="299.47" data-end="301.72">megabytes of memory whereas in genexus</span> <span data-start="301.72" data-end="304.06">stays very stable it stays with a small</span> <span data-start="304.06" data-end="309.63">footprint and the question really is</span> <span data-start="309.63" data-end="312.55">what's the difference between these two</span> <span data-start="312.55" data-end="315.25">and the big difference is that Apache</span> <span data-start="315.25" data-end="318.15">uses threads for each connection and</span> <span data-start="318.15" data-end="326.229">nginx uses an event loop okay so to be a</span> <span data-start="326.229" data-end="330.03">slightly technical the first benchmark</span> <span data-start="330.03" data-end="332.949">kind of tells you that context switching</span> <span data-start="332.949" data-end="335.199">between the different threads which is</span> <span data-start="335.199" data-end="338.289">what Apache does is is not free it costs</span> <span data-start="338.289" data-end="344.08">some CPU time and the second one is that</span> <span data-start="344.08" data-end="348.58">each thread takes memory and that ends</span> <span data-start="348.58" data-end="352.75">up being a lot of memory and kind of in</span> <span data-start="352.75" data-end="358.02">the building tight little server thing</span> <span data-start="358.02" data-end="360.25">community if you want to make a little</span> <span data-start="360.25" data-end="362.289">engine X server or you want to make a</span> <span data-start="362.289" data-end="366.31">little IRC server everybody knows that</span> <span data-start="366.31" data-end="368.44">you can't use threats for connections</span> <span data-start="368.44" data-end="370.24">this is not the right way to do</span> <span data-start="370.24" data-end="372.55">concurrency the right way to do</span> <span data-start="372.55" data-end="374.47">concurrency is to have a single thread</span> <span data-start="374.47" data-end="377.919">and have an event loop so you do</span> <span data-start="377.919" data-end="380.5">something and then you're done with it</span> <span data-start="380.5" data-end="381.789">and then you do something else and</span> <span data-start="381.789" data-end="384.19">you're done with it but that requires</span> <span data-start="384.19" data-end="387.88">though is that what you do never takes</span> <span data-start="387.88" data-end="389.949">very long you have to have non-blocking</span> <span data-start="389.949" data-end="398.979">i/o so apache uses OS threads there's</span> <span data-start="398.979" data-end="400.78">other threading systems you could have</span> <span data-start="400.78" data-end="403.57">green threads or you could have</span> <span data-start="403.57" data-end="405.78">co-routines</span> <span data-start="405.78" data-end="409.75">these can help the situation very much</span> <span data-start="409.75" data-end="413.169">but it's still machinery it's still</span> <span data-start="413.169" data-end="414.62">something that</span> <span data-start="414.62" data-end="419.69">needs to be done you have to you have to</span> <span data-start="419.69" data-end="422.66">do something to create the illusion that</span> <span data-start="422.66" data-end="427.669">when you connect to the database your</span> <span data-start="427.669" data-end="430.1">program halts you don't move on to the</span> <span data-start="430.1" data-end="433.01">next line until it comes back it's an</span> <span data-start="433.01" data-end="434.93">illusion your programs not halting it's</span> <span data-start="434.93" data-end="436.97">doing all these other things but it</span> <span data-start="436.97" data-end="442.13">looks like it's halted so I say that</span> <span data-start="442.13" data-end="443.81">threaded concurrency is a leaky</span> <span data-start="443.81" data-end="448.01">abstraction it's it creates pains you</span> <span data-start="448.01" data-end="452.24">have locking problems you can you have</span> <span data-start="452.24" data-end="454.31">these memory problems it's hard to think</span> <span data-start="454.31" data-end="457.729">about it's not a very good abstraction</span> <span data-start="457.729" data-end="459.11">for what's really happening on your</span> <span data-start="459.11" data-end="466.34">computer so code like this where you</span> <span data-start="466.34" data-end="471.229">call a function and it connects to some</span> <span data-start="471.229" data-end="473.12">server and returns something from that</span> <span data-start="473.12" data-end="477.71">server as if no time has passed and then</span> <span data-start="477.71" data-end="479.15">you're going to use the result beyond</span> <span data-start="479.15" data-end="483.02">that this somehow either requires</span> <span data-start="483.02" data-end="485.99">blocking the entire process or you're</span> <span data-start="485.99" data-end="487.46">going to have to have some sort of</span> <span data-start="487.46" data-end="488.479">threading system</span> <span data-start="488.479" data-end="491.36">maybe it's co-routines but it's probably</span> <span data-start="491.36" data-end="494.81">going to require multiple execution</span> <span data-start="494.81" data-end="499.099">stacks but you could have the code like</span> <span data-start="499.099" data-end="502.13">this where you make the query to the</span> <span data-start="502.13" data-end="504.949">database and instead of waiting for the</span> <span data-start="504.949" data-end="507.68">response inside that function you give</span> <span data-start="507.68" data-end="512.159">it a callback in one form or another</span> <span data-start="512.169" data-end="515.75">when this happens you can your execution</span> <span data-start="515.75" data-end="517.37">can run right through that statement</span> <span data-start="517.37" data-end="520.789">make that request and continue doing</span> <span data-start="520.789" data-end="523.55">other things when the request comes back</span> <span data-start="523.55" data-end="525.65">millions and millions of clock cycles</span> <span data-start="525.65" data-end="528.55">later you can execute the callback</span> <span data-start="528.55" data-end="531.08">there's no machinery involved in this</span> <span data-start="531.08" data-end="533.089">all you need is a pointer to that</span> <span data-start="533.089" data-end="539.779">callback so this is how we need to do i</span> <span data-start="539.779" data-end="543.41">oh if you want very fast high</span> <span data-start="543.41" data-end="546.05">concurrency servers you have to design</span> <span data-start="546.05" data-end="547.97">them like this</span> <span data-start="547.97" data-end="552.779">mm-hmm so okay you say yeah but</span> <span data-start="552.779" data-end="555.149">everybody's talking about threads you</span> <span data-start="555.149" data-end="557.399">know my boss says that Java threads are</span> <span data-start="557.399" data-end="559.62">super cool blah blah blah why isn't</span> <span data-start="559.62" data-end="562.17">everybody doing this why should you</span> <span data-start="562.17" data-end="566.1">believe me well there's there's two</span> <span data-start="566.1" data-end="569.43">reasons I think they can be summed up in</span> <span data-start="569.43" data-end="572.91">two reasons anyway and it would be</span> <span data-start="572.91" data-end="577.079">cultural infrastructure 'el so I think</span> <span data-start="577.079" data-end="579.42">that there's a cultural bias against</span> <span data-start="579.42" data-end="582.36">doing non-blocking i/o you know your</span> <span data-start="582.36" data-end="584.76">first program that you ever do io with</span> <span data-start="584.76" data-end="586.44">is something where you enter your name</span> <span data-start="586.44" data-end="589.529">and then you get the results somebody</span> <span data-start="589.529" data-end="592.079">types that in but you block on that</span> <span data-start="592.079" data-end="593.81">function you don't do anything else and</span> <span data-start="593.81" data-end="596.94">then you print out the name so we're</span> <span data-start="596.94" data-end="600.87">taught to like demand input and we kind</span> <span data-start="600.87" data-end="603.18">of treat it the same way on on sockets</span> <span data-start="603.18" data-end="606.209">so we connect to the database and all</span> <span data-start="606.209" data-end="608.04">right give me the give me the give me</span> <span data-start="608.04" data-end="613.62">the response so people see code like</span> <span data-start="613.62" data-end="616.44">this where instead of waiting you just</span> <span data-start="616.44" data-end="619.74">give a call back and they say I can't do</span> <span data-start="619.74" data-end="620.1">that</span> <span data-start="620.1" data-end="622.38">that's that spaghetti code that's too</span> <span data-start="622.38" data-end="625.89">complicated I think we should reconsider</span> <span data-start="625.89" data-end="628.23">this I don't think it is necessarily</span> <span data-start="628.23" data-end="631.529">more complicated maybe in the simplest</span> <span data-start="631.529" data-end="634.38">cases like this but when you start</span> <span data-start="634.38" data-end="638.13">writing an IRC server it becomes very</span> <span data-start="638.13" data-end="642.899">natural to write code like this and the</span> <span data-start="642.899" data-end="645.18">other reason would be the missing</span> <span data-start="645.18" data-end="648.269">infrastructure so remember if you're on</span> <span data-start="648.269" data-end="650.88">an event loop you can never block on i/o</span> <span data-start="650.88" data-end="652.8">you can never wait for the database to</span> <span data-start="652.8" data-end="654.72">respond because you're in a single</span> <span data-start="654.72" data-end="656.79">threat if you ever wait everything else</span> <span data-start="656.79" data-end="658.47">shuts down we're in a threaded</span> <span data-start="658.47" data-end="660.81">environment you can wait occasionally or</span> <span data-start="660.81" data-end="665.279">for very long periods of time so the</span> <span data-start="665.279" data-end="666.81">problem is is that we just don't have</span> <span data-start="666.81" data-end="669.149">like libraries available to us to do</span> <span data-start="669.149" data-end="674.25">this sort of non blocking i/o so just a</span> <span data-start="674.25" data-end="676.68">couple of examples like POSIX has an</span> <span data-start="676.68" data-end="679.74">asynchronous file IO specification but</span> <span data-start="679.74" data-end="680.91">it's really hard to</span> <span data-start="680.91" data-end="685.29">find such libraries man pages often</span> <span data-start="685.29" data-end="689.24">don't state if a functions going to</span> <span data-start="689.24" data-end="691.77">access the disk or not you just don't</span> <span data-start="691.77" data-end="696.96">know which is important closures and</span> <span data-start="696.96" data-end="699.45">anonymous functions you don't have in C</span> <span data-start="699.45" data-end="704.03">so that makes writing such evented code</span> <span data-start="704.03" data-end="709.98">difficult and things like live MySQL</span> <span data-start="709.98" data-end="711.84">client don't support asynchronous</span> <span data-start="711.84" data-end="714.15">queries I think they actually might do</span> <span data-start="714.15" data-end="715.5">asynchronous queries but not</span> <span data-start="715.5" data-end="718.8">asynchronous connections and Aengus</span> <span data-start="718.8" data-end="721.44">asynchronous DNS resolution is is really</span> <span data-start="721.44" data-end="731.82">difficult to find so there are certain</span> <span data-start="731.82" data-end="735.27">solutions you might have heard of event</span> <span data-start="735.27" data-end="738.63">machine or pythons twisted or if you</span> <span data-start="738.63" data-end="741.69">come from Perl any event these are</span> <span data-start="741.69" data-end="744.51">libraries that provide such an event</span> <span data-start="744.51" data-end="747.93">loop with non-blocking sockets and it is</span> <span data-start="747.93" data-end="750.45">fairly easy to use them to create</span> <span data-start="750.45" data-end="754.83">efficient servers but I think that users</span> <span data-start="754.83" data-end="759.38">are kind of confused as how to use this</span> <span data-start="759.38" data-end="761.91">if you're using Ruby there's all of</span> <span data-start="761.91" data-end="764.07">these libraries available you have a</span> <span data-start="764.07" data-end="765.69">vent machine in here and you want to</span> <span data-start="765.69" data-end="767.51">know how do I use these other ones and</span> <span data-start="767.51" data-end="769.92">usually the answer to that is you can't</span> <span data-start="769.92" data-end="773.4">because the MySQL library for Ruby</span> <span data-start="773.4" data-end="775.98">blocks on everything so you can't just</span> <span data-start="775.98" data-end="780.42">throw that into an event loop but people</span> <span data-start="780.42" data-end="782.7">don't know that and so users really</span> <span data-start="782.7" data-end="786.84">still require some knowledge of event</span> <span data-start="786.84" data-end="790.65">loops or non-blocking i/o which almost</span> <span data-start="790.65" data-end="794.43">nobody has and so it's doesn't abstract</span> <span data-start="794.43" data-end="799.41">the problem very well but yeah luckily</span> </p>
<p><span data-start="799.41" data-end="802.35">JavaScript was was designed in such a</span> <span data-start="802.35" data-end="805.35">way that that it was built for an event</span> <span data-start="805.35" data-end="807.96">though the browser side JavaScript that</span> <span data-start="807.96" data-end="810.39">you have is an event loop you create a</span> <span data-start="810.39" data-end="812.55">button somebody clicks it you get a</span> <span data-start="812.55" data-end="814.019">unclick callback</span> <span data-start="814.019" data-end="818.16">this is exactly what one needs to do</span> <span data-start="818.16" data-end="823.019">event the stuff so yeah it has anonymous</span> <span data-start="823.019" data-end="825.959">functions and closures when you're on</span> <span data-start="825.959" data-end="827.879">the browser you only get one call back</span> <span data-start="827.879" data-end="829.769">at a time you're not getting multiple</span> <span data-start="829.769" data-end="831.6">callbacks and you don't need to lock</span> <span data-start="831.6" data-end="835.589">variables and the i/o is just done</span> <span data-start="835.589" data-end="841.29">through those callbacks so I think</span> <span data-start="841.29" data-end="844.41">everybody in this room who is familiar</span> <span data-start="844.41" data-end="850.259">with Java JavaScript is already kind of</span> <span data-start="850.259" data-end="854.489">prepared for writing evented servers you</span> <span data-start="854.489" data-end="856.529">don't you you don't really need to know</span> <span data-start="856.529" data-end="861.119">that much more so right so that was a</span> <span data-start="861.119" data-end="867.569">long motivation so what I want to make</span> <span data-start="867.569" data-end="872.249">is a non-blocking</span> <span data-start="872.249" data-end="874.23">infrastructure so that you can make very</span> <span data-start="874.23" data-end="877.439">highly concurrent servers and you don't</span> <span data-start="877.439" data-end="879.089">need to know about it we're going to</span> <span data-start="879.089" data-end="881.73">abstract all of the difficult</span> <span data-start="881.73" data-end="883.709">non-blocking event loop you don't need</span> <span data-start="883.709" data-end="885.529">to know about that it's just going to be</span> <span data-start="885.529" data-end="895.709">callbacks so right so so let me just</span> <span data-start="895.709" data-end="897.6">give some design goals and then I'll</span> <span data-start="897.6" data-end="900.6">give some actual practical examples of</span> <span data-start="900.6" data-end="906.059">how to build a server so first of all no</span> <span data-start="906.059" data-end="909.6">function should perform i/o to receive</span> <span data-start="909.6" data-end="917.189">disk or network information from or from</span> <span data-start="917.189" data-end="919.11">another process you have to have some</span> <span data-start="919.11" data-end="920.699">sort of callback so you can never have</span> <span data-start="920.699" data-end="923.069">that sort of function that makes some</span> <span data-start="923.069" data-end="924.99">query that return something that's not</span> <span data-start="924.99" data-end="931.079">allowed it should be low-level so I want</span> <span data-start="931.079" data-end="933.299">everything to be able to stream in and</span> <span data-start="933.299" data-end="937.619">out you never should never force the</span> <span data-start="937.619" data-end="941.669">user to buffer data and if you're</span> <span data-start="941.669" data-end="944.189">familiar with like Ruby on Rails or</span> <span data-start="944.189" data-end="947.43">something a lot of places</span> <span data-start="947.43" data-end="949.77">you to buffer data in one way or another</span> </p>
<p><span data-start="949.77" data-end="952.95">I don't want to make those choices for</span> <span data-start="952.95" data-end="955.05">you it's low level people can build on</span> <span data-start="955.05" data-end="957.51">top of that so if they want to buffer</span> <span data-start="957.51" data-end="961.32">their data then they can do that but at</span> <span data-start="961.32" data-end="964.26">my level at the node level it should not</span> <span data-start="964.26" data-end="967.43">make any sort of decisions like that and</span> <span data-start="967.43" data-end="971.88">similarly I shouldn't remove any</span> <span data-start="971.88" data-end="974.49">functionality at the POSIX layer so for</span> <span data-start="974.49" data-end="977.029">example have close TCP connections</span> <span data-start="977.029" data-end="980.22">everybody's shrugging but there's good</span> <span data-start="980.22" data-end="982.79">stuff to be had that everybody ignores</span> <span data-start="982.79" data-end="988.38">um and so I should also have like some</span> <span data-start="988.38" data-end="990.27">built-in support you don't want to write</span> <span data-start="990.27" data-end="993.06">everything I want you to I want it to be</span> <span data-start="993.06" data-end="996.089">low level but I think TCP and DNS and</span> </p>
<p><span data-start="996.089" data-end="1000.05">HTTP are infrastructural protocols</span> <span data-start="1000.05" data-end="1001.91">they're very important and so there</span> <span data-start="1001.91" data-end="1004.16">should be very good support for them in</span> <span data-start="1004.16" data-end="1010.19">such a system and in particular with</span> <span data-start="1010.19" data-end="1014.69">with HTTP it should it's going to have</span> <span data-start="1014.69" data-end="1016.25">many features so we're going to have</span> <span data-start="1016.25" data-end="1018.65">chunked request chunked responses I'm</span> <span data-start="1018.65" data-end="1021.74">going to have keepalive and importantly</span> <span data-start="1021.74" data-end="1024.949">it should be you should be able to get a</span> <span data-start="1024.949" data-end="1028.16">request and respond to it at will so you</span> <span data-start="1028.16" data-end="1031.1">should be able to hang requests and this</span> <span data-start="1031.1" data-end="1033.4">is what you need for comet style</span> <span data-start="1033.4" data-end="1035.449">applications if you want to do a long</span> <span data-start="1035.449" data-end="1037.85">pole then you have to hang that request</span> <span data-start="1037.85" data-end="1040.1">and wait till you have something to tell</span> <span data-start="1040.1" data-end="1045.17">the user mm-hmm and finally the the API</span> <span data-start="1045.17" data-end="1049.34">needs to be familiar so if I'm going to</span> <span data-start="1049.34" data-end="1051.02">have a timer I'm going to call it set</span> <span data-start="1051.02" data-end="1053.09">timeout it's going to it should look</span> <span data-start="1053.09" data-end="1056.03">like browser JavaScript and where it's</span> <span data-start="1056.03" data-end="1058.13">not browser JavaScript where I'm talking</span> <span data-start="1058.13" data-end="1061.67">about POSIX stuff then it should use the</span> </p>
<p><span data-start="1061.67" data-end="1063.35">POSIX names that is I don't want to</span> <span data-start="1063.35" data-end="1066.679">reinvent what people are doing I just</span> <span data-start="1066.679" data-end="1068.929">kind of want to present an idealized</span> <span data-start="1068.929" data-end="1071.57">version of that and then finally it</span> <span data-start="1071.57" data-end="1074.03">should be platform independent at the</span> <span data-start="1074.03" data-end="1076.21">moment I don't compile on Windows but</span> <span data-start="1076.21" data-end="1081.6">there's no reason I can't and I hope to</span> <span data-start="1081.6" data-end="1088.23">okay so now now some actual examples so</span> <span data-start="1088.23" data-end="1090.91">note is you have to compile it so you</span> <span data-start="1090.91" data-end="1095.44">have to download it so there's no</span> <span data-start="1095.44" data-end="1097.42">binaries is what I want to say and you</span> <span data-start="1097.42" data-end="1099.28">there's no real dependencies other than</span> </p>
<p><span data-start="1099.28" data-end="1102.52">Python so it should be fairly easy to to</span> <span data-start="1102.52" data-end="1105.19">build it's not it's not very difficult</span> <span data-start="1105.19" data-end="1108.67">or at least it should not be okay so</span> <span data-start="1108.67" data-end="1111.64">here's here's your first example this</span> <span data-start="1111.64" data-end="1115.09">program is going to output hello after</span> <span data-start="1115.09" data-end="1122.11">having waited two seconds so first first</span> <span data-start="1122.11" data-end="1126.31">we require the SIS model which we need</span> <span data-start="1126.31" data-end="1129.01">to output some some data this is the</span> <span data-start="1129.01" data-end="1132.88">common j/s require uses the semantics</span> <span data-start="1132.88" data-end="1136.36">defined by command j s then we set a</span> <span data-start="1136.36" data-end="1140.13">timeout for 2,000 milliseconds mm-hmm</span> <span data-start="1140.13" data-end="1142.87">importantly the callback inside is not</span> <span data-start="1142.87" data-end="1145.84">done right now first we print hello</span> <span data-start="1145.84" data-end="1149.59">which comes after that two seconds later</span> <span data-start="1149.59" data-end="1155.95">world is printed out so node after the</span> <span data-start="1155.95" data-end="1159.16">world is printed out no two exits so</span> <span data-start="1159.16" data-end="1161.2">that's kind of important when there's</span> <span data-start="1161.2" data-end="1163.66">nothing else to do on the event loop if</span> <span data-start="1163.66" data-end="1166.18">there's no more timers than it exits</span> <span data-start="1166.18" data-end="1170.11">it's the end of the process okay so so</span> <span data-start="1170.11" data-end="1172.12">here's what you would do you would put</span> <span data-start="1172.12" data-end="1174.76">it into a file called hello world GS and</span> <span data-start="1174.76" data-end="1177.28">then run it with the node program and</span> <span data-start="1177.28" data-end="1179.71">you get hello to send kids later world</span> <span data-start="1179.71" data-end="1185.41">in the process exits okay mmm-hmm so now</span> <span data-start="1185.41" data-end="1187.21">we're going to change the hello world</span> <span data-start="1187.21" data-end="1191.83">program and what we'll do this time is</span> <span data-start="1191.83" data-end="1194.92">is we're going to go in a loop so we're</span> <span data-start="1194.92" data-end="1198.88">going to use the the set interval</span> <span data-start="1198.88" data-end="1201.52">function and we're going to loop forever</span> <span data-start="1201.52" data-end="1204.22">and print out a message and then what we</span> <span data-start="1204.22" data-end="1205.84">want when the user kills it when they</span> <span data-start="1205.84" data-end="1208.84">hit control-c that it prints out a</span> <span data-start="1208.84" data-end="1211.42">message and then exits and this is to</span> <span data-start="1211.42" data-end="1213.43">demonstrate the special</span> <span data-start="1213.43" data-end="1217.06">process object in node and the how you</span> <span data-start="1217.06" data-end="1219.85">set a signal handler the for the</span> <span data-start="1219.85" data-end="1223.78">interrupt signal the second okay so so</span> <span data-start="1223.78" data-end="1227.65">again we do the require we just need one</span> <span data-start="1227.65" data-end="1229.42">function so let's just pull it out into</span> <span data-start="1229.42" data-end="1232.6">a variable in the next three lines we</span> <span data-start="1232.6" data-end="1234.88">set up the interval which calls that</span> <span data-start="1234.88" data-end="1239.74">callback every 500 milliseconds right</span> <span data-start="1239.74" data-end="1241.87">and then the last couple lines we're</span> <span data-start="1241.87" data-end="1246.76">setting up a signal handler so you do</span> <span data-start="1246.76" data-end="1248.98">this by calling this add listener</span> <span data-start="1248.98" data-end="1252.19">function which is should be fairly</span> <span data-start="1252.19" data-end="1257.23">familiar if you're used to the Dom then</span> <span data-start="1257.23" data-end="1259.42">you put you you print out goodbye and</span> <span data-start="1259.42" data-end="1265.33">then you you exit the process so this</span> <span data-start="1265.33" data-end="1271.03">this process object emits events when it</span> <span data-start="1271.03" data-end="1273.58">receives a signal so it emits the sig</span> <span data-start="1273.58" data-end="1277.66">int event there it would be the same for</span> <span data-start="1277.66" data-end="1281.2">any other signal that that the process</span> <span data-start="1281.2" data-end="1286.72">might get so so this is like the dome</span> <span data-start="1286.72" data-end="1289.87">you just add a listener to catch what</span> <span data-start="1289.87" data-end="1293.08">the process is doing there's a couple of</span> <span data-start="1293.08" data-end="1295.39">other things on the process like the PID</span> <span data-start="1295.39" data-end="1297.76">the program arguments the environment</span> <span data-start="1297.76" data-end="1300.51">current working directory memory usage</span> <span data-start="1300.51" data-end="1304.72">useful things so the the way that</span> <span data-start="1304.72" data-end="1308.05">process emits these events is is pretty</span> <span data-start="1308.05" data-end="1312.19">typical for node so many objects emit</span> <span data-start="1312.19" data-end="1315.28">events it's kind of the the fundamental</span> <span data-start="1315.28" data-end="1320.26">paradigm in in in node so like for</span> <span data-start="1320.26" data-end="1322.3">example a TCP server would emit a</span> <span data-start="1322.3" data-end="1324.97">connection event every time somebody</span> <span data-start="1324.97" data-end="1328.15">connects and like if you have somebody's</span> <span data-start="1328.15" data-end="1332.2">doing an HTTP upload it would emit the</span> <span data-start="1332.2" data-end="1335.11">request object to admit a body event</span> <span data-start="1335.11" data-end="1336.97">each time you get a packet of that</span> <span data-start="1336.97" data-end="1339.13">upload so somebody's uploading a stream</span> <span data-start="1339.13" data-end="1342.16">a movie or so to your server and you get</span> <span data-start="1342.16" data-end="1346.18">body body body</span> <span data-start="1346.19" data-end="1350.21">so yeah all objects that emit events are</span> <span data-start="1350.21" data-end="1356.03">instances of the event in meter class mm</span> <span data-start="1356.03" data-end="1359.27">okay so so here's here's the first TCP</span> <span data-start="1359.27" data-end="1362">server example so we're going make a TCP</span> <span data-start="1362" data-end="1364.04">server it's going to listen on port 8000</span> <span data-start="1364.04" data-end="1366.35">and then when somebody connects we're</span> <span data-start="1366.35" data-end="1368.75">going to send the the peer a message</span> <span data-start="1368.75" data-end="1370.55">we're going to say hello and then we're</span> <span data-start="1370.55" data-end="1372.17">going close to the connection so a very</span> <span data-start="1372.17" data-end="1376.28">simple TCP server so we have to require</span> <span data-start="1376.28" data-end="1378.56">the TCP module that's what we do in the</span> <span data-start="1378.56" data-end="1380.78">first line and then we create a server</span> <span data-start="1380.78" data-end="1385.82">object s and we that's a TCP server and</span> <span data-start="1385.82" data-end="1387.86">then we add a listener for the</span> <span data-start="1387.86" data-end="1391.13">connection event and we get this object</span> </p>
<p><span data-start="1391.13" data-end="1393.68">C from from the connection event that's</span> <span data-start="1393.68" data-end="1398">that's our connection we send it hello</span> <span data-start="1398" data-end="1401.21">we close and then finally we have to</span> <span data-start="1401.21" data-end="1407.72">start it listening on port 8000 so if if</span> <span data-start="1407.72" data-end="1412.91">we tried that then we would start the we</span> <span data-start="1412.91" data-end="1414.71">would put that code in this server Jas</span> <span data-start="1414.71" data-end="1417.92">and you can tell that to localhost</span> <span data-start="1417.92" data-end="1420.86">at a port 8000 and you get hello and</span> <span data-start="1420.86" data-end="1423.05">then the the server closes the</span> <span data-start="1423.05" data-end="1432.5">connection okay so we can simplify this</span> <span data-start="1432.5" data-end="1434.24">a little bit so the the connection</span> <span data-start="1434.24" data-end="1435.56">listener does it you don't need to call</span> <span data-start="1435.56" data-end="1437.48">this add listener you can just pass it</span> <span data-start="1437.48" data-end="1439.7">to the constructor and so so we can</span> <span data-start="1439.7" data-end="1441.68">simplify this program until just a</span> <span data-start="1441.68" data-end="1448.55">couple lines by doing this so file i/o</span> <span data-start="1448.55" data-end="1453.2">and notice non-blocking this is</span> <span data-start="1453.2" data-end="1455.63">something that's usually very hard to do</span> <span data-start="1455.63" data-end="1461.72">and note it's quite hard not to do which</span> <span data-start="1461.72" data-end="1464.87">is good I mean the the way that you</span> <span data-start="1464.87" data-end="1467.54">should be doing things should be easy in</span> <span data-start="1467.54" data-end="1468.89">the way you shouldn't be doing things</span> <span data-start="1468.89" data-end="1473.93">should be difficult okay so so what</span> <span data-start="1473.93" data-end="1476.73">we're going to do is we're going to</span> <span data-start="1476.73" data-end="1479.429">look at the last time somebody modified</span> </p>
<p><span data-start="1479.429" data-end="1483.059">EDC password so first we require the</span> <span data-start="1483.059" data-end="1485.34">POSIX module which has all of our file</span> <span data-start="1485.34" data-end="1487.919">i/o operations and we pull out this stat</span> <span data-start="1487.919" data-end="1492.389">function we require our puts function</span> <span data-start="1492.389" data-end="1496.889">get that from the sis module and then we</span> <span data-start="1496.889" data-end="1499.649">call stat on EDC password and it returns</span> <span data-start="1499.649" data-end="1503.419">a province which I'll talk more about</span> <span data-start="1503.419" data-end="1505.95">and then we add a call back to the</span> <span data-start="1505.95" data-end="1508.859">promise which gets called when when the</span> <span data-start="1508.859" data-end="1512.73">stat operation was complete and then</span> <span data-start="1512.73" data-end="1514.799">finally we print out the the modified</span> <span data-start="1514.799" data-end="1521.129">time so the these these promise objects</span> <span data-start="1521.129" data-end="1523.379">are pretty common all the file</span> <span data-start="1523.379" data-end="1526.47">operations return a promise and so a</span> <span data-start="1526.47" data-end="1528.659">promise is is an event emitter which</span> <span data-start="1528.659" data-end="1532.23">which emits a success or an error event</span> <span data-start="1532.23" data-end="1535.95">so if you do some file operation you</span> <span data-start="1535.95" data-end="1537.989">don't want to block because that's going</span> <span data-start="1537.989" data-end="1540.359">to be a long time you can't just shut</span> <span data-start="1540.359" data-end="1542.129">down your server while you spin the disk</span> <span data-start="1542.129" data-end="1546.6">so you send off this request to the to</span> <span data-start="1546.6" data-end="1549.509">the disk ok tell me what time that that</span> <span data-start="1549.509" data-end="1551.909">file was modified I'm going to go do</span> <span data-start="1551.909" data-end="1554.789">other things and then eventually it</span> <span data-start="1554.789" data-end="1557.97">comes back and it says success I got the</span> <span data-start="1557.97" data-end="1559.609">answer for you here it is</span> <span data-start="1559.609" data-end="1564.72">or error so the the promise dot add</span> <span data-start="1564.72" data-end="1567.649">callback was was just API sugar for for</span> <span data-start="1567.649" data-end="1574.2">promise at this nurse first success okay</span> <span data-start="1574.2" data-end="1576.269">so we're getting progressively more</span> <span data-start="1576.269" data-end="1579.72">complicated now we're going to do an</span> </p>
<p><span data-start="1579.72" data-end="1584.129">HTTP server we have to require the the</span> <span data-start="1584.129" data-end="1589.47">HTTP module and we create a HTTP server</span> <span data-start="1589.47" data-end="1593.19">object and the callback for this which</span> <span data-start="1593.19" data-end="1596.039">is called on each request gives you a</span> <span data-start="1596.039" data-end="1600.919">request object in a response object so</span> <span data-start="1600.919" data-end="1604.379">then we send that the header the the 200</span> <span data-start="1604.379" data-end="1606.84">success code and content type text plane</span> <span data-start="1606.84" data-end="1610.53">and we send body hello send body world</span> <span data-start="1610.53" data-end="1614.64">and then we finished the response this</span> <span data-start="1614.64" data-end="1618.96">is slightly more complicated than if you</span> <span data-start="1618.96" data-end="1622.05">were at the narwhal talk before Tom</span> <span data-start="1622.05" data-end="1625.44">promotes the the J SGI specification</span> <span data-start="1625.44" data-end="1628.38">this is more complicated than that but</span> <span data-start="1628.38" data-end="1632.71">it's it's for a good reason</span> </p>
<p><span data-start="1632.72" data-end="1638.94">J SGI requires you to Iraq to rap it's</span> <span data-start="1638.94" data-end="1641.4">it's the same thing you have a function</span> <span data-start="1641.4" data-end="1643.59">and then you return the result so all</span> <span data-start="1643.59" data-end="1645.09">the processing happens in a single</span> <span data-start="1645.09" data-end="1647.49">function which as I said at the</span> <span data-start="1647.49" data-end="1649.02">beginning is something we want to avoid</span> <span data-start="1649.02" data-end="1650.84">if you have to connect to the database</span> <span data-start="1650.84" data-end="1654.24">then you don't want to you don't want to</span> <span data-start="1654.24" data-end="1657.21">have to respond in one function now I</span> <span data-start="1657.21" data-end="1661.11">think that there's some ways to do that</span> <span data-start="1661.11" data-end="1664.35">with with J SGI but i like this i think</span> <span data-start="1664.35" data-end="1668.94">it's it's simple enough so let's let's</span> <span data-start="1668.94" data-end="1671.9">try this out so we put the the code into</span> <span data-start="1671.9" data-end="1674.01">HTTP server j yes</span> <span data-start="1674.01" data-end="1677.19">we're uncurl on it and we get hello</span> <span data-start="1677.19" data-end="1681.04">world</span> <span data-start="1681.05" data-end="1684.93">okay now slightly more complicated we're</span> <span data-start="1684.93" data-end="1686.82">going to do the same thing we're going</span> <span data-start="1686.82" data-end="1689.1">to have an HTTP server which outputs</span> <span data-start="1689.1" data-end="1692.76">hello world but instead of outputting at</span> <span data-start="1692.76" data-end="1694.86">all at once it's going to output hello</span> <span data-start="1694.86" data-end="1697.5">and then it's going to output world two</span> <span data-start="1697.5" data-end="1700.59">seconds later so what we do is we put a</span> <span data-start="1700.59" data-end="1703.29">set timeout in there so we wait for 2000</span> <span data-start="1703.29" data-end="1708.67">milliseconds in the the request callback</span> <span data-start="1708.68" data-end="1713.67">so you might wonder like okay who cares</span> <span data-start="1713.67" data-end="1716.79">why would anybody want to do this but</span> <span data-start="1716.79" data-end="1720.99">this is important because while the</span> <span data-start="1720.99" data-end="1723.09">server doesn't shut down when when the</span> <span data-start="1723.09" data-end="1724.29">set timeout is called</span> <span data-start="1724.29" data-end="1726.21">it doesn't say set timeout it's not</span> <span data-start="1726.21" data-end="1728.43">asleep you're not sleeping for two</span> <span data-start="1728.43" data-end="1730.11">seconds and not doing anything else</span> <span data-start="1730.11" data-end="1732.99">you're serving requests so here's a</span> <span data-start="1732.99" data-end="1734.19">request here's a request here's a</span> <span data-start="1734.19" data-end="1736.65">request and then suddenly okay that</span> <span data-start="1736.65" data-end="1738.45">one's done that one's done that one's</span> <span data-start="1738.45" data-end="1741">done this is the exact behavior that</span> <span data-start="1741" data-end="1744">you'd need for comet style application</span> <span data-start="1744" data-end="1746.16">if you need to do a long pole you have</span> <span data-start="1746.16" data-end="1747.96">to be able to hang requests in an</span> <span data-start="1747.96" data-end="1750.3">efficient way and this demonstrates how</span> <span data-start="1750.3" data-end="1753.75">you can do that this isn't the right way</span> <span data-start="1753.75" data-end="1755.61">to do a long pole thing but it</span> <span data-start="1755.61" data-end="1760.27">demonstrates that you can hang requests</span> <span data-start="1760.28" data-end="1763.89">so let's try it out we put into a file</span> </p>
<p><span data-start="1763.89" data-end="1767.76">HTTP server to call it with node run</span> <span data-start="1767.76" data-end="1770.76">curl we get hello two seconds later we</span> <span data-start="1770.76" data-end="1775.77">get world a streaming web server okay we</span> <span data-start="1775.77" data-end="1778.5">can also use we can also call programs</span> <span data-start="1778.5" data-end="1782.1">with node one would hope so we can do</span> <span data-start="1782.1" data-end="1786.81">that with the Cissy XE command of course</span> <span data-start="1786.81" data-end="1789.78">this also returns a promise because it's</span> <span data-start="1789.78" data-end="1790.86">something that doesn't happen</span> <span data-start="1790.86" data-end="1792.78">immediately it doesn't happen in memory</span> <span data-start="1792.78" data-end="1797.01">but you know if you do LS / that might</span> <span data-start="1797.01" data-end="1798.72">have to spin the disk and so there's</span> <span data-start="1798.72" data-end="1802.05">some time that happens between the time</span> <span data-start="1802.05" data-end="1803.61">that that starts and the time that that</span> <span data-start="1803.61" data-end="1805.94">finishes so we have to have a callback</span> <span data-start="1805.94" data-end="1808.68">so we we add a callback to the promise</span> <span data-start="1808.68" data-end="1811.08">object which is returned from sista XE</span> <span data-start="1811.08" data-end="1817.53">and then we output the output okay so</span> <span data-start="1817.53" data-end="1820.41">but I told you before that I never would</span> <span data-start="1820.41" data-end="1822.42">force people to buffer data and that</span> <span data-start="1822.42" data-end="1825.54">just buffered the data so there's also a</span> <span data-start="1825.54" data-end="1829.2">lower-level way to call sub process to</span> <span data-start="1829.2" data-end="1832.28">call it to make a child process where</span> <span data-start="1832.28" data-end="1835.23">you can stream the data through through</span> <span data-start="1835.23" data-end="1837.84">the standard i/o so you can stream that</span> <span data-start="1837.84" data-end="1840.39">if you're you LS on a huge directory you</span> <span data-start="1840.39" data-end="1842.1">don't want to buffer all of that data in</span> <span data-start="1842.1" data-end="1845.16">memory you want to stream it to the to</span> <span data-start="1845.16" data-end="1848.67">the to the parent process and pars it</span> <span data-start="1848.67" data-end="1851.19">and handle it do whatever with it but</span> <span data-start="1851.19" data-end="1854.19">hopefully not buffer it so this is a</span> <span data-start="1854.19" data-end="1856.23">simple form of inter process</span> <span data-start="1856.23" data-end="1861.69">communication so this is an example of</span> <span data-start="1861.69" data-end="1863.91">that where we're going to launch the cat</span> <span data-start="1863.91" data-end="1868.26">program like the UNIX cat program which</span> <span data-start="1868.26" data-end="1870.9">whatever you you send to it it just</span> <span data-start="1870.9" data-end="1874.17">sends the same thing back and so we</span> <span data-start="1874.17" data-end="1877.02">create the child process in line 3</span> <span data-start="1877.02" data-end="1880.38">we add a listener for output so every</span> <span data-start="1880.38" data-end="1882.21">time that there's some output it calls</span> <span data-start="1882.21" data-end="1884.43">that that callback and then in the last</span> <span data-start="1884.43" data-end="1886.62">couple lines we write data to the cat</span> <span data-start="1886.62" data-end="1889.44">process and so that's sending that hello</span> <span data-start="1889.44" data-end="1893.7">world and line eleven and twelve to the</span> <span data-start="1893.7" data-end="1897.03">standard in of the cat process and then</span> <span data-start="1897.03" data-end="1899.13">finally we call closed which closes the</span> <span data-start="1899.13" data-end="1902.85">standard end of the cat process and cat</span> <span data-start="1902.85" data-end="1904.74">terminates when it's standard in is is</span> <span data-start="1904.74" data-end="1909.03">complete okay so we can Street we can</span> <span data-start="1909.03" data-end="1912.51">create sub processes we can create child</span> <span data-start="1912.51" data-end="1915.3">processes and stream data in and out of</span> <span data-start="1915.3" data-end="1921.21">out of them okay so so now I have a demo</span> <span data-start="1921.21" data-end="1926.06">for you I wrote an IRC server in node</span> <span data-start="1926.06" data-end="1929.88">just a hack really but just to</span> <span data-start="1929.88" data-end="1934.77">demonstrate what you can do so maybe</span> <span data-start="1934.77" data-end="1936.69">this will work maybe this won't work but</span> <span data-start="1936.69" data-end="1939.33">let's let's try to go to IRC no js' dot</span> <span data-start="1939.33" data-end="1964.69">org and go on to the node.js channel</span> <span data-start="1964.7" data-end="1967.94">okay so so I have my my terminal here</span> </p>
<p><span data-start="1967.94" data-end="1969.649">I'm actually logged into the server so</span> <span data-start="1969.649" data-end="1972.23">well first of all I'm going to connect</span> <span data-start="1972.23" data-end="1973.669">to the server hopefully it's still</span> <span data-start="1973.669" data-end="1986.84">running and it hasn't crashed</span> <span data-start="1986.85" data-end="1990.84">okay so so now I'm connected and I I</span> <span data-start="1990.84" data-end="2002.99">will join the OGS</span> <span data-start="2003" data-end="2006.96">okay so so if if people did that you can</span> <span data-start="2006.96" data-end="2009.87">see people talking so so this this IRC</span> <span data-start="2009.87" data-end="2015.57">server is is running on node this is an</span> <span data-start="2015.57" data-end="2018.45">IRC client of course what I want to do</span> <span data-start="2018.45" data-end="2027.299">is actually show yes I want to I also</span> <span data-start="2027.299" data-end="2029.159">have a repo library a read eval print</span> <span data-start="2029.159" data-end="2031.679">loop and so since we have an event loop</span> <span data-start="2031.679" data-end="2034.08">we can add all sorts of io to this this</span> <span data-start="2034.08" data-end="2036.24">is one process but we can add a repo to</span> <span data-start="2036.24" data-end="2037.919">it without thinking about it because</span> <span data-start="2037.919" data-end="2040.5">what we do is we do all the on our event</span> <span data-start="2040.5" data-end="2042.45">loop we we do all the connections we</span> <span data-start="2042.45" data-end="2044.22">send all the messages we come back and</span> <span data-start="2044.22" data-end="2046.44">then we can do the repo things if we</span> <span data-start="2046.44" data-end="2048.389">wanted to add an HTTP server to that</span> <span data-start="2048.389" data-end="2050.159">that would also be possible all in the</span> <span data-start="2050.159" data-end="2052.53">same process just by going around the</span> <span data-start="2052.53" data-end="2054.21">event loop and since nothing blocks we</span> <span data-start="2054.21" data-end="2060.24">can just add as much IO as we want to so</span> </p>
<p><span data-start="2060.24" data-end="2069.159">I show you the repo now</span> <span data-start="2069.169" data-end="2088.659">kind of</span> <span data-start="2088.669" data-end="2092.539">okay so it's running on screen so I'm</span> <span data-start="2092.539" data-end="2105.01">just going to open the screen</span> <span data-start="2105.02" data-end="2109.57">there it is okay so this is the ircd</span> <span data-start="2109.57" data-end="2113.09">repo thing and so what I can do is is I</span> <span data-start="2113.09" data-end="2116.48">have total control over the IRC server</span> <span data-start="2116.48" data-end="2120.17">so for example I can kill some of these</span> <span data-start="2120.17" data-end="2139.87">users off</span> <span data-start="2139.88" data-end="2142.53">yeah okay</span> </p>
<p><span data-start="2142.53" data-end="2147.119">I have full control I could also make</span> <span data-start="2147.119" data-end="2202.89">people like say things</span> <span data-start="2202.9" data-end="2206.48">okay anyway the point is we have a we</span> <span data-start="2206.48" data-end="2212.36">have a repo to to the IRC server and of</span> <span data-start="2212.36" data-end="2214.19">course if I just control see it then</span> <span data-start="2214.19" data-end="2216.56">everybody will go away and they're</span> <span data-start="2216.56" data-end="2219.47">offline now because the IRC server is</span> <span data-start="2219.47" data-end="2221.81">gone and if I turn it back on then it's</span> <span data-start="2221.81" data-end="2262.53">just there okay so so that's my my demo</span> <span data-start="2262.54" data-end="2268.51">okay yeah so so check out the the code</span> <span data-start="2268.51" data-end="2271.36">if you want it's it's just 400 lines or</span> <span data-start="2271.36" data-end="2277.09">so I think this demonstrates that node</span> <span data-start="2277.09" data-end="2279.76">abstracts the real problem of writing an</span> </p>
<p><span data-start="2279.76" data-end="2282.13">IRC server away because if you look at</span> <span data-start="2282.13" data-end="2283.9">the code of that it's just okay somebody</span> <span data-start="2283.9" data-end="2285.73">connects okay I have a list of users</span> <span data-start="2285.73" data-end="2288.52">okay I send this user that message it's</span> <span data-start="2288.52" data-end="2291.58">it's really quite easy to follow in my</span> <span data-start="2291.58" data-end="2295.6">humble opinion whereas if you try to sit</span> <span data-start="2295.6" data-end="2298.27">down and write an IRC server say in Ruby</span> <span data-start="2298.27" data-end="2301.63">I think you'll find it very difficult</span> <span data-start="2301.63" data-end="2303.67">okay I guess who can use event machine</span> <span data-start="2303.67" data-end="2308.59">and you might find it okay but I think</span> <span data-start="2308.59" data-end="2312.4">that this really abstracts the the the</span> <span data-start="2312.4" data-end="2315.7">problem of writing a concurrent server</span> <span data-start="2315.7" data-end="2317.98">so if you want to throw together say a</span> <span data-start="2317.98" data-end="2321.22">message queue demon startup node type</span> <span data-start="2321.22" data-end="2323.02">out a hundred lines of JavaScript and</span> <span data-start="2323.02" data-end="2325.27">there's your message queue demon that</span> <span data-start="2325.27" data-end="2327.52">that does whatever specific thing that</span> <span data-start="2327.52" data-end="2331.45">you need it to do okay so so just</span> <span data-start="2331.45" data-end="2334.72">briefly uh I talked about the internal</span> <span data-start="2334.72" data-end="2338.59">design of node so note is not some big</span> <span data-start="2338.59" data-end="2343.39">monolithic app it's it's a bunch of C</span> <span data-start="2343.39" data-end="2347.02">libraries that are kind of hacked</span> <span data-start="2347.02" data-end="2349.99">together in various ways so the v8 is</span> <span data-start="2349.99" data-end="2351.76">not a little seed library it's a huge C</span> <span data-start="2351.76" data-end="2356.29">library that's by Google of course the</span> </p>
<p><span data-start="2356.29" data-end="2359.8">Lib Evie event loop and Libby IO thread</span> <span data-start="2359.8" data-end="2362.35">pool are a really nice little libraries</span> <span data-start="2362.35" data-end="2364.27">and they're both written by marked</span> <span data-start="2364.27" data-end="2369.21">layman there's a HTTP parser which is</span> <span data-start="2369.21" data-end="2372.15">quite advanced it could do all sorts of</span> <span data-start="2372.15" data-end="2375.13">streaming sort of things that's by me</span> <span data-start="2375.13" data-end="2378.58">and a socket library by me too and then</span> <span data-start="2378.58" data-end="2382.93">a you you DNS is is a DNS resolver which</span> <span data-start="2382.93" data-end="2389.83">is important so the way that I do this</span> <span data-start="2389.83" data-end="2393.45">is</span> <span data-start="2393.46" data-end="2395.17">there's a lot of system calls that you</span> <span data-start="2395.17" data-end="2396.91">might do if you have to access the file</span> <span data-start="2396.91" data-end="2401.65">system those system calls those POSIX</span> <span data-start="2401.65" data-end="2403.78">system calls can block and so what I do</span> <span data-start="2403.78" data-end="2405.67">is I have a thread pool underneath</span> <span data-start="2405.67" data-end="2411.43">everything and I say ok I want to do</span> <span data-start="2411.43" data-end="2414.88">this system call I want to read a</span> <span data-start="2414.88" data-end="2417.4">directory I pack it up and then I send</span> <span data-start="2417.4" data-end="2419.68">it off to the thread pool it does stuff</span> <span data-start="2419.68" data-end="2424.24">and then it comes back signal handlers</span> <span data-start="2424.24" data-end="2427.45">are usually asynchronous from the rest</span> <span data-start="2427.45" data-end="2431.77">of your execution stack and this this</span> <span data-start="2431.77" data-end="2433.66">thread pool thing these things are kind</span> <span data-start="2433.66" data-end="2436.3">of asynchronous from the main nodejs</span> <span data-start="2436.3" data-end="2438.88">event loop and so they have to notify</span> <span data-start="2438.88" data-end="2440.77">they have to be marshaled back into the</span> <span data-start="2440.77" data-end="2443.47">main event loop you have to say ok wait</span> <span data-start="2443.47" data-end="2445.809">your turn alright now we can process the</span> <span data-start="2445.809" data-end="2447.339">signal handler you can't just do it</span> <span data-start="2447.339" data-end="2449.5">immediately when the result comes from</span> <span data-start="2449.5" data-end="2451.42">the event loop you can't just say stop</span> <span data-start="2451.42" data-end="2453.19">everything we're going to do this you</span> <span data-start="2453.19" data-end="2455.38">have to say ok all right now we can</span> <span data-start="2455.38" data-end="2457.75">process you and we I do this by by using</span> <span data-start="2457.75" data-end="2460.92">a pipe from the thread pool in and from</span> <span data-start="2460.92" data-end="2464.74">signal handlers in and you can select on</span> <span data-start="2464.74" data-end="2469.599">that pipe another thing that I did is</span> </p>
<p><span data-start="2469.599" data-end="2472.27">I'm worried about what happens if you</span> <span data-start="2472.27" data-end="2476.319">pipe a huge file into node so say this</span> <span data-start="2476.319" data-end="2481.72">this file is 200 megabytes and has a</span> <span data-start="2481.72" data-end="2484.72">list of domain names and you want to</span> <span data-start="2484.72" data-end="2488.65">look them all up so each line is a</span> <span data-start="2488.65" data-end="2491.349">domain name and you want to do dns</span> <span data-start="2491.349" data-end="2493.39">resolution on them but you can't block</span> <span data-start="2493.39" data-end="2495.13">the dns resolution or else it's going to</span> <span data-start="2495.13" data-end="2496.51">be really slow what you want to do is</span> <span data-start="2496.51" data-end="2498.28">read it and stream it into your node</span> <span data-start="2498.28" data-end="2500.95">process read the lines do the DNS</span> <span data-start="2500.95" data-end="2502.54">lookups and this should all be on the</span> <span data-start="2502.54" data-end="2507.099">same event level so the problem is is</span> <span data-start="2507.099" data-end="2512.619">that in UNIX or in any POSIX system the</span> <span data-start="2512.619" data-end="2514.75">standard EDD file descriptor is going to</span> <span data-start="2514.75" data-end="2519.25">refer to a file and you can't select on</span> <span data-start="2519.25" data-end="2522.28">files you can't add them to your event</span> <span data-start="2522.28" data-end="2524.319">loop you can't just read from them</span> <span data-start="2524.319" data-end="2526.47">because that's going to block</span> <span data-start="2526.47" data-end="2529.54">so what you do is you create a pumping</span> <span data-start="2529.54" data-end="2532.42">thread and you have a pipe and so you do</span> <span data-start="2532.42" data-end="2535.78">these blocking reads from the file pump</span> <span data-start="2535.78" data-end="2538.089">them into the pipe a which goes into the</span> <span data-start="2538.089" data-end="2540.43">main application and in this way you can</span> <span data-start="2540.43" data-end="2542.74">stream data into the the server in a</span> <span data-start="2542.74" data-end="2544.72">non-blocking way with just one extra</span> <span data-start="2544.72" data-end="2546.82">thread these are the sort of things that</span> <span data-start="2546.82" data-end="2549.73">you might have to do know about if you</span> <span data-start="2549.73" data-end="2553.06">were going to write this yourself you</span> <span data-start="2553.06" data-end="2554.5">don't have to do that it's under the</span> <span data-start="2554.5" data-end="2558.4">it's down below the the API that the</span> <span data-start="2558.4" data-end="2561.16">users deal with if you're interested</span> <span data-start="2561.16" data-end="2563.08">look in the source directory at the</span> <span data-start="2563.08" data-end="2569.98">coupling okay so so what's next I have</span> <span data-start="2569.98" data-end="2572.44">to fix some some API issues there's</span> <span data-start="2572.44" data-end="2575.23">various things that are very kind of</span> <span data-start="2575.23" data-end="2581.08">ugly I want to have more modularity I</span> <span data-start="2581.08" data-end="2584.23">want to have break up the libraries into</span> </p>
<p><span data-start="2584.23" data-end="2586.9">DLL so that the the coronoid process is</span> <span data-start="2586.9" data-end="2589.839">very small and that if you need the HTTP</span> <span data-start="2589.839" data-end="2593.26">server you would load a DLL to some</span> <span data-start="2593.26" data-end="2596.77">shared object to to get the HTTP parser</span> <span data-start="2596.77" data-end="2600.4">for example I'm going to include some</span> <span data-start="2600.4" data-end="2603.16">libraries for like MySQL and Postgres</span> <span data-start="2603.16" data-end="2606.88">into the core distribution I need to</span> <span data-start="2606.88" data-end="2610.99">improve performance that's always an</span> <span data-start="2610.99" data-end="2613.66">issue there's there's a some low-hanging</span> <span data-start="2613.66" data-end="2616.839">fruit that I know about that we can that</span> <span data-start="2616.839" data-end="2619.75">we can pick and make it faster TLS</span> <span data-start="2619.75" data-end="2623.17">support is on its way and then finally I</span> <span data-start="2623.17" data-end="2625.39">would like to do some sort of web worker</span> <span data-start="2625.39" data-end="2628.33">like thing which would probably just</span> <span data-start="2628.33" data-end="2632.349">extend the the child process object so</span> <span data-start="2632.349" data-end="2634.78">that you can create processes and kind</span> <span data-start="2634.78" data-end="2637.39">of do IPC between them in a in a nice</span> <span data-start="2637.39" data-end="2643.33">way so right now the version is 0.1</span> <span data-start="2643.33" data-end="2647.8">point 17 I will release 0.2 which will</span> <span data-start="2647.8" data-end="2650.109">be kind of the first version that I</span> <span data-start="2650.109" data-end="2652.39">would hope that other people would use</span> <span data-start="2652.39" data-end="2654.58">at the moment I think it's a bit hacky</span> <span data-start="2654.58" data-end="2657.25">and if your experimental then please use</span> <span data-start="2657.25" data-end="2659.86">it but</span> <span data-start="2659.86" data-end="2663.61">if not then wait for 0.2 and I think</span> <span data-start="2663.61" data-end="2666.13">that will be good because I will freeze</span> <span data-start="2666.13" data-end="2669.4">the API or at least some of it and so</span> <span data-start="2669.4" data-end="2671.23">you can kind of build on it with some</span> <span data-start="2671.23" data-end="2672.94">confidence that I won't change it out</span> <span data-start="2672.94" data-end="2677.8">from underneath mmm okay so yes any</span> <span data-start="2677.8" data-end="2699.9">questions</span> <span data-start="2699.91" data-end="2703.66">so the the question is if like if you</span> <span data-start="2703.66" data-end="2705.67">make changes to the source file well it</span> <span data-start="2705.67" data-end="2707.65">will it load in those changes</span> <span data-start="2707.65" data-end="2711.579">no but Felix and I have been hacking on</span> <span data-start="2711.579" data-end="2713.859">this a bit this weekend it's something</span> </p>
<p><span data-start="2713.859" data-end="2732.98">I'd like to add yes</span> <span data-start="2732.99" data-end="2735.46">so the question is what do I do with</span> <span data-start="2735.46" data-end="2739.05">blocking rights when you have a socket</span> <span data-start="2739.05" data-end="2741.46">there's a right buffer in the kernel and</span> <span data-start="2741.46" data-end="2743.95">you can only write so much data to the</span> <span data-start="2743.95" data-end="2745.45">right buffer before it gets filled up</span> <span data-start="2745.45" data-end="2748.03">this kernel can't push out all the data</span> <span data-start="2748.03" data-end="2751">to the network as fast as it wants to</span> <span data-start="2751" data-end="2753.7">there's some buffer that that can</span> <span data-start="2753.7" data-end="2755.29">possibly fill up so if you're streaming</span> <span data-start="2755.29" data-end="2757.63">a file out of the socket to somewhere</span> <span data-start="2757.63" data-end="2760.99">else then that can block in node it</span> <span data-start="2760.99" data-end="2764.29">doesn't block it buffers the data it</span> <span data-start="2764.29" data-end="2766.99">will allocate data internally if you do</span> <span data-start="2766.99" data-end="2769.48">that and what you could do is get a</span> <span data-start="2769.48" data-end="2772.42">callback win that buffer when the kernel</span> <span data-start="2772.42" data-end="2774.7">buffer drains so what you can do if you</span> <span data-start="2774.7" data-end="2777.73">want to stream a file to somebody you</span> <span data-start="2777.73" data-end="2781.03">start sending it and then you send a say</span> <span data-start="2781.03" data-end="2785.32">a megabyte which may fill up the buffer</span> <span data-start="2785.32" data-end="2787.3">may not fill up the buffer and then you</span> <span data-start="2787.3" data-end="2789.43">wait till it drains and then you send</span> <span data-start="2789.43" data-end="2791.71">another megabyte and so in this way you</span> <span data-start="2791.71" data-end="2794.02">can stream data the the right buffer</span> <span data-start="2794.02" data-end="2796.03">will never fill up what will happen is</span> <span data-start="2796.03" data-end="2799.95">all allocate memory so in in user space</span> <span data-start="2799.95" data-end="2817.63">so so rights don't block</span> <span data-start="2817.64" data-end="2822.64">yes</span> <span data-start="2822.65" data-end="2826.62">so the question is what is my stance on</span> <span data-start="2826.62" data-end="2832.71">common j/s so common je s I think has a</span> <span data-start="2832.71" data-end="2834.84">lot of good proposals so the module</span> <span data-start="2834.84" data-end="2838.73">system I'm using there's a binary</span> <span data-start="2838.73" data-end="2841.68">proposal and there's a package proposal</span> <span data-start="2841.68" data-end="2845.07">which which look very good at the moment</span> <span data-start="2845.07" data-end="2847.23">commonjs has only ratified I think the</span> <span data-start="2847.23" data-end="2850.59">the module proposal and the assert this</span> <span data-start="2850.59" data-end="2853.14">testing library proposal so it doesn't</span> <span data-start="2853.14" data-end="2856.02">define things like IO so I think those</span> <span data-start="2856.02" data-end="2858.9">discussions will be ongoing I think</span> <span data-start="2858.9" data-end="2860.46">there's some people who want it more in</span> <span data-start="2860.46" data-end="2862.53">a blocking state I want it more in a</span> <span data-start="2862.53" data-end="2864.6">vented State and so we'll fight it out</span> <span data-start="2864.6" data-end="2879.48">over the next couple months or so yes</span> <span data-start="2879.49" data-end="2886.22">a little bit I would like to have more</span> <span data-start="2886.22" data-end="2888.19">money for it</span> <span data-start="2888.19" data-end="2890.63">writing your own open-source project</span> <span data-start="2890.63" data-end="2894.65">requires a lot of effort and yeah it</span> </p>
</section>